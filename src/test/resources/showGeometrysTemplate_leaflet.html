<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Âá†‰ΩïÂõæÂΩ¢Â±ïÁ§∫Ê®°Êùø - LeafletÁâà</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

    <!-- Â§©Âú∞Âõæ API -->
    <script src="https://api.tianditu.gov.cn/api?v=4.0&tk=9ed3674d01dd7c129ab38e3c38bf651a"></script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Turf.js Áî®‰∫éÂá†‰ΩïËÆ°ÁÆó -->
    <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

    <!-- WKTËß£ÊûêÂ∫ì -->
    <script src="https://unpkg.com/wellknown@0.5.0/wellknown.js"></script>

    <!-- Leaflet Geometry Util for area calculation -->
    <script src="https://unpkg.com/leaflet-geometryutil@0.11.0/src/leaflet.geometryutil.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f0f0;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            width: 100%;
            height: 100vh;
            margin: 0;
            background: white;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            position: relative;
        }
        
        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: transparent;
            color: white;
            padding: 0;
            text-align: left;
            z-index: 1000;
            display: none;
        }
        
        .header.show {
            display: block;
        }
        
        .header h1 {
            font-size: 18px;
            margin: 0;
            display: inline-block;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 12px;
            margin: 0 0 0 20px;
            display: inline-block;
        }
        
        .main-content {
            position: relative;
            height: 100vh;
            width: 100%;
        }
        
        .left-panel {
            width: 350px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
            position: absolute;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 1001;
            transition: transform 0.3s ease;
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
        }
        
        .left-panel.collapsed {
            transform: translateX(-350px);
            z-index: 9999; /* Á°Æ‰øùÈù¢ÊùøÂú®Âõ∫ÂÆöÊåâÈíÆ‰πã‰∏ã */
        }
        
        .left-panel.collapsed .panel-toggle {
            left: 100%;
            display: none !important;
        }
        

        
        .toolbar {
            padding: 15px;
            background: white;
            border-bottom: 1px solid #e9ecef;
        }
        
        .toolbar h3 {
            margin-bottom: 10px;
            color: #495057;
            font-size: 16px;
        }
        
        .tool-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .tool-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            background: #6c757d;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .tool-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }
        
        .tool-btn.active {
            background: #007bff;
        }
        
        .wkt-input {
            flex: 1;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }
        
        .tab-container {
            margin-bottom: 15px;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 8px;
            padding: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s ease;
            font-size: 13px;
            font-weight: 500;
        }
        
        .tab.active {
            background: #007bff;
            color: white;
            box-shadow: 0 2px 4px rgba(0,123,255,0.3);
        }
        
        .tab-content {
            display: none;
            margin-top: 15px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
            font-size: 13px;
        }
        
        .input-group textarea {
            width: 100%;
            height: 80px;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            resize: vertical;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            transition: border-color 0.3s ease;
        }
        
        .input-group textarea:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .button-group {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            flex: 1;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #1e7e34;
            transform: translateY(-1px);
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-primary:disabled {
            background: #6c757d;
            border-color: #6c757d;
        }
        
        .btn-secondary:disabled {
            background: #6c757d;
            border-color: #6c757d;
        }
        
        .btn-warning:disabled {
            background: #6c757d;
            border-color: #6c757d;
            color: white;
        }
        
        .color-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 6px;
        }
        
        .color-picker {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #dee2e6;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .color-picker:hover {
            border-color: #007bff;
            transform: scale(1.1);
        }
        
        .color-label {
            font-size: 12px;
            color: #495057;
            font-weight: 500;
        }
        
        .map-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: #e9ecef;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        

        
        .header-toggle {
            position: fixed;
            top: 10px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            z-index: 1001;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }
        
        .header-toggle:hover {
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .panel-toggle-fixed {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: #007bff;
            color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
            z-index: 10000;
        }
        
        .panel-toggle-fixed:hover {
            background: #0056b3;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .map-control-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .map-control-btn:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .playback-player {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            z-index: 1000;
            width: 600px;
            max-width: 90vw;
            overflow: hidden;
        }
        
        .player-header {
            background: #007bff;
            color: white;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .player-title {
            font-size: 14px;
            font-weight: 500;
        }
        
        .player-close {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s ease;
        }
        
        .player-close:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .player-controls {
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .player-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: #007bff;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .player-btn:hover {
            background: #0056b3;
            transform: scale(1.05);
        }
        
        .player-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .player-speed {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 8px;
        }
        
        .player-speed label {
            font-size: 12px;
            color: #495057;
            font-weight: 500;
        }
        
        .player-speed input[type="range"] {
            width: 80px;
        }
        
        .player-speed span {
            font-size: 12px;
            color: #6c757d;
            min-width: 25px;
        }
        
        .player-progress {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 8px;
        }
        
        .player-progress input[type="range"] {
            flex: 1;
            height: 4px;
            border-radius: 2px;
            background: #e9ecef;
            outline: none;
            -webkit-appearance: none;
        }
        
        .player-progress input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #007bff;
            cursor: pointer;
        }
        
        .player-progress span {
            font-size: 12px;
            color: #495057;
            font-weight: 500;
            min-width: 80px;
        }
        
        .speed-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .speed-control label {
            font-size: 12px;
            color: #495057;
            font-weight: 500;
        }
        
        .speed-control input[type="range"] {
            width: 80px;
        }
        
        .speed-value {
            font-size: 12px;
            color: #6c757d;
            min-width: 30px;
        }
        
        .time-slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .time-slider {
            flex: 1;
            height: 4px;
            border-radius: 2px;
            background: #e9ecef;
            outline: none;
            -webkit-appearance: none;
        }
        
        .time-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #007bff;
            cursor: pointer;
        }
        
        .time-label {
            font-size: 11px;
            color: #495057;
            font-weight: 500;
            min-width: 120px;
        }
        
        .status-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px 15px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            font-size: 12px;
            color: #495057;
        }
        
        .measure-result {
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1001;
        }
        
        .coordinate-info {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            font-size: 11px;
            color: #495057;
        }
        
        .hidden {
            display: none !important;
        }
        
        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
                height: auto;
            }
            
            .left-panel {
                width: 100%;
                height: 400px;
            }
            
            .map-container {
                height: 500px;
            }
        }
        
        .area-label {
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            pointer-events: none;
            z-index: 1000; /* Á°Æ‰øùÊ†áÁ≠æÂú®ÊúÄ‰∏äÂ±Ç */
        }
        
        /* ÈªòËÆ§ÈöêËóèÊ†áÁ≠æÂÆπÂô®‰∏ãÁöÑÊ†áÁ≠æ */
        .labels-hidden .area-label { display: none; }


    </style>
</head>
<body>
<div class="container">
    <div class="main-content">
        <div class="left-panel">

            <div class="toolbar">
                <h3>üõ†Ô∏è Â∑•ÂÖ∑Ê†è</h3>
                <div class="tool-buttons">
                    <button class="tool-btn" id="measureDistanceBtn" title="ÊµãË∑ù">üìè ÊµãË∑ù</button>
                    <button class="tool-btn" id="measureAreaBtn" title="ÊµãÈù¢">üìê ÊµãÈù¢</button>
                    <button class="tool-btn" id="mapTypeBtn" title="ÂàáÊç¢Âú∞Âõæ">üó∫Ô∏è Ë°óÈÅìÂõæ</button>
                    <button class="tool-btn" id="clearAllBtn" title="Ê∏ÖÁ©∫ÊâÄÊúâ">üóëÔ∏è Ê∏ÖÁ©∫</button>
                </div>
            </div>

            <div class="wkt-input">
                <div class="tab-container">
                    <div class="tabs">
                        <div class="tab active" data-tab="outline">ËΩÆÂªì</div>
                        <div class="tab" data-tab="track">ËΩ®Ëøπ</div>
                    </div>

                    <div class="tab-content active" id="outline-tab">
                        <div class="input-group">
                            <textarea id="outlineWkt" style="height: 400px;"
                                      placeholder="ËæìÂÖ•Â§öËæπÂΩ¢WKTÔºåÊîØÊåÅÂ§öË°åËæìÂÖ•ÔºåÊØèË°å‰∏Ä‰∏™WKT">${outline}</textarea>
                        </div>
                        <div class="button-group">
                            <button class="btn btn-primary" onclick="drawOutline()">üéØ ÁªòÂà∂ËΩÆÂªì</button>
                            <button class="btn btn-secondary" onclick="clearOutline()">üßπ Ê∏ÖÈô§ËΩÆÂªì</button>
                        </div>
                        <div class="input-group">
                            <label><input type="checkbox" id="toggleLabelsCheckbox"> ÊòæÁ§∫‰∫©Êï∞</label>
                        </div>
                    </div>

                    <div class="tab-content" id="track-tab">
                        <div class="time-range-settings" style="margin-bottom:8px;font-size:12px;color:#333;">
                            <label>Êó∂Èó¥ËåÉÂõ¥ÈÄâÂèñ(ÁïôÁ©∫ÂàôÊòæÁ§∫ÊâÄÊúâËΩ®Ëøπ)</label>
                            <input type="text" id="timeRangeInput"
                                   style="width:100%;margin-top:4px;padding:4px;border:1px solid #ddd;border-radius:4px;font-size:12px;"
                                   placeholder="Ê†ºÂºèÔºöyyyy-MM-ddTHH:mm:ss - yyyy-MM-ddTHH:mm:ss">
                        </div>
                        <textarea id="trackTextarea"
                                  style="width:100%;height:400px;margin-bottom:10px;padding:8px;border:1px solid #ddd;border-radius:4px;font-family:monospace;resize:vertical;box-sizing:border-box;">${trace}</textarea>
                        <div class="button-group">
                            <button id="drawTrackButton" class="btn btn-primary">üéØ ËΩ®Ëøπ</button>
                            <button id="showTrackPointsButton" class="btn btn-warning">üìç ÊâìÁÇπ</button>
                            <button id="clearTrackButton" class="btn btn-secondary">üßπ Ê∏ÖÁ©∫</button>
                        </div>
                        <!-- ËΩ®ËøπÈ¢úËâ≤ÈÄâÊã©Âô® -->
                        <div class="color-picker-container" style="margin-top:8px;">
                            <div style="display:flex;align-items:center;gap:8px;">
                                <div style="display:flex;align-items:center;gap:4px;">
                                    <label style="font-size:12px;">ËΩ®ËøπÁ∫øÈ¢úËâ≤:</label>
                                    <div id="trackLineColorPicker" class="color-picker"
                                         style="width:24px;height:24px;border:1px solid #ccc;cursor:pointer;background-color:#FF0000;"></div>
                                    <input type="color" id="trackLineColorInput" value="#FF0000" style="display:none;">
                                </div>
                                <div style="display:flex;align-items:center;gap:4px;">
                                    <label style="font-size:12px;">ËΩ®ËøπÁÇπÈ¢úËâ≤:</label>
                                    <div id="trackPointColorPicker" class="color-picker"
                                         style="width:24px;height:24px;border:1px solid #ccc;cursor:pointer;background-color:#68EAF3;"></div>
                                    <input type="color" id="trackPointColorInput" value="#68EAF3" style="display:none;">
                                </div>
                            </div>
                        </div>
                        <!-- ËΩ®ËøπÂõûÊîæ -->
                        <div class="split-section" style="margin-top:8px;">
                            <div class="playback-actions" style="display:flex;gap:8px;margin-bottom:8px;">
                                <button id="playbackToggleBtn" class="btn btn-primary">‚ñ∂Ô∏è ËΩ®ËøπÂõûÊîæ</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>

            <!-- Â∑•ÂÖ∑Ê†èÂàáÊç¢ÊåâÈíÆ -->
            <button class="panel-toggle-fixed" id="panelToggleFixed" title="Â±ïÂºÄ/Êî∂Áº©Â∑•ÂÖ∑Ê†è">‚óÄ‚ñ∂</button>

            <div class="status-info" id="statusInfo" style="display: none;">
                Â∞±Áª™
            </div>

            <div class="coordinate-info" id="coordinateInfo">
                ÁªèÂ∫¶: -, Á∫¨Â∫¶: -
            </div>

            <!-- ËΩ®ËøπÂõûÊîæÊí≠ÊîæÂô® -->
            <div class="playback-player" id="playbackPlayer" style="display: none;">
                <div class="player-header">
                    <span class="player-title">ËΩ®ËøπÂõûÊîæ</span>
                    <button class="player-close" id="playerCloseBtn" title="ÂÖ≥Èó≠">‚úï</button>
                </div>
                <div class="player-controls">
                    <button class="player-btn" id="playerPlayBtn" title="Êí≠Êîæ">‚ñ∂Ô∏è</button>
                    <button class="player-btn" id="playerStopBtn" title="ÂÅúÊ≠¢">‚èπÔ∏è</button>

                    <div class="player-speed">
                        <label>ÈÄüÂ∫¶:</label>
                        <input type="range" id="playerSpeedSlider" min="1" max="2048" step="1" value="1">
                        <span id="playerSpeedValue">1x</span>
                    </div>

                    <div class="player-progress">
                        <input type="range" id="playerProgressSlider" min="0" max="100" value="0">
                        <span id="playerTimeLabel">00:00 / 00:00</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ÂÖ®Â±ÄÂèòÈáè
    let map;
    let currentMapType = 'street';
    let currentBaseLayer;
    let currentSatelliteLayer;

    // ÂõæÂ±ÇÁªÑ
    let outlineLayerGroup;
    let trackLayerGroup;
    let measureLayerGroup;
    let labelLayerGroup;

    // Ê†áÁ≠æÁõ∏ÂÖ≥
    let labelsEnabled = false;

    // ÂΩìÂâçÂá†‰ΩïÂõæÂΩ¢
    let currentOutline = null;
    let currentTrack = null;

    // ËΩ®ËøπÂõûÊîæÁõ∏ÂÖ≥
    let playbackState = {
        isPlaying: false,
        points: [],
        currentIndex: 0,
        speed: 1,
        marker: null,
        polyline: null,
        timer: null
    };

    // Êñ∞Êí≠ÊîæÂô®ÂÖÉÁ¥†
    let playbackPlayer;
    let playerCloseBtn;
    let playerPlayBtn;
    let playerStopBtn;
    let playerSpeedSlider;
    let playerSpeedValue;
    let playerProgressSlider;
    let playerTimeLabel;

    // ÊµãÈáèÁõ∏ÂÖ≥
    let measureState = {
        isActive: false,
        mode: '',
        points: [],
        tempLine: null,
        lines: [],
        markers: [],
        labels: [],
        polygon: null,
        areaLabel: null
    };

    // È¢úËâ≤ÈÖçÁΩÆ
    let currentOutlineColor = "#FFD700";
    let currentFillColor = "#FFFF00";
    let currentFillOpacity = 0.35;
    let currentTrackLineColor = "#FF0000";
    let currentTrackPointColor = "#68EAF3";

    // Áä∂ÊÄÅ‰ø°ÊÅØÂÆöÊó∂Âô®
    let statusMessageTimer = null;

    // Â§öËæπÂΩ¢È¢úËâ≤ÊñπÊ°à
    const polygonColors = [
        { outline: "#FFD700", fill: "#FFFF00", opacity: 0.35 },
        { outline: "#FF0000", fill: "#FF6666", opacity: 0.35 },
        { outline: "#00FF00", fill: "#66FF66", opacity: 0.35 },
        { outline: "#0000FF", fill: "#6666FF", opacity: 0.35 },
        { outline: "#FF00FF", fill: "#FF66FF", opacity: 0.35 },
        { outline: "#00FFFF", fill: "#66FFFF", opacity: 0.35 },
        { outline: "#FFA500", fill: "#FFCC66", opacity: 0.35 },
        { outline: "#800080", fill: "#CC66CC", opacity: 0.35 },
        { outline: "#008000", fill: "#66CC66", opacity: 0.35 },
        { outline: "#800000", fill: "#CC6666", opacity: 0.35 }
    ];

    // ÊòæÁ§∫Êí≠ÊîæÂô®
    function showPlaybackPlayer() {
        if (playbackPlayer) {
            playbackPlayer.style.display = 'block';
            updatePlayerControls();
            
            // ÂêåÊ≠•ÊóßÁâàÊéßÂà∂Èù¢ÊùøÁä∂ÊÄÅÔºå‰øùÊåÅÂΩìÂâçÊí≠Êîæ‰ΩçÁΩÆ
            if (playerProgressSlider && playbackState.points.length > 0) {
                playerProgressSlider.disabled = false;
                playerProgressSlider.max = 100;
                // ‰∏çÈáçÁΩÆËøõÂ∫¶Êù°ÂÄºÔºå‰øùÊåÅÂΩìÂâçÊí≠Êîæ‰ΩçÁΩÆ
                if (playbackState.points.length > 0 && playbackState.currentIndex >= 0) {
                    const percentage = Math.round((playbackState.currentIndex / (playbackState.points.length - 1)) * 100);
                    playerProgressSlider.value = percentage;
                }
            }
            if (playerTimeLabel && playbackState.points.length > 0) {
                // Ê†πÊçÆÂΩìÂâçÊí≠Êîæ‰ΩçÁΩÆÊõ¥Êñ∞Êó∂Èó¥ÊòæÁ§∫
                if (playbackState.currentIndex >= 0 && playbackState.currentIndex < playbackState.points.length) {
                    const currentPoint = playbackState.points[playbackState.currentIndex];
                    const lastPoint = playbackState.points[playbackState.points.length - 1];
                    
                    if (currentPoint && lastPoint) {
                        function formatTime(timestamp) {
                            const date = parseTimestamp(timestamp);
                            if (!date) return '00:00:00';
                            
                            const hours = date.getHours().toString().padStart(2, '0');
                            const minutes = date.getMinutes().toString().padStart(2, '0');
                            const seconds = date.getSeconds().toString().padStart(2, '0');
                            return hours + ':' + minutes + ':' + seconds;
                        }
                        
                        const currentTime = formatTime(currentPoint.timestamp);
                        const totalTime = formatTime(lastPoint.timestamp);
                        playerTimeLabel.textContent = currentTime + ' / ' + totalTime;
                    }
                }
            }
        }
    }

    // ÈöêËóèÊí≠ÊîæÂô®
    function hidePlaybackPlayer() {
        if (playbackPlayer) {
            playbackPlayer.style.display = 'none';
            // Âè™ÊöÇÂÅúÊí≠ÊîæÔºå‰∏çÈáçÁΩÆËøõÂ∫¶
            if (playbackState.isPlaying) {
                pausePlayback();
            }
            
            // ÈáçÁΩÆÊí≠ÊîæÂô®ÊéßÂà∂Áä∂ÊÄÅ
            updatePlayerControls();
        }
    }

    // ÂàáÊç¢Êí≠ÊîæÁä∂ÊÄÅ
    function togglePlayback() {
        if (playbackState.isPlaying) {
            pausePlayback();
        } else {
            startPlayback();
        }
        
        // Êõ¥Êñ∞Êí≠ÊîæÂô®ÊéßÂà∂Áä∂ÊÄÅ
        updatePlayerControls();
    }

    // Êõ¥Êñ∞Êí≠ÊîæÂô®ÊéßÂà∂Áä∂ÊÄÅ
    function updatePlayerControls() {
        const hasTrack = playbackState.points && playbackState.points.length > 0;
        
        if (playerPlayBtn) playerPlayBtn.disabled = !hasTrack;
        if (playerStopBtn) playerStopBtn.disabled = !hasTrack;
        if (playerSpeedSlider) playerSpeedSlider.disabled = !hasTrack;
        if (playerProgressSlider) playerProgressSlider.disabled = !hasTrack;
        
        if (playbackState.isPlaying) {
            if (playerPlayBtn) playerPlayBtn.innerHTML = '‚è∏Ô∏è';
            if (playerPlayBtn) playerPlayBtn.title = 'ÊöÇÂÅú';
        } else {
            if (playerPlayBtn) playerPlayBtn.innerHTML = '‚ñ∂Ô∏è';
            if (playerPlayBtn) playerPlayBtn.title = 'Êí≠Êîæ';
        }
    }

    // ÂàùÂßãÂåñÂú∞Âõæ
    function initMap() {
        console.log('initMap called');

        // ÂàõÂª∫Âú∞Âõæ
        map = L.map('map', {
            center: [39.9042, 116.4074], // Âåó‰∫¨
            zoom: 11,
            zoomControl: false,
            attributionControl: false
        });

        console.log('Map created:', map);

        // ‰∏çÊ∑ªÂä†Áº©ÊîæÊéß‰ª∂Ôºå‰ΩøÁî®ÊªöËΩÆÁº©ÊîæÂú∞Âõæ

        // ÂàùÂßãÂåñÂõæÂ±ÇÁªÑ
        outlineLayerGroup = L.layerGroup().addTo(map);
        trackLayerGroup = L.layerGroup().addTo(map);
        measureLayerGroup = L.layerGroup().addTo(map);
        // ÂÖà‰∏çÊ∑ªÂä†Ê†áÁ≠æÂõæÂ±ÇÔºåÁ®çÂêéÁ°Æ‰øùÂÆÉÂú®ÊúÄ‰∏äÂ±Ç
        labelLayerGroup = L.layerGroup();
        map.addLayer(labelLayerGroup);

        console.log('Layer groups created');

        // ÂàùÂßãÂåñÂú∞ÂõæÁ±ªÂûã
        currentMapType = 'satellite';

        // Ê∑ªÂä†Âü∫Á°ÄÂõæÂ±Ç
        addBaseLayers();

        // ÁªëÂÆö‰∫ã‰ª∂
        bindMapEvents();

        // Êõ¥Êñ∞Áä∂ÊÄÅ
        updateStatus('Âú∞ÂõæÂàùÂßãÂåñÂÆåÊàê');

        console.log('initMap completed');

        // Á°Æ‰øùÊ†áÁ≠æÂõæÂ±ÇÂú®ÊúÄ‰∏äÂ±Ç
        map.removeLayer(labelLayerGroup);
        map.addLayer(labelLayerGroup);

        // ÂàùÂßãÂåñÊñ∞Êí≠ÊîæÂô®ÂÖÉÁ¥†
        playbackPlayer = document.getElementById('playbackPlayer');
        playerCloseBtn = document.getElementById('playerCloseBtn');
        playerPlayBtn = document.getElementById('playerPlayBtn');
        playerStopBtn = document.getElementById('playerStopBtn');
        playerSpeedSlider = document.getElementById('playerSpeedSlider');
        playerSpeedValue = document.getElementById('playerSpeedValue');
        playerProgressSlider = document.getElementById('playerProgressSlider');
        playerTimeLabel = document.getElementById('playerTimeLabel');

        // ÂàùÂßãÂåñÈÄüÂ∫¶ÊòæÁ§∫
        if (playerSpeedValue) {
            playerSpeedValue.textContent = '1x';
        }

        // ÂàùÂßãÂåñÊí≠ÊîæÂô®ÊåâÈíÆÁä∂ÊÄÅÔºà‰ΩøÁî®updatePlayerControlsÂáΩÊï∞Ôºâ
        updatePlayerControls();
    }

    // Ê∑ªÂä†Âü∫Á°ÄÂõæÂ±Ç
    function addBaseLayers() {
        console.log('addBaseLayers called');

        // Â§©Âú∞ÂõæË°óÈÅìÂõæ
        const tk = "9ed3674d01dd7c129ab38e3c38bf651a";

        // Â§©Âú∞ÂõæË°óÈÅìÂõæ - ‰ΩøÁî®XYZÁì¶ÁâáÊúçÂä°
        const vecLayer = L.tileLayer(`https://t{s}.tianditu.gov.cn/vec_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=vec&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`, {
            attribution: '¬© Â§©Âú∞Âõæ',
            maxZoom: 18,
            tileSize: 256,
            subdomains: ['0', '1', '2', '3', '4', '5', '6', '7']
        });

        // Â§©Âú∞ÂõæË°óÈÅìÂõæÊ†áÊ≥®
        const cvaLayer = L.tileLayer(`https://t{s}.tianditu.gov.cn/cva_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cva&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`, {
            attribution: '¬© Â§©Âú∞Âõæ',
            maxZoom: 18,
            tileSize: 256,
            subdomains: ['0', '1', '2', '3', '4', '5', '6', '7']
        });

        // Â§©Âú∞ÂõæÂç´ÊòüÂõæ - ‰ΩøÁî®XYZÁì¶ÁâáÊúçÂä°
        const imgLayer = L.tileLayer(`https://t{s}.tianditu.gov.cn/img_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=img&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`, {
            attribution: '¬© Â§©Âú∞Âõæ',
            maxZoom: 18,
            tileSize: 256,
            subdomains: ['0', '1', '2', '3', '4', '5', '6', '7']
        });

        // Â§©Âú∞ÂõæÂç´ÊòüÂõæÊ†áÊ≥®
        const ciaLayer = L.tileLayer(`https://t{s}.tianditu.gov.cn/cia_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cia&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`, {
            attribution: '¬© Â§©Âú∞Âõæ',
            maxZoom: 18,
            tileSize: 256,
            subdomains: ['0', '1', '2', '3', '4', '5', '6', '7']
        });

        // Ê∑ªÂä†ÂõæÂ±ÇÂä†ËΩΩ‰∫ã‰ª∂ÁõëÂê¨
        vecLayer.on('load', function() {
            console.log('Â§©Âú∞ÂõæË°óÈÅìÂõæÂ±ÇÂä†ËΩΩÂÆåÊàê');
            updateStatus('Â§©Âú∞ÂõæË°óÈÅìÂõæÂ±ÇÂä†ËΩΩÂÆåÊàê');
        });

        imgLayer.on('load', function() {
            console.log('Â§©Âú∞ÂõæÂç´ÊòüÂõæÂ±ÇÂä†ËΩΩÂÆåÊàê');
            updateStatus('Â§©Âú∞ÂõæÂç´ÊòüÂõæÂ±ÇÂä†ËΩΩÂÆåÊàê');
        });

        vecLayer.on('error', function(e) {
            console.error('Â§©Âú∞ÂõæË°óÈÅìÂõæÂ±ÇÂä†ËΩΩÈîôËØØ:', e);
            updateStatus('Â§©Âú∞ÂõæË°óÈÅìÂõæÂ±ÇÂä†ËΩΩÂ§±Ë¥•');
        });

        imgLayer.on('error', function(e) {
            console.error('Â§©Âú∞ÂõæÂç´ÊòüÂõæÂ±ÇÂä†ËΩΩÈîôËØØ:', e);
            updateStatus('Â§©Âú∞ÂõæÂç´ÊòüÂõæÂ±ÇÂä†ËΩΩÂ§±Ë¥•');
        });

        // ÂàõÂª∫ÂõæÂ±ÇÁªÑ
        currentBaseLayer = L.layerGroup([vecLayer, cvaLayer]);
        currentSatelliteLayer = L.layerGroup([imgLayer, ciaLayer]);

        console.log('currentBaseLayer created:', currentBaseLayer);
        console.log('currentSatelliteLayer created:', currentSatelliteLayer);

        // ÈªòËÆ§ÊòæÁ§∫Âç´ÊòüÂõæ
        currentSatelliteLayer.addTo(map);

        console.log('Satellite layer added to map');
        console.log('currentMapType initialized to: satellite');
    }

    // ÁªëÂÆöÂú∞Âõæ‰∫ã‰ª∂
    function bindMapEvents() {
        // Èº†Ê†áÁßªÂä®‰∫ã‰ª∂ - Êõ¥Êñ∞ÂùêÊ†áÊòæÁ§∫
        map.on('mousemove', function(e) {
            const lat = e.latlng.lat.toFixed(6);
            const lng = e.latlng.lng.toFixed(6);
            const coordinateInfo = document.getElementById('coordinateInfo');
            if (coordinateInfo) {
                coordinateInfo.textContent = `ÁªèÂ∫¶: ${lng}, Á∫¨Â∫¶: ${lat}`;
            }
        });

        // Âú∞ÂõæÊéß‰ª∂‰∫ã‰ª∂
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const resetViewBtn = document.getElementById('resetViewBtn');

        if (zoomInBtn) {
            zoomInBtn.addEventListener('click', function() {
                map.zoomIn();
            });
        }

        if (zoomOutBtn) {
            zoomOutBtn.addEventListener('click', function() {
                map.zoomOut();
            });
        }

        if (resetViewBtn) {
            resetViewBtn.addEventListener('click', function() {
                map.setView([39.9042, 116.4074], 11);
            });
        }
    }

    // Áä∂ÊÄÅÊõ¥Êñ∞
    function updateStatus(message) {
        const statusInfo = document.getElementById('statusInfo');
        if (statusInfo) {
            // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®
            if (statusMessageTimer) {
                clearTimeout(statusMessageTimer);
                statusMessageTimer = null;
            }
            
            statusInfo.textContent = message;
            statusInfo.style.display = 'block';
            
            // ËÆæÁΩÆÊñ∞ÁöÑÂÆöÊó∂Âô®
            statusMessageTimer = setTimeout(() => {
                statusInfo.style.display = 'none';
                statusMessageTimer = null;
            }, 1000);
        }
    }

    // Ê†áÁ≠æÈ°µÂàáÊç¢
    function bindTabEvents() {
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');

        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const targetTab = this.dataset.tab;

                // ÁßªÈô§ÊâÄÊúâÊ¥ªÂä®Áä∂ÊÄÅ
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));

                // Ê∑ªÂä†Ê¥ªÂä®Áä∂ÊÄÅ
                this.classList.add('active');
                document.getElementById(targetTab + '-tab').classList.add('active');
            });
        });
    }

    // È¢úËâ≤ÈÄâÊã©Âô®‰∫ã‰ª∂
    function bindColorPickerEvents() {
        // ËΩ®ËøπÁ∫øÈ¢úËâ≤
        const trackLineColorPicker = document.getElementById('trackLineColorPicker');
        const trackLineColorInput = document.getElementById('trackLineColorInput');

        if (trackLineColorPicker && trackLineColorInput) {
            trackLineColorPicker.addEventListener('click', function() {
                trackLineColorInput.click();
            });

            trackLineColorInput.addEventListener('change', function() {
                currentTrackLineColor = this.value;
                trackLineColorPicker.style.backgroundColor = currentTrackLineColor;
            });
        }

        // ËΩ®ËøπÁÇπÈ¢úËâ≤
        const trackPointColorPicker = document.getElementById('trackPointColorPicker');
        const trackPointColorInput = document.getElementById('trackPointColorInput');

        if (trackPointColorPicker && trackPointColorInput) {
            trackPointColorPicker.addEventListener('click', function() {
                trackPointColorInput.click();
            });

            trackPointColorInput.addEventListener('change', function() {
                currentTrackPointColor = this.value;
                trackPointColorPicker.style.backgroundColor = currentTrackPointColor;
            });
        }
    }

    // Â∑•ÂÖ∑ÊåâÈíÆ‰∫ã‰ª∂
    function bindToolEvents() {
        // ÊµãË∑ùÊåâÈíÆ
        const measureDistanceBtn = document.getElementById('measureDistanceBtn');
        if (measureDistanceBtn) {
            measureDistanceBtn.addEventListener('click', startMeasureDistance);
        }

        // ÊµãÈù¢ÊåâÈíÆ
        const measureAreaBtn = document.getElementById('measureAreaBtn');
        if (measureAreaBtn) {
            measureAreaBtn.addEventListener('click', startMeasureArea);
        }

        // Âú∞ÂõæÁ±ªÂûãÂàáÊç¢
        const mapTypeBtn = document.getElementById('mapTypeBtn');
        if (mapTypeBtn) {
            mapTypeBtn.addEventListener('click', toggleMapType);
        }

        // Ê∏ÖÁ©∫ÊâÄÊúâ
        const clearAllBtn = document.getElementById('clearAllBtn');
        if (clearAllBtn) {
            clearAllBtn.addEventListener('click', clearAll);
        }

        // ËΩ®ËøπÁõ∏ÂÖ≥ÊåâÈíÆ
        const drawTrackBtn = document.getElementById('drawTrackButton');
        const showTrackPointsBtn = document.getElementById('showTrackPointsButton');
        const clearTrackBtn = document.getElementById('clearTrackButton');

        if (drawTrackBtn) drawTrackBtn.addEventListener('click', drawTrack);
        if (showTrackPointsBtn) showTrackPointsBtn.addEventListener('click', showTrackPoints);
        if (clearTrackBtn) clearTrackBtn.addEventListener('click', clearTrack);

        // ËΩ®ËøπÂõûÊîæÂàáÊç¢ÊåâÈíÆ - ÂßãÁªàÂèØÁÇπÂáªÔºåÁÇπÂáªÊó∂ËøõË°åÂàùÂßãÂåñÊ£ÄÊü•
        const playbackToggleBtn = document.getElementById('playbackToggleBtn');
        if (playbackToggleBtn) {
            // ÁßªÈô§disabledÂ±ûÊÄßÔºå‰ΩøÊåâÈíÆÂßãÁªàÂèØÁÇπÂáª
            playbackToggleBtn.disabled = false;
            
            playbackToggleBtn.addEventListener('click', function() {
                // Â¶ÇÊûúÊí≠ÊîæÂô®Â∑≤ÊòæÁ§∫ÔºåÂàôÈöêËóè
                if (playbackPlayer.style.display === 'block') {
                    hidePlaybackPlayer();
                    return;
                }
                
                // Ê£ÄÊü•ÊòØÂê¶ÊúâËΩ®ËøπÊï∞ÊçÆ
                if (!playbackState.points || playbackState.points.length === 0) {
                    // Â∞ùËØï‰ªétextareaËß£ÊûêËΩ®ËøπÊï∞ÊçÆ
                    const trackTextarea = document.getElementById('trackTextarea');
                    if (trackTextarea && trackTextarea.value.trim()) {
                        try {
                            parseTrackPoints(trackTextarea.value.trim());
                        } catch (e) {
                            updateStatus('ËΩ®ËøπÊï∞ÊçÆÊ†ºÂºèÈîôËØØÔºåÊó†Ê≥ïÊâìÂºÄÊí≠ÊîæÂô®');
                            return;
                        }
                    }
                }
                
                // ÂÜçÊ¨°Ê£ÄÊü•ÊòØÂê¶ÊúâÊúâÊïàËΩ®ËøπÊï∞ÊçÆ
                if (!playbackState.points || playbackState.points.length === 0) {
                    updateStatus('Ê≤°ÊúâÊúâÊïàÁöÑËΩ®ËøπÊï∞ÊçÆÔºåÊó†Ê≥ïÊâìÂºÄÊí≠ÊîæÂô®');
                    return;
                }
                
                // ÊòæÁ§∫Êí≠ÊîæÂô®
                showPlaybackPlayer();
            });
        }

        // Êñ∞Êí≠ÊîæÂô®ÊéßÂà∂‰∫ã‰ª∂
        if (playerCloseBtn) playerCloseBtn.addEventListener('click', hidePlaybackPlayer);
        if (playerPlayBtn) playerPlayBtn.addEventListener('click', togglePlayback);

        if (playerStopBtn) playerStopBtn.addEventListener('click', stopPlayback);
        
        // ÂàùÂßãÂåñÊí≠ÊîæÂô®ÊåâÈíÆÁä∂ÊÄÅ
        updatePlayerControls();
        
        // ÈÄüÂ∫¶ÊªëÂùó
        if (playerSpeedSlider) {
            playerSpeedSlider.addEventListener('input', function() {
                // Â∞ÜÊªëÂùóÂÄºËΩ¨Êç¢‰∏∫ÊåáÊï∞ÂÄçÊï∞Ôºö1,2,4,8,16,32,64,128,256,512,1024
                const sliderValue = parseInt(this.value);
                let speed;
                
                if (sliderValue === 1) {
                    speed = 1;
                } else {
                    // ËÆ°ÁÆó2ÁöÑÂπÇÊ¨°Ôºö2^0=1, 2^1=2, 2^2=4, ..., 2^10=1024
                    const power = Math.floor(Math.log2(sliderValue));
                    speed = Math.pow(2, power);
                }
                
                // ÈôêÂà∂ÊúÄÂ§ßÂÄº
                speed = Math.min(speed, 1024);
                
                // Á°Æ‰øùÊòØ2ÁöÑÂπÇÊ¨°ÂÄçÊï∞Ôºö1,2,4,8,16,32,64,128,256,512,1024
                const validSpeeds = [1, 2, 4, 8, 16, 32, 64, 128, 256, 512, 1024];
                speed = validSpeeds.find(s => s >= speed) || 1024;
                
                playbackState.speed = speed;
                if (playerSpeedValue) playerSpeedValue.textContent = speed + 'x';
                
                // Â¶ÇÊûúÊ≠£Âú®Êí≠ÊîæÔºåÂ∫îÁî®Êñ∞ÈÄüÂ∫¶Ôºà‰øùÊåÅÂΩìÂâç‰ΩçÁΩÆÁªßÁª≠Êí≠ÊîæÔºâ
                if (playbackState.isPlaying) {
                    // ‰∏çÈúÄË¶ÅÊöÇÂÅúÂíåÈáçÊñ∞ÂºÄÂßãÔºåÈÄüÂ∫¶‰ºöÂú®‰∏ã‰∏Ä‰∏™ÁÇπËá™Âä®Â∫îÁî®
                    updateStatus(`Êí≠ÊîæÈÄüÂ∫¶Â∑≤Ë∞ÉÊï¥‰∏∫ ${speed}x`);
                }
            });
        }
        
        // ËøõÂ∫¶ÊªëÂùó
        if (playerProgressSlider) {
            playerProgressSlider.addEventListener('input', function() {
                const percentage = parseInt(this.value);
                if (playbackState.points && playbackState.points.length > 0) {
                    const index = Math.floor((percentage / 100) * (playbackState.points.length - 1));
                    const wasPlaying = playbackState.isPlaying; // ËÆ∞ÂΩïÊí≠ÊîæÁä∂ÊÄÅ
                    jumpToPoint(index);
                    // Â¶ÇÊûú‰πãÂâçÂú®Êí≠ÊîæÔºåÁªßÁª≠Êí≠Êîæ
                    if (wasPlaying) {
                        setTimeout(() => {
                            playbackState.isPlaying = true;
                            playbackNextPoint();
                        }, 100);
                    }
                }
            });
        }

        // ËΩ®ËøπÊñáÊú¨Ê°Ü‰∫ã‰ª∂ÁõëÂê¨ - Ê†πÊçÆÂÜÖÂÆπÂêØÁî®/Á¶ÅÁî®ÊåâÈíÆ
        const trackTextarea = document.getElementById('trackTextarea');
        if (trackTextarea) {
            function updateTrackButtons() {
                const hasContent = trackTextarea.value.trim().length > 0;
                if (drawTrackBtn) drawTrackBtn.disabled = !hasContent;
                if (showTrackPointsBtn) showTrackPointsBtn.disabled = !hasContent;
                if (clearTrackBtn) clearTrackBtn.disabled = !hasContent;
                
                // Â¶ÇÊûúÊúâËΩ®ËøπÂÜÖÂÆπÔºåÂ∞ùËØïËá™Âä®Ëß£Êûê‰ª•ÂêØÁî®Êí≠ÊîæÊåâÈíÆ
                if (hasContent) {
                    try {
                        const trackText = trackTextarea.value.trim();
                        const lines = trackText.split('\n');
                        let hasValidTrackData = false;
                        
                        // Ê£ÄÊü•ÊòØÂê¶ÊúâÊúâÊïàÁöÑËΩ®ËøπÊï∞ÊçÆÊ†ºÂºè
                        for (let line of lines) {
                            line = line.trim();
                            if (!line) continue;
                            
                            const parts = line.split(',');
                            if (parts.length >= 3) {
                                // Ê£ÄÊü•‰∏§ÁßçÊ†ºÂºèÔºöÁªèÂ∫¶,Á∫¨Â∫¶,Êó∂Èó¥Êà≥ Êàñ Êó∂Èó¥Êà≥,ÁªèÂ∫¶,Á∫¨Â∫¶
                                const part1 = parts[0].trim();
                                const part2 = parts[1].trim();
                                const part3 = parts[2].trim();
                                
                                // Â¶ÇÊûúÊòØÊúâÊïàÁöÑÊï∞Â≠óÊ†ºÂºèÔºåÂàôËÆ§‰∏∫ÊúâÊúâÊïàËΩ®ËøπÊï∞ÊçÆ
                                if ((!isNaN(part1) && !isNaN(part2) && part3) || 
                                    (!isNaN(part2) && !isNaN(part3) && part1)) {
                                    hasValidTrackData = true;
                                    break;
                                }
                            }
                        }
                        
                        // Êí≠ÊîæÊåâÈíÆÁé∞Âú®ÂßãÁªàÂèØÁÇπÂáªÔºå‰∏çÈúÄË¶ÅÊ†πÊçÆËß£ÊûêÁªìÊûúÂêØÁî®/Á¶ÅÁî®
                        // Â¶ÇÊûúÊâæÂà∞ÊúâÊïàÊï∞ÊçÆÔºåËá™Âä®Ëß£ÊûêÂà∞playbackState
                        if (hasValidTrackData) {
                            const points = [];
                            lines.forEach(line => {
                                line = line.trim();
                                if (!line) return;
                                
                                const parts = line.split(',');
                                if (parts.length >= 3) {
                                    let lng, lat, timestamp;
                                    
                                    // Âà§Êñ≠Ê†ºÂºè
                                    if (parts[0].trim().length > 10 && !isNaN(parts[0].trim())) {
                                        // Ê†ºÂºèÔºöÊó∂Èó¥Êà≥,ÁªèÂ∫¶,Á∫¨Â∫¶
                                        timestamp = parts[0].trim();
                                        lng = parseFloat(parts[1].trim());
                                        lat = parseFloat(parts[2].trim());
                                    } else {
                                        // Ê†ºÂºèÔºöÁªèÂ∫¶,Á∫¨Â∫¶,Êó∂Èó¥Êà≥
                                        lng = parseFloat(parts[0].trim());
                                        lat = parseFloat(parts[1].trim());
                                        timestamp = parts[2].trim();
                                    }
                                    
                                    if (!isNaN(lng) && !isNaN(lat) && timestamp) {
                                        points.push({
                                            lat: lat,
                                            lng: lng,
                                            timestamp: timestamp
                                        });
                                    }
                                }
                            });
                            
                            // ‰øùÂ≠òËß£ÊûêÁöÑËΩ®ËøπÁÇπ
                            if (points.length > 0) {
                                playbackState.points = points;
                            }
                        }
                        
                    } catch (e) {
                        // Ëß£ÊûêÂ§±Ë¥•Êó∂ÔºåÊ∏ÖÁ©∫ËΩ®ËøπÁÇπ
                        playbackState.points = [];
                    }
                } else {
                    // Ê≤°ÊúâÂÜÖÂÆπÊó∂ÔºåÊ∏ÖÁ©∫ËΩ®ËøπÁÇπ
                    playbackState.points = [];
                }
            }
            
            // ÂàùÂßãÁä∂ÊÄÅ
            updateTrackButtons();
            
            // ÁõëÂê¨ËæìÂÖ•‰∫ã‰ª∂
            trackTextarea.addEventListener('input', updateTrackButtons);
            trackTextarea.addEventListener('change', updateTrackButtons);
        }
    }

    // ËΩÆÂªìÁªòÂà∂ÂáΩÊï∞
    function drawOutline() {
        const wktText = document.getElementById('outlineWkt').value.trim();
        if (!wktText) {
            alert('ËØ∑ËæìÂÖ•WKTÊï∞ÊçÆ');
            return;
        }

        clearOutline();

        try {
            // Ê£ÄÊü•ÊòØÂê¶‰∏∫Â§öË°åWKT
            const wktLines = wktText.split('\n').filter(line => line.trim());
            let polygonData = [];

            if (wktLines.length === 1) {
                // ÂçïË°åWKT - ‰ΩøÁî®ÂéüÂßãÈÄªËæë
                const geojson = wellknown.parse(wktLines[0].trim());
                if (geojson.type === "Polygon") {
                    polygonData.push({ index: 1, geojson: geojson, colorIndex: 0 });
                } else if (geojson.type === "MultiPolygon") {
                    geojson.coordinates.forEach((polygon, index) => {
                        // Â∞ÜMultiPolygonÁöÑÊØè‰∏™Â≠êÂ§öËæπÂΩ¢ËΩ¨Êç¢‰∏∫ÂçïÁã¨ÁöÑPolygon
                        const singlePolygon = {
                            type: "Polygon",
                            coordinates: polygon
                        };
                        polygonData.push({ index: index + 1, geojson: singlePolygon, colorIndex: index });
                    });
                }
            } else {
                // Â§öË°åWKT - ÊØèË°å‰∏Ä‰∏™Â§öËæπÂΩ¢
                wktLines.forEach((line, index) => {
                    if (line.trim()) {
                        try {
                            const geojson = wellknown.parse(line.trim());
                            if (geojson.type === "Polygon") {
                                polygonData.push({ index: index + 1, geojson: geojson, colorIndex: index });
                            } else if (geojson.type === "MultiPolygon") {
                                // Â¶ÇÊûú‰∏ÄË°åÊòØMultiPolygonÔºåÊãÜÂàÜÊàêÂ§ö‰∏™Polygon
                                geojson.coordinates.forEach((polygon, subIndex) => {
                                    const singlePolygon = {
                                        type: "Polygon",
                                        coordinates: polygon
                                    };
                                    polygonData.push({
                                        index: index + 1 + subIndex * 0.1,
                                        geojson: singlePolygon,
                                        colorIndex: index
                                    });
                                });
                            }
                        } catch (e) {
                            console.warn(`Á¨¨${index + 1}Ë°åWKTËß£ÊûêÂ§±Ë¥•:`, e);
                        }
                    }
                });
            }

            // ‰∏∫ÊØè‰∏™Â§öËæπÂΩ¢ÂàõÂª∫ÂõæÂ±Ç
            polygonData.forEach((data, idx) => {
                const colorScheme = polygonColors[data.colorIndex % polygonColors.length];
                const style = {
                    color: colorScheme.outline,
                    weight: 1,
                    opacity: 1,
                    fillColor: colorScheme.fill,
                    fillOpacity: colorScheme.opacity
                };

                const polygonLayer = L.geoJSON(data.geojson, {
                    style: style
                });

                outlineLayerGroup.addLayer(polygonLayer);

                // ËÆ°ÁÆóÈù¢ÁßØÂπ∂Ê∑ªÂä†‰∫©Êï∞Ê†áÁ≠æ
                if (typeof L !== 'undefined' && typeof L.GeometryUtil !== 'undefined' && typeof L.GeometryUtil.geodesicArea === 'function') {
                    try {
                        // Ëé∑ÂèñÂõæÂ±Ç‰∏≠ÁöÑË¶ÅÁ¥†ËøõË°åÈù¢ÁßØËÆ°ÁÆó
                        let layers = [];

                        // Â¶ÇÊûúpolygonLayerÊòØLayerGroupÊàñFeatureGroupÔºåËé∑ÂèñÂÖ∂ÊâÄÊúâÂ≠êÂõæÂ±Ç
                        if (polygonLayer instanceof L.LayerGroup || polygonLayer instanceof L.FeatureGroup) {
                            layers = polygonLayer.getLayers();
                        } else {
                            // ÂØπ‰∫éÂÖ∂‰ªñÁ±ªÂûãÁöÑÂõæÂ±ÇÔºåÊ£ÄÊü•ÊòØÂê¶ÊúâgetLayersÊñπÊ≥ï
                            layers = polygonLayer.getLayers ? polygonLayer.getLayers() : [polygonLayer];
                        }

                        if (layers && Array.isArray(layers) && layers.length > 0) {
                            for (let j = 0; j < layers.length; j++) {
                                const layer = layers[j];
                                let latLngs;

                                // Ê†πÊçÆÂõæÂ±ÇÁ±ªÂûãËé∑ÂèñÂùêÊ†á
                                if (layer && typeof layer.getLatLngs === 'function') {
                                    if (layer instanceof L.Polygon) {
                                        latLngs = layer.getLatLngs();
                                    } else if (layer instanceof L.MultiPolygon) {
                                        // ÂØπ‰∫éMultiPolygonÔºåÂèñÁ¨¨‰∏Ä‰∏™Â§öËæπÂΩ¢
                                        const multiLatLngs = layer.getLatLngs();
                                        if (multiLatLngs && Array.isArray(multiLatLngs) && multiLatLngs.length > 0) {
                                            latLngs = multiLatLngs[0];
                                        }
                                    }

                                    if (latLngs) {
                                        // Â§ÑÁêÜlatLngsÊ†ºÂºèÔºåÁ°Æ‰øùÊ≠£Á°ÆËÆ°ÁÆóÈù¢ÁßØ
                                        let areaLatLngs = latLngs;
                                        if (Array.isArray(latLngs) && latLngs.length > 0) {
                                            areaLatLngs = latLngs[0] || latLngs;
                                        }

                                        let areaSqM, areaMu;
                                        if (typeof L.GeometryUtil !== 'undefined' && typeof L.GeometryUtil.geodesicArea === 'function') {
                                            areaSqM = L.GeometryUtil.geodesicArea(areaLatLngs);
                                            areaMu = (areaSqM / 666.6667).toFixed(4); // ËΩ¨Êç¢‰∏∫‰∫©
                                            console.log('‰ΩøÁî®L.GeometryUtilËÆ°ÁÆóÂ§öËæπÂΩ¢Èù¢ÁßØ:', areaSqM, 'Âπ≥ÊñπÁ±≥ (', areaMu, '‰∫©)');
                                        } else if (typeof turf !== 'undefined') {
                                            // ‰ΩøÁî®Turf.js‰Ωú‰∏∫Â§áÈÄâÊñπÊ°à
                                            try {
                                                // Â§ÑÁêÜÂ§öËæπÂΩ¢ÂùêÊ†áÔºåÊîØÊåÅÂ§ñÈÉ®ËæπÁïåÂíåÂÜÖÈÉ®Â≠îÊ¥û
                                                const processPolygon = (polyCoords) => {
                                                    if (!Array.isArray(polyCoords) || polyCoords.length === 0) {
                                                        return null;
                                                    }

                                                    // Â¶ÇÊûúÊòØÂ§öËæπÂΩ¢Êï∞ÁªÑÔºàÂ§ñÈÉ®ËæπÁïå+Â≠îÊ¥ûÔºâÔºåÂàÜÂà´Â§ÑÁêÜ
                                                    let processedCoords = [];

                                                    // Â§ÑÁêÜÂ§öËæπÂΩ¢ÁöÑÊØè‰∏™ÁéØÔºàÁ¨¨‰∏Ä‰∏™ÊòØÂ§ñÈÉ®ËæπÁïåÔºåÂÖ∂‰ΩôÊòØÂ≠îÊ¥ûÔºâ
                                                    for (let i = 0; i < polyCoords.length; i++) {
                                                        let ring = polyCoords[i];
                                                        if (!Array.isArray(ring)) {
                                                            ring = [ring]; // Â¶ÇÊûú‰∏çÊòØÊï∞ÁªÑÔºåËΩ¨Êç¢‰∏∫Êï∞ÁªÑ
                                                        }

                                                        // Â∞ÜLeafletÂùêÊ†áËΩ¨Êç¢‰∏∫GeoJSONÊ†ºÂºè [lng, lat]
                                                        let geoJsonRing = ring.map(latLng => {
                                                            if (latLng.lat !== undefined && latLng.lng !== undefined) {
                                                                return [latLng.lng, latLng.lat];
                                                            } else if (Array.isArray(latLng) && latLng.length >= 2) {
                                                                // Â¶ÇÊûúÂ∑≤ÁªèÊòØÊï∞ÁªÑÊ†ºÂºè [lat, lng] Êàñ [lng, lat]
                                                                return [latLng[1], latLng[0]]; // ÂÅáËÆæÊòØ [lat, lng] Ê†ºÂºè
                                                            }
                                                            return null;
                                                        }).filter(coord => coord !== null);

                                                        // Á°Æ‰øùÁéØÊòØÈó≠ÂêàÁöÑÔºàËá≥Â∞ëÊúâ4‰∏™ÁÇπÔºåÈ¶ñÂ∞æÁõ∏ÂêåÔºâ
                                                        if (geoJsonRing.length >= 3) {
                                                            // Â¶ÇÊûúÈ¶ñÂ∞æ‰∏çÁõ∏ÂêåÔºåÈó≠ÂêàÁéØ
                                                            if (geoJsonRing[0][0] !== geoJsonRing[geoJsonRing.length - 1][0] ||
                                                                geoJsonRing[0][1] !== geoJsonRing[geoJsonRing.length - 1][1]) {
                                                                geoJsonRing.push(geoJsonRing[0]);
                                                            }

                                                            // Á°Æ‰øùËá≥Â∞ëÊúâ4‰∏™ÁÇπÔºàÈó≠ÂêàÂêéÔºâ
                                                            if (geoJsonRing.length < 4) {
                                                                // Â¶ÇÊûúÁÇπÊï∞‰∏çË∂≥4‰∏™ÔºåÂ§çÂà∂ÁÇπÁõ¥Âà∞ËææÂà∞4‰∏™
                                                                while (geoJsonRing.length < 4) {
                                                                    geoJsonRing.push(geoJsonRing[geoJsonRing.length - 1]);
                                                                }
                                                            }
                                                        } else if (geoJsonRing.length === 2) {
                                                            // Â¶ÇÊûúÂè™Êúâ2‰∏™ÁÇπÔºåÂ§çÂà∂ÂÆÉ‰ª¨ÂΩ¢ÊàêËá≥Â∞ë4‰∏™ÁÇπÁöÑÁéØ
                                                            geoJsonRing.push(geoJsonRing[1]);
                                                            geoJsonRing.push(geoJsonRing[0]);
                                                        } else if (geoJsonRing.length === 1) {
                                                            // Â¶ÇÊûúÂè™Êúâ1‰∏™ÁÇπÔºåÂ§çÂà∂3Ê¨°ÂΩ¢Êàê4‰∏™ÁÇπÁöÑÁéØ
                                                            for (let k = 0; k < 3; k++) {
                                                                geoJsonRing.push(geoJsonRing[0]);
                                                            }
                                                        }

                                                        processedCoords.push(geoJsonRing);
                                                    }

                                                    return processedCoords;
                                                };

                                                // Ê†πÊçÆareaLatLngsÁöÑÁªìÊûÑÂ§ÑÁêÜÂùêÊ†á
                                                let coordinates;
                                                if (Array.isArray(areaLatLngs) && areaLatLngs.length > 0) {
                                                    if (Array.isArray(areaLatLngs[0])) {
                                                        // Â¶ÇÊûúÊòØÂ§öËæπÂΩ¢Êï∞ÁªÑÔºàÂåÖÂê´Â§ñÈÉ®ËæπÁïåÂíåÂ≠îÊ¥ûÔºâ
                                                        coordinates = processPolygon(areaLatLngs);
                                                    } else {
                                                        // Â¶ÇÊûúÊòØÂçï‰∏™Â§öËæπÂΩ¢ËæπÁïå
                                                        coordinates = processPolygon([areaLatLngs]);
                                                    }
                                                } else {
                                                    // Âçï‰∏™Â§öËæπÂΩ¢ËæπÁïå
                                                    coordinates = processPolygon([areaLatLngs]);
                                                }

                                                if (coordinates && coordinates.length > 0) {
                                                    const polygon = turf.polygon(coordinates);
                                                    areaSqM = turf.area(polygon);
                                                    areaMu = (areaSqM / 666.6667).toFixed(4); // ËΩ¨Êç¢‰∏∫‰∫©
                                                    console.log('‰ΩøÁî®Turf.jsËÆ°ÁÆóÂ§öËæπÂΩ¢Èù¢ÁßØ:', areaSqM, 'Âπ≥ÊñπÁ±≥ (', areaMu, '‰∫©)');
                                                } else {
                                                    console.log('Êó†Ê≥ïÂ§ÑÁêÜÂùêÊ†áÊï∞ÊçÆÔºå‰ΩøÁî®ÈªòËÆ§Èù¢ÁßØ');
                                                    areaSqM = 0;
                                                    areaMu = '0.0000';
                                                }
                                            } catch (e) {
                                                console.error('‰ΩøÁî®Turf.jsËÆ°ÁÆóÈù¢ÁßØÊó∂Âá∫Èîô:', e);
                                                areaSqM = 0;
                                                areaMu = '0.0000';
                                            }
                                        } else {
                                            console.error('L.GeometryUtilÂíåTurf.jsÈÉΩ‰∏çÂèØÁî®ÔºåÊó†Ê≥ïËÆ°ÁÆóÈù¢ÁßØ');
                                            areaSqM = 0;
                                            areaMu = '0.0000';
                                        }

                                        console.log('ËÆ°ÁÆóÂ§öËæπÂΩ¢Èù¢ÁßØ:', areaSqM, 'Âπ≥ÊñπÁ±≥ (', areaMu, '‰∫©)');

                                        // Â¶ÇÊûúÊ†áÁ≠æÂ∑≤ÂêØÁî®ÔºåÂàôÊ∑ªÂä†Èù¢ÁßØÊ†áÁ≠æ
                                        if (labelsEnabled) {
                                            console.log('Ê†áÁ≠æÂ∑≤ÂêØÁî®Ôºå‰∏∫Â§öËæπÂΩ¢Ê∑ªÂä†Èù¢ÁßØÊ†áÁ≠æ');
                                            addAreaLabelToLayer(polygonLayer, `Èù¢ÁßØ: ${areaMu}‰∫©`);
                                            console.log('ÂΩìÂâçÊ†áÁ≠æÂõæÂ±Ç‰∏≠ÁöÑÂõæÂ±ÇÊï∞Èáè:', labelLayerGroup.getLayers().length);
                                        } else {
                                            console.log('Ê†áÁ≠æÊú™ÂêØÁî®Ôºå‰∏çÊ∑ªÂä†Èù¢ÁßØÊ†áÁ≠æ');
                                        }
                                        break; // Âè™Â§ÑÁêÜÁ¨¨‰∏Ä‰∏™ÊúâÊïàÁöÑÂõæÂ±ÇÊù•ËÆ°ÁÆóÈù¢ÁßØ
                                    }
                                }
                            }
                        }
                    } catch (areaError) {
                        console.warn('Èù¢ÁßØËÆ°ÁÆóÈîôËØØ:', areaError);
                    }
                }
            });

            // Ëá™ÈÄÇÂ∫îËßÜÈáé
            if (outlineLayerGroup && outlineLayerGroup.getLayers && outlineLayerGroup.getLayers().length > 0) {
                // ËÆ°ÁÆóÊâÄÊúâÂ≠êÂõæÂ±ÇÁöÑÊï¥‰ΩìËæπÁïå
                const layers = outlineLayerGroup.getLayers();
                let groupBounds = null;

                for (let i = 0; i < layers.length; i++) {
                    const layer = layers[i];
                    let layerBounds;

                    // Ê£ÄÊü•ÂõæÂ±ÇÊòØÂê¶‰∏∫LayerGroupÊàñFeatureGroup
                    if (layer instanceof L.LayerGroup || layer instanceof L.FeatureGroup) {
                        try {
                            layerBounds = layer.getBounds();
                        } catch (e) {
                            // Â¶ÇÊûúLayerGroup/FeatureGroupÊ≤°ÊúâgetBoundsÊñπÊ≥ïÔºåÈÅçÂéÜÂÖ∂Â≠êÂõæÂ±Ç
                            const subLayers = layer.getLayers();
                            for (let j = 0; j < subLayers.length; j++) {
                                try {
                                    const subLayerBounds = subLayers[j].getBounds();
                                    if (subLayerBounds && subLayerBounds.isValid && subLayerBounds.isValid()) {
                                        if (!groupBounds) {
                                            groupBounds = subLayerBounds;
                                        } else {
                                            groupBounds.extend(subLayerBounds);
                                        }
                                    }
                                } catch (e) {
                                    continue;
                                }
                            }
                            continue; // ÁªßÁª≠Â§ñÂ±ÇÂæ™ÁéØ
                        }
                    } else {
                        try {
                            layerBounds = layer.getBounds();
                        } catch (e) {
                            continue; // Â∞ùËØï‰∏ã‰∏Ä‰∏™ÂõæÂ±Ç
                        }
                    }

                    if (layerBounds && layerBounds.isValid && layerBounds.isValid()) {
                        if (!groupBounds) {
                            groupBounds = layerBounds;
                        } else {
                            groupBounds.extend(layerBounds);
                        }
                    }
                }

                if (groupBounds && groupBounds.isValid && groupBounds.isValid()) {
                    map.fitBounds(groupBounds, { padding: [20, 20] });
                }
            }

            updateStatus(`ËΩÆÂªìÁªòÂà∂ÂÆåÊàêÔºåÂÖ±${polygonData.length}‰∏™Â§öËæπÂΩ¢`);

        } catch (error) {
            console.error('WKTËß£ÊûêÈîôËØØ:', error);
            updateStatus('WKTËß£ÊûêÂ§±Ë¥•: ' + error.message);
        }
    }

    // Ê∏ÖÈô§ËΩÆÂªì
    function clearOutline() {
        outlineLayerGroup.clearLayers();
        currentOutline = null;
        updateStatus('ËΩÆÂªìÂ∑≤Ê∏ÖÈô§');
    }

    // ‰∏∫ÂõæÂ±ÇÊ∑ªÂä†Ê†áÁ≠æ
    function addLabelsToLayer(layer, prefix) {
        try {
            // Â¶ÇÊûúlayerÊòØLayerGroupÊàñFeatureGroupÔºåÈúÄË¶ÅËé∑ÂèñÂÖ∂‰∏≠ÁöÑÁ¨¨‰∏Ä‰∏™ÂõæÂ±ÇÊù•Ëé∑ÂèñËæπÁïå
            let bounds;
            if (layer instanceof L.LayerGroup || layer instanceof L.FeatureGroup) {
                const layers = layer.getLayers();
                if (layers && layers.length > 0) {
                    // ÈÅçÂéÜÊâÄÊúâÂ≠êÂõæÂ±ÇÊù•Ëé∑ÂèñÊúâÊïàÁöÑËæπÁïå
                    for (let i = 0; i < layers.length; i++) {
                        try {
                            const subLayer = layers[i];
                            let subLayerBounds;

                            // Ê£ÄÊü•Â≠êÂõæÂ±ÇÊòØÂê¶‰∏∫LayerGroupÊàñFeatureGroup
                            if (subLayer instanceof L.LayerGroup || subLayer instanceof L.FeatureGroup) {
                                // ÈÄíÂΩíÂ§ÑÁêÜÂµåÂ•óÁöÑLayerGroupÊàñFeatureGroup
                                const subSubLayers = subLayer.getLayers();
                                for (let j = 0; j < subSubLayers.length; j++) {
                                    try {
                                        const subSubLayerBounds = subSubLayers[j].getBounds();
                                        if (subSubLayerBounds && subSubLayerBounds.isValid && subSubLayerBounds.isValid()) {
                                            subLayerBounds = subSubLayerBounds;
                                            break;
                                        }
                                    } catch (e) {
                                        continue;
                                    }
                                }
                            } else {
                                subLayerBounds = subLayer.getBounds();
                            }

                            if (subLayerBounds && subLayerBounds.isValid && subLayerBounds.isValid()) {
                                bounds = subLayerBounds;
                                break; // ‰ΩøÁî®Á¨¨‰∏Ä‰∏™ÊúâÊïàÁöÑËæπÁïå
                            }
                        } catch (e) {
                            continue; // Â∞ùËØï‰∏ã‰∏Ä‰∏™ÂõæÂ±Ç
                        }
                    }
                }
            } else {
                // Â¶ÇÊûúÊòØÂçï‰∏™ÂõæÂ±ÇÔºåÁõ¥Êé•Ëé∑ÂèñËæπÁïå
                try {
                    bounds = layer.getBounds();
                } catch (e) {
                    console.error('Ëé∑ÂèñÂõæÂ±ÇËæπÁïåÂ§±Ë¥•:', e);
                    return; // Â¶ÇÊûúÊó†Ê≥ïËé∑ÂèñËæπÁïåÔºåÂàô‰∏çÊ∑ªÂä†Ê†áÁ≠æ
                }
            }

            if (bounds && bounds.isValid && bounds.isValid()) {
                const center = bounds.getCenter();
                const label = L.divIcon({
                    className: 'custom-label',
                    html: `<div style="background: rgba(0,0,0,0.8); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; white-space: nowrap;">${prefix}</div>`,
                    iconSize: null,
                    iconAnchor: [0, 0]
                });

                const labelMarker = L.marker(center, { icon: label });
                labelLayerGroup.addLayer(labelMarker);
            }
        } catch (error) {
            console.error('Ê∑ªÂä†Ê†áÁ≠æÈîôËØØ:', error);
        }
    }

    // ‰∏∫ÂõæÂ±ÇÊ∑ªÂä†Èù¢ÁßØÊ†áÁ≠æ
    function addAreaLabelToLayer(layer, areaText) {
        try {
            console.log('Â∞ùËØï‰∏∫ÂõæÂ±ÇÊ∑ªÂä†Èù¢ÁßØÊ†áÁ≠æ:', areaText);
            // Â¶ÇÊûúlayerÊòØLayerGroupÊàñFeatureGroupÔºåÈúÄË¶ÅËé∑ÂèñÂÖ∂‰∏≠ÁöÑÁ¨¨‰∏Ä‰∏™ÂõæÂ±ÇÊù•Ëé∑ÂèñËæπÁïå
            let bounds;
            if (layer instanceof L.LayerGroup || layer instanceof L.FeatureGroup) {
                const layers = layer.getLayers();
                if (layers && layers.length > 0) {
                    // ÈÅçÂéÜÊâÄÊúâÂ≠êÂõæÂ±ÇÊù•Ëé∑ÂèñÊúâÊïàÁöÑËæπÁïå
                    for (let i = 0; i < layers.length; i++) {
                        try {
                            const subLayer = layers[i];
                            let subLayerBounds;

                            // Ê£ÄÊü•Â≠êÂõæÂ±ÇÊòØÂê¶‰∏∫LayerGroupÊàñFeatureGroup
                            if (subLayer instanceof L.LayerGroup || subLayer instanceof L.FeatureGroup) {
                                // ÈÄíÂΩíÂ§ÑÁêÜÂµåÂ•óÁöÑLayerGroupÊàñFeatureGroup
                                const subSubLayers = subLayer.getLayers();
                                for (let j = 0; j < subSubLayers.length; j++) {
                                    try {
                                        const subSubLayerBounds = subSubLayers[j].getBounds();
                                        if (subSubLayerBounds && subSubLayerBounds.isValid && subSubLayerBounds.isValid()) {
                                            subLayerBounds = subSubLayerBounds;
                                            break;
                                        }
                                    } catch (e) {
                                        continue;
                                    }
                                }
                            } else {
                                subLayerBounds = subLayer.getBounds();
                            }

                            if (subLayerBounds && subLayerBounds.isValid && subLayerBounds.isValid()) {
                                bounds = subLayerBounds;
                                break; // ‰ΩøÁî®Á¨¨‰∏Ä‰∏™ÊúâÊïàÁöÑËæπÁïå
                            }
                        } catch (e) {
                            continue; // Â∞ùËØï‰∏ã‰∏Ä‰∏™ÂõæÂ±Ç
                        }
                    }
                }
            } else {
                // Â¶ÇÊûúÊòØÂçï‰∏™ÂõæÂ±ÇÔºåÁõ¥Êé•Ëé∑ÂèñËæπÁïå
                try {
                    bounds = layer.getBounds();
                } catch (e) {
                    console.error('Ëé∑ÂèñÂõæÂ±ÇËæπÁïåÂ§±Ë¥•:', e);
                    return; // Â¶ÇÊûúÊó†Ê≥ïËé∑ÂèñËæπÁïåÔºåÂàô‰∏çÊ∑ªÂä†Ê†áÁ≠æ
                }
            }

            if (bounds && bounds.isValid && bounds.isValid()) {
                const center = bounds.getCenter();
                const label = L.divIcon({
                    className: 'area-label',
                    html: areaText,
                    iconSize: null,
                    iconAnchor: null // ‰ΩøÁî®ÈªòËÆ§ÈîöÁÇπ
                });

                const labelMarker = L.marker(center, { icon: label });
                labelLayerGroup.addLayer(labelMarker);
                console.log('ÊàêÂäüÊ∑ªÂä†Èù¢ÁßØÊ†áÁ≠æÂà∞ÂõæÂ±ÇÁªÑ');
                console.log('ÂΩìÂâçÊ†áÁ≠æÂõæÂ±Ç‰∏≠ÁöÑÂõæÂ±ÇÊï∞Èáè:', labelLayerGroup.getLayers().length);
            } else {
                console.warn('Êó†Ê≥ïËé∑ÂèñÂõæÂ±ÇËæπÁïåÔºåÊó†Ê≥ïÊ∑ªÂä†Èù¢ÁßØÊ†áÁ≠æ');
            }
        } catch (error) {
            console.error('Ê∑ªÂä†Èù¢ÁßØÊ†áÁ≠æÈîôËØØ:', error);
        }
    }

    // ËΩ®ËøπÁªòÂà∂ÂáΩÊï∞
    function drawTrack() {
        const trackText = document.getElementById('trackTextarea').value.trim();
        const timeRangeText = document.getElementById('timeRangeInput').value.trim();

        if (!trackText) {
            alert('ËØ∑Á≤òË¥¥ËΩ®ËøπÊñáÊú¨ÔºàÊó∂Èó¥Êà≥,ÁªèÂ∫¶,Á∫¨Â∫¶Ôºâ');
            return;
        }

        clearTrack();

        // Ëß£ÊûêÊó∂Èó¥ËåÉÂõ¥
        let startTime, endTime;
        if (timeRangeText) {
            const timeParts = timeRangeText.split(' - ');
            if (timeParts.length === 2) {
                startTime = new Date(timeParts[0].trim());
                endTime = new Date(timeParts[1].trim());

                if (isNaN(startTime.getTime()) || isNaN(endTime.getTime())) {
                    alert('Êó∂Èó¥ËåÉÂõ¥Ê†ºÂºè‰∏çÊ≠£Á°ÆÔºåËØ∑‰ΩøÁî®Ê†ºÂºèÔºö2025-10-23T13:56:49 - 2025-10-23T15:51:31');
                    return;
                }
            }
        }

        // Ëß£ÊûêËΩ®ËøπÊï∞ÊçÆ
        const points = [];
        const lines = trackText.split('\n');

        lines.forEach(line => {
            line = line.trim();
            if (!line) return;

            // ÊîØÊåÅ‰∏§ÁßçÊ†ºÂºèÔºö
            // 1. ÁªèÂ∫¶,Á∫¨Â∫¶,Êó∂Èó¥Êà≥
            // 2. Êó∂Èó¥Êà≥,ÁªèÂ∫¶,Á∫¨Â∫¶
            const parts = line.split(',');
            if (parts.length >= 3) {
                let lng, lat, timestamp;

                // Âà§Êñ≠Ê†ºÂºèÔºöÂ¶ÇÊûúÁ¨¨‰∏ÄÈÉ®ÂàÜÊòØÊï∞Â≠ó‰∏îÈïøÂ∫¶Â§ß‰∫é10ÔºåÂèØËÉΩÊòØÊó∂Èó¥Êà≥
                if (parts[0].trim().length > 10 && !isNaN(parts[0].trim())) {
                    // Ê†ºÂºèÔºöÊó∂Èó¥Êà≥,ÁªèÂ∫¶,Á∫¨Â∫¶
                    timestamp = parts[0].trim();
                    lng = parseFloat(parts[1].trim());
                    lat = parseFloat(parts[2].trim());
                } else {
                    // Ê†ºÂºèÔºöÁªèÂ∫¶,Á∫¨Â∫¶,Êó∂Èó¥Êà≥
                    lng = parseFloat(parts[0].trim());
                    lat = parseFloat(parts[1].trim());
                    timestamp = parts[2].trim();
                }

                if (!isNaN(lng) && !isNaN(lat) && timestamp) {
                    const pointTime = parseTimestamp(timestamp);

                    // Ê£ÄÊü•Êó∂Èó¥ËåÉÂõ¥
                    if (startTime && endTime) {
                        if (pointTime < startTime || pointTime > endTime) {
                            return; // Ë∑≥Ëøá‰∏çÂú®Êó∂Èó¥ËåÉÂõ¥ÂÜÖÁöÑÁÇπ
                        }
                    }

                    points.push({
                        lat: lat,
                        lng: lng,
                        timestamp: timestamp,
                        time: pointTime
                    });
                }
            }
        });

        if (points.length < 2) {
            alert('ËØ•Êó∂Èó¥ËåÉÂõ¥ÂÜÖÁöÑÊúâÊïàËΩ®ËøπÁÇπ‰∏çË∂≥ÔºåËá≥Â∞ëÈúÄË¶Å‰∏§ÁÇπ');
            return;
        }

        // ÊåâÊó∂Èó¥ÊéíÂ∫è
        points.sort((a, b) => a.time - b.time);

        // ÁªòÂà∂ËΩ®ËøπÁ∫ø
        const latlngs = points.map(p => [p.lat, p.lng]);

        currentTrack = L.polyline(latlngs, {
            color: currentTrackLineColor,
            weight: 1,
            opacity: 0.9
        });

        trackLayerGroup.addLayer(currentTrack);

        // Ëá™ÈÄÇÂ∫îËßÜÈáé
        const group = new L.featureGroup([currentTrack]);
        map.fitBounds(group.getBounds().pad(0.1));

        // ‰øùÂ≠òËΩ®ËøπÁÇπÁî®‰∫éÂõûÊîæ
        playbackState.points = points;

        // ÂêØÁî®Êí≠ÊîæÂô®ÊéßÂà∂ÊåâÈíÆÔºàÂ¶ÇÊûúÊí≠ÊîæÂô®ÂÖÉÁ¥†Â≠òÂú®Ôºâ
        if (playbackPlayer) {
            updatePlayerControls();
        }

        updateStatus('ËΩ®ËøπÁªòÂà∂ÂÆåÊàê');
    }

    // ÁªòÂà∂ËΩ®ËøπÁÇπÔºàÊâìÁÇπÔºâ- ÂàÜÊâπÂ§ÑÁêÜÈÅøÂÖçÈ°µÈù¢Âç°Ê≠ª
    function showTrackPoints() {
        const trackText = document.getElementById('trackTextarea').value.trim();
        const timeRangeText = document.getElementById('timeRangeInput').value.trim();

        if (!trackText) {
            alert('ËØ∑Á≤òË¥¥ËΩ®ËøπÊñáÊú¨ÔºàÊó∂Èó¥Êà≥,ÁªèÂ∫¶,Á∫¨Â∫¶Ôºâ');
            return;
        }

        clearTrack();

        // Ëß£ÊûêÊó∂Èó¥ËåÉÂõ¥
        let startTime, endTime;
        if (timeRangeText) {
            const timeParts = timeRangeText.split(' - ');
            if (timeParts.length === 2) {
                startTime = new Date(timeParts[0].trim());
                endTime = new Date(timeParts[1].trim());

                if (isNaN(startTime.getTime()) || isNaN(endTime.getTime())) {
                    alert('Êó∂Èó¥ËåÉÂõ¥Ê†ºÂºè‰∏çÊ≠£Á°ÆÔºåËØ∑‰ΩøÁî®Ê†ºÂºèÔºö2025-10-23T13:56:49 - 2025-10-23T15:51:31');
                    return;
                }
            }
        }

        // Ëß£ÊûêËΩ®ËøπÊï∞ÊçÆ
        const points = [];
        const lines = trackText.split('\n');

        lines.forEach(line => {
            line = line.trim();
            if (!line) return;

            // ÊîØÊåÅ‰∏§ÁßçÊ†ºÂºèÔºö
            // 1. ÁªèÂ∫¶,Á∫¨Â∫¶,Êó∂Èó¥Êà≥
            // 2. Êó∂Èó¥Êà≥,ÁªèÂ∫¶,Á∫¨Â∫¶
            const parts = line.split(',');
            if (parts.length >= 3) {
                let lng, lat, timestamp;

                // Âà§Êñ≠Ê†ºÂºèÔºöÂ¶ÇÊûúÁ¨¨‰∏ÄÈÉ®ÂàÜÊòØÊï∞Â≠ó‰∏îÈïøÂ∫¶Â§ß‰∫é10ÔºåÂèØËÉΩÊòØÊó∂Èó¥Êà≥
                if (parts[0].trim().length > 10 && !isNaN(parts[0].trim())) {
                    // Ê†ºÂºèÔºöÊó∂Èó¥Êà≥,ÁªèÂ∫¶,Á∫¨Â∫¶
                    timestamp = parts[0].trim();
                    lng = parseFloat(parts[1].trim());
                    lat = parseFloat(parts[2].trim());
                } else {
                    // Ê†ºÂºèÔºöÁªèÂ∫¶,Á∫¨Â∫¶,Êó∂Èó¥Êà≥
                    lng = parseFloat(parts[0].trim());
                    lat = parseFloat(parts[1].trim());
                    timestamp = parts[2].trim();
                }

                if (!isNaN(lng) && !isNaN(lat) && timestamp) {
                    const pointTime = parseTimestamp(timestamp);

                    // Ê£ÄÊü•Êó∂Èó¥ËåÉÂõ¥
                    if (startTime && endTime) {
                        if (pointTime < startTime || pointTime > endTime) {
                            return; // Ë∑≥Ëøá‰∏çÂú®Êó∂Èó¥ËåÉÂõ¥ÂÜÖÁöÑÁÇπ
                        }
                    }

                    points.push({
                        lat: lat,
                        lng: lng,
                        timestamp: timestamp,
                        time: pointTime
                    });
                }
            }
        });

        if (points.length === 0) {
            alert('ËØ•Êó∂Èó¥ËåÉÂõ¥ÂÜÖÊ≤°ÊúâÊâæÂà∞ËΩ®ËøπÁÇπ');
            return;
        }

        // ÊåâÊó∂Èó¥ÊéíÂ∫è
        points.sort((a, b) => a.time - b.time);

        // ‰øùÂ≠òËΩ®ËøπÁÇπÁî®‰∫éÂõûÊîæ
        playbackState.points = points;

        // ÂàÜÊâπÁªòÂà∂ËΩ®ËøπÁÇπÔºåÈÅøÂÖçÈ°µÈù¢Âç°Ê≠ª
        const batchSize = 100; // ÊØèÊâπÂ§ÑÁêÜ100‰∏™ÁÇπ
        let currentBatch = 0;
        let processedCount = 0;
        const totalPoints = points.length;
        let isFirstPointProcessed = false; // Ê†áËÆ∞ÊòØÂê¶Â∑≤Â§ÑÁêÜÁ¨¨‰∏Ä‰∏™ÁÇπ

        updateStatus(`ÂºÄÂßãÁªòÂà∂ËΩ®ËøπÁÇπÔºåÂÖ±${totalPoints}‰∏™ÁÇπÔºåÂàÜÊâπÂ§ÑÁêÜ‰∏≠...`);

        function drawBatch() {
            const startIdx = currentBatch * batchSize;
            const endIdx = Math.min(startIdx + batchSize, totalPoints);
            const batchPoints = points.slice(startIdx, endIdx);

            // ÁªòÂà∂ÂΩìÂâçÊâπÊ¨°ÁöÑÁÇπ
            batchPoints.forEach((point, index) => {
                const actualIndex = startIdx + index;
                
                // Â¶ÇÊûúÊòØÁ¨¨‰∏Ä‰∏™ÁÇπÔºåÂÖàÂ∞ÜÂú∞Âõæ‰∏≠ÂøÉÁßªËá≥ËØ•ÁÇπÔºå‰∏çÊîπÂèòÁº©ÊîæÁ∫ßÂà´
                if (!isFirstPointProcessed && actualIndex === 0) {
                    map.setView([point.lat, point.lng], map.getZoom()); // ‰øùÊåÅÂΩìÂâçÁº©ÊîæÁ∫ßÂà´Ôºå‰ªÖÂ±Ö‰∏≠ÊòæÁ§∫
                    isFirstPointProcessed = true;
                }
                
                // ÂàõÂª∫ÊûÅÂ∞èÁöÑDivIcon
                const tinyIcon = L.divIcon({
                    className: 'tiny-track-point',
                    html: `<div style="width: 1px; height: 1px; background-color: ${currentTrackPointColor}; border-radius: 50%;"></div>`,
                    iconSize: [1, 1],
                    iconAnchor: [0.5, 0.5]
                });

                const marker = L.marker([point.lat, point.lng], {
                    icon: tinyIcon,
                    opacity: 0.8
                });

                marker.bindPopup(`ËΩ®ËøπÁÇπ ${actualIndex + 1}<br>Êó∂Èó¥: ${point.timestamp}`);
                trackLayerGroup.addLayer(marker);
            });

            processedCount += batchPoints.length;
            currentBatch++;

            // Êõ¥Êñ∞ËøõÂ∫¶Áä∂ÊÄÅ
            const progress = Math.round((processedCount / totalPoints) * 100);
            updateStatus(`ËΩ®ËøπÁÇπÁªòÂà∂‰∏≠... ${progress}% (${processedCount}/${totalPoints})`);

            // Â¶ÇÊûúËøòÊúâÊú™Â§ÑÁêÜÁöÑÁÇπÔºåÁªßÁª≠‰∏ã‰∏ÄÊâπ
            if (processedCount < totalPoints) {
                // ‰ΩøÁî®setTimeoutËÆ©ÊµèËßàÂô®ÊúâÊó∂Èó¥Â§ÑÁêÜÂÖ∂‰ªñ‰ªªÂä°ÔºåÈÅøÂÖçÂç°Ê≠ª
                setTimeout(drawBatch, 10);
            } else {
                // ÊâÄÊúâÁÇπÁªòÂà∂ÂÆåÊàê
                // Ëá™ÈÄÇÂ∫îËßÜÈáéÔºàÂ¶ÇÊûúÂè™Êúâ‰∏Ä‰∏™ÁÇπÔºå‰øùÊåÅÂΩìÂâçÁº©ÊîæÁ∫ßÂà´ÔºõÂ¶ÇÊûúÊúâÂ§ö‰∏™ÁÇπÔºåË∞ÉÊï¥Ëá≥ÂêàÈÄÇÁöÑËßÜÈáéÔºâ
                if (totalPoints === 1) {
                    // Âçï‰∏™ÁÇπÔºå‰øùÊåÅ‰πãÂâçËÆæÁΩÆÁöÑÁº©ÊîæÁ∫ßÂà´Âíå‰∏≠ÂøÉÁÇπ
                } else {
                    // Â§ö‰∏™ÁÇπÔºåË∞ÉÊï¥ËßÜÈáé‰ª•ÊòæÁ§∫ÊâÄÊúâÁÇπ
                    const group = new L.featureGroup(trackLayerGroup.getLayers());
                    map.fitBounds(group.getBounds().pad(0.1));
                }

                // Êõ¥Êñ∞Êí≠ÊîæÂô®ÊéßÂà∂Áä∂ÊÄÅ
                updatePlayerControls();

                updateStatus(`ËΩ®ËøπÁÇπÁªòÂà∂ÂÆåÊàêÔºåÂÖ±${totalPoints}‰∏™ÁÇπ`);
                
                // Êõ¥Êñ∞Êí≠ÊîæÂô®ÊéßÂà∂Áä∂ÊÄÅ
                updatePlayerControls();
            }
        }

        // ÂºÄÂßãÁ¨¨‰∏ÄÊâπÁªòÂà∂
        drawBatch();
    }

    // Ëß£ÊûêËΩ®ËøπÁÇπ - ÂàÜÊâπÂ§ÑÁêÜÈÅøÂÖçÈ°µÈù¢Âç°Ê≠ª
    function parseTrackPoints(text) {
        try {
            const lines = text.trim().split('\n');
            const points = [];

            lines.forEach(line => {
                const parts = line.split(',');
                if (parts.length >= 3) {
                    const lng = parseFloat(parts[0].trim());
                    const lat = parseFloat(parts[1].trim());
                    const timestamp = parts[2].trim();

                    if (!isNaN(lng) && !isNaN(lat)) {
                        points.push({
                            lat: lat,
                            lng: lng,
                            timestamp: timestamp,
                            time: parseTimestamp(timestamp)
                        });
                    }
                }
            });

            if (points.length > 0) {
                // ÊåâÊó∂Èó¥ÊéíÂ∫è
                points.sort((a, b) => a.time - b.time);

                // ‰øùÂ≠òËΩ®ËøπÁÇπÁî®‰∫éÂõûÊîæ
                playbackState.points = points;

                // ÂàÜÊâπÁªòÂà∂ËΩ®ËøπÁÇπÔºåÈÅøÂÖçÈ°µÈù¢Âç°Ê≠ª
                const batchSize = 100; // ÊØèÊâπÂ§ÑÁêÜ100‰∏™ÁÇπ
                let currentBatch = 0;
                let processedCount = 0;
                const totalPoints = points.length;

                updateStatus(`ÂºÄÂßãÁªòÂà∂ËΩ®ËøπÁÇπÔºåÂÖ±${totalPoints}‰∏™ÁÇπÔºåÂàÜÊâπÂ§ÑÁêÜ‰∏≠...`);

                function drawBatch() {
                    const startIdx = currentBatch * batchSize;
                    const endIdx = Math.min(startIdx + batchSize, totalPoints);
                    const batchPoints = points.slice(startIdx, endIdx);

                    // ÁªòÂà∂ÂΩìÂâçÊâπÊ¨°ÁöÑÁÇπ
                    batchPoints.forEach((point, index) => {
                        const actualIndex = startIdx + index;
                        
                        // ÂàõÂª∫ÊûÅÂ∞èÁöÑDivIcon
                        const tinyIcon = L.divIcon({
                            className: 'tiny-track-point',
                            html: `<div style="width: 1px; height: 1px; background-color: ${currentTrackPointColor}; border-radius: 50%;"></div>`,
                            iconSize: [1, 1],
                            iconAnchor: [0.5, 0.5]
                        });

                        const marker = L.marker([point.lat, point.lng], {
                            icon: tinyIcon,
                            opacity: 0.8
                        });

                        marker.bindPopup(`ËΩ®ËøπÁÇπ ${actualIndex + 1}<br>Êó∂Èó¥: ${point.timestamp}`);
                        trackLayerGroup.addLayer(marker);
                    });

                    processedCount += batchPoints.length;
                    currentBatch++;

                    // Êõ¥Êñ∞ËøõÂ∫¶Áä∂ÊÄÅ
                    const progress = Math.round((processedCount / totalPoints) * 100);
                    updateStatus(`ËΩ®ËøπÁÇπÁªòÂà∂‰∏≠... ${progress}% (${processedCount}/${totalPoints})`);

                    // Â¶ÇÊûúËøòÊúâÊú™Â§ÑÁêÜÁöÑÁÇπÔºåÁªßÁª≠‰∏ã‰∏ÄÊâπ
                    if (processedCount < totalPoints) {
                        // ‰ΩøÁî®setTimeoutËÆ©ÊµèËßàÂô®ÊúâÊó∂Èó¥Â§ÑÁêÜÂÖ∂‰ªñ‰ªªÂä°ÔºåÈÅøÂÖçÂç°Ê≠ª
                        setTimeout(drawBatch, 10);
                    } else {
                          // ÊâÄÊúâÁÇπÁªòÂà∂ÂÆåÊàê
                          updateStatus(`ËΩ®ËøπÁÇπÁªòÂà∂ÂÆåÊàêÔºåÂÖ±${totalPoints}‰∏™ÁÇπ`);
                          
                          // Êõ¥Êñ∞Êí≠ÊîæÂô®ÊéßÂà∂Áä∂ÊÄÅ
                          updatePlayerControls();
                      }
                }

                // ÂºÄÂßãÁ¨¨‰∏ÄÊâπÁªòÂà∂
                drawBatch();
            }
        } catch (error) {
            console.error('ËΩ®ËøπÁÇπËß£ÊûêÈîôËØØ:', error);
            updateStatus('ËΩ®ËøπÁÇπËß£ÊûêÂ§±Ë¥•');
        }
    }

    // Êó∂Èó¥Êà≥Ëß£Êûê
    function parseTimestamp(timestamp) {
        const tstr = (timestamp || '').replace(/\D/g, '');
        const m = tstr && tstr.match(/^\d{14}$/);
        if (!m) return null;

        const y = parseInt(tstr.slice(0, 4), 10);
        const M = parseInt(tstr.slice(4, 6), 10) - 1;
        const d = parseInt(tstr.slice(6, 8), 10);
        const h = parseInt(tstr.slice(8, 10), 10);
        const m2 = parseInt(tstr.slice(10, 12), 10);
        const s = parseInt(tstr.slice(12, 14), 10);
        const dt = new Date(y, M, d, h, m2, s);
        return isNaN(dt.getTime()) ? null : dt;
    }

    // Ê∏ÖÈô§ËΩ®Ëøπ
    function clearTrack() {
        trackLayerGroup.clearLayers();
        currentTrack = null;
        playbackState.points = [];
        stopPlayback();

        // ÈáçÁΩÆÊí≠ÊîæÂô®Áä∂ÊÄÅÔºàÂ¶ÇÊûúÊí≠ÊîæÂô®ÂÖÉÁ¥†Â≠òÂú®Ôºâ
        if (playbackPlayer) {
            updatePlayerControls();
        }
        
        // ÈáçÁΩÆËøõÂ∫¶Êù°ÂíåÊó∂Èó¥ÊòæÁ§∫
        if (playerProgressSlider) {
            playerProgressSlider.value = 0;
            playerProgressSlider.disabled = true;
        }
        if (playerTimeLabel) {
            playerTimeLabel.textContent = '00:00:00 / 00:00:00';
        }

        updateStatus('ËΩ®ËøπÂ∑≤Ê∏ÖÈô§');
    }

    // ËΩ®ËøπÂõûÊîæÊéßÂà∂ÂáΩÊï∞ - ‰ΩøÁî®Êñ∞ÁöÑÊí≠ÊîæÂô®ÊéßÂà∂Èù¢Êùø
    function startPlayback() {
        // Ê£ÄÊü•ÊòØÂê¶ÊúâËΩ®ËøπÁÇπ
        if (!playbackState.points || playbackState.points.length === 0) {
            updateStatus('ÊöÇÊó†ËΩ®ËøπÊï∞ÊçÆÔºåÊó†Ê≥ïÂºÄÂßãÂõûÊîæ');
            return;
        }

        if (playbackState.isPlaying) {
            return;
        }

        // ÂÅúÊ≠¢‰πãÂâçÁöÑÂõûÊîæÔºà‰ΩÜ‰∏çÈáçÁΩÆcurrentIndexÔºâ
        if (playbackState.timer) {
            clearTimeout(playbackState.timer);
            playbackState.timer = null;
        }

        playbackState.isPlaying = true;
        // ‰∏çÈáçÁΩÆcurrentIndexÔºå‰øùÊåÅÂΩìÂâçÊí≠Êîæ‰ΩçÁΩÆ

        // Â¶ÇÊûúÊí≠ÊîæÂÖÉÁ¥†‰∏çÂ≠òÂú®ÔºåÂàõÂª∫ÂÆÉ‰ª¨
        if (!playbackState.marker || !playbackState.polyline) {
            // Ê∏ÖÈô§‰πãÂâçÁöÑÂõûÊîæÂÖÉÁ¥†
            if (playbackState.marker) {
                map.removeLayer(playbackState.marker);
            }
            if (playbackState.polyline) {
                map.removeLayer(playbackState.polyline);
            }

            // ÂàõÂª∫ÂõûÊîæËΩ®ËøπÁ∫ø
            const latlngs = playbackState.points.map(p => [p.lat, p.lng]);
            playbackState.polyline = L.polyline(latlngs, {
                color: '#FF6B6B',
                weight: 1,
                opacity: 0.6
            }).addTo(map);

            // ÂàõÂª∫ÂõûÊîæÊ†áËÆ∞
            const firstPoint = playbackState.points[0];
            playbackState.marker = L.circleMarker([firstPoint.lat, firstPoint.lng], {
                radius: 0.5,
                fillColor: '#FF6B6B',
                color: '#FFFFFF',
                weight: 0.5,
                opacity: 1,
                fillOpacity: 0.9
            }).addTo(map);

            // Ëá™ÈÄÇÂ∫îËßÜÈáéÂà∞ËΩ®ËøπËåÉÂõ¥
            const bounds = playbackState.polyline.getBounds();
            if (bounds && bounds.isValid()) {
                map.fitBounds(bounds, { padding: [20, 20] });
            }
        }

        // Êõ¥Êñ∞Êí≠ÊîæÂô®ÊéßÂà∂Áä∂ÊÄÅ
        updatePlayerControls();
        
        // ËÆæÁΩÆËøõÂ∫¶Êù°ÂíåÊó∂Èó¥ÊòæÁ§∫Ôºà‰∏çÈáçÁΩÆËøõÂ∫¶Ôºâ
        if (playerProgressSlider) {
            playerProgressSlider.disabled = false;
            playerProgressSlider.max = 100;
        }
        
        if (playerSpeedValue) {
            // ÊòæÁ§∫ÊåáÊï∞ÂÄçÊï∞
            const displaySpeed = playbackState.speed || 1;
            playerSpeedValue.textContent = displaySpeed + 'x';
        }

        // ÂºÄÂßãÊí≠Êîæ
        playbackNextPoint();
        updateStatus('ËΩ®ËøπÂõûÊîæÂºÄÂßã');
    }

    function playbackNextPoint() {
        if (!playbackState.isPlaying || !playbackState.points || playbackState.currentIndex >= playbackState.points.length) {
            // Âè™ÊúâÂú®Êí≠ÊîæÂÆåÊàêÊó∂ÊâçÂÅúÊ≠¢Âπ∂ÈáçÁΩÆÔºåÊöÇÂÅúÊó∂‰∏çÂÅúÊ≠¢
            if (playbackState.currentIndex >= playbackState.points.length) {
                stopPlayback();
            }
            return;
        }

        const point = playbackState.points[playbackState.currentIndex];

        // Êõ¥Êñ∞Ê†áËÆ∞‰ΩçÁΩÆ
        playbackState.marker.setLatLng([point.lat, point.lng]);
        playbackState.marker.bindPopup(`ÂõûÊîæÁÇπ ${playbackState.currentIndex + 1}<br>Êó∂Èó¥: ${point.timestamp}`);

        // Êõ¥Êñ∞ËΩ®ËøπÁ∫ø
        const currentLatlngs = playbackState.points.slice(0, playbackState.currentIndex + 1).map(p => [p.lat, p.lng]);
        playbackState.polyline.setLatLngs(currentLatlngs);

        // Ê£ÄÊü•ÁÇπÊòØÂê¶Âú®Â±èÂπïÂèØËßÅËåÉÂõ¥ÂÜÖÔºåÂè™Êúâ‰∏çÂú®ÂèØËßÅËåÉÂõ¥ÂÜÖÊó∂ÊâçÂ±Ö‰∏≠
        const pointLatLng = L.latLng(point.lat, point.lng);
        const bounds = map.getBounds();
        
        // Â¶ÇÊûúÁÇπ‰∏çÂú®ÂΩìÂâçÂú∞ÂõæËæπÁïåÂÜÖÔºåÊàñËÄÖË∑ùÁ¶ªËæπÁïåÂ§™ËøëÔºàÂ∞è‰∫éÂú∞ÂõæÂÆΩÈ´òÁöÑ10%ÔºâÔºåÂàôÂ±Ö‰∏≠
        if (!bounds.contains(pointLatLng)) {
            // ÁÇπÂÆåÂÖ®‰∏çÂú®Â±èÂπïÂÜÖÔºåÈúÄË¶ÅÂ±Ö‰∏≠
            map.setView([point.lat, point.lng], map.getZoom(), {
                animate: true,
                duration: 0.3
            });
        } else {
            // ÁÇπÂú®Â±èÂπïÂÜÖÔºåÊ£ÄÊü•ÊòØÂê¶Èù†ËøëËæπÁïåÔºàË∑ùÁ¶ªËæπÁïåÂ∞è‰∫éÂú∞ÂõæÂÆΩÈ´òÁöÑ10%Ôºâ
            const boundsPad = bounds.pad(-0.1); // ÂÜÖÁº©10%ÁöÑËæπÁïå
            if (!boundsPad.contains(pointLatLng)) {
                // ÁÇπÈù†ËøëËæπÁïåÔºåÂ±Ö‰∏≠ÊòæÁ§∫
                map.setView([point.lat, point.lng], map.getZoom(), {
                    animate: true,
                    duration: 0.3
                });
            }
            // ÁÇπÂú®Â±èÂπï‰∏≠Â§ÆÂå∫ÂüüÔºå‰∏çÈúÄË¶ÅÂ±Ö‰∏≠
        }

        // Ê†ºÂºèÂåñÊó∂Èó¥ÊòæÁ§∫ÂáΩÊï∞
        function formatTime(timestamp) {
            const date = parseTimestamp(timestamp);
            if (!date) return '00:00:00';
            
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const seconds = date.getSeconds().toString().padStart(2, '0');
            return hours + ':' + minutes + ':' + seconds;
        }

        // Êõ¥Êñ∞ËøõÂ∫¶Êù°ÂíåÊó∂Èó¥ÊòæÁ§∫
        if (playerProgressSlider && playbackState.points.length > 0) {
            const percentage = Math.round((playbackState.currentIndex / (playbackState.points.length - 1)) * 100);
            playerProgressSlider.value = percentage;
        }
        
        // Êõ¥Êñ∞Êó∂Èó¥ÊòæÁ§∫ÔºàÂ¶ÇÊûúÊí≠ÊîæÂô®ÂÖÉÁ¥†Â≠òÂú®Ôºâ
        if (playerTimeLabel && playbackState.points.length > 0) {
            const currentPoint = playbackState.points[playbackState.currentIndex];
            const lastPoint = playbackState.points[playbackState.points.length - 1];
            
            if (currentPoint && lastPoint) {
                const currentTime = formatTime(currentPoint.timestamp);
                const totalTime = formatTime(lastPoint.timestamp);
                playerTimeLabel.textContent = currentTime + ' / ' + totalTime;
            }
        }

        // Êõ¥Êñ∞Áä∂ÊÄÅ
        const progress = Math.round((playbackState.currentIndex / (playbackState.points.length - 1)) * 100);
        updateStatus(`ËΩ®ËøπÂõûÊîæ‰∏≠... ${progress}%`);

        playbackState.currentIndex++;

        // ËÆæÁΩÆ‰∏ã‰∏Ä‰∏™ÁÇπÁöÑÊí≠ÊîæÂª∂Ëøü
        const speed = playbackState.speed || 1;
        const delay = 1000 / speed; // ÈÄüÂ∫¶Ë∂äÂø´ÔºåÂª∂ËøüË∂äÁü≠

        playbackState.timer = setTimeout(playbackNextPoint, delay);
    }

    function pausePlayback() {
        playbackState.isPlaying = false;
        
        // Ê∏ÖÈô§ÂÆöÊó∂Âô®
        if (playbackState.timer) {
            clearTimeout(playbackState.timer);
            playbackState.timer = null;
        }
        
        // Êõ¥Êñ∞Êí≠ÊîæÂô®ÊéßÂà∂Áä∂ÊÄÅ
        if (playbackPlayer) {
            updatePlayerControls();
        }
        
        updateStatus('ËΩ®ËøπÂõûÊîæÂ∑≤ÊöÇÂÅú');
    }

    function stopPlayback() {
        playbackState.isPlaying = false;
        playbackState.currentIndex = 0;

        // Ê∏ÖÈô§ÂõûÊîæÂÖÉÁ¥†
        if (playbackState.marker) {
            map.removeLayer(playbackState.marker);
            playbackState.marker = null;
        }
        if (playbackState.polyline) {
            map.removeLayer(playbackState.polyline);
            playbackState.polyline = null;
        }

        // ÈáçÁΩÆËøõÂ∫¶Êù°ÂíåÊó∂Èó¥ÊòæÁ§∫
        if (playerProgressSlider) {
            playerProgressSlider.value = 0;
        }
        if (playerTimeLabel) {
            playerTimeLabel.textContent = '00:00:00 / 00:00:00';
        }
        
        // Êõ¥Êñ∞Êí≠ÊîæÂô®ÊéßÂà∂Áä∂ÊÄÅÔºàÂ¶ÇÊûúÊí≠ÊîæÂô®ÂÖÉÁ¥†Â≠òÂú®Ôºâ
        if (playbackPlayer) {
            updatePlayerControls();
        }
        
        updateStatus('ËΩ®ËøπÂõûÊîæÂ∑≤ÂÅúÊ≠¢');

        // ÈáçÁΩÆÊªëÂùó
        const playbackTimeSlider = document.getElementById('playbackTimeSlider');
        if (playbackTimeSlider) {
            playbackTimeSlider.value = 0;
            playbackTimeSlider.disabled = true;
        }

        // ÂêåÊ≠•Êõ¥Êñ∞Â∫ïÈÉ®Âõ∫ÂÆöÊí≠ÊîæÊéßÂà∂Èù¢Êùø
        const playbackTimeSliderFixed = document.getElementById('playbackTimeSliderFixed');
        if (playbackTimeSliderFixed) {
            playbackTimeSliderFixed.value = 0;
            playbackTimeSliderFixed.disabled = true;
        }

        updateStatus('ËΩ®ËøπÂõûÊîæÂ∑≤ÂÅúÊ≠¢');
    }

    function jumpToPoint(index) {
        if (!playbackState.points || index < 0 || index >= playbackState.points.length) {
            return;
        }

        playbackState.currentIndex = index;

        // Â¶ÇÊûúÊ≠£Âú®Êí≠ÊîæÔºåÊöÇÂÅú
        if (playbackState.isPlaying) {
            pausePlayback();
        }

        // ÂàõÂª∫ÂõûÊîæÂÖÉÁ¥†ÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®Ôºâ
        if (!playbackState.marker) {
            const point = playbackState.points[0];
            playbackState.marker = L.circleMarker([point.lat, point.lng], {
                radius: 0.5,
                fillColor: '#FF6B6B',
                color: '#FFFFFF',
                weight: 0.5,
                opacity: 1,
                fillOpacity: 0.9
            }).addTo(map);
        }

        if (!playbackState.polyline) {
            const latlngs = playbackState.points.map(p => [p.lat, p.lng]);
            playbackState.polyline = L.polyline(latlngs, {
                color: '#FF6B6B',
                weight: 1,
                opacity: 0.6
            }).addTo(map);
        }

        // Ë∑≥ËΩ¨Âà∞ÊåáÂÆöÁÇπ
        const point = playbackState.points[index];
        playbackState.marker.setLatLng([point.lat, point.lng]);
        playbackState.marker.bindPopup(`ÂõûÊîæÁÇπ ${index + 1}<br>Êó∂Èó¥: ${point.timestamp}`);

        // Êõ¥Êñ∞ËΩ®ËøπÁ∫ø
        const currentLatlngs = playbackState.points.slice(0, index + 1).map(p => [p.lat, p.lng]);
        playbackState.polyline.setLatLngs(currentLatlngs);

        // Êõ¥Êñ∞Áä∂ÊÄÅ
        const progress = Math.round((index / (playbackState.points.length - 1)) * 100);
        updateStatus(`ËΩ®ËøπÂõûÊîæÂ∑≤Ë∑≥ËΩ¨Âà∞ ${progress}%`);
    }

    // ÂàÜÂâ≤Âô®ÁªòÂà∂


    // ËΩ®ËøπÂõûÊîæÊéßÂà∂ - ‰ΩøÁî®Êñ∞ÁöÑÊí≠ÊîæÂô®ÊéßÂà∂Èù¢Êùø
    function startPlayback() {
        // Ê£ÄÊü•ÊòØÂê¶ÊúâËΩ®ËøπÁÇπ
        if (!playbackState.points || playbackState.points.length === 0) {
            updateStatus('ÊöÇÊó†ËΩ®ËøπÊï∞ÊçÆÔºåÊó†Ê≥ïÂºÄÂßãÂõûÊîæ');
            return;
        }

        if (playbackState.isPlaying) {
            return;
        }

        // ÂÅúÊ≠¢‰πãÂâçÁöÑÂõûÊîæÔºà‰ΩÜ‰∏çÈáçÁΩÆcurrentIndexÔºâ
        if (playbackState.timer) {
            clearTimeout(playbackState.timer);
            playbackState.timer = null;
        }

        playbackState.isPlaying = true;
        // ‰∏çÈáçÁΩÆcurrentIndexÔºå‰øùÊåÅÂΩìÂâçÊí≠Êîæ‰ΩçÁΩÆ

        // Â¶ÇÊûúÊí≠ÊîæÂÖÉÁ¥†‰∏çÂ≠òÂú®ÔºåÂàõÂª∫ÂÆÉ‰ª¨
        if (!playbackState.marker || !playbackState.polyline) {
            // Ê∏ÖÈô§‰πãÂâçÁöÑÂõûÊîæÂÖÉÁ¥†
            if (playbackState.marker) {
                map.removeLayer(playbackState.marker);
            }
            if (playbackState.polyline) {
                map.removeLayer(playbackState.polyline);
            }

            // ÂàõÂª∫ÂõûÊîæËΩ®ËøπÁ∫ø
            const latlngs = playbackState.points.map(p => [p.lat, p.lng]);
            playbackState.polyline = L.polyline(latlngs, {
                color: '#FF6B6B',
                weight: 1,
                opacity: 0.6
            }).addTo(map);

            // ÂàõÂª∫ÂõûÊîæÊ†áËÆ∞
            const firstPoint = playbackState.points[0];
            playbackState.marker = L.circleMarker([firstPoint.lat, firstPoint.lng], {
                radius: 0.5,
                fillColor: '#FF6B6B',
                color: '#FFFFFF',
                weight: 0.5,
                opacity: 1,
                fillOpacity: 0.9
            }).addTo(map);

            // Ëá™ÈÄÇÂ∫îËßÜÈáéÂà∞ËΩ®ËøπËåÉÂõ¥
            const bounds = playbackState.polyline.getBounds();
            if (bounds && bounds.isValid()) {
                map.fitBounds(bounds, { padding: [20, 20] });
            }
        }

        // Êõ¥Êñ∞Êí≠ÊîæÂô®ÊéßÂà∂Áä∂ÊÄÅ
        updatePlayerControls();
        
        // ËÆæÁΩÆËøõÂ∫¶Êù°ÂíåÊó∂Èó¥ÊòæÁ§∫Ôºà‰∏çÈáçÁΩÆËøõÂ∫¶Ôºâ
        if (playerProgressSlider) {
            playerProgressSlider.disabled = false;
            playerProgressSlider.max = 100;
        }
        
        if (playerSpeedValue) {
            // ÊòæÁ§∫ÊåáÊï∞ÂÄçÊï∞
            const displaySpeed = playbackState.speed || 1;
            playerSpeedValue.textContent = displaySpeed + 'x';
        }

        // ÂºÄÂßãÊí≠Êîæ
        playbackNextPoint();
        updateStatus('ËΩ®ËøπÂõûÊîæÂºÄÂßã');
    }

    function stopPlayback() {
        playbackState.isPlaying = false;
        playbackState.currentIndex = 0;

        // Ê∏ÖÈô§ÂÆöÊó∂Âô®
        if (playbackState.timer) {
            clearTimeout(playbackState.timer);
            playbackState.timer = null;
        }

        // Ê∏ÖÈô§ÂõûÊîæÂÖÉÁ¥†
        if (playbackState.marker) {
            map.removeLayer(playbackState.marker);
            playbackState.marker = null;
        }
        if (playbackState.polyline) {
            map.removeLayer(playbackState.polyline);
            playbackState.polyline = null;
        }

        // ÈáçÁΩÆËøõÂ∫¶Êù°ÂíåÊó∂Èó¥ÊòæÁ§∫
        if (playerProgressSlider) {
            playerProgressSlider.value = 0;
        }
        if (playerTimeLabel) {
            playerTimeLabel.textContent = '00:00:00 / 00:00:00';
        }
        
        // Êõ¥Êñ∞Êí≠ÊîæÂô®ÊéßÂà∂Áä∂ÊÄÅÔºàÂ¶ÇÊûúÊí≠ÊîæÂô®ÂÖÉÁ¥†Â≠òÂú®Ôºâ
        if (playbackPlayer) {
            updatePlayerControls();
        }
        
        updateStatus('ËΩ®ËøπÂõûÊîæÂ∑≤ÂÅúÊ≠¢');
    }

    function scheduleNextPlayback() {
        if (!playbackState.isPlaying || !playbackState.points || playbackState.currentIndex >= playbackState.points.length - 1) {
            if (playbackState.currentIndex >= playbackState.points.length - 1) {
                updateStatus('ËΩ®ËøπÂõûÊîæÂÆåÊàê');
                stopPlayback(); // Âè™Âú®Êí≠ÊîæÂÆåÊàêÊó∂ÂÅúÊ≠¢Âπ∂ÈáçÁΩÆ
            }
            return; // Â¶ÇÊûúÊòØÊöÇÂÅúÔºåÁõ¥Êé•ËøîÂõûÔºå‰∏çÂÅúÊ≠¢Êí≠Êîæ
        }

        const next = playbackState.points[playbackState.currentIndex + 1];
        const speed = playbackState.speed || 1;
        const delay = Math.max(100, Math.round(1000 / speed));

        playbackState.timer = setTimeout(() => {
            playbackState.currentIndex++;

            // Êõ¥Êñ∞Ê†áËÆ∞‰ΩçÁΩÆ
            if (playbackState.marker) {
                playbackState.marker.setLatLng([next.lat, next.lng]);
                playbackState.marker.bindPopup(`ÂõûÊîæÁÇπ ${playbackState.currentIndex + 1}<br>Êó∂Èó¥: ${next.timestamp}`);
            }

            // Êõ¥Êñ∞ËΩ®ËøπÁ∫ø
            if (playbackState.polyline) {
                const currentLatlngs = playbackState.points.slice(0, playbackState.currentIndex + 1).map(p => [p.lat, p.lng]);
                playbackState.polyline.setLatLngs(currentLatlngs);
            }

            // Ê£ÄÊü•ÁÇπÊòØÂê¶Âú®Â±èÂπïÂèØËßÅËåÉÂõ¥ÂÜÖÔºåÂè™Êúâ‰∏çÂú®ÂèØËßÅËåÉÂõ¥ÂÜÖÊó∂ÊâçÂ±Ö‰∏≠
            const pointLatLng = L.latLng(next.lat, next.lng);
            const bounds = map.getBounds();
            
            // Â¶ÇÊûúÁÇπ‰∏çÂú®ÂΩìÂâçÂú∞ÂõæËæπÁïåÂÜÖÔºåÊàñËÄÖË∑ùÁ¶ªËæπÁïåÂ§™ËøëÔºàÂ∞è‰∫éÂú∞ÂõæÂÆΩÈ´òÁöÑ10%ÔºâÔºåÂàôÂ±Ö‰∏≠
            if (!bounds.contains(pointLatLng)) {
                // ÁÇπÂÆåÂÖ®‰∏çÂú®Â±èÂπïÂÜÖÔºåÈúÄË¶ÅÂ±Ö‰∏≠
                map.setView([next.lat, next.lng], map.getZoom(), {
                    animate: true,
                    duration: 0.3
                });
            } else {
                // ÁÇπÂú®Â±èÂπïÂÜÖÔºåÊ£ÄÊü•ÊòØÂê¶Èù†ËøëËæπÁïåÔºàË∑ùÁ¶ªËæπÁïåÂ∞è‰∫éÂú∞ÂõæÂÆΩÈ´òÁöÑ10%Ôºâ
                const boundsPad = bounds.pad(-0.1); // ÂÜÖÁº©10%ÁöÑËæπÁïå
                if (!boundsPad.contains(pointLatLng)) {
                    // ÁÇπÈù†ËøëËæπÁïåÔºåÂ±Ö‰∏≠ÊòæÁ§∫
                    map.setView([next.lat, next.lng], map.getZoom(), {
                        animate: true,
                        duration: 0.3
                    });
                }
                // ÁÇπÂú®Â±èÂπï‰∏≠Â§ÆÂå∫ÂüüÔºå‰∏çÈúÄË¶ÅÂ±Ö‰∏≠
            }

            // Êõ¥Êñ∞ËøõÂ∫¶Êù°ÂíåÊó∂Èó¥ÊòæÁ§∫
            if (playerProgressSlider && playbackState.points.length > 0) {
                const percentage = Math.round((playbackState.currentIndex / (playbackState.points.length - 1)) * 100);
                playerProgressSlider.value = percentage;
            }
            
            if (playerTimeLabel && playbackState.points.length > 0) {
                const currentPoint = playbackState.points[playbackState.currentIndex];
                const lastPoint = playbackState.points[playbackState.points.length - 1];
                
                if (currentPoint && lastPoint) {
                    const currentTime = formatTime(currentPoint.timestamp);
                    const totalTime = formatTime(lastPoint.timestamp);
                    playerTimeLabel.textContent = currentTime + ' / ' + totalTime;
                }
            }

            // ÁªßÁª≠‰∏ã‰∏Ä‰∏™ÁÇπ
            scheduleNextPlayback();
        }, delay);
    }

    // Ê†ºÂºèÂåñÊó∂Èó¥ÊòæÁ§∫ÂáΩÊï∞
    function formatTime(timestamp) {
        const date = parseTimestamp(timestamp);
        if (!date) return '00:00';
        
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        return hours + ':' + minutes;
    }

    // ÊóßÁâàÊó∂Èó¥ÊªëÂùóÈÖçÁΩÆÂáΩÊï∞ - Â∑≤Â∫üÂºÉÔºå‰øùÁïôÂÖºÂÆπÊÄß
    function configureTimeSlider() {
        const slider = document.getElementById('playbackTimeSlider');
        if (!slider) return;

        // Á©∫ËΩ®ËøπÊó∂ËÆæÁΩÆÊªëÂùó‰∏∫Á¶ÅÁî®Áä∂ÊÄÅ
        if (playbackState.points.length === 0) {
            slider.disabled = true;
            slider.min = 0;
            slider.max = 0;
            slider.value = 0;
            
            // ÂêåÊ≠•Êõ¥Êñ∞Â∫ïÈÉ®Âõ∫ÂÆöÊí≠ÊîæÊéßÂà∂Èù¢Êùø
            const sliderFixed = document.getElementById('playbackTimeSliderFixed');
            if (sliderFixed) {
                sliderFixed.disabled = true;
                sliderFixed.min = 0;
                sliderFixed.max = 0;
                sliderFixed.value = 0;
            }
            return;
        }

        slider.disabled = false;
        slider.min = 0;
        slider.max = playbackState.points.length - 1;
        // ‰∏çÈáçÁΩÆÊªëÂùóÂÄºÔºå‰øùÊåÅÂΩìÂâçÊí≠Êîæ‰ΩçÁΩÆ
        if (playbackState.currentIndex >= 0 && playbackState.currentIndex < playbackState.points.length) {
            slider.value = playbackState.currentIndex;
        }

        // ÂêåÊ≠•Êõ¥Êñ∞Â∫ïÈÉ®Âõ∫ÂÆöÊí≠ÊîæÊéßÂà∂Èù¢Êùø
        const sliderFixed = document.getElementById('playbackTimeSliderFixed');
        if (sliderFixed) {
            sliderFixed.disabled = false;
            sliderFixed.min = 0;
            sliderFixed.max = playbackState.points.length - 1;
            // ‰∏çÈáçÁΩÆÊªëÂùóÂÄºÔºå‰øùÊåÅÂΩìÂâçÊí≠Êîæ‰ΩçÁΩÆ
            if (playbackState.currentIndex >= 0 && playbackState.currentIndex < playbackState.points.length) {
                sliderFixed.value = playbackState.currentIndex;
            }
        }
    }

    function updateTimeSlider() {
        const slider = document.getElementById('playbackTimeSlider');
        if (slider) {
            slider.value = playbackState.currentIndex;
        }

        // ÂêåÊ≠•Êõ¥Êñ∞Â∫ïÈÉ®Âõ∫ÂÆöÊí≠ÊîæÊéßÂà∂Èù¢Êùø
        const sliderFixed = document.getElementById('playbackTimeSliderFixed');
        if (sliderFixed) {
            sliderFixed.value = playbackState.currentIndex;
        }
    }

    function updatePlaybackTimeLabel(timestamp) {
        const label = document.getElementById('playbackTimeLabel');
        if (label) {
            if (timestamp) {
                label.textContent = `Êó∂Èó¥: ${timestamp}`;
            } else {
                label.textContent = 'Êó∂Èó¥: --';
            }
        }

        // ÂêåÊ≠•Êõ¥Êñ∞Â∫ïÈÉ®Âõ∫ÂÆöÊí≠ÊîæÊéßÂà∂Èù¢Êùø
        const labelFixed = document.getElementById('playbackTimeLabelFixed');
        if (labelFixed) {
            if (timestamp) {
                labelFixed.textContent = `Êó∂Èó¥: ${timestamp}`;
            } else {
                labelFixed.textContent = 'Êó∂Èó¥: --';
            }
        }
    }

    // ÊµãÈáèÂäüËÉΩ


    function startMeasureDistance() {
        if (!map) return;

        clearMeasureResult();

        measureState.isActive = true;
        measureState.mode = 'distance';

        // Á¶ÅÁî®ÊµãÈáèÊåâÈíÆ
        document.getElementById('measureDistanceBtn').classList.add('active');
        document.getElementById('measureAreaBtn').disabled = true;

        // Á¶ÅÁî®Âú∞ÂõæÂèåÂáªÁº©ÊîæÂäüËÉΩ
        map.doubleClickZoom.disable();

        // ËÆæÁΩÆÊõ¥ÁÅµÊïèÁöÑÂèåÂáªÊ£ÄÊµãÂèÇÊï∞
        if (map.options) {
            map.options.doubleClickZoom = false;
            map.options.tap = false; // Á¶ÅÁî®Ëß¶Êë∏Âª∂Ëøü
        }

        // ËÆæÁΩÆÊõ¥ÁÅµÊïèÁöÑÂèåÂáªÊ£ÄÊµãÂèÇÊï∞
        if (map.options) {
            map.options.doubleClickZoom = false;
            map.options.tap = false; // Á¶ÅÁî®Ëß¶Êë∏Âª∂Ëøü
        }

        // ÁªëÂÆöÂú∞Âõæ‰∫ã‰ª∂
        map.on('click', handleMeasureClick);
        map.on('mousemove', handleMeasureMouseMove);
        map.on('contextmenu', handleDistanceMeasureRightClick); // Âè≥ÈîÆÁªìÊùüÊµãÈáè

        updateStatus('ÊµãË∑ùÊ®°ÂºèÂ∑≤ÊøÄÊ¥ªÔºåÁÇπÂáªÂú∞ÂõæÂºÄÂßãÊµãÈáèÔºåÂè≥ÈîÆÁªìÊùüÊµãÈáè');
    }

    // Âè≥ÈîÆÁªìÊùüÊµãË∑ù
    function handleDistanceMeasureRightClick(e) {
        // ÈòªÊ≠¢Âè≥ÈîÆËèúÂçïÁöÑÈªòËÆ§Ë°å‰∏∫
        if (e && e.originalEvent) {
            e.originalEvent.preventDefault();
            e.originalEvent.stopPropagation();
        }

        // Á°Æ‰øùËá≥Â∞ëÊúâ2‰∏™ÁÇπÊâçËÉΩÂΩ¢ÊàêÁ∫øÊÆµ
        if (measureState.points.length >= 2) {
            finishMeasureDistance();
        } else {
            alert('ËØ∑Ëá≥Â∞ëÁÇπÂáª2‰∏™ÁÇπÂΩ¢ÊàêÁ∫øÊÆµÂêéÂÜçÂè≥ÈîÆÁªìÊùüÊµãÈáè');
        }

        return false;
    }

    // Âè≥ÈîÆÁªìÊùüÊµãÈù¢
    function handleAreaMeasureRightClick(e) {
        // ÈòªÊ≠¢Âè≥ÈîÆËèúÂçïÁöÑÈªòËÆ§Ë°å‰∏∫
        if (e && e.originalEvent) {
            e.originalEvent.preventDefault();
            e.originalEvent.stopPropagation();
        }

        // Á°Æ‰øùËá≥Â∞ëÊúâ3‰∏™ÁÇπÊâçËÉΩÂΩ¢ÊàêÂ§öËæπÂΩ¢
        if (measureState.points.length >= 3) {
            finishMeasureArea();
        } else {
            alert('ËØ∑Ëá≥Â∞ëÁÇπÂáª3‰∏™ÁÇπÂΩ¢ÊàêÂ§öËæπÂΩ¢ÂêéÂÜçÂè≥ÈîÆÁªìÊùüÊµãÈáè');
        }

        return false;
    }

    function startMeasureArea() {
        if (!map) return;

        clearMeasureResult();

        measureState.isActive = true;
        measureState.mode = 'area';

        // Á¶ÅÁî®ÊµãÈáèÊåâÈíÆ
        document.getElementById('measureAreaBtn').classList.add('active');
        document.getElementById('measureDistanceBtn').disabled = true;

        // Á¶ÅÁî®Âú∞ÂõæÂèåÂáªÁº©ÊîæÂäüËÉΩ
        map.doubleClickZoom.disable();

        // ÁªëÂÆöÂú∞Âõæ‰∫ã‰ª∂
        map.on('click', handleMeasureClick);
        map.on('mousemove', handleMeasureMouseMove);
        map.on('contextmenu', handleAreaMeasureRightClick); // Âè≥ÈîÆÁªìÊùüÊµãÈáè

        updateStatus('ÊµãÈù¢Ê®°ÂºèÂ∑≤ÊøÄÊ¥ªÔºåÁÇπÂáªÂú∞ÂõæÂºÄÂßãÊµãÈáèÔºåÂè≥ÈîÆÁªìÊùüÊµãÈáè');
    }

    function handleMeasureClick(e) {
    if (!measureState.isActive) return;

    // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°ÔºåÈÅøÂÖçÂπ≤Êâ∞ÂèåÂáªÊ£ÄÊµã
    if (e && e.originalEvent) {
        e.originalEvent.stopPropagation();
    }

    const point = e.latlng;
    measureState.points.push(point);

    // ÂàõÂª∫ÁÇπÊ†áËÆ∞
    const marker = L.circleMarker(point, {
        color: currentOutlineColor,
        fillColor: currentFillColor,
        fillOpacity: 1,
        radius: 0.5
    });

    measureLayerGroup.addLayer(marker);
    measureState.markers.push(marker);

    if (measureState.mode === 'distance') {
        // ÊµãË∑ùÈÄªËæë
        if (measureState.points.length > 1) {
            const lastPoint = measureState.points[measureState.points.length - 2];
            const newLine = L.polyline([lastPoint, point], {
                color: currentOutlineColor,
                weight: 1,
                opacity: 1
            });

            measureLayerGroup.addLayer(newLine);
            measureState.lines.push(newLine);

            // Êõ¥Êñ∞Ë∑ùÁ¶ªÊ†áÁ≠æ
            const distance = calculateDistance(lastPoint, point);
            const center = L.latLng(
                (lastPoint.lat + point.lat) / 2,
                (lastPoint.lng + point.lng) / 2
            );
            showDistanceLabel(center, distance);
        }
    } else if (measureState.mode === 'area') {
        // ÊµãÈù¢ÈÄªËæë
        if (measureState.points.length > 1) {
            // ÂàõÂª∫Á∫øÊÆµ
            const lastPoint = measureState.points[measureState.points.length - 2];
            const newLine = L.polyline([lastPoint, point], {
                color: currentOutlineColor,
                weight: 1,
                opacity: 1
            });

            measureLayerGroup.addLayer(newLine);
            measureState.lines.push(newLine);
        }

        // ÂΩìÊúâ3‰∏™ÊàñÊõ¥Â§öÁÇπÊó∂ÔºåÊõ¥Êñ∞Â§öËæπÂΩ¢Ôºà‰ΩÜ‰∏çÊòæÁ§∫Ê†áÁ≠æÔºâ
        if (measureState.points.length >= 3) {
            // ÁßªÈô§‰πãÂâçÁöÑÂ§öËæπÂΩ¢
            if (measureState.polygon) {
                measureLayerGroup.removeLayer(measureState.polygon);
            }

            // ÂàõÂª∫Êñ∞ÁöÑÂ§öËæπÂΩ¢
            measureState.polygon = L.polygon(measureState.points, {
                color: currentOutlineColor,
                weight: 1,
                opacity: 1,
                fillColor: currentFillColor,
                fillOpacity: 0.3
            });

            measureLayerGroup.addLayer(measureState.polygon);

            // Ê≥®ÊÑèÔºöËøôÈáå‰∏çÂÜçÊòæÁ§∫Èù¢ÁßØÊ†áÁ≠æÔºåÂè™Âú®ÂèåÂáªÁªìÊùüÊó∂ÊòæÁ§∫
        }
    }
}

    function handleMeasureMouseMove(e) {
        if (!measureState.isActive || measureState.points.length === 0) return;

        const lastPoint = measureState.points[measureState.points.length - 1];
        const currentPoint = e.latlng;

        // ÁßªÈô§‰πãÂâçÁöÑ‰∏¥Êó∂Á∫ø
        if (measureState.tempLine) {
            measureLayerGroup.removeLayer(measureState.tempLine);
        }

        // ÂàõÂª∫Êñ∞ÁöÑ‰∏¥Êó∂Á∫ø
        let tempCoords = [lastPoint, currentPoint];

        // Â¶ÇÊûúÊòØÈù¢ÁßØÊµãÈáèÔºåÊ∑ªÂä†Èó≠ÂêàÁ∫ø
        if (measureState.mode === 'area' && measureState.points.length >= 2) {
            tempCoords.push(measureState.points[0]);
        }

        measureState.tempLine = L.polyline(tempCoords, {
            color: '#FFFF00',
            weight: 2,
            opacity: 0.8,
            dashArray: '5, 5'
        });

        measureLayerGroup.addLayer(measureState.tempLine);
    }

    function updateMeasurePolygon() {
        // ÁßªÈô§‰πãÂâçÁöÑÂ§öËæπÂΩ¢
        if (measureState.polygon) {
            measureLayerGroup.removeLayer(measureState.polygon);
        }

        // ÂàõÂª∫Êñ∞ÁöÑÂ§öËæπÂΩ¢
        measureState.polygon = L.polygon(measureState.points, {
            color: currentOutlineColor,
            weight: 1,
            opacity: 1,
            fillColor: currentFillColor,
            fillOpacity: 0.3
        });

        measureLayerGroup.addLayer(measureState.polygon);

        // ËÆ°ÁÆóÂπ∂ÊòæÁ§∫Èù¢ÁßØ
        const area = calculatePolygonArea(measureState.points);
        const center = getPolygonCenter(measureState.points);
        showAreaLabel(center, area);
    }

    function finishMeasureDistance() {
        if (!measureState.isActive || measureState.mode !== 'distance') return;

        // ÁßªÈô§‰∫ã‰ª∂ÁõëÂê¨
        map.off('click', handleMeasureClick);
        map.off('mousemove', handleMeasureMouseMove);
        map.off('contextmenu', handleDistanceMeasureRightClick);

        // ÈáçÊñ∞ÂêØÁî®Âú∞ÂõæÂèåÂáªÁº©ÊîæÂäüËÉΩ
        map.doubleClickZoom.enable();

        // ÊÅ¢Â§çÂú∞ÂõæÈÄâÈ°πËÆæÁΩÆ
        if (map.options) {
            map.options.doubleClickZoom = true;
            map.options.tap = true;
        }

        // ÊÅ¢Â§çÂú∞ÂõæÈÄâÈ°πËÆæÁΩÆ
        if (map.options) {
            map.options.doubleClickZoom = true;
            map.options.tap = true;
        }

        // ÁßªÈô§‰∏¥Êó∂Á∫ø
        if (measureState.tempLine) {
            measureLayerGroup.removeLayer(measureState.tempLine);
            measureState.tempLine = null;
        }

        // ÊòæÁ§∫ÊÄªË∑ùÁ¶ª
        if (measureState.points.length > 1) {
            const totalDistance = calculateTotalDistance();
            showTotalDistanceLabel(totalDistance);

            // ÈáçÊñ∞ÂàõÂª∫ÊúÄÁªàÁöÑÁ∫øÊÆµ‰ª•Á°Æ‰øùÊòæÁ§∫Ê≠£Á°Æ
            if (measureState.line) {
                measureLayerGroup.removeLayer(measureState.line);
            }

            measureState.line = L.polyline(measureState.points, {
                color: currentOutlineColor,
                weight: 1,
                opacity: 1
            });

            measureLayerGroup.addLayer(measureState.line);
        }

        // ÈáçÁΩÆÁä∂ÊÄÅ
        measureState.isActive = false;
        measureState.mode = '';

        // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
        document.getElementById('measureDistanceBtn').classList.remove('active');
        document.getElementById('measureAreaBtn').disabled = false;

        updateStatus('ÊµãË∑ùÂÆåÊàêÔºåÊÄªË∑ùÁ¶ªÂ∑≤ÊòæÁ§∫');
    }

    function finishMeasureArea() {
        if (!measureState.isActive || measureState.mode !== 'area') return;

        // ÁßªÈô§‰∫ã‰ª∂ÁõëÂê¨
        map.off('click', handleMeasureClick);
        map.off('mousemove', handleMeasureMouseMove);
        map.off('contextmenu', handleAreaMeasureRightClick);

        // ÈáçÊñ∞ÂêØÁî®Âú∞ÂõæÂèåÂáªÁº©ÊîæÂäüËÉΩ
        map.doubleClickZoom.enable();

        // ÁßªÈô§‰∏¥Êó∂Á∫ø
        if (measureState.tempLine) {
            measureLayerGroup.removeLayer(measureState.tempLine);
            measureState.tempLine = null;
        }

        // Â¶ÇÊûúÁÇπÊï∞>=3ÔºåÊòæÁ§∫ÊÄªÈù¢ÁßØ
        if (measureState.points.length >= 3) {
            // Á°Æ‰øùÂ§öËæπÂΩ¢ÊòØÈó≠ÂêàÁöÑ
            const lastPoint = measureState.points[measureState.points.length - 1];
            const firstPoint = measureState.points[0];

            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÈó≠ÂêàÔºàÈ¶ñÂ∞æÁÇπÊòØÂê¶Áõ∏ÂêåÔºâ
            if (lastPoint.lat !== firstPoint.lat || lastPoint.lng !== firstPoint.lng) {
                // Â¶ÇÊûúÊú™Èó≠ÂêàÔºåÂ∞ÜÈ¶ñÁÇπÊ∑ªÂä†Âà∞Êú´Â∞æ‰ª•ÂΩ¢ÊàêÈó≠ÂêàÂ§öËæπÂΩ¢
                measureState.points.push(L.latLng(firstPoint.lat, firstPoint.lng));
            }

            const area = calculatePolygonArea(measureState.points);
            const center = getPolygonCenter(measureState.points);

            // Ê∏ÖÈô§‰πãÂâçÁöÑÈù¢ÁßØÊ†áÁ≠æÔºàÂ¶ÇÊûúÊúâÔºâ
            if (measureState.areaLabel) {
                measureLayerGroup.removeLayer(measureState.areaLabel);
                measureState.areaLabel = null;
            }

            // ÊòæÁ§∫ÊÄªÈù¢ÁßØÊ†áÁ≠æÔºàÂπ≥ÊñπÁ±≥+‰∫©Êï∞Ôºâ
            showTotalAreaLabel(center, area);

            // ÈáçÊñ∞ÂàõÂª∫ÊúÄÁªàÁöÑÂ§öËæπÂΩ¢‰ª•Á°Æ‰øùÈó≠Âêà
            if (measureState.polygon) {
                measureLayerGroup.removeLayer(measureState.polygon);
            }

            measureState.polygon = L.polygon(measureState.points, {
                color: currentOutlineColor,
                weight: 1,
                opacity: 1,
                fillColor: currentFillColor,
                fillOpacity: 0.3
            });

            measureLayerGroup.addLayer(measureState.polygon);
        } else {
            // ÁÇπÊï∞‰∏çË∂≥ÔºåÊ∏ÖÈô§ÊâÄÊúâÊµãÈáèÁªìÊûú
            clearMeasureResult();
        }

        // ÈáçÁΩÆÁä∂ÊÄÅ
        measureState.isActive = false;
        measureState.mode = '';

        // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
        document.getElementById('measureAreaBtn').classList.remove('active');
        document.getElementById('measureDistanceBtn').disabled = false;

        updateStatus('ÊµãÈù¢ÂÆåÊàêÔºåÊÄªÈù¢ÁßØÂ∑≤ÊòæÁ§∫');
    }

    // Ë∑ùÁ¶ªËÆ°ÁÆó
    function calculateDistance(point1, point2) {
        return point1.distanceTo(point2);
    }

    // Â§öËæπÂΩ¢Èù¢ÁßØËÆ°ÁÆó
    function calculatePolygonArea(points) {
        if (points.length < 3) return 0;

        // ‰ΩøÁî®Turf.jsËÆ°ÁÆóÈù¢ÁßØ
        try {
            // Â∞ÜLeafletÂùêÊ†áËΩ¨Êç¢‰∏∫GeoJSONÊ†ºÂºè
            let coords = points.map(p => {
                if (p.lng !== undefined && p.lat !== undefined) {
                    return [p.lng, p.lat];
                } else if (Array.isArray(p) && p.length >= 2) {
                    // Â¶ÇÊûúÂ∑≤ÁªèÊòØÊï∞ÁªÑÊ†ºÂºè [lat, lng] Êàñ [lng, lat]
                    return [p[1], p[0]]; // ÂÅáËÆæÊòØ [lat, lng] Ê†ºÂºè
                }
                return null;
            }).filter(coord => coord !== null);

            // Á°Æ‰øùÁéØÊòØÈó≠ÂêàÁöÑÔºàËá≥Â∞ëÊúâ4‰∏™ÁÇπÔºåÈ¶ñÂ∞æÁõ∏ÂêåÔºâ
            if (coords.length >= 3) {
                // Â¶ÇÊûúÈ¶ñÂ∞æ‰∏çÁõ∏ÂêåÔºåÈó≠ÂêàÁéØ
                if (coords[0][0] !== coords[coords.length - 1][0] ||
                    coords[0][1] !== coords[coords.length - 1][1]) {
                    coords.push(coords[0]);
                }

                // Á°Æ‰øùËá≥Â∞ëÊúâ4‰∏™ÁÇπÔºàÈó≠ÂêàÂêéÔºâ
                if (coords.length < 4) {
                    // Â¶ÇÊûúÁÇπÊï∞‰∏çË∂≥4‰∏™ÔºåÂ§çÂà∂ÁÇπÁõ¥Âà∞ËææÂà∞4‰∏™
                    while (coords.length < 4) {
                        coords.push(coords[coords.length - 1]);
                    }
                }
            } else if (coords.length === 2) {
                // Â¶ÇÊûúÂè™Êúâ2‰∏™ÁÇπÔºåÂ§çÂà∂ÂÆÉ‰ª¨ÂΩ¢ÊàêËá≥Â∞ë4‰∏™ÁÇπÁöÑÁéØ
                coords.push(coords[1]);
                coords.push(coords[0]);
            } else if (coords.length === 1) {
                // Â¶ÇÊûúÂè™Êúâ1‰∏™ÁÇπÔºåÂ§çÂà∂3Ê¨°ÂΩ¢Êàê4‰∏™ÁÇπÁöÑÁéØ
                for (let k = 0; k < 3; k++) {
                    coords.push(coords[0]);
                }
            }

            const polygon = turf.polygon([coords]);
            const area = turf.area(polygon); // Âπ≥ÊñπÁ±≥

            return area;
        } catch (e) {
            console.error('ËÆ°ÁÆóÂ§öËæπÂΩ¢Èù¢ÁßØÊó∂Âá∫Èîô:', e);
            return 0;
        }
    }

    // Ëé∑ÂèñÂ§öËæπÂΩ¢‰∏≠ÂøÉÁÇπ
    function getPolygonCenter(points) {
        if (points.length === 0) return null;

        let latSum = 0, lngSum = 0;
        points.forEach(p => {
            latSum += p.lat;
            lngSum += p.lng;
        });

        return L.latLng(latSum / points.length, lngSum / points.length);
    }

    // ËÆ°ÁÆóÊÄªË∑ùÁ¶ª
    function calculateTotalDistance() {
        let total = 0;
        for (let i = 1; i < measureState.points.length; i++) {
            total += calculateDistance(measureState.points[i-1], measureState.points[i]);
        }
        return total;
    }

    // ÊòæÁ§∫Ë∑ùÁ¶ªÊ†áÁ≠æ
    function showDistanceLabel(latlng, distance) {
        const label = L.divIcon({
            className: 'measure-label',
            html: `<div style="background: rgba(255,255,255,0.9); color: #333; padding: 2px 6px; border-radius: 3px; font-size: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.3);">${distance.toFixed(2)} Á±≥</div>`,
            iconSize: null,
            iconAnchor: [0, -10]
        });

        const marker = L.marker(latlng, { icon: label });
        measureLayerGroup.addLayer(marker);
        measureState.labels.push(marker);
    }

    // ÊòæÁ§∫Èù¢ÁßØÊ†áÁ≠æ
    function showAreaLabel(latlng, area) {
        const label = L.divIcon({
            className: 'measure-label',
            html: `<div style="background: rgba(255,255,255,0.9); color: #333; padding: 2px 6px; border-radius: 3px; font-size: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.3);">${area.toFixed(2)} Âπ≥ÊñπÁ±≥</div>`,
            iconSize: null,
            iconAnchor: [0, -10]
        });

        const marker = L.marker(latlng, { icon: label });
        measureLayerGroup.addLayer(marker);
        measureState.areaLabel = marker;
    }

    // ÊòæÁ§∫ÊÄªË∑ùÁ¶ªÊ†áÁ≠æ
    function showTotalDistanceLabel(totalDistance) {
        if (measureState.points.length === 0) return;

        const lastPoint = measureState.points[measureState.points.length - 1];
        const label = L.divIcon({
            className: 'measure-total-label',
            html: `<div style="background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px; font-size: 14px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">ÊÄªË∑ùÁ¶ª: ${totalDistance.toFixed(2)} Á±≥</div>`,
            iconSize: null,
            iconAnchor: [0, -20]
        });

        const marker = L.marker(lastPoint, { icon: label });
        measureLayerGroup.addLayer(marker);
        measureState.labels.push(marker);
    }

    // ÊòæÁ§∫ÊÄªÈù¢ÁßØÊ†áÁ≠æ
    function showTotalAreaLabel(latlng, area) {
        const areaInMu = area / 666.6667;
        const label = L.divIcon({
            className: 'measure-total-label',
            html: `<div style="background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px; font-size: 14px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.3); line-height: 1.4;">ÊÄªÈù¢ÁßØ: ${area.toFixed(2)} Âπ≥ÊñπÁ±≥<br>${areaInMu.toFixed(2)} ‰∫©</div>`,
            iconSize: null,
            iconAnchor: [0, -40]
        });

        const marker = L.marker(latlng, { icon: label });
        measureLayerGroup.addLayer(marker);
        measureState.labels.push(marker);
    }

    // Ê∏ÖÈô§ÊµãÈáèÁªìÊûú
    function clearMeasureResult() {
        measureLayerGroup.clearLayers();
        measureState = {
            isActive: false,
            mode: '',
            points: [],
            tempLine: null,
            lines: [],
            markers: [],
            labels: [],
            polygon: null,
            areaLabel: null
        };

        // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
        document.getElementById('measureDistanceBtn').classList.remove('active');
        document.getElementById('measureAreaBtn').classList.remove('active');
        document.getElementById('measureDistanceBtn').disabled = false;
        document.getElementById('measureAreaBtn').disabled = false;

        // Á°Æ‰øùÈáçÊñ∞ÂêØÁî®Âú∞ÂõæÂèåÂáªÁº©ÊîæÂäüËÉΩ
        if (map && map.doubleClickZoom) {
            map.doubleClickZoom.enable();

            // ÊÅ¢Â§çÂú∞ÂõæÈÄâÈ°πËÆæÁΩÆ
            if (map.options) {
                map.options.doubleClickZoom = true;
                map.options.tap = true;
            }
        }
    }

    // Âú∞ÂõæÁ±ªÂûãÂàáÊç¢
    function toggleMapType() {
        console.log('toggleMapType called, currentMapType:', currentMapType);
        console.log('map:', map);
        console.log('currentBaseLayer:', currentBaseLayer);
        console.log('currentSatelliteLayer:', currentSatelliteLayer);

        if (!map) {
            console.error('Map not initialized');
            return;
        }

        if (!currentBaseLayer || !currentSatelliteLayer) {
            console.error('Layers not properly initialized');
            updateStatus('ÂõæÂ±ÇÊú™Ê≠£Á°ÆÂàùÂßãÂåñ');
            return;
        }

        const mapTypeBtn = document.getElementById('mapTypeBtn');

        try {
            if (currentMapType === 'street') {
                console.log('Switching to satellite map');
                // ÂàáÊç¢Âà∞Âç´ÊòüÂõæ
                map.removeLayer(currentBaseLayer);
                map.addLayer(currentSatelliteLayer);
                currentMapType = 'satellite';
                mapTypeBtn.innerHTML = 'üõ∞Ô∏è Âç´ÊòüÂõæ';
                mapTypeBtn.title = 'ÂΩìÂâçÔºöÂç´ÊòüÂõæÔºåÁÇπÂáªÂàáÊç¢Ë°óÈÅìÂõæ';
            } else {
                console.log('Switching to street map');
                // ÂàáÊç¢Âà∞Ë°óÈÅìÂõæ
                map.removeLayer(currentSatelliteLayer);
                map.addLayer(currentBaseLayer);
                currentMapType = 'street';
                mapTypeBtn.innerHTML = 'üó∫Ô∏è Ë°óÈÅìÂõæ';
                mapTypeBtn.title = 'ÂΩìÂâçÔºöË°óÈÅìÂõæÔºåÁÇπÂáªÂàáÊç¢Âç´ÊòüÂõæ';
            }

            updateStatus(`Â∑≤ÂàáÊç¢Âà∞${currentMapType === 'street' ? 'Ë°óÈÅìÂõæ' : 'Âç´ÊòüÂõæ'}`);
            console.log('Map type switched successfully to:', currentMapType);
        } catch (error) {
            console.error('Error switching map type:', error);
            updateStatus('Âú∞ÂõæÂàáÊç¢Â§±Ë¥•: ' + error.message);
        }
    }

    // Ê∏ÖÁ©∫ÊâÄÊúâ
    function clearAll() {
        clearMeasureResult();

        updateStatus('ÊµãË∑ùÊµãÈù¢Â∑≤Ê∏ÖÁ©∫');
    }

    // ÂàáÊç¢Â∑¶‰æßÈù¢Êùø
    function toggleLeftPanel() {
        const panel = document.querySelector('.left-panel');
        const fixedToggle = document.getElementById('panelToggleFixed');

        if (panel.classList.contains('collapsed')) {
            // Â±ïÂºÄÈù¢Êùø - Èù¢ÊùøÂΩìÂâçÊòØÊî∂Ëµ∑ÁöÑÔºåÁÇπÂáªÂêéË¶ÅÂ±ïÂºÄÔºåÊâÄ‰ª•ÊåâÈíÆÂ∫îÊòæÁ§∫‰∏∫Â±ïÂºÄÂõæÊ†á
            panel.classList.remove('collapsed');
            if(fixedToggle) {
                fixedToggle.innerHTML = '‚ñ∂‚óÄ'; // Â±ïÂºÄÂõæÊ†á
                fixedToggle.title = 'Êî∂Áº©Â∑•ÂÖ∑Ê†è';
            }
        } else {
            // Êî∂Ëµ∑Èù¢Êùø - Èù¢ÊùøÂΩìÂâçÊòØÂ±ïÂºÄÁöÑÔºåÁÇπÂáªÂêéË¶ÅÊî∂Ëµ∑ÔºåÊâÄ‰ª•ÊåâÈíÆÂ∫îÊòæÁ§∫‰∏∫Êî∂Áº©ÂõæÊ†á
            panel.classList.add('collapsed');
            if(fixedToggle) {
                fixedToggle.innerHTML = '‚óÄ‚ñ∂'; // Êî∂Áº©ÂõæÊ†á
                fixedToggle.title = 'Â±ïÂºÄÂ∑•ÂÖ∑Ê†è';
            }
        }
    }

    // ÂàáÊç¢Ê†áÈ¢òÊ†è
    function toggleHeader() {
        const header = document.querySelector('.header');
        const toggle = document.getElementById('headerToggle');

        if (header.classList.contains('show')) {
            // ÈöêËóèÊ†áÈ¢ò
            header.classList.remove('show');
            header.style.display = 'none';
            toggle.innerHTML = '‚ò∞';
            toggle.title = 'ÊòæÁ§∫Â∑•ÂÖ∑Ê†è';
            toggle.style.display = 'block';
        } else {
            // ÊòæÁ§∫Ê†áÈ¢ò
            header.classList.add('show');
            header.style.display = 'flex';
            toggle.innerHTML = '‚úï';
            toggle.title = 'ÈöêËóèÂ∑•ÂÖ∑Ê†è';
        }
    }

    // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
    document.addEventListener('DOMContentLoaded', function() {
        initMap();
        bindTabEvents();
        bindColorPickerEvents();
        bindToolEvents();

        // ÁªëÂÆöÈù¢ÊùøÂàáÊç¢‰∫ã‰ª∂
        const headerToggle = document.getElementById('headerToggle');
        const panelToggleFixed = document.getElementById('panelToggleFixed');

        if (headerToggle) {
            headerToggle.addEventListener('click', toggleHeader);
            headerToggle.style.display = 'block';
        }

        if (panelToggleFixed) {
            panelToggleFixed.addEventListener('click', toggleLeftPanel);
        }

        // ÂàùÂßãÂåñÈù¢ÊùøÁä∂ÊÄÅ
        const savedPanelState = localStorage.getItem('leftPanelCollapsed');
        const panel = document.querySelector('.left-panel');
        const fixedToggle = document.getElementById('panelToggleFixed');

        if (savedPanelState === 'true') {
            panel.classList.add('collapsed');
            if(fixedToggle) {
                fixedToggle.innerHTML = '‚óÄ‚ñ∂'; // Êî∂Áº©ÂõæÊ†á
                fixedToggle.title = 'Â±ïÂºÄÂ∑•ÂÖ∑Ê†è';
            }
        } else {
            if(fixedToggle) {
                fixedToggle.innerHTML = '‚ñ∂‚óÄ'; // Â±ïÂºÄÂõæÊ†á
                fixedToggle.title = 'Êî∂Áº©Â∑•ÂÖ∑Ê†è';
            }
        }

        // Ê∑ªÂä†ÊòæÁ§∫‰∫©Êï∞Â§çÈÄâÊ°ÜÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
        const toggleLabelsCheckbox = document.getElementById('toggleLabelsCheckbox');
        if (toggleLabelsCheckbox) {
            toggleLabelsCheckbox.addEventListener('change', function() {
                const isChecked = this.checked;
                labelsEnabled = isChecked;
                console.log('Ê†áÁ≠æÊòæÁ§∫Áä∂ÊÄÅÂ∑≤Êõ¥Êîπ:', isChecked);

                // Ëé∑ÂèñÂÆπÂô®ÂÖÉÁ¥†Âπ∂ÂàáÊç¢labels-hiddenÁ±ª
                const container = document.querySelector('.container') || document.body;

                if (isChecked) {
                    // ÂêØÁî®Ê†áÁ≠æÔºöÊòæÁ§∫ÊâÄÊúâÊ†áÁ≠æ
                    console.log('ÂêØÁî®Ê†áÁ≠æÊòæÁ§∫');
                    container.classList.remove('labels-hidden');

                    console.log('Ê£ÄÊü•ÊòØÂê¶ÊúâËΩÆÂªìÂõæÂ±ÇÁªÑ:', outlineLayerGroup);
                    if (outlineLayerGroup && outlineLayerGroup.getLayers) {
                        console.log('ËΩÆÂªìÂõæÂ±ÇÁªÑÂ≠òÂú®ÔºåËé∑ÂèñÂõæÂ±ÇÊï∞Èáè:', outlineLayerGroup.getLayers().length);
                        if (outlineLayerGroup.getLayers().length > 0) {
                            // Ê∏ÖÈô§Áé∞ÊúâÊ†áÁ≠æ
                            labelLayerGroup.clearLayers();
                            console.log('Â∑≤Ê∏ÖÈô§Áé∞ÊúâÊ†áÁ≠æÔºåÂáÜÂ§áÊ∑ªÂä†Êñ∞Ê†áÁ≠æ');

                            // ‰∏∫ÊØè‰∏™ËΩÆÂªìÊ∑ªÂä†Ê†áÁ≠æ
                            // Á°Æ‰øùL.GeometryUtilÂ∑≤Âä†ËΩΩ
                            if (typeof L.GeometryUtil === 'undefined' || typeof L.GeometryUtil.geodesicArea !== 'function') {
                                console.log('‰ΩøÁî®Turf.jsËÆ°ÁÆóÈù¢ÁßØ');
                                // Â∞ùËØï‰ΩøÁî®Turf.js‰Ωú‰∏∫Â§áÈÄâÊñπÊ°à
                                if (typeof turf !== 'undefined') {
                                    console.log('‰ΩøÁî®Turf.jsËÆ°ÁÆóÈù¢ÁßØ');
                                    outlineLayerGroup.eachLayer(function(layer) {
                                        // Ëé∑ÂèñÂõæÂ±Ç‰∏≠ÁöÑÂÆûÈôÖÂá†‰ΩïË¶ÅÁ¥†ËøõË°åÈù¢ÁßØËÆ°ÁÆó
                                        let layers = [];

                                        // Â¶ÇÊûúlayerÊòØLayerGroupÊàñFeatureGroupÔºåËé∑ÂèñÂÖ∂ÊâÄÊúâÂ≠êÂõæÂ±Ç
                                        if (layer instanceof L.LayerGroup || layer instanceof L.FeatureGroup) {
                                            layers = layer.getLayers();
                                        } else {
                                            layers = layer.getLayers ? layer.getLayers() : [layer];
                                        }

                                        console.log('ÂõæÂ±ÇÊï∞ÁªÑÈïøÂ∫¶:', layers && Array.isArray(layers) ? layers.length : 0);
                                        if (layers && Array.isArray(layers) && layers.length > 0) {
                                            for (let j = 0; j < layers.length; j++) {
                                                const subLayer = layers[j];
                                                console.log('Â§ÑÁêÜÂ≠êÂõæÂ±Ç:', subLayer);
                                                let latLngs;

                                                // Ê†πÊçÆÂõæÂ±ÇÁ±ªÂûãËé∑ÂèñÂùêÊ†á
                                                if (subLayer instanceof L.Polygon) {
                                                    latLngs = subLayer.getLatLngs();
                                                    console.log('Â§öËæπÂΩ¢latLngs:', latLngs);
                                                } else if (subLayer instanceof L.MultiPolygon) {
                                                    // ÂØπ‰∫éMultiPolygonÔºåÂèñÁ¨¨‰∏Ä‰∏™Â§öËæπÂΩ¢
                                                    const multiLatLngs = subLayer.getLatLngs();
                                                    console.log('MultiPolygon latLngs:', multiLatLngs);
                                                    if (multiLatLngs && multiLatLngs.length > 0) {
                                                        latLngs = multiLatLngs[0];
                                                    }
                                                } else if (subLayer instanceof L.Rectangle) {
                                                    // ÂØπ‰∫éRectangleÔºåËé∑ÂèñÂÖ∂ËæπÁïåÂùêÊ†á
                                                    latLngs = subLayer.getLatLngs();
                                                    console.log('Áü©ÂΩ¢latLngs:', latLngs);
                                                }

                                                if (latLngs) {
                                                    // ‰ΩøÁî®Turf.jsËÆ°ÁÆóÈù¢ÁßØ
                                                    try {
                                                        // Â§ÑÁêÜÂ§öËæπÂΩ¢ÂùêÊ†áÔºåÊîØÊåÅÂ§ñÈÉ®ËæπÁïåÂíåÂÜÖÈÉ®Â≠îÊ¥û
                                                        const processPolygon = (polyCoords) => {
                                                            if (!Array.isArray(polyCoords) || polyCoords.length === 0) {
                                                                return null;
                                                            }

                                                            // Â¶ÇÊûúÊòØÂ§öËæπÂΩ¢Êï∞ÁªÑÔºàÂ§ñÈÉ®ËæπÁïå+Â≠îÊ¥ûÔºâÔºåÂàÜÂà´Â§ÑÁêÜ
                                                            let processedCoords = [];

                                                            // Â§ÑÁêÜÂ§öËæπÂΩ¢ÁöÑÊØè‰∏™ÁéØÔºàÁ¨¨‰∏Ä‰∏™ÊòØÂ§ñÈÉ®ËæπÁïåÔºåÂÖ∂‰ΩôÊòØÂ≠îÊ¥ûÔºâ
                                                            for (let i = 0; i < polyCoords.length; i++) {
                                                                let ring = polyCoords[i];
                                                                if (!Array.isArray(ring)) {
                                                                    ring = [ring]; // Â¶ÇÊûú‰∏çÊòØÊï∞ÁªÑÔºåËΩ¨Êç¢‰∏∫Êï∞ÁªÑ
                                                                }

                                                                // Â∞ÜLeafletÂùêÊ†áËΩ¨Êç¢‰∏∫GeoJSONÊ†ºÂºè [lng, lat]
                                                                let geoJsonRing = ring.map(latLng => {
                                                                    if (latLng.lat !== undefined && latLng.lng !== undefined) {
                                                                        return [latLng.lng, latLng.lat];
                                                                    } else if (Array.isArray(latLng) && latLng.length >= 2) {
                                                                        // Â¶ÇÊûúÂ∑≤ÁªèÊòØÊï∞ÁªÑÊ†ºÂºè [lat, lng] Êàñ [lng, lat]
                                                                        return [latLng[1], latLng[0]]; // ÂÅáËÆæÊòØ [lat, lng] Ê†ºÂºè
                                                                    }
                                                                    return null;
                                                                }).filter(coord => coord !== null);

                                                                // Á°Æ‰øùÁéØÊòØÈó≠ÂêàÁöÑÔºàËá≥Â∞ëÊúâ4‰∏™ÁÇπÔºåÈ¶ñÂ∞æÁõ∏ÂêåÔºâ
                                                                if (geoJsonRing.length >= 3) {
                                                                    // Â¶ÇÊûúÈ¶ñÂ∞æ‰∏çÁõ∏ÂêåÔºåÈó≠ÂêàÁéØ
                                                                    if (geoJsonRing[0][0] !== geoJsonRing[geoJsonRing.length - 1][0] ||
                                                                        geoJsonRing[0][1] !== geoJsonRing[geoJsonRing.length - 1][1]) {
                                                                        geoJsonRing.push(geoJsonRing[0]);
                                                                    }

                                                                    // Á°Æ‰øùËá≥Â∞ëÊúâ4‰∏™ÁÇπÔºàÈó≠ÂêàÂêéÔºâ
                                                                    if (geoJsonRing.length < 4) {
                                                                        // Â¶ÇÊûúÁÇπÊï∞‰∏çË∂≥4‰∏™ÔºåÂ§çÂà∂ÁÇπÁõ¥Âà∞ËææÂà∞4‰∏™
                                                                        while (geoJsonRing.length < 4) {
                                                                            geoJsonRing.push(geoJsonRing[geoJsonRing.length - 1]);
                                                                        }
                                                                    }
                                                                } else if (geoJsonRing.length === 2) {
                                                                    // Â¶ÇÊûúÂè™Êúâ2‰∏™ÁÇπÔºåÂ§çÂà∂ÂÆÉ‰ª¨ÂΩ¢ÊàêËá≥Â∞ë4‰∏™ÁÇπÁöÑÁéØ
                                                                    geoJsonRing.push(geoJsonRing[1]);
                                                                    geoJsonRing.push(geoJsonRing[0]);
                                                                } else if (geoJsonRing.length === 1) {
                                                                    // Â¶ÇÊûúÂè™Êúâ1‰∏™ÁÇπÔºåÂ§çÂà∂3Ê¨°ÂΩ¢Êàê4‰∏™ÁÇπÁöÑÁéØ
                                                                    for (let k = 0; k < 3; k++) {
                                                                        geoJsonRing.push(geoJsonRing[0]);
                                                                    }
                                                                }

                                                                processedCoords.push(geoJsonRing);
                                                            }

                                                            return processedCoords;
                                                        };

                                                        // Ê†πÊçÆlatLngsÁöÑÁªìÊûÑÂ§ÑÁêÜÂùêÊ†á
                                                        let coordinates;
                                                        if (Array.isArray(latLngs) && latLngs.length > 0) {
                                                            if (Array.isArray(latLngs[0])) {
                                                                // Â¶ÇÊûúÊòØÂ§öËæπÂΩ¢Êï∞ÁªÑÔºàÂåÖÂê´Â§ñÈÉ®ËæπÁïåÂíåÂ≠îÊ¥ûÔºâ
                                                                coordinates = processPolygon(latLngs);
                                                            } else {
                                                                // Â¶ÇÊûúÊòØÂçï‰∏™Â§öËæπÂΩ¢ËæπÁïå
                                                                coordinates = processPolygon([latLngs]);
                                                            }
                                                        } else {
                                                            // Âçï‰∏™Â§öËæπÂΩ¢ËæπÁïå
                                                            coordinates = processPolygon([latLngs]);
                                                        }

                                                        if (coordinates && coordinates.length > 0) {
                                                            const polygon = turf.polygon(coordinates);
                                                            const areaSqM = turf.area(polygon);
                                                            const areaMu = (areaSqM / 666.6667).toFixed(4); // ËΩ¨Êç¢‰∏∫‰∫©
                                                            console.log('‰ΩøÁî®Turf.jsËÆ°ÁÆóÂæóÂà∞ÁöÑÈù¢ÁßØ:', areaSqM, 'Âπ≥ÊñπÁ±≥ (', areaMu, '‰∫©)');
                                                            console.log('‰∏∫ÂõæÂ±ÇÊ∑ªÂä†Èù¢ÁßØÊ†áÁ≠æ:', areaMu, '‰∫©');
                                                            addAreaLabelToLayer(subLayer, `Èù¢ÁßØ: ${areaMu}‰∫©`); // ‰ΩøÁî®subLayerËÄå‰∏çÊòØlayer
                                                        } else {
                                                            console.log('Êó†Ê≥ïÂ§ÑÁêÜÂùêÊ†áÊï∞ÊçÆÔºåË∑≥ËøáÊ≠§ÂõæÂ±Ç');
                                                        }
                                                    } catch (e) {
                                                        console.error('‰ΩøÁî®Turf.jsËÆ°ÁÆóÈù¢ÁßØÊó∂Âá∫Èîô:', e);
                                                    }
                                                } else {
                                                    console.log('Êó†Ê≥ïËé∑ÂèñÂùêÊ†áÔºåË∑≥ËøáÊ≠§ÂõæÂ±Ç');
                                                }
                                            }
                                        } else {
                                            console.log('ÂõæÂ±ÇÊï∞ÁªÑ‰∏∫Á©∫Êàñ‰∏çÊòØÊï∞ÁªÑ');
                                        }
                                    });
                                } else {
                                    console.error('Turf.js‰πüÊú™ÂÆö‰πâÔºåÊó†Ê≥ïËÆ°ÁÆóÈù¢ÁßØ');
                                }
                            } else {
                                console.log('ÂºÄÂßã‰∏∫', outlineLayerGroup.getLayers().length, '‰∏™ËΩÆÂªìÊ∑ªÂä†Ê†áÁ≠æ');
                                let labelCount = 0;
                                outlineLayerGroup.eachLayer(function(layer) {
                                    console.log('Â§ÑÁêÜÂõæÂ±Ç:', layer);
                                    // Ëé∑ÂèñÂõæÂ±Ç‰∏≠ÁöÑÂÆûÈôÖÂá†‰ΩïË¶ÅÁ¥†ËøõË°åÈù¢ÁßØËÆ°ÁÆó
                                    let layers = [];

                                    // Â¶ÇÊûúlayerÊòØLayerGroupÊàñFeatureGroupÔºåËé∑ÂèñÂÖ∂ÊâÄÊúâÂ≠êÂõæÂ±Ç
                                    if (layer instanceof L.LayerGroup || layer instanceof L.FeatureGroup) {
                                        layers = layer.getLayers();
                                    } else {
                                        layers = layer.getLayers ? layer.getLayers() : [layer];
                                    }

                                    console.log('ÂõæÂ±ÇÊï∞ÁªÑÈïøÂ∫¶:', layers && Array.isArray(layers) ? layers.length : 0);
                                    if (layers && Array.isArray(layers) && layers.length > 0) {
                                        for (let j = 0; j < layers.length; j++) {
                                            const subLayer = layers[j];
                                            console.log('Â§ÑÁêÜÂ≠êÂõæÂ±Ç:', subLayer);
                                            let latLngs;

                                            // Ê†πÊçÆÂõæÂ±ÇÁ±ªÂûãËé∑ÂèñÂùêÊ†á
                                            if (subLayer instanceof L.Polygon) {
                                                latLngs = subLayer.getLatLngs();
                                                console.log('Â§öËæπÂΩ¢latLngs:', latLngs);
                                            } else if (subLayer instanceof L.MultiPolygon) {
                                                // ÂØπ‰∫éMultiPolygonÔºåÂèñÁ¨¨‰∏Ä‰∏™Â§öËæπÂΩ¢
                                                const multiLatLngs = subLayer.getLatLngs();
                                                console.log('MultiPolygon latLngs:', multiLatLngs);
                                                if (multiLatLngs && multiLatLngs.length > 0) {
                                                    latLngs = multiLatLngs[0];
                                                }
                                            } else if (subLayer instanceof L.Rectangle) {
                                                // ÂØπ‰∫éRectangleÔºåËé∑ÂèñÂÖ∂ËæπÁïåÂùêÊ†á
                                                latLngs = subLayer.getLatLngs();
                                                console.log('Áü©ÂΩ¢latLngs:', latLngs);
                                            }

                                            if (latLngs) {
                                                // Ê£ÄÊü•L.GeometryUtilÊòØÂê¶ÂèØÁî®ÔºåÂ¶ÇÊûú‰∏çÂèØÁî®Âàô‰ΩøÁî®Turf.js
                                                if (typeof L.GeometryUtil !== 'undefined' && typeof L.GeometryUtil.geodesicArea === 'function') {
                                                    const areaSqM = L.GeometryUtil.geodesicArea(latLngs[0] || latLngs);
                                                    const areaMu = (areaSqM / 666.6667).toFixed(4); // ËΩ¨Êç¢‰∏∫‰∫©
                                                    console.log('‰ΩøÁî®L.GeometryUtilËÆ°ÁÆóÂæóÂà∞ÁöÑÈù¢ÁßØ:', areaSqM, 'Âπ≥ÊñπÁ±≥ (', areaMu, '‰∫©)');
                                                    console.log('‰∏∫ÂõæÂ±ÇÊ∑ªÂä†Èù¢ÁßØÊ†áÁ≠æ:', areaMu, '‰∫©');
                                                    addAreaLabelToLayer(subLayer, `Èù¢ÁßØ: ${areaMu}‰∫©`); // ‰ΩøÁî®subLayerËÄå‰∏çÊòØlayer
                                                    labelCount++;
                                                } else {
                                                    console.log('L.GeometryUtilÊú™ÂÆö‰πâÊàñgeodesicAreaÊñπÊ≥ï‰∏çÂ≠òÂú®ÔºåÂ∞ùËØï‰ΩøÁî®Turf.js');
                                                    // ‰ΩøÁî®Turf.jsËÆ°ÁÆóÈù¢ÁßØ
                                                    try {
                                                        // Â§ÑÁêÜÂ§öËæπÂΩ¢ÂùêÊ†áÔºåÊîØÊåÅÂ§ñÈÉ®ËæπÁïåÂíåÂÜÖÈÉ®Â≠îÊ¥û
                                                        const processPolygon = (polyCoords) => {
                                                            if (!Array.isArray(polyCoords) || polyCoords.length === 0) {
                                                                return null;
                                                            }

                                                            // Â¶ÇÊûúÊòØÂ§öËæπÂΩ¢Êï∞ÁªÑÔºàÂ§ñÈÉ®ËæπÁïå+Â≠îÊ¥ûÔºâÔºåÂàÜÂà´Â§ÑÁêÜ
                                                            let processedCoords = [];

                                                            // Â§ÑÁêÜÂ§öËæπÂΩ¢ÁöÑÊØè‰∏™ÁéØÔºàÁ¨¨‰∏Ä‰∏™ÊòØÂ§ñÈÉ®ËæπÁïåÔºåÂÖ∂‰ΩôÊòØÂ≠îÊ¥ûÔºâ
                                                            for (let i = 0; i < polyCoords.length; i++) {
                                                                let ring = polyCoords[i];
                                                                if (!Array.isArray(ring)) {
                                                                    ring = [ring]; // Â¶ÇÊûú‰∏çÊòØÊï∞ÁªÑÔºåËΩ¨Êç¢‰∏∫Êï∞ÁªÑ
                                                                }

                                                                // Â∞ÜLeafletÂùêÊ†áËΩ¨Êç¢‰∏∫GeoJSONÊ†ºÂºè [lng, lat]
                                                                let geoJsonRing = ring.map(latLng => {
                                                                    if (latLng.lat !== undefined && latLng.lng !== undefined) {
                                                                        return [latLng.lng, latLng.lat];
                                                                    } else if (Array.isArray(latLng) && latLng.length >= 2) {
                                                                        // Â¶ÇÊûúÂ∑≤ÁªèÊòØÊï∞ÁªÑÊ†ºÂºè [lat, lng] Êàñ [lng, lat]
                                                                        return [latLng[1], latLng[0]]; // ÂÅáËÆæÊòØ [lat, lng] Ê†ºÂºè
                                                                    }
                                                                    return null;
                                                                }).filter(coord => coord !== null);

                                                                // Á°Æ‰øùÁéØÊòØÈó≠ÂêàÁöÑÔºàËá≥Â∞ëÊúâ4‰∏™ÁÇπÔºåÈ¶ñÂ∞æÁõ∏ÂêåÔºâ
                                                                if (geoJsonRing.length >= 3) {
                                                                    // Â¶ÇÊûúÈ¶ñÂ∞æ‰∏çÁõ∏ÂêåÔºåÈó≠ÂêàÁéØ
                                                                    if (geoJsonRing[0][0] !== geoJsonRing[geoJsonRing.length - 1][0] ||
                                                                        geoJsonRing[0][1] !== geoJsonRing[geoJsonRing.length - 1][1]) {
                                                                        geoJsonRing.push(geoJsonRing[0]);
                                                                    }

                                                                    // Á°Æ‰øùËá≥Â∞ëÊúâ4‰∏™ÁÇπÔºàÈó≠ÂêàÂêéÔºâ
                                                                    if (geoJsonRing.length < 4) {
                                                                        // Â¶ÇÊûúÁÇπÊï∞‰∏çË∂≥4‰∏™ÔºåÂ§çÂà∂ÁÇπÁõ¥Âà∞ËææÂà∞4‰∏™
                                                                        while (geoJsonRing.length < 4) {
                                                                            geoJsonRing.push(geoJsonRing[geoJsonRing.length - 1]);
                                                                        }
                                                                    }
                                                                } else if (geoJsonRing.length === 2) {
                                                                    // Â¶ÇÊûúÂè™Êúâ2‰∏™ÁÇπÔºåÂ§çÂà∂ÂÆÉ‰ª¨ÂΩ¢ÊàêËá≥Â∞ë4‰∏™ÁÇπÁöÑÁéØ
                                                                    geoJsonRing.push(geoJsonRing[1]);
                                                                    geoJsonRing.push(geoJsonRing[0]);
                                                                } else if (geoJsonRing.length === 1) {
                                                                    // Â¶ÇÊûúÂè™Êúâ1‰∏™ÁÇπÔºåÂ§çÂà∂3Ê¨°ÂΩ¢Êàê4‰∏™ÁÇπÁöÑÁéØ
                                                                    for (let k = 0; k < 3; k++) {
                                                                        geoJsonRing.push(geoJsonRing[0]);
                                                                    }
                                                                }

                                                                processedCoords.push(geoJsonRing);
                                                            }

                                                            return processedCoords;
                                                        };

                                                        // Ê†πÊçÆlatLngsÁöÑÁªìÊûÑÂ§ÑÁêÜÂùêÊ†á
                                                        let coordinates;
                                                        if (Array.isArray(latLngs) && latLngs.length > 0) {
                                                            if (Array.isArray(latLngs[0])) {
                                                                // Â¶ÇÊûúÊòØÂ§öËæπÂΩ¢Êï∞ÁªÑÔºàÂåÖÂê´Â§ñÈÉ®ËæπÁïåÂíåÂ≠îÊ¥ûÔºâ
                                                                coordinates = processPolygon(latLngs);
                                                            } else {
                                                                // Â¶ÇÊûúÊòØÂçï‰∏™Â§öËæπÂΩ¢ËæπÁïå
                                                                coordinates = processPolygon([latLngs]);
                                                            }
                                                        } else {
                                                            // Âçï‰∏™Â§öËæπÂΩ¢ËæπÁïå
                                                            coordinates = processPolygon([latLngs]);
                                                        }

                                                        if (coordinates && coordinates.length > 0) {
                                                            const polygon = turf.polygon(coordinates);
                                                            const areaSqM = turf.area(polygon);
                                                            const areaMu = (areaSqM / 666.6667).toFixed(4); // ËΩ¨Êç¢‰∏∫‰∫©
                                                            console.log('‰ΩøÁî®Turf.jsËÆ°ÁÆóÂæóÂà∞ÁöÑÈù¢ÁßØ:', areaSqM, 'Âπ≥ÊñπÁ±≥ (', areaMu, '‰∫©)');
                                                            console.log('‰∏∫ÂõæÂ±ÇÊ∑ªÂä†Èù¢ÁßØÊ†áÁ≠æ:', areaMu, '‰∫©');
                                                            addAreaLabelToLayer(subLayer, `Èù¢ÁßØ: ${areaMu}‰∫©`); // ‰ΩøÁî®subLayerËÄå‰∏çÊòØlayer
                                                            labelCount++;
                                                        } else {
                                                            console.log('Êó†Ê≥ïÂ§ÑÁêÜÂùêÊ†áÊï∞ÊçÆÔºåË∑≥ËøáÊ≠§ÂõæÂ±Ç');
                                                        }
                                                    } catch (e) {
                                                        console.error('‰ΩøÁî®Turf.jsËÆ°ÁÆóÈù¢ÁßØÊó∂Âá∫Èîô:', e);
                                                    }
                                                }
                                            } else {
                                                console.log('Êó†Ê≥ïËé∑ÂèñÂùêÊ†áÔºåË∑≥ËøáÊ≠§ÂõæÂ±Ç');
                                            }
                                        }
                                    } else {
                                        console.log('ÂõæÂ±ÇÊï∞ÁªÑ‰∏∫Á©∫Êàñ‰∏çÊòØÊï∞ÁªÑ');
                                    }
                                });
                                console.log('ÊÄªÂÖ±Â§ÑÁêÜ‰∫Ü', labelCount, '‰∏™Ê†áÁ≠æ');
                            }
                        } else {
                            console.log('ËΩÆÂªìÂõæÂ±ÇÁªÑ‰∏≠Ê≤°ÊúâÂõæÂ±Ç');
                        }
                    } else {
                        console.log('ËΩÆÂªìÂõæÂ±ÇÁªÑ‰∏çÂ≠òÂú®ÊàñÊ≤°ÊúâgetLayersÊñπÊ≥ï');
                    }
                } else {
                    // Á¶ÅÁî®Ê†áÁ≠æÔºöÈöêËóèÊâÄÊúâÊ†áÁ≠æ
                    console.log('Á¶ÅÁî®Ê†áÁ≠æÊòæÁ§∫ÔºåÊ∏ÖÈô§ÊâÄÊúâÊ†áÁ≠æ');
                    if (labelLayerGroup) {
                        labelLayerGroup.clearLayers();
                        console.log('Ê†áÁ≠æÂõæÂ±ÇÂ∑≤Ê∏ÖÁ©∫ÔºåÂΩìÂâçÂõæÂ±ÇÊï∞Èáè:', labelLayerGroup.getLayers().length);
                    } else {
                        console.log('Ê†áÁ≠æÂõæÂ±ÇÁªÑ‰∏çÂ≠òÂú®');
                    }
                    container.classList.add('labels-hidden');
                }

                // Á°Æ‰øùÊ†áÁ≠æÂõæÂ±ÇÂßãÁªàÂú®ÊúÄ‰∏äÂ±Ç
                if (labelLayerGroup) {
                    map.removeLayer(labelLayerGroup);
                    map.addLayer(labelLayerGroup);
                }
            });
        }

        updateStatus('È°µÈù¢Âä†ËΩΩÂÆåÊàê');
    });

    // ÂÖ®Â±ÄÂáΩÊï∞‰æõHTMLË∞ÉÁî®
    window.drawOutline = drawOutline;
    window.clearOutline = clearOutline;
    window.drawTrack = drawTrack;
    window.startPlayback = startPlayback;
    window.stopPlayback = stopPlayback;
</script>
</body>
</html>