<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‡ ä½•å›¾å½¢å±•ç¤ºæ¨¡æ¿ - Leafletç‰ˆ</title>

    <!-- APIå¯†é’¥é…ç½® - æœ¬åœ°æ–‡ä»¶ç¯å¢ƒä½¿ç”¨ç™¾åº¦åœ°å›¾ï¼ŒWebç¯å¢ƒä½¿ç”¨å¤©åœ°å›¾ -->
    <script>
        // ç™¾åº¦åœ°å›¾APIå¯†é’¥ï¼ˆæœ¬åœ°æ–‡ä»¶ç¯å¢ƒä½¿ç”¨ï¼‰
        const BAIDU_MAP_AK = 'vMMZdKUVyHa5p2m5GZl2w4sNlF0dwr52';
        // å¤©åœ°å›¾APIå¯†é’¥ï¼ˆWebç¯å¢ƒä½¿ç”¨ï¼‰
        const TIANDITU_MAP_TK = '9ed3674d01dd7c129ab38e3c38bf651a';
    </script>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

    <!-- å¤©åœ°å›¾ API -->
    <script>
        // åŠ¨æ€åŠ è½½å¤©åœ°å›¾APIï¼Œé¿å…document.write
        const tiandituScript = document.createElement('script');
        tiandituScript.src = 'https://api.tianditu.gov.cn/api?v=4.0&tk=' + TIANDITU_MAP_TK;
        tiandituScript.async = true;
        document.head.appendChild(tiandituScript);
    </script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Turf.js ç”¨äºå‡ ä½•è®¡ç®— -->
    <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

    <!-- WKTè§£æåº“ -->
    <script src="https://unpkg.com/wellknown@0.5.0/wellknown.js"></script>

    <!-- Leaflet Geometry Util for area calculation -->
    <script src="https://unpkg.com/leaflet-geometryutil@0.11.0/src/leaflet.geometryutil.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f0f0;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            width: 100%;
            height: 100vh;
            margin: 0;
            background: white;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            position: relative;
        }
        
        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: transparent;
            color: white;
            padding: 0;
            text-align: left;
            z-index: 1000;
            display: none;
        }
        
        .header.show {
            display: block;
        }
        
        .header h1 {
            font-size: 18px;
            margin: 0;
            display: inline-block;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 12px;
            margin: 0 0 0 20px;
            display: inline-block;
        }
        
        .main-content {
            position: relative;
            height: 100vh;
            width: 100%;
        }
        
        .left-panel {
            width: 350px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
            position: absolute;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 1001;
            transition: transform 0.3s ease;
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
        }
        
        .left-panel.collapsed {
            transform: translateX(-350px);
            z-index: 9999; /* ç¡®ä¿é¢æ¿åœ¨å›ºå®šæŒ‰é’®ä¹‹ä¸‹ */
        }
        
        .left-panel.collapsed .panel-toggle {
            left: 100%;
            display: none !important;
        }
        

        
        .toolbar {
            padding: 15px;
            background: white;
            border-bottom: 1px solid #e9ecef;
        }
        
        .toolbar h3 {
            margin-bottom: 10px;
            color: #495057;
            font-size: 16px;
        }
        
        .tool-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .tool-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            background: #6c757d;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .tool-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }
        
        .tool-btn.active {
            background: #007bff;
        }
        
        .wkt-input {
            flex: 1;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }
        
        .tab-container {
            margin-bottom: 15px;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 8px;
            padding: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s ease;
            font-size: 13px;
            font-weight: 500;
        }
        
        .tab.active {
            background: #007bff;
            color: white;
            box-shadow: 0 2px 4px rgba(0,123,255,0.3);
        }
        
        .tab-content {
            display: none;
            margin-top: 15px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
            font-size: 13px;
        }
        
        .input-group textarea {
            width: 100%;
            height: 80px;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            resize: vertical;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            transition: border-color 0.3s ease;
        }
        
        .input-group textarea:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .button-group {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            flex: 1;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #1e7e34;
            transform: translateY(-1px);
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-primary:disabled {
            background: #6c757d;
            border-color: #6c757d;
        }
        
        .btn-secondary:disabled {
            background: #6c757d;
            border-color: #6c757d;
        }
        
        .btn-warning:disabled {
            background: #6c757d;
            border-color: #6c757d;
            color: white;
        }
        
        .color-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 6px;
        }
        
        .color-picker {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #dee2e6;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .color-picker:hover {
            border-color: #007bff;
            transform: scale(1.1);
        }
        
        .color-label {
            font-size: 12px;
            color: #495057;
            font-weight: 500;
        }
        
        .map-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: #e9ecef;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        

        
        .header-toggle {
            position: fixed;
            top: 10px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            z-index: 1001;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }
        
        .header-toggle:hover {
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .panel-toggle-fixed {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: #007bff;
            color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
            z-index: 10000;
        }
        
        .panel-toggle-fixed:hover {
            background: #0056b3;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .map-control-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .map-control-btn:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .playback-player {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            z-index: 1000;
            width: 600px;
            max-width: 90vw;
            overflow: hidden;
        }
        
        .player-header {
            background: #007bff;
            color: white;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .player-title {
            font-size: 14px;
            font-weight: 500;
        }
        
        .player-close {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s ease;
        }
        
        .player-close:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .player-controls {
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .player-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: #007bff;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .player-btn:hover {
            background: #0056b3;
            transform: scale(1.05);
        }
        
        .player-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .player-speed {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 8px;
        }
        
        .player-speed label {
            font-size: 12px;
            color: #495057;
            font-weight: 500;
        }
        
        .player-speed input[type="range"] {
            width: 80px;
        }
        
        .player-speed span {
            font-size: 12px;
            color: #6c757d;
            min-width: 25px;
        }
        
        .player-progress {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 8px;
        }
        
        .player-progress input[type="range"] {
            flex: 1;
            height: 4px;
            border-radius: 2px;
            background: #e9ecef;
            outline: none;
            -webkit-appearance: none;
        }
        
        .player-progress input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #007bff;
            cursor: pointer;
        }
        
        .player-progress span {
            font-size: 12px;
            color: #495057;
            font-weight: 500;
            min-width: 80px;
        }
        
        .speed-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .speed-control label {
            font-size: 12px;
            color: #495057;
            font-weight: 500;
        }
        
        .speed-control input[type="range"] {
            width: 80px;
        }
        
        .speed-value {
            font-size: 12px;
            color: #6c757d;
            min-width: 30px;
        }
        
        .time-slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .time-slider {
            flex: 1;
            height: 4px;
            border-radius: 2px;
            background: #e9ecef;
            outline: none;
            -webkit-appearance: none;
        }
        
        .time-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #007bff;
            cursor: pointer;
        }
        
        .time-label {
            font-size: 11px;
            color: #495057;
            font-weight: 500;
            min-width: 120px;
        }
        
        .status-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px 15px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            font-size: 12px;
            color: #495057;
        }
        
        .measure-result {
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1001;
        }
        
        .coordinate-info {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            font-size: 11px;
            color: #495057;
        }
        
        .hidden {
            display: none !important;
        }
        
        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
                height: auto;
            }
            
            .left-panel {
                width: 100%;
                height: 400px;
            }
            
            .map-container {
                height: 500px;
            }
        }
        
        .area-label {
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            pointer-events: none;
            z-index: 1000; /* ç¡®ä¿æ ‡ç­¾åœ¨æœ€ä¸Šå±‚ */
        }
        
        /* é»˜è®¤éšè—æ ‡ç­¾å®¹å™¨ä¸‹çš„æ ‡ç­¾ */
        .labels-hidden .area-label { display: none; }

        /* å³é”®èœå•æ ·å¼ */
        .context-menu {
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 10000;
            min-width: 120px;
            display: none;
        }

        .context-menu-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 12px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }

        .context-menu-item:last-child {
            border-bottom: none;
        }

        .context-menu-item:hover {
            background-color: #f0f0f0;
        }

        .context-menu-item.disabled {
            color: #999;
            cursor: not-allowed;
        }

        .context-menu-item.disabled:hover {
            background-color: white;
        }

    </style>
</head>
<body>
<div class="container">
    <div class="main-content">
        <div class="left-panel">

            <div class="toolbar">
                <h3>ğŸ› ï¸ å·¥å…·æ </h3>
                <div class="tool-buttons">
                    <button class="tool-btn" id="measureDistanceBtn" title="æµ‹è·">ğŸ“ æµ‹è·</button>
                    <button class="tool-btn" id="measureAreaBtn" title="æµ‹é¢">ğŸ“ æµ‹é¢</button>
                    <button class="tool-btn" id="mapTypeBtn" title="åˆ‡æ¢åœ°å›¾">ğŸ—ºï¸ è¡—é“å›¾</button>
                    <button class="tool-btn" id="clearAllBtn" title="æ¸…ç©ºæ‰€æœ‰">ğŸ—‘ï¸ æ¸…ç©º</button>
                </div>
            </div>

            <div class="wkt-input">
                <div class="tab-container">
                    <div class="tabs">
                        <div class="tab active" data-tab="outline">è½®å»“</div>
                        <div class="tab" data-tab="track">è½¨è¿¹</div>
                    </div>

                    <div class="tab-content active" id="outline-tab">
                        <div class="input-group">
                            <textarea id="outlineWkt" style="height: 400px;"
                                      placeholder="è¾“å…¥å¤šè¾¹å½¢WKTï¼Œæ”¯æŒå¤šè¡Œè¾“å…¥ï¼Œæ¯è¡Œä¸€ä¸ªWKT">${outline}</textarea>
                        </div>
                        <div class="button-group">
                            <button class="btn btn-primary" onclick="drawOutline()">ğŸ¯ ç»˜åˆ¶è½®å»“</button>
                            <button class="btn btn-secondary" onclick="clearOutline()">ğŸ§¹ æ¸…é™¤è½®å»“</button>
                        </div>
                        <div class="input-group">
                            <label><input type="checkbox" id="toggleLabelsCheckbox"> æ˜¾ç¤ºäº©æ•°</label>
                        </div>
                    </div>

                    <div class="tab-content" id="track-tab">
                        <div class="time-range-settings" style="margin-bottom:8px;font-size:12px;color:#333;">
                            <label>æ—¶é—´èŒƒå›´é€‰å–(ç•™ç©ºåˆ™æ˜¾ç¤ºæ‰€æœ‰è½¨è¿¹)</label>
                            <input type="text" id="timeRangeInput"
                                   style="width:100%;margin-top:4px;padding:4px;border:1px solid #ddd;border-radius:4px;font-size:12px;"
                                   placeholder="æ ¼å¼ï¼šyyyy-MM-ddTHH:mm:ss - yyyy-MM-ddTHH:mm:ss">
                        </div>
                        <textarea id="trackTextarea"
                                  style="width:100%;height:400px;margin-bottom:10px;padding:8px;border:1px solid #ddd;border-radius:4px;font-family:monospace;resize:vertical;box-sizing:border-box;">${trace}</textarea>
                        <div class="button-group">
                            <button id="drawTrackButton" class="btn btn-primary">ğŸ¯ è½¨è¿¹</button>
                            <button id="showTrackPointsButton" class="btn btn-warning">ğŸ“ æ‰“ç‚¹</button>
                            <button id="clearTrackButton" class="btn btn-secondary">ğŸ§¹ æ¸…ç©º</button>
                        </div>
                        <!-- è½¨è¿¹é¢œè‰²é€‰æ‹©å™¨ -->
                        <div class="color-picker-container" style="margin-top:8px;">
                            <div style="display:flex;align-items:center;gap:8px;">
                                <div style="display:flex;align-items:center;gap:4px;">
                                    <label style="font-size:12px;">è½¨è¿¹çº¿é¢œè‰²:</label>
                                    <div id="trackLineColorPicker" class="color-picker"
                                         style="width:24px;height:24px;border:1px solid #ccc;cursor:pointer;background-color:#FF0000;"></div>
                                    <input type="color" id="trackLineColorInput" value="#FF0000" style="display:none;">
                                </div>
                                <div style="display:flex;align-items:center;gap:4px;">
                                    <label style="font-size:12px;">è½¨è¿¹ç‚¹é¢œè‰²:</label>
                                    <div id="trackPointColorPicker" class="color-picker"
                                         style="width:24px;height:24px;border:1px solid #ccc;cursor:pointer;background-color:#68EAF3;"></div>
                                    <input type="color" id="trackPointColorInput" value="#68EAF3" style="display:none;">
                                </div>
                            </div>
                        </div>
                        <!-- è½¨è¿¹å›æ”¾ -->
                        <div class="split-section" style="margin-top:8px;">
                            <div class="playback-actions" style="display:flex;gap:8px;margin-bottom:8px;">
                                <button id="playbackToggleBtn" class="btn btn-primary">â–¶ï¸ è½¨è¿¹å›æ”¾</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>

            <!-- å·¥å…·æ åˆ‡æ¢æŒ‰é’® -->
            <button class="panel-toggle-fixed" id="panelToggleFixed" title="å±•å¼€/æ”¶ç¼©å·¥å…·æ ">â—€â–¶</button>

            <div class="status-info" id="statusInfo" style="display: none;">
                å°±ç»ª
            </div>

            <div class="coordinate-info" id="coordinateInfo">
                ç»åº¦: -, çº¬åº¦: -
            </div>

            <!-- å³é”®èœå• -->
            <div class="context-menu" id="contextMenu">
                <div class="context-menu-item" id="getAddressMenuItem">ğŸ“ è·å–åœ°å€</div>
            </div>

            <!-- è½¨è¿¹å›æ”¾æ’­æ”¾å™¨ -->
            <div class="playback-player" id="playbackPlayer" style="display: none;">
                <div class="player-header">
                    <span class="player-title">è½¨è¿¹å›æ”¾</span>
                    <button class="player-close" id="playerCloseBtn" title="å…³é—­">âœ•</button>
                </div>
                <div class="player-controls">
                    <button class="player-btn" id="playerPlayBtn" title="æ’­æ”¾">â–¶ï¸</button>
                    <button class="player-btn" id="playerStopBtn" title="åœæ­¢">â¹ï¸</button>

                    <div class="player-speed">
                        <label>é€Ÿåº¦:</label>
                        <input type="range" id="playerSpeedSlider" min="1" max="2048" step="1" value="1">
                        <span id="playerSpeedValue">1x</span>
                    </div>

                    <div class="player-progress">
                        <input type="range" id="playerProgressSlider" min="0" max="100" value="0">
                        <div id="playerTimeLabel" style="display: flex; flex-direction: column; align-items: center; min-width: 80px;">
                            <div id="currentTime" style="font-size: 12px; line-height: 1.2;">00:00:00</div>
                            <div id="totalTime" style="font-size: 10px; line-height: 1.2; color: #666;">00:00:00</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // å…¨å±€å˜é‡
    let map;
    let currentMapType = 'street';
    let currentBaseLayer;
    let currentSatelliteLayer;

    // å›¾å±‚ç»„
    let outlineLayerGroup;
    let trackLayerGroup;
    let measureLayerGroup;
    let labelLayerGroup;

    // æ ‡ç­¾ç›¸å…³
    let labelsEnabled = false;

    // å½“å‰å‡ ä½•å›¾å½¢
    let currentOutline = null;
    let currentTrack = null;

    // è½¨è¿¹å›æ”¾ç›¸å…³
    let playbackState = {
        isPlaying: false,
        points: [],
        currentIndex: 0,
        speed: 1,
        marker: null,
        polyline: null,
        timer: null
    };

    // æ–°æ’­æ”¾å™¨å…ƒç´ 
    let playbackPlayer;
    let playerCloseBtn;
    let playerPlayBtn;
    let playerStopBtn;
    let playerSpeedSlider;
    let playerSpeedValue;
    let playerProgressSlider;
    let playerTimeLabel;

    // æµ‹é‡ç›¸å…³
    let measureState = {
        isActive: false,
        mode: '',
        points: [],
        tempLine: null,
        lines: [],
        markers: [],
        labels: [],
        polygon: null,
        areaLabel: null
    };

    // é¢œè‰²é…ç½®
    let currentOutlineColor = "#FFD700";
    let currentFillColor = "#FFFF00";
    let currentFillOpacity = 0.35;
    let currentTrackLineColor = "#FF0000";
    let currentTrackPointColor = "#68EAF3";

    // çŠ¶æ€ä¿¡æ¯å®šæ—¶å™¨
    let statusMessageTimer = null;

    // å³é”®èœå•ç›¸å…³
    let contextMenu = null;
    let getAddressMenuItem = null;
    let lastRightClickLatLng = null;

    // å¤šè¾¹å½¢é¢œè‰²æ–¹æ¡ˆ
    const polygonColors = [
        { outline: "#FFD700", fill: "#FFFF00", opacity: 0.35 },
        { outline: "#FF0000", fill: "#FF6666", opacity: 0.35 },
        { outline: "#00FF00", fill: "#66FF66", opacity: 0.35 },
        { outline: "#0000FF", fill: "#6666FF", opacity: 0.35 },
        { outline: "#FF00FF", fill: "#FF66FF", opacity: 0.35 },
        { outline: "#00FFFF", fill: "#66FFFF", opacity: 0.35 },
        { outline: "#FFA500", fill: "#FFCC66", opacity: 0.35 },
        { outline: "#800080", fill: "#CC66CC", opacity: 0.35 },
        { outline: "#008000", fill: "#66CC66", opacity: 0.35 },
        { outline: "#800000", fill: "#CC6666", opacity: 0.35 }
    ];

    // æ˜¾ç¤ºæ’­æ”¾å™¨
    function showPlaybackPlayer() {
        if (playbackPlayer) {
            playbackPlayer.style.display = 'block';
            updatePlayerControls();
            
            // åŒæ­¥æ—§ç‰ˆæ§åˆ¶é¢æ¿çŠ¶æ€ï¼Œä¿æŒå½“å‰æ’­æ”¾ä½ç½®
            if (playerProgressSlider && playbackState.points.length > 0) {
                playerProgressSlider.disabled = false;
                playerProgressSlider.max = 100;
                // ä¸é‡ç½®è¿›åº¦æ¡å€¼ï¼Œä¿æŒå½“å‰æ’­æ”¾ä½ç½®
                if (playbackState.points.length > 0 && playbackState.currentIndex >= 0) {
                    const percentage = Math.round((playbackState.currentIndex / (playbackState.points.length - 1)) * 100);
                    playerProgressSlider.value = percentage;
                }
            }
            if (playerTimeLabel && playbackState.points.length > 0) {
                // æ ¹æ®å½“å‰æ’­æ”¾ä½ç½®æ›´æ–°æ—¶é—´æ˜¾ç¤º
                if (playbackState.currentIndex >= 0 && playbackState.currentIndex < playbackState.points.length) {
                    const currentPoint = playbackState.points[playbackState.currentIndex];
                    const lastPoint = playbackState.points[playbackState.points.length - 1];
                    
                    if (currentPoint && lastPoint) {
                        function formatTime(timestamp) {
                            const date = parseTimestamp(timestamp);
                            if (!date) return '00:00:00';
                            
                            const hours = date.getHours().toString().padStart(2, '0');
                            const minutes = date.getMinutes().toString().padStart(2, '0');
                            const seconds = date.getSeconds().toString().padStart(2, '0');
                            return hours + ':' + minutes + ':' + seconds;
                        }
                        
                        const currentTime = formatTime(currentPoint.timestamp);
                        const totalTime = formatTime(lastPoint.timestamp);
                        
                        // åˆ†åˆ«æ›´æ–°ä¸¤è¡Œæ—¶é—´æ˜¾ç¤º
                        const currentTimeElement = document.getElementById('currentTime');
                        const totalTimeElement = document.getElementById('totalTime');
                        
                        if (currentTimeElement) currentTimeElement.textContent = currentTime;
                        if (totalTimeElement) totalTimeElement.textContent = totalTime;
                    }
                }
            }
        }
    }

    // éšè—æ’­æ”¾å™¨
    function hidePlaybackPlayer() {
        if (playbackPlayer) {
            playbackPlayer.style.display = 'none';
            // åªæš‚åœæ’­æ”¾ï¼Œä¸é‡ç½®è¿›åº¦
            if (playbackState.isPlaying) {
                pausePlayback();
            }
            
            // é‡ç½®æ’­æ”¾å™¨æ§åˆ¶çŠ¶æ€
            updatePlayerControls();
        }
    }

    // åˆ‡æ¢æ’­æ”¾çŠ¶æ€
    function togglePlayback() {
        if (playbackState.isPlaying) {
            pausePlayback();
        } else {
            startPlayback();
        }
        
        // æ›´æ–°æ’­æ”¾å™¨æ§åˆ¶çŠ¶æ€
        updatePlayerControls();
    }

    // æ›´æ–°æ’­æ”¾å™¨æ§åˆ¶çŠ¶æ€
    function updatePlayerControls() {
        const hasTrack = playbackState.points && playbackState.points.length > 0;
        
        if (playerPlayBtn) playerPlayBtn.disabled = !hasTrack;
        if (playerStopBtn) playerStopBtn.disabled = !hasTrack;
        if (playerSpeedSlider) playerSpeedSlider.disabled = !hasTrack;
        if (playerProgressSlider) playerProgressSlider.disabled = !hasTrack;
        
        if (playbackState.isPlaying) {
            if (playerPlayBtn) playerPlayBtn.innerHTML = 'â¸ï¸';
            if (playerPlayBtn) playerPlayBtn.title = 'æš‚åœ';
        } else {
            if (playerPlayBtn) playerPlayBtn.innerHTML = 'â–¶ï¸';
            if (playerPlayBtn) playerPlayBtn.title = 'æ’­æ”¾';
        }
    }

    // åˆå§‹åŒ–åœ°å›¾
    function initMap() {
        console.log('initMap called');

        // åˆ›å»ºåœ°å›¾
        map = L.map('map', {
            center: [39.9042, 116.4074], // åŒ—äº¬
            zoom: 11,
            zoomControl: false,
            attributionControl: false
        });

        console.log('Map created:', map);

        // ä¸æ·»åŠ ç¼©æ”¾æ§ä»¶ï¼Œä½¿ç”¨æ»šè½®ç¼©æ”¾åœ°å›¾

        // åˆå§‹åŒ–å›¾å±‚ç»„
        outlineLayerGroup = L.layerGroup().addTo(map);
        trackLayerGroup = L.layerGroup().addTo(map);
        measureLayerGroup = L.layerGroup().addTo(map);
        // å…ˆä¸æ·»åŠ æ ‡ç­¾å›¾å±‚ï¼Œç¨åç¡®ä¿å®ƒåœ¨æœ€ä¸Šå±‚
        labelLayerGroup = L.layerGroup();
        map.addLayer(labelLayerGroup);

        console.log('Layer groups created');

        // åˆå§‹åŒ–åœ°å›¾ç±»å‹
        currentMapType = 'satellite';

        // æ·»åŠ åŸºç¡€å›¾å±‚
        addBaseLayers();

        // ç»‘å®šäº‹ä»¶
        bindMapEvents();

        // æ›´æ–°çŠ¶æ€
        updateStatus('åœ°å›¾åˆå§‹åŒ–å®Œæˆ');

        console.log('initMap completed');

        // ç¡®ä¿æ ‡ç­¾å›¾å±‚åœ¨æœ€ä¸Šå±‚
        map.removeLayer(labelLayerGroup);
        map.addLayer(labelLayerGroup);

        // åˆå§‹åŒ–æ–°æ’­æ”¾å™¨å…ƒç´ 
        playbackPlayer = document.getElementById('playbackPlayer');
        playerCloseBtn = document.getElementById('playerCloseBtn');
        playerPlayBtn = document.getElementById('playerPlayBtn');
        playerStopBtn = document.getElementById('playerStopBtn');
        playerSpeedSlider = document.getElementById('playerSpeedSlider');
        playerSpeedValue = document.getElementById('playerSpeedValue');
        playerProgressSlider = document.getElementById('playerProgressSlider');
        playerTimeLabel = document.getElementById('playerTimeLabel');

        // åˆå§‹åŒ–é€Ÿåº¦æ˜¾ç¤º
        if (playerSpeedValue) {
            playerSpeedValue.textContent = '1x';
        }

        // åˆå§‹åŒ–æ’­æ”¾å™¨æŒ‰é’®çŠ¶æ€ï¼ˆä½¿ç”¨updatePlayerControlså‡½æ•°ï¼‰
        updatePlayerControls();
    }

    // æ·»åŠ åŸºç¡€å›¾å±‚
    function addBaseLayers() {
        console.log('addBaseLayers called');

        // å¤©åœ°å›¾è¡—é“å›¾
        const tk = "9ed3674d01dd7c129ab38e3c38bf651a";

        // å¤©åœ°å›¾è¡—é“å›¾ - ä½¿ç”¨XYZç“¦ç‰‡æœåŠ¡
        const vecLayer = L.tileLayer(`https://t{s}.tianditu.gov.cn/vec_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=vec&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`, {
            attribution: 'Â© å¤©åœ°å›¾',
            maxZoom: 18,
            tileSize: 256,
            subdomains: ['0', '1', '2', '3', '4', '5', '6', '7']
        });

        // å¤©åœ°å›¾è¡—é“å›¾æ ‡æ³¨
        const cvaLayer = L.tileLayer(`https://t{s}.tianditu.gov.cn/cva_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cva&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`, {
            attribution: 'Â© å¤©åœ°å›¾',
            maxZoom: 18,
            tileSize: 256,
            subdomains: ['0', '1', '2', '3', '4', '5', '6', '7']
        });

        // å¤©åœ°å›¾å«æ˜Ÿå›¾ - ä½¿ç”¨XYZç“¦ç‰‡æœåŠ¡
        const imgLayer = L.tileLayer(`https://t{s}.tianditu.gov.cn/img_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=img&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`, {
            attribution: 'Â© å¤©åœ°å›¾',
            maxZoom: 18,
            tileSize: 256,
            subdomains: ['0', '1', '2', '3', '4', '5', '6', '7']
        });

        // å¤©åœ°å›¾å«æ˜Ÿå›¾æ ‡æ³¨
        const ciaLayer = L.tileLayer(`https://t{s}.tianditu.gov.cn/cia_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cia&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`, {
            attribution: 'Â© å¤©åœ°å›¾',
            maxZoom: 18,
            tileSize: 256,
            subdomains: ['0', '1', '2', '3', '4', '5', '6', '7']
        });

        // æ·»åŠ å›¾å±‚åŠ è½½äº‹ä»¶ç›‘å¬
        vecLayer.on('load', function() {
            console.log('å¤©åœ°å›¾è¡—é“å›¾å±‚åŠ è½½å®Œæˆ');
            updateStatus('å¤©åœ°å›¾è¡—é“å›¾å±‚åŠ è½½å®Œæˆ');
        });

        imgLayer.on('load', function() {
            console.log('å¤©åœ°å›¾å«æ˜Ÿå›¾å±‚åŠ è½½å®Œæˆ');
            updateStatus('å¤©åœ°å›¾å«æ˜Ÿå›¾å±‚åŠ è½½å®Œæˆ');
        });

        vecLayer.on('error', function(e) {
            console.error('å¤©åœ°å›¾è¡—é“å›¾å±‚åŠ è½½é”™è¯¯:', e);
            updateStatus('å¤©åœ°å›¾è¡—é“å›¾å±‚åŠ è½½å¤±è´¥');
        });

        imgLayer.on('error', function(e) {
            console.error('å¤©åœ°å›¾å«æ˜Ÿå›¾å±‚åŠ è½½é”™è¯¯:', e);
            updateStatus('å¤©åœ°å›¾å«æ˜Ÿå›¾å±‚åŠ è½½å¤±è´¥');
        });

        // åˆ›å»ºå›¾å±‚ç»„
        currentBaseLayer = L.layerGroup([vecLayer, cvaLayer]);
        currentSatelliteLayer = L.layerGroup([imgLayer, ciaLayer]);

        console.log('currentBaseLayer created:', currentBaseLayer);
        console.log('currentSatelliteLayer created:', currentSatelliteLayer);

        // é»˜è®¤æ˜¾ç¤ºå«æ˜Ÿå›¾
        currentSatelliteLayer.addTo(map);

        console.log('Satellite layer added to map');
        console.log('currentMapType initialized to: satellite');
    }

    // ç»‘å®šåœ°å›¾äº‹ä»¶
    function bindMapEvents() {
        // é¼ æ ‡ç§»åŠ¨äº‹ä»¶ - æ›´æ–°åæ ‡æ˜¾ç¤º
        map.on('mousemove', function(e) {
            const lat = e.latlng.lat.toFixed(6);
            const lng = e.latlng.lng.toFixed(6);
            const coordinateInfo = document.getElementById('coordinateInfo');
            if (coordinateInfo) {
                coordinateInfo.textContent = `ç»åº¦: ${lng}, çº¬åº¦: ${lat}`;
            }
        });

        // å³é”®èœå•äº‹ä»¶
        map.on('contextmenu', function(e) {
            // å¦‚æœåœ¨æµ‹é‡æ¨¡å¼ä¸‹ï¼Œä¸æ˜¾ç¤ºå³é”®èœå•ï¼ˆè®©æµ‹é‡æ¨¡å¼çš„å³é”®å¤„ç†æ¥ç®¡ï¼‰
            if (measureState.isActive) {
                return;
            }

            // ä¿å­˜å³é”®ç‚¹å‡»çš„åæ ‡
            lastRightClickLatLng = e.latlng;

            // æ˜¾ç¤ºå³é”®èœå•
            showContextMenu(e.originalEvent);

            // é˜»æ­¢é»˜è®¤å³é”®èœå•
            if (e.originalEvent) {
                e.originalEvent.preventDefault();
                e.originalEvent.stopPropagation();
            }

            return false;
        });

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—å³é”®èœå•
        map.on('click', function() {
            hideContextMenu();
        });

        // åœ°å›¾æ§ä»¶äº‹ä»¶
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const resetViewBtn = document.getElementById('resetViewBtn');

        if (zoomInBtn) {
            zoomInBtn.addEventListener('click', function() {
                map.zoomIn();
            });
        }

        if (zoomOutBtn) {
            zoomOutBtn.addEventListener('click', function() {
                map.zoomOut();
            });
        }

        if (resetViewBtn) {
            resetViewBtn.addEventListener('click', function() {
                map.setView([39.9042, 116.4074], 11);
            });
        }
    }

    // çŠ¶æ€æ›´æ–°
    function updateStatus(message) {
        const statusInfo = document.getElementById('statusInfo');
        if (statusInfo) {
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (statusMessageTimer) {
                clearTimeout(statusMessageTimer);
                statusMessageTimer = null;
            }
            
            statusInfo.textContent = message;
            statusInfo.style.display = 'block';
            
            // è®¾ç½®æ–°çš„å®šæ—¶å™¨
            statusMessageTimer = setTimeout(() => {
                statusInfo.style.display = 'none';
                statusMessageTimer = null;
            }, 1000);
        }
    }

    // å³é”®èœå•åŠŸèƒ½å‡½æ•°
    function showContextMenu(event) {
        if (!contextMenu) {
            contextMenu = document.getElementById('contextMenu');
            getAddressMenuItem = document.getElementById('getAddressMenuItem');
            
            // ç»‘å®šèœå•é¡¹ç‚¹å‡»äº‹ä»¶
            if (getAddressMenuItem) {
                getAddressMenuItem.addEventListener('click', handleGetAddress);
            }
        }

        if (contextMenu && event) {
            // è®¾ç½®èœå•ä½ç½®
            contextMenu.style.left = event.pageX + 'px';
            contextMenu.style.top = event.pageY + 'px';
            contextMenu.style.display = 'block';
        }
    }

    function hideContextMenu() {
        if (contextMenu) {
            contextMenu.style.display = 'none';
        }
    }

    // å¤„ç†è·å–åœ°å€åŠŸèƒ½
    function handleGetAddress() {
        if (!lastRightClickLatLng) {
            updateStatus('æ²¡æœ‰æœ‰æ•ˆçš„åæ ‡ç‚¹');
            return;
        }

        const lat = lastRightClickLatLng.lat;
        const lng = lastRightClickLatLng.lng;

        // è°ƒç”¨å¤©åœ°å›¾é€†åœ°ç†ç¼–ç API
        getAddressFromTianDiTu(lat, lng);
        
        // éšè—å³é”®èœå•
        hideContextMenu();
    }

    // å¤©åœ°å›¾é€†åœ°ç†ç¼–ç 
    function getAddressFromTianDiTu(lat, lng) {
        // ä½¿ç”¨å¤©åœ°å›¾é€†åœ°ç†ç¼–ç APIï¼Œä½¿ç”¨åå°tk
        const tk = "9ed3674d01dd7c129ab38e3c38bf651a";
        const postStr = `{'lon':${lng},'lat':${lat},'ver':1}`;
        const url = `https://api.tianditu.gov.cn/geocoder?postStr=${postStr}&type=geocode&tk=${tk}`;

        console.log('è¯·æ±‚URL:', url);
        console.log('åæ ‡:', lat, lng);
        console.log('postStr:', postStr);
        updateStatus('æ­£åœ¨è·å–åœ°å€ä¿¡æ¯...');

        // åˆ¤æ–­æ˜¯å¦åœ¨æœ¬åœ°æ–‡ä»¶ç¯å¢ƒä¸­è¿è¡Œ
        const isLocalFile = window.location.protocol === 'file:';
        
        if (isLocalFile) {
            // æœ¬åœ°æ–‡ä»¶ç¯å¢ƒï¼šä½¿ç”¨JSONPæ–¹å¼
            console.log('æ£€æµ‹åˆ°æœ¬åœ°æ–‡ä»¶è®¿é—®ï¼Œä½¿ç”¨JSONPæ–¹å¼');
            tryJSONPApproach(lat, lng, tk);
        } else {
            // Webå®¹å™¨ç¯å¢ƒï¼šç›´æ¥å‘é€GETè¯·æ±‚
            console.log('Webå®¹å™¨ç¯å¢ƒï¼Œç›´æ¥å‘é€GETè¯·æ±‚');
            fetch(url)
            .then(response => {
                console.log('å“åº”çŠ¶æ€:', response.status, response.statusText);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('å“åº”æ•°æ®:', data);
                handleTiandituResponse(lat, lng, data);
            })
            .catch(error => {
                console.error('é€†åœ°ç†ç¼–ç è¯·æ±‚å¤±è´¥:', error);
                // å¤±è´¥åç›´æ¥ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆæ˜¾ç¤ºåæ ‡
                useFallbackAddress(lat, lng);
            });
        }
    }

    // ä¸“é—¨ä¸ºæœ¬åœ°æ–‡ä»¶ç¯å¢ƒè®¾è®¡çš„æ–¹æ¡ˆ
    function tryJSONPApproach(lat, lng, tk) {
        // æœ¬åœ°æ–‡ä»¶ç¯å¢ƒä½¿ç”¨ç™¾åº¦åœ°å›¾API - JSONPæ–¹å¼è·å–åœ°å€ä¿¡æ¯
        const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
        
        // ç™¾åº¦åœ°å›¾APIé…ç½® - ä½¿ç”¨é¡¶éƒ¨å®šä¹‰çš„å¸¸é‡
        const baiduAk = BAIDU_MAP_AK;
        const url = `https://api.map.baidu.com/reverse_geocoding/v3/?ak=${baiduAk}&extensions_poi=1&entire_poi=1&sort_strategy=distance&output=json&coordtype=wgs84ll&location=${lat},${lng}&callback=${callbackName}`;
        
        console.log('ç™¾åº¦åœ°å›¾JSONPè¯·æ±‚URL:', url);
        
        // åˆ›å»ºå…¨å±€å›è°ƒå‡½æ•°
        window[callbackName] = function(data) {
            console.log('ç™¾åº¦åœ°å›¾JSONPå“åº”æ•°æ®:', data);
            cleanup();
            
            if (data && data.status === 0 && data.result) {
                // å¤„ç†ç™¾åº¦åœ°å›¾å“åº”æ•°æ®ï¼Œè½¬æ¢ä¸ºå¤©åœ°å›¾æ ¼å¼
                const addressData = {
                    result: {
                        formatted_address: data.result.formatted_address || data.result.address
                    }
                };
                
                // å¦‚æœæœ‰POIä¿¡æ¯ï¼Œæ·»åŠ åˆ°åœ°å€ä¸­
                if (data.result.pois && data.result.pois.length > 0) {
                    const nearestPoi = data.result.pois[0];
                    addressData.result.formatted_address += ` (${nearestPoi.name})`;
                }
                
                handleTiandituResponse(lat, lng, addressData);
            } else {
                console.log('ç™¾åº¦åœ°å›¾JSONPè¿”å›æ•°æ®æ ¼å¼ä¸æ­£ç¡®æˆ–çŠ¶æ€é”™è¯¯ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ');
                useFallbackAddress(lat, lng);
            }
        };
        
        // åˆ›å»ºscriptæ ‡ç­¾
        const script = document.createElement('script');
        script.src = url;
        
        let timeoutId;
        
        function cleanup() {
            if (timeoutId) clearTimeout(timeoutId);
            if (window[callbackName]) delete window[callbackName];
            if (script.parentNode) document.body.removeChild(script);
        }
        
        script.onerror = function() {
            cleanup();
            console.log('ç™¾åº¦åœ°å›¾JSONPè¯·æ±‚å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ');
            useFallbackAddress(lat, lng);
        };
        
        // è®¾ç½®è¶…æ—¶
        timeoutId = setTimeout(() => {
            cleanup();
            console.log('ç™¾åº¦åœ°å›¾JSONPè¯·æ±‚è¶…æ—¶ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ');
            useFallbackAddress(lat, lng);
        }, 8000); // 8ç§’è¶…æ—¶
        
        document.body.appendChild(script);
    }

    // å¤„ç†å¤©åœ°å›¾APIå“åº”æ•°æ®
    function handleTiandituResponse(lat, lng, data) {
        if (data && data.result && data.result.formatted_address) {
            const address = data.result.formatted_address;
            showAddressLabel(lat, lng, address);
            updateStatus('åœ°å€è·å–æˆåŠŸ');
        } else if (data && data.msg) {
            updateStatus(`åœ°å€è·å–å¤±è´¥ï¼š${data.msg}`);
        } else {
            updateStatus('åœ°å€è·å–å¤±è´¥ï¼šæœªæ‰¾åˆ°åœ°å€ä¿¡æ¯');
        }
    }

    // æœ€ç»ˆå¤‡ç”¨æ–¹æ¡ˆï¼šæ˜¾ç¤ºåæ ‡ä¿¡æ¯
    function useFallbackAddress(lat, lng) {
        const fallbackAddress = `åæ ‡ä½ç½®ï¼š${lng.toFixed(6)}, ${lat.toFixed(6)}`;
        showAddressLabel(lat, lng, fallbackAddress);
        updateStatus('åœ°å€æœåŠ¡æš‚ä¸å¯ç”¨ï¼Œæ˜¾ç¤ºåæ ‡ä¿¡æ¯');
    }

    // æ˜¾ç¤ºåœ°å€æ ‡ç­¾
    function showAddressLabel(lat, lng, address) {
        // åˆ›å»ºåœ°å€æ ‡ç­¾
        const label = L.marker([lat, lng], {
            icon: L.divIcon({
                className: 'address-label',
                html: `<div style="background: white; border: 2px solid #007bff; border-radius: 6px; padding: 8px 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); font-size: 12px; max-width: 300px; word-wrap: break-word;">
                        <div style="font-weight: bold; color: #007bff; margin-bottom: 4px;">ğŸ“ åœ°å€ä¿¡æ¯</div>
                        <div style="color: #333;">${address}</div>
                        <div style="font-size: 10px; color: #666; margin-top: 4px;">
                            åæ ‡: ${lng.toFixed(6)}, ${lat.toFixed(6)}
                        </div>
                     </div>`,
                iconSize: [300, 'auto'],
                iconAnchor: [150, 0]
            })
        }).addTo(labelLayerGroup);

        // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œç‚¹å‡»å¯ä»¥åˆ é™¤æ ‡ç­¾
        label.on('click', function() {
            labelLayerGroup.removeLayer(label);
            updateStatus('åœ°å€æ ‡ç­¾å·²åˆ é™¤');
        });

        // 3ç§’åè‡ªåŠ¨éšè—æ ‡ç­¾
        setTimeout(() => {
            if (labelLayerGroup.hasLayer(label)) {
                labelLayerGroup.removeLayer(label);
            }
        }, 10000); // 10ç§’åè‡ªåŠ¨éšè—
    }

    // æ ‡ç­¾é¡µåˆ‡æ¢
    function bindTabEvents() {
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');

        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const targetTab = this.dataset.tab;

                // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));

                // æ·»åŠ æ´»åŠ¨çŠ¶æ€
                this.classList.add('active');
                document.getElementById(targetTab + '-tab').classList.add('active');
            });
        });
    }

    // é¢œè‰²é€‰æ‹©å™¨äº‹ä»¶
    function bindColorPickerEvents() {
        // è½¨è¿¹çº¿é¢œè‰²
        const trackLineColorPicker = document.getElementById('trackLineColorPicker');
        const trackLineColorInput = document.getElementById('trackLineColorInput');

        if (trackLineColorPicker && trackLineColorInput) {
            trackLineColorPicker.addEventListener('click', function() {
                trackLineColorInput.click();
            });

            trackLineColorInput.addEventListener('change', function() {
                currentTrackLineColor = this.value;
                trackLineColorPicker.style.backgroundColor = currentTrackLineColor;
            });
        }

        // è½¨è¿¹ç‚¹é¢œè‰²
        const trackPointColorPicker = document.getElementById('trackPointColorPicker');
        const trackPointColorInput = document.getElementById('trackPointColorInput');

        if (trackPointColorPicker && trackPointColorInput) {
            trackPointColorPicker.addEventListener('click', function() {
                trackPointColorInput.click();
            });

            trackPointColorInput.addEventListener('change', function() {
                currentTrackPointColor = this.value;
                trackPointColorPicker.style.backgroundColor = currentTrackPointColor;
            });
        }
    }

    // å·¥å…·æŒ‰é’®äº‹ä»¶
    function bindToolEvents() {
        // æµ‹è·æŒ‰é’®
        const measureDistanceBtn = document.getElementById('measureDistanceBtn');
        if (measureDistanceBtn) {
            measureDistanceBtn.addEventListener('click', startMeasureDistance);
        }

        // æµ‹é¢æŒ‰é’®
        const measureAreaBtn = document.getElementById('measureAreaBtn');
        if (measureAreaBtn) {
            measureAreaBtn.addEventListener('click', startMeasureArea);
        }

        // åœ°å›¾ç±»å‹åˆ‡æ¢
        const mapTypeBtn = document.getElementById('mapTypeBtn');
        if (mapTypeBtn) {
            mapTypeBtn.addEventListener('click', toggleMapType);
        }

        // æ¸…ç©ºæ‰€æœ‰
        const clearAllBtn = document.getElementById('clearAllBtn');
        if (clearAllBtn) {
            clearAllBtn.addEventListener('click', clearAll);
        }

        // è½¨è¿¹ç›¸å…³æŒ‰é’®
        const drawTrackBtn = document.getElementById('drawTrackButton');
        const showTrackPointsBtn = document.getElementById('showTrackPointsButton');
        const clearTrackBtn = document.getElementById('clearTrackButton');

        if (drawTrackBtn) drawTrackBtn.addEventListener('click', drawTrack);
        if (showTrackPointsBtn) showTrackPointsBtn.addEventListener('click', showTrackPoints);
        if (clearTrackBtn) clearTrackBtn.addEventListener('click', clearTrack);

        // è½¨è¿¹å›æ”¾åˆ‡æ¢æŒ‰é’® - å§‹ç»ˆå¯ç‚¹å‡»ï¼Œç‚¹å‡»æ—¶è¿›è¡Œåˆå§‹åŒ–æ£€æŸ¥
        const playbackToggleBtn = document.getElementById('playbackToggleBtn');
        if (playbackToggleBtn) {
            // ç§»é™¤disabledå±æ€§ï¼Œä½¿æŒ‰é’®å§‹ç»ˆå¯ç‚¹å‡»
            playbackToggleBtn.disabled = false;
            
            playbackToggleBtn.addEventListener('click', function() {
                // å¦‚æœæ’­æ”¾å™¨å·²æ˜¾ç¤ºï¼Œåˆ™éšè—
                if (playbackPlayer.style.display === 'block') {
                    hidePlaybackPlayer();
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰è½¨è¿¹æ•°æ®
                if (!playbackState.points || playbackState.points.length === 0) {
                    // å°è¯•ä»textareaè§£æè½¨è¿¹æ•°æ®
                    const trackTextarea = document.getElementById('trackTextarea');
                    if (trackTextarea && trackTextarea.value.trim()) {
                        try {
                            parseTrackPoints(trackTextarea.value.trim());
                        } catch (e) {
                            updateStatus('è½¨è¿¹æ•°æ®æ ¼å¼é”™è¯¯ï¼Œæ— æ³•æ‰“å¼€æ’­æ”¾å™¨');
                            return;
                        }
                    }
                }
                
                // å†æ¬¡æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆè½¨è¿¹æ•°æ®
                if (!playbackState.points || playbackState.points.length === 0) {
                    updateStatus('æ²¡æœ‰æœ‰æ•ˆçš„è½¨è¿¹æ•°æ®ï¼Œæ— æ³•æ‰“å¼€æ’­æ”¾å™¨');
                    return;
                }
                
                // æ˜¾ç¤ºæ’­æ”¾å™¨
                showPlaybackPlayer();
            });
        }

        // æ–°æ’­æ”¾å™¨æ§åˆ¶äº‹ä»¶
        if (playerCloseBtn) playerCloseBtn.addEventListener('click', hidePlaybackPlayer);
        if (playerPlayBtn) playerPlayBtn.addEventListener('click', togglePlayback);

        if (playerStopBtn) playerStopBtn.addEventListener('click', stopPlayback);
        
        // åˆå§‹åŒ–æ’­æ”¾å™¨æŒ‰é’®çŠ¶æ€
        updatePlayerControls();
        
        // é€Ÿåº¦æ»‘å—
        if (playerSpeedSlider) {
            playerSpeedSlider.addEventListener('input', function() {
                // å°†æ»‘å—å€¼è½¬æ¢ä¸ºæŒ‡æ•°å€æ•°ï¼š1,2,4,8,16,32,64,128,256,512,1024
                const sliderValue = parseInt(this.value);
                let speed;
                
                if (sliderValue === 1) {
                    speed = 1;
                } else {
                    // è®¡ç®—2çš„å¹‚æ¬¡ï¼š2^0=1, 2^1=2, 2^2=4, ..., 2^10=1024
                    const power = Math.floor(Math.log2(sliderValue));
                    speed = Math.pow(2, power);
                }
                
                // é™åˆ¶æœ€å¤§å€¼
                speed = Math.min(speed, 1024);
                
                // ç¡®ä¿æ˜¯2çš„å¹‚æ¬¡å€æ•°ï¼š1,2,4,8,16,32,64,128,256,512,1024
                const validSpeeds = [1, 2, 4, 8, 16, 32, 64, 128, 256, 512, 1024];
                speed = validSpeeds.find(s => s >= speed) || 1024;
                
                playbackState.speed = speed;
                if (playerSpeedValue) playerSpeedValue.textContent = speed + 'x';
                
                // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œåº”ç”¨æ–°é€Ÿåº¦ï¼ˆä¿æŒå½“å‰ä½ç½®ç»§ç»­æ’­æ”¾ï¼‰
                if (playbackState.isPlaying) {
                    // ä¸éœ€è¦æš‚åœå’Œé‡æ–°å¼€å§‹ï¼Œé€Ÿåº¦ä¼šåœ¨ä¸‹ä¸€ä¸ªç‚¹è‡ªåŠ¨åº”ç”¨
                    updateStatus(`æ’­æ”¾é€Ÿåº¦å·²è°ƒæ•´ä¸º ${speed}x`);
                }
            });
        }
        
        // è¿›åº¦æ»‘å—
        if (playerProgressSlider) {
            playerProgressSlider.addEventListener('input', function() {
                const percentage = parseInt(this.value);
                if (playbackState.points && playbackState.points.length > 0) {
                    const index = Math.floor((percentage / 100) * (playbackState.points.length - 1));
                    const wasPlaying = playbackState.isPlaying; // è®°å½•æ’­æ”¾çŠ¶æ€
                    jumpToPoint(index);
                    // å¦‚æœä¹‹å‰åœ¨æ’­æ”¾ï¼Œç»§ç»­æ’­æ”¾
                    if (wasPlaying) {
                        setTimeout(() => {
                            playbackState.isPlaying = true;
                            playbackNextPoint();
                        }, 100);
                    }
                }
            });
        }

        // è½¨è¿¹æ–‡æœ¬æ¡†äº‹ä»¶ç›‘å¬ - æ ¹æ®å†…å®¹å¯ç”¨/ç¦ç”¨æŒ‰é’®
        const trackTextarea = document.getElementById('trackTextarea');
        if (trackTextarea) {
            function updateTrackButtons() {
                const hasContent = trackTextarea.value.trim().length > 0;
                if (drawTrackBtn) drawTrackBtn.disabled = !hasContent;
                if (showTrackPointsBtn) showTrackPointsBtn.disabled = !hasContent;
                if (clearTrackBtn) clearTrackBtn.disabled = !hasContent;
                
                // å¦‚æœæœ‰è½¨è¿¹å†…å®¹ï¼Œå°è¯•è‡ªåŠ¨è§£æä»¥å¯ç”¨æ’­æ”¾æŒ‰é’®
                if (hasContent) {
                    try {
                        const trackText = trackTextarea.value.trim();
                        const lines = trackText.split('\n');
                        let hasValidTrackData = false;
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„è½¨è¿¹æ•°æ®æ ¼å¼
                        for (let line of lines) {
                            line = line.trim();
                            if (!line) continue;
                            
                            const parts = line.split(',');
                            if (parts.length >= 3) {
                                // æ£€æŸ¥ä¸¤ç§æ ¼å¼ï¼šç»åº¦,çº¬åº¦,æ—¶é—´æˆ³ æˆ– æ—¶é—´æˆ³,ç»åº¦,çº¬åº¦
                                const part1 = parts[0].trim();
                                const part2 = parts[1].trim();
                                const part3 = parts[2].trim();
                                
                                // å¦‚æœæ˜¯æœ‰æ•ˆçš„æ•°å­—æ ¼å¼ï¼Œåˆ™è®¤ä¸ºæœ‰æœ‰æ•ˆè½¨è¿¹æ•°æ®
                                if ((!isNaN(part1) && !isNaN(part2) && part3) || 
                                    (!isNaN(part2) && !isNaN(part3) && part1)) {
                                    hasValidTrackData = true;
                                    break;
                                }
                            }
                        }
                        
                        // æ’­æ”¾æŒ‰é’®ç°åœ¨å§‹ç»ˆå¯ç‚¹å‡»ï¼Œä¸éœ€è¦æ ¹æ®è§£æç»“æœå¯ç”¨/ç¦ç”¨
                        // å¦‚æœæ‰¾åˆ°æœ‰æ•ˆæ•°æ®ï¼Œè‡ªåŠ¨è§£æåˆ°playbackState
                        if (hasValidTrackData) {
                            const points = [];
                            lines.forEach(line => {
                                line = line.trim();
                                if (!line) return;
                                
                                const parts = line.split(',');
                                if (parts.length >= 3) {
                                    let lng, lat, timestamp;
                                    
                                    // åˆ¤æ–­æ ¼å¼
                                    if (parts[0].trim().length > 10 && !isNaN(parts[0].trim())) {
                                        // æ ¼å¼ï¼šæ—¶é—´æˆ³,ç»åº¦,çº¬åº¦
                                        timestamp = parts[0].trim();
                                        lng = parseFloat(parts[1].trim());
                                        lat = parseFloat(parts[2].trim());
                                    } else {
                                        // æ ¼å¼ï¼šç»åº¦,çº¬åº¦,æ—¶é—´æˆ³
                                        lng = parseFloat(parts[0].trim());
                                        lat = parseFloat(parts[1].trim());
                                        timestamp = parts[2].trim();
                                    }
                                    
                                    if (!isNaN(lng) && !isNaN(lat) && timestamp) {
                                        points.push({
                                            lat: lat,
                                            lng: lng,
                                            timestamp: timestamp
                                        });
                                    }
                                }
                            });
                            
                            // ä¿å­˜è§£æçš„è½¨è¿¹ç‚¹
                            if (points.length > 0) {
                                playbackState.points = points;
                            }
                        }
                        
                    } catch (e) {
                        // è§£æå¤±è´¥æ—¶ï¼Œæ¸…ç©ºè½¨è¿¹ç‚¹
                        playbackState.points = [];
                    }
                } else {
                    // æ²¡æœ‰å†…å®¹æ—¶ï¼Œæ¸…ç©ºè½¨è¿¹ç‚¹
                    playbackState.points = [];
                }
            }
            
            // åˆå§‹çŠ¶æ€
            updateTrackButtons();
            
            // ç›‘å¬è¾“å…¥äº‹ä»¶
            trackTextarea.addEventListener('input', updateTrackButtons);
            trackTextarea.addEventListener('change', updateTrackButtons);
        }
    }

    // è½®å»“ç»˜åˆ¶å‡½æ•°
    function drawOutline() {
        const wktText = document.getElementById('outlineWkt').value.trim();
        if (!wktText) {
            alert('è¯·è¾“å…¥WKTæ•°æ®');
            return;
        }

        clearOutline();

        try {
            // æ£€æŸ¥æ˜¯å¦ä¸ºå¤šè¡ŒWKT
            const wktLines = wktText.split('\n').filter(line => line.trim());
            let polygonData = [];

            if (wktLines.length === 1) {
                // å•è¡ŒWKT - ä½¿ç”¨åŸå§‹é€»è¾‘
                const geojson = wellknown.parse(wktLines[0].trim());
                if (geojson.type === "Polygon") {
                    polygonData.push({ index: 1, geojson: geojson, colorIndex: 0 });
                } else if (geojson.type === "MultiPolygon") {
                    geojson.coordinates.forEach((polygon, index) => {
                        // å°†MultiPolygonçš„æ¯ä¸ªå­å¤šè¾¹å½¢è½¬æ¢ä¸ºå•ç‹¬çš„Polygon
                        const singlePolygon = {
                            type: "Polygon",
                            coordinates: polygon
                        };
                        polygonData.push({ index: index + 1, geojson: singlePolygon, colorIndex: index });
                    });
                }
            } else {
                // å¤šè¡ŒWKT - æ¯è¡Œä¸€ä¸ªå¤šè¾¹å½¢
                wktLines.forEach((line, index) => {
                    if (line.trim()) {
                        try {
                            const geojson = wellknown.parse(line.trim());
                            if (geojson.type === "Polygon") {
                                polygonData.push({ index: index + 1, geojson: geojson, colorIndex: index });
                            } else if (geojson.type === "MultiPolygon") {
                                // å¦‚æœä¸€è¡Œæ˜¯MultiPolygonï¼Œæ‹†åˆ†æˆå¤šä¸ªPolygon
                                geojson.coordinates.forEach((polygon, subIndex) => {
                                    const singlePolygon = {
                                        type: "Polygon",
                                        coordinates: polygon
                                    };
                                    polygonData.push({
                                        index: index + 1 + subIndex * 0.1,
                                        geojson: singlePolygon,
                                        colorIndex: index
                                    });
                                });
                            }
                        } catch (e) {
                            console.warn(`ç¬¬${index + 1}è¡ŒWKTè§£æå¤±è´¥:`, e);
                        }
                    }
                });
            }

            // ä¸ºæ¯ä¸ªå¤šè¾¹å½¢åˆ›å»ºå›¾å±‚
            polygonData.forEach((data, idx) => {
                const colorScheme = polygonColors[data.colorIndex % polygonColors.length];
                const style = {
                    color: colorScheme.outline,
                    weight: 1,
                    opacity: 1,
                    fillColor: colorScheme.fill,
                    fillOpacity: colorScheme.opacity
                };

                const polygonLayer = L.geoJSON(data.geojson, {
                    style: style
                });

                outlineLayerGroup.addLayer(polygonLayer);

                // è®¡ç®—é¢ç§¯å¹¶æ·»åŠ äº©æ•°æ ‡ç­¾
                if (typeof L !== 'undefined' && typeof L.GeometryUtil !== 'undefined' && typeof L.GeometryUtil.geodesicArea === 'function') {
                    try {
                        // è·å–å›¾å±‚ä¸­çš„è¦ç´ è¿›è¡Œé¢ç§¯è®¡ç®—
                        let layers = [];

                        // å¦‚æœpolygonLayeræ˜¯LayerGroupæˆ–FeatureGroupï¼Œè·å–å…¶æ‰€æœ‰å­å›¾å±‚
                        if (polygonLayer instanceof L.LayerGroup || polygonLayer instanceof L.FeatureGroup) {
                            layers = polygonLayer.getLayers();
                        } else {
                            // å¯¹äºå…¶ä»–ç±»å‹çš„å›¾å±‚ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰getLayersæ–¹æ³•
                            layers = polygonLayer.getLayers ? polygonLayer.getLayers() : [polygonLayer];
                        }

                        if (layers && Array.isArray(layers) && layers.length > 0) {
                            for (let j = 0; j < layers.length; j++) {
                                const layer = layers[j];
                                let latLngs;

                                // æ ¹æ®å›¾å±‚ç±»å‹è·å–åæ ‡
                                if (layer && typeof layer.getLatLngs === 'function') {
                                    if (layer instanceof L.Polygon) {
                                        latLngs = layer.getLatLngs();
                                    } else if (layer instanceof L.MultiPolygon) {
                                        // å¯¹äºMultiPolygonï¼Œå–ç¬¬ä¸€ä¸ªå¤šè¾¹å½¢
                                        const multiLatLngs = layer.getLatLngs();
                                        if (multiLatLngs && Array.isArray(multiLatLngs) && multiLatLngs.length > 0) {
                                            latLngs = multiLatLngs[0];
                                        }
                                    }

                                    if (latLngs) {
                                        // å¤„ç†latLngsæ ¼å¼ï¼Œç¡®ä¿æ­£ç¡®è®¡ç®—é¢ç§¯
                                        let areaLatLngs = latLngs;
                                        if (Array.isArray(latLngs) && latLngs.length > 0) {
                                            areaLatLngs = latLngs[0] || latLngs;
                                        }

                                        let areaSqM, areaMu;
                                        if (typeof L.GeometryUtil !== 'undefined' && typeof L.GeometryUtil.geodesicArea === 'function') {
                                            areaSqM = L.GeometryUtil.geodesicArea(areaLatLngs);
                                            areaMu = (areaSqM / 666.6667).toFixed(4); // è½¬æ¢ä¸ºäº©
                                            console.log('ä½¿ç”¨L.GeometryUtilè®¡ç®—å¤šè¾¹å½¢é¢ç§¯:', areaSqM, 'å¹³æ–¹ç±³ (', areaMu, 'äº©)');
                                        } else if (typeof turf !== 'undefined') {
                                            // ä½¿ç”¨Turf.jsä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
                                            try {
                                                // å¤„ç†å¤šè¾¹å½¢åæ ‡ï¼Œæ”¯æŒå¤–éƒ¨è¾¹ç•Œå’Œå†…éƒ¨å­”æ´
                                                const processPolygon = (polyCoords) => {
                                                    if (!Array.isArray(polyCoords) || polyCoords.length === 0) {
                                                        return null;
                                                    }

                                                    // å¦‚æœæ˜¯å¤šè¾¹å½¢æ•°ç»„ï¼ˆå¤–éƒ¨è¾¹ç•Œ+å­”æ´ï¼‰ï¼Œåˆ†åˆ«å¤„ç†
                                                    let processedCoords = [];

                                                    // å¤„ç†å¤šè¾¹å½¢çš„æ¯ä¸ªç¯ï¼ˆç¬¬ä¸€ä¸ªæ˜¯å¤–éƒ¨è¾¹ç•Œï¼Œå…¶ä½™æ˜¯å­”æ´ï¼‰
                                                    for (let i = 0; i < polyCoords.length; i++) {
                                                        let ring = polyCoords[i];
                                                        if (!Array.isArray(ring)) {
                                                            ring = [ring]; // å¦‚æœä¸æ˜¯æ•°ç»„ï¼Œè½¬æ¢ä¸ºæ•°ç»„
                                                        }

                                                        // å°†Leafletåæ ‡è½¬æ¢ä¸ºGeoJSONæ ¼å¼ [lng, lat]
                                                        let geoJsonRing = ring.map(latLng => {
                                                            if (latLng.lat !== undefined && latLng.lng !== undefined) {
                                                                return [latLng.lng, latLng.lat];
                                                            } else if (Array.isArray(latLng) && latLng.length >= 2) {
                                                                // å¦‚æœå·²ç»æ˜¯æ•°ç»„æ ¼å¼ [lat, lng] æˆ– [lng, lat]
                                                                return [latLng[1], latLng[0]]; // å‡è®¾æ˜¯ [lat, lng] æ ¼å¼
                                                            }
                                                            return null;
                                                        }).filter(coord => coord !== null);

                                                        // ç¡®ä¿ç¯æ˜¯é—­åˆçš„ï¼ˆè‡³å°‘æœ‰4ä¸ªç‚¹ï¼Œé¦–å°¾ç›¸åŒï¼‰
                                                        if (geoJsonRing.length >= 3) {
                                                            // å¦‚æœé¦–å°¾ä¸ç›¸åŒï¼Œé—­åˆç¯
                                                            if (geoJsonRing[0][0] !== geoJsonRing[geoJsonRing.length - 1][0] ||
                                                                geoJsonRing[0][1] !== geoJsonRing[geoJsonRing.length - 1][1]) {
                                                                geoJsonRing.push(geoJsonRing[0]);
                                                            }

                                                            // ç¡®ä¿è‡³å°‘æœ‰4ä¸ªç‚¹ï¼ˆé—­åˆåï¼‰
                                                            if (geoJsonRing.length < 4) {
                                                                // å¦‚æœç‚¹æ•°ä¸è¶³4ä¸ªï¼Œå¤åˆ¶ç‚¹ç›´åˆ°è¾¾åˆ°4ä¸ª
                                                                while (geoJsonRing.length < 4) {
                                                                    geoJsonRing.push(geoJsonRing[geoJsonRing.length - 1]);
                                                                }
                                                            }
                                                        } else if (geoJsonRing.length === 2) {
                                                            // å¦‚æœåªæœ‰2ä¸ªç‚¹ï¼Œå¤åˆ¶å®ƒä»¬å½¢æˆè‡³å°‘4ä¸ªç‚¹çš„ç¯
                                                            geoJsonRing.push(geoJsonRing[1]);
                                                            geoJsonRing.push(geoJsonRing[0]);
                                                        } else if (geoJsonRing.length === 1) {
                                                            // å¦‚æœåªæœ‰1ä¸ªç‚¹ï¼Œå¤åˆ¶3æ¬¡å½¢æˆ4ä¸ªç‚¹çš„ç¯
                                                            for (let k = 0; k < 3; k++) {
                                                                geoJsonRing.push(geoJsonRing[0]);
                                                            }
                                                        }

                                                        processedCoords.push(geoJsonRing);
                                                    }

                                                    return processedCoords;
                                                };

                                                // æ ¹æ®areaLatLngsçš„ç»“æ„å¤„ç†åæ ‡
                                                let coordinates;
                                                if (Array.isArray(areaLatLngs) && areaLatLngs.length > 0) {
                                                    if (Array.isArray(areaLatLngs[0])) {
                                                        // å¦‚æœæ˜¯å¤šè¾¹å½¢æ•°ç»„ï¼ˆåŒ…å«å¤–éƒ¨è¾¹ç•Œå’Œå­”æ´ï¼‰
                                                        coordinates = processPolygon(areaLatLngs);
                                                    } else {
                                                        // å¦‚æœæ˜¯å•ä¸ªå¤šè¾¹å½¢è¾¹ç•Œ
                                                        coordinates = processPolygon([areaLatLngs]);
                                                    }
                                                } else {
                                                    // å•ä¸ªå¤šè¾¹å½¢è¾¹ç•Œ
                                                    coordinates = processPolygon([areaLatLngs]);
                                                }

                                                if (coordinates && coordinates.length > 0) {
                                                    const polygon = turf.polygon(coordinates);
                                                    areaSqM = turf.area(polygon);
                                                    areaMu = (areaSqM / 666.6667).toFixed(4); // è½¬æ¢ä¸ºäº©
                                                    console.log('ä½¿ç”¨Turf.jsè®¡ç®—å¤šè¾¹å½¢é¢ç§¯:', areaSqM, 'å¹³æ–¹ç±³ (', areaMu, 'äº©)');
                                                } else {
                                                    console.log('æ— æ³•å¤„ç†åæ ‡æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤é¢ç§¯');
                                                    areaSqM = 0;
                                                    areaMu = '0.0000';
                                                }
                                            } catch (e) {
                                                console.error('ä½¿ç”¨Turf.jsè®¡ç®—é¢ç§¯æ—¶å‡ºé”™:', e);
                                                areaSqM = 0;
                                                areaMu = '0.0000';
                                            }
                                        } else {
                                            console.error('L.GeometryUtilå’ŒTurf.jséƒ½ä¸å¯ç”¨ï¼Œæ— æ³•è®¡ç®—é¢ç§¯');
                                            areaSqM = 0;
                                            areaMu = '0.0000';
                                        }

                                        console.log('è®¡ç®—å¤šè¾¹å½¢é¢ç§¯:', areaSqM, 'å¹³æ–¹ç±³ (', areaMu, 'äº©)');

                                        // å¦‚æœæ ‡ç­¾å·²å¯ç”¨ï¼Œåˆ™æ·»åŠ é¢ç§¯æ ‡ç­¾
                                        if (labelsEnabled) {
                                            console.log('æ ‡ç­¾å·²å¯ç”¨ï¼Œä¸ºå¤šè¾¹å½¢æ·»åŠ é¢ç§¯æ ‡ç­¾');
                                            addAreaLabelToLayer(polygonLayer, `é¢ç§¯: ${areaMu}äº©`);
                                            console.log('å½“å‰æ ‡ç­¾å›¾å±‚ä¸­çš„å›¾å±‚æ•°é‡:', labelLayerGroup.getLayers().length);
                                        } else {
                                            console.log('æ ‡ç­¾æœªå¯ç”¨ï¼Œä¸æ·»åŠ é¢ç§¯æ ‡ç­¾');
                                        }
                                        break; // åªå¤„ç†ç¬¬ä¸€ä¸ªæœ‰æ•ˆçš„å›¾å±‚æ¥è®¡ç®—é¢ç§¯
                                    }
                                }
                            }
                        }
                    } catch (areaError) {
                        console.warn('é¢ç§¯è®¡ç®—é”™è¯¯:', areaError);
                    }
                }
            });

            // è‡ªé€‚åº”è§†é‡
            if (outlineLayerGroup && outlineLayerGroup.getLayers && outlineLayerGroup.getLayers().length > 0) {
                // è®¡ç®—æ‰€æœ‰å­å›¾å±‚çš„æ•´ä½“è¾¹ç•Œ
                const layers = outlineLayerGroup.getLayers();
                let groupBounds = null;

                for (let i = 0; i < layers.length; i++) {
                    const layer = layers[i];
                    let layerBounds;

                    // æ£€æŸ¥å›¾å±‚æ˜¯å¦ä¸ºLayerGroupæˆ–FeatureGroup
                    if (layer instanceof L.LayerGroup || layer instanceof L.FeatureGroup) {
                        try {
                            layerBounds = layer.getBounds();
                        } catch (e) {
                            // å¦‚æœLayerGroup/FeatureGroupæ²¡æœ‰getBoundsæ–¹æ³•ï¼Œéå†å…¶å­å›¾å±‚
                            const subLayers = layer.getLayers();
                            for (let j = 0; j < subLayers.length; j++) {
                                try {
                                    const subLayerBounds = subLayers[j].getBounds();
                                    if (subLayerBounds && subLayerBounds.isValid && subLayerBounds.isValid()) {
                                        if (!groupBounds) {
                                            groupBounds = subLayerBounds;
                                        } else {
                                            groupBounds.extend(subLayerBounds);
                                        }
                                    }
                                } catch (e) {
                                    continue;
                                }
                            }
                            continue; // ç»§ç»­å¤–å±‚å¾ªç¯
                        }
                    } else {
                        try {
                            layerBounds = layer.getBounds();
                        } catch (e) {
                            continue; // å°è¯•ä¸‹ä¸€ä¸ªå›¾å±‚
                        }
                    }

                    if (layerBounds && layerBounds.isValid && layerBounds.isValid()) {
                        if (!groupBounds) {
                            groupBounds = layerBounds;
                        } else {
                            groupBounds.extend(layerBounds);
                        }
                    }
                }

                if (groupBounds && groupBounds.isValid && groupBounds.isValid()) {
                    map.fitBounds(groupBounds, { padding: [20, 20] });
                }
            }

            updateStatus(`è½®å»“ç»˜åˆ¶å®Œæˆï¼Œå…±${polygonData.length}ä¸ªå¤šè¾¹å½¢`);

        } catch (error) {
            console.error('WKTè§£æé”™è¯¯:', error);
            updateStatus('WKTè§£æå¤±è´¥: ' + error.message);
        }
    }

    // æ¸…é™¤è½®å»“
    function clearOutline() {
        outlineLayerGroup.clearLayers();
        currentOutline = null;
        updateStatus('è½®å»“å·²æ¸…é™¤');
    }

    // ä¸ºå›¾å±‚æ·»åŠ æ ‡ç­¾
    function addLabelsToLayer(layer, prefix) {
        try {
            // å¦‚æœlayeræ˜¯LayerGroupæˆ–FeatureGroupï¼Œéœ€è¦è·å–å…¶ä¸­çš„ç¬¬ä¸€ä¸ªå›¾å±‚æ¥è·å–è¾¹ç•Œ
            let bounds;
            if (layer instanceof L.LayerGroup || layer instanceof L.FeatureGroup) {
                const layers = layer.getLayers();
                if (layers && layers.length > 0) {
                    // éå†æ‰€æœ‰å­å›¾å±‚æ¥è·å–æœ‰æ•ˆçš„è¾¹ç•Œ
                    for (let i = 0; i < layers.length; i++) {
                        try {
                            const subLayer = layers[i];
                            let subLayerBounds;

                            // æ£€æŸ¥å­å›¾å±‚æ˜¯å¦ä¸ºLayerGroupæˆ–FeatureGroup
                            if (subLayer instanceof L.LayerGroup || subLayer instanceof L.FeatureGroup) {
                                // é€’å½’å¤„ç†åµŒå¥—çš„LayerGroupæˆ–FeatureGroup
                                const subSubLayers = subLayer.getLayers();
                                for (let j = 0; j < subSubLayers.length; j++) {
                                    try {
                                        const subSubLayerBounds = subSubLayers[j].getBounds();
                                        if (subSubLayerBounds && subSubLayerBounds.isValid && subSubLayerBounds.isValid()) {
                                            subLayerBounds = subSubLayerBounds;
                                            break;
                                        }
                                    } catch (e) {
                                        continue;
                                    }
                                }
                            } else {
                                subLayerBounds = subLayer.getBounds();
                            }

                            if (subLayerBounds && subLayerBounds.isValid && subLayerBounds.isValid()) {
                                bounds = subLayerBounds;
                                break; // ä½¿ç”¨ç¬¬ä¸€ä¸ªæœ‰æ•ˆçš„è¾¹ç•Œ
                            }
                        } catch (e) {
                            continue; // å°è¯•ä¸‹ä¸€ä¸ªå›¾å±‚
                        }
                    }
                }
            } else {
                // å¦‚æœæ˜¯å•ä¸ªå›¾å±‚ï¼Œç›´æ¥è·å–è¾¹ç•Œ
                try {
                    bounds = layer.getBounds();
                } catch (e) {
                    console.error('è·å–å›¾å±‚è¾¹ç•Œå¤±è´¥:', e);
                    return; // å¦‚æœæ— æ³•è·å–è¾¹ç•Œï¼Œåˆ™ä¸æ·»åŠ æ ‡ç­¾
                }
            }

            if (bounds && bounds.isValid && bounds.isValid()) {
                const center = bounds.getCenter();
                const label = L.divIcon({
                    className: 'custom-label',
                    html: `<div style="background: rgba(0,0,0,0.8); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; white-space: nowrap;">${prefix}</div>`,
                    iconSize: null,
                    iconAnchor: [0, 0]
                });

                const labelMarker = L.marker(center, { icon: label });
                labelLayerGroup.addLayer(labelMarker);
            }
        } catch (error) {
            console.error('æ·»åŠ æ ‡ç­¾é”™è¯¯:', error);
        }
    }

    // ä¸ºå›¾å±‚æ·»åŠ é¢ç§¯æ ‡ç­¾
    function addAreaLabelToLayer(layer, areaText) {
        try {
            console.log('å°è¯•ä¸ºå›¾å±‚æ·»åŠ é¢ç§¯æ ‡ç­¾:', areaText);
            // å¦‚æœlayeræ˜¯LayerGroupæˆ–FeatureGroupï¼Œéœ€è¦è·å–å…¶ä¸­çš„ç¬¬ä¸€ä¸ªå›¾å±‚æ¥è·å–è¾¹ç•Œ
            let bounds;
            if (layer instanceof L.LayerGroup || layer instanceof L.FeatureGroup) {
                const layers = layer.getLayers();
                if (layers && layers.length > 0) {
                    // éå†æ‰€æœ‰å­å›¾å±‚æ¥è·å–æœ‰æ•ˆçš„è¾¹ç•Œ
                    for (let i = 0; i < layers.length; i++) {
                        try {
                            const subLayer = layers[i];
                            let subLayerBounds;

                            // æ£€æŸ¥å­å›¾å±‚æ˜¯å¦ä¸ºLayerGroupæˆ–FeatureGroup
                            if (subLayer instanceof L.LayerGroup || subLayer instanceof L.FeatureGroup) {
                                // é€’å½’å¤„ç†åµŒå¥—çš„LayerGroupæˆ–FeatureGroup
                                const subSubLayers = subLayer.getLayers();
                                for (let j = 0; j < subSubLayers.length; j++) {
                                    try {
                                        const subSubLayerBounds = subSubLayers[j].getBounds();
                                        if (subSubLayerBounds && subSubLayerBounds.isValid && subSubLayerBounds.isValid()) {
                                            subLayerBounds = subSubLayerBounds;
                                            break;
                                        }
                                    } catch (e) {
                                        continue;
                                    }
                                }
                            } else {
                                subLayerBounds = subLayer.getBounds();
                            }

                            if (subLayerBounds && subLayerBounds.isValid && subLayerBounds.isValid()) {
                                bounds = subLayerBounds;
                                break; // ä½¿ç”¨ç¬¬ä¸€ä¸ªæœ‰æ•ˆçš„è¾¹ç•Œ
                            }
                        } catch (e) {
                            continue; // å°è¯•ä¸‹ä¸€ä¸ªå›¾å±‚
                        }
                    }
                }
            } else {
                // å¦‚æœæ˜¯å•ä¸ªå›¾å±‚ï¼Œç›´æ¥è·å–è¾¹ç•Œ
                try {
                    bounds = layer.getBounds();
                } catch (e) {
                    console.error('è·å–å›¾å±‚è¾¹ç•Œå¤±è´¥:', e);
                    return; // å¦‚æœæ— æ³•è·å–è¾¹ç•Œï¼Œåˆ™ä¸æ·»åŠ æ ‡ç­¾
                }
            }

            if (bounds && bounds.isValid && bounds.isValid()) {
                const center = bounds.getCenter();
                const label = L.divIcon({
                    className: 'area-label',
                    html: areaText,
                    iconSize: null,
                    iconAnchor: null // ä½¿ç”¨é»˜è®¤é”šç‚¹
                });

                const labelMarker = L.marker(center, { icon: label });
                labelLayerGroup.addLayer(labelMarker);
                console.log('æˆåŠŸæ·»åŠ é¢ç§¯æ ‡ç­¾åˆ°å›¾å±‚ç»„');
                console.log('å½“å‰æ ‡ç­¾å›¾å±‚ä¸­çš„å›¾å±‚æ•°é‡:', labelLayerGroup.getLayers().length);
            } else {
                console.warn('æ— æ³•è·å–å›¾å±‚è¾¹ç•Œï¼Œæ— æ³•æ·»åŠ é¢ç§¯æ ‡ç­¾');
            }
        } catch (error) {
            console.error('æ·»åŠ é¢ç§¯æ ‡ç­¾é”™è¯¯:', error);
        }
    }

    // è½¨è¿¹ç»˜åˆ¶å‡½æ•°
    function drawTrack() {
        const trackText = document.getElementById('trackTextarea').value.trim();
        const timeRangeText = document.getElementById('timeRangeInput').value.trim();

        if (!trackText) {
            alert('è¯·ç²˜è´´è½¨è¿¹æ–‡æœ¬ï¼ˆæ—¶é—´æˆ³,ç»åº¦,çº¬åº¦ï¼‰');
            return;
        }

        clearTrack();

        // è§£ææ—¶é—´èŒƒå›´
        let startTime, endTime;
        if (timeRangeText) {
            const timeParts = timeRangeText.split(' - ');
            if (timeParts.length === 2) {
                startTime = new Date(timeParts[0].trim());
                endTime = new Date(timeParts[1].trim());

                if (isNaN(startTime.getTime()) || isNaN(endTime.getTime())) {
                    alert('æ—¶é—´èŒƒå›´æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä½¿ç”¨æ ¼å¼ï¼š2025-10-23T13:56:49 - 2025-10-23T15:51:31');
                    return;
                }
            }
        }

        // è§£æè½¨è¿¹æ•°æ®
        const points = [];
        const lines = trackText.split('\n');

        lines.forEach(line => {
            line = line.trim();
            if (!line) return;

            // æ”¯æŒä¸¤ç§æ ¼å¼ï¼š
            // 1. ç»åº¦,çº¬åº¦,æ—¶é—´æˆ³
            // 2. æ—¶é—´æˆ³,ç»åº¦,çº¬åº¦
            const parts = line.split(',');
            if (parts.length >= 3) {
                let lng, lat, timestamp;

                // åˆ¤æ–­æ ¼å¼ï¼šå¦‚æœç¬¬ä¸€éƒ¨åˆ†æ˜¯æ•°å­—ä¸”é•¿åº¦å¤§äº10ï¼Œå¯èƒ½æ˜¯æ—¶é—´æˆ³
                if (parts[0].trim().length > 10 && !isNaN(parts[0].trim())) {
                    // æ ¼å¼ï¼šæ—¶é—´æˆ³,ç»åº¦,çº¬åº¦
                    timestamp = parts[0].trim();
                    lng = parseFloat(parts[1].trim());
                    lat = parseFloat(parts[2].trim());
                } else {
                    // æ ¼å¼ï¼šç»åº¦,çº¬åº¦,æ—¶é—´æˆ³
                    lng = parseFloat(parts[0].trim());
                    lat = parseFloat(parts[1].trim());
                    timestamp = parts[2].trim();
                }

                if (!isNaN(lng) && !isNaN(lat) && timestamp) {
                    const pointTime = parseTimestamp(timestamp);

                    // æ£€æŸ¥æ—¶é—´èŒƒå›´
                    if (startTime && endTime) {
                        if (pointTime < startTime || pointTime > endTime) {
                            return; // è·³è¿‡ä¸åœ¨æ—¶é—´èŒƒå›´å†…çš„ç‚¹
                        }
                    }

                    points.push({
                        lat: lat,
                        lng: lng,
                        timestamp: timestamp,
                        time: pointTime
                    });
                }
            }
        });

        if (points.length < 2) {
            alert('è¯¥æ—¶é—´èŒƒå›´å†…çš„æœ‰æ•ˆè½¨è¿¹ç‚¹ä¸è¶³ï¼Œè‡³å°‘éœ€è¦ä¸¤ç‚¹');
            return;
        }

        // æŒ‰æ—¶é—´æ’åº
        points.sort((a, b) => a.time - b.time);

        // ç»˜åˆ¶è½¨è¿¹çº¿
        const latlngs = points.map(p => [p.lat, p.lng]);

        currentTrack = L.polyline(latlngs, {
            color: currentTrackLineColor,
            weight: 1,
            opacity: 0.9
        });

        trackLayerGroup.addLayer(currentTrack);

        // è‡ªé€‚åº”è§†é‡
        const group = new L.featureGroup([currentTrack]);
        map.fitBounds(group.getBounds().pad(0.1));

        // ä¿å­˜è½¨è¿¹ç‚¹ç”¨äºå›æ”¾
        playbackState.points = points;

        // å¯ç”¨æ’­æ”¾å™¨æ§åˆ¶æŒ‰é’®ï¼ˆå¦‚æœæ’­æ”¾å™¨å…ƒç´ å­˜åœ¨ï¼‰
        if (playbackPlayer) {
            updatePlayerControls();
        }

        updateStatus('è½¨è¿¹ç»˜åˆ¶å®Œæˆ');
    }

    // ç»˜åˆ¶è½¨è¿¹ç‚¹ï¼ˆæ‰“ç‚¹ï¼‰- åˆ†æ‰¹å¤„ç†é¿å…é¡µé¢å¡æ­»
    function showTrackPoints() {
        const trackText = document.getElementById('trackTextarea').value.trim();
        const timeRangeText = document.getElementById('timeRangeInput').value.trim();

        if (!trackText) {
            alert('è¯·ç²˜è´´è½¨è¿¹æ–‡æœ¬ï¼ˆæ—¶é—´æˆ³,ç»åº¦,çº¬åº¦ï¼‰');
            return;
        }

        clearTrack();

        // è§£ææ—¶é—´èŒƒå›´
        let startTime, endTime;
        if (timeRangeText) {
            const timeParts = timeRangeText.split(' - ');
            if (timeParts.length === 2) {
                startTime = new Date(timeParts[0].trim());
                endTime = new Date(timeParts[1].trim());

                if (isNaN(startTime.getTime()) || isNaN(endTime.getTime())) {
                    alert('æ—¶é—´èŒƒå›´æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä½¿ç”¨æ ¼å¼ï¼š2025-10-23T13:56:49 - 2025-10-23T15:51:31');
                    return;
                }
            }
        }

        // è§£æè½¨è¿¹æ•°æ®
        const points = [];
        const lines = trackText.split('\n');

        lines.forEach(line => {
            line = line.trim();
            if (!line) return;

            // æ”¯æŒä¸¤ç§æ ¼å¼ï¼š
            // 1. ç»åº¦,çº¬åº¦,æ—¶é—´æˆ³
            // 2. æ—¶é—´æˆ³,ç»åº¦,çº¬åº¦
            const parts = line.split(',');
            if (parts.length >= 3) {
                let lng, lat, timestamp;

                // åˆ¤æ–­æ ¼å¼ï¼šå¦‚æœç¬¬ä¸€éƒ¨åˆ†æ˜¯æ•°å­—ä¸”é•¿åº¦å¤§äº10ï¼Œå¯èƒ½æ˜¯æ—¶é—´æˆ³
                if (parts[0].trim().length > 10 && !isNaN(parts[0].trim())) {
                    // æ ¼å¼ï¼šæ—¶é—´æˆ³,ç»åº¦,çº¬åº¦
                    timestamp = parts[0].trim();
                    lng = parseFloat(parts[1].trim());
                    lat = parseFloat(parts[2].trim());
                } else {
                    // æ ¼å¼ï¼šç»åº¦,çº¬åº¦,æ—¶é—´æˆ³
                    lng = parseFloat(parts[0].trim());
                    lat = parseFloat(parts[1].trim());
                    timestamp = parts[2].trim();
                }

                if (!isNaN(lng) && !isNaN(lat) && timestamp) {
                    const pointTime = parseTimestamp(timestamp);

                    // æ£€æŸ¥æ—¶é—´èŒƒå›´
                    if (startTime && endTime) {
                        if (pointTime < startTime || pointTime > endTime) {
                            return; // è·³è¿‡ä¸åœ¨æ—¶é—´èŒƒå›´å†…çš„ç‚¹
                        }
                    }

                    points.push({
                        lat: lat,
                        lng: lng,
                        timestamp: timestamp,
                        time: pointTime
                    });
                }
            }
        });

        if (points.length === 0) {
            alert('è¯¥æ—¶é—´èŒƒå›´å†…æ²¡æœ‰æ‰¾åˆ°è½¨è¿¹ç‚¹');
            return;
        }

        // æŒ‰æ—¶é—´æ’åº
        points.sort((a, b) => a.time - b.time);

        // ä¿å­˜è½¨è¿¹ç‚¹ç”¨äºå›æ”¾
        playbackState.points = points;

        // åˆ†æ‰¹ç»˜åˆ¶è½¨è¿¹ç‚¹ï¼Œé¿å…é¡µé¢å¡æ­»
        const batchSize = 100; // æ¯æ‰¹å¤„ç†100ä¸ªç‚¹
        let currentBatch = 0;
        let processedCount = 0;
        const totalPoints = points.length;
        let isFirstPointProcessed = false; // æ ‡è®°æ˜¯å¦å·²å¤„ç†ç¬¬ä¸€ä¸ªç‚¹

        updateStatus(`å¼€å§‹ç»˜åˆ¶è½¨è¿¹ç‚¹ï¼Œå…±${totalPoints}ä¸ªç‚¹ï¼Œåˆ†æ‰¹å¤„ç†ä¸­...`);

        function drawBatch() {
            const startIdx = currentBatch * batchSize;
            const endIdx = Math.min(startIdx + batchSize, totalPoints);
            const batchPoints = points.slice(startIdx, endIdx);

            // ç»˜åˆ¶å½“å‰æ‰¹æ¬¡çš„ç‚¹
            batchPoints.forEach((point, index) => {
                const actualIndex = startIdx + index;
                
                // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªç‚¹ï¼Œå…ˆå°†åœ°å›¾ä¸­å¿ƒç§»è‡³è¯¥ç‚¹ï¼Œä¸æ”¹å˜ç¼©æ”¾çº§åˆ«
                if (!isFirstPointProcessed && actualIndex === 0) {
                    map.setView([point.lat, point.lng], map.getZoom()); // ä¿æŒå½“å‰ç¼©æ”¾çº§åˆ«ï¼Œä»…å±…ä¸­æ˜¾ç¤º
                    isFirstPointProcessed = true;
                }
                
                // åˆ›å»ºæå°çš„DivIcon
                const tinyIcon = L.divIcon({
                    className: 'tiny-track-point',
                    html: `<div style="width: 1px; height: 1px; background-color: ${currentTrackPointColor}; border-radius: 50%;"></div>`,
                    iconSize: [1, 1],
                    iconAnchor: [0.5, 0.5]
                });

                const marker = L.marker([point.lat, point.lng], {
                    icon: tinyIcon,
                    opacity: 0.8
                });

                marker.bindPopup(`è½¨è¿¹ç‚¹ ${actualIndex + 1}<br>æ—¶é—´: ${point.timestamp}`);
                trackLayerGroup.addLayer(marker);
            });

            processedCount += batchPoints.length;
            currentBatch++;

            // æ›´æ–°è¿›åº¦çŠ¶æ€
            const progress = Math.round((processedCount / totalPoints) * 100);
            updateStatus(`è½¨è¿¹ç‚¹ç»˜åˆ¶ä¸­... ${progress}% (${processedCount}/${totalPoints})`);

            // å¦‚æœè¿˜æœ‰æœªå¤„ç†çš„ç‚¹ï¼Œç»§ç»­ä¸‹ä¸€æ‰¹
            if (processedCount < totalPoints) {
                // ä½¿ç”¨setTimeoutè®©æµè§ˆå™¨æœ‰æ—¶é—´å¤„ç†å…¶ä»–ä»»åŠ¡ï¼Œé¿å…å¡æ­»
                setTimeout(drawBatch, 10);
            } else {
                // æ‰€æœ‰ç‚¹ç»˜åˆ¶å®Œæˆ
                // è‡ªé€‚åº”è§†é‡ï¼ˆå¦‚æœåªæœ‰ä¸€ä¸ªç‚¹ï¼Œä¿æŒå½“å‰ç¼©æ”¾çº§åˆ«ï¼›å¦‚æœæœ‰å¤šä¸ªç‚¹ï¼Œè°ƒæ•´è‡³åˆé€‚çš„è§†é‡ï¼‰
                if (totalPoints === 1) {
                    // å•ä¸ªç‚¹ï¼Œä¿æŒä¹‹å‰è®¾ç½®çš„ç¼©æ”¾çº§åˆ«å’Œä¸­å¿ƒç‚¹
                } else {
                    // å¤šä¸ªç‚¹ï¼Œè°ƒæ•´è§†é‡ä»¥æ˜¾ç¤ºæ‰€æœ‰ç‚¹
                    const group = new L.featureGroup(trackLayerGroup.getLayers());
                    map.fitBounds(group.getBounds().pad(0.1));
                }

                // æ›´æ–°æ’­æ”¾å™¨æ§åˆ¶çŠ¶æ€
                updatePlayerControls();

                updateStatus(`è½¨è¿¹ç‚¹ç»˜åˆ¶å®Œæˆï¼Œå…±${totalPoints}ä¸ªç‚¹`);
                
                // æ›´æ–°æ’­æ”¾å™¨æ§åˆ¶çŠ¶æ€
                updatePlayerControls();
            }
        }

        // å¼€å§‹ç¬¬ä¸€æ‰¹ç»˜åˆ¶
        drawBatch();
    }

    // è§£æè½¨è¿¹ç‚¹ - åˆ†æ‰¹å¤„ç†é¿å…é¡µé¢å¡æ­»
    function parseTrackPoints(text) {
        try {
            const lines = text.trim().split('\n');
            const points = [];

            lines.forEach(line => {
                const parts = line.split(',');
                if (parts.length >= 3) {
                    const lng = parseFloat(parts[0].trim());
                    const lat = parseFloat(parts[1].trim());
                    const timestamp = parts[2].trim();

                    if (!isNaN(lng) && !isNaN(lat)) {
                        points.push({
                            lat: lat,
                            lng: lng,
                            timestamp: timestamp,
                            time: parseTimestamp(timestamp)
                        });
                    }
                }
            });

            if (points.length > 0) {
                // æŒ‰æ—¶é—´æ’åº
                points.sort((a, b) => a.time - b.time);

                // ä¿å­˜è½¨è¿¹ç‚¹ç”¨äºå›æ”¾
                playbackState.points = points;

                // åˆ†æ‰¹ç»˜åˆ¶è½¨è¿¹ç‚¹ï¼Œé¿å…é¡µé¢å¡æ­»
                const batchSize = 100; // æ¯æ‰¹å¤„ç†100ä¸ªç‚¹
                let currentBatch = 0;
                let processedCount = 0;
                const totalPoints = points.length;

                updateStatus(`å¼€å§‹ç»˜åˆ¶è½¨è¿¹ç‚¹ï¼Œå…±${totalPoints}ä¸ªç‚¹ï¼Œåˆ†æ‰¹å¤„ç†ä¸­...`);

                function drawBatch() {
                    const startIdx = currentBatch * batchSize;
                    const endIdx = Math.min(startIdx + batchSize, totalPoints);
                    const batchPoints = points.slice(startIdx, endIdx);

                    // ç»˜åˆ¶å½“å‰æ‰¹æ¬¡çš„ç‚¹
                    batchPoints.forEach((point, index) => {
                        const actualIndex = startIdx + index;
                        
                        // åˆ›å»ºæå°çš„DivIcon
                        const tinyIcon = L.divIcon({
                            className: 'tiny-track-point',
                            html: `<div style="width: 1px; height: 1px; background-color: ${currentTrackPointColor}; border-radius: 50%;"></div>`,
                            iconSize: [1, 1],
                            iconAnchor: [0.5, 0.5]
                        });

                        const marker = L.marker([point.lat, point.lng], {
                            icon: tinyIcon,
                            opacity: 0.8
                        });

                        marker.bindPopup(`è½¨è¿¹ç‚¹ ${actualIndex + 1}<br>æ—¶é—´: ${point.timestamp}`);
                        trackLayerGroup.addLayer(marker);
                    });

                    processedCount += batchPoints.length;
                    currentBatch++;

                    // æ›´æ–°è¿›åº¦çŠ¶æ€
                    const progress = Math.round((processedCount / totalPoints) * 100);
                    updateStatus(`è½¨è¿¹ç‚¹ç»˜åˆ¶ä¸­... ${progress}% (${processedCount}/${totalPoints})`);

                    // å¦‚æœè¿˜æœ‰æœªå¤„ç†çš„ç‚¹ï¼Œç»§ç»­ä¸‹ä¸€æ‰¹
                    if (processedCount < totalPoints) {
                        // ä½¿ç”¨setTimeoutè®©æµè§ˆå™¨æœ‰æ—¶é—´å¤„ç†å…¶ä»–ä»»åŠ¡ï¼Œé¿å…å¡æ­»
                        setTimeout(drawBatch, 10);
                    } else {
                          // æ‰€æœ‰ç‚¹ç»˜åˆ¶å®Œæˆ
                          updateStatus(`è½¨è¿¹ç‚¹ç»˜åˆ¶å®Œæˆï¼Œå…±${totalPoints}ä¸ªç‚¹`);
                          
                          // æ›´æ–°æ’­æ”¾å™¨æ§åˆ¶çŠ¶æ€
                          updatePlayerControls();
                      }
                }

                // å¼€å§‹ç¬¬ä¸€æ‰¹ç»˜åˆ¶
                drawBatch();
            }
        } catch (error) {
            console.error('è½¨è¿¹ç‚¹è§£æé”™è¯¯:', error);
            updateStatus('è½¨è¿¹ç‚¹è§£æå¤±è´¥');
        }
    }

    // æ—¶é—´æˆ³è§£æ
    function parseTimestamp(timestamp) {
        const tstr = (timestamp || '').replace(/\D/g, '');
        const m = tstr && tstr.match(/^\d{14}$/);
        if (!m) return null;

        const y = parseInt(tstr.slice(0, 4), 10);
        const M = parseInt(tstr.slice(4, 6), 10) - 1;
        const d = parseInt(tstr.slice(6, 8), 10);
        const h = parseInt(tstr.slice(8, 10), 10);
        const m2 = parseInt(tstr.slice(10, 12), 10);
        const s = parseInt(tstr.slice(12, 14), 10);
        const dt = new Date(y, M, d, h, m2, s);
        return isNaN(dt.getTime()) ? null : dt;
    }

    // æ¸…é™¤è½¨è¿¹
    function clearTrack() {
        trackLayerGroup.clearLayers();
        currentTrack = null;
        playbackState.points = [];
        stopPlayback();

        // é‡ç½®æ’­æ”¾å™¨çŠ¶æ€ï¼ˆå¦‚æœæ’­æ”¾å™¨å…ƒç´ å­˜åœ¨ï¼‰
        if (playbackPlayer) {
            updatePlayerControls();
        }
        
        // æ¸…é™¤è½¨è¿¹æ—¶é‡ç½®è¿›åº¦æ¡å’Œæ—¶é—´æ˜¾ç¤º
        if (playerProgressSlider) {
            playerProgressSlider.value = 0;
            playerProgressSlider.disabled = true;
        }
        // é‡ç½®ä¸¤è¡Œæ—¶é—´æ˜¾ç¤º
        const currentTimeElement = document.getElementById('currentTime');
        const totalTimeElement = document.getElementById('totalTime');
        if (currentTimeElement) currentTimeElement.textContent = '00:00:00';
        if (totalTimeElement) totalTimeElement.textContent = '00:00:00';

        updateStatus('è½¨è¿¹å·²æ¸…é™¤');
    }

    // è½¨è¿¹å›æ”¾æ§åˆ¶å‡½æ•° - ä½¿ç”¨æ–°çš„æ’­æ”¾å™¨æ§åˆ¶é¢æ¿
    function startPlayback() {
        // æ£€æŸ¥æ˜¯å¦æœ‰è½¨è¿¹ç‚¹
        if (!playbackState.points || playbackState.points.length === 0) {
            updateStatus('æš‚æ— è½¨è¿¹æ•°æ®ï¼Œæ— æ³•å¼€å§‹å›æ”¾');
            return;
        }

        if (playbackState.isPlaying) {
            return;
        }

        // åœæ­¢ä¹‹å‰çš„å›æ”¾ï¼ˆä½†ä¸é‡ç½®currentIndexï¼‰
        if (playbackState.timer) {
            clearTimeout(playbackState.timer);
            playbackState.timer = null;
        }

        playbackState.isPlaying = true;
        // ä¸é‡ç½®currentIndexï¼Œä¿æŒå½“å‰æ’­æ”¾ä½ç½®

        // å¦‚æœæ’­æ”¾å…ƒç´ ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒä»¬
        if (!playbackState.marker || !playbackState.polyline) {
            // æ¸…é™¤ä¹‹å‰çš„å›æ”¾å…ƒç´ 
            if (playbackState.marker) {
                map.removeLayer(playbackState.marker);
            }
            if (playbackState.polyline) {
                map.removeLayer(playbackState.polyline);
            }

            // åˆ›å»ºå›æ”¾è½¨è¿¹çº¿
            const latlngs = playbackState.points.map(p => [p.lat, p.lng]);
            playbackState.polyline = L.polyline(latlngs, {
                color: '#FF6B6B',
                weight: 1,
                opacity: 0.6
            }).addTo(map);

            // åˆ›å»ºå›æ”¾æ ‡è®°
            const firstPoint = playbackState.points[0];
            playbackState.marker = L.circleMarker([firstPoint.lat, firstPoint.lng], {
                radius: 0.5,
                fillColor: '#FF6B6B',
                color: '#FFFFFF',
                weight: 0.5,
                opacity: 1,
                fillOpacity: 0.9
            }).addTo(map);

            // è‡ªé€‚åº”è§†é‡åˆ°è½¨è¿¹èŒƒå›´
            const bounds = playbackState.polyline.getBounds();
            if (bounds && bounds.isValid()) {
                map.fitBounds(bounds, { padding: [20, 20] });
            }
        }

        // æ›´æ–°æ’­æ”¾å™¨æ§åˆ¶çŠ¶æ€
        updatePlayerControls();
        
        // è®¾ç½®è¿›åº¦æ¡å’Œæ—¶é—´æ˜¾ç¤ºï¼ˆä¸é‡ç½®è¿›åº¦ï¼‰
        if (playerProgressSlider) {
            playerProgressSlider.disabled = false;
            playerProgressSlider.max = 100;
        }
        
        if (playerSpeedValue) {
            // æ˜¾ç¤ºæŒ‡æ•°å€æ•°
            const displaySpeed = playbackState.speed || 1;
            playerSpeedValue.textContent = displaySpeed + 'x';
        }

        // å¼€å§‹æ’­æ”¾
        playbackNextPoint();
        updateStatus('è½¨è¿¹å›æ”¾å¼€å§‹');
    }

    function playbackNextPoint() {
        if (!playbackState.isPlaying || !playbackState.points || playbackState.currentIndex >= playbackState.points.length) {
            // åªæœ‰åœ¨æ’­æ”¾å®Œæˆæ—¶æ‰åœæ­¢å¹¶é‡ç½®ï¼Œæš‚åœæ—¶ä¸åœæ­¢
            if (playbackState.currentIndex >= playbackState.points.length) {
                // æ’­æ”¾å®Œæˆï¼Œåªé‡ç½®çŠ¶æ€ä½†ä¸æ¸…é™¤è½¨è¿¹çº¿
                playbackState.isPlaying = false;
                playbackState.currentIndex = 0;
                
                // æ¸…é™¤å®šæ—¶å™¨
                if (playbackState.timer) {
                    clearTimeout(playbackState.timer);
                    playbackState.timer = null;
                }
                
                // æ¸…é™¤æ ‡è®°ï¼ˆä¿ç•™è½¨è¿¹çº¿ï¼‰
                if (playbackState.marker) {
                    map.removeLayer(playbackState.marker);
                    playbackState.marker = null;
                }
                
                // æ’­æ”¾å®Œæˆæ—¶ä¸éœ€è¦é‡ç½®æ—¶é—´æ˜¾ç¤ºï¼Œä¿æŒå½“å‰æ—¶é—´
                // ä¹Ÿä¸éœ€è¦é‡ç½®è¿›åº¦æ¡ä½ç½®
                // const currentTimeElement = document.getElementById('currentTime');
                // const totalTimeElement = document.getElementById('totalTime');
                // if (currentTimeElement) currentTimeElement.textContent = '00:00:00';
                // if (totalTimeElement) totalTimeElement.textContent = '00:00:00';
                
                // æ›´æ–°æ’­æ”¾å™¨æ§åˆ¶çŠ¶æ€ï¼ˆå¦‚æœæ’­æ”¾å™¨å…ƒç´ å­˜åœ¨ï¼‰
                if (playbackPlayer) {
                    updatePlayerControls();
                }
                
                updateStatus('è½¨è¿¹å›æ”¾å®Œæˆ');
            }
            return;
        }

        const point = playbackState.points[playbackState.currentIndex];

        // æ›´æ–°æ ‡è®°ä½ç½®
        playbackState.marker.setLatLng([point.lat, point.lng]);
        playbackState.marker.bindPopup(`å›æ”¾ç‚¹ ${playbackState.currentIndex + 1}<br>æ—¶é—´: ${point.timestamp}`);

        // æ›´æ–°è½¨è¿¹çº¿
        const currentLatlngs = playbackState.points.slice(0, playbackState.currentIndex + 1).map(p => [p.lat, p.lng]);
        playbackState.polyline.setLatLngs(currentLatlngs);

        // æ£€æŸ¥ç‚¹æ˜¯å¦åœ¨å±å¹•å¯è§èŒƒå›´å†…ï¼Œåªæœ‰ä¸åœ¨å¯è§èŒƒå›´å†…æ—¶æ‰å±…ä¸­
        const pointLatLng = L.latLng(point.lat, point.lng);
        const bounds = map.getBounds();
        
        // å¦‚æœç‚¹ä¸åœ¨å½“å‰åœ°å›¾è¾¹ç•Œå†…ï¼Œæˆ–è€…è·ç¦»è¾¹ç•Œå¤ªè¿‘ï¼ˆå°äºåœ°å›¾å®½é«˜çš„10%ï¼‰ï¼Œåˆ™å±…ä¸­
        if (!bounds.contains(pointLatLng)) {
            // ç‚¹å®Œå…¨ä¸åœ¨å±å¹•å†…ï¼Œéœ€è¦å±…ä¸­
            map.setView([point.lat, point.lng], map.getZoom(), {
                animate: true,
                duration: 0.3
            });
        } else {
            // ç‚¹åœ¨å±å¹•å†…ï¼Œæ£€æŸ¥æ˜¯å¦é è¿‘è¾¹ç•Œï¼ˆè·ç¦»è¾¹ç•Œå°äºåœ°å›¾å®½é«˜çš„10%ï¼‰
            const boundsPad = bounds.pad(-0.1); // å†…ç¼©10%çš„è¾¹ç•Œ
            if (!boundsPad.contains(pointLatLng)) {
                // ç‚¹é è¿‘è¾¹ç•Œï¼Œå±…ä¸­æ˜¾ç¤º
                map.setView([point.lat, point.lng], map.getZoom(), {
                    animate: true,
                    duration: 0.3
                });
            }
            // ç‚¹åœ¨å±å¹•ä¸­å¤®åŒºåŸŸï¼Œä¸éœ€è¦å±…ä¸­
        }

        // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤ºå‡½æ•°
        function formatTime(timestamp) {
            const date = parseTimestamp(timestamp);
            if (!date) return '00:00:00';
            
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const seconds = date.getSeconds().toString().padStart(2, '0');
            return hours + ':' + minutes + ':' + seconds;
        }

        // æ›´æ–°è¿›åº¦æ¡å’Œæ—¶é—´æ˜¾ç¤º
        if (playerProgressSlider && playbackState.points.length > 0) {
            const percentage = Math.round((playbackState.currentIndex / (playbackState.points.length - 1)) * 100);
            playerProgressSlider.value = percentage;
        }
        
        // æ›´æ–°æ—¶é—´æ˜¾ç¤ºï¼ˆå¦‚æœæ’­æ”¾å™¨å…ƒç´ å­˜åœ¨ï¼‰
        if (playbackState.points.length > 0) {
            const currentPoint = playbackState.points[playbackState.currentIndex];
            const lastPoint = playbackState.points[playbackState.points.length - 1];
            
            if (currentPoint && lastPoint) {
                const currentTime = formatTime(currentPoint.timestamp);
                const totalTime = formatTime(lastPoint.timestamp);
                
                // æ›´æ–°ä¸¤è¡Œæ—¶é—´æ˜¾ç¤º
                const currentTimeElement = document.getElementById('currentTime');
                const totalTimeElement = document.getElementById('totalTime');
                if (currentTimeElement) currentTimeElement.textContent = currentTime;
                if (totalTimeElement) totalTimeElement.textContent = totalTime;
            }
        }

        // æ›´æ–°çŠ¶æ€
        const progress = Math.round((playbackState.currentIndex / (playbackState.points.length - 1)) * 100);
        updateStatus(`è½¨è¿¹å›æ”¾ä¸­... ${progress}%`);

        playbackState.currentIndex++;

        // è®¾ç½®ä¸‹ä¸€ä¸ªç‚¹çš„æ’­æ”¾å»¶è¿Ÿ
        const speed = playbackState.speed || 1;
        const delay = 1000 / speed; // é€Ÿåº¦è¶Šå¿«ï¼Œå»¶è¿Ÿè¶ŠçŸ­

        playbackState.timer = setTimeout(playbackNextPoint, delay);
    }

    function pausePlayback() {
        playbackState.isPlaying = false;
        
        // æ¸…é™¤å®šæ—¶å™¨
        if (playbackState.timer) {
            clearTimeout(playbackState.timer);
            playbackState.timer = null;
        }
        
        // æ›´æ–°æ’­æ”¾å™¨æ§åˆ¶çŠ¶æ€
        if (playbackPlayer) {
            updatePlayerControls();
        }
        
        updateStatus('è½¨è¿¹å›æ”¾å·²æš‚åœ');
    }

    function stopPlayback() {
        playbackState.isPlaying = false;
        playbackState.currentIndex = 0;

        // æ¸…é™¤å›æ”¾å…ƒç´ 
        if (playbackState.marker) {
            map.removeLayer(playbackState.marker);
            playbackState.marker = null;
        }
        if (playbackState.polyline) {
            map.removeLayer(playbackState.polyline);
            playbackState.polyline = null;
        }

        // é‡ç½®è¿›åº¦æ¡å’Œæ—¶é—´æ˜¾ç¤º
        if (playerProgressSlider) {
            playerProgressSlider.value = 0;
        }
        // é‡ç½®ä¸¤è¡Œæ—¶é—´æ˜¾ç¤º
        const currentTimeElement = document.getElementById('currentTime');
        const totalTimeElement = document.getElementById('totalTime');
        if (currentTimeElement) currentTimeElement.textContent = '00:00:00';
        if (totalTimeElement) totalTimeElement.textContent = '00:00:00';
        
        // æ›´æ–°æ’­æ”¾å™¨æ§åˆ¶çŠ¶æ€ï¼ˆå¦‚æœæ’­æ”¾å™¨å…ƒç´ å­˜åœ¨ï¼‰
        if (playbackPlayer) {
            updatePlayerControls();
        }
        
        updateStatus('è½¨è¿¹å›æ”¾å·²åœæ­¢');

        // é‡ç½®æ»‘å—
        const playbackTimeSlider = document.getElementById('playbackTimeSlider');
        if (playbackTimeSlider) {
            playbackTimeSlider.value = 0;
            playbackTimeSlider.disabled = true;
        }

        // åŒæ­¥æ›´æ–°åº•éƒ¨å›ºå®šæ’­æ”¾æ§åˆ¶é¢æ¿
        const playbackTimeSliderFixed = document.getElementById('playbackTimeSliderFixed');
        if (playbackTimeSliderFixed) {
            playbackTimeSliderFixed.value = 0;
            playbackTimeSliderFixed.disabled = true;
        }

        updateStatus('è½¨è¿¹å›æ”¾å·²åœæ­¢');
    }

    function jumpToPoint(index) {
        if (!playbackState.points || index < 0 || index >= playbackState.points.length) {
            return;
        }

        playbackState.currentIndex = index;

        // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œæš‚åœ
        if (playbackState.isPlaying) {
            pausePlayback();
        }

        // åˆ›å»ºå›æ”¾å…ƒç´ ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if (!playbackState.marker) {
            const point = playbackState.points[0];
            playbackState.marker = L.circleMarker([point.lat, point.lng], {
                radius: 0.5,
                fillColor: '#FF6B6B',
                color: '#FFFFFF',
                weight: 0.5,
                opacity: 1,
                fillOpacity: 0.9
            }).addTo(map);
        }

        if (!playbackState.polyline) {
            const latlngs = playbackState.points.map(p => [p.lat, p.lng]);
            playbackState.polyline = L.polyline(latlngs, {
                color: '#FF6B6B',
                weight: 1,
                opacity: 0.6
            }).addTo(map);
        }

        // è·³è½¬åˆ°æŒ‡å®šç‚¹
        const point = playbackState.points[index];
        playbackState.marker.setLatLng([point.lat, point.lng]);
        playbackState.marker.bindPopup(`å›æ”¾ç‚¹ ${index + 1}<br>æ—¶é—´: ${point.timestamp}`);

        // æ›´æ–°è½¨è¿¹çº¿
        const currentLatlngs = playbackState.points.slice(0, index + 1).map(p => [p.lat, p.lng]);
        playbackState.polyline.setLatLngs(currentLatlngs);

        // æ›´æ–°çŠ¶æ€
        const progress = Math.round((index / (playbackState.points.length - 1)) * 100);
        updateStatus(`è½¨è¿¹å›æ”¾å·²è·³è½¬åˆ° ${progress}%`);
    }

    // åˆ†å‰²å™¨ç»˜åˆ¶


    // è½¨è¿¹å›æ”¾æ§åˆ¶ - ä½¿ç”¨æ–°çš„æ’­æ”¾å™¨æ§åˆ¶é¢æ¿
    function startPlayback() {
        // æ£€æŸ¥æ˜¯å¦æœ‰è½¨è¿¹ç‚¹
        if (!playbackState.points || playbackState.points.length === 0) {
            updateStatus('æš‚æ— è½¨è¿¹æ•°æ®ï¼Œæ— æ³•å¼€å§‹å›æ”¾');
            return;
        }

        if (playbackState.isPlaying) {
            return;
        }

        // åœæ­¢ä¹‹å‰çš„å›æ”¾ï¼ˆä½†ä¸é‡ç½®currentIndexï¼‰
        if (playbackState.timer) {
            clearTimeout(playbackState.timer);
            playbackState.timer = null;
        }

        playbackState.isPlaying = true;
        // ä¸é‡ç½®currentIndexï¼Œä¿æŒå½“å‰æ’­æ”¾ä½ç½®

        // å¦‚æœæ’­æ”¾å…ƒç´ ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒä»¬
        if (!playbackState.marker || !playbackState.polyline) {
            // æ¸…é™¤ä¹‹å‰çš„å›æ”¾å…ƒç´ 
            if (playbackState.marker) {
                map.removeLayer(playbackState.marker);
            }
            if (playbackState.polyline) {
                map.removeLayer(playbackState.polyline);
            }

            // åˆ›å»ºå›æ”¾è½¨è¿¹çº¿
            const latlngs = playbackState.points.map(p => [p.lat, p.lng]);
            playbackState.polyline = L.polyline(latlngs, {
                color: '#FF6B6B',
                weight: 1,
                opacity: 0.6
            }).addTo(map);

            // åˆ›å»ºå›æ”¾æ ‡è®°
            const firstPoint = playbackState.points[0];
            playbackState.marker = L.circleMarker([firstPoint.lat, firstPoint.lng], {
                radius: 0.5,
                fillColor: '#FF6B6B',
                color: '#FFFFFF',
                weight: 0.5,
                opacity: 1,
                fillOpacity: 0.9
            }).addTo(map);

            // è‡ªé€‚åº”è§†é‡åˆ°è½¨è¿¹èŒƒå›´
            const bounds = playbackState.polyline.getBounds();
            if (bounds && bounds.isValid()) {
                map.fitBounds(bounds, { padding: [20, 20] });
            }
        }

        // æ›´æ–°æ’­æ”¾å™¨æ§åˆ¶çŠ¶æ€
        updatePlayerControls();
        
        // è®¾ç½®è¿›åº¦æ¡å’Œæ—¶é—´æ˜¾ç¤ºï¼ˆä¸é‡ç½®è¿›åº¦ï¼‰
        if (playerProgressSlider) {
            playerProgressSlider.disabled = false;
            playerProgressSlider.max = 100;
        }
        
        if (playerSpeedValue) {
            // æ˜¾ç¤ºæŒ‡æ•°å€æ•°
            const displaySpeed = playbackState.speed || 1;
            playerSpeedValue.textContent = displaySpeed + 'x';
        }

        // å¼€å§‹æ’­æ”¾
        playbackNextPoint();
        updateStatus('è½¨è¿¹å›æ”¾å¼€å§‹');
    }

    function stopPlayback() {
        playbackState.isPlaying = false;
        playbackState.currentIndex = 0;

        // æ¸…é™¤å®šæ—¶å™¨
        if (playbackState.timer) {
            clearTimeout(playbackState.timer);
            playbackState.timer = null;
        }

        // æ¸…é™¤å›æ”¾å…ƒç´ 
        if (playbackState.marker) {
            map.removeLayer(playbackState.marker);
            playbackState.marker = null;
        }
        if (playbackState.polyline) {
            map.removeLayer(playbackState.polyline);
            playbackState.polyline = null;
        }

        // åœæ­¢æ’­æ”¾æ—¶é‡ç½®è¿›åº¦æ¡å’Œæ—¶é—´æ˜¾ç¤º
        if (playerProgressSlider) {
            playerProgressSlider.value = 0;
        }
        if (playerTimeLabel) {
            playerTimeLabel.textContent = '00:00:00 / 00:00:00';
        }
        
        // æ›´æ–°æ’­æ”¾å™¨æ§åˆ¶çŠ¶æ€ï¼ˆå¦‚æœæ’­æ”¾å™¨å…ƒç´ å­˜åœ¨ï¼‰
        if (playbackPlayer) {
            updatePlayerControls();
        }
        
        updateStatus('è½¨è¿¹å›æ”¾å·²åœæ­¢');
    }

    function scheduleNextPlayback() {
        if (!playbackState.isPlaying || !playbackState.points || playbackState.currentIndex >= playbackState.points.length - 1) {
            if (playbackState.currentIndex >= playbackState.points.length - 1) {
                updateStatus('è½¨è¿¹å›æ”¾å®Œæˆ');
                // æ’­æ”¾å®Œæˆæ—¶ä¸æ¸…é™¤è½¨è¿¹çº¿ï¼Œåªåœæ­¢æ’­æ”¾å¹¶é‡ç½®çŠ¶æ€
                playbackState.isPlaying = false;
                playbackState.currentIndex = 0;
                
                // æ¸…é™¤å®šæ—¶å™¨
                if (playbackState.timer) {
                    clearTimeout(playbackState.timer);
                    playbackState.timer = null;
                }
                
                // åªæ¸…é™¤æ ‡è®°ï¼Œä¿ç•™è½¨è¿¹çº¿
                if (playbackState.marker) {
                    map.removeLayer(playbackState.marker);
                    playbackState.marker = null;
                }
                
                // é‡ç½®ä¸¤è¡Œæ—¶é—´æ˜¾ç¤ºï¼ˆä¿ç•™è¿›åº¦æ¡ä½ç½®ï¼‰
                const currentTimeElement = document.getElementById('currentTime');
                const totalTimeElement = document.getElementById('totalTime');
                if (currentTimeElement) currentTimeElement.textContent = '00:00:00';
                if (totalTimeElement) totalTimeElement.textContent = '00:00:00';
                
                // æ›´æ–°æ’­æ”¾å™¨æ§åˆ¶çŠ¶æ€
                if (playbackPlayer) {
                    updatePlayerControls();
                }
                
                // æ’­æ”¾å®Œæˆæ—¶ä¸éœ€è¦é‡ç½®æ—¶é—´æ»‘å—ï¼Œä¿æŒå½“å‰ä½ç½®
                // const playbackTimeSlider = document.getElementById('playbackTimeSlider');
                // if (playbackTimeSlider) {
                //     playbackTimeSlider.value = 0;
                //     playbackTimeSlider.disabled = true;
                // }
                
                // åŒæ­¥æ›´æ–°åº•éƒ¨å›ºå®šæ’­æ”¾æ§åˆ¶é¢æ¿
                // const playbackTimeSliderFixed = document.getElementById('playbackTimeSliderFixed');
                // if (playbackTimeSliderFixed) {
                //     playbackTimeSliderFixed.value = 0;
                //     playbackTimeSliderFixed.disabled = true;
                // }
            }
            return; // å¦‚æœæ˜¯æš‚åœï¼Œç›´æ¥è¿”å›ï¼Œä¸åœæ­¢æ’­æ”¾
        }

        const next = playbackState.points[playbackState.currentIndex + 1];
        const speed = playbackState.speed || 1;
        const delay = Math.max(100, Math.round(1000 / speed));

        playbackState.timer = setTimeout(() => {
            playbackState.currentIndex++;

            // æ›´æ–°æ ‡è®°ä½ç½®
            if (playbackState.marker) {
                playbackState.marker.setLatLng([next.lat, next.lng]);
                playbackState.marker.bindPopup(`å›æ”¾ç‚¹ ${playbackState.currentIndex + 1}<br>æ—¶é—´: ${next.timestamp}`);
            }

            // æ›´æ–°è½¨è¿¹çº¿
            if (playbackState.polyline) {
                const currentLatlngs = playbackState.points.slice(0, playbackState.currentIndex + 1).map(p => [p.lat, p.lng]);
                playbackState.polyline.setLatLngs(currentLatlngs);
            }

            // æ£€æŸ¥ç‚¹æ˜¯å¦åœ¨å±å¹•å¯è§èŒƒå›´å†…ï¼Œåªæœ‰ä¸åœ¨å¯è§èŒƒå›´å†…æ—¶æ‰å±…ä¸­
            const pointLatLng = L.latLng(next.lat, next.lng);
            const bounds = map.getBounds();
            
            // å¦‚æœç‚¹ä¸åœ¨å½“å‰åœ°å›¾è¾¹ç•Œå†…ï¼Œæˆ–è€…è·ç¦»è¾¹ç•Œå¤ªè¿‘ï¼ˆå°äºåœ°å›¾å®½é«˜çš„10%ï¼‰ï¼Œåˆ™å±…ä¸­
            if (!bounds.contains(pointLatLng)) {
                // ç‚¹å®Œå…¨ä¸åœ¨å±å¹•å†…ï¼Œéœ€è¦å±…ä¸­
                map.setView([next.lat, next.lng], map.getZoom(), {
                    animate: true,
                    duration: 0.3
                });
            } else {
                // ç‚¹åœ¨å±å¹•å†…ï¼Œæ£€æŸ¥æ˜¯å¦é è¿‘è¾¹ç•Œï¼ˆè·ç¦»è¾¹ç•Œå°äºåœ°å›¾å®½é«˜çš„10%ï¼‰
                const boundsPad = bounds.pad(-0.1); // å†…ç¼©10%çš„è¾¹ç•Œ
                if (!boundsPad.contains(pointLatLng)) {
                    // ç‚¹é è¿‘è¾¹ç•Œï¼Œå±…ä¸­æ˜¾ç¤º
                    map.setView([next.lat, next.lng], map.getZoom(), {
                        animate: true,
                        duration: 0.3
                    });
                }
                // ç‚¹åœ¨å±å¹•ä¸­å¤®åŒºåŸŸï¼Œä¸éœ€è¦å±…ä¸­
            }

            // æ›´æ–°è¿›åº¦æ¡å’Œæ—¶é—´æ˜¾ç¤º
            if (playerProgressSlider && playbackState.points.length > 0) {
                const percentage = Math.round((playbackState.currentIndex / (playbackState.points.length - 1)) * 100);
                playerProgressSlider.value = percentage;
            }
            
            if (playbackState.points.length > 0) {
                const currentPoint = playbackState.points[playbackState.currentIndex];
                const lastPoint = playbackState.points[playbackState.points.length - 1];
                
                if (currentPoint && lastPoint) {
                    const currentTime = formatTime(currentPoint.timestamp);
                    const totalTime = formatTime(lastPoint.timestamp);
                    
                    // æ›´æ–°ä¸¤è¡Œæ—¶é—´æ˜¾ç¤º
                    const currentTimeElement = document.getElementById('currentTime');
                    const totalTimeElement = document.getElementById('totalTime');
                    if (currentTimeElement) currentTimeElement.textContent = currentTime;
                    if (totalTimeElement) totalTimeElement.textContent = totalTime;
                }
            }

            // ç»§ç»­ä¸‹ä¸€ä¸ªç‚¹
            scheduleNextPlayback();
        }, delay);
    }

    // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤ºå‡½æ•°
    function formatTime(timestamp) {
        const date = parseTimestamp(timestamp);
        if (!date) return '00:00';
        
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        return hours + ':' + minutes;
    }

    // æ—§ç‰ˆæ—¶é—´æ»‘å—é…ç½®å‡½æ•° - å·²åºŸå¼ƒï¼Œä¿ç•™å…¼å®¹æ€§
    function configureTimeSlider() {
        const slider = document.getElementById('playbackTimeSlider');
        if (!slider) return;

        // ç©ºè½¨è¿¹æ—¶è®¾ç½®æ»‘å—ä¸ºç¦ç”¨çŠ¶æ€
        if (playbackState.points.length === 0) {
            slider.disabled = true;
            slider.min = 0;
            slider.max = 0;
            slider.value = 0;
            
            // åŒæ­¥æ›´æ–°åº•éƒ¨å›ºå®šæ’­æ”¾æ§åˆ¶é¢æ¿
            const sliderFixed = document.getElementById('playbackTimeSliderFixed');
            if (sliderFixed) {
                sliderFixed.disabled = true;
                sliderFixed.min = 0;
                sliderFixed.max = 0;
                sliderFixed.value = 0;
            }
            return;
        }

        slider.disabled = false;
        slider.min = 0;
        slider.max = playbackState.points.length - 1;
        // ä¸é‡ç½®æ»‘å—å€¼ï¼Œä¿æŒå½“å‰æ’­æ”¾ä½ç½®
        if (playbackState.currentIndex >= 0 && playbackState.currentIndex < playbackState.points.length) {
            slider.value = playbackState.currentIndex;
        }

        // åŒæ­¥æ›´æ–°åº•éƒ¨å›ºå®šæ’­æ”¾æ§åˆ¶é¢æ¿
        const sliderFixed = document.getElementById('playbackTimeSliderFixed');
        if (sliderFixed) {
            sliderFixed.disabled = false;
            sliderFixed.min = 0;
            sliderFixed.max = playbackState.points.length - 1;
            // ä¸é‡ç½®æ»‘å—å€¼ï¼Œä¿æŒå½“å‰æ’­æ”¾ä½ç½®
            if (playbackState.currentIndex >= 0 && playbackState.currentIndex < playbackState.points.length) {
                sliderFixed.value = playbackState.currentIndex;
            }
        }
    }

    function updateTimeSlider() {
        const slider = document.getElementById('playbackTimeSlider');
        if (slider) {
            slider.value = playbackState.currentIndex;
        }

        // åŒæ­¥æ›´æ–°åº•éƒ¨å›ºå®šæ’­æ”¾æ§åˆ¶é¢æ¿
        const sliderFixed = document.getElementById('playbackTimeSliderFixed');
        if (sliderFixed) {
            sliderFixed.value = playbackState.currentIndex;
        }
    }

    function updatePlaybackTimeLabel(timestamp) {
        const label = document.getElementById('playbackTimeLabel');
        if (label) {
            if (timestamp) {
                label.textContent = `æ—¶é—´: ${timestamp}`;
            } else {
                label.textContent = 'æ—¶é—´: --';
            }
        }

        // åŒæ­¥æ›´æ–°åº•éƒ¨å›ºå®šæ’­æ”¾æ§åˆ¶é¢æ¿
        const labelFixed = document.getElementById('playbackTimeLabelFixed');
        if (labelFixed) {
            if (timestamp) {
                labelFixed.textContent = `æ—¶é—´: ${timestamp}`;
            } else {
                labelFixed.textContent = 'æ—¶é—´: --';
            }
        }
    }

    // æµ‹é‡åŠŸèƒ½


    function startMeasureDistance() {
        if (!map) return;

        clearMeasureResult();

        measureState.isActive = true;
        measureState.mode = 'distance';

        // ç¦ç”¨æµ‹é‡æŒ‰é’®
        document.getElementById('measureDistanceBtn').classList.add('active');
        document.getElementById('measureAreaBtn').disabled = true;

        // ç¦ç”¨åœ°å›¾åŒå‡»ç¼©æ”¾åŠŸèƒ½
        map.doubleClickZoom.disable();

        // è®¾ç½®æ›´çµæ•çš„åŒå‡»æ£€æµ‹å‚æ•°
        if (map.options) {
            map.options.doubleClickZoom = false;
            map.options.tap = false; // ç¦ç”¨è§¦æ‘¸å»¶è¿Ÿ
        }

        // è®¾ç½®æ›´çµæ•çš„åŒå‡»æ£€æµ‹å‚æ•°
        if (map.options) {
            map.options.doubleClickZoom = false;
            map.options.tap = false; // ç¦ç”¨è§¦æ‘¸å»¶è¿Ÿ
        }

        // ç»‘å®šåœ°å›¾äº‹ä»¶
        map.on('click', handleMeasureClick);
        map.on('mousemove', handleMeasureMouseMove);
        map.on('contextmenu', handleDistanceMeasureRightClick); // å³é”®ç»“æŸæµ‹é‡

        updateStatus('æµ‹è·æ¨¡å¼å·²æ¿€æ´»ï¼Œç‚¹å‡»åœ°å›¾å¼€å§‹æµ‹é‡ï¼Œå³é”®ç»“æŸæµ‹é‡');
    }

    // å³é”®ç»“æŸæµ‹è·
    function handleDistanceMeasureRightClick(e) {
        // é˜»æ­¢å³é”®èœå•çš„é»˜è®¤è¡Œä¸º
        if (e && e.originalEvent) {
            e.originalEvent.preventDefault();
            e.originalEvent.stopPropagation();
        }

        // ç¡®ä¿è‡³å°‘æœ‰2ä¸ªç‚¹æ‰èƒ½å½¢æˆçº¿æ®µ
        if (measureState.points.length >= 2) {
            finishMeasureDistance();
        } else {
            alert('è¯·è‡³å°‘ç‚¹å‡»2ä¸ªç‚¹å½¢æˆçº¿æ®µåå†å³é”®ç»“æŸæµ‹é‡');
        }

        return false;
    }

    // å³é”®ç»“æŸæµ‹é¢
    function handleAreaMeasureRightClick(e) {
        // é˜»æ­¢å³é”®èœå•çš„é»˜è®¤è¡Œä¸º
        if (e && e.originalEvent) {
            e.originalEvent.preventDefault();
            e.originalEvent.stopPropagation();
        }

        // ç¡®ä¿è‡³å°‘æœ‰3ä¸ªç‚¹æ‰èƒ½å½¢æˆå¤šè¾¹å½¢
        if (measureState.points.length >= 3) {
            finishMeasureArea();
        } else {
            alert('è¯·è‡³å°‘ç‚¹å‡»3ä¸ªç‚¹å½¢æˆå¤šè¾¹å½¢åå†å³é”®ç»“æŸæµ‹é‡');
        }

        return false;
    }

    function startMeasureArea() {
        if (!map) return;

        clearMeasureResult();

        measureState.isActive = true;
        measureState.mode = 'area';

        // ç¦ç”¨æµ‹é‡æŒ‰é’®
        document.getElementById('measureAreaBtn').classList.add('active');
        document.getElementById('measureDistanceBtn').disabled = true;

        // ç¦ç”¨åœ°å›¾åŒå‡»ç¼©æ”¾åŠŸèƒ½
        map.doubleClickZoom.disable();

        // ç»‘å®šåœ°å›¾äº‹ä»¶
        map.on('click', handleMeasureClick);
        map.on('mousemove', handleMeasureMouseMove);
        map.on('contextmenu', handleAreaMeasureRightClick); // å³é”®ç»“æŸæµ‹é‡

        updateStatus('æµ‹é¢æ¨¡å¼å·²æ¿€æ´»ï¼Œç‚¹å‡»åœ°å›¾å¼€å§‹æµ‹é‡ï¼Œå³é”®ç»“æŸæµ‹é‡');
    }

    function handleMeasureClick(e) {
    if (!measureState.isActive) return;

    // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…å¹²æ‰°åŒå‡»æ£€æµ‹
    if (e && e.originalEvent) {
        e.originalEvent.stopPropagation();
    }

    const point = e.latlng;
    measureState.points.push(point);

    // åˆ›å»ºç‚¹æ ‡è®°
    const marker = L.circleMarker(point, {
        color: currentOutlineColor,
        fillColor: currentFillColor,
        fillOpacity: 1,
        radius: 0.5
    });

    measureLayerGroup.addLayer(marker);
    measureState.markers.push(marker);

    if (measureState.mode === 'distance') {
        // æµ‹è·é€»è¾‘
        if (measureState.points.length > 1) {
            const lastPoint = measureState.points[measureState.points.length - 2];
            const newLine = L.polyline([lastPoint, point], {
                color: currentOutlineColor,
                weight: 1,
                opacity: 1
            });

            measureLayerGroup.addLayer(newLine);
            measureState.lines.push(newLine);

            // æ›´æ–°è·ç¦»æ ‡ç­¾
            const distance = calculateDistance(lastPoint, point);
            const center = L.latLng(
                (lastPoint.lat + point.lat) / 2,
                (lastPoint.lng + point.lng) / 2
            );
            showDistanceLabel(center, distance);
        }
    } else if (measureState.mode === 'area') {
        // æµ‹é¢é€»è¾‘
        if (measureState.points.length > 1) {
            // åˆ›å»ºçº¿æ®µ
            const lastPoint = measureState.points[measureState.points.length - 2];
            const newLine = L.polyline([lastPoint, point], {
                color: currentOutlineColor,
                weight: 1,
                opacity: 1
            });

            measureLayerGroup.addLayer(newLine);
            measureState.lines.push(newLine);
        }

        // å½“æœ‰3ä¸ªæˆ–æ›´å¤šç‚¹æ—¶ï¼Œæ›´æ–°å¤šè¾¹å½¢ï¼ˆä½†ä¸æ˜¾ç¤ºæ ‡ç­¾ï¼‰
        if (measureState.points.length >= 3) {
            // ç§»é™¤ä¹‹å‰çš„å¤šè¾¹å½¢
            if (measureState.polygon) {
                measureLayerGroup.removeLayer(measureState.polygon);
            }

            // åˆ›å»ºæ–°çš„å¤šè¾¹å½¢
            measureState.polygon = L.polygon(measureState.points, {
                color: currentOutlineColor,
                weight: 1,
                opacity: 1,
                fillColor: currentFillColor,
                fillOpacity: 0.3
            });

            measureLayerGroup.addLayer(measureState.polygon);

            // æ³¨æ„ï¼šè¿™é‡Œä¸å†æ˜¾ç¤ºé¢ç§¯æ ‡ç­¾ï¼Œåªåœ¨åŒå‡»ç»“æŸæ—¶æ˜¾ç¤º
        }
    }
}

    function handleMeasureMouseMove(e) {
        if (!measureState.isActive || measureState.points.length === 0) return;

        const lastPoint = measureState.points[measureState.points.length - 1];
        const currentPoint = e.latlng;

        // ç§»é™¤ä¹‹å‰çš„ä¸´æ—¶çº¿
        if (measureState.tempLine) {
            measureLayerGroup.removeLayer(measureState.tempLine);
        }

        // åˆ›å»ºæ–°çš„ä¸´æ—¶çº¿
        let tempCoords = [lastPoint, currentPoint];

        // å¦‚æœæ˜¯é¢ç§¯æµ‹é‡ï¼Œæ·»åŠ é—­åˆçº¿
        if (measureState.mode === 'area' && measureState.points.length >= 2) {
            tempCoords.push(measureState.points[0]);
        }

        measureState.tempLine = L.polyline(tempCoords, {
            color: '#FFFF00',
            weight: 2,
            opacity: 0.8,
            dashArray: '5, 5'
        });

        measureLayerGroup.addLayer(measureState.tempLine);
    }

    function updateMeasurePolygon() {
        // ç§»é™¤ä¹‹å‰çš„å¤šè¾¹å½¢
        if (measureState.polygon) {
            measureLayerGroup.removeLayer(measureState.polygon);
        }

        // åˆ›å»ºæ–°çš„å¤šè¾¹å½¢
        measureState.polygon = L.polygon(measureState.points, {
            color: currentOutlineColor,
            weight: 1,
            opacity: 1,
            fillColor: currentFillColor,
            fillOpacity: 0.3
        });

        measureLayerGroup.addLayer(measureState.polygon);

        // è®¡ç®—å¹¶æ˜¾ç¤ºé¢ç§¯
        const area = calculatePolygonArea(measureState.points);
        const center = getPolygonCenter(measureState.points);
        showAreaLabel(center, area);
    }

    function finishMeasureDistance() {
        if (!measureState.isActive || measureState.mode !== 'distance') return;

        // ç§»é™¤äº‹ä»¶ç›‘å¬
        map.off('click', handleMeasureClick);
        map.off('mousemove', handleMeasureMouseMove);
        map.off('contextmenu', handleDistanceMeasureRightClick);

        // é‡æ–°å¯ç”¨åœ°å›¾åŒå‡»ç¼©æ”¾åŠŸèƒ½
        map.doubleClickZoom.enable();

        // æ¢å¤åœ°å›¾é€‰é¡¹è®¾ç½®
        if (map.options) {
            map.options.doubleClickZoom = true;
            map.options.tap = true;
        }

        // æ¢å¤åœ°å›¾é€‰é¡¹è®¾ç½®
        if (map.options) {
            map.options.doubleClickZoom = true;
            map.options.tap = true;
        }

        // ç§»é™¤ä¸´æ—¶çº¿
        if (measureState.tempLine) {
            measureLayerGroup.removeLayer(measureState.tempLine);
            measureState.tempLine = null;
        }

        // æ˜¾ç¤ºæ€»è·ç¦»
        if (measureState.points.length > 1) {
            const totalDistance = calculateTotalDistance();
            showTotalDistanceLabel(totalDistance);

            // é‡æ–°åˆ›å»ºæœ€ç»ˆçš„çº¿æ®µä»¥ç¡®ä¿æ˜¾ç¤ºæ­£ç¡®
            if (measureState.line) {
                measureLayerGroup.removeLayer(measureState.line);
            }

            measureState.line = L.polyline(measureState.points, {
                color: currentOutlineColor,
                weight: 1,
                opacity: 1
            });

            measureLayerGroup.addLayer(measureState.line);
        }

        // é‡ç½®çŠ¶æ€
        measureState.isActive = false;
        measureState.mode = '';

        // æ¢å¤æŒ‰é’®çŠ¶æ€
        document.getElementById('measureDistanceBtn').classList.remove('active');
        document.getElementById('measureAreaBtn').disabled = false;

        updateStatus('æµ‹è·å®Œæˆï¼Œæ€»è·ç¦»å·²æ˜¾ç¤º');
    }

    function finishMeasureArea() {
        if (!measureState.isActive || measureState.mode !== 'area') return;

        // ç§»é™¤äº‹ä»¶ç›‘å¬
        map.off('click', handleMeasureClick);
        map.off('mousemove', handleMeasureMouseMove);
        map.off('contextmenu', handleAreaMeasureRightClick);

        // é‡æ–°å¯ç”¨åœ°å›¾åŒå‡»ç¼©æ”¾åŠŸèƒ½
        map.doubleClickZoom.enable();

        // ç§»é™¤ä¸´æ—¶çº¿
        if (measureState.tempLine) {
            measureLayerGroup.removeLayer(measureState.tempLine);
            measureState.tempLine = null;
        }

        // å¦‚æœç‚¹æ•°>=3ï¼Œæ˜¾ç¤ºæ€»é¢ç§¯
        if (measureState.points.length >= 3) {
            // ç¡®ä¿å¤šè¾¹å½¢æ˜¯é—­åˆçš„
            const lastPoint = measureState.points[measureState.points.length - 1];
            const firstPoint = measureState.points[0];

            // æ£€æŸ¥æ˜¯å¦å·²ç»é—­åˆï¼ˆé¦–å°¾ç‚¹æ˜¯å¦ç›¸åŒï¼‰
            if (lastPoint.lat !== firstPoint.lat || lastPoint.lng !== firstPoint.lng) {
                // å¦‚æœæœªé—­åˆï¼Œå°†é¦–ç‚¹æ·»åŠ åˆ°æœ«å°¾ä»¥å½¢æˆé—­åˆå¤šè¾¹å½¢
                measureState.points.push(L.latLng(firstPoint.lat, firstPoint.lng));
            }

            const area = calculatePolygonArea(measureState.points);
            const center = getPolygonCenter(measureState.points);

            // æ¸…é™¤ä¹‹å‰çš„é¢ç§¯æ ‡ç­¾ï¼ˆå¦‚æœæœ‰ï¼‰
            if (measureState.areaLabel) {
                measureLayerGroup.removeLayer(measureState.areaLabel);
                measureState.areaLabel = null;
            }

            // æ˜¾ç¤ºæ€»é¢ç§¯æ ‡ç­¾ï¼ˆå¹³æ–¹ç±³+äº©æ•°ï¼‰
            showTotalAreaLabel(center, area);

            // é‡æ–°åˆ›å»ºæœ€ç»ˆçš„å¤šè¾¹å½¢ä»¥ç¡®ä¿é—­åˆ
            if (measureState.polygon) {
                measureLayerGroup.removeLayer(measureState.polygon);
            }

            measureState.polygon = L.polygon(measureState.points, {
                color: currentOutlineColor,
                weight: 1,
                opacity: 1,
                fillColor: currentFillColor,
                fillOpacity: 0.3
            });

            measureLayerGroup.addLayer(measureState.polygon);
        } else {
            // ç‚¹æ•°ä¸è¶³ï¼Œæ¸…é™¤æ‰€æœ‰æµ‹é‡ç»“æœ
            clearMeasureResult();
        }

        // é‡ç½®çŠ¶æ€
        measureState.isActive = false;
        measureState.mode = '';

        // æ¢å¤æŒ‰é’®çŠ¶æ€
        document.getElementById('measureAreaBtn').classList.remove('active');
        document.getElementById('measureDistanceBtn').disabled = false;

        updateStatus('æµ‹é¢å®Œæˆï¼Œæ€»é¢ç§¯å·²æ˜¾ç¤º');
    }

    // è·ç¦»è®¡ç®—
    function calculateDistance(point1, point2) {
        return point1.distanceTo(point2);
    }

    // å¤šè¾¹å½¢é¢ç§¯è®¡ç®—
    function calculatePolygonArea(points) {
        if (points.length < 3) return 0;

        // ä½¿ç”¨Turf.jsè®¡ç®—é¢ç§¯
        try {
            // å°†Leafletåæ ‡è½¬æ¢ä¸ºGeoJSONæ ¼å¼
            let coords = points.map(p => {
                if (p.lng !== undefined && p.lat !== undefined) {
                    return [p.lng, p.lat];
                } else if (Array.isArray(p) && p.length >= 2) {
                    // å¦‚æœå·²ç»æ˜¯æ•°ç»„æ ¼å¼ [lat, lng] æˆ– [lng, lat]
                    return [p[1], p[0]]; // å‡è®¾æ˜¯ [lat, lng] æ ¼å¼
                }
                return null;
            }).filter(coord => coord !== null);

            // ç¡®ä¿ç¯æ˜¯é—­åˆçš„ï¼ˆè‡³å°‘æœ‰4ä¸ªç‚¹ï¼Œé¦–å°¾ç›¸åŒï¼‰
            if (coords.length >= 3) {
                // å¦‚æœé¦–å°¾ä¸ç›¸åŒï¼Œé—­åˆç¯
                if (coords[0][0] !== coords[coords.length - 1][0] ||
                    coords[0][1] !== coords[coords.length - 1][1]) {
                    coords.push(coords[0]);
                }

                // ç¡®ä¿è‡³å°‘æœ‰4ä¸ªç‚¹ï¼ˆé—­åˆåï¼‰
                if (coords.length < 4) {
                    // å¦‚æœç‚¹æ•°ä¸è¶³4ä¸ªï¼Œå¤åˆ¶ç‚¹ç›´åˆ°è¾¾åˆ°4ä¸ª
                    while (coords.length < 4) {
                        coords.push(coords[coords.length - 1]);
                    }
                }
            } else if (coords.length === 2) {
                // å¦‚æœåªæœ‰2ä¸ªç‚¹ï¼Œå¤åˆ¶å®ƒä»¬å½¢æˆè‡³å°‘4ä¸ªç‚¹çš„ç¯
                coords.push(coords[1]);
                coords.push(coords[0]);
            } else if (coords.length === 1) {
                // å¦‚æœåªæœ‰1ä¸ªç‚¹ï¼Œå¤åˆ¶3æ¬¡å½¢æˆ4ä¸ªç‚¹çš„ç¯
                for (let k = 0; k < 3; k++) {
                    coords.push(coords[0]);
                }
            }

            const polygon = turf.polygon([coords]);
            const area = turf.area(polygon); // å¹³æ–¹ç±³

            return area;
        } catch (e) {
            console.error('è®¡ç®—å¤šè¾¹å½¢é¢ç§¯æ—¶å‡ºé”™:', e);
            return 0;
        }
    }

    // è·å–å¤šè¾¹å½¢ä¸­å¿ƒç‚¹
    function getPolygonCenter(points) {
        if (points.length === 0) return null;

        let latSum = 0, lngSum = 0;
        points.forEach(p => {
            latSum += p.lat;
            lngSum += p.lng;
        });

        return L.latLng(latSum / points.length, lngSum / points.length);
    }

    // è®¡ç®—æ€»è·ç¦»
    function calculateTotalDistance() {
        let total = 0;
        for (let i = 1; i < measureState.points.length; i++) {
            total += calculateDistance(measureState.points[i-1], measureState.points[i]);
        }
        return total;
    }

    // æ˜¾ç¤ºè·ç¦»æ ‡ç­¾
    function showDistanceLabel(latlng, distance) {
        const label = L.divIcon({
            className: 'measure-label',
            html: `<div style="background: rgba(255,255,255,0.9); color: #333; padding: 2px 6px; border-radius: 3px; font-size: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.3);">${distance.toFixed(2)} ç±³</div>`,
            iconSize: null,
            iconAnchor: [0, -10]
        });

        const marker = L.marker(latlng, { icon: label });
        measureLayerGroup.addLayer(marker);
        measureState.labels.push(marker);
    }

    // æ˜¾ç¤ºé¢ç§¯æ ‡ç­¾
    function showAreaLabel(latlng, area) {
        const label = L.divIcon({
            className: 'measure-label',
            html: `<div style="background: rgba(255,255,255,0.9); color: #333; padding: 2px 6px; border-radius: 3px; font-size: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.3);">${area.toFixed(2)} å¹³æ–¹ç±³</div>`,
            iconSize: null,
            iconAnchor: [0, -10]
        });

        const marker = L.marker(latlng, { icon: label });
        measureLayerGroup.addLayer(marker);
        measureState.areaLabel = marker;
    }

    // æ˜¾ç¤ºæ€»è·ç¦»æ ‡ç­¾
    function showTotalDistanceLabel(totalDistance) {
        if (measureState.points.length === 0) return;

        const lastPoint = measureState.points[measureState.points.length - 1];
        const label = L.divIcon({
            className: 'measure-total-label',
            html: `<div style="background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px; font-size: 14px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">æ€»è·ç¦»: ${totalDistance.toFixed(2)} ç±³</div>`,
            iconSize: null,
            iconAnchor: [0, -20]
        });

        const marker = L.marker(lastPoint, { icon: label });
        measureLayerGroup.addLayer(marker);
        measureState.labels.push(marker);
    }

    // æ˜¾ç¤ºæ€»é¢ç§¯æ ‡ç­¾
    function showTotalAreaLabel(latlng, area) {
        const areaInMu = area / 666.6667;
        const label = L.divIcon({
            className: 'measure-total-label',
            html: `<div style="background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px; font-size: 14px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.3); line-height: 1.4;">æ€»é¢ç§¯: ${area.toFixed(2)} å¹³æ–¹ç±³<br>${areaInMu.toFixed(2)} äº©</div>`,
            iconSize: null,
            iconAnchor: [0, -40]
        });

        const marker = L.marker(latlng, { icon: label });
        measureLayerGroup.addLayer(marker);
        measureState.labels.push(marker);
    }

    // æ¸…é™¤æµ‹é‡ç»“æœ
    function clearMeasureResult() {
        measureLayerGroup.clearLayers();
        measureState = {
            isActive: false,
            mode: '',
            points: [],
            tempLine: null,
            lines: [],
            markers: [],
            labels: [],
            polygon: null,
            areaLabel: null
        };

        // æ¢å¤æŒ‰é’®çŠ¶æ€
        document.getElementById('measureDistanceBtn').classList.remove('active');
        document.getElementById('measureAreaBtn').classList.remove('active');
        document.getElementById('measureDistanceBtn').disabled = false;
        document.getElementById('measureAreaBtn').disabled = false;

        // ç¡®ä¿é‡æ–°å¯ç”¨åœ°å›¾åŒå‡»ç¼©æ”¾åŠŸèƒ½
        if (map && map.doubleClickZoom) {
            map.doubleClickZoom.enable();

            // æ¢å¤åœ°å›¾é€‰é¡¹è®¾ç½®
            if (map.options) {
                map.options.doubleClickZoom = true;
                map.options.tap = true;
            }
        }
    }

    // åœ°å›¾ç±»å‹åˆ‡æ¢
    function toggleMapType() {
        console.log('toggleMapType called, currentMapType:', currentMapType);
        console.log('map:', map);
        console.log('currentBaseLayer:', currentBaseLayer);
        console.log('currentSatelliteLayer:', currentSatelliteLayer);

        if (!map) {
            console.error('Map not initialized');
            return;
        }

        if (!currentBaseLayer || !currentSatelliteLayer) {
            console.error('Layers not properly initialized');
            updateStatus('å›¾å±‚æœªæ­£ç¡®åˆå§‹åŒ–');
            return;
        }

        const mapTypeBtn = document.getElementById('mapTypeBtn');

        try {
            if (currentMapType === 'street') {
                console.log('Switching to satellite map');
                // åˆ‡æ¢åˆ°å«æ˜Ÿå›¾
                map.removeLayer(currentBaseLayer);
                map.addLayer(currentSatelliteLayer);
                currentMapType = 'satellite';
                mapTypeBtn.innerHTML = 'ğŸ›°ï¸ å«æ˜Ÿå›¾';
                mapTypeBtn.title = 'å½“å‰ï¼šå«æ˜Ÿå›¾ï¼Œç‚¹å‡»åˆ‡æ¢è¡—é“å›¾';
            } else {
                console.log('Switching to street map');
                // åˆ‡æ¢åˆ°è¡—é“å›¾
                map.removeLayer(currentSatelliteLayer);
                map.addLayer(currentBaseLayer);
                currentMapType = 'street';
                mapTypeBtn.innerHTML = 'ğŸ—ºï¸ è¡—é“å›¾';
                mapTypeBtn.title = 'å½“å‰ï¼šè¡—é“å›¾ï¼Œç‚¹å‡»åˆ‡æ¢å«æ˜Ÿå›¾';
            }

            updateStatus(`å·²åˆ‡æ¢åˆ°${currentMapType === 'street' ? 'è¡—é“å›¾' : 'å«æ˜Ÿå›¾'}`);
            console.log('Map type switched successfully to:', currentMapType);
        } catch (error) {
            console.error('Error switching map type:', error);
            updateStatus('åœ°å›¾åˆ‡æ¢å¤±è´¥: ' + error.message);
        }
    }

    // æ¸…ç©ºæ‰€æœ‰
    function clearAll() {
        clearMeasureResult();

        updateStatus('æµ‹è·æµ‹é¢å·²æ¸…ç©º');
    }

    // åˆ‡æ¢å·¦ä¾§é¢æ¿
    function toggleLeftPanel() {
        const panel = document.querySelector('.left-panel');
        const fixedToggle = document.getElementById('panelToggleFixed');

        if (panel.classList.contains('collapsed')) {
            // å±•å¼€é¢æ¿ - é¢æ¿å½“å‰æ˜¯æ”¶èµ·çš„ï¼Œç‚¹å‡»åè¦å±•å¼€ï¼Œæ‰€ä»¥æŒ‰é’®åº”æ˜¾ç¤ºä¸ºå±•å¼€å›¾æ ‡
            panel.classList.remove('collapsed');
            if(fixedToggle) {
                fixedToggle.innerHTML = 'â–¶â—€'; // å±•å¼€å›¾æ ‡
                fixedToggle.title = 'æ”¶ç¼©å·¥å…·æ ';
            }
        } else {
            // æ”¶èµ·é¢æ¿ - é¢æ¿å½“å‰æ˜¯å±•å¼€çš„ï¼Œç‚¹å‡»åè¦æ”¶èµ·ï¼Œæ‰€ä»¥æŒ‰é’®åº”æ˜¾ç¤ºä¸ºæ”¶ç¼©å›¾æ ‡
            panel.classList.add('collapsed');
            if(fixedToggle) {
                fixedToggle.innerHTML = 'â—€â–¶'; // æ”¶ç¼©å›¾æ ‡
                fixedToggle.title = 'å±•å¼€å·¥å…·æ ';
            }
        }
    }

    // åˆ‡æ¢æ ‡é¢˜æ 
    function toggleHeader() {
        const header = document.querySelector('.header');
        const toggle = document.getElementById('headerToggle');

        if (header.classList.contains('show')) {
            // éšè—æ ‡é¢˜
            header.classList.remove('show');
            header.style.display = 'none';
            toggle.innerHTML = 'â˜°';
            toggle.title = 'æ˜¾ç¤ºå·¥å…·æ ';
            toggle.style.display = 'block';
        } else {
            // æ˜¾ç¤ºæ ‡é¢˜
            header.classList.add('show');
            header.style.display = 'flex';
            toggle.innerHTML = 'âœ•';
            toggle.title = 'éšè—å·¥å…·æ ';
        }
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        initMap();
        bindTabEvents();
        bindColorPickerEvents();
        bindToolEvents();

        // ç»‘å®šé¢æ¿åˆ‡æ¢äº‹ä»¶
        const headerToggle = document.getElementById('headerToggle');
        const panelToggleFixed = document.getElementById('panelToggleFixed');

        if (headerToggle) {
            headerToggle.addEventListener('click', toggleHeader);
            headerToggle.style.display = 'block';
        }

        if (panelToggleFixed) {
            panelToggleFixed.addEventListener('click', toggleLeftPanel);
        }

        // åˆå§‹åŒ–é¢æ¿çŠ¶æ€
        const savedPanelState = localStorage.getItem('leftPanelCollapsed');
        const panel = document.querySelector('.left-panel');
        const fixedToggle = document.getElementById('panelToggleFixed');

        if (savedPanelState === 'true') {
            panel.classList.add('collapsed');
            if(fixedToggle) {
                fixedToggle.innerHTML = 'â—€â–¶'; // æ”¶ç¼©å›¾æ ‡
                fixedToggle.title = 'å±•å¼€å·¥å…·æ ';
            }
        } else {
            if(fixedToggle) {
                fixedToggle.innerHTML = 'â–¶â—€'; // å±•å¼€å›¾æ ‡
                fixedToggle.title = 'æ”¶ç¼©å·¥å…·æ ';
            }
        }

        // æ·»åŠ æ˜¾ç¤ºäº©æ•°å¤é€‰æ¡†çš„äº‹ä»¶ç›‘å¬å™¨
        const toggleLabelsCheckbox = document.getElementById('toggleLabelsCheckbox');
        if (toggleLabelsCheckbox) {
            toggleLabelsCheckbox.addEventListener('change', function() {
                const isChecked = this.checked;
                labelsEnabled = isChecked;
                console.log('æ ‡ç­¾æ˜¾ç¤ºçŠ¶æ€å·²æ›´æ”¹:', isChecked);

                // è·å–å®¹å™¨å…ƒç´ å¹¶åˆ‡æ¢labels-hiddenç±»
                const container = document.querySelector('.container') || document.body;

                if (isChecked) {
                    // å¯ç”¨æ ‡ç­¾ï¼šæ˜¾ç¤ºæ‰€æœ‰æ ‡ç­¾
                    console.log('å¯ç”¨æ ‡ç­¾æ˜¾ç¤º');
                    container.classList.remove('labels-hidden');

                    console.log('æ£€æŸ¥æ˜¯å¦æœ‰è½®å»“å›¾å±‚ç»„:', outlineLayerGroup);
                    if (outlineLayerGroup && outlineLayerGroup.getLayers) {
                        console.log('è½®å»“å›¾å±‚ç»„å­˜åœ¨ï¼Œè·å–å›¾å±‚æ•°é‡:', outlineLayerGroup.getLayers().length);
                        if (outlineLayerGroup.getLayers().length > 0) {
                            // æ¸…é™¤ç°æœ‰æ ‡ç­¾
                            labelLayerGroup.clearLayers();
                            console.log('å·²æ¸…é™¤ç°æœ‰æ ‡ç­¾ï¼Œå‡†å¤‡æ·»åŠ æ–°æ ‡ç­¾');

                            // ä¸ºæ¯ä¸ªè½®å»“æ·»åŠ æ ‡ç­¾
                            // ç¡®ä¿L.GeometryUtilå·²åŠ è½½
                            if (typeof L.GeometryUtil === 'undefined' || typeof L.GeometryUtil.geodesicArea !== 'function') {
                                console.log('ä½¿ç”¨Turf.jsè®¡ç®—é¢ç§¯');
                                // å°è¯•ä½¿ç”¨Turf.jsä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
                                if (typeof turf !== 'undefined') {
                                    console.log('ä½¿ç”¨Turf.jsè®¡ç®—é¢ç§¯');
                                    outlineLayerGroup.eachLayer(function(layer) {
                                        // è·å–å›¾å±‚ä¸­çš„å®é™…å‡ ä½•è¦ç´ è¿›è¡Œé¢ç§¯è®¡ç®—
                                        let layers = [];

                                        // å¦‚æœlayeræ˜¯LayerGroupæˆ–FeatureGroupï¼Œè·å–å…¶æ‰€æœ‰å­å›¾å±‚
                                        if (layer instanceof L.LayerGroup || layer instanceof L.FeatureGroup) {
                                            layers = layer.getLayers();
                                        } else {
                                            layers = layer.getLayers ? layer.getLayers() : [layer];
                                        }

                                        console.log('å›¾å±‚æ•°ç»„é•¿åº¦:', layers && Array.isArray(layers) ? layers.length : 0);
                                        if (layers && Array.isArray(layers) && layers.length > 0) {
                                            for (let j = 0; j < layers.length; j++) {
                                                const subLayer = layers[j];
                                                console.log('å¤„ç†å­å›¾å±‚:', subLayer);
                                                let latLngs;

                                                // æ ¹æ®å›¾å±‚ç±»å‹è·å–åæ ‡
                                                if (subLayer instanceof L.Polygon) {
                                                    latLngs = subLayer.getLatLngs();
                                                    console.log('å¤šè¾¹å½¢latLngs:', latLngs);
                                                } else if (subLayer instanceof L.MultiPolygon) {
                                                    // å¯¹äºMultiPolygonï¼Œå–ç¬¬ä¸€ä¸ªå¤šè¾¹å½¢
                                                    const multiLatLngs = subLayer.getLatLngs();
                                                    console.log('MultiPolygon latLngs:', multiLatLngs);
                                                    if (multiLatLngs && multiLatLngs.length > 0) {
                                                        latLngs = multiLatLngs[0];
                                                    }
                                                } else if (subLayer instanceof L.Rectangle) {
                                                    // å¯¹äºRectangleï¼Œè·å–å…¶è¾¹ç•Œåæ ‡
                                                    latLngs = subLayer.getLatLngs();
                                                    console.log('çŸ©å½¢latLngs:', latLngs);
                                                }

                                                if (latLngs) {
                                                    // ä½¿ç”¨Turf.jsè®¡ç®—é¢ç§¯
                                                    try {
                                                        // å¤„ç†å¤šè¾¹å½¢åæ ‡ï¼Œæ”¯æŒå¤–éƒ¨è¾¹ç•Œå’Œå†…éƒ¨å­”æ´
                                                        const processPolygon = (polyCoords) => {
                                                            if (!Array.isArray(polyCoords) || polyCoords.length === 0) {
                                                                return null;
                                                            }

                                                            // å¦‚æœæ˜¯å¤šè¾¹å½¢æ•°ç»„ï¼ˆå¤–éƒ¨è¾¹ç•Œ+å­”æ´ï¼‰ï¼Œåˆ†åˆ«å¤„ç†
                                                            let processedCoords = [];

                                                            // å¤„ç†å¤šè¾¹å½¢çš„æ¯ä¸ªç¯ï¼ˆç¬¬ä¸€ä¸ªæ˜¯å¤–éƒ¨è¾¹ç•Œï¼Œå…¶ä½™æ˜¯å­”æ´ï¼‰
                                                            for (let i = 0; i < polyCoords.length; i++) {
                                                                let ring = polyCoords[i];
                                                                if (!Array.isArray(ring)) {
                                                                    ring = [ring]; // å¦‚æœä¸æ˜¯æ•°ç»„ï¼Œè½¬æ¢ä¸ºæ•°ç»„
                                                                }

                                                                // å°†Leafletåæ ‡è½¬æ¢ä¸ºGeoJSONæ ¼å¼ [lng, lat]
                                                                let geoJsonRing = ring.map(latLng => {
                                                                    if (latLng.lat !== undefined && latLng.lng !== undefined) {
                                                                        return [latLng.lng, latLng.lat];
                                                                    } else if (Array.isArray(latLng) && latLng.length >= 2) {
                                                                        // å¦‚æœå·²ç»æ˜¯æ•°ç»„æ ¼å¼ [lat, lng] æˆ– [lng, lat]
                                                                        return [latLng[1], latLng[0]]; // å‡è®¾æ˜¯ [lat, lng] æ ¼å¼
                                                                    }
                                                                    return null;
                                                                }).filter(coord => coord !== null);

                                                                // ç¡®ä¿ç¯æ˜¯é—­åˆçš„ï¼ˆè‡³å°‘æœ‰4ä¸ªç‚¹ï¼Œé¦–å°¾ç›¸åŒï¼‰
                                                                if (geoJsonRing.length >= 3) {
                                                                    // å¦‚æœé¦–å°¾ä¸ç›¸åŒï¼Œé—­åˆç¯
                                                                    if (geoJsonRing[0][0] !== geoJsonRing[geoJsonRing.length - 1][0] ||
                                                                        geoJsonRing[0][1] !== geoJsonRing[geoJsonRing.length - 1][1]) {
                                                                        geoJsonRing.push(geoJsonRing[0]);
                                                                    }

                                                                    // ç¡®ä¿è‡³å°‘æœ‰4ä¸ªç‚¹ï¼ˆé—­åˆåï¼‰
                                                                    if (geoJsonRing.length < 4) {
                                                                        // å¦‚æœç‚¹æ•°ä¸è¶³4ä¸ªï¼Œå¤åˆ¶ç‚¹ç›´åˆ°è¾¾åˆ°4ä¸ª
                                                                        while (geoJsonRing.length < 4) {
                                                                            geoJsonRing.push(geoJsonRing[geoJsonRing.length - 1]);
                                                                        }
                                                                    }
                                                                } else if (geoJsonRing.length === 2) {
                                                                    // å¦‚æœåªæœ‰2ä¸ªç‚¹ï¼Œå¤åˆ¶å®ƒä»¬å½¢æˆè‡³å°‘4ä¸ªç‚¹çš„ç¯
                                                                    geoJsonRing.push(geoJsonRing[1]);
                                                                    geoJsonRing.push(geoJsonRing[0]);
                                                                } else if (geoJsonRing.length === 1) {
                                                                    // å¦‚æœåªæœ‰1ä¸ªç‚¹ï¼Œå¤åˆ¶3æ¬¡å½¢æˆ4ä¸ªç‚¹çš„ç¯
                                                                    for (let k = 0; k < 3; k++) {
                                                                        geoJsonRing.push(geoJsonRing[0]);
                                                                    }
                                                                }

                                                                processedCoords.push(geoJsonRing);
                                                            }

                                                            return processedCoords;
                                                        };

                                                        // æ ¹æ®latLngsçš„ç»“æ„å¤„ç†åæ ‡
                                                        let coordinates;
                                                        if (Array.isArray(latLngs) && latLngs.length > 0) {
                                                            if (Array.isArray(latLngs[0])) {
                                                                // å¦‚æœæ˜¯å¤šè¾¹å½¢æ•°ç»„ï¼ˆåŒ…å«å¤–éƒ¨è¾¹ç•Œå’Œå­”æ´ï¼‰
                                                                coordinates = processPolygon(latLngs);
                                                            } else {
                                                                // å¦‚æœæ˜¯å•ä¸ªå¤šè¾¹å½¢è¾¹ç•Œ
                                                                coordinates = processPolygon([latLngs]);
                                                            }
                                                        } else {
                                                            // å•ä¸ªå¤šè¾¹å½¢è¾¹ç•Œ
                                                            coordinates = processPolygon([latLngs]);
                                                        }

                                                        if (coordinates && coordinates.length > 0) {
                                                            const polygon = turf.polygon(coordinates);
                                                            const areaSqM = turf.area(polygon);
                                                            const areaMu = (areaSqM / 666.6667).toFixed(4); // è½¬æ¢ä¸ºäº©
                                                            console.log('ä½¿ç”¨Turf.jsè®¡ç®—å¾—åˆ°çš„é¢ç§¯:', areaSqM, 'å¹³æ–¹ç±³ (', areaMu, 'äº©)');
                                                            console.log('ä¸ºå›¾å±‚æ·»åŠ é¢ç§¯æ ‡ç­¾:', areaMu, 'äº©');
                                                            addAreaLabelToLayer(subLayer, `é¢ç§¯: ${areaMu}äº©`); // ä½¿ç”¨subLayerè€Œä¸æ˜¯layer
                                                        } else {
                                                            console.log('æ— æ³•å¤„ç†åæ ‡æ•°æ®ï¼Œè·³è¿‡æ­¤å›¾å±‚');
                                                        }
                                                    } catch (e) {
                                                        console.error('ä½¿ç”¨Turf.jsè®¡ç®—é¢ç§¯æ—¶å‡ºé”™:', e);
                                                    }
                                                } else {
                                                    console.log('æ— æ³•è·å–åæ ‡ï¼Œè·³è¿‡æ­¤å›¾å±‚');
                                                }
                                            }
                                        } else {
                                            console.log('å›¾å±‚æ•°ç»„ä¸ºç©ºæˆ–ä¸æ˜¯æ•°ç»„');
                                        }
                                    });
                                } else {
                                    console.error('Turf.jsä¹Ÿæœªå®šä¹‰ï¼Œæ— æ³•è®¡ç®—é¢ç§¯');
                                }
                            } else {
                                console.log('å¼€å§‹ä¸º', outlineLayerGroup.getLayers().length, 'ä¸ªè½®å»“æ·»åŠ æ ‡ç­¾');
                                let labelCount = 0;
                                outlineLayerGroup.eachLayer(function(layer) {
                                    console.log('å¤„ç†å›¾å±‚:', layer);
                                    // è·å–å›¾å±‚ä¸­çš„å®é™…å‡ ä½•è¦ç´ è¿›è¡Œé¢ç§¯è®¡ç®—
                                    let layers = [];

                                    // å¦‚æœlayeræ˜¯LayerGroupæˆ–FeatureGroupï¼Œè·å–å…¶æ‰€æœ‰å­å›¾å±‚
                                    if (layer instanceof L.LayerGroup || layer instanceof L.FeatureGroup) {
                                        layers = layer.getLayers();
                                    } else {
                                        layers = layer.getLayers ? layer.getLayers() : [layer];
                                    }

                                    console.log('å›¾å±‚æ•°ç»„é•¿åº¦:', layers && Array.isArray(layers) ? layers.length : 0);
                                    if (layers && Array.isArray(layers) && layers.length > 0) {
                                        for (let j = 0; j < layers.length; j++) {
                                            const subLayer = layers[j];
                                            console.log('å¤„ç†å­å›¾å±‚:', subLayer);
                                            let latLngs;

                                            // æ ¹æ®å›¾å±‚ç±»å‹è·å–åæ ‡
                                            if (subLayer instanceof L.Polygon) {
                                                latLngs = subLayer.getLatLngs();
                                                console.log('å¤šè¾¹å½¢latLngs:', latLngs);
                                            } else if (subLayer instanceof L.MultiPolygon) {
                                                // å¯¹äºMultiPolygonï¼Œå–ç¬¬ä¸€ä¸ªå¤šè¾¹å½¢
                                                const multiLatLngs = subLayer.getLatLngs();
                                                console.log('MultiPolygon latLngs:', multiLatLngs);
                                                if (multiLatLngs && multiLatLngs.length > 0) {
                                                    latLngs = multiLatLngs[0];
                                                }
                                            } else if (subLayer instanceof L.Rectangle) {
                                                // å¯¹äºRectangleï¼Œè·å–å…¶è¾¹ç•Œåæ ‡
                                                latLngs = subLayer.getLatLngs();
                                                console.log('çŸ©å½¢latLngs:', latLngs);
                                            }

                                            if (latLngs) {
                                                // æ£€æŸ¥L.GeometryUtilæ˜¯å¦å¯ç”¨ï¼Œå¦‚æœä¸å¯ç”¨åˆ™ä½¿ç”¨Turf.js
                                                if (typeof L.GeometryUtil !== 'undefined' && typeof L.GeometryUtil.geodesicArea === 'function') {
                                                    const areaSqM = L.GeometryUtil.geodesicArea(latLngs[0] || latLngs);
                                                    const areaMu = (areaSqM / 666.6667).toFixed(4); // è½¬æ¢ä¸ºäº©
                                                    console.log('ä½¿ç”¨L.GeometryUtilè®¡ç®—å¾—åˆ°çš„é¢ç§¯:', areaSqM, 'å¹³æ–¹ç±³ (', areaMu, 'äº©)');
                                                    console.log('ä¸ºå›¾å±‚æ·»åŠ é¢ç§¯æ ‡ç­¾:', areaMu, 'äº©');
                                                    addAreaLabelToLayer(subLayer, `é¢ç§¯: ${areaMu}äº©`); // ä½¿ç”¨subLayerè€Œä¸æ˜¯layer
                                                    labelCount++;
                                                } else {
                                                    console.log('L.GeometryUtilæœªå®šä¹‰æˆ–geodesicAreaæ–¹æ³•ä¸å­˜åœ¨ï¼Œå°è¯•ä½¿ç”¨Turf.js');
                                                    // ä½¿ç”¨Turf.jsè®¡ç®—é¢ç§¯
                                                    try {
                                                        // å¤„ç†å¤šè¾¹å½¢åæ ‡ï¼Œæ”¯æŒå¤–éƒ¨è¾¹ç•Œå’Œå†…éƒ¨å­”æ´
                                                        const processPolygon = (polyCoords) => {
                                                            if (!Array.isArray(polyCoords) || polyCoords.length === 0) {
                                                                return null;
                                                            }

                                                            // å¦‚æœæ˜¯å¤šè¾¹å½¢æ•°ç»„ï¼ˆå¤–éƒ¨è¾¹ç•Œ+å­”æ´ï¼‰ï¼Œåˆ†åˆ«å¤„ç†
                                                            let processedCoords = [];

                                                            // å¤„ç†å¤šè¾¹å½¢çš„æ¯ä¸ªç¯ï¼ˆç¬¬ä¸€ä¸ªæ˜¯å¤–éƒ¨è¾¹ç•Œï¼Œå…¶ä½™æ˜¯å­”æ´ï¼‰
                                                            for (let i = 0; i < polyCoords.length; i++) {
                                                                let ring = polyCoords[i];
                                                                if (!Array.isArray(ring)) {
                                                                    ring = [ring]; // å¦‚æœä¸æ˜¯æ•°ç»„ï¼Œè½¬æ¢ä¸ºæ•°ç»„
                                                                }

                                                                // å°†Leafletåæ ‡è½¬æ¢ä¸ºGeoJSONæ ¼å¼ [lng, lat]
                                                                let geoJsonRing = ring.map(latLng => {
                                                                    if (latLng.lat !== undefined && latLng.lng !== undefined) {
                                                                        return [latLng.lng, latLng.lat];
                                                                    } else if (Array.isArray(latLng) && latLng.length >= 2) {
                                                                        // å¦‚æœå·²ç»æ˜¯æ•°ç»„æ ¼å¼ [lat, lng] æˆ– [lng, lat]
                                                                        return [latLng[1], latLng[0]]; // å‡è®¾æ˜¯ [lat, lng] æ ¼å¼
                                                                    }
                                                                    return null;
                                                                }).filter(coord => coord !== null);

                                                                // ç¡®ä¿ç¯æ˜¯é—­åˆçš„ï¼ˆè‡³å°‘æœ‰4ä¸ªç‚¹ï¼Œé¦–å°¾ç›¸åŒï¼‰
                                                                if (geoJsonRing.length >= 3) {
                                                                    // å¦‚æœé¦–å°¾ä¸ç›¸åŒï¼Œé—­åˆç¯
                                                                    if (geoJsonRing[0][0] !== geoJsonRing[geoJsonRing.length - 1][0] ||
                                                                        geoJsonRing[0][1] !== geoJsonRing[geoJsonRing.length - 1][1]) {
                                                                        geoJsonRing.push(geoJsonRing[0]);
                                                                    }

                                                                    // ç¡®ä¿è‡³å°‘æœ‰4ä¸ªç‚¹ï¼ˆé—­åˆåï¼‰
                                                                    if (geoJsonRing.length < 4) {
                                                                        // å¦‚æœç‚¹æ•°ä¸è¶³4ä¸ªï¼Œå¤åˆ¶ç‚¹ç›´åˆ°è¾¾åˆ°4ä¸ª
                                                                        while (geoJsonRing.length < 4) {
                                                                            geoJsonRing.push(geoJsonRing[geoJsonRing.length - 1]);
                                                                        }
                                                                    }
                                                                } else if (geoJsonRing.length === 2) {
                                                                    // å¦‚æœåªæœ‰2ä¸ªç‚¹ï¼Œå¤åˆ¶å®ƒä»¬å½¢æˆè‡³å°‘4ä¸ªç‚¹çš„ç¯
                                                                    geoJsonRing.push(geoJsonRing[1]);
                                                                    geoJsonRing.push(geoJsonRing[0]);
                                                                } else if (geoJsonRing.length === 1) {
                                                                    // å¦‚æœåªæœ‰1ä¸ªç‚¹ï¼Œå¤åˆ¶3æ¬¡å½¢æˆ4ä¸ªç‚¹çš„ç¯
                                                                    for (let k = 0; k < 3; k++) {
                                                                        geoJsonRing.push(geoJsonRing[0]);
                                                                    }
                                                                }

                                                                processedCoords.push(geoJsonRing);
                                                            }

                                                            return processedCoords;
                                                        };

                                                        // æ ¹æ®latLngsçš„ç»“æ„å¤„ç†åæ ‡
                                                        let coordinates;
                                                        if (Array.isArray(latLngs) && latLngs.length > 0) {
                                                            if (Array.isArray(latLngs[0])) {
                                                                // å¦‚æœæ˜¯å¤šè¾¹å½¢æ•°ç»„ï¼ˆåŒ…å«å¤–éƒ¨è¾¹ç•Œå’Œå­”æ´ï¼‰
                                                                coordinates = processPolygon(latLngs);
                                                            } else {
                                                                // å¦‚æœæ˜¯å•ä¸ªå¤šè¾¹å½¢è¾¹ç•Œ
                                                                coordinates = processPolygon([latLngs]);
                                                            }
                                                        } else {
                                                            // å•ä¸ªå¤šè¾¹å½¢è¾¹ç•Œ
                                                            coordinates = processPolygon([latLngs]);
                                                        }

                                                        if (coordinates && coordinates.length > 0) {
                                                            const polygon = turf.polygon(coordinates);
                                                            const areaSqM = turf.area(polygon);
                                                            const areaMu = (areaSqM / 666.6667).toFixed(4); // è½¬æ¢ä¸ºäº©
                                                            console.log('ä½¿ç”¨Turf.jsè®¡ç®—å¾—åˆ°çš„é¢ç§¯:', areaSqM, 'å¹³æ–¹ç±³ (', areaMu, 'äº©)');
                                                            console.log('ä¸ºå›¾å±‚æ·»åŠ é¢ç§¯æ ‡ç­¾:', areaMu, 'äº©');
                                                            addAreaLabelToLayer(subLayer, `é¢ç§¯: ${areaMu}äº©`); // ä½¿ç”¨subLayerè€Œä¸æ˜¯layer
                                                            labelCount++;
                                                        } else {
                                                            console.log('æ— æ³•å¤„ç†åæ ‡æ•°æ®ï¼Œè·³è¿‡æ­¤å›¾å±‚');
                                                        }
                                                    } catch (e) {
                                                        console.error('ä½¿ç”¨Turf.jsè®¡ç®—é¢ç§¯æ—¶å‡ºé”™:', e);
                                                    }
                                                }
                                            } else {
                                                console.log('æ— æ³•è·å–åæ ‡ï¼Œè·³è¿‡æ­¤å›¾å±‚');
                                            }
                                        }
                                    } else {
                                        console.log('å›¾å±‚æ•°ç»„ä¸ºç©ºæˆ–ä¸æ˜¯æ•°ç»„');
                                    }
                                });
                                console.log('æ€»å…±å¤„ç†äº†', labelCount, 'ä¸ªæ ‡ç­¾');
                            }
                        } else {
                            console.log('è½®å»“å›¾å±‚ç»„ä¸­æ²¡æœ‰å›¾å±‚');
                        }
                    } else {
                        console.log('è½®å»“å›¾å±‚ç»„ä¸å­˜åœ¨æˆ–æ²¡æœ‰getLayersæ–¹æ³•');
                    }
                } else {
                    // ç¦ç”¨æ ‡ç­¾ï¼šéšè—æ‰€æœ‰æ ‡ç­¾
                    console.log('ç¦ç”¨æ ‡ç­¾æ˜¾ç¤ºï¼Œæ¸…é™¤æ‰€æœ‰æ ‡ç­¾');
                    if (labelLayerGroup) {
                        labelLayerGroup.clearLayers();
                        console.log('æ ‡ç­¾å›¾å±‚å·²æ¸…ç©ºï¼Œå½“å‰å›¾å±‚æ•°é‡:', labelLayerGroup.getLayers().length);
                    } else {
                        console.log('æ ‡ç­¾å›¾å±‚ç»„ä¸å­˜åœ¨');
                    }
                    container.classList.add('labels-hidden');
                }

                // ç¡®ä¿æ ‡ç­¾å›¾å±‚å§‹ç»ˆåœ¨æœ€ä¸Šå±‚
                if (labelLayerGroup) {
                    map.removeLayer(labelLayerGroup);
                    map.addLayer(labelLayerGroup);
                }
            });
        }

        updateStatus('é¡µé¢åŠ è½½å®Œæˆ');

        // æ·»åŠ ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—å³é”®èœå•çš„äº‹ä»¶ç›‘å¬
        document.addEventListener('click', function(e) {
            // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯å³é”®èœå•æœ¬èº«ï¼Œä¹Ÿä¸æ˜¯è·å–åœ°å€èœå•é¡¹ï¼Œåˆ™éšè—èœå•
            if (contextMenu && !contextMenu.contains(e.target) && 
                (!getAddressMenuItem || !getAddressMenuItem.contains(e.target))) {
                hideContextMenu();
            }
        });

        // é˜»æ­¢å³é”®èœå•å†…éƒ¨çš„ç‚¹å‡»äº‹ä»¶å†’æ³¡
        if (contextMenu) {
            contextMenu.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }
    });

    // å…¨å±€å‡½æ•°ä¾›HTMLè°ƒç”¨
    window.drawOutline = drawOutline;
    window.clearOutline = clearOutline;
    window.drawTrack = drawTrack;
    window.startPlayback = startPlayback;
    window.stopPlayback = stopPlayback;
</script>
</body>
</html>