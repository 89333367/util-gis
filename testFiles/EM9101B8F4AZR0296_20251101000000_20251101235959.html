<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Âá†‰ΩïÂõæÂΩ¢Â±ïÁ§∫Ê®°Êùø - LeafletÁâà</title>

    <!-- APIÂØÜÈí•ÈÖçÁΩÆ - Êú¨Âú∞Êñá‰ª∂ÁéØÂ¢É‰ΩøÁî®ÁôæÂ∫¶Âú∞ÂõæÔºåWebÁéØÂ¢É‰ΩøÁî®Â§©Âú∞Âõæ -->
    <script>
        // ÁôæÂ∫¶Âú∞ÂõæAPIÂØÜÈí•ÔºàÊú¨Âú∞Êñá‰ª∂ÁéØÂ¢É‰ΩøÁî®Ôºâ
        const BAIDU_MAP_AK = 'vMMZdKUVyHa5p2m5GZl2w4sNlF0dwr52';
        // Â§©Âú∞ÂõæAPIÂØÜÈí•ÔºàWebÁéØÂ¢É‰ΩøÁî®Ôºâ
        const TIANDITU_MAP_TK = '9ed3674d01dd7c129ab38e3c38bf651a';
    </script>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

    <!-- Â§©Âú∞Âõæ API -->
    <script>
        // Âä®ÊÄÅÂä†ËΩΩÂ§©Âú∞ÂõæAPIÔºåÈÅøÂÖçdocument.write
        const tiandituScript = document.createElement('script');
        tiandituScript.src = 'https://api.tianditu.gov.cn/api?v=4.0&tk=' + TIANDITU_MAP_TK;
        tiandituScript.async = true;
        document.head.appendChild(tiandituScript);
    </script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Turf.js Áî®‰∫éÂá†‰ΩïËÆ°ÁÆó -->
    <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

    <!-- WKTËß£ÊûêÂ∫ì -->
    <script src="https://unpkg.com/wellknown@0.5.0/wellknown.js"></script>

    <!-- Leaflet Geometry Util for area calculation -->
    <script src="https://unpkg.com/leaflet-geometryutil@0.11.0/src/leaflet.geometryutil.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f0f0;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            width: 100%;
            height: 100vh;
            margin: 0;
            background: white;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            position: relative;
        }
        
        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: transparent;
            color: white;
            padding: 0;
            text-align: left;
            z-index: 1000;
            display: none;
        }
        
        .header.show {
            display: block;
        }
        
        .header h1 {
            font-size: 18px;
            margin: 0;
            display: inline-block;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 12px;
            margin: 0 0 0 20px;
            display: inline-block;
        }
        
        .main-content {
            position: relative;
            height: 100vh;
            width: 100%;
        }
        
        .left-panel {
            width: 350px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
            position: absolute;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 1001;
            transition: transform 0.3s ease;
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
        }
        
        .left-panel.collapsed {
            transform: translateX(-350px);
            z-index: 9999; /* Á°Æ‰øùÈù¢ÊùøÂú®Âõ∫ÂÆöÊåâÈíÆ‰πã‰∏ã */
        }
        
        .left-panel.collapsed .panel-toggle {
            left: 100%;
            display: none !important;
        }
        

        
        .toolbar {
            padding: 15px;
            background: white;
            border-bottom: 1px solid #e9ecef;
        }
        
        .toolbar h3 {
            margin-bottom: 10px;
            color: #495057;
            font-size: 16px;
        }
        
        .tool-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .tool-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            background: #6c757d;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .tool-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }
        
        .tool-btn.active {
            background: #007bff;
        }
        
        .wkt-input {
            flex: 1;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }
        
        .tab-container {
            margin-bottom: 15px;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 8px;
            padding: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s ease;
            font-size: 13px;
            font-weight: 500;
        }
        
        .tab.active {
            background: #007bff;
            color: white;
            box-shadow: 0 2px 4px rgba(0,123,255,0.3);
        }
        
        .tab-content {
            display: none;
            margin-top: 15px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
            font-size: 13px;
        }
        
        .input-group textarea {
            width: 100%;
            height: 80px;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            resize: vertical;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            transition: border-color 0.3s ease;
        }
        
        .input-group textarea:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .button-group {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            flex: 1;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #1e7e34;
            transform: translateY(-1px);
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-primary:disabled {
            background: #6c757d;
            border-color: #6c757d;
        }
        
        .btn-secondary:disabled {
            background: #6c757d;
            border-color: #6c757d;
        }
        
        .btn-warning:disabled {
            background: #6c757d;
            border-color: #6c757d;
            color: white;
        }
        
        .color-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 6px;
        }
        
        .color-picker {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #dee2e6;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .color-picker:hover {
            border-color: #007bff;
            transform: scale(1.1);
        }
        
        .color-label {
            font-size: 12px;
            color: #495057;
            font-weight: 500;
        }
        
        .map-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: #e9ecef;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        

        
        .header-toggle {
            position: fixed;
            top: 10px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            z-index: 1001;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }
        
        .header-toggle:hover {
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .panel-toggle-fixed {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: #007bff;
            color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
            z-index: 10000;
        }
        
        .panel-toggle-fixed:hover {
            background: #0056b3;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .map-control-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .map-control-btn:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .playback-player {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            z-index: 1000;
            width: 600px;
            max-width: 90vw;
            overflow: hidden;
        }
        
        .player-header {
            background: #007bff;
            color: white;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .player-title {
            font-size: 14px;
            font-weight: 500;
        }
        
        .player-close {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s ease;
        }
        
        .player-close:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .player-controls {
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .player-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: #007bff;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .player-btn:hover {
            background: #0056b3;
            transform: scale(1.05);
        }
        
        .player-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .player-speed {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 8px;
        }
        
        .player-speed label {
            font-size: 12px;
            color: #495057;
            font-weight: 500;
        }
        
        .player-speed input[type="range"] {
            width: 80px;
        }
        
        .player-speed span {
            font-size: 12px;
            color: #6c757d;
            min-width: 25px;
        }
        
        .player-progress {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 8px;
        }
        
        .player-progress input[type="range"] {
            flex: 1;
            height: 4px;
            border-radius: 2px;
            background: #e9ecef;
            outline: none;
            -webkit-appearance: none;
        }
        
        .player-progress input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #007bff;
            cursor: pointer;
        }
        
        .player-progress span {
            font-size: 12px;
            color: #495057;
            font-weight: 500;
            min-width: 80px;
        }
        
        .speed-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .speed-control label {
            font-size: 12px;
            color: #495057;
            font-weight: 500;
        }
        
        .speed-control input[type="range"] {
            width: 80px;
        }
        
        .speed-value {
            font-size: 12px;
            color: #6c757d;
            min-width: 30px;
        }
        
        .time-slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .time-slider {
            flex: 1;
            height: 4px;
            border-radius: 2px;
            background: #e9ecef;
            outline: none;
            -webkit-appearance: none;
        }
        
        .time-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #007bff;
            cursor: pointer;
        }
        
        .time-label {
            font-size: 11px;
            color: #495057;
            font-weight: 500;
            min-width: 120px;
        }
        
        .status-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px 15px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            font-size: 12px;
            color: #495057;
        }
        
        .measure-result {
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1001;
        }
        
        .coordinate-info {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            font-size: 11px;
            color: #495057;
        }
        
        .hidden {
            display: none !important;
        }
        
        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
                height: auto;
            }
            
            .left-panel {
                width: 100%;
                height: 400px;
            }
            
            .map-container {
                height: 500px;
            }
        }
        
        .area-label {
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            pointer-events: none;
            z-index: 1000; /* Á°Æ‰øùÊ†áÁ≠æÂú®ÊúÄ‰∏äÂ±Ç */
        }
        
        /* ÈªòËÆ§ÈöêËóèÊ†áÁ≠æÂÆπÂô®‰∏ãÁöÑÊ†áÁ≠æ */
        .labels-hidden .area-label { display: none; }

        /* Âè≥ÈîÆËèúÂçïÊ†∑Âºè */
        .context-menu {
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 10000;
            min-width: 120px;
            display: none;
        }

        .context-menu-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 12px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }

        .context-menu-item:last-child {
            border-bottom: none;
        }

        .context-menu-item:hover {
            background-color: #f0f0f0;
        }

        .context-menu-item.disabled {
            color: #999;
            cursor: not-allowed;
        }

        .context-menu-item.disabled:hover {
            background-color: white;
        }

        /* CanvasËΩ®ËøπÁÇπ‰ºòÂåñÊ†∑Âºè */
        .leaflet-canvas {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            image-rendering: pixelated;
        }
        
        /* ÊûÅÂ∞èËΩ®ËøπÁÇπÊ†∑Âºè */
        .leaflet-marker-icon.tiny-point {
            width: 1px !important;
            height: 1px !important;
            min-width: 1px !important;
            min-height: 1px !important;
            border-radius: 50% !important;
            opacity: 0.8 !important;
        }
        
        /* CanvasÊ∏≤ÊüìÁöÑCircleMarker‰ºòÂåñ */
        .leaflet-canvas-pane circle {
            vector-effect: non-scaling-stroke;
            shape-rendering: optimizeSpeed;
        }
        
        /* ËΩ®ËøπÁÇπÊÇ¨ÂÅúÊó∂ÊòæÁ§∫ÊâãÂûãÊåáÈíà */
        .leaflet-marker-icon.tiny-point:hover {
            cursor: pointer !important;
        }
        
        /* CircleMarkerÊÇ¨ÂÅúÊó∂ÊòæÁ§∫ÊâãÂûãÊåáÈíà */
        .leaflet-canvas-pane circle:hover {
            cursor: pointer !important;
        }
        
        /* ÊôÆÈÄömarkerÊÇ¨ÂÅúÊó∂ÊòæÁ§∫ÊâãÂûãÊåáÈíà */
        .leaflet-marker-icon:hover {
            cursor: pointer !important;
        }
        
        /* ËΩ®ËøπÁÇπCanvasÂõæÂ±Ç‰ºòÂåñ */
        .leaflet-layer canvas {
            will-change: transform;
            transform: translateZ(0);
        }
    </style>
</head>
<body>
<div class="container">
    <div class="main-content">
        <div class="left-panel">

            <div class="toolbar">
                <h3>üõ†Ô∏è Â∑•ÂÖ∑Ê†è</h3>
                <div class="tool-buttons">
                    <button class="tool-btn" id="measureDistanceBtn" title="ÊµãË∑ù">üìè ÊµãË∑ù</button>
                    <button class="tool-btn" id="measureAreaBtn" title="ÊµãÈù¢">üìê ÊµãÈù¢</button>
                    <button class="tool-btn" id="mapTypeBtn" title="ÂàáÊç¢Âú∞Âõæ">üó∫Ô∏è Ë°óÈÅìÂõæ</button>
                    <button class="tool-btn" id="clearAllBtn" title="Ê∏ÖÁ©∫ÊâÄÊúâ">üóëÔ∏è Ê∏ÖÁ©∫</button>
                </div>
            </div>

            <div class="wkt-input">
                <div class="tab-container">
                    <div class="tabs">
                        <div class="tab active" data-tab="outline">ËΩÆÂªì</div>
                        <div class="tab" data-tab="track">ËΩ®Ëøπ</div>
                    </div>

                    <div class="tab-content active" id="outline-tab">
                        <div class="input-group">
                            <textarea id="outlineWkt" style="height: 400px;"
                                      placeholder="ËæìÂÖ•Â§öËæπÂΩ¢WKTÔºåÊîØÊåÅÂ§öË°åËæìÂÖ•ÔºåÊØèË°å‰∏Ä‰∏™WKT">GEOMETRYCOLLECTION EMPTY</textarea>
                        </div>
                        <div class="button-group">
                            <button class="btn btn-primary" onclick="drawOutline()">üéØ ÁªòÂà∂ËΩÆÂªì</button>
                            <button class="btn btn-secondary" onclick="clearOutline()">üßπ Ê∏ÖÈô§ËΩÆÂªì</button>
                        </div>
                        <div class="input-group">
                            <label><input type="checkbox" id="toggleLabelsCheckbox"> ÊòæÁ§∫‰∫©Êï∞</label>
                        </div>
                    </div>

                    <div class="tab-content" id="track-tab">
                        <div class="time-range-settings" style="margin-bottom:8px;font-size:12px;color:#333;">
                            <label>Êó∂Èó¥ËåÉÂõ¥ÈÄâÂèñ(ÁïôÁ©∫ÂàôÊòæÁ§∫ÊâÄÊúâËΩ®Ëøπ)</label>
                            <input type="text" id="timeRangeInput"
                                   style="width:100%;margin-top:4px;padding:4px;border:1px solid #ddd;border-radius:4px;font-size:12px;"
                                   placeholder="Ê†ºÂºèÔºöyyyy-MM-ddTHH:mm:ss - yyyy-MM-ddTHH:mm:ss">
                        </div>
                        <textarea id="trackTextarea"
                                  style="width:100%;height:400px;margin-bottom:10px;padding:8px;border:1px solid #ddd;border-radius:4px;font-family:monospace;resize:vertical;box-sizing:border-box;">20251101075920,124.504387,45.342025
20251101075930,124.504243,45.341985
20251101075940,124.503652,45.341865
20251101075950,124.503114,45.341694
20251101080000,124.502817,45.341689
20251101080010,124.502542,45.342064
20251101080020,124.502319,45.342370
20251101080030,124.502012,45.342488
20251101080040,124.501846,45.342633
20251101080050,124.501788,45.342669
20251101080100,124.501646,45.342732
20251101080110,124.501523,45.342723
20251101080120,124.501176,45.342718
20251101080130,124.500875,45.343054
20251101080140,124.500348,45.343603
20251101080150,124.499824,45.344164
20251101080200,124.499290,45.344746
20251101080210,124.498757,45.345367
20251101080220,124.498242,45.346002
20251101080230,124.498049,45.346552
20251101080240,124.498454,45.347215
20251101080250,124.498625,45.347900
20251101080300,124.498718,45.348550
20251101080310,124.498712,45.349030
20251101080320,124.498683,45.349368
20251101080330,124.498661,45.349797
20251101080340,124.498705,45.350375
20251101080350,124.498759,45.350973
20251101080400,124.498891,45.351561
20251101080410,124.499311,45.352187
20251101080420,124.499783,45.352811
20251101080430,124.500162,45.353467
20251101080440,124.500426,45.354135
20251101080450,124.500667,45.354797
20251101080500,124.500919,45.355480
20251101080510,124.501238,45.356100
20251101080520,124.501516,45.356662
20251101080530,124.502005,45.357202
20251101080540,124.502457,45.357825
20251101080550,124.503042,45.358306
20251101080600,124.503482,45.358779
20251101080610,124.503445,45.359374
20251101080620,124.502929,45.359970
20251101080630,124.502588,45.360376
20251101080640,124.502270,45.360729
20251101080650,124.501726,45.361076
20251101080700,124.500976,45.361247
20251101080710,124.500589,45.361714
20251101080720,124.500417,45.361975
20251101080730,124.500417,45.361975
20251101080740,124.500417,45.361975
20251101080750,124.500449,45.362271
20251101080800,124.500499,45.362833
20251101080810,124.500068,45.363417
20251101080820,124.499644,45.364001
20251101080830,124.499411,45.364590
20251101080840,124.499554,45.365230
20251101080850,124.499694,45.365896
20251101080900,124.499833,45.366570
20251101080910,124.499944,45.367253
20251101080920,124.500061,45.367948
20251101080930,124.500115,45.368659
20251101080940,124.500155,45.369365
20251101080950,124.500193,45.370064
20251101081000,124.500244,45.370756
20251101081010,124.500307,45.371430
20251101081020,124.500262,45.372102
20251101081030,124.500196,45.372771
20251101081040,124.500134,45.373423
20251101081050,124.500144,45.374126
20251101081100,124.500240,45.374770
20251101081110,124.500294,45.375217
20251101081120,124.500365,45.375874
20251101081130,124.500447,45.376537
20251101081140,124.500535,45.377228
20251101081150,124.500630,45.377986
20251101081200,124.500784,45.378614
20251101081210,124.501194,45.379199
20251101081220,124.501645,45.379842
20251101081230,124.502068,45.380447
20251101081240,124.502493,45.381046
20251101081250,124.502891,45.381609
20251101081300,124.503302,45.382187
20251101081310,124.503600,45.382441
20251101081320,124.503926,45.382531
20251101081330,124.504207,45.382582
20251101081340,124.504570,45.382658
20251101081350,124.505059,45.382744
20251101081400,124.505430,45.382800
20251101081410,124.505762,45.382875
20251101081420,124.506188,45.382954
20251101081430,124.506715,45.383047
20251101081440,124.507192,45.383131
20251101081450,124.507660,45.383217
20251101081500,124.508172,45.383308
20251101081510,124.508597,45.383372
20251101081520,124.509106,45.383430
20251101081530,124.509567,45.383394
20251101081540,124.510021,45.383267
20251101081550,124.510438,45.383130
20251101081600,124.510830,45.383138
20251101081610,124.511053,45.383408
20251101081620,124.511427,45.383662
20251101081630,124.511546,45.383968
20251101081640,124.511356,45.384340
20251101081650,124.511029,45.384728
20251101081700,124.510651,45.384979
20251101081710,124.510239,45.385218
20251101081720,124.509849,45.385446
20251101081730,124.509456,45.385643
20251101081740,124.509032,45.385848
20251101081750,124.508629,45.386040
20251101081800,124.508664,45.386310
20251101081810,124.508945,45.386580
20251101081820,124.509232,45.386872
20251101081830,124.509559,45.387189
20251101081840,124.509807,45.387434
20251101081850,124.510050,45.387673
20251101081900,124.510291,45.387929
20251101081910,124.510566,45.388259
20251101081920,124.510837,45.388605
20251101081930,124.511089,45.388948
20251101081940,124.511356,45.389222
20251101081950,124.511606,45.389476
20251101082000,124.511907,45.389816
20251101082010,124.512154,45.390083
20251101082020,124.512417,45.390375
20251101082030,124.512677,45.390665
20251101082040,124.512942,45.390963
20251101082050,124.513195,45.391234
20251101082100,124.513431,45.391504
20251101082110,124.513675,45.391788
20251101082120,124.513920,45.392063
20251101082130,124.513871,45.392323
20251101082140,124.513741,45.392482
20251101082150,124.513608,45.392674
20251101082200,124.513414,45.392915
20251101082210,124.513200,45.393177
20251101082220,124.512980,45.393415
20251101082230,124.512807,45.393601
20251101082240,124.512807,45.393602
20251101082250,124.512807,45.393602
20251101082300,124.512781,45.393632
20251101082310,124.512682,45.393738
20251101082320,124.512682,45.393738
20251101082330,124.512682,45.393739
20251101082340,124.512682,45.393739
20251101082350,124.512575,45.393876
20251101082400,124.512463,45.394155
20251101082410,124.512390,45.394477
20251101082420,124.512315,45.394803
20251101082430,124.512192,45.395132
20251101082440,124.512060,45.395461
20251101082450,124.511930,45.395780
20251101082500,124.511831,45.396085
20251101082510,124.511842,45.396425
20251101082520,124.511890,45.396711
20251101082530,124.512010,45.397040
20251101082540,124.512217,45.397352
20251101082550,124.512419,45.397644
20251101082600,124.512632,45.397943
20251101082610,124.512963,45.398172
20251101082620,124.513276,45.398298
20251101082630,124.513534,45.398390
20251101082640,124.513679,45.398461
20251101082650,124.513929,45.398562
20251101082700,124.514194,45.398556
20251101082710,124.514389,45.398356
20251101082720,124.514358,45.398177
20251101082730,124.514533,45.398056
20251101082740,124.514634,45.397977
20251101082750,124.514635,45.397977
20251101082800,124.514635,45.397977
20251101082810,124.514635,45.397977
20251101082820,124.514658,45.397962
20251101082830,124.514721,45.397919
20251101082840,124.514748,45.397902
20251101082850,124.514788,45.397878
20251101082900,124.514790,45.397877
20251101082910,124.514790,45.397877
20251101082920,124.514790,45.397877
20251101082930,124.514790,45.397877
20251101082940,124.514790,45.397877
20251101082950,124.514790,45.397877
20251101083000,124.514790,45.397877
20251101083010,124.514790,45.397877
20251101083020,124.514790,45.397877
20251101083030,124.514790,45.397877
20251101083040,124.514790,45.397877
20251101083050,124.514790,45.397877
20251101083100,124.514838,45.397849
20251101083110,124.514908,45.397808
20251101083120,124.514982,45.397764
20251101083130,124.515057,45.397720
20251101083140,124.515135,45.397673
20251101083150,124.515204,45.397630
20251101083200,124.515263,45.397593
20251101083210,124.515327,45.397552
20251101083220,124.515399,45.397508
20251101083230,124.515473,45.397463
20251101083240,124.515536,45.397422
20251101083250,124.515610,45.397372
20251101083300,124.515694,45.397317
20251101083310,124.515779,45.397260
20251101083320,124.515864,45.397203
20251101083330,124.515941,45.397150
20251101083340,124.516022,45.397098
20251101083350,124.516113,45.397044
20251101083400,124.516205,45.396994
20251101083410,124.516298,45.396945
20251101083420,124.516392,45.396894
20251101083430,124.516485,45.396842
20251101083440,124.516587,45.396785
20251101083450,124.516682,45.396732
20251101083500,124.516783,45.396675
20251101083510,124.516891,45.396616
20251101083520,124.516984,45.396557
20251101083530,124.517065,45.396516
20251101083540,124.517158,45.396466
20251101083550,124.517251,45.396417
20251101083600,124.517342,45.396369
20251101083610,124.517430,45.396321
20251101083620,124.517525,45.396270
20251101083630,124.517617,45.396222
20251101083640,124.517708,45.396173
20251101083650,124.517797,45.396126
20251101083700,124.517874,45.396085
20251101083710,124.517955,45.396039
20251101083720,124.518035,45.395995
20251101083730,124.518000,45.396016
20251101083740,124.518000,45.396015
20251101083750,124.518000,45.396015
20251101083800,124.518001,45.396015
20251101083810,124.518001,45.396015
20251101083820,124.518025,45.396001
20251101083830,124.518104,45.395955
20251101083840,124.518180,45.395912
20251101083850,124.518194,45.395906
20251101083900,124.518192,45.395907
20251101083910,124.518192,45.395907
20251101083920,124.518192,45.395907
20251101083930,124.518192,45.395907
20251101083940,124.518192,45.395907
20251101083950,124.518192,45.395907
20251101084000,124.518192,45.395907
20251101084010,124.518192,45.395907
20251101084020,124.518192,45.395907
20251101084030,124.518192,45.395907
20251101084040,124.518192,45.395907
20251101084050,124.518192,45.395907
20251101084100,124.518251,45.395873
20251101084110,124.518305,45.395844
20251101084120,124.518345,45.395822
20251101084130,124.518421,45.395779
20251101084140,124.518500,45.395736
20251101084150,124.518582,45.395689
20251101084200,124.518664,45.395642
20251101084210,124.518749,45.395595
20251101084220,124.518782,45.395577
20251101084230,124.518807,45.395562
20251101084240,124.518890,45.395515
20251101084250,124.518976,45.395468
20251101084300,124.519052,45.395425
20251101084310,124.519131,45.395380
20251101084320,124.519212,45.395334
20251101084330,124.519297,45.395286
20251101084340,124.519383,45.395237
20251101084350,124.519466,45.395190
20251101084400,124.519552,45.395141
20251101084410,124.519644,45.395089
20251101084420,124.519736,45.395037
20251101084430,124.519745,45.395032
20251101084440,124.519764,45.395022
20251101084450,124.519767,45.395021
20251101084500,124.519769,45.395020
20251101084510,124.519768,45.395020
20251101084520,124.519768,45.395020
20251101084530,124.519768,45.395020
20251101084540,124.519768,45.395020
20251101084550,124.519768,45.395020
20251101084600,124.519768,45.395020
20251101084610,124.519768,45.395020
20251101084620,124.519768,45.395020
20251101084630,124.519768,45.395020
20251101084640,124.519768,45.395020
20251101084650,124.519768,45.395020
20251101084700,124.519768,45.395020
20251101084710,124.519768,45.395020
20251101084720,124.519768,45.395020
20251101084730,124.519768,45.395020
20251101084740,124.519768,45.395020
20251101084750,124.519768,45.395020
20251101084800,124.519768,45.395020
20251101084810,124.519768,45.395020
20251101084820,124.519768,45.395020
20251101084830,124.519768,45.395020
20251101084840,124.519768,45.395020
20251101084850,124.519768,45.395020
20251101084900,124.519768,45.395020
20251101084910,124.519768,45.395020
20251101084920,124.519768,45.395020
20251101090657,124.519693,45.395061
20251101090707,124.519693,45.395061
20251101090717,124.519680,45.395068
20251101090727,124.519703,45.395055
20251101090737,124.519771,45.395114
20251101090747,124.519564,45.395278
20251101090757,124.519204,45.395480
20251101090807,124.518844,45.395682
20251101090817,124.518486,45.395885
20251101090827,124.518284,45.396022
20251101090837,124.518024,45.396165
20251101090847,124.517668,45.396346
20251101090857,124.517304,45.396544
20251101090907,124.517048,45.396680
20251101090917,124.516794,45.396809
20251101090927,124.516467,45.396985
20251101090937,124.516104,45.397184
20251101090947,124.515767,45.397406
20251101090957,124.515428,45.397622
20251101091007,124.515079,45.397834
20251101091017,124.514749,45.397971
20251101091027,124.514556,45.398046
20251101091037,124.514329,45.398212
20251101091047,124.514298,45.398239
20251101091057,124.514388,45.398350
20251101152839,124.513965,45.398579
20251101152849,124.513823,45.398495
20251101152859,124.513664,45.398408
20251101152909,124.513498,45.398350
20251101152919,124.513269,45.398294
20251101152929,124.513143,45.398263
20251101152939,124.512917,45.398139
20251101152949,124.512689,45.397986
20251101152959,124.512529,45.397794
20251101153009,124.512383,45.397578
20251101153019,124.512252,45.397393
20251101153029,124.512144,45.397237
20251101153039,124.512045,45.397079
20251101153049,124.511950,45.396897
20251101153059,124.511900,45.396706
20251101153109,124.511864,45.396515
20251101153119,124.511840,45.396331
20251101153129,124.511833,45.396131
20251101153139,124.511873,45.395962
20251101153149,124.511950,45.395742
20251101153159,124.512030,45.395542
20251101153209,124.512113,45.395347
20251101153219,124.512182,45.395171
20251101153229,124.512333,45.394773
20251101153239,124.512406,45.394431
20251101153249,124.512481,45.394130
20251101153259,124.512563,45.393915
20251101153309,124.512591,45.393701
20251101153319,124.512830,45.393567
20251101153329,124.512969,45.393448
20251101153339,124.513215,45.393174
20251101153349,124.513508,45.392831
20251101153359,124.513742,45.392495
20251101153409,124.513966,45.392224
20251101153419,124.513828,45.391949
20251101153429,124.513558,45.391648
20251101153439,124.513323,45.391372
20251101153449,124.513080,45.391102
20251101153459,124.512807,45.390811
20251101153509,124.512623,45.390597
20251101153519,124.512380,45.390326
20251101153529,124.512125,45.390039
20251101153539,124.511879,45.389773
20251101153549,124.511566,45.389422
20251101153559,124.511284,45.389142
20251101153609,124.510995,45.388806
20251101153619,124.510728,45.388460
20251101153629,124.510399,45.388044
20251101153639,124.510060,45.387673
20251101153649,124.509868,45.387487
20251101153659,124.509858,45.387475
20251101153709,124.509858,45.387475
20251101153719,124.509847,45.387464
20251101153729,124.509730,45.387345
20251101153739,124.509569,45.387196
20251101153749,124.509423,45.387058
20251101153759,124.509278,45.386911
20251101153809,124.509013,45.386644
20251101153819,124.508786,45.386422
20251101153829,124.508585,45.386160
20251101153839,124.508898,45.385917
20251101153849,124.509260,45.385741
20251101153859,124.509721,45.385517
20251101153909,124.510155,45.385271
20251101153919,124.510571,45.385030
20251101153929,124.510983,45.384766
20251101153939,124.511303,45.384437
20251101153949,124.511538,45.384003
20251101153959,124.511376,45.383620
20251101154009,124.511023,45.383377
20251101154019,124.510820,45.383119
20251101154029,124.510510,45.383099
20251101154039,124.510239,45.383191
20251101154049,124.509824,45.383315
20251101154059,124.509371,45.383423
20251101154109,124.508881,45.383403
20251101154119,124.508387,45.383336
20251101154129,124.508129,45.383296
20251101154139,124.508016,45.383276
20251101154149,124.507587,45.383197
20251101154159,124.507125,45.383115
20251101154209,124.506622,45.383027
20251101154219,124.506188,45.382949
20251101154229,124.505740,45.382869
20251101154239,124.505449,45.382799
20251101154249,124.505177,45.382755
20251101154259,124.504851,45.382704
20251101154309,124.504395,45.382617
20251101154319,124.504129,45.382560
20251101154541,124.503101,45.381889
20251101154551,124.502672,45.381279
20251101154601,124.502319,45.380785
20251101154611,124.502218,45.380636
20251101154621,124.502030,45.380404
20251101154631,124.501852,45.380125
20251101154641,124.501499,45.379611
20251101154651,124.501152,45.379119
20251101154701,124.500821,45.378649
20251101154711,124.500661,45.378198
20251101154721,124.500608,45.377700
20251101154731,124.500527,45.377076
20251101154741,124.500455,45.376484
20251101154751,124.500381,45.375952
20251101154801,124.500321,45.375411
20251101154811,124.500244,45.374846
20251101154821,124.500171,45.374258
20251101154831,124.500111,45.373706
20251101154841,124.500179,45.373140
20251101154851,124.500235,45.372504
20251101154901,124.500293,45.371916
20251101154911,124.500311,45.371328
20251101154921,124.500248,45.370736
20251101154931,124.500198,45.370091
20251101154941,124.500159,45.369441
20251101154951,124.500128,45.368772
20251101155001,124.500088,45.368104
20251101155011,124.499980,45.367423
20251101155021,124.499860,45.366724
20251101155031,124.499721,45.366036
20251101155041,124.499580,45.365401
20251101155051,124.499448,45.364780
20251101155101,124.499556,45.364121
20251101155111,124.499959,45.363576
20251101155121,124.500328,45.363082
20251101155131,124.500556,45.362562
20251101155141,124.500405,45.362014
20251101155151,124.500770,45.361489
20251101155201,124.501328,45.361113
20251101155211,124.502113,45.360889
20251101155221,124.502584,45.360370
20251101155231,124.503069,45.359827
20251101155241,124.503501,45.359261
20251101155251,124.503462,45.358694
20251101155301,124.503007,45.358283
20251101155311,124.502671,45.358018
20251101155321,124.502345,45.357680
20251101155331,124.502105,45.357325
20251101155341,124.501863,45.357046
20251101155351,124.501862,45.357045
20251101155401,124.501817,45.356996
20251101155411,124.501575,45.356708
20251101155421,124.501570,45.356703
20251101155431,124.501570,45.356703
20251101155441,124.501570,45.356702
20251101155451,124.501550,45.356679
20251101155501,124.501409,45.356486
20251101155511,124.501303,45.356277
20251101155521,124.501171,45.355939
20251101155531,124.501006,45.355657
20251101155541,124.501007,45.355658
20251101155551,124.501003,45.355651
20251101155601,124.500864,45.355312
20251101155611,124.500676,45.354809
20251101155621,124.500440,45.354139
20251101155631,124.500187,45.353493
20251101155641,124.500022,45.353165
20251101155651,124.499854,45.352902
20251101155701,124.499695,45.352643
20251101155711,124.499442,45.352321
20251101155721,124.499125,45.351921
20251101155731,124.498817,45.351310
20251101155741,124.498764,45.350718
20251101155751,124.498696,45.350241
20251101155801,124.498684,45.349795
20251101155811,124.498686,45.349283
20251101155821,124.498725,45.348698
20251101155831,124.498686,45.348245
20251101155841,124.498586,45.347576
20251101155851,124.498219,45.346827
20251101155901,124.497990,45.346362
20251101155911,124.498513,45.345656
20251101155921,124.499028,45.345053
20251101155931,124.499698,45.344306
20251101155941,124.500377,45.343579
20251101155951,124.500785,45.343145
20251101160001,124.501054,45.342853
20251101160011,124.501324,45.342113
20251101160021,124.501038,45.341751
20251101160031,124.500502,45.341435
20251101160041,124.500038,45.340801
20251101160051,124.499916,45.340258
20251101160101,124.500333,45.339884
20251101160111,124.500860,45.339320
20251101160121,124.501142,45.338732
20251101160131,124.501351,45.338212
20251101160141,124.501654,45.337497
20251101160151,124.501936,45.336823
20251101160201,124.502037,45.336217
20251101160211,124.502389,45.335579
20251101160221,124.502888,45.335254
20251101160231,124.502688,45.334817
20251101160241,124.502451,45.334318
20251101160251,124.502105,45.333575
20251101160301,124.502065,45.332923
20251101160311,124.502027,45.332225
20251101160321,124.502017,45.331662
20251101160331,124.502147,45.331192
20251101160341,124.502350,45.330671
20251101160351,124.502548,45.330204
20251101160401,124.502687,45.329961
20251101160411,124.502996,45.329688
20251101160421,124.503343,45.329375
20251101160431,124.503706,45.329030
20251101160441,124.504146,45.328664
20251101160451,124.504532,45.328421
20251101160501,124.504871,45.328224
20251101160511,124.505191,45.328055
20251101160521,124.505472,45.327905
20251101160531,124.505748,45.327760
20251101160541,124.506077,45.327593
20251101160551,124.506652,45.327292
20251101160601,124.507170,45.327012
20251101160611,124.507925,45.326587
20251101160621,124.508660,45.326189
20251101160631,124.509447,45.325762
20251101160641,124.510298,45.325276
20251101160651,124.511140,45.324812
20251101160701,124.512008,45.324351
20251101160711,124.512719,45.323970
20251101160721,124.513418,45.323576
20251101160731,124.514072,45.323223
20251101160741,124.514682,45.322882
20251101160751,124.514790,45.322820
20251101160801,124.515021,45.322714
20251101160811,124.515789,45.322298
20251101160821,124.516551,45.321882
20251101160831,124.517294,45.321477
20251101160841,124.517999,45.321094
20251101160851,124.518287,45.320935
20251101160901,124.518287,45.320935
20251101160911,124.518287,45.320935
20251101160921,124.518678,45.320731
20251101160931,124.519416,45.320333
20251101160941,124.520144,45.319939
20251101160951,124.520794,45.319480
20251101161001,124.521330,45.318906
20251101161011,124.521799,45.318276
20251101161021,124.522212,45.317714
20251101161031,124.522594,45.317208
20251101161041,124.523008,45.316675
20251101161051,124.523422,45.316124
20251101161101,124.523833,45.315581
20251101161111,124.524280,45.314981
20251101161121,124.524670,45.314463
20251101161131,124.524968,45.314049
20251101161141,124.525126,45.313804
20251101161151,124.525341,45.313568
20251101161201,124.525777,45.313004
20251101161211,124.526156,45.312517
20251101161221,124.526615,45.311897
20251101161231,124.527023,45.311330
20251101161241,124.527291,45.310981
20251101161251,124.527708,45.310393
20251101161301,124.527973,45.310045
20251101161311,124.528106,45.309842
20251101161321,124.528476,45.309392
20251101161331,124.528845,45.309103
20251101161341,124.529249,45.308702
20251101161351,124.529736,45.308191
20251101161401,124.530205,45.307605
20251101161411,124.530501,45.306969
20251101161421,124.530651,45.306474
20251101161431,124.530844,45.305825
20251101161441,124.531027,45.305220
20251101161451,124.531195,45.304712
20251101161501,124.531343,45.304148
20251101161511,124.531562,45.303460
20251101161521,124.531756,45.302789
20251101161531,124.531969,45.302102
20251101161541,124.532124,45.301510
20251101161551,124.532185,45.301052
20251101161601,124.532192,45.301004
20251101161611,124.532290,45.300579
20251101161621,124.532426,45.299844
20251101161631,124.532557,45.299089
20251101161641,124.532689,45.298361
20251101161651,124.532816,45.297670
20251101161701,124.532930,45.297040
20251101161711,124.533054,45.296339
20251101161721,124.533190,45.295594
20251101161731,124.533340,45.294746
20251101161741,124.533476,45.293985
20251101161751,124.533609,45.293215
20251101161801,124.533758,45.292416
20251101161811,124.533900,45.291615
20251101161821,124.534008,45.291010
20251101161831,124.534054,45.290637
20251101161841,124.534121,45.290316
20251101161851,124.534230,45.289668
20251101161901,124.534361,45.289055
20251101161911,124.534523,45.288380
20251101161921,124.534631,45.287923
20251101161931,124.534676,45.287728
20251101161941,124.534760,45.287343
20251101161951,124.534821,45.287082
20251101162001,124.534832,45.286936
20251101162011,124.534769,45.286753
20251101162021,124.534391,45.286764
20251101162031,124.533663,45.286791
20251101162041,124.532673,45.287167
20251101162051,124.531712,45.287341
20251101162101,124.530573,45.287515
20251101162111,124.529538,45.287652
20251101162121,124.528572,45.287814
20251101162131,124.528262,45.287884
20251101162141,124.528327,45.287894
20251101162151,124.528321,45.287888
20251101162201,124.528333,45.287896
20251101162211,124.528329,45.287893
20251101162221,124.528326,45.287891
20251101162231,124.528245,45.287872
20251101162241,124.528422,45.287832
20251101162251,124.528366,45.287925
20251101162301,124.528386,45.287998
20251101162311,124.528389,45.288006
20251101162321,124.528400,45.288039
20251101162331,124.528403,45.288050
20251101162447,124.528398,45.288095
20251101162457,124.528400,45.288099
20251101162507,124.528400,45.288102
20251101165439,124.528388,45.288057
20251101165449,124.528386,45.288050
20251101192524,124.528386,45.288052
20251101192630,124.528392,45.288070
20251101192640,124.528393,45.288073
20251101192650,124.528394,45.288077
20251101192700,124.528395,45.288081
20251101192710,124.528395,45.288081
20251101192720,124.528395,45.288081
20251101192730,124.528395,45.288081
20251101192740,124.528395,45.288081
20251101192750,124.528395,45.288081
20251101192800,124.528396,45.288084
20251101192810,124.528397,45.288087
20251101192820,124.528397,45.288090
20251101192830,124.528398,45.288092
20251101192840,124.528398,45.288094
20251101192850,124.528398,45.288095
20251101192900,124.528398,45.288094
20251101192910,124.528399,45.288096
20251101192920,124.528399,45.288098
20251101192930,124.528399,45.288099
20251101192940,124.528400,45.288100
20251101192950,124.528400,45.288100
20251101193000,124.528400,45.288102
20251101193010,124.528400,45.288102
20251101193349,124.528400,45.288102
20251101193359,124.528400,45.288102
20251101193409,124.528400,45.288102
20251101193419,124.528400,45.288102
20251101193429,124.528400,45.288102
20251101193439,124.528400,45.288102
20251101193449,124.528400,45.288102
20251101193543,124.528400,45.288103
20251101195428,124.528400,45.288101
20251101195438,124.528400,45.288100
20251101195448,124.528400,45.288100
20251101195458,124.528400,45.288100
20251101195508,124.528400,45.288100
20251101195518,124.528400,45.288100
20251101195528,124.528400,45.288100
20251101195538,124.528400,45.288101
20251101195635,124.528400,45.288101
20251101195645,124.528400,45.288101
20251101195938,124.528390,45.288052
20251101195948,124.528389,45.288048
20251101195958,124.528389,45.288048
20251101200008,124.528389,45.288048
20251101200018,124.528380,45.288005
20251101200028,124.528376,45.287973
20251101200038,124.528371,45.287944
20251101200048,124.528368,45.287911
20251101200058,124.528339,45.287865
20251101200108,124.528721,45.287765
20251101200118,124.528884,45.287741
20251101200128,124.529518,45.287659
20251101200138,124.530373,45.287531
20251101200148,124.531181,45.287405
20251101200158,124.532024,45.287277
20251101200208,124.532828,45.287109
20251101200218,124.533553,45.286822
20251101200228,124.534486,45.286751
20251101200238,124.534792,45.286769
20251101200248,124.534824,45.286971
20251101200258,124.534799,45.287121
20251101200308,124.534722,45.287471
20251101200318,124.534605,45.288015
20251101200328,124.534467,45.288610
20251101200338,124.534330,45.289178
20251101200348,124.534228,45.289632
20251101200358,124.534124,45.290201
20251101200408,124.534031,45.290819
20251101200418,124.533903,45.291567
20251101200428,124.533780,45.292260
20251101200438,124.533651,45.292970
20251101200448,124.533524,45.293669
20251101200458,124.533401,45.294328
20251101200508,124.533293,45.294986
20251101200518,124.533172,45.295684
20251101200528,124.533046,45.296355
20251101200538,124.532922,45.297034
20251101200548,124.532809,45.297679
20251101200558,124.532677,45.298421
20251101200608,124.532540,45.299158
20251101200618,124.532415,45.299858
20251101200628,124.532288,45.300557
20251101200638,124.532165,45.301248
20251101200648,124.532040,45.301851
20251101200658,124.531980,45.302153
20251101200708,124.531917,45.302272
20251101200718,124.531791,45.302664
20251101200728,124.531600,45.303306
20251101200738,124.531394,45.303970
20251101200748,124.531224,45.304568
20251101200758,124.531045,45.305150
20251101200808,124.530839,45.305833
20251101200818,124.530651,45.306458
20251101200828,124.530487,45.307032
20251101200838,124.530192,45.307619
20251101200848,124.529809,45.308105
20251101200858,124.529348,45.308597
20251101200908,124.528904,45.309041
20251101200918,124.528390,45.309462
20251101200928,124.527997,45.309974
20251101200938,124.527604,45.310549
20251101200948,124.527211,45.311089
20251101200958,124.526782,45.311651
20251101201008,124.526381,45.312218
20251101201018,124.525907,45.312828
20251101201028,124.525455,45.313421
20251101201038,124.525058,45.313935
20251101201048,124.524644,45.314483
20251101201058,124.524234,45.315029
20251101201108,124.523832,45.315573
20251101201118,124.523388,45.316161
20251101201128,124.522958,45.316736
20251101201138,124.522549,45.317279
20251101201148,124.522148,45.317803
20251101201158,124.521751,45.318341
20251101201208,124.521434,45.318769
20251101201218,124.520932,45.319350
20251101201228,124.520299,45.319847
20251101201238,124.519487,45.320279
20251101201248,124.518697,45.320711
20251101201258,124.517933,45.321125
20251101201308,124.517155,45.321547
20251101201318,124.516437,45.321940
20251101201328,124.515689,45.322346
20251101201338,124.514987,45.322723
20251101201348,124.514217,45.323131
20251101201358,124.513463,45.323546
20251101201408,124.512710,45.323968
20251101201418,124.511908,45.324396
20251101201428,124.511103,45.324830
20251101201438,124.510320,45.325260
20251101201448,124.509592,45.325680
20251101201458,124.508887,45.326060
20251101201508,124.508233,45.326419
20251101201518,124.507599,45.326767
20251101201528,124.506983,45.327115
20251101201538,124.506223,45.327520
20251101201548,124.505502,45.327886
20251101201558,124.504870,45.328225
20251101201608,124.504201,45.328621
20251101201618,124.503583,45.329140
20251101201628,124.503026,45.329662
20251101201638,124.502551,45.330204
20251101201648,124.502313,45.330769
20251101201658,124.502133,45.331232
20251101201708,124.502008,45.331797
20251101201718,124.502045,45.332365
20251101201728,124.502053,45.333038
20251101201738,124.501965,45.333591
20251101201748,124.501581,45.334147
20251101201758,124.501349,45.334693
20251101201808,124.501165,45.335296
20251101201818,124.500921,45.335871
20251101201828,124.500702,45.336426
20251101201838,124.500434,45.336973
20251101201848,124.500134,45.337455
20251101201858,124.499939,45.337796
20251101201908,124.499635,45.338289
20251101201918,124.499314,45.338834
20251101201928,124.499142,45.339400
20251101201938,124.498965,45.339712
20251101201948,124.499256,45.339929
20251101201958,124.499848,45.340206
20251101202008,124.500194,45.340372
20251101202018,124.500866,45.340706
20251101202028,124.501572,45.341054
20251101202038,124.502243,45.341346
20251101202048,124.502848,45.341615
20251101202058,124.503607,45.341856
20251101202108,124.504329,45.341998
20251101202118,124.504526,45.342071
20251101202128,124.504475,45.342068
20251101202138,124.504406,45.342128
20251101202148,124.504407,45.342127</textarea>
                        <div class="button-group">
                            <button id="drawTrackButton" class="btn btn-primary">üéØ ËΩ®Ëøπ</button>
                            <button id="showTrackPointsButton" class="btn btn-warning">üìç ÊâìÁÇπ</button>
                            <button id="clearTrackButton" class="btn btn-secondary">üßπ Ê∏ÖÁ©∫</button>
                        </div>
                        <!-- ËΩ®ËøπÈ¢úËâ≤ÈÄâÊã©Âô® -->
                        <div class="color-picker-container" style="margin-top:8px;">
                            <div style="display:flex;align-items:center;gap:8px;">
                                <div style="display:flex;align-items:center;gap:4px;">
                                    <label style="font-size:12px;">ËΩ®ËøπÁ∫øÈ¢úËâ≤:</label>
                                    <div id="trackLineColorPicker" class="color-picker"
                                         style="width:24px;height:24px;border:1px solid #ccc;cursor:pointer;background-color:#FF0000;"></div>
                                    <input type="color" id="trackLineColorInput" value="#FF0000" style="display:none;">
                                </div>
                                <div style="display:flex;align-items:center;gap:4px;">
                                    <label style="font-size:12px;">ËΩ®ËøπÁÇπÈ¢úËâ≤:</label>
                                    <div id="trackPointColorPicker" class="color-picker"
                                         style="width:24px;height:24px;border:1px solid #ccc;cursor:pointer;background-color:#68EAF3;"></div>
                                    <input type="color" id="trackPointColorInput" value="#68EAF3" style="display:none;">
                                </div>
                            </div>
                        </div>
                        <!-- ËΩ®ËøπÂõûÊîæ -->
                        <div class="split-section" style="margin-top:8px;">
                            <div class="playback-actions" style="display:flex;gap:8px;margin-bottom:8px;">
                                <button id="playbackToggleBtn" class="btn btn-primary">‚ñ∂Ô∏è ËΩ®ËøπÂõûÊîæ</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>

            <!-- Â∑•ÂÖ∑Ê†èÂàáÊç¢ÊåâÈíÆ -->
            <button class="panel-toggle-fixed" id="panelToggleFixed" title="Â±ïÂºÄ/Êî∂Áº©Â∑•ÂÖ∑Ê†è">‚óÄ‚ñ∂</button>

            <div class="status-info" id="statusInfo" style="display: none;">
                Â∞±Áª™
            </div>

            <div class="coordinate-info" id="coordinateInfo">
                ÁªèÂ∫¶: -, Á∫¨Â∫¶: -
            </div>

            <!-- Âè≥ÈîÆËèúÂçï -->
            <div class="context-menu" id="contextMenu">
                <div class="context-menu-item" id="getAddressMenuItem">üìç Ëé∑ÂèñÂú∞ÂùÄ</div>
            </div>

            <!-- ËΩ®ËøπÂõûÊîæÊí≠ÊîæÂô® -->
            <div class="playback-player" id="playbackPlayer" style="display: none;">
                <div class="player-header">
                    <span class="player-title">ËΩ®ËøπÂõûÊîæ</span>
                    <button class="player-close" id="playerCloseBtn" title="ÂÖ≥Èó≠">‚úï</button>
                </div>
                <div class="player-controls">
                    <button class="player-btn" id="playerPlayBtn" title="Êí≠Êîæ">‚ñ∂Ô∏è</button>
                    <button class="player-btn" id="playerStopBtn" title="ÂÅúÊ≠¢">‚èπÔ∏è</button>

                    <div class="player-speed">
                        <label>ÈÄüÂ∫¶:</label>
                        <input type="range" id="playerSpeedSlider" min="1" max="2048" step="1" value="1">
                        <span id="playerSpeedValue">1x</span>
                    </div>

                    <div class="player-progress">
                        <input type="range" id="playerProgressSlider" min="0" max="100" value="0">
                        <div id="playerTimeLabel" style="display: flex; flex-direction: column; align-items: center; min-width: 80px;">
                            <div id="currentTime" style="font-size: 12px; line-height: 1.2;">00:00:00</div>
                            <div id="totalTime" style="font-size: 10px; line-height: 1.2; color: #666;">00:00:00</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ÂÖ®Â±ÄÂèòÈáè
    let map;
    let currentMapType = 'street';
    let currentBaseLayer;
    let currentSatelliteLayer;

    // ÂõæÂ±ÇÁªÑ
    let outlineLayerGroup;
    let trackLayerGroup;
    let measureLayerGroup;
    let labelLayerGroup;

    // Ê†áÁ≠æÁõ∏ÂÖ≥
    let labelsEnabled = false;

    // ÂΩìÂâçÂá†‰ΩïÂõæÂΩ¢
    let currentOutline = null;
    let currentTrack = null;

    // ËΩ®ËøπÂõûÊîæÁõ∏ÂÖ≥
    let playbackState = {
        isPlaying: false,
        points: [],
        currentIndex: 0,
        speed: 1,
        marker: null,
        polyline: null,
        timer: null
    };

    // Êñ∞Êí≠ÊîæÂô®ÂÖÉÁ¥†
    let playbackPlayer;
    let playerCloseBtn;
    let playerPlayBtn;
    let playerStopBtn;
    let playerSpeedSlider;
    let playerSpeedValue;
    let playerProgressSlider;
    let playerTimeLabel;

    // ÊµãÈáèÁõ∏ÂÖ≥
    let measureState = {
        isActive: false,
        mode: '',
        points: [],
        tempLine: null,
        lines: [],
        markers: [],
        labels: [],
        polygon: null,
        areaLabel: null
    };

    // È¢úËâ≤ÈÖçÁΩÆ
    let currentOutlineColor = "#FFD700";
    let currentFillColor = "#FFFF00";
    let currentFillOpacity = 0.8;
    let currentTrackLineColor = "#FF0000";
    let currentTrackPointColor = "#68EAF3";

    // Áä∂ÊÄÅ‰ø°ÊÅØÂÆöÊó∂Âô®
    let statusMessageTimer = null;

    // Âè≥ÈîÆËèúÂçïÁõ∏ÂÖ≥
    let contextMenu = null;
    let getAddressMenuItem = null;
    let lastRightClickLatLng = null;

    // Â§öËæπÂΩ¢È¢úËâ≤ÊñπÊ°à
    const polygonColors = [
        { outline: "#FFD700", fill: "#FFFF00", opacity: 0.6 },
        { outline: "#FF0000", fill: "#FF6666", opacity: 0.6 },
        { outline: "#00FF00", fill: "#66FF66", opacity: 0.6 },
        { outline: "#0000FF", fill: "#6666FF", opacity: 0.6 },
        { outline: "#FF00FF", fill: "#FF66FF", opacity: 0.6 },
        { outline: "#00FFFF", fill: "#66FFFF", opacity: 0.6 },
        { outline: "#FFA500", fill: "#FFCC66", opacity: 0.6 },
        { outline: "#800080", fill: "#CC66CC", opacity: 0.6 },
        { outline: "#008000", fill: "#66CC66", opacity: 0.6 },
        { outline: "#800000", fill: "#CC6666", opacity: 0.6 }
    ];

    // ÊòæÁ§∫Êí≠ÊîæÂô®
    function showPlaybackPlayer() {
        if (playbackPlayer) {
            playbackPlayer.style.display = 'block';
            updatePlayerControls();
            
            // ÂêåÊ≠•ÊóßÁâàÊéßÂà∂Èù¢ÊùøÁä∂ÊÄÅÔºå‰øùÊåÅÂΩìÂâçÊí≠Êîæ‰ΩçÁΩÆ
            if (playerProgressSlider && playbackState.points.length > 0) {
                playerProgressSlider.disabled = false;
                playerProgressSlider.max = 100;
                // ‰∏çÈáçÁΩÆËøõÂ∫¶Êù°ÂÄºÔºå‰øùÊåÅÂΩìÂâçÊí≠Êîæ‰ΩçÁΩÆ
                if (playbackState.points.length > 0 && playbackState.currentIndex >= 0) {
                    const percentage = Math.round((playbackState.currentIndex / (playbackState.points.length - 1)) * 100);
                    playerProgressSlider.value = percentage;
                }
            }
            if (playerTimeLabel && playbackState.points.length > 0) {
                // Ê†πÊçÆÂΩìÂâçÊí≠Êîæ‰ΩçÁΩÆÊõ¥Êñ∞Êó∂Èó¥ÊòæÁ§∫
                if (playbackState.currentIndex >= 0 && playbackState.currentIndex < playbackState.points.length) {
                    const currentPoint = playbackState.points[playbackState.currentIndex];
                    const lastPoint = playbackState.points[playbackState.points.length - 1];
                    
                    if (currentPoint && lastPoint) {
                        function formatTime(timestamp) {
                            const date = parseTimestamp(timestamp);
                            if (!date) return '00:00:00';
                            
                            const hours = date.getHours().toString().padStart(2, '0');
                            const minutes = date.getMinutes().toString().padStart(2, '0');
                            const seconds = date.getSeconds().toString().padStart(2, '0');
                            return hours + ':' + minutes + ':' + seconds;
                        }
                        
                        const currentTime = formatTime(currentPoint.timestamp);
                        const totalTime = formatTime(lastPoint.timestamp);
                        
                        // ÂàÜÂà´Êõ¥Êñ∞‰∏§Ë°åÊó∂Èó¥ÊòæÁ§∫
                        const currentTimeElement = document.getElementById('currentTime');
                        const totalTimeElement = document.getElementById('totalTime');
                        
                        if (currentTimeElement) currentTimeElement.textContent = currentTime;
                        if (totalTimeElement) totalTimeElement.textContent = totalTime;
                    }
                }
            }
        }
    }

    // ÈöêËóèÊí≠ÊîæÂô®
    function hidePlaybackPlayer() {
        if (playbackPlayer) {
            playbackPlayer.style.display = 'none';
            // Âè™ÊöÇÂÅúÊí≠ÊîæÔºå‰∏çÈáçÁΩÆËøõÂ∫¶
            if (playbackState.isPlaying) {
                pausePlayback();
            }
            
            // ÈáçÁΩÆÊí≠ÊîæÂô®ÊéßÂà∂Áä∂ÊÄÅ
            updatePlayerControls();
        }
    }

    // Â∫îÁî®Êó∂Èó¥ËåÉÂõ¥ËøáÊª§
    function applyTimeRangeFilter() {
        const timeRangeText = document.getElementById('timeRangeInput').value.trim();
        
        if (!timeRangeText) {
            // Ê≤°ÊúâÊó∂Èó¥ËåÉÂõ¥Ôºå‰ΩøÁî®ÊâÄÊúâÁÇπ
            playbackState.filteredPoints = playbackState.points.slice();
            return;
        }
        
        // Ëß£ÊûêÊó∂Èó¥ËåÉÂõ¥
        const timeRangeMatch = timeRangeText.match(/^([\d-]+T[\d:]+)\s*-\s*([\d-]+T[\d:]+)$/);
        if (!timeRangeMatch) {
            // Ê†ºÂºè‰∏çÊ≠£Á°ÆÔºå‰ΩøÁî®ÊâÄÊúâÁÇπ
            playbackState.filteredPoints = playbackState.points.slice();
            return;
        }
        
        const startTimeStr = timeRangeMatch[1];
        const endTimeStr = timeRangeMatch[2];
        
        const startTime = new Date(startTimeStr);
        const endTime = new Date(endTimeStr);
        
        if (isNaN(startTime.getTime()) || isNaN(endTime.getTime())) {
            // Êó∂Èó¥Ëß£ÊûêÂ§±Ë¥•Ôºå‰ΩøÁî®ÊâÄÊúâÁÇπ
            playbackState.filteredPoints = playbackState.points.slice();
            return;
        }
        
        // ËøáÊª§ËΩ®ËøπÁÇπ
        playbackState.filteredPoints = playbackState.points.filter(point => {
            const pointTime = parseTimestamp(point.timestamp);
            return pointTime && pointTime >= startTime && pointTime <= endTime;
        });
        
        // Â¶ÇÊûúËøáÊª§ÂêéÁÇπÊï∞‰∏çË∂≥Ôºå‰ΩøÁî®ÊâÄÊúâÁÇπ
        if (playbackState.filteredPoints.length < 2) {
            playbackState.filteredPoints = playbackState.points.slice();
        }
    }

    // ÂàáÊç¢Êí≠ÊîæÁä∂ÊÄÅ
    function togglePlayback() {
        if (playbackState.isPlaying) {
            pausePlayback();
        } else {
            // ÂºÄÂßãÊí≠ÊîæÂâçÂ∫îÁî®Êó∂Èó¥ËåÉÂõ¥ËøáÊª§
            applyTimeRangeFilter();
            startPlayback();
        }
        
        // Êõ¥Êñ∞Êí≠ÊîæÂô®ÊéßÂà∂Áä∂ÊÄÅ
        updatePlayerControls();
    }

    // Êõ¥Êñ∞Êí≠ÊîæÂô®ÊéßÂà∂Áä∂ÊÄÅ
    function updatePlayerControls() {
        const hasTrack = playbackState.points && playbackState.points.length > 0;
        
        if (playerPlayBtn) playerPlayBtn.disabled = !hasTrack;
        if (playerStopBtn) playerStopBtn.disabled = !hasTrack;
        if (playerSpeedSlider) playerSpeedSlider.disabled = !hasTrack;
        if (playerProgressSlider) playerProgressSlider.disabled = !hasTrack;
        
        if (playbackState.isPlaying) {
            if (playerPlayBtn) playerPlayBtn.innerHTML = '‚è∏Ô∏è';
            if (playerPlayBtn) playerPlayBtn.title = 'ÊöÇÂÅú';
        } else {
            if (playerPlayBtn) playerPlayBtn.innerHTML = '‚ñ∂Ô∏è';
            if (playerPlayBtn) playerPlayBtn.title = 'Êí≠Êîæ';
        }
    }

    // ÂàùÂßãÂåñÂú∞Âõæ
    function initMap() {
        console.log('initMap called');

        // ÂàõÂª∫Âú∞Âõæ
        map = L.map('map', {
            center: [39.9042, 116.4074], // Âåó‰∫¨
            zoom: 11,
            zoomControl: false,
            attributionControl: false
        });

        console.log('Map created:', map);

        // ‰∏çÊ∑ªÂä†Áº©ÊîæÊéß‰ª∂Ôºå‰ΩøÁî®ÊªöËΩÆÁº©ÊîæÂú∞Âõæ

        // ÂàùÂßãÂåñÂõæÂ±ÇÁªÑ
        outlineLayerGroup = L.layerGroup().addTo(map);
        trackLayerGroup = L.layerGroup().addTo(map);
        measureLayerGroup = L.layerGroup().addTo(map);
        // ÂÖà‰∏çÊ∑ªÂä†Ê†áÁ≠æÂõæÂ±ÇÔºåÁ®çÂêéÁ°Æ‰øùÂÆÉÂú®ÊúÄ‰∏äÂ±Ç
        labelLayerGroup = L.layerGroup();
        map.addLayer(labelLayerGroup);

        console.log('Layer groups created');

        // ÂàùÂßãÂåñÂú∞ÂõæÁ±ªÂûã
        currentMapType = 'satellite';

        // Ê∑ªÂä†Âü∫Á°ÄÂõæÂ±Ç
        addBaseLayers();

        // ÁªëÂÆö‰∫ã‰ª∂
        bindMapEvents();

        // Êõ¥Êñ∞Áä∂ÊÄÅ
        updateStatus('Âú∞ÂõæÂàùÂßãÂåñÂÆåÊàê');

        console.log('initMap completed');

        // Á°Æ‰øùÊ†áÁ≠æÂõæÂ±ÇÂú®ÊúÄ‰∏äÂ±Ç
        map.removeLayer(labelLayerGroup);
        map.addLayer(labelLayerGroup);

        // ÂàùÂßãÂåñÊñ∞Êí≠ÊîæÂô®ÂÖÉÁ¥†
        playbackPlayer = document.getElementById('playbackPlayer');
        playerCloseBtn = document.getElementById('playerCloseBtn');
        playerPlayBtn = document.getElementById('playerPlayBtn');
        playerStopBtn = document.getElementById('playerStopBtn');
        playerSpeedSlider = document.getElementById('playerSpeedSlider');
        playerSpeedValue = document.getElementById('playerSpeedValue');
        playerProgressSlider = document.getElementById('playerProgressSlider');
        playerTimeLabel = document.getElementById('playerTimeLabel');

        // ÂàùÂßãÂåñÈÄüÂ∫¶ÊòæÁ§∫
        if (playerSpeedValue) {
            playerSpeedValue.textContent = '1x';
        }

        // ÂàùÂßãÂåñÊí≠ÊîæÂô®ÊåâÈíÆÁä∂ÊÄÅÔºà‰ΩøÁî®updatePlayerControlsÂáΩÊï∞Ôºâ
        updatePlayerControls();
    }

    // Ê∑ªÂä†Âü∫Á°ÄÂõæÂ±Ç
    function addBaseLayers() {
        console.log('addBaseLayers called');

        // Â§©Âú∞ÂõæË°óÈÅìÂõæ
        const tk = "9ed3674d01dd7c129ab38e3c38bf651a";

        // Â§©Âú∞ÂõæË°óÈÅìÂõæ - ‰ΩøÁî®XYZÁì¶ÁâáÊúçÂä°
        const vecLayer = L.tileLayer(`https://t{s}.tianditu.gov.cn/vec_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=vec&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`, {
            attribution: '¬© Â§©Âú∞Âõæ',
            maxZoom: 18,
            tileSize: 256,
            subdomains: ['0', '1', '2', '3', '4', '5', '6', '7']
        });

        // Â§©Âú∞ÂõæË°óÈÅìÂõæÊ†áÊ≥®
        const cvaLayer = L.tileLayer(`https://t{s}.tianditu.gov.cn/cva_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cva&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`, {
            attribution: '¬© Â§©Âú∞Âõæ',
            maxZoom: 18,
            tileSize: 256,
            subdomains: ['0', '1', '2', '3', '4', '5', '6', '7']
        });

        // Â§©Âú∞ÂõæÂç´ÊòüÂõæ - ‰ΩøÁî®XYZÁì¶ÁâáÊúçÂä°
        const imgLayer = L.tileLayer(`https://t{s}.tianditu.gov.cn/img_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=img&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`, {
            attribution: '¬© Â§©Âú∞Âõæ',
            maxZoom: 18,
            tileSize: 256,
            subdomains: ['0', '1', '2', '3', '4', '5', '6', '7']
        });

        // Â§©Âú∞ÂõæÂç´ÊòüÂõæÊ†áÊ≥®
        const ciaLayer = L.tileLayer(`https://t{s}.tianditu.gov.cn/cia_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cia&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`, {
            attribution: '¬© Â§©Âú∞Âõæ',
            maxZoom: 18,
            tileSize: 256,
            subdomains: ['0', '1', '2', '3', '4', '5', '6', '7']
        });

        // Ê∑ªÂä†ÂõæÂ±ÇÂä†ËΩΩ‰∫ã‰ª∂ÁõëÂê¨
        vecLayer.on('load', function() {
            console.log('Â§©Âú∞ÂõæË°óÈÅìÂõæÂ±ÇÂä†ËΩΩÂÆåÊàê');
            updateStatus('Â§©Âú∞ÂõæË°óÈÅìÂõæÂ±ÇÂä†ËΩΩÂÆåÊàê');
        });

        imgLayer.on('load', function() {
            console.log('Â§©Âú∞ÂõæÂç´ÊòüÂõæÂ±ÇÂä†ËΩΩÂÆåÊàê');
            updateStatus('Â§©Âú∞ÂõæÂç´ÊòüÂõæÂ±ÇÂä†ËΩΩÂÆåÊàê');
        });

        vecLayer.on('error', function(e) {
            console.error('Â§©Âú∞ÂõæË°óÈÅìÂõæÂ±ÇÂä†ËΩΩÈîôËØØ:', e);
            updateStatus('Â§©Âú∞ÂõæË°óÈÅìÂõæÂ±ÇÂä†ËΩΩÂ§±Ë¥•');
        });

        imgLayer.on('error', function(e) {
            console.error('Â§©Âú∞ÂõæÂç´ÊòüÂõæÂ±ÇÂä†ËΩΩÈîôËØØ:', e);
            updateStatus('Â§©Âú∞ÂõæÂç´ÊòüÂõæÂ±ÇÂä†ËΩΩÂ§±Ë¥•');
        });

        // ÂàõÂª∫ÂõæÂ±ÇÁªÑ
        currentBaseLayer = L.layerGroup([vecLayer, cvaLayer]);
        currentSatelliteLayer = L.layerGroup([imgLayer, ciaLayer]);

        console.log('currentBaseLayer created:', currentBaseLayer);
        console.log('currentSatelliteLayer created:', currentSatelliteLayer);

        // ÈªòËÆ§ÊòæÁ§∫Âç´ÊòüÂõæ
        currentSatelliteLayer.addTo(map);

        console.log('Satellite layer added to map');
        console.log('currentMapType initialized to: satellite');
    }

    // ÁªëÂÆöÂú∞Âõæ‰∫ã‰ª∂
    function bindMapEvents() {
        // Èº†Ê†áÁßªÂä®‰∫ã‰ª∂ - Êõ¥Êñ∞ÂùêÊ†áÊòæÁ§∫
        map.on('mousemove', function(e) {
            const lat = e.latlng.lat.toFixed(6);
            const lng = e.latlng.lng.toFixed(6);
            const coordinateInfo = document.getElementById('coordinateInfo');
            if (coordinateInfo) {
                coordinateInfo.textContent = `ÁªèÂ∫¶: ${lng}, Á∫¨Â∫¶: ${lat}`;
            }
        });

        // Âè≥ÈîÆËèúÂçï‰∫ã‰ª∂
        map.on('contextmenu', function(e) {
            // Â¶ÇÊûúÂú®ÊµãÈáèÊ®°Âºè‰∏ãÔºå‰∏çÊòæÁ§∫Âè≥ÈîÆËèúÂçïÔºàËÆ©ÊµãÈáèÊ®°ÂºèÁöÑÂè≥ÈîÆÂ§ÑÁêÜÊé•ÁÆ°Ôºâ
            if (measureState.isActive) {
                return;
            }

            // ‰øùÂ≠òÂè≥ÈîÆÁÇπÂáªÁöÑÂùêÊ†á
            lastRightClickLatLng = e.latlng;

            // ÊòæÁ§∫Âè≥ÈîÆËèúÂçï
            showContextMenu(e.originalEvent);

            // ÈòªÊ≠¢ÈªòËÆ§Âè≥ÈîÆËèúÂçï
            if (e.originalEvent) {
                e.originalEvent.preventDefault();
                e.originalEvent.stopPropagation();
            }

            return false;
        });

        // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÈöêËóèÂè≥ÈîÆËèúÂçï
        map.on('click', function() {
            hideContextMenu();
        });

        // Âú∞ÂõæÊéß‰ª∂‰∫ã‰ª∂
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const resetViewBtn = document.getElementById('resetViewBtn');

        if (zoomInBtn) {
            zoomInBtn.addEventListener('click', function() {
                map.zoomIn();
            });
        }

        if (zoomOutBtn) {
            zoomOutBtn.addEventListener('click', function() {
                map.zoomOut();
            });
        }

        if (resetViewBtn) {
            resetViewBtn.addEventListener('click', function() {
                map.setView([39.9042, 116.4074], 11);
            });
        }
    }

    // Áä∂ÊÄÅÊõ¥Êñ∞
    function updateStatus(message) {
        const statusInfo = document.getElementById('statusInfo');
        if (statusInfo) {
            // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®
            if (statusMessageTimer) {
                clearTimeout(statusMessageTimer);
                statusMessageTimer = null;
            }
            
            statusInfo.textContent = message;
            statusInfo.style.display = 'block';
            
            // ËÆæÁΩÆÊñ∞ÁöÑÂÆöÊó∂Âô®
            statusMessageTimer = setTimeout(() => {
                statusInfo.style.display = 'none';
                statusMessageTimer = null;
            }, 1000);
        }
    }

    // Âè≥ÈîÆËèúÂçïÂäüËÉΩÂáΩÊï∞
    function showContextMenu(event) {
        if (!contextMenu) {
            contextMenu = document.getElementById('contextMenu');
            getAddressMenuItem = document.getElementById('getAddressMenuItem');
            
            // ÁªëÂÆöËèúÂçïÈ°πÁÇπÂáª‰∫ã‰ª∂
            if (getAddressMenuItem) {
                getAddressMenuItem.addEventListener('click', handleGetAddress);
            }
        }

        if (contextMenu && event) {
            // ËÆæÁΩÆËèúÂçï‰ΩçÁΩÆ
            contextMenu.style.left = event.pageX + 'px';
            contextMenu.style.top = event.pageY + 'px';
            contextMenu.style.display = 'block';
        }
    }

    function hideContextMenu() {
        if (contextMenu) {
            contextMenu.style.display = 'none';
        }
    }

    // Â§ÑÁêÜËé∑ÂèñÂú∞ÂùÄÂäüËÉΩ
    function handleGetAddress() {
        if (!lastRightClickLatLng) {
            updateStatus('Ê≤°ÊúâÊúâÊïàÁöÑÂùêÊ†áÁÇπ');
            return;
        }

        const lat = lastRightClickLatLng.lat;
        const lng = lastRightClickLatLng.lng;

        // Ë∞ÉÁî®Â§©Âú∞ÂõæÈÄÜÂú∞ÁêÜÁºñÁ†ÅAPI
        getAddressFromTianDiTu(lat, lng);
        
        // ÈöêËóèÂè≥ÈîÆËèúÂçï
        hideContextMenu();
    }

    // Â§©Âú∞ÂõæÈÄÜÂú∞ÁêÜÁºñÁ†Å
    function getAddressFromTianDiTu(lat, lng) {
        // ‰ΩøÁî®Â§©Âú∞ÂõæÈÄÜÂú∞ÁêÜÁºñÁ†ÅAPIÔºå‰ΩøÁî®ÂêéÂè∞tk
        const tk = "9ed3674d01dd7c129ab38e3c38bf651a";
        const postStr = `{'lon':${lng},'lat':${lat},'ver':1}`;
        const url = `https://api.tianditu.gov.cn/geocoder?postStr=${postStr}&type=geocode&tk=${tk}`;

        console.log('ËØ∑Ê±ÇURL:', url);
        console.log('ÂùêÊ†á:', lat, lng);
        console.log('postStr:', postStr);
        updateStatus('Ê≠£Âú®Ëé∑ÂèñÂú∞ÂùÄ‰ø°ÊÅØ...');

        // Âà§Êñ≠ÊòØÂê¶Âú®Êú¨Âú∞Êñá‰ª∂ÁéØÂ¢É‰∏≠ËøêË°å
        const isLocalFile = window.location.protocol === 'file:';
        
        if (isLocalFile) {
            // Êú¨Âú∞Êñá‰ª∂ÁéØÂ¢ÉÔºö‰ΩøÁî®JSONPÊñπÂºè
            console.log('Ê£ÄÊµãÂà∞Êú¨Âú∞Êñá‰ª∂ËÆøÈóÆÔºå‰ΩøÁî®JSONPÊñπÂºè');
            tryJSONPApproach(lat, lng, tk);
        } else {
            // WebÂÆπÂô®ÁéØÂ¢ÉÔºöÁõ¥Êé•ÂèëÈÄÅGETËØ∑Ê±Ç
            console.log('WebÂÆπÂô®ÁéØÂ¢ÉÔºåÁõ¥Êé•ÂèëÈÄÅGETËØ∑Ê±Ç');
            fetch(url)
            .then(response => {
                console.log('ÂìçÂ∫îÁä∂ÊÄÅ:', response.status, response.statusText);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('ÂìçÂ∫îÊï∞ÊçÆ:', data);
                handleTiandituResponse(lat, lng, data);
            })
            .catch(error => {
                console.error('ÈÄÜÂú∞ÁêÜÁºñÁ†ÅËØ∑Ê±ÇÂ§±Ë¥•:', error);
                // Â§±Ë¥•ÂêéÁõ¥Êé•‰ΩøÁî®Â§áÁî®ÊñπÊ°àÊòæÁ§∫ÂùêÊ†á
                useFallbackAddress(lat, lng);
            });
        }
    }

    // ‰∏ìÈó®‰∏∫Êú¨Âú∞Êñá‰ª∂ÁéØÂ¢ÉËÆæËÆ°ÁöÑÊñπÊ°à
    function tryJSONPApproach(lat, lng, tk) {
        // Êú¨Âú∞Êñá‰ª∂ÁéØÂ¢É‰ΩøÁî®ÁôæÂ∫¶Âú∞ÂõæAPI - JSONPÊñπÂºèËé∑ÂèñÂú∞ÂùÄ‰ø°ÊÅØ
        const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
        
        // ÁôæÂ∫¶Âú∞ÂõæAPIÈÖçÁΩÆ - ‰ΩøÁî®È°∂ÈÉ®ÂÆö‰πâÁöÑÂ∏∏Èáè
        const baiduAk = BAIDU_MAP_AK;
        const url = `https://api.map.baidu.com/reverse_geocoding/v3/?ak=${baiduAk}&extensions_poi=1&entire_poi=1&sort_strategy=distance&output=json&coordtype=wgs84ll&location=${lat},${lng}&callback=${callbackName}`;
        
        console.log('ÁôæÂ∫¶Âú∞ÂõæJSONPËØ∑Ê±ÇURL:', url);
        
        // ÂàõÂª∫ÂÖ®Â±ÄÂõûË∞ÉÂáΩÊï∞
        window[callbackName] = function(data) {
            console.log('ÁôæÂ∫¶Âú∞ÂõæJSONPÂìçÂ∫îÊï∞ÊçÆ:', data);
            cleanup();
            
            if (data && data.status === 0 && data.result) {
                // Â§ÑÁêÜÁôæÂ∫¶Âú∞ÂõæÂìçÂ∫îÊï∞ÊçÆÔºåËΩ¨Êç¢‰∏∫Â§©Âú∞ÂõæÊ†ºÂºè
                const addressData = {
                    result: {
                        formatted_address: data.result.formatted_address || data.result.address
                    }
                };
                
                // Â¶ÇÊûúÊúâPOI‰ø°ÊÅØÔºåÊ∑ªÂä†Âà∞Âú∞ÂùÄ‰∏≠
                if (data.result.pois && data.result.pois.length > 0) {
                    const nearestPoi = data.result.pois[0];
                    addressData.result.formatted_address += ` (${nearestPoi.name})`;
                }
                
                handleTiandituResponse(lat, lng, addressData);
            } else {
                console.log('ÁôæÂ∫¶Âú∞ÂõæJSONPËøîÂõûÊï∞ÊçÆÊ†ºÂºè‰∏çÊ≠£Á°ÆÊàñÁä∂ÊÄÅÈîôËØØÔºå‰ΩøÁî®Â§áÁî®ÊñπÊ°à');
                useFallbackAddress(lat, lng);
            }
        };
        
        // ÂàõÂª∫scriptÊ†áÁ≠æ
        const script = document.createElement('script');
        script.src = url;
        
        let timeoutId;
        
        function cleanup() {
            if (timeoutId) clearTimeout(timeoutId);
            if (window[callbackName]) delete window[callbackName];
            if (script.parentNode) document.body.removeChild(script);
        }
        
        script.onerror = function() {
            cleanup();
            console.log('ÁôæÂ∫¶Âú∞ÂõæJSONPËØ∑Ê±ÇÂ§±Ë¥•Ôºå‰ΩøÁî®Â§áÁî®ÊñπÊ°à');
            useFallbackAddress(lat, lng);
        };
        
        // ËÆæÁΩÆË∂ÖÊó∂
        timeoutId = setTimeout(() => {
            cleanup();
            console.log('ÁôæÂ∫¶Âú∞ÂõæJSONPËØ∑Ê±ÇË∂ÖÊó∂Ôºå‰ΩøÁî®Â§áÁî®ÊñπÊ°à');
            useFallbackAddress(lat, lng);
        }, 8000); // 8ÁßíË∂ÖÊó∂
        
        document.body.appendChild(script);
    }

    // Â§ÑÁêÜÂ§©Âú∞ÂõæAPIÂìçÂ∫îÊï∞ÊçÆ
    function handleTiandituResponse(lat, lng, data) {
        if (data && data.result && data.result.formatted_address) {
            const address = data.result.formatted_address;
            showAddressLabel(lat, lng, address);
            updateStatus('Âú∞ÂùÄËé∑ÂèñÊàêÂäü');
        } else if (data && data.msg) {
            updateStatus(`Âú∞ÂùÄËé∑ÂèñÂ§±Ë¥•Ôºö${data.msg}`);
        } else {
            updateStatus('Âú∞ÂùÄËé∑ÂèñÂ§±Ë¥•ÔºöÊú™ÊâæÂà∞Âú∞ÂùÄ‰ø°ÊÅØ');
        }
    }

    // ÊúÄÁªàÂ§áÁî®ÊñπÊ°àÔºöÊòæÁ§∫ÂùêÊ†á‰ø°ÊÅØ
    function useFallbackAddress(lat, lng) {
        const fallbackAddress = `ÂùêÊ†á‰ΩçÁΩÆÔºö${lng.toFixed(6)}, ${lat.toFixed(6)}`;
        showAddressLabel(lat, lng, fallbackAddress);
        updateStatus('Âú∞ÂùÄÊúçÂä°ÊöÇ‰∏çÂèØÁî®ÔºåÊòæÁ§∫ÂùêÊ†á‰ø°ÊÅØ');
    }

    // ÊòæÁ§∫Âú∞ÂùÄÊ†áÁ≠æ
    function showAddressLabel(lat, lng, address) {
        // ÂàõÂª∫Âú∞ÂùÄÊ†áÁ≠æ
        const label = L.marker([lat, lng], {
            icon: L.divIcon({
                className: 'address-label',
                html: `<div style="background: white; border: 2px solid #007bff; border-radius: 6px; padding: 8px 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); font-size: 12px; max-width: 300px; word-wrap: break-word;">
                        <div style="font-weight: bold; color: #007bff; margin-bottom: 4px;">üìç Âú∞ÂùÄ‰ø°ÊÅØ</div>
                        <div style="color: #333;">${address}</div>
                        <div style="font-size: 10px; color: #666; margin-top: 4px;">
                            ÂùêÊ†á: ${lng.toFixed(6)}, ${lat.toFixed(6)}
                        </div>
                     </div>`,
                iconSize: [300, 'auto'],
                iconAnchor: [150, 0]
            })
        }).addTo(labelLayerGroup);

        // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂ÔºåÁÇπÂáªÂèØ‰ª•Âà†Èô§Ê†áÁ≠æ
        label.on('click', function() {
            labelLayerGroup.removeLayer(label);
            updateStatus('Âú∞ÂùÄÊ†áÁ≠æÂ∑≤Âà†Èô§');
        });

        // 3ÁßíÂêéËá™Âä®ÈöêËóèÊ†áÁ≠æ
        setTimeout(() => {
            if (labelLayerGroup.hasLayer(label)) {
                labelLayerGroup.removeLayer(label);
            }
        }, 10000); // 10ÁßíÂêéËá™Âä®ÈöêËóè
    }

    // Ê†áÁ≠æÈ°µÂàáÊç¢
    function bindTabEvents() {
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');

        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const targetTab = this.dataset.tab;

                // ÁßªÈô§ÊâÄÊúâÊ¥ªÂä®Áä∂ÊÄÅ
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));

                // Ê∑ªÂä†Ê¥ªÂä®Áä∂ÊÄÅ
                this.classList.add('active');
                document.getElementById(targetTab + '-tab').classList.add('active');
            });
        });
    }

    // È¢úËâ≤ÈÄâÊã©Âô®‰∫ã‰ª∂
    function bindColorPickerEvents() {
        // ËΩ®ËøπÁ∫øÈ¢úËâ≤
        const trackLineColorPicker = document.getElementById('trackLineColorPicker');
        const trackLineColorInput = document.getElementById('trackLineColorInput');

        if (trackLineColorPicker && trackLineColorInput) {
            trackLineColorPicker.addEventListener('click', function() {
                trackLineColorInput.click();
            });

            trackLineColorInput.addEventListener('change', function() {
                currentTrackLineColor = this.value;
                trackLineColorPicker.style.backgroundColor = currentTrackLineColor;
            });
        }

        // ËΩ®ËøπÁÇπÈ¢úËâ≤
        const trackPointColorPicker = document.getElementById('trackPointColorPicker');
        const trackPointColorInput = document.getElementById('trackPointColorInput');

        if (trackPointColorPicker && trackPointColorInput) {
            trackPointColorPicker.addEventListener('click', function() {
                trackPointColorInput.click();
            });

            trackPointColorInput.addEventListener('change', function() {
                currentTrackPointColor = this.value;
                trackPointColorPicker.style.backgroundColor = currentTrackPointColor;
            });
        }
    }

    // Â∑•ÂÖ∑ÊåâÈíÆ‰∫ã‰ª∂
    function bindToolEvents() {
        // ÊµãË∑ùÊåâÈíÆ
        const measureDistanceBtn = document.getElementById('measureDistanceBtn');
        if (measureDistanceBtn) {
            measureDistanceBtn.addEventListener('click', startMeasureDistance);
        }

        // ÊµãÈù¢ÊåâÈíÆ
        const measureAreaBtn = document.getElementById('measureAreaBtn');
        if (measureAreaBtn) {
            measureAreaBtn.addEventListener('click', startMeasureArea);
        }

        // Âú∞ÂõæÁ±ªÂûãÂàáÊç¢
        const mapTypeBtn = document.getElementById('mapTypeBtn');
        if (mapTypeBtn) {
            mapTypeBtn.addEventListener('click', toggleMapType);
        }

        // Ê∏ÖÁ©∫ÊâÄÊúâ
        const clearAllBtn = document.getElementById('clearAllBtn');
        if (clearAllBtn) {
            clearAllBtn.addEventListener('click', clearAll);
        }

        // ËΩ®ËøπÁõ∏ÂÖ≥ÊåâÈíÆ
        const drawTrackBtn = document.getElementById('drawTrackButton');
        const showTrackPointsBtn = document.getElementById('showTrackPointsButton');
        const clearTrackBtn = document.getElementById('clearTrackButton');

        if (drawTrackBtn) drawTrackBtn.addEventListener('click', drawTrack);
        if (showTrackPointsBtn) showTrackPointsBtn.addEventListener('click', showTrackPoints);
        if (clearTrackBtn) clearTrackBtn.addEventListener('click', clearTrack);

        // ËΩ®ËøπÂõûÊîæÂàáÊç¢ÊåâÈíÆ - ÂßãÁªàÂèØÁÇπÂáªÔºåÁÇπÂáªÊó∂ËøõË°åÂàùÂßãÂåñÊ£ÄÊü•
        const playbackToggleBtn = document.getElementById('playbackToggleBtn');
        if (playbackToggleBtn) {
            // ÁßªÈô§disabledÂ±ûÊÄßÔºå‰ΩøÊåâÈíÆÂßãÁªàÂèØÁÇπÂáª
            playbackToggleBtn.disabled = false;
            
            playbackToggleBtn.addEventListener('click', function() {
                // Â¶ÇÊûúÊí≠ÊîæÂô®Â∑≤ÊòæÁ§∫ÔºåÂàôÈöêËóè
                if (playbackPlayer.style.display === 'block') {
                    hidePlaybackPlayer();
                    return;
                }
                
                // Ê£ÄÊü•ÊòØÂê¶ÊúâËΩ®ËøπÊï∞ÊçÆ
                if (!playbackState.points || playbackState.points.length === 0) {
                    // Â∞ùËØï‰ªétextareaËß£ÊûêËΩ®ËøπÊï∞ÊçÆ
                    const trackTextarea = document.getElementById('trackTextarea');
                    if (trackTextarea && trackTextarea.value.trim()) {
                        try {
                            parseTrackPoints(trackTextarea.value.trim());
                        } catch (e) {
                            updateStatus('ËΩ®ËøπÊï∞ÊçÆÊ†ºÂºèÈîôËØØÔºåÊó†Ê≥ïÊâìÂºÄÊí≠ÊîæÂô®');
                            return;
                        }
                    }
                }
                
                // ÂÜçÊ¨°Ê£ÄÊü•ÊòØÂê¶ÊúâÊúâÊïàËΩ®ËøπÊï∞ÊçÆ
                if (!playbackState.points || playbackState.points.length === 0) {
                    updateStatus('Ê≤°ÊúâÊúâÊïàÁöÑËΩ®ËøπÊï∞ÊçÆÔºåÊó†Ê≥ïÊâìÂºÄÊí≠ÊîæÂô®');
                    return;
                }
                
                // ÊòæÁ§∫Êí≠ÊîæÂô®
                showPlaybackPlayer();
            });
        }

        // Êñ∞Êí≠ÊîæÂô®ÊéßÂà∂‰∫ã‰ª∂
        if (playerCloseBtn) playerCloseBtn.addEventListener('click', hidePlaybackPlayer);
        if (playerPlayBtn) playerPlayBtn.addEventListener('click', togglePlayback);

        if (playerStopBtn) playerStopBtn.addEventListener('click', stopPlayback);
        
        // ÂàùÂßãÂåñÊí≠ÊîæÂô®ÊåâÈíÆÁä∂ÊÄÅ
        updatePlayerControls();
        
        // ÈÄüÂ∫¶ÊªëÂùó
        if (playerSpeedSlider) {
            playerSpeedSlider.addEventListener('input', function() {
                // Â∞ÜÊªëÂùóÂÄºËΩ¨Êç¢‰∏∫ÊåáÊï∞ÂÄçÊï∞Ôºö1,2,4,8,16,32,64,128,256,512,1024
                const sliderValue = parseInt(this.value);
                let speed;
                
                if (sliderValue === 1) {
                    speed = 1;
                } else {
                    // ËÆ°ÁÆó2ÁöÑÂπÇÊ¨°Ôºö2^0=1, 2^1=2, 2^2=4, ..., 2^10=1024
                    const power = Math.floor(Math.log2(sliderValue));
                    speed = Math.pow(2, power);
                }
                
                // ÈôêÂà∂ÊúÄÂ§ßÂÄº
                speed = Math.min(speed, 1024);
                
                // Á°Æ‰øùÊòØ2ÁöÑÂπÇÊ¨°ÂÄçÊï∞Ôºö1,2,4,8,16,32,64,128,256,512,1024
                const validSpeeds = [1, 2, 4, 8, 16, 32, 64, 128, 256, 512, 1024];
                speed = validSpeeds.find(s => s >= speed) || 1024;
                
                playbackState.speed = speed;
                if (playerSpeedValue) playerSpeedValue.textContent = speed + 'x';
                
                // Â¶ÇÊûúÊ≠£Âú®Êí≠ÊîæÔºåÂ∫îÁî®Êñ∞ÈÄüÂ∫¶Ôºà‰øùÊåÅÂΩìÂâç‰ΩçÁΩÆÁªßÁª≠Êí≠ÊîæÔºâ
                if (playbackState.isPlaying) {
                    // ‰∏çÈúÄË¶ÅÊöÇÂÅúÂíåÈáçÊñ∞ÂºÄÂßãÔºåÈÄüÂ∫¶‰ºöÂú®‰∏ã‰∏Ä‰∏™ÁÇπËá™Âä®Â∫îÁî®
                    updateStatus(`Êí≠ÊîæÈÄüÂ∫¶Â∑≤Ë∞ÉÊï¥‰∏∫ ${speed}x`);
                }
            });
        }
        
        // ËøõÂ∫¶ÊªëÂùó
        if (playerProgressSlider) {
            playerProgressSlider.addEventListener('input', function() {
                const percentage = parseInt(this.value);
                if (playbackState.filteredPoints && playbackState.filteredPoints.length > 0) {
                    const index = Math.floor((percentage / 100) * (playbackState.filteredPoints.length - 1));
                    const wasPlaying = playbackState.isPlaying; // ËÆ∞ÂΩïÊí≠ÊîæÁä∂ÊÄÅ
                    jumpToPoint(index);
                    // Â¶ÇÊûú‰πãÂâçÂú®Êí≠ÊîæÔºåÁªßÁª≠Êí≠Êîæ
                    if (wasPlaying) {
                        setTimeout(() => {
                            playbackState.isPlaying = true;
                            playbackNextPoint();
                        }, 100);
                    }
                }
            });
        }

        // ËΩ®ËøπÊñáÊú¨Ê°Ü‰∫ã‰ª∂ÁõëÂê¨ - Ê†πÊçÆÂÜÖÂÆπÂêØÁî®/Á¶ÅÁî®ÊåâÈíÆ
        const trackTextarea = document.getElementById('trackTextarea');
        if (trackTextarea) {
            function updateTrackButtons() {
                const hasContent = trackTextarea.value.trim().length > 0;
                if (drawTrackBtn) drawTrackBtn.disabled = !hasContent;
                if (showTrackPointsBtn) showTrackPointsBtn.disabled = !hasContent;
                if (clearTrackBtn) clearTrackBtn.disabled = !hasContent;
                
                // Â¶ÇÊûúÊúâËΩ®ËøπÂÜÖÂÆπÔºåÂ∞ùËØïËá™Âä®Ëß£Êûê‰ª•ÂêØÁî®Êí≠ÊîæÊåâÈíÆ
                if (hasContent) {
                    try {
                        const trackText = trackTextarea.value.trim();
                        const lines = trackText.split('\n');
                        let hasValidTrackData = false;
                        
                        // Ê£ÄÊü•ÊòØÂê¶ÊúâÊúâÊïàÁöÑËΩ®ËøπÊï∞ÊçÆÊ†ºÂºè
                        for (let line of lines) {
                            line = line.trim();
                            if (!line) continue;
                            
                            const parts = line.split(',');
                            if (parts.length >= 3) {
                                // Ê£ÄÊü•‰∏§ÁßçÊ†ºÂºèÔºöÁªèÂ∫¶,Á∫¨Â∫¶,Êó∂Èó¥Êà≥ Êàñ Êó∂Èó¥Êà≥,ÁªèÂ∫¶,Á∫¨Â∫¶
                                const part1 = parts[0].trim();
                                const part2 = parts[1].trim();
                                const part3 = parts[2].trim();
                                
                                // Â¶ÇÊûúÊòØÊúâÊïàÁöÑÊï∞Â≠óÊ†ºÂºèÔºåÂàôËÆ§‰∏∫ÊúâÊúâÊïàËΩ®ËøπÊï∞ÊçÆ
                                if ((!isNaN(part1) && !isNaN(part2) && part3) || 
                                    (!isNaN(part2) && !isNaN(part3) && part1)) {
                                    hasValidTrackData = true;
                                    break;
                                }
                            }
                        }
                        
                        // Êí≠ÊîæÊåâÈíÆÁé∞Âú®ÂßãÁªàÂèØÁÇπÂáªÔºå‰∏çÈúÄË¶ÅÊ†πÊçÆËß£ÊûêÁªìÊûúÂêØÁî®/Á¶ÅÁî®
                        // Â¶ÇÊûúÊâæÂà∞ÊúâÊïàÊï∞ÊçÆÔºåËá™Âä®Ëß£ÊûêÂà∞playbackState
                        if (hasValidTrackData) {
                            const points = [];
                            lines.forEach(line => {
                                line = line.trim();
                                if (!line) return;
                                
                                const parts = line.split(',');
                                if (parts.length >= 3) {
                                    let lng, lat, timestamp;
                                    
                                    // Âà§Êñ≠Ê†ºÂºè
                                    if (parts[0].trim().length > 10 && !isNaN(parts[0].trim())) {
                                        // Ê†ºÂºèÔºöÊó∂Èó¥Êà≥,ÁªèÂ∫¶,Á∫¨Â∫¶
                                        timestamp = parts[0].trim();
                                        lng = parseFloat(parts[1].trim());
                                        lat = parseFloat(parts[2].trim());
                                    } else {
                                        // Ê†ºÂºèÔºöÁªèÂ∫¶,Á∫¨Â∫¶,Êó∂Èó¥Êà≥
                                        lng = parseFloat(parts[0].trim());
                                        lat = parseFloat(parts[1].trim());
                                        timestamp = parts[2].trim();
                                    }
                                    
                                    if (!isNaN(lng) && !isNaN(lat) && timestamp && lat !== 0 && lng !== 0) {
                                        points.push({
                                            lat: lat,
                                            lng: lng,
                                            timestamp: timestamp
                                        });
                                    }
                                }
                            });
                            
                            // ‰øùÂ≠òËß£ÊûêÁöÑËΩ®ËøπÁÇπ
                            if (points.length > 0) {
                                playbackState.points = points;
                            }
                        }
                        
                    } catch (e) {
                        // Ëß£ÊûêÂ§±Ë¥•Êó∂ÔºåÊ∏ÖÁ©∫ËΩ®ËøπÁÇπ
                        playbackState.points = [];
                    }
                } else {
                    // Ê≤°ÊúâÂÜÖÂÆπÊó∂ÔºåÊ∏ÖÁ©∫ËΩ®ËøπÁÇπ
                    playbackState.points = [];
                }
            }
            
            // ÂàùÂßãÁä∂ÊÄÅ
            updateTrackButtons();
            
            // ÁõëÂê¨ËæìÂÖ•‰∫ã‰ª∂
            trackTextarea.addEventListener('input', updateTrackButtons);
            trackTextarea.addEventListener('change', updateTrackButtons);
        }
    }

    // ËΩÆÂªìÁªòÂà∂ÂáΩÊï∞
    function drawOutline() {
        const wktText = document.getElementById('outlineWkt').value.trim();
        if (!wktText) {
            alert('ËØ∑ËæìÂÖ•WKTÊï∞ÊçÆ');
            return;
        }

        clearOutline();

        try {
            // Ê£ÄÊü•ÊòØÂê¶‰∏∫Â§öË°åWKT
            const wktLines = wktText.split('\n').filter(line => line.trim());
            let polygonData = [];

            if (wktLines.length === 1) {
                // ÂçïË°åWKT - ‰ΩøÁî®ÂéüÂßãÈÄªËæë
                const geojson = wellknown.parse(wktLines[0].trim());
                if (geojson.type === "Polygon") {
                    polygonData.push({ index: 1, geojson: geojson, colorIndex: 0 });
                } else if (geojson.type === "MultiPolygon") {
                    geojson.coordinates.forEach((polygon, index) => {
                        // Â∞ÜMultiPolygonÁöÑÊØè‰∏™Â≠êÂ§öËæπÂΩ¢ËΩ¨Êç¢‰∏∫ÂçïÁã¨ÁöÑPolygon
                        const singlePolygon = {
                            type: "Polygon",
                            coordinates: polygon
                        };
                        polygonData.push({ index: index + 1, geojson: singlePolygon, colorIndex: index });
                    });
                }
            } else {
                // Â§öË°åWKT - ÊØèË°å‰∏Ä‰∏™Â§öËæπÂΩ¢
                wktLines.forEach((line, index) => {
                    if (line.trim()) {
                        try {
                            const geojson = wellknown.parse(line.trim());
                            if (geojson.type === "Polygon") {
                                polygonData.push({ index: index + 1, geojson: geojson, colorIndex: index });
                            } else if (geojson.type === "MultiPolygon") {
                                // Â¶ÇÊûú‰∏ÄË°åÊòØMultiPolygonÔºåÊãÜÂàÜÊàêÂ§ö‰∏™Polygon
                                geojson.coordinates.forEach((polygon, subIndex) => {
                                    const singlePolygon = {
                                        type: "Polygon",
                                        coordinates: polygon
                                    };
                                    polygonData.push({
                                        index: index + 1 + subIndex * 0.1,
                                        geojson: singlePolygon,
                                        colorIndex: index
                                    });
                                });
                            }
                        } catch (e) {
                            console.warn(`Á¨¨${index + 1}Ë°åWKTËß£ÊûêÂ§±Ë¥•:`, e);
                        }
                    }
                });
            }

            // ‰∏∫ÊØè‰∏™Â§öËæπÂΩ¢ÂàõÂª∫ÂõæÂ±Ç
            polygonData.forEach((data, idx) => {
                const colorScheme = polygonColors[data.colorIndex % polygonColors.length];
                const style = {
                    color: colorScheme.outline,
                    weight: 1,
                    opacity: 1,
                    fillColor: colorScheme.fill,
                    fillOpacity: colorScheme.opacity
                };

                const polygonLayer = L.geoJSON(data.geojson, {
                    style: style
                });

                outlineLayerGroup.addLayer(polygonLayer);

                // ËÆ°ÁÆóÈù¢ÁßØÂπ∂Ê∑ªÂä†‰∫©Êï∞Ê†áÁ≠æ
                if (typeof L !== 'undefined' && typeof L.GeometryUtil !== 'undefined' && typeof L.GeometryUtil.geodesicArea === 'function') {
                    try {
                        // Ëé∑ÂèñÂõæÂ±Ç‰∏≠ÁöÑË¶ÅÁ¥†ËøõË°åÈù¢ÁßØËÆ°ÁÆó
                        let layers = [];

                        // Â¶ÇÊûúpolygonLayerÊòØLayerGroupÊàñFeatureGroupÔºåËé∑ÂèñÂÖ∂ÊâÄÊúâÂ≠êÂõæÂ±Ç
                        if (polygonLayer instanceof L.LayerGroup || polygonLayer instanceof L.FeatureGroup) {
                            layers = polygonLayer.getLayers();
                        } else {
                            // ÂØπ‰∫éÂÖ∂‰ªñÁ±ªÂûãÁöÑÂõæÂ±ÇÔºåÊ£ÄÊü•ÊòØÂê¶ÊúâgetLayersÊñπÊ≥ï
                            layers = polygonLayer.getLayers ? polygonLayer.getLayers() : [polygonLayer];
                        }

                        if (layers && Array.isArray(layers) && layers.length > 0) {
                            for (let j = 0; j < layers.length; j++) {
                                const layer = layers[j];
                                let latLngs;

                                // Ê†πÊçÆÂõæÂ±ÇÁ±ªÂûãËé∑ÂèñÂùêÊ†á
                                if (layer && typeof layer.getLatLngs === 'function') {
                                    if (layer instanceof L.Polygon) {
                                        latLngs = layer.getLatLngs();
                                    } else if (layer instanceof L.MultiPolygon) {
                                        // ÂØπ‰∫éMultiPolygonÔºåÂèñÁ¨¨‰∏Ä‰∏™Â§öËæπÂΩ¢
                                        const multiLatLngs = layer.getLatLngs();
                                        if (multiLatLngs && Array.isArray(multiLatLngs) && multiLatLngs.length > 0) {
                                            latLngs = multiLatLngs[0];
                                        }
                                    }

                                    if (latLngs) {
                                        // Â§ÑÁêÜlatLngsÊ†ºÂºèÔºåÁ°Æ‰øùÊ≠£Á°ÆËÆ°ÁÆóÈù¢ÁßØ
                                        let areaLatLngs = latLngs;
                                        if (Array.isArray(latLngs) && latLngs.length > 0) {
                                            areaLatLngs = latLngs[0] || latLngs;
                                        }

                                        let areaSqM, areaMu;
                                        if (typeof L.GeometryUtil !== 'undefined' && typeof L.GeometryUtil.geodesicArea === 'function') {
                                            areaSqM = L.GeometryUtil.geodesicArea(areaLatLngs);
                                            areaMu = (areaSqM / 666.6667).toFixed(4); // ËΩ¨Êç¢‰∏∫‰∫©
                                            console.log('‰ΩøÁî®L.GeometryUtilËÆ°ÁÆóÂ§öËæπÂΩ¢Èù¢ÁßØ:', areaSqM, 'Âπ≥ÊñπÁ±≥ (', areaMu, '‰∫©)');
                                        } else if (typeof turf !== 'undefined') {
                                            // ‰ΩøÁî®Turf.js‰Ωú‰∏∫Â§áÈÄâÊñπÊ°à
                                            try {
                                                // Â§ÑÁêÜÂ§öËæπÂΩ¢ÂùêÊ†áÔºåÊîØÊåÅÂ§ñÈÉ®ËæπÁïåÂíåÂÜÖÈÉ®Â≠îÊ¥û
                                                const processPolygon = (polyCoords) => {
                                                    if (!Array.isArray(polyCoords) || polyCoords.length === 0) {
                                                        return null;
                                                    }

                                                    // Â¶ÇÊûúÊòØÂ§öËæπÂΩ¢Êï∞ÁªÑÔºàÂ§ñÈÉ®ËæπÁïå+Â≠îÊ¥ûÔºâÔºåÂàÜÂà´Â§ÑÁêÜ
                                                    let processedCoords = [];

                                                    // Â§ÑÁêÜÂ§öËæπÂΩ¢ÁöÑÊØè‰∏™ÁéØÔºàÁ¨¨‰∏Ä‰∏™ÊòØÂ§ñÈÉ®ËæπÁïåÔºåÂÖ∂‰ΩôÊòØÂ≠îÊ¥ûÔºâ
                                                    for (let i = 0; i < polyCoords.length; i++) {
                                                        let ring = polyCoords[i];
                                                        if (!Array.isArray(ring)) {
                                                            ring = [ring]; // Â¶ÇÊûú‰∏çÊòØÊï∞ÁªÑÔºåËΩ¨Êç¢‰∏∫Êï∞ÁªÑ
                                                        }

                                                        // Â∞ÜLeafletÂùêÊ†áËΩ¨Êç¢‰∏∫GeoJSONÊ†ºÂºè [lng, lat]
                                                        let geoJsonRing = ring.map(latLng => {
                                                            if (latLng.lat !== undefined && latLng.lng !== undefined) {
                                                                return [latLng.lng, latLng.lat];
                                                            } else if (Array.isArray(latLng) && latLng.length >= 2) {
                                                                // Â¶ÇÊûúÂ∑≤ÁªèÊòØÊï∞ÁªÑÊ†ºÂºè [lat, lng] Êàñ [lng, lat]
                                                                return [latLng[1], latLng[0]]; // ÂÅáËÆæÊòØ [lat, lng] Ê†ºÂºè
                                                            }
                                                            return null;
                                                        }).filter(coord => coord !== null);

                                                        // Á°Æ‰øùÁéØÊòØÈó≠ÂêàÁöÑÔºàËá≥Â∞ëÊúâ4‰∏™ÁÇπÔºåÈ¶ñÂ∞æÁõ∏ÂêåÔºâ
                                                        if (geoJsonRing.length >= 3) {
                                                            // Â¶ÇÊûúÈ¶ñÂ∞æ‰∏çÁõ∏ÂêåÔºåÈó≠ÂêàÁéØ
                                                            if (geoJsonRing[0][0] !== geoJsonRing[geoJsonRing.length - 1][0] ||
                                                                geoJsonRing[0][1] !== geoJsonRing[geoJsonRing.length - 1][1]) {
                                                                geoJsonRing.push(geoJsonRing[0]);
                                                            }

                                                            // Á°Æ‰øùËá≥Â∞ëÊúâ4‰∏™ÁÇπÔºàÈó≠ÂêàÂêéÔºâ
                                                            if (geoJsonRing.length < 4) {
                                                                // Â¶ÇÊûúÁÇπÊï∞‰∏çË∂≥4‰∏™ÔºåÂ§çÂà∂ÁÇπÁõ¥Âà∞ËææÂà∞4‰∏™
                                                                while (geoJsonRing.length < 4) {
                                                                    geoJsonRing.push(geoJsonRing[geoJsonRing.length - 1]);
                                                                }
                                                            }
                                                        } else if (geoJsonRing.length === 2) {
                                                            // Â¶ÇÊûúÂè™Êúâ2‰∏™ÁÇπÔºåÂ§çÂà∂ÂÆÉ‰ª¨ÂΩ¢ÊàêËá≥Â∞ë4‰∏™ÁÇπÁöÑÁéØ
                                                            geoJsonRing.push(geoJsonRing[1]);
                                                            geoJsonRing.push(geoJsonRing[0]);
                                                        } else if (geoJsonRing.length === 1) {
                                                            // Â¶ÇÊûúÂè™Êúâ1‰∏™ÁÇπÔºåÂ§çÂà∂3Ê¨°ÂΩ¢Êàê4‰∏™ÁÇπÁöÑÁéØ
                                                            for (let k = 0; k < 3; k++) {
                                                                geoJsonRing.push(geoJsonRing[0]);
                                                            }
                                                        }

                                                        processedCoords.push(geoJsonRing);
                                                    }

                                                    return processedCoords;
                                                };

                                                // Ê†πÊçÆareaLatLngsÁöÑÁªìÊûÑÂ§ÑÁêÜÂùêÊ†á
                                                let coordinates;
                                                if (Array.isArray(areaLatLngs) && areaLatLngs.length > 0) {
                                                    if (Array.isArray(areaLatLngs[0])) {
                                                        // Â¶ÇÊûúÊòØÂ§öËæπÂΩ¢Êï∞ÁªÑÔºàÂåÖÂê´Â§ñÈÉ®ËæπÁïåÂíåÂ≠îÊ¥ûÔºâ
                                                        coordinates = processPolygon(areaLatLngs);
                                                    } else {
                                                        // Â¶ÇÊûúÊòØÂçï‰∏™Â§öËæπÂΩ¢ËæπÁïå
                                                        coordinates = processPolygon([areaLatLngs]);
                                                    }
                                                } else {
                                                    // Âçï‰∏™Â§öËæπÂΩ¢ËæπÁïå
                                                    coordinates = processPolygon([areaLatLngs]);
                                                }

                                                if (coordinates && coordinates.length > 0) {
                                                    const polygon = turf.polygon(coordinates);
                                                    areaSqM = turf.area(polygon);
                                                    areaMu = (areaSqM / 666.6667).toFixed(4); // ËΩ¨Êç¢‰∏∫‰∫©
                                                    console.log('‰ΩøÁî®Turf.jsËÆ°ÁÆóÂ§öËæπÂΩ¢Èù¢ÁßØ:', areaSqM, 'Âπ≥ÊñπÁ±≥ (', areaMu, '‰∫©)');
                                                } else {
                                                    console.log('Êó†Ê≥ïÂ§ÑÁêÜÂùêÊ†áÊï∞ÊçÆÔºå‰ΩøÁî®ÈªòËÆ§Èù¢ÁßØ');
                                                    areaSqM = 0;
                                                    areaMu = '0.0000';
                                                }
                                            } catch (e) {
                                                console.error('‰ΩøÁî®Turf.jsËÆ°ÁÆóÈù¢ÁßØÊó∂Âá∫Èîô:', e);
                                                areaSqM = 0;
                                                areaMu = '0.0000';
                                            }
                                        } else {
                                            console.error('L.GeometryUtilÂíåTurf.jsÈÉΩ‰∏çÂèØÁî®ÔºåÊó†Ê≥ïËÆ°ÁÆóÈù¢ÁßØ');
                                            areaSqM = 0;
                                            areaMu = '0.0000';
                                        }

                                        console.log('ËÆ°ÁÆóÂ§öËæπÂΩ¢Èù¢ÁßØ:', areaSqM, 'Âπ≥ÊñπÁ±≥ (', areaMu, '‰∫©)');

                                        // Â¶ÇÊûúÊ†áÁ≠æÂ∑≤ÂêØÁî®ÔºåÂàôÊ∑ªÂä†Èù¢ÁßØÊ†áÁ≠æ
                                        if (labelsEnabled) {
                                            console.log('Ê†áÁ≠æÂ∑≤ÂêØÁî®Ôºå‰∏∫Â§öËæπÂΩ¢Ê∑ªÂä†Èù¢ÁßØÊ†áÁ≠æ');
                                            addAreaLabelToLayer(polygonLayer, `Èù¢ÁßØ: ${areaMu}‰∫©`);
                                            console.log('ÂΩìÂâçÊ†áÁ≠æÂõæÂ±Ç‰∏≠ÁöÑÂõæÂ±ÇÊï∞Èáè:', labelLayerGroup.getLayers().length);
                                        } else {
                                            console.log('Ê†áÁ≠æÊú™ÂêØÁî®Ôºå‰∏çÊ∑ªÂä†Èù¢ÁßØÊ†áÁ≠æ');
                                        }
                                        break; // Âè™Â§ÑÁêÜÁ¨¨‰∏Ä‰∏™ÊúâÊïàÁöÑÂõæÂ±ÇÊù•ËÆ°ÁÆóÈù¢ÁßØ
                                    }
                                }
                            }
                        }
                    } catch (areaError) {
                        console.warn('Èù¢ÁßØËÆ°ÁÆóÈîôËØØ:', areaError);
                    }
                }
            });

            // Ëá™ÈÄÇÂ∫îËßÜÈáé
            if (outlineLayerGroup && outlineLayerGroup.getLayers && outlineLayerGroup.getLayers().length > 0) {
                // ËÆ°ÁÆóÊâÄÊúâÂ≠êÂõæÂ±ÇÁöÑÊï¥‰ΩìËæπÁïå
                const layers = outlineLayerGroup.getLayers();
                let groupBounds = null;

                for (let i = 0; i < layers.length; i++) {
                    const layer = layers[i];
                    let layerBounds;

                    // Ê£ÄÊü•ÂõæÂ±ÇÊòØÂê¶‰∏∫LayerGroupÊàñFeatureGroup
                    if (layer instanceof L.LayerGroup || layer instanceof L.FeatureGroup) {
                        try {
                            layerBounds = layer.getBounds();
                        } catch (e) {
                            // Â¶ÇÊûúLayerGroup/FeatureGroupÊ≤°ÊúâgetBoundsÊñπÊ≥ïÔºåÈÅçÂéÜÂÖ∂Â≠êÂõæÂ±Ç
                            const subLayers = layer.getLayers();
                            for (let j = 0; j < subLayers.length; j++) {
                                try {
                                    const subLayerBounds = subLayers[j].getBounds();
                                    if (subLayerBounds && subLayerBounds.isValid && subLayerBounds.isValid()) {
                                        if (!groupBounds) {
                                            groupBounds = subLayerBounds;
                                        } else {
                                            groupBounds.extend(subLayerBounds);
                                        }
                                    }
                                } catch (e) {
                                    continue;
                                }
                            }
                            continue; // ÁªßÁª≠Â§ñÂ±ÇÂæ™ÁéØ
                        }
                    } else {
                        try {
                            layerBounds = layer.getBounds();
                        } catch (e) {
                            continue; // Â∞ùËØï‰∏ã‰∏Ä‰∏™ÂõæÂ±Ç
                        }
                    }

                    if (layerBounds && layerBounds.isValid && layerBounds.isValid()) {
                        if (!groupBounds) {
                            groupBounds = layerBounds;
                        } else {
                            groupBounds.extend(layerBounds);
                        }
                    }
                }

                if (groupBounds && groupBounds.isValid && groupBounds.isValid()) {
                    map.fitBounds(groupBounds, { padding: [20, 20] });
                }
            }

            updateStatus(`ËΩÆÂªìÁªòÂà∂ÂÆåÊàêÔºåÂÖ±${polygonData.length}‰∏™Â§öËæπÂΩ¢`);

        } catch (error) {
            console.error('WKTËß£ÊûêÈîôËØØ:', error);
            updateStatus('WKTËß£ÊûêÂ§±Ë¥•: ' + error.message);
        }
    }

    // Ê∏ÖÈô§ËΩÆÂªì
    function clearOutline() {
        outlineLayerGroup.clearLayers();
        currentOutline = null;
        updateStatus('ËΩÆÂªìÂ∑≤Ê∏ÖÈô§');
    }

    // ‰∏∫ÂõæÂ±ÇÊ∑ªÂä†Ê†áÁ≠æ
    function addLabelsToLayer(layer, prefix) {
        try {
            // Â¶ÇÊûúlayerÊòØLayerGroupÊàñFeatureGroupÔºåÈúÄË¶ÅËé∑ÂèñÂÖ∂‰∏≠ÁöÑÁ¨¨‰∏Ä‰∏™ÂõæÂ±ÇÊù•Ëé∑ÂèñËæπÁïå
            let bounds;
            if (layer instanceof L.LayerGroup || layer instanceof L.FeatureGroup) {
                const layers = layer.getLayers();
                if (layers && layers.length > 0) {
                    // ÈÅçÂéÜÊâÄÊúâÂ≠êÂõæÂ±ÇÊù•Ëé∑ÂèñÊúâÊïàÁöÑËæπÁïå
                    for (let i = 0; i < layers.length; i++) {
                        try {
                            const subLayer = layers[i];
                            let subLayerBounds;

                            // Ê£ÄÊü•Â≠êÂõæÂ±ÇÊòØÂê¶‰∏∫LayerGroupÊàñFeatureGroup
                            if (subLayer instanceof L.LayerGroup || subLayer instanceof L.FeatureGroup) {
                                // ÈÄíÂΩíÂ§ÑÁêÜÂµåÂ•óÁöÑLayerGroupÊàñFeatureGroup
                                const subSubLayers = subLayer.getLayers();
                                for (let j = 0; j < subSubLayers.length; j++) {
                                    try {
                                        const subSubLayerBounds = subSubLayers[j].getBounds();
                                        if (subSubLayerBounds && subSubLayerBounds.isValid && subSubLayerBounds.isValid()) {
                                            subLayerBounds = subSubLayerBounds;
                                            break;
                                        }
                                    } catch (e) {
                                        continue;
                                    }
                                }
                            } else {
                                subLayerBounds = subLayer.getBounds();
                            }

                            if (subLayerBounds && subLayerBounds.isValid && subLayerBounds.isValid()) {
                                bounds = subLayerBounds;
                                break; // ‰ΩøÁî®Á¨¨‰∏Ä‰∏™ÊúâÊïàÁöÑËæπÁïå
                            }
                        } catch (e) {
                            continue; // Â∞ùËØï‰∏ã‰∏Ä‰∏™ÂõæÂ±Ç
                        }
                    }
                }
            } else {
                // Â¶ÇÊûúÊòØÂçï‰∏™ÂõæÂ±ÇÔºåÁõ¥Êé•Ëé∑ÂèñËæπÁïå
                try {
                    bounds = layer.getBounds();
                } catch (e) {
                    console.error('Ëé∑ÂèñÂõæÂ±ÇËæπÁïåÂ§±Ë¥•:', e);
                    return; // Â¶ÇÊûúÊó†Ê≥ïËé∑ÂèñËæπÁïåÔºåÂàô‰∏çÊ∑ªÂä†Ê†áÁ≠æ
                }
            }

            if (bounds && bounds.isValid && bounds.isValid()) {
                const center = bounds.getCenter();
                const label = L.divIcon({
                    className: 'custom-label',
                    html: `<div style="background: rgba(0,0,0,0.8); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; white-space: nowrap;">${prefix}</div>`,
                    iconSize: null,
                    iconAnchor: [0, 0]
                });

                const labelMarker = L.marker(center, { icon: label });
                labelLayerGroup.addLayer(labelMarker);
            }
        } catch (error) {
            console.error('Ê∑ªÂä†Ê†áÁ≠æÈîôËØØ:', error);
        }
    }

    // ‰∏∫ÂõæÂ±ÇÊ∑ªÂä†Èù¢ÁßØÊ†áÁ≠æ
    function addAreaLabelToLayer(layer, areaText) {
        try {
            console.log('Â∞ùËØï‰∏∫ÂõæÂ±ÇÊ∑ªÂä†Èù¢ÁßØÊ†áÁ≠æ:', areaText);
            // Â¶ÇÊûúlayerÊòØLayerGroupÊàñFeatureGroupÔºåÈúÄË¶ÅËé∑ÂèñÂÖ∂‰∏≠ÁöÑÁ¨¨‰∏Ä‰∏™ÂõæÂ±ÇÊù•Ëé∑ÂèñËæπÁïå
            let bounds;
            if (layer instanceof L.LayerGroup || layer instanceof L.FeatureGroup) {
                const layers = layer.getLayers();
                if (layers && layers.length > 0) {
                    // ÈÅçÂéÜÊâÄÊúâÂ≠êÂõæÂ±ÇÊù•Ëé∑ÂèñÊúâÊïàÁöÑËæπÁïå
                    for (let i = 0; i < layers.length; i++) {
                        try {
                            const subLayer = layers[i];
                            let subLayerBounds;

                            // Ê£ÄÊü•Â≠êÂõæÂ±ÇÊòØÂê¶‰∏∫LayerGroupÊàñFeatureGroup
                            if (subLayer instanceof L.LayerGroup || subLayer instanceof L.FeatureGroup) {
                                // ÈÄíÂΩíÂ§ÑÁêÜÂµåÂ•óÁöÑLayerGroupÊàñFeatureGroup
                                const subSubLayers = subLayer.getLayers();
                                for (let j = 0; j < subSubLayers.length; j++) {
                                    try {
                                        const subSubLayerBounds = subSubLayers[j].getBounds();
                                        if (subSubLayerBounds && subSubLayerBounds.isValid && subSubLayerBounds.isValid()) {
                                            subLayerBounds = subSubLayerBounds;
                                            break;
                                        }
                                    } catch (e) {
                                        continue;
                                    }
                                }
                            } else {
                                subLayerBounds = subLayer.getBounds();
                            }

                            if (subLayerBounds && subLayerBounds.isValid && subLayerBounds.isValid()) {
                                bounds = subLayerBounds;
                                break; // ‰ΩøÁî®Á¨¨‰∏Ä‰∏™ÊúâÊïàÁöÑËæπÁïå
                            }
                        } catch (e) {
                            continue; // Â∞ùËØï‰∏ã‰∏Ä‰∏™ÂõæÂ±Ç
                        }
                    }
                }
            } else {
                // Â¶ÇÊûúÊòØÂçï‰∏™ÂõæÂ±ÇÔºåÁõ¥Êé•Ëé∑ÂèñËæπÁïå
                try {
                    bounds = layer.getBounds();
                } catch (e) {
                    console.error('Ëé∑ÂèñÂõæÂ±ÇËæπÁïåÂ§±Ë¥•:', e);
                    return; // Â¶ÇÊûúÊó†Ê≥ïËé∑ÂèñËæπÁïåÔºåÂàô‰∏çÊ∑ªÂä†Ê†áÁ≠æ
                }
            }

            if (bounds && bounds.isValid && bounds.isValid()) {
                const center = bounds.getCenter();
                const label = L.divIcon({
                    className: 'area-label',
                    html: areaText,
                    iconSize: null,
                    iconAnchor: null // ‰ΩøÁî®ÈªòËÆ§ÈîöÁÇπ
                });

                const labelMarker = L.marker(center, { icon: label });
                labelLayerGroup.addLayer(labelMarker);
                console.log('ÊàêÂäüÊ∑ªÂä†Èù¢ÁßØÊ†áÁ≠æÂà∞ÂõæÂ±ÇÁªÑ');
                console.log('ÂΩìÂâçÊ†áÁ≠æÂõæÂ±Ç‰∏≠ÁöÑÂõæÂ±ÇÊï∞Èáè:', labelLayerGroup.getLayers().length);
            } else {
                console.warn('Êó†Ê≥ïËé∑ÂèñÂõæÂ±ÇËæπÁïåÔºåÊó†Ê≥ïÊ∑ªÂä†Èù¢ÁßØÊ†áÁ≠æ');
            }
        } catch (error) {
            console.error('Ê∑ªÂä†Èù¢ÁßØÊ†áÁ≠æÈîôËØØ:', error);
        }
    }

    // ËΩ®ËøπÁªòÂà∂ÂáΩÊï∞
    function drawTrack() {
        const trackText = document.getElementById('trackTextarea').value.trim();
        const timeRangeText = document.getElementById('timeRangeInput').value.trim();

        if (!trackText) {
            alert('ËØ∑Á≤òË¥¥ËΩ®ËøπÊñáÊú¨ÔºàÊó∂Èó¥Êà≥,ÁªèÂ∫¶,Á∫¨Â∫¶Ôºâ');
            return;
        }

        // Ê∏ÖÈô§ËΩ®ËøπÊòæÁ§∫Ôºå‰ΩÜ‰øùÁïôËΩ®ËøπÁÇπÊï∞ÊçÆÁî®‰∫éÂõûÊîæ
        trackLayerGroup.clearLayers();
        currentTrack = null;
        
        // ÂÅúÊ≠¢ÂõûÊîæ‰ΩÜ‰∏çÈáçÁΩÆpointsÊï∞ÊçÆÂíåcurrentIndex
        playbackState.isPlaying = false;
        if (playbackState.timer) {
            clearTimeout(playbackState.timer);
            playbackState.timer = null;
        }
        
        // Ê∏ÖÈô§ÂõûÊîæÂÖÉÁ¥†
        if (playbackState.marker) {
            map.removeLayer(playbackState.marker);
            playbackState.marker = null;
        }
        if (playbackState.polyline) {
            map.removeLayer(playbackState.polyline);
            playbackState.polyline = null;
        }

        // Ëß£ÊûêÊó∂Èó¥ËåÉÂõ¥
        let startTime, endTime;
        if (timeRangeText) {
            const timeParts = timeRangeText.split(' - ');
            if (timeParts.length === 2) {
                startTime = new Date(timeParts[0].trim());
                endTime = new Date(timeParts[1].trim());

                if (isNaN(startTime.getTime()) || isNaN(endTime.getTime())) {
                    alert('Êó∂Èó¥ËåÉÂõ¥Ê†ºÂºè‰∏çÊ≠£Á°ÆÔºåËØ∑‰ΩøÁî®Ê†ºÂºèÔºö2025-10-23T13:56:49 - 2025-10-23T15:51:31');
                    return;
                }
            }
        }

        // Ëß£ÊûêËΩ®ËøπÊï∞ÊçÆ
        const points = [];
        const lines = trackText.split('\n');

        lines.forEach(line => {
            line = line.trim();
            if (!line) return;

            // ÊîØÊåÅ‰∏§ÁßçÊ†ºÂºèÔºö
            // 1. ÁªèÂ∫¶,Á∫¨Â∫¶,Êó∂Èó¥Êà≥
            // 2. Êó∂Èó¥Êà≥,ÁªèÂ∫¶,Á∫¨Â∫¶
            const parts = line.split(',');
            if (parts.length >= 3) {
                let lng, lat, timestamp;

                // Âà§Êñ≠Ê†ºÂºèÔºöÂ¶ÇÊûúÁ¨¨‰∏ÄÈÉ®ÂàÜÊòØÊï∞Â≠ó‰∏îÈïøÂ∫¶Â§ß‰∫é10ÔºåÂèØËÉΩÊòØÊó∂Èó¥Êà≥
                if (parts[0].trim().length > 10 && !isNaN(parts[0].trim())) {
                    // Ê†ºÂºèÔºöÊó∂Èó¥Êà≥,ÁªèÂ∫¶,Á∫¨Â∫¶
                    timestamp = parts[0].trim();
                    lng = parseFloat(parts[1].trim());
                    lat = parseFloat(parts[2].trim());
                } else {
                    // Ê†ºÂºèÔºöÁªèÂ∫¶,Á∫¨Â∫¶,Êó∂Èó¥Êà≥
                    lng = parseFloat(parts[0].trim());
                    lat = parseFloat(parts[1].trim());
                    timestamp = parts[2].trim();
                }

                if (!isNaN(lng) && !isNaN(lat) && timestamp && lat !== 0 && lng !== 0) {
                    const pointTime = parseTimestamp(timestamp);

                    // Ê£ÄÊü•Êó∂Èó¥ËåÉÂõ¥
                    if (startTime && endTime) {
                        if (pointTime < startTime || pointTime > endTime) {
                            return; // Ë∑≥Ëøá‰∏çÂú®Êó∂Èó¥ËåÉÂõ¥ÂÜÖÁöÑÁÇπ
                        }
                    }

                    points.push({
                        lat: lat,
                        lng: lng,
                        timestamp: timestamp,
                        time: pointTime
                    });
                }
            }
        });

        if (points.length < 2) {
            alert('ËØ•Êó∂Èó¥ËåÉÂõ¥ÂÜÖÁöÑÊúâÊïàËΩ®ËøπÁÇπ‰∏çË∂≥ÔºåËá≥Â∞ëÈúÄË¶Å‰∏§ÁÇπ');
            return;
        }

        // ÊåâÊó∂Èó¥ÊéíÂ∫è
        points.sort((a, b) => a.time - b.time);

        // ÁªòÂà∂ËΩ®ËøπÁ∫ø
        const latlngs = points.map(p => [p.lat, p.lng]);

        currentTrack = L.polyline(latlngs, {
            color: currentTrackLineColor,
            weight: 1,
            opacity: 0.9
        });

        trackLayerGroup.addLayer(currentTrack);

        // Ëá™ÈÄÇÂ∫îËßÜÈáé
        const group = new L.featureGroup([currentTrack]);
        map.fitBounds(group.getBounds().pad(0.1));

        // ‰øùÂ≠òËΩ®ËøπÁÇπÁî®‰∫éÂõûÊîæ
        playbackState.points = points;

        // ÂêØÁî®Êí≠ÊîæÂô®ÊéßÂà∂ÊåâÈíÆÔºàÂ¶ÇÊûúÊí≠ÊîæÂô®ÂÖÉÁ¥†Â≠òÂú®Ôºâ
        if (playbackPlayer) {
            updatePlayerControls();
        }

        updateStatus('ËΩ®ËøπÁªòÂà∂ÂÆåÊàê');
    }

    // CanvasËΩ®ËøπÁÇπÊ∏≤ÊüìÂô® - È´òÊÄßËÉΩÊ∏≤ÊüìÂ§ßÈáèËΩ®ËøπÁÇπ
    let trackCanvasLayer = null;
    
    // ËΩ®ËøπÁÇπÊ∏≤ÊüìÈÖçÁΩÆ
    const trackPointConfig = {
        maxPointsForFullRender: 100000,    // ÂÖ®ÈáèÊ∏≤ÊüìÁöÑÊúÄÂ§ßÁÇπÊï∞
        maxPointsForBatchRender: 10000,   // ÂàÜÊâπÊ∏≤ÊüìÁöÑÊúÄÂ§ßÁÇπÊï∞
        batchSize: 1000,                  // ÊØèÊâπÂ§ÑÁêÜÁöÑÁÇπÊï∞
        pointRadius: 0.5,                // ÁÇπÁöÑÂçäÂæÑÔºàÂÉèÁ¥†Ôºâ
        pointOpacity: 0.8,                 // ÁÇπÁöÑÈÄèÊòéÂ∫¶
        useSimplification: true,           // ÊòØÂê¶‰ΩøÁî®Êï∞ÊçÆÁÆÄÂåñ
        simplificationTolerance: 0.00001  // ÁÆÄÂåñÂÆπÂ∑ÆÔºàÂ∫¶Ôºâ
    };
    
    // ÂàõÂª∫CanvasÂõæÂ±ÇÁî®‰∫éËΩ®ËøπÁÇπÊ∏≤Êüì
    function createTrackCanvasLayer() {
        if (trackCanvasLayer) {
            map.removeLayer(trackCanvasLayer);
        }
        
        trackCanvasLayer = L.canvas();
        trackCanvasLayer.addTo(map);
        return trackCanvasLayer;
    }
    
    // Êï∞ÊçÆÁÆÄÂåñÂáΩÊï∞ - ÂáèÂ∞ëÁÇπÊï∞‰ΩÜ‰øùÊåÅËΩ®ËøπÂΩ¢Áä∂
    function simplifyPoints(points, tolerance) {
        if (points.length <= trackPointConfig.maxPointsForFullRender) {
            return points;
        }
        
        // ‰ΩøÁî®ÁÆÄÂçïÁöÑË∑ùÁ¶ªËøáÊª§ÁÆóÊ≥ï
        const simplified = [points[0]];
        let lastPoint = points[0];
        
        for (let i = 1; i < points.length; i++) {
            const currentPoint = points[i];
            const distance = Math.sqrt(
                Math.pow(currentPoint.lat - lastPoint.lat, 2) + 
                Math.pow(currentPoint.lng - lastPoint.lng, 2)
            );
            
            if (distance > tolerance) {
                simplified.push(currentPoint);
                lastPoint = currentPoint;
            }
        }
        
        // Á°Æ‰øùÂåÖÂê´ÊúÄÂêé‰∏Ä‰∏™ÁÇπ
        if (simplified[simplified.length - 1] !== points[points.length - 1]) {
            simplified.push(points[points.length - 1]);
        }
        
        console.log(`Êï∞ÊçÆÁÆÄÂåñ: ${points.length} -> ${simplified.length} ÁÇπ`);
        return simplified;
    }

    // ‰ΩøÁî®CanvasÁªòÂà∂ËΩ®ËøπÁÇπ - È´òÊÄßËÉΩÊñπÊ°à
    function showTrackPoints() {
        const trackText = document.getElementById('trackTextarea').value.trim();
        const timeRangeText = document.getElementById('timeRangeInput').value.trim();

        if (!trackText) {
            alert('ËØ∑Á≤òË¥¥ËΩ®ËøπÊñáÊú¨ÔºàÊó∂Èó¥Êà≥,ÁªèÂ∫¶,Á∫¨Â∫¶Ôºâ');
            return;
        }

        // Ê∏ÖÈô§ËΩ®ËøπÊòæÁ§∫Ôºå‰ΩÜ‰øùÁïôËΩ®ËøπÁÇπÊï∞ÊçÆÁî®‰∫éÂõûÊîæ
        trackLayerGroup.clearLayers();
        currentTrack = null;
        
        // ÂÅúÊ≠¢ÂõûÊîæ‰ΩÜ‰∏çÈáçÁΩÆpointsÊï∞ÊçÆÂíåcurrentIndex
        playbackState.isPlaying = false;
        if (playbackState.timer) {
            clearTimeout(playbackState.timer);
            playbackState.timer = null;
        }
        
        // Ê∏ÖÈô§ÂõûÊîæÂÖÉÁ¥†
        if (playbackState.marker) {
            map.removeLayer(playbackState.marker);
            playbackState.marker = null;
        }
        if (playbackState.polyline) {
            map.removeLayer(playbackState.polyline);
            playbackState.polyline = null;
        }

        // Ëß£ÊûêÊó∂Èó¥ËåÉÂõ¥
        let startTime, endTime;
        if (timeRangeText) {
            const timeParts = timeRangeText.split(' - ');
            if (timeParts.length === 2) {
                startTime = new Date(timeParts[0].trim());
                endTime = new Date(timeParts[1].trim());

                if (isNaN(startTime.getTime()) || isNaN(endTime.getTime())) {
                    alert('Êó∂Èó¥ËåÉÂõ¥Ê†ºÂºè‰∏çÊ≠£Á°ÆÔºåËØ∑‰ΩøÁî®Ê†ºÂºèÔºö2025-10-23T13:56:49 - 2025-10-23T15:51:31');
                    return;
                }
            }
        }

        // Ëß£ÊûêËΩ®ËøπÊï∞ÊçÆ
        const points = [];
        const lines = trackText.split('\n');

        lines.forEach(line => {
            line = line.trim();
            if (!line) return;

            // ÊîØÊåÅ‰∏§ÁßçÊ†ºÂºèÔºö
            // 1. ÁªèÂ∫¶,Á∫¨Â∫¶,Êó∂Èó¥Êà≥
            // 2. Êó∂Èó¥Êà≥,ÁªèÂ∫¶,Á∫¨Â∫¶
            const parts = line.split(',');
            if (parts.length >= 3) {
                let lng, lat, timestamp;

                // Âà§Êñ≠Ê†ºÂºèÔºöÂ¶ÇÊûúÁ¨¨‰∏ÄÈÉ®ÂàÜÊòØÊï∞Â≠ó‰∏îÈïøÂ∫¶Â§ß‰∫é10ÔºåÂèØËÉΩÊòØÊó∂Èó¥Êà≥
                if (parts[0].trim().length > 10 && !isNaN(parts[0].trim())) {
                    // Ê†ºÂºèÔºöÊó∂Èó¥Êà≥,ÁªèÂ∫¶,Á∫¨Â∫¶
                    timestamp = parts[0].trim();
                    lng = parseFloat(parts[1].trim());
                    lat = parseFloat(parts[2].trim());
                } else {
                    // Ê†ºÂºèÔºöÁªèÂ∫¶,Á∫¨Â∫¶,Êó∂Èó¥Êà≥
                    lng = parseFloat(parts[0].trim());
                    lat = parseFloat(parts[1].trim());
                    timestamp = parts[2].trim();
                }

                if (!isNaN(lng) && !isNaN(lat) && timestamp && lat !== 0 && lng !== 0) {
                    const pointTime = parseTimestamp(timestamp);

                    // Ê£ÄÊü•Êó∂Èó¥ËåÉÂõ¥
                    if (startTime && endTime) {
                        if (pointTime < startTime || pointTime > endTime) {
                            return; // Ë∑≥Ëøá‰∏çÂú®Êó∂Èó¥ËåÉÂõ¥ÂÜÖÁöÑÁÇπ
                        }
                    }

                    points.push({
                        lat: lat,
                        lng: lng,
                        timestamp: timestamp,
                        time: pointTime
                    });
                }
            }
        });

        if (points.length === 0) {
            alert('ËØ•Êó∂Èó¥ËåÉÂõ¥ÂÜÖÊ≤°ÊúâÊâæÂà∞ËΩ®ËøπÁÇπ');
            return;
        }

        // ÊåâÊó∂Èó¥ÊéíÂ∫è
        points.sort((a, b) => a.time - b.time);

        // ‰øùÂ≠òËΩ®ËøπÁÇπÁî®‰∫éÂõûÊîæ
        playbackState.points = points;

        // ‰ΩøÁî®CanvasÊ∏≤ÊüìËΩ®ËøπÁÇπ
        renderTrackPointsWithCanvas(points);
    }

    // CanvasÊ∏≤ÊüìËΩ®ËøπÁÇπ - Ë∂ÖÈ´òÊÄßËÉΩÊñπÊ°àÔºàÊîØÊåÅÊµ∑ÈáèÊï∞ÊçÆÔºâ
    function renderTrackPointsWithCanvas(points) {
        const totalPoints = points.length;
        updateStatus(`ÂºÄÂßãCanvasÊ∏≤ÊüìËΩ®ËøπÁÇπÔºåÂÖ±${totalPoints}‰∏™ÁÇπ...`);

        // Êï∞ÊçÆÁÆÄÂåñÂ§ÑÁêÜÔºàÈíàÂØπÊµ∑ÈáèÊï∞ÊçÆÔºâ
        let renderPoints = points;
        if (trackPointConfig.useSimplification && totalPoints > trackPointConfig.maxPointsForFullRender) {
            renderPoints = simplifyPoints(points, trackPointConfig.simplificationTolerance);
            updateStatus(`Êï∞ÊçÆÁÆÄÂåñÂêéÔºåÂÖ±${renderPoints.length}‰∏™ÁÇπ...`);
        }

        // ÂàõÂª∫CanvasÂõæÂ±Ç
        createTrackCanvasLayer();
        const canvasLayer = trackCanvasLayer;
        
        // Ê†πÊçÆÁÇπÊï∞ÈÄâÊã©‰∏çÂêåÁöÑÊ∏≤ÊüìÁ≠ñÁï•
        if (renderPoints.length <= trackPointConfig.maxPointsForFullRender) {
            // Â∞èÊï∞ÊçÆÈáè - ‰∏ÄÊ¨°ÊÄßÊ∏≤Êüì
            renderAllPointsAtOnce(renderPoints, canvasLayer);
        } else if (renderPoints.length <= trackPointConfig.maxPointsForBatchRender) {
            // ‰∏≠Á≠âÊï∞ÊçÆÈáè - ÂàÜÊâπÊ∏≤Êüì
            renderPointsInBatches(renderPoints, canvasLayer);
        } else {
            // Â§ßÊï∞ÊçÆÈáè - Ë∂ÖÂ§ßÊâπÈáèÊ∏≤Êüì
            renderPointsInLargeBatches(renderPoints, canvasLayer);
        }
    }
    
    // ‰∏ÄÊ¨°ÊÄßÊ∏≤ÊüìÊâÄÊúâÁÇπÔºàÈÄÇÂêàÂ∞èÊï∞ÊçÆÈáèÔºâ
    function renderAllPointsAtOnce(points, canvasLayer) {
        requestAnimationFrame(() => {
            try {
                const circleMarkers = [];
                const pointColor = currentTrackPointColor;
                const radius = trackPointConfig.pointRadius;
                
                // È´òÊïàÂàõÂª∫ÊâÄÊúâÁÇπ
                for (let i = 0; i < points.length; i++) {
                    const point = points[i];
                    const circleMarker = L.circleMarker([point.lat, point.lng], {
                        radius: radius,
                        fillColor: pointColor,
                        color: pointColor,
                        weight: 0,
                        opacity: trackPointConfig.pointOpacity,
                        fillOpacity: trackPointConfig.pointOpacity,
                        renderer: canvasLayer,
                        interactive: true,
                        className: 'tiny-point'
                    });

                    circleMarker.on('click', function() {
                        this.bindPopup(`ËΩ®ËøπÁÇπ ${i + 1}<br>Êó∂Èó¥: ${point.timestamp}<br>ÁªèÂ∫¶: ${point.lng.toFixed(6)}<br>Á∫¨Â∫¶: ${point.lat.toFixed(6)}`).openPopup();
                    });

                    circleMarkers.push(circleMarker);
                }

                // ÊâπÈáèÊ∑ªÂä†Âà∞Âú∞Âõæ
                const canvasPoints = L.layerGroup(circleMarkers);
                canvasPoints.addTo(map);
                trackLayerGroup.addLayer(canvasPoints);

                // Ëá™ÈÄÇÂ∫îËßÜÈáé
                adjustMapView(points);
                
                updateStatus(`CanvasÊ∏≤ÊüìÂÆåÊàêÔºåÂÖ±${points.length}‰∏™ÁÇπ`);
                updatePlayerControls();
                
            } catch (error) {
                console.error('CanvasÊ∏≤ÊüìÈîôËØØ:', error);
                updateStatus('CanvasÊ∏≤ÊüìÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞ÂàÜÊâπÊ∏≤Êüì');
                renderPointsInBatches(points, canvasLayer);
            }
        });
    }
    
    // ÂàÜÊâπÊ∏≤ÊüìÔºàÈÄÇÂêà‰∏≠Á≠âÊï∞ÊçÆÈáèÔºâ
    function renderPointsInBatches(points, canvasLayer) {
        const totalPoints = points.length;
        const batchSize = trackPointConfig.batchSize;
        let currentBatch = 0;
        let processedCount = 0;
        const pointColor = currentTrackPointColor;
        const radius = trackPointConfig.pointRadius;
        
        function drawBatch() {
            const startIdx = currentBatch * batchSize;
            const endIdx = Math.min(startIdx + batchSize, totalPoints);
            
            const batchMarkers = [];
            for (let i = startIdx; i < endIdx; i++) {
                const point = points[i];
                const circleMarker = L.circleMarker([point.lat, point.lng], {
                    radius: radius,
                    fillColor: pointColor,
                    color: pointColor,
                    weight: 0,
                    opacity: trackPointConfig.pointOpacity,
                    fillOpacity: trackPointConfig.pointOpacity,
                    renderer: canvasLayer,
                    interactive: true,
                    className: 'tiny-point'
                });

                circleMarker.on('click', function() {
                    this.bindPopup(`ËΩ®ËøπÁÇπ ${i + 1}<br>Êó∂Èó¥: ${point.timestamp}<br>ÁªèÂ∫¶: ${point.lng.toFixed(6)}<br>Á∫¨Â∫¶: ${point.lat.toFixed(6)}`).openPopup();
                });

                batchMarkers.push(circleMarker);
            }

            const batchLayer = L.layerGroup(batchMarkers);
            batchLayer.addTo(map);
            trackLayerGroup.addLayer(batchLayer);

            processedCount += batchMarkers.length;
            currentBatch++;

            const progress = Math.round((processedCount / totalPoints) * 100);
            updateStatus(`ËΩ®ËøπÁÇπÊ∏≤Êüì‰∏≠... ${progress}% (${processedCount}/${totalPoints})`);

            if (processedCount < totalPoints) {
                setTimeout(drawBatch, 16); // 60fpsÁöÑÂ∏ßÈó¥Èöî
            } else {
                adjustMapView(points);
                updateStatus(`CanvasÊ∏≤ÊüìÂÆåÊàêÔºåÂÖ±${totalPoints}‰∏™ÁÇπ`);
                updatePlayerControls();
            }
        }

        drawBatch();
    }
    
    // Ë∂ÖÂ§ßÊâπÈáèÊ∏≤ÊüìÔºàÈÄÇÂêàÂ§ßÊï∞ÊçÆÈáèÔºâ
    function renderPointsInLargeBatches(points, canvasLayer) {
        const totalPoints = points.length;
        const batchSize = trackPointConfig.batchSize * 2; // Êõ¥Â§ßÁöÑÊâπÊ¨°
        let currentBatch = 0;
        let processedCount = 0;
        const pointColor = currentTrackPointColor;
        const radius = trackPointConfig.pointRadius;
        
        function drawLargeBatch() {
            const startIdx = currentBatch * batchSize;
            const endIdx = Math.min(startIdx + batchSize, totalPoints);
            
            const batchMarkers = [];
            for (let i = startIdx; i < endIdx; i++) {
                const point = points[i];
                const circleMarker = L.circleMarker([point.lat, point.lng], {
                    radius: radius,
                    fillColor: pointColor,
                    color: pointColor,
                    weight: 0,
                    opacity: trackPointConfig.pointOpacity,
                    fillOpacity: trackPointConfig.pointOpacity,
                    renderer: canvasLayer,
                    interactive: false,
                    className: 'tiny-point'
                });

                circleMarker.on('click', function() {
                    this.bindPopup(`ËΩ®ËøπÁÇπ ${i + 1}<br>Êó∂Èó¥: ${point.timestamp}<br>ÁªèÂ∫¶: ${point.lng.toFixed(6)}<br>Á∫¨Â∫¶: ${point.lat.toFixed(6)}`).openPopup();
                });

                batchMarkers.push(circleMarker);
            }

            const batchLayer = L.layerGroup(batchMarkers);
            batchLayer.addTo(map);
            trackLayerGroup.addLayer(batchLayer);

            processedCount += batchMarkers.length;
            currentBatch++;

            const progress = Math.round((processedCount / totalPoints) * 100);
            updateStatus(`ËΩ®ËøπÁÇπÊ∏≤Êüì‰∏≠... ${progress}% (${processedCount}/${totalPoints})`);

            if (processedCount < totalPoints) {
                setTimeout(drawLargeBatch, 32); // Êõ¥ÈïøÁöÑÈó¥ÈöîÔºåÈÅøÂÖçÈòªÂ°û
            } else {
                adjustMapView(points);
                updateStatus(`CanvasÊ∏≤ÊüìÂÆåÊàêÔºåÂÖ±${totalPoints}‰∏™ÁÇπ`);
                updatePlayerControls();
            }
        }

        drawLargeBatch();
    }
    
    // Ë∞ÉÊï¥Âú∞ÂõæËßÜÈáé
    function adjustMapView(points) {
        if (points.length === 1) {
            map.setView([points[0].lat, points[0].lng], map.getZoom());
        } else {
            const bounds = L.latLngBounds(points.map(p => [p.lat, p.lng]));
            map.fitBounds(bounds.pad(0.1));
        }
    }

    // ÂõûÈÄÄÊñπÊ°àÔºöÂàÜÊâπDOMÊ∏≤ÊüìÔºàÁî®‰∫éCanvasÂ§±Ë¥•ÁöÑÊÉÖÂÜµÔºâ
    function renderTrackPointsWithBatch(points) {
        const totalPoints = points.length;
        const batchSize = 500; // Â¢ûÂ§ßÊâπÊ¨°Â§ßÂ∞è
        let currentBatch = 0;
        let processedCount = 0;

        function drawBatch() {
            const startIdx = currentBatch * batchSize;
            const endIdx = Math.min(startIdx + batchSize, totalPoints);
            const batchPoints = points.slice(startIdx, endIdx);

            // ÊâπÈáèÂàõÂª∫CircleMarkerÔºà‰ΩøÁî®CanvasÊ∏≤ÊüìÔºâ
            const batchLayer = L.layerGroup();
            batchPoints.forEach((point, index) => {
                const actualIndex = startIdx + index;
                
                const circleMarker = L.circleMarker([point.lat, point.lng], {
                    radius: 0.5,
                    fillColor: currentTrackPointColor,
                    color: currentTrackPointColor,
                    weight: 0,
                    opacity: 0.8,
                    fillOpacity: 0.8,
                    interactive: true
                });

                circleMarker.on('click', function() {
                    this.bindPopup(`ËΩ®ËøπÁÇπ ${actualIndex + 1}<br>Êó∂Èó¥: ${point.timestamp}<br>ÁªèÂ∫¶: ${point.lng.toFixed(6)}<br>Á∫¨Â∫¶: ${point.lat.toFixed(6)}`).openPopup();
                });

                batchLayer.addLayer(circleMarker);
            });

            batchLayer.addTo(map);
            trackLayerGroup.addLayer(batchLayer);

            processedCount += batchPoints.length;
            currentBatch++;

            const progress = Math.round((processedCount / totalPoints) * 100);
            updateStatus(`ËΩ®ËøπÁÇπÁªòÂà∂‰∏≠... ${progress}% (${processedCount}/${totalPoints})`);

            if (processedCount < totalPoints) {
                setTimeout(drawBatch, 50); // Â¢ûÂä†Èó¥ÈöîÊó∂Èó¥
            } else {
                if (totalPoints === 1) {
                    map.setView([points[0].lat, points[0].lng], map.getZoom());
                } else {
                    const bounds = L.latLngBounds(points.map(p => [p.lat, p.lng]));
                    map.fitBounds(bounds.pad(0.1));
                }
                updateStatus(`ËΩ®ËøπÁÇπÁªòÂà∂ÂÆåÊàêÔºåÂÖ±${totalPoints}‰∏™ÁÇπ`);
                updatePlayerControls();
            }
        }

        drawBatch();
    }

    // Ëß£ÊûêËΩ®ËøπÁÇπ - ÂàÜÊâπÂ§ÑÁêÜÈÅøÂÖçÈ°µÈù¢Âç°Ê≠ª
    function parseTrackPoints(text) {
        try {
            const lines = text.trim().split('\n');
            const points = [];

            lines.forEach(line => {
                const parts = line.split(',');
                if (parts.length >= 3) {
                    const lng = parseFloat(parts[0].trim());
                    const lat = parseFloat(parts[1].trim());
                    const timestamp = parts[2].trim();

                    if (!isNaN(lng) && !isNaN(lat) && lat !== 0 && lng !== 0) {
                        points.push({
                            lat: lat,
                            lng: lng,
                            timestamp: timestamp,
                            time: parseTimestamp(timestamp)
                        });
                    }
                }
            });

            if (points.length > 0) {
                // ÊåâÊó∂Èó¥ÊéíÂ∫è
                points.sort((a, b) => a.time - b.time);

                // ‰øùÂ≠òËΩ®ËøπÁÇπÁî®‰∫éÂõûÊîæ
                playbackState.points = points;

                // ÂàÜÊâπÁªòÂà∂ËΩ®ËøπÁÇπÔºåÈÅøÂÖçÈ°µÈù¢Âç°Ê≠ª
                const batchSize = 100; // ÊØèÊâπÂ§ÑÁêÜ100‰∏™ÁÇπ
                let currentBatch = 0;
                let processedCount = 0;
                const totalPoints = points.length;

                updateStatus(`ÂºÄÂßãÁªòÂà∂ËΩ®ËøπÁÇπÔºåÂÖ±${totalPoints}‰∏™ÁÇπÔºåÂàÜÊâπÂ§ÑÁêÜ‰∏≠...`);

                function drawBatch() {
                    const startIdx = currentBatch * batchSize;
                    const endIdx = Math.min(startIdx + batchSize, totalPoints);
                    const batchPoints = points.slice(startIdx, endIdx);

                    // ÁªòÂà∂ÂΩìÂâçÊâπÊ¨°ÁöÑÁÇπ
                    batchPoints.forEach((point, index) => {
                        const actualIndex = startIdx + index;
                        
                        // ÂàõÂª∫ÊûÅÂ∞èÁöÑDivIcon
                        const tinyIcon = L.divIcon({
                            className: 'tiny-track-point',
                            html: `<div style="width: 1px; height: 1px; background-color: ${currentTrackPointColor}; border-radius: 50%;"></div>`,
                            iconSize: [1, 1],
                            iconAnchor: [0.5, 0.5]
                        });

                        const marker = L.marker([point.lat, point.lng], {
                            icon: tinyIcon,
                            opacity: 0.8
                        });

                        marker.bindPopup(`ËΩ®ËøπÁÇπ ${actualIndex + 1}<br>Êó∂Èó¥: ${point.timestamp}<br>ÁªèÂ∫¶: ${point.lng.toFixed(6)}<br>Á∫¨Â∫¶: ${point.lat.toFixed(6)}`);
                        trackLayerGroup.addLayer(marker);
                    });

                    processedCount += batchPoints.length;
                    currentBatch++;

                    // Êõ¥Êñ∞ËøõÂ∫¶Áä∂ÊÄÅ
                    const progress = Math.round((processedCount / totalPoints) * 100);
                    updateStatus(`ËΩ®ËøπÁÇπÁªòÂà∂‰∏≠... ${progress}% (${processedCount}/${totalPoints})`);

                    // Â¶ÇÊûúËøòÊúâÊú™Â§ÑÁêÜÁöÑÁÇπÔºåÁªßÁª≠‰∏ã‰∏ÄÊâπ
                    if (processedCount < totalPoints) {
                        // ‰ΩøÁî®setTimeoutËÆ©ÊµèËßàÂô®ÊúâÊó∂Èó¥Â§ÑÁêÜÂÖ∂‰ªñ‰ªªÂä°ÔºåÈÅøÂÖçÂç°Ê≠ª
                        setTimeout(drawBatch, 10);
                    } else {
                          // ÊâÄÊúâÁÇπÁªòÂà∂ÂÆåÊàê
                          updateStatus(`ËΩ®ËøπÁÇπÁªòÂà∂ÂÆåÊàêÔºåÂÖ±${totalPoints}‰∏™ÁÇπ`);
                          
                          // Êõ¥Êñ∞Êí≠ÊîæÂô®ÊéßÂà∂Áä∂ÊÄÅ
                          updatePlayerControls();
                      }
                }

                // ÂºÄÂßãÁ¨¨‰∏ÄÊâπÁªòÂà∂
                drawBatch();
            }
        } catch (error) {
            console.error('ËΩ®ËøπÁÇπËß£ÊûêÈîôËØØ:', error);
            updateStatus('ËΩ®ËøπÁÇπËß£ÊûêÂ§±Ë¥•');
        }
    }

    // Êó∂Èó¥Êà≥Ëß£Êûê
    function parseTimestamp(timestamp) {
        const tstr = (timestamp || '').replace(/\D/g, '');
        const m = tstr && tstr.match(/^\d{14}$/);
        if (!m) return null;

        const y = parseInt(tstr.slice(0, 4), 10);
        const M = parseInt(tstr.slice(4, 6), 10) - 1;
        const d = parseInt(tstr.slice(6, 8), 10);
        const h = parseInt(tstr.slice(8, 10), 10);
        const m2 = parseInt(tstr.slice(10, 12), 10);
        const s = parseInt(tstr.slice(12, 14), 10);
        const dt = new Date(y, M, d, h, m2, s);
        return isNaN(dt.getTime()) ? null : dt;
    }

    // Ê∏ÖÈô§ËΩ®Ëøπ
    function clearTrack() {
        trackLayerGroup.clearLayers();
        currentTrack = null;
        
        // Âè™ÊöÇÂÅúÂõûÊîæÔºå‰∏çÈáçÁΩÆcurrentIndexÂíåpointsÔºåËøôÊ†∑Áî®Êà∑ÂèØ‰ª•ÈáçÊñ∞ÁªòÂà∂ËΩ®ËøπÂêéÁªßÁª≠ÂõûÊîæ
        playbackState.isPlaying = false;
        if (playbackState.timer) {
            clearTimeout(playbackState.timer);
            playbackState.timer = null;
        }
        
        // Ê∏ÖÈô§ÂõûÊîæÂÖÉÁ¥†Ôºå‰ΩÜ‰øùÁïôpointsÊï∞ÊçÆ
        if (playbackState.marker) {
            map.removeLayer(playbackState.marker);
            playbackState.marker = null;
        }
        if (playbackState.polyline) {
            map.removeLayer(playbackState.polyline);
            playbackState.polyline = null;
        }

        // ÈáçÁΩÆÊí≠ÊîæÂô®Áä∂ÊÄÅÔºàÂ¶ÇÊûúÊí≠ÊîæÂô®ÂÖÉÁ¥†Â≠òÂú®Ôºâ
        if (playbackPlayer) {
            updatePlayerControls();
        }
        
        // Ê∏ÖÈô§ËΩ®ËøπÊó∂ÈáçÁΩÆËøõÂ∫¶Êù°ÂíåÊó∂Èó¥ÊòæÁ§∫
        if (playerProgressSlider) {
            playerProgressSlider.value = 0;
            playerProgressSlider.disabled = true;
        }
        // Âè™ÈáçÁΩÆÂΩìÂâçÊó∂Èó¥Ôºå‰øùÊåÅÁªìÊùüÊó∂Èó¥‰∏çÂèò
        const currentTimeElement = document.getElementById('currentTime');
        if (currentTimeElement) currentTimeElement.textContent = '00:00:00';
        // ‰∏çÈáçÁΩÆtotalTimeElementÔºå‰øùÊåÅÁªìÊùüÊó∂Èó¥ÊòæÁ§∫

        updateStatus('ËΩ®ËøπÂ∑≤Ê∏ÖÈô§');
    }

    // ËΩ®ËøπÂõûÊîæÊéßÂà∂ÂáΩÊï∞ - ‰ΩøÁî®Êñ∞ÁöÑÊí≠ÊîæÂô®ÊéßÂà∂Èù¢Êùø
    function startPlayback() {
        // Ê£ÄÊü•ÊòØÂê¶ÊúâËΩ®ËøπÁÇπ
        if (!playbackState.points || playbackState.points.length === 0) {
            updateStatus('ÊöÇÊó†ËΩ®ËøπÊï∞ÊçÆÔºåÊó†Ê≥ïÂºÄÂßãÂõûÊîæ');
            return;
        }

        if (playbackState.isPlaying) {
            return;
        }

        // ÂÅúÊ≠¢‰πãÂâçÁöÑÂõûÊîæÔºà‰ΩÜ‰∏çÈáçÁΩÆcurrentIndexÔºâ
        if (playbackState.timer) {
            clearTimeout(playbackState.timer);
            playbackState.timer = null;
        }

        playbackState.isPlaying = true;
        // ‰∏çÈáçÁΩÆcurrentIndexÔºå‰øùÊåÅÂΩìÂâçÊí≠Êîæ‰ΩçÁΩÆ

        // Â¶ÇÊûúÊí≠ÊîæÂÖÉÁ¥†‰∏çÂ≠òÂú®ÔºåÂàõÂª∫ÂÆÉ‰ª¨
        if (!playbackState.marker || !playbackState.polyline) {
            // Ê∏ÖÈô§‰πãÂâçÁöÑÂõûÊîæÂÖÉÁ¥†
            if (playbackState.marker) {
                map.removeLayer(playbackState.marker);
            }
            if (playbackState.polyline) {
                map.removeLayer(playbackState.polyline);
            }

            // ÂàõÂª∫ÂõûÊîæËΩ®ËøπÁ∫øÔºà‰ΩøÁî®ËøáÊª§ÂêéÁöÑÁÇπÔºâ
            const latlngs = playbackState.filteredPoints.map(p => [p.lat, p.lng]);
            playbackState.polyline = L.polyline(latlngs, {
                color: currentTrackLineColor,
                weight: 1,
                opacity: 0.6
            }).addTo(map);

            // ÂàõÂª∫ÂõûÊîæÊ†áËÆ∞Ôºà‰ΩøÁî®ËøáÊª§ÂêéÁöÑÁ¨¨‰∏Ä‰∏™ÁÇπÔºâ
            const firstPoint = playbackState.filteredPoints[0];
            playbackState.marker = L.circleMarker([firstPoint.lat, firstPoint.lng], {
                radius: 0.5,
                fillColor: currentTrackLineColor,
                color: '#FFFFFF',
                weight: 0.5,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(map);

            // Ëá™ÈÄÇÂ∫îËßÜÈáéÂà∞ËΩ®ËøπËåÉÂõ¥
            const bounds = playbackState.polyline.getBounds();
            if (bounds && bounds.isValid()) {
                map.fitBounds(bounds, { padding: [20, 20] });
            }
        }

        // Êõ¥Êñ∞Êí≠ÊîæÂô®ÊéßÂà∂Áä∂ÊÄÅ
        updatePlayerControls();
        
        // ËÆæÁΩÆËøõÂ∫¶Êù°ÂíåÊó∂Èó¥ÊòæÁ§∫Ôºà‰∏çÈáçÁΩÆËøõÂ∫¶Ôºâ
        if (playerProgressSlider) {
            playerProgressSlider.disabled = false;
            playerProgressSlider.max = 100;
            
            // Ê†πÊçÆËøáÊª§ÂêéÁöÑÁÇπËÆæÁΩÆÂàùÂßãËøõÂ∫¶
            if (playbackState.filteredPoints.length > 0) {
                const initialProgress = Math.round((playbackState.currentIndex / (playbackState.filteredPoints.length - 1)) * 100);
                playerProgressSlider.value = initialProgress;
            }
        }
        
        if (playerSpeedValue) {
            // ÊòæÁ§∫ÊåáÊï∞ÂÄçÊï∞
            const displaySpeed = playbackState.speed || 1;
            playerSpeedValue.textContent = displaySpeed + 'x';
        }

        // ÂàùÂßãÂåñÊó∂Èó¥ÊòæÁ§∫Ôºà‰ΩøÁî®ËøáÊª§ÂêéÁöÑÁÇπÔºâ
        if (playbackState.filteredPoints.length > 0) {
            const currentPoint = playbackState.filteredPoints[playbackState.currentIndex];
            const lastPoint = playbackState.filteredPoints[playbackState.filteredPoints.length - 1];
            
            if (currentPoint && lastPoint) {
                const currentTime = formatTime(currentPoint.timestamp);
                const totalTime = formatTime(lastPoint.timestamp);
                
                const currentTimeElement = document.getElementById('currentTime');
                const totalTimeElement = document.getElementById('totalTime');
                if (currentTimeElement) currentTimeElement.textContent = currentTime;
                if (totalTimeElement) totalTimeElement.textContent = totalTime;
            }
        }

        // ÂºÄÂßãÊí≠Êîæ
        playbackNextPoint();
        updateStatus('ËΩ®ËøπÂõûÊîæÂºÄÂßã');
    }

    function playbackNextPoint() {
        if (!playbackState.isPlaying || !playbackState.filteredPoints || playbackState.currentIndex >= playbackState.filteredPoints.length) {
            // Âè™ÊúâÂú®Êí≠ÊîæÂÆåÊàêÊó∂ÊâçÂÅúÊ≠¢Âπ∂ÈáçÁΩÆÔºåÊöÇÂÅúÊó∂‰∏çÂÅúÊ≠¢
            if (playbackState.currentIndex >= playbackState.filteredPoints.length) {
                // Êí≠ÊîæÂÆåÊàêÔºåÂè™ÈáçÁΩÆÁä∂ÊÄÅ‰ΩÜ‰∏çÊ∏ÖÈô§ËΩ®ËøπÁ∫ø
                playbackState.isPlaying = false;
                playbackState.currentIndex = 0;
                
                // Ê∏ÖÈô§ÂÆöÊó∂Âô®
                if (playbackState.timer) {
                    clearTimeout(playbackState.timer);
                    playbackState.timer = null;
                }
                
                // Ê∏ÖÈô§Ê†áËÆ∞Ôºà‰øùÁïôËΩ®ËøπÁ∫øÔºâ
                if (playbackState.marker) {
                    map.removeLayer(playbackState.marker);
                    playbackState.marker = null;
                }
                
                // Êí≠ÊîæÂÆåÊàêÊó∂‰∏çÈúÄË¶ÅÈáçÁΩÆÊó∂Èó¥ÊòæÁ§∫Ôºå‰øùÊåÅÂΩìÂâçÊó∂Èó¥
                // ‰πü‰∏çÈúÄË¶ÅÈáçÁΩÆËøõÂ∫¶Êù°‰ΩçÁΩÆ
                // const currentTimeElement = document.getElementById('currentTime');
                // const totalTimeElement = document.getElementById('totalTime');
                // if (currentTimeElement) currentTimeElement.textContent = '00:00:00';
                // if (totalTimeElement) totalTimeElement.textContent = '00:00:00';
                
                // Êõ¥Êñ∞Êí≠ÊîæÂô®ÊéßÂà∂Áä∂ÊÄÅÔºàÂ¶ÇÊûúÊí≠ÊîæÂô®ÂÖÉÁ¥†Â≠òÂú®Ôºâ
                if (playbackPlayer) {
                    updatePlayerControls();
                }
                
                updateStatus('ËΩ®ËøπÂõûÊîæÂÆåÊàê');
            }
            return;
        }

        const point = playbackState.filteredPoints[playbackState.currentIndex];

        // Êõ¥Êñ∞Ê†áËÆ∞‰ΩçÁΩÆ
        playbackState.marker.setLatLng([point.lat, point.lng]);
        playbackState.marker.bindPopup(`ÂõûÊîæÁÇπ ${playbackState.currentIndex + 1}<br>Êó∂Èó¥: ${point.timestamp}<br>ÁªèÂ∫¶: ${point.lng.toFixed(6)}<br>Á∫¨Â∫¶: ${point.lat.toFixed(6)}`);

        // Êõ¥Êñ∞ËΩ®ËøπÁ∫ø
        const currentLatlngs = playbackState.filteredPoints.slice(0, playbackState.currentIndex + 1).map(p => [p.lat, p.lng]);
        playbackState.polyline.setLatLngs(currentLatlngs);

        // Ê£ÄÊü•ÁÇπÊòØÂê¶Âú®Â±èÂπïÂèØËßÅËåÉÂõ¥ÂÜÖÔºåÂè™Êúâ‰∏çÂú®ÂèØËßÅËåÉÂõ¥ÂÜÖÊó∂ÊâçÂ±Ö‰∏≠
        const pointLatLng = L.latLng(point.lat, point.lng);
        const bounds = map.getBounds();
        
        // Â¶ÇÊûúÁÇπ‰∏çÂú®ÂΩìÂâçÂú∞ÂõæËæπÁïåÂÜÖÔºåÊàñËÄÖË∑ùÁ¶ªËæπÁïåÂ§™ËøëÔºàÂ∞è‰∫éÂú∞ÂõæÂÆΩÈ´òÁöÑ10%ÔºâÔºåÂàôÂ±Ö‰∏≠
        if (!bounds.contains(pointLatLng)) {
            // ÁÇπÂÆåÂÖ®‰∏çÂú®Â±èÂπïÂÜÖÔºåÈúÄË¶ÅÂ±Ö‰∏≠
            map.setView([point.lat, point.lng], map.getZoom(), {
                animate: true,
                duration: 0.3
            });
        } else {
            // ÁÇπÂú®Â±èÂπïÂÜÖÔºåÊ£ÄÊü•ÊòØÂê¶Èù†ËøëËæπÁïåÔºàË∑ùÁ¶ªËæπÁïåÂ∞è‰∫éÂú∞ÂõæÂÆΩÈ´òÁöÑ10%Ôºâ
            const boundsPad = bounds.pad(-0.1); // ÂÜÖÁº©10%ÁöÑËæπÁïå
            if (!boundsPad.contains(pointLatLng)) {
                // ÁÇπÈù†ËøëËæπÁïåÔºåÂ±Ö‰∏≠ÊòæÁ§∫
                map.setView([point.lat, point.lng], map.getZoom(), {
                    animate: true,
                    duration: 0.3
                });
            }
            // ÁÇπÂú®Â±èÂπï‰∏≠Â§ÆÂå∫ÂüüÔºå‰∏çÈúÄË¶ÅÂ±Ö‰∏≠
        }

        // Ê†ºÂºèÂåñÊó∂Èó¥ÊòæÁ§∫ÂáΩÊï∞
        function formatTime(timestamp) {
            const date = parseTimestamp(timestamp);
            if (!date) return '00:00:00';
            
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const seconds = date.getSeconds().toString().padStart(2, '0');
            return hours + ':' + minutes + ':' + seconds;
        }

        // Êõ¥Êñ∞ËøõÂ∫¶Êù°ÂíåÊó∂Èó¥ÊòæÁ§∫
        if (playerProgressSlider && playbackState.filteredPoints.length > 0) {
            const percentage = Math.round((playbackState.currentIndex / (playbackState.filteredPoints.length - 1)) * 100);
            playerProgressSlider.value = percentage;
        }
        
        // Êõ¥Êñ∞Êó∂Èó¥ÊòæÁ§∫ÔºàÂ¶ÇÊûúÊí≠ÊîæÂô®ÂÖÉÁ¥†Â≠òÂú®Ôºâ
        if (playbackState.filteredPoints.length > 0) {
            const currentPoint = playbackState.filteredPoints[playbackState.currentIndex];
            const lastPoint = playbackState.filteredPoints[playbackState.filteredPoints.length - 1];
            
            if (currentPoint && lastPoint) {
                const currentTime = formatTime(currentPoint.timestamp);
                const totalTime = formatTime(lastPoint.timestamp);
                
                // Êõ¥Êñ∞‰∏§Ë°åÊó∂Èó¥ÊòæÁ§∫
                const currentTimeElement = document.getElementById('currentTime');
                const totalTimeElement = document.getElementById('totalTime');
                if (currentTimeElement) currentTimeElement.textContent = currentTime;
                if (totalTimeElement) totalTimeElement.textContent = totalTime;
            }
        }

        // Êõ¥Êñ∞Áä∂ÊÄÅ
        const progress = Math.round((playbackState.currentIndex / (playbackState.filteredPoints.length - 1)) * 100);
        updateStatus(`ËΩ®ËøπÂõûÊîæ‰∏≠... ${progress}%`);

        playbackState.currentIndex++;

        // ËÆæÁΩÆ‰∏ã‰∏Ä‰∏™ÁÇπÁöÑÊí≠ÊîæÂª∂Ëøü
        const speed = playbackState.speed || 1;
        const delay = 1000 / speed; // ÈÄüÂ∫¶Ë∂äÂø´ÔºåÂª∂ËøüË∂äÁü≠

        playbackState.timer = setTimeout(playbackNextPoint, delay);
    }

    function pausePlayback() {
        playbackState.isPlaying = false;
        
        // Ê∏ÖÈô§ÂÆöÊó∂Âô®
        if (playbackState.timer) {
            clearTimeout(playbackState.timer);
            playbackState.timer = null;
        }
        
        // Êõ¥Êñ∞Êí≠ÊîæÂô®ÊéßÂà∂Áä∂ÊÄÅ
        if (playbackPlayer) {
            updatePlayerControls();
        }
        
        updateStatus('ËΩ®ËøπÂõûÊîæÂ∑≤ÊöÇÂÅú');
    }

    function stopPlayback() {
        playbackState.isPlaying = false;
        playbackState.currentIndex = 0;

        // Ê∏ÖÈô§ÂÆöÊó∂Âô®
        if (playbackState.timer) {
            clearTimeout(playbackState.timer);
            playbackState.timer = null;
        }

        // Ê∏ÖÈô§ÂõûÊîæÂÖÉÁ¥†
        if (playbackState.marker) {
            map.removeLayer(playbackState.marker);
            playbackState.marker = null;
        }
        if (playbackState.polyline) {
            map.removeLayer(playbackState.polyline);
            playbackState.polyline = null;
        }

        // ÈáçÁΩÆËøõÂ∫¶Êù°ÂíåÊó∂Èó¥ÊòæÁ§∫
        if (playerProgressSlider) {
            playerProgressSlider.value = 0;
        }
        // ÈáçÁΩÆÂΩìÂâçÊó∂Èó¥‰∏∫ËøáÊª§ÂêéËΩ®ËøπÁÇπÁöÑÁ¨¨‰∏Ä‰∏™ÁÇπÊó∂Èó¥
        const currentTimeElement = document.getElementById('currentTime');
        if (currentTimeElement && playbackState.filteredPoints && playbackState.filteredPoints.length > 0) {
            const firstPoint = playbackState.filteredPoints[0];
            if (firstPoint && firstPoint.timestamp) {
                currentTimeElement.textContent = formatTime(firstPoint.timestamp);
            } else {
                currentTimeElement.textContent = '00:00:00';
            }
        } else if (currentTimeElement) {
            currentTimeElement.textContent = '00:00:00';
        }
        // ‰∏çÈáçÁΩÆtotalTimeElementÔºå‰øùÊåÅÁªìÊùüÊó∂Èó¥ÊòæÁ§∫
        
        // Êõ¥Êñ∞Êí≠ÊîæÂô®ÊéßÂà∂Áä∂ÊÄÅÔºàÂ¶ÇÊûúÊí≠ÊîæÂô®ÂÖÉÁ¥†Â≠òÂú®Ôºâ
        if (playbackPlayer) {
            updatePlayerControls();
        }
        
        updateStatus('ËΩ®ËøπÂõûÊîæÂ∑≤ÂÅúÊ≠¢');

        // ÈáçÁΩÆÊªëÂùó
        const playbackTimeSlider = document.getElementById('playbackTimeSlider');
        if (playbackTimeSlider) {
            playbackTimeSlider.value = 0;
            playbackTimeSlider.disabled = true;
        }

        // ÂêåÊ≠•Êõ¥Êñ∞Â∫ïÈÉ®Âõ∫ÂÆöÊí≠ÊîæÊéßÂà∂Èù¢Êùø
        const playbackTimeSliderFixed = document.getElementById('playbackTimeSliderFixed');
        if (playbackTimeSliderFixed) {
            playbackTimeSliderFixed.value = 0;
            playbackTimeSliderFixed.disabled = true;
        }

        updateStatus('ËΩ®ËøπÂõûÊîæÂ∑≤ÂÅúÊ≠¢');
    }

    function jumpToPoint(index) {
        if (!playbackState.filteredPoints || index < 0 || index >= playbackState.filteredPoints.length) {
            return;
        }

        playbackState.currentIndex = index;

        // Â¶ÇÊûúÊ≠£Âú®Êí≠ÊîæÔºåÊöÇÂÅú
        if (playbackState.isPlaying) {
            pausePlayback();
        }

        // ÂàõÂª∫ÂõûÊîæÂÖÉÁ¥†ÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®Ôºâ
        if (!playbackState.marker) {
            const point = playbackState.filteredPoints[0];
            playbackState.marker = L.circleMarker([point.lat, point.lng], {
                radius: 0.5,
                fillColor: currentTrackLineColor,
                color: '#FFFFFF',
                weight: 0.5,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(map);
        }

        if (!playbackState.polyline) {
            const latlngs = playbackState.filteredPoints.map(p => [p.lat, p.lng]);
            playbackState.polyline = L.polyline(latlngs, {
                color: currentTrackLineColor,
                weight: 1,
                opacity: 0.6
            }).addTo(map);
        }

        // Ë∑≥ËΩ¨Âà∞ÊåáÂÆöÁÇπ
        const point = playbackState.filteredPoints[index];
        playbackState.marker.setLatLng([point.lat, point.lng]);
        playbackState.marker.bindPopup(`ÂõûÊîæÁÇπ ${index + 1}<br>Êó∂Èó¥: ${point.timestamp}<br>ÁªèÂ∫¶: ${point.lng.toFixed(6)}<br>Á∫¨Â∫¶: ${point.lat.toFixed(6)}`);

        // Êõ¥Êñ∞ËΩ®ËøπÁ∫ø
        const currentLatlngs = playbackState.filteredPoints.slice(0, index + 1).map(p => [p.lat, p.lng]);
        playbackState.polyline.setLatLngs(currentLatlngs);

        // Êõ¥Êñ∞Áä∂ÊÄÅ
        const progress = Math.round((index / (playbackState.filteredPoints.length - 1)) * 100);
        updateStatus(`ËΩ®ËøπÂõûÊîæÂ∑≤Ë∑≥ËΩ¨Âà∞ ${progress}%`);
    }

    // ÂàÜÂâ≤Âô®ÁªòÂà∂


    // ËΩ®ËøπÂõûÊîæÊéßÂà∂ - ‰ΩøÁî®Êñ∞ÁöÑÊí≠ÊîæÂô®ÊéßÂà∂Èù¢Êùø
    function startPlayback() {
        // Ê£ÄÊü•ÊòØÂê¶ÊúâËΩ®ËøπÁÇπ
        if (!playbackState.points || playbackState.points.length === 0) {
            updateStatus('ÊöÇÊó†ËΩ®ËøπÊï∞ÊçÆÔºåÊó†Ê≥ïÂºÄÂßãÂõûÊîæ');
            return;
        }

        if (playbackState.isPlaying) {
            return;
        }

        // Â∫îÁî®Êó∂Èó¥ËåÉÂõ¥ËøáÊª§
        applyTimeRangeFilter();
        
        // Ê£ÄÊü•ËøáÊª§ÂêéÁöÑËΩ®ËøπÁÇπ
        if (!playbackState.filteredPoints || playbackState.filteredPoints.length < 2) {
            updateStatus('ÊúâÊïàËΩ®ËøπÁÇπ‰∏çË∂≥ÔºåËá≥Â∞ëÈúÄË¶Å‰∏§ÁÇπ');
            return;
        }

        // ÂÅúÊ≠¢‰πãÂâçÁöÑÂõûÊîæÔºà‰ΩÜ‰∏çÈáçÁΩÆcurrentIndexÔºâ
        if (playbackState.timer) {
            clearTimeout(playbackState.timer);
            playbackState.timer = null;
        }

        playbackState.isPlaying = true;
        // ‰∏çÈáçÁΩÆcurrentIndexÔºå‰øùÊåÅÂΩìÂâçÊí≠Êîæ‰ΩçÁΩÆ

        // Â¶ÇÊûúÊí≠ÊîæÂÖÉÁ¥†‰∏çÂ≠òÂú®ÔºåÂàõÂª∫ÂÆÉ‰ª¨
        if (!playbackState.marker || !playbackState.polyline) {
            // Ê∏ÖÈô§‰πãÂâçÁöÑÂõûÊîæÂÖÉÁ¥†
            if (playbackState.marker) {
                map.removeLayer(playbackState.marker);
            }
            if (playbackState.polyline) {
                map.removeLayer(playbackState.polyline);
            }

            // ÂàõÂª∫ÂõûÊîæËΩ®ËøπÁ∫øÔºà‰ΩøÁî®ËøáÊª§ÂêéÁöÑÁÇπÔºâ
            const latlngs = playbackState.filteredPoints.map(p => [p.lat, p.lng]);
            playbackState.polyline = L.polyline(latlngs, {
                color: currentTrackLineColor,
                weight: 1,
                opacity: 0.6
            }).addTo(map);

            // ÂàõÂª∫ÂõûÊîæÊ†áËÆ∞Ôºà‰ΩøÁî®ËøáÊª§ÂêéÁöÑÁ¨¨‰∏Ä‰∏™ÁÇπÔºâ
            const firstPoint = playbackState.filteredPoints[0];
            playbackState.marker = L.circleMarker([firstPoint.lat, firstPoint.lng], {
                radius: 0.5,
                fillColor: currentTrackLineColor,
                color: '#FFFFFF',
                weight: 0.5,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(map);

            // Ëá™ÈÄÇÂ∫îËßÜÈáéÂà∞ËΩ®ËøπËåÉÂõ¥
            const bounds = playbackState.polyline.getBounds();
            if (bounds && bounds.isValid()) {
                map.fitBounds(bounds, { padding: [20, 20] });
            }
        }

        // Êõ¥Êñ∞Êí≠ÊîæÂô®ÊéßÂà∂Áä∂ÊÄÅ
        updatePlayerControls();
        
        // ËÆæÁΩÆËøõÂ∫¶Êù°ÂíåÊó∂Èó¥ÊòæÁ§∫Ôºà‰∏çÈáçÁΩÆËøõÂ∫¶Ôºâ
        if (playerProgressSlider) {
            playerProgressSlider.disabled = false;
            playerProgressSlider.max = 100;
        }
        
        if (playerSpeedValue) {
            // ÊòæÁ§∫ÊåáÊï∞ÂÄçÊï∞
            const displaySpeed = playbackState.speed || 1;
            playerSpeedValue.textContent = displaySpeed + 'x';
        }

        // ÂºÄÂßãÊí≠Êîæ
        playbackNextPoint();
        updateStatus('ËΩ®ËøπÂõûÊîæÂºÄÂßã');
    }

    function stopPlayback() {
        playbackState.isPlaying = false;
        playbackState.currentIndex = 0;

        // Ê∏ÖÈô§ÂÆöÊó∂Âô®
        if (playbackState.timer) {
            clearTimeout(playbackState.timer);
            playbackState.timer = null;
        }

        // Ê∏ÖÈô§ÂõûÊîæÂÖÉÁ¥†
        if (playbackState.marker) {
            map.removeLayer(playbackState.marker);
            playbackState.marker = null;
        }
        if (playbackState.polyline) {
            map.removeLayer(playbackState.polyline);
            playbackState.polyline = null;
        }

        // ÈáçÁΩÆËøõÂ∫¶Êù°ÂíåÊó∂Èó¥ÊòæÁ§∫
        if (playerProgressSlider) {
            playerProgressSlider.value = 0;
        }
        // ÈáçÁΩÆÂΩìÂâçÊó∂Èó¥‰∏∫ËøáÊª§ÂêéËΩ®ËøπÁÇπÁöÑÁ¨¨‰∏Ä‰∏™ÁÇπÊó∂Èó¥
        const currentTimeElement = document.getElementById('currentTime');
        if (currentTimeElement && playbackState.filteredPoints && playbackState.filteredPoints.length > 0) {
            const firstPoint = playbackState.filteredPoints[0];
            if (firstPoint && firstPoint.timestamp) {
                currentTimeElement.textContent = formatTime(firstPoint.timestamp);
            } else {
                currentTimeElement.textContent = '00:00:00';
            }
        } else if (currentTimeElement) {
            currentTimeElement.textContent = '00:00:00';
        }
        
        // Êõ¥Êñ∞Êí≠ÊîæÂô®ÊéßÂà∂Áä∂ÊÄÅÔºàÂ¶ÇÊûúÊí≠ÊîæÂô®ÂÖÉÁ¥†Â≠òÂú®Ôºâ
        if (playbackPlayer) {
            updatePlayerControls();
        }
        
        updateStatus('ËΩ®ËøπÂõûÊîæÂ∑≤ÂÅúÊ≠¢');
    }

    function scheduleNextPlayback() {
        if (!playbackState.isPlaying || !playbackState.filteredPoints || playbackState.currentIndex >= playbackState.filteredPoints.length - 1) {
            if (playbackState.currentIndex >= playbackState.filteredPoints.length - 1) {
                updateStatus('ËΩ®ËøπÂõûÊîæÂÆåÊàê');
                // Êí≠ÊîæÂÆåÊàêÊó∂‰∏çÊ∏ÖÈô§ËΩ®ËøπÁ∫øÔºåÂè™ÂÅúÊ≠¢Êí≠ÊîæÂπ∂ÈáçÁΩÆÁä∂ÊÄÅ
                playbackState.isPlaying = false;
                playbackState.currentIndex = 0;
                
                // Ê∏ÖÈô§ÂÆöÊó∂Âô®
                if (playbackState.timer) {
                    clearTimeout(playbackState.timer);
                    playbackState.timer = null;
                }
                
                // Âè™Ê∏ÖÈô§Ê†áËÆ∞Ôºå‰øùÁïôËΩ®ËøπÁ∫ø
                if (playbackState.marker) {
                    map.removeLayer(playbackState.marker);
                    playbackState.marker = null;
                }
                
                // ÈáçÁΩÆÂΩìÂâçÊó∂Èó¥Ôºå‰øùÊåÅÁªìÊùüÊó∂Èó¥‰∏çÂèòÔºà‰øùÁïôËøõÂ∫¶Êù°‰ΩçÁΩÆÔºâ
                const currentTimeElement = document.getElementById('currentTime');
                if (currentTimeElement) currentTimeElement.textContent = '00:00:00';
                // ‰∏çÈáçÁΩÆtotalTimeElementÔºå‰øùÊåÅÁªìÊùüÊó∂Èó¥ÊòæÁ§∫
                
                // Êõ¥Êñ∞Êí≠ÊîæÂô®ÊéßÂà∂Áä∂ÊÄÅ
                if (playbackPlayer) {
                    updatePlayerControls();
                }
                
                // Êí≠ÊîæÂÆåÊàêÊó∂‰∏çÈúÄË¶ÅÈáçÁΩÆÊó∂Èó¥ÊªëÂùóÔºå‰øùÊåÅÂΩìÂâç‰ΩçÁΩÆ
                // const playbackTimeSlider = document.getElementById('playbackTimeSlider');
                // if (playbackTimeSlider) {
                //     playbackTimeSlider.value = 0;
                //     playbackTimeSlider.disabled = true;
                // }
                
                // ÂêåÊ≠•Êõ¥Êñ∞Â∫ïÈÉ®Âõ∫ÂÆöÊí≠ÊîæÊéßÂà∂Èù¢Êùø
                // const playbackTimeSliderFixed = document.getElementById('playbackTimeSliderFixed');
                // if (playbackTimeSliderFixed) {
                //     playbackTimeSliderFixed.value = 0;
                //     playbackTimeSliderFixed.disabled = true;
                // }
            }
            return; // Â¶ÇÊûúÊòØÊöÇÂÅúÔºåÁõ¥Êé•ËøîÂõûÔºå‰∏çÂÅúÊ≠¢Êí≠Êîæ
        }

        const next = playbackState.filteredPoints[playbackState.currentIndex + 1];
        const speed = playbackState.speed || 1;
        const delay = Math.max(100, Math.round(1000 / speed));

        playbackState.timer = setTimeout(() => {
            playbackState.currentIndex++;

            // Êõ¥Êñ∞Ê†áËÆ∞‰ΩçÁΩÆ
            if (playbackState.marker) {
                playbackState.marker.setLatLng([next.lat, next.lng]);
                playbackState.marker.bindPopup(`ÂõûÊîæÁÇπ ${playbackState.currentIndex + 1}<br>Êó∂Èó¥: ${next.timestamp}<br>ÁªèÂ∫¶: ${next.lng.toFixed(6)}<br>Á∫¨Â∫¶: ${next.lat.toFixed(6)}`);
            }

            // Êõ¥Êñ∞ËΩ®ËøπÁ∫ø
            if (playbackState.polyline) {
                const currentLatlngs = playbackState.filteredPoints.slice(0, playbackState.currentIndex + 1).map(p => [p.lat, p.lng]);
                playbackState.polyline.setLatLngs(currentLatlngs);
            }

            // Ê£ÄÊü•ÁÇπÊòØÂê¶Âú®Â±èÂπïÂèØËßÅËåÉÂõ¥ÂÜÖÔºåÂè™Êúâ‰∏çÂú®ÂèØËßÅËåÉÂõ¥ÂÜÖÊó∂ÊâçÂ±Ö‰∏≠
            const pointLatLng = L.latLng(next.lat, next.lng);
            const bounds = map.getBounds();
            
            // Â¶ÇÊûúÁÇπ‰∏çÂú®ÂΩìÂâçÂú∞ÂõæËæπÁïåÂÜÖÔºåÊàñËÄÖË∑ùÁ¶ªËæπÁïåÂ§™ËøëÔºàÂ∞è‰∫éÂú∞ÂõæÂÆΩÈ´òÁöÑ10%ÔºâÔºåÂàôÂ±Ö‰∏≠
            if (!bounds.contains(pointLatLng)) {
                // ÁÇπÂÆåÂÖ®‰∏çÂú®Â±èÂπïÂÜÖÔºåÈúÄË¶ÅÂ±Ö‰∏≠
                map.setView([next.lat, next.lng], map.getZoom(), {
                    animate: true,
                    duration: 0.3
                });
            } else {
                // ÁÇπÂú®Â±èÂπïÂÜÖÔºåÊ£ÄÊü•ÊòØÂê¶Èù†ËøëËæπÁïåÔºàË∑ùÁ¶ªËæπÁïåÂ∞è‰∫éÂú∞ÂõæÂÆΩÈ´òÁöÑ10%Ôºâ
                const boundsPad = bounds.pad(-0.1); // ÂÜÖÁº©10%ÁöÑËæπÁïå
                if (!boundsPad.contains(pointLatLng)) {
                    // ÁÇπÈù†ËøëËæπÁïåÔºåÂ±Ö‰∏≠ÊòæÁ§∫
                    map.setView([next.lat, next.lng], map.getZoom(), {
                        animate: true,
                        duration: 0.3
                    });
                }
                // ÁÇπÂú®Â±èÂπï‰∏≠Â§ÆÂå∫ÂüüÔºå‰∏çÈúÄË¶ÅÂ±Ö‰∏≠
            }

            // Êõ¥Êñ∞ËøõÂ∫¶Êù°ÂíåÊó∂Èó¥ÊòæÁ§∫
            if (playerProgressSlider && playbackState.filteredPoints.length > 0) {
                const percentage = Math.round((playbackState.currentIndex / (playbackState.filteredPoints.length - 1)) * 100);
                playerProgressSlider.value = percentage;
            }
            
            if (playbackState.filteredPoints.length > 0) {
                const currentPoint = playbackState.filteredPoints[playbackState.currentIndex];
                const lastPoint = playbackState.filteredPoints[playbackState.filteredPoints.length - 1];
                
                if (currentPoint && lastPoint) {
                    const currentTime = formatTime(currentPoint.timestamp);
                    const totalTime = formatTime(lastPoint.timestamp);
                    
                    // Êõ¥Êñ∞‰∏§Ë°åÊó∂Èó¥ÊòæÁ§∫
                    const currentTimeElement = document.getElementById('currentTime');
                    const totalTimeElement = document.getElementById('totalTime');
                    if (currentTimeElement) currentTimeElement.textContent = currentTime;
                    if (totalTimeElement) totalTimeElement.textContent = totalTime;
                }
            }

            // ÁªßÁª≠‰∏ã‰∏Ä‰∏™ÁÇπ
            scheduleNextPlayback();
        }, delay);
    }

    // Ê†ºÂºèÂåñÊó∂Èó¥ÊòæÁ§∫ÂáΩÊï∞
    function formatTime(timestamp) {
        const date = parseTimestamp(timestamp);
        if (!date) return '00:00';
        
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        return hours + ':' + minutes;
    }

    // ÊóßÁâàÊó∂Èó¥ÊªëÂùóÈÖçÁΩÆÂáΩÊï∞ - Â∑≤Â∫üÂºÉÔºå‰øùÁïôÂÖºÂÆπÊÄß
    function configureTimeSlider() {
        const slider = document.getElementById('playbackTimeSlider');
        if (!slider) return;

        // Á©∫ËΩ®ËøπÊó∂ËÆæÁΩÆÊªëÂùó‰∏∫Á¶ÅÁî®Áä∂ÊÄÅ
        if (playbackState.filteredPoints.length === 0) {
            slider.disabled = true;
            slider.min = 0;
            slider.max = 0;
            slider.value = 0;
            
            // ÂêåÊ≠•Êõ¥Êñ∞Â∫ïÈÉ®Âõ∫ÂÆöÊí≠ÊîæÊéßÂà∂Èù¢Êùø
            const sliderFixed = document.getElementById('playbackTimeSliderFixed');
            if (sliderFixed) {
                sliderFixed.disabled = true;
                sliderFixed.min = 0;
                sliderFixed.max = 0;
                sliderFixed.value = 0;
            }
            return;
        }

        slider.disabled = false;
        slider.min = 0;
        slider.max = playbackState.filteredPoints.length - 1;
        // ‰∏çÈáçÁΩÆÊªëÂùóÂÄºÔºå‰øùÊåÅÂΩìÂâçÊí≠Êîæ‰ΩçÁΩÆ
        if (playbackState.currentIndex >= 0 && playbackState.currentIndex < playbackState.filteredPoints.length) {
            slider.value = playbackState.currentIndex;
        }

        // ÂêåÊ≠•Êõ¥Êñ∞Â∫ïÈÉ®Âõ∫ÂÆöÊí≠ÊîæÊéßÂà∂Èù¢Êùø
        const sliderFixed = document.getElementById('playbackTimeSliderFixed');
        if (sliderFixed) {
            sliderFixed.disabled = false;
            sliderFixed.min = 0;
            sliderFixed.max = playbackState.filteredPoints.length - 1;
            // ‰∏çÈáçÁΩÆÊªëÂùóÂÄºÔºå‰øùÊåÅÂΩìÂâçÊí≠Êîæ‰ΩçÁΩÆ
            if (playbackState.currentIndex >= 0 && playbackState.currentIndex < playbackState.filteredPoints.length) {
                sliderFixed.value = playbackState.currentIndex;
            }
        }
    }

    function updateTimeSlider() {
        const slider = document.getElementById('playbackTimeSlider');
        if (slider) {
            slider.value = playbackState.currentIndex;
        }

        // ÂêåÊ≠•Êõ¥Êñ∞Â∫ïÈÉ®Âõ∫ÂÆöÊí≠ÊîæÊéßÂà∂Èù¢Êùø
        const sliderFixed = document.getElementById('playbackTimeSliderFixed');
        if (sliderFixed) {
            sliderFixed.value = playbackState.currentIndex;
        }
    }

    function updatePlaybackTimeLabel(timestamp) {
        const label = document.getElementById('playbackTimeLabel');
        if (label) {
            if (timestamp) {
                label.textContent = `Êó∂Èó¥: ${timestamp}`;
            } else {
                label.textContent = 'Êó∂Èó¥: --';
            }
        }

        // ÂêåÊ≠•Êõ¥Êñ∞Â∫ïÈÉ®Âõ∫ÂÆöÊí≠ÊîæÊéßÂà∂Èù¢Êùø
        const labelFixed = document.getElementById('playbackTimeLabelFixed');
        if (labelFixed) {
            if (timestamp) {
                labelFixed.textContent = `Êó∂Èó¥: ${timestamp}`;
            } else {
                labelFixed.textContent = 'Êó∂Èó¥: --';
            }
        }
    }

    // ÊµãÈáèÂäüËÉΩ


    function startMeasureDistance() {
        if (!map) return;

        clearMeasureResult();

        measureState.isActive = true;
        measureState.mode = 'distance';

        // Á¶ÅÁî®ÊµãÈáèÊåâÈíÆ
        document.getElementById('measureDistanceBtn').classList.add('active');
        document.getElementById('measureAreaBtn').disabled = true;

        // Á¶ÅÁî®Âú∞ÂõæÂèåÂáªÁº©ÊîæÂäüËÉΩ
        map.doubleClickZoom.disable();

        // ËÆæÁΩÆÊõ¥ÁÅµÊïèÁöÑÂèåÂáªÊ£ÄÊµãÂèÇÊï∞
        if (map.options) {
            map.options.doubleClickZoom = false;
            map.options.tap = false; // Á¶ÅÁî®Ëß¶Êë∏Âª∂Ëøü
        }

        // ËÆæÁΩÆÊõ¥ÁÅµÊïèÁöÑÂèåÂáªÊ£ÄÊµãÂèÇÊï∞
        if (map.options) {
            map.options.doubleClickZoom = false;
            map.options.tap = false; // Á¶ÅÁî®Ëß¶Êë∏Âª∂Ëøü
        }

        // ÁªëÂÆöÂú∞Âõæ‰∫ã‰ª∂
        map.on('click', handleMeasureClick);
        map.on('mousemove', handleMeasureMouseMove);
        map.on('contextmenu', handleDistanceMeasureRightClick); // Âè≥ÈîÆÁªìÊùüÊµãÈáè

        updateStatus('ÊµãË∑ùÊ®°ÂºèÂ∑≤ÊøÄÊ¥ªÔºåÁÇπÂáªÂú∞ÂõæÂºÄÂßãÊµãÈáèÔºåÂè≥ÈîÆÁªìÊùüÊµãÈáè');
    }

    // Âè≥ÈîÆÁªìÊùüÊµãË∑ù
    function handleDistanceMeasureRightClick(e) {
        // ÈòªÊ≠¢Âè≥ÈîÆËèúÂçïÁöÑÈªòËÆ§Ë°å‰∏∫
        if (e && e.originalEvent) {
            e.originalEvent.preventDefault();
            e.originalEvent.stopPropagation();
        }

        // Á°Æ‰øùËá≥Â∞ëÊúâ2‰∏™ÁÇπÊâçËÉΩÂΩ¢ÊàêÁ∫øÊÆµ
        if (measureState.points.length >= 2) {
            finishMeasureDistance();
        } else {
            alert('ËØ∑Ëá≥Â∞ëÁÇπÂáª2‰∏™ÁÇπÂΩ¢ÊàêÁ∫øÊÆµÂêéÂÜçÂè≥ÈîÆÁªìÊùüÊµãÈáè');
        }

        return false;
    }

    // Âè≥ÈîÆÁªìÊùüÊµãÈù¢
    function handleAreaMeasureRightClick(e) {
        // ÈòªÊ≠¢Âè≥ÈîÆËèúÂçïÁöÑÈªòËÆ§Ë°å‰∏∫
        if (e && e.originalEvent) {
            e.originalEvent.preventDefault();
            e.originalEvent.stopPropagation();
        }

        // Á°Æ‰øùËá≥Â∞ëÊúâ3‰∏™ÁÇπÊâçËÉΩÂΩ¢ÊàêÂ§öËæπÂΩ¢
        if (measureState.points.length >= 3) {
            finishMeasureArea();
        } else {
            alert('ËØ∑Ëá≥Â∞ëÁÇπÂáª3‰∏™ÁÇπÂΩ¢ÊàêÂ§öËæπÂΩ¢ÂêéÂÜçÂè≥ÈîÆÁªìÊùüÊµãÈáè');
        }

        return false;
    }

    function startMeasureArea() {
        if (!map) return;

        clearMeasureResult();

        measureState.isActive = true;
        measureState.mode = 'area';

        // Á¶ÅÁî®ÊµãÈáèÊåâÈíÆ
        document.getElementById('measureAreaBtn').classList.add('active');
        document.getElementById('measureDistanceBtn').disabled = true;

        // Á¶ÅÁî®Âú∞ÂõæÂèåÂáªÁº©ÊîæÂäüËÉΩ
        map.doubleClickZoom.disable();

        // ÁªëÂÆöÂú∞Âõæ‰∫ã‰ª∂
        map.on('click', handleMeasureClick);
        map.on('mousemove', handleMeasureMouseMove);
        map.on('contextmenu', handleAreaMeasureRightClick); // Âè≥ÈîÆÁªìÊùüÊµãÈáè

        updateStatus('ÊµãÈù¢Ê®°ÂºèÂ∑≤ÊøÄÊ¥ªÔºåÁÇπÂáªÂú∞ÂõæÂºÄÂßãÊµãÈáèÔºåÂè≥ÈîÆÁªìÊùüÊµãÈáè');
    }

    function handleMeasureClick(e) {
    if (!measureState.isActive) return;

    // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°ÔºåÈÅøÂÖçÂπ≤Êâ∞ÂèåÂáªÊ£ÄÊµã
    if (e && e.originalEvent) {
        e.originalEvent.stopPropagation();
    }

    const point = e.latlng;
    measureState.points.push(point);

    // ÂàõÂª∫ÁÇπÊ†áËÆ∞
    const marker = L.circleMarker(point, {
        color: currentOutlineColor,
        fillColor: currentFillColor,
        fillOpacity: 1,
        radius: 0.5
    });

    measureLayerGroup.addLayer(marker);
    measureState.markers.push(marker);

    if (measureState.mode === 'distance') {
        // ÊµãË∑ùÈÄªËæë
        if (measureState.points.length > 1) {
            const lastPoint = measureState.points[measureState.points.length - 2];
            const newLine = L.polyline([lastPoint, point], {
                color: currentOutlineColor,
                weight: 1,
                opacity: 1
            });

            measureLayerGroup.addLayer(newLine);
            measureState.lines.push(newLine);

            // Êõ¥Êñ∞Ë∑ùÁ¶ªÊ†áÁ≠æ
            const distance = calculateDistance(lastPoint, point);
            const center = L.latLng(
                (lastPoint.lat + point.lat) / 2,
                (lastPoint.lng + point.lng) / 2
            );
            showDistanceLabel(center, distance);
        }
    } else if (measureState.mode === 'area') {
        // ÊµãÈù¢ÈÄªËæë
        if (measureState.points.length > 1) {
            // ÂàõÂª∫Á∫øÊÆµ
            const lastPoint = measureState.points[measureState.points.length - 2];
            const newLine = L.polyline([lastPoint, point], {
                color: currentOutlineColor,
                weight: 1,
                opacity: 1
            });

            measureLayerGroup.addLayer(newLine);
            measureState.lines.push(newLine);
        }

        // ÂΩìÊúâ3‰∏™ÊàñÊõ¥Â§öÁÇπÊó∂ÔºåÊõ¥Êñ∞Â§öËæπÂΩ¢Ôºà‰ΩÜ‰∏çÊòæÁ§∫Ê†áÁ≠æÔºâ
        if (measureState.points.length >= 3) {
            // ÁßªÈô§‰πãÂâçÁöÑÂ§öËæπÂΩ¢
            if (measureState.polygon) {
                measureLayerGroup.removeLayer(measureState.polygon);
            }

            // ÂàõÂª∫Êñ∞ÁöÑÂ§öËæπÂΩ¢
            measureState.polygon = L.polygon(measureState.points, {
                color: currentOutlineColor,
                weight: 1,
                opacity: 1,
                fillColor: currentFillColor,
                fillOpacity: 0.8
            });

            measureLayerGroup.addLayer(measureState.polygon);

            // Ê≥®ÊÑèÔºöËøôÈáå‰∏çÂÜçÊòæÁ§∫Èù¢ÁßØÊ†áÁ≠æÔºåÂè™Âú®ÂèåÂáªÁªìÊùüÊó∂ÊòæÁ§∫
        }
    }
}

    function handleMeasureMouseMove(e) {
        if (!measureState.isActive || measureState.points.length === 0) return;

        const lastPoint = measureState.points[measureState.points.length - 1];
        const currentPoint = e.latlng;

        // ÁßªÈô§‰πãÂâçÁöÑ‰∏¥Êó∂Á∫ø
        if (measureState.tempLine) {
            measureLayerGroup.removeLayer(measureState.tempLine);
        }

        // ÂàõÂª∫Êñ∞ÁöÑ‰∏¥Êó∂Á∫ø
        let tempCoords = [lastPoint, currentPoint];

        // Â¶ÇÊûúÊòØÈù¢ÁßØÊµãÈáèÔºåÊ∑ªÂä†Èó≠ÂêàÁ∫ø
        if (measureState.mode === 'area' && measureState.points.length >= 2) {
            tempCoords.push(measureState.points[0]);
        }

        measureState.tempLine = L.polyline(tempCoords, {
            color: '#FFFF00',
            weight: 2,
            opacity: 0.8,
            dashArray: '5, 5'
        });

        measureLayerGroup.addLayer(measureState.tempLine);
    }

    function updateMeasurePolygon() {
        // ÁßªÈô§‰πãÂâçÁöÑÂ§öËæπÂΩ¢
        if (measureState.polygon) {
            measureLayerGroup.removeLayer(measureState.polygon);
        }

        // ÂàõÂª∫Êñ∞ÁöÑÂ§öËæπÂΩ¢
        measureState.polygon = L.polygon(measureState.points, {
            color: currentOutlineColor,
            weight: 1,
            opacity: 1,
            fillColor: currentFillColor,
            fillOpacity: 0.8
        });

        measureLayerGroup.addLayer(measureState.polygon);

        // ËÆ°ÁÆóÂπ∂ÊòæÁ§∫Èù¢ÁßØ
        const area = calculatePolygonArea(measureState.points);
        const center = getPolygonCenter(measureState.points);
        showAreaLabel(center, area);
    }

    function finishMeasureDistance() {
        if (!measureState.isActive || measureState.mode !== 'distance') return;

        // ÁßªÈô§‰∫ã‰ª∂ÁõëÂê¨
        map.off('click', handleMeasureClick);
        map.off('mousemove', handleMeasureMouseMove);
        map.off('contextmenu', handleDistanceMeasureRightClick);

        // ÈáçÊñ∞ÂêØÁî®Âú∞ÂõæÂèåÂáªÁº©ÊîæÂäüËÉΩ
        map.doubleClickZoom.enable();

        // ÊÅ¢Â§çÂú∞ÂõæÈÄâÈ°πËÆæÁΩÆ
        if (map.options) {
            map.options.doubleClickZoom = true;
            map.options.tap = true;
        }

        // ÊÅ¢Â§çÂú∞ÂõæÈÄâÈ°πËÆæÁΩÆ
        if (map.options) {
            map.options.doubleClickZoom = true;
            map.options.tap = true;
        }

        // ÁßªÈô§‰∏¥Êó∂Á∫ø
        if (measureState.tempLine) {
            measureLayerGroup.removeLayer(measureState.tempLine);
            measureState.tempLine = null;
        }

        // ÊòæÁ§∫ÊÄªË∑ùÁ¶ª
        if (measureState.points.length > 1) {
            const totalDistance = calculateTotalDistance();
            showTotalDistanceLabel(totalDistance);

            // ÈáçÊñ∞ÂàõÂª∫ÊúÄÁªàÁöÑÁ∫øÊÆµ‰ª•Á°Æ‰øùÊòæÁ§∫Ê≠£Á°Æ
            if (measureState.line) {
                measureLayerGroup.removeLayer(measureState.line);
            }

            measureState.line = L.polyline(measureState.points, {
                color: currentOutlineColor,
                weight: 1,
                opacity: 1
            });

            measureLayerGroup.addLayer(measureState.line);
        }

        // ÈáçÁΩÆÁä∂ÊÄÅ
        measureState.isActive = false;
        measureState.mode = '';

        // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
        document.getElementById('measureDistanceBtn').classList.remove('active');
        document.getElementById('measureAreaBtn').disabled = false;

        updateStatus('ÊµãË∑ùÂÆåÊàêÔºåÊÄªË∑ùÁ¶ªÂ∑≤ÊòæÁ§∫');
    }

    function finishMeasureArea() {
        if (!measureState.isActive || measureState.mode !== 'area') return;

        // ÁßªÈô§‰∫ã‰ª∂ÁõëÂê¨
        map.off('click', handleMeasureClick);
        map.off('mousemove', handleMeasureMouseMove);
        map.off('contextmenu', handleAreaMeasureRightClick);

        // ÈáçÊñ∞ÂêØÁî®Âú∞ÂõæÂèåÂáªÁº©ÊîæÂäüËÉΩ
        map.doubleClickZoom.enable();

        // ÁßªÈô§‰∏¥Êó∂Á∫ø
        if (measureState.tempLine) {
            measureLayerGroup.removeLayer(measureState.tempLine);
            measureState.tempLine = null;
        }

        // Â¶ÇÊûúÁÇπÊï∞>=3ÔºåÊòæÁ§∫ÊÄªÈù¢ÁßØ
        if (measureState.points.length >= 3) {
            // Á°Æ‰øùÂ§öËæπÂΩ¢ÊòØÈó≠ÂêàÁöÑ
            const lastPoint = measureState.points[measureState.points.length - 1];
            const firstPoint = measureState.points[0];

            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÈó≠ÂêàÔºàÈ¶ñÂ∞æÁÇπÊòØÂê¶Áõ∏ÂêåÔºâ
            if (lastPoint.lat !== firstPoint.lat || lastPoint.lng !== firstPoint.lng) {
                // Â¶ÇÊûúÊú™Èó≠ÂêàÔºåÂ∞ÜÈ¶ñÁÇπÊ∑ªÂä†Âà∞Êú´Â∞æ‰ª•ÂΩ¢ÊàêÈó≠ÂêàÂ§öËæπÂΩ¢
                measureState.points.push(L.latLng(firstPoint.lat, firstPoint.lng));
            }

            const area = calculatePolygonArea(measureState.points);
            const center = getPolygonCenter(measureState.points);

            // Ê∏ÖÈô§‰πãÂâçÁöÑÈù¢ÁßØÊ†áÁ≠æÔºàÂ¶ÇÊûúÊúâÔºâ
            if (measureState.areaLabel) {
                measureLayerGroup.removeLayer(measureState.areaLabel);
                measureState.areaLabel = null;
            }

            // ÊòæÁ§∫ÊÄªÈù¢ÁßØÊ†áÁ≠æÔºàÂπ≥ÊñπÁ±≥+‰∫©Êï∞Ôºâ
            showTotalAreaLabel(center, area);

            // ÈáçÊñ∞ÂàõÂª∫ÊúÄÁªàÁöÑÂ§öËæπÂΩ¢‰ª•Á°Æ‰øùÈó≠Âêà
            if (measureState.polygon) {
                measureLayerGroup.removeLayer(measureState.polygon);
            }

            measureState.polygon = L.polygon(measureState.points, {
                color: currentOutlineColor,
                weight: 1,
                opacity: 1,
                fillColor: currentFillColor,
                fillOpacity: 0.8
            });

            measureLayerGroup.addLayer(measureState.polygon);
        } else {
            // ÁÇπÊï∞‰∏çË∂≥ÔºåÊ∏ÖÈô§ÊâÄÊúâÊµãÈáèÁªìÊûú
            clearMeasureResult();
        }

        // ÈáçÁΩÆÁä∂ÊÄÅ
        measureState.isActive = false;
        measureState.mode = '';

        // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
        document.getElementById('measureAreaBtn').classList.remove('active');
        document.getElementById('measureDistanceBtn').disabled = false;

        updateStatus('ÊµãÈù¢ÂÆåÊàêÔºåÊÄªÈù¢ÁßØÂ∑≤ÊòæÁ§∫');
    }

    // Ë∑ùÁ¶ªËÆ°ÁÆó
    function calculateDistance(point1, point2) {
        return point1.distanceTo(point2);
    }

    // Â§öËæπÂΩ¢Èù¢ÁßØËÆ°ÁÆó
    function calculatePolygonArea(points) {
        if (points.length < 3) return 0;

        // ‰ΩøÁî®Turf.jsËÆ°ÁÆóÈù¢ÁßØ
        try {
            // Â∞ÜLeafletÂùêÊ†áËΩ¨Êç¢‰∏∫GeoJSONÊ†ºÂºè
            let coords = points.map(p => {
                if (p.lng !== undefined && p.lat !== undefined) {
                    return [p.lng, p.lat];
                } else if (Array.isArray(p) && p.length >= 2) {
                    // Â¶ÇÊûúÂ∑≤ÁªèÊòØÊï∞ÁªÑÊ†ºÂºè [lat, lng] Êàñ [lng, lat]
                    return [p[1], p[0]]; // ÂÅáËÆæÊòØ [lat, lng] Ê†ºÂºè
                }
                return null;
            }).filter(coord => coord !== null);

            // Á°Æ‰øùÁéØÊòØÈó≠ÂêàÁöÑÔºàËá≥Â∞ëÊúâ4‰∏™ÁÇπÔºåÈ¶ñÂ∞æÁõ∏ÂêåÔºâ
            if (coords.length >= 3) {
                // Â¶ÇÊûúÈ¶ñÂ∞æ‰∏çÁõ∏ÂêåÔºåÈó≠ÂêàÁéØ
                if (coords[0][0] !== coords[coords.length - 1][0] ||
                    coords[0][1] !== coords[coords.length - 1][1]) {
                    coords.push(coords[0]);
                }

                // Á°Æ‰øùËá≥Â∞ëÊúâ4‰∏™ÁÇπÔºàÈó≠ÂêàÂêéÔºâ
                if (coords.length < 4) {
                    // Â¶ÇÊûúÁÇπÊï∞‰∏çË∂≥4‰∏™ÔºåÂ§çÂà∂ÁÇπÁõ¥Âà∞ËææÂà∞4‰∏™
                    while (coords.length < 4) {
                        coords.push(coords[coords.length - 1]);
                    }
                }
            } else if (coords.length === 2) {
                // Â¶ÇÊûúÂè™Êúâ2‰∏™ÁÇπÔºåÂ§çÂà∂ÂÆÉ‰ª¨ÂΩ¢ÊàêËá≥Â∞ë4‰∏™ÁÇπÁöÑÁéØ
                coords.push(coords[1]);
                coords.push(coords[0]);
            } else if (coords.length === 1) {
                // Â¶ÇÊûúÂè™Êúâ1‰∏™ÁÇπÔºåÂ§çÂà∂3Ê¨°ÂΩ¢Êàê4‰∏™ÁÇπÁöÑÁéØ
                for (let k = 0; k < 3; k++) {
                    coords.push(coords[0]);
                }
            }

            const polygon = turf.polygon([coords]);
            const area = turf.area(polygon); // Âπ≥ÊñπÁ±≥

            return area;
        } catch (e) {
            console.error('ËÆ°ÁÆóÂ§öËæπÂΩ¢Èù¢ÁßØÊó∂Âá∫Èîô:', e);
            return 0;
        }
    }

    // Ëé∑ÂèñÂ§öËæπÂΩ¢‰∏≠ÂøÉÁÇπ
    function getPolygonCenter(points) {
        if (points.length === 0) return null;

        let latSum = 0, lngSum = 0;
        points.forEach(p => {
            latSum += p.lat;
            lngSum += p.lng;
        });

        return L.latLng(latSum / points.length, lngSum / points.length);
    }

    // ËÆ°ÁÆóÊÄªË∑ùÁ¶ª
    function calculateTotalDistance() {
        let total = 0;
        for (let i = 1; i < measureState.points.length; i++) {
            total += calculateDistance(measureState.points[i-1], measureState.points[i]);
        }
        return total;
    }

    // ÊòæÁ§∫Ë∑ùÁ¶ªÊ†áÁ≠æ
    function showDistanceLabel(latlng, distance) {
        const label = L.divIcon({
            className: 'measure-label',
            html: `<div style="background: rgba(255,255,255,0.9); color: #333; padding: 2px 6px; border-radius: 3px; font-size: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.3);">${distance.toFixed(2)} Á±≥</div>`,
            iconSize: null,
            iconAnchor: [0, -10]
        });

        const marker = L.marker(latlng, { icon: label });
        measureLayerGroup.addLayer(marker);
        measureState.labels.push(marker);
    }

    // ÊòæÁ§∫Èù¢ÁßØÊ†áÁ≠æ
    function showAreaLabel(latlng, area) {
        const label = L.divIcon({
            className: 'measure-label',
            html: `<div style="background: rgba(255,255,255,0.9); color: #333; padding: 2px 6px; border-radius: 3px; font-size: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.3);">${area.toFixed(2)} Âπ≥ÊñπÁ±≥</div>`,
            iconSize: null,
            iconAnchor: [0, -10]
        });

        const marker = L.marker(latlng, { icon: label });
        measureLayerGroup.addLayer(marker);
        measureState.areaLabel = marker;
    }

    // ÊòæÁ§∫ÊÄªË∑ùÁ¶ªÊ†áÁ≠æ
    function showTotalDistanceLabel(totalDistance) {
        if (measureState.points.length === 0) return;

        const lastPoint = measureState.points[measureState.points.length - 1];
        const label = L.divIcon({
            className: 'measure-total-label',
            html: `<div style="background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px; font-size: 14px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">ÊÄªË∑ùÁ¶ª: ${totalDistance.toFixed(2)} Á±≥</div>`,
            iconSize: null,
            iconAnchor: [0, -20]
        });

        const marker = L.marker(lastPoint, { icon: label });
        measureLayerGroup.addLayer(marker);
        measureState.labels.push(marker);
    }

    // ÊòæÁ§∫ÊÄªÈù¢ÁßØÊ†áÁ≠æ
    function showTotalAreaLabel(latlng, area) {
        const areaInMu = area / 666.6667;
        const label = L.divIcon({
            className: 'measure-total-label',
            html: `<div style="background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px; font-size: 14px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.3); line-height: 1.4;">ÊÄªÈù¢ÁßØ: ${area.toFixed(2)} Âπ≥ÊñπÁ±≥<br>${areaInMu.toFixed(2)} ‰∫©</div>`,
            iconSize: null,
            iconAnchor: [0, -40]
        });

        const marker = L.marker(latlng, { icon: label });
        measureLayerGroup.addLayer(marker);
        measureState.labels.push(marker);
    }

    // Ê∏ÖÈô§ÊµãÈáèÁªìÊûú
    function clearMeasureResult() {
        measureLayerGroup.clearLayers();
        measureState = {
            isActive: false,
            mode: '',
            points: [],
            tempLine: null,
            lines: [],
            markers: [],
            labels: [],
            polygon: null,
            areaLabel: null
        };

        // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
        document.getElementById('measureDistanceBtn').classList.remove('active');
        document.getElementById('measureAreaBtn').classList.remove('active');
        document.getElementById('measureDistanceBtn').disabled = false;
        document.getElementById('measureAreaBtn').disabled = false;

        // Á°Æ‰øùÈáçÊñ∞ÂêØÁî®Âú∞ÂõæÂèåÂáªÁº©ÊîæÂäüËÉΩ
        if (map && map.doubleClickZoom) {
            map.doubleClickZoom.enable();

            // ÊÅ¢Â§çÂú∞ÂõæÈÄâÈ°πËÆæÁΩÆ
            if (map.options) {
                map.options.doubleClickZoom = true;
                map.options.tap = true;
            }
        }
    }

    // Âú∞ÂõæÁ±ªÂûãÂàáÊç¢
    function toggleMapType() {
        console.log('toggleMapType called, currentMapType:', currentMapType);
        console.log('map:', map);
        console.log('currentBaseLayer:', currentBaseLayer);
        console.log('currentSatelliteLayer:', currentSatelliteLayer);

        if (!map) {
            console.error('Map not initialized');
            return;
        }

        if (!currentBaseLayer || !currentSatelliteLayer) {
            console.error('Layers not properly initialized');
            updateStatus('ÂõæÂ±ÇÊú™Ê≠£Á°ÆÂàùÂßãÂåñ');
            return;
        }

        const mapTypeBtn = document.getElementById('mapTypeBtn');

        try {
            if (currentMapType === 'street') {
                console.log('Switching to satellite map');
                // ÂàáÊç¢Âà∞Âç´ÊòüÂõæ
                map.removeLayer(currentBaseLayer);
                map.addLayer(currentSatelliteLayer);
                currentMapType = 'satellite';
                mapTypeBtn.innerHTML = 'üõ∞Ô∏è Âç´ÊòüÂõæ';
                mapTypeBtn.title = 'ÂΩìÂâçÔºöÂç´ÊòüÂõæÔºåÁÇπÂáªÂàáÊç¢Ë°óÈÅìÂõæ';
            } else {
                console.log('Switching to street map');
                // ÂàáÊç¢Âà∞Ë°óÈÅìÂõæ
                map.removeLayer(currentSatelliteLayer);
                map.addLayer(currentBaseLayer);
                currentMapType = 'street';
                mapTypeBtn.innerHTML = 'üó∫Ô∏è Ë°óÈÅìÂõæ';
                mapTypeBtn.title = 'ÂΩìÂâçÔºöË°óÈÅìÂõæÔºåÁÇπÂáªÂàáÊç¢Âç´ÊòüÂõæ';
            }

            updateStatus(`Â∑≤ÂàáÊç¢Âà∞${currentMapType === 'street' ? 'Ë°óÈÅìÂõæ' : 'Âç´ÊòüÂõæ'}`);
            console.log('Map type switched successfully to:', currentMapType);
        } catch (error) {
            console.error('Error switching map type:', error);
            updateStatus('Âú∞ÂõæÂàáÊç¢Â§±Ë¥•: ' + error.message);
        }
    }

    // Ê∏ÖÁ©∫ÊâÄÊúâ
    function clearAll() {
        clearMeasureResult();

        updateStatus('ÊµãË∑ùÊµãÈù¢Â∑≤Ê∏ÖÁ©∫');
    }

    // ÂàáÊç¢Â∑¶‰æßÈù¢Êùø
    function toggleLeftPanel() {
        const panel = document.querySelector('.left-panel');
        const fixedToggle = document.getElementById('panelToggleFixed');

        if (panel.classList.contains('collapsed')) {
            // Â±ïÂºÄÈù¢Êùø - Èù¢ÊùøÂΩìÂâçÊòØÊî∂Ëµ∑ÁöÑÔºåÁÇπÂáªÂêéË¶ÅÂ±ïÂºÄÔºåÊâÄ‰ª•ÊåâÈíÆÂ∫îÊòæÁ§∫‰∏∫Â±ïÂºÄÂõæÊ†á
            panel.classList.remove('collapsed');
            if(fixedToggle) {
                fixedToggle.innerHTML = '‚ñ∂‚óÄ'; // Â±ïÂºÄÂõæÊ†á
                fixedToggle.title = 'Êî∂Áº©Â∑•ÂÖ∑Ê†è';
            }
        } else {
            // Êî∂Ëµ∑Èù¢Êùø - Èù¢ÊùøÂΩìÂâçÊòØÂ±ïÂºÄÁöÑÔºåÁÇπÂáªÂêéË¶ÅÊî∂Ëµ∑ÔºåÊâÄ‰ª•ÊåâÈíÆÂ∫îÊòæÁ§∫‰∏∫Êî∂Áº©ÂõæÊ†á
            panel.classList.add('collapsed');
            if(fixedToggle) {
                fixedToggle.innerHTML = '‚óÄ‚ñ∂'; // Êî∂Áº©ÂõæÊ†á
                fixedToggle.title = 'Â±ïÂºÄÂ∑•ÂÖ∑Ê†è';
            }
        }
    }

    // ÂàáÊç¢Ê†áÈ¢òÊ†è
    function toggleHeader() {
        const header = document.querySelector('.header');
        const toggle = document.getElementById('headerToggle');

        if (header.classList.contains('show')) {
            // ÈöêËóèÊ†áÈ¢ò
            header.classList.remove('show');
            header.style.display = 'none';
            toggle.innerHTML = '‚ò∞';
            toggle.title = 'ÊòæÁ§∫Â∑•ÂÖ∑Ê†è';
            toggle.style.display = 'block';
        } else {
            // ÊòæÁ§∫Ê†áÈ¢ò
            header.classList.add('show');
            header.style.display = 'flex';
            toggle.innerHTML = '‚úï';
            toggle.title = 'ÈöêËóèÂ∑•ÂÖ∑Ê†è';
        }
    }

    // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
    document.addEventListener('DOMContentLoaded', function() {
        initMap();
        bindTabEvents();
        bindColorPickerEvents();
        bindToolEvents();

        // ÁªëÂÆöÈù¢ÊùøÂàáÊç¢‰∫ã‰ª∂
        const headerToggle = document.getElementById('headerToggle');
        const panelToggleFixed = document.getElementById('panelToggleFixed');

        if (headerToggle) {
            headerToggle.addEventListener('click', toggleHeader);
            headerToggle.style.display = 'block';
        }

        if (panelToggleFixed) {
            panelToggleFixed.addEventListener('click', toggleLeftPanel);
        }

        // ÂàùÂßãÂåñÈù¢ÊùøÁä∂ÊÄÅ
        const savedPanelState = localStorage.getItem('leftPanelCollapsed');
        const panel = document.querySelector('.left-panel');
        const fixedToggle = document.getElementById('panelToggleFixed');

        if (savedPanelState === 'true') {
            panel.classList.add('collapsed');
            if(fixedToggle) {
                fixedToggle.innerHTML = '‚óÄ‚ñ∂'; // Êî∂Áº©ÂõæÊ†á
                fixedToggle.title = 'Â±ïÂºÄÂ∑•ÂÖ∑Ê†è';
            }
        } else {
            if(fixedToggle) {
                fixedToggle.innerHTML = '‚ñ∂‚óÄ'; // Â±ïÂºÄÂõæÊ†á
                fixedToggle.title = 'Êî∂Áº©Â∑•ÂÖ∑Ê†è';
            }
        }

        // Ê∑ªÂä†ÊòæÁ§∫‰∫©Êï∞Â§çÈÄâÊ°ÜÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
        const toggleLabelsCheckbox = document.getElementById('toggleLabelsCheckbox');
        if (toggleLabelsCheckbox) {
            toggleLabelsCheckbox.addEventListener('change', function() {
                const isChecked = this.checked;
                labelsEnabled = isChecked;
                console.log('Ê†áÁ≠æÊòæÁ§∫Áä∂ÊÄÅÂ∑≤Êõ¥Êîπ:', isChecked);

                // Ëé∑ÂèñÂÆπÂô®ÂÖÉÁ¥†Âπ∂ÂàáÊç¢labels-hiddenÁ±ª
                const container = document.querySelector('.container') || document.body;

                if (isChecked) {
                    // ÂêØÁî®Ê†áÁ≠æÔºöÊòæÁ§∫ÊâÄÊúâÊ†áÁ≠æ
                    console.log('ÂêØÁî®Ê†áÁ≠æÊòæÁ§∫');
                    container.classList.remove('labels-hidden');

                    console.log('Ê£ÄÊü•ÊòØÂê¶ÊúâËΩÆÂªìÂõæÂ±ÇÁªÑ:', outlineLayerGroup);
                    if (outlineLayerGroup && outlineLayerGroup.getLayers) {
                        console.log('ËΩÆÂªìÂõæÂ±ÇÁªÑÂ≠òÂú®ÔºåËé∑ÂèñÂõæÂ±ÇÊï∞Èáè:', outlineLayerGroup.getLayers().length);
                        if (outlineLayerGroup.getLayers().length > 0) {
                            // Ê∏ÖÈô§Áé∞ÊúâÊ†áÁ≠æ
                            labelLayerGroup.clearLayers();
                            console.log('Â∑≤Ê∏ÖÈô§Áé∞ÊúâÊ†áÁ≠æÔºåÂáÜÂ§áÊ∑ªÂä†Êñ∞Ê†áÁ≠æ');

                            // ‰∏∫ÊØè‰∏™ËΩÆÂªìÊ∑ªÂä†Ê†áÁ≠æ
                            // Á°Æ‰øùL.GeometryUtilÂ∑≤Âä†ËΩΩ
                            if (typeof L.GeometryUtil === 'undefined' || typeof L.GeometryUtil.geodesicArea !== 'function') {
                                console.log('‰ΩøÁî®Turf.jsËÆ°ÁÆóÈù¢ÁßØ');
                                // Â∞ùËØï‰ΩøÁî®Turf.js‰Ωú‰∏∫Â§áÈÄâÊñπÊ°à
                                if (typeof turf !== 'undefined') {
                                    console.log('‰ΩøÁî®Turf.jsËÆ°ÁÆóÈù¢ÁßØ');
                                    outlineLayerGroup.eachLayer(function(layer) {
                                        // Ëé∑ÂèñÂõæÂ±Ç‰∏≠ÁöÑÂÆûÈôÖÂá†‰ΩïË¶ÅÁ¥†ËøõË°åÈù¢ÁßØËÆ°ÁÆó
                                        let layers = [];

                                        // Â¶ÇÊûúlayerÊòØLayerGroupÊàñFeatureGroupÔºåËé∑ÂèñÂÖ∂ÊâÄÊúâÂ≠êÂõæÂ±Ç
                                        if (layer instanceof L.LayerGroup || layer instanceof L.FeatureGroup) {
                                            layers = layer.getLayers();
                                        } else {
                                            layers = layer.getLayers ? layer.getLayers() : [layer];
                                        }

                                        console.log('ÂõæÂ±ÇÊï∞ÁªÑÈïøÂ∫¶:', layers && Array.isArray(layers) ? layers.length : 0);
                                        if (layers && Array.isArray(layers) && layers.length > 0) {
                                            for (let j = 0; j < layers.length; j++) {
                                                const subLayer = layers[j];
                                                console.log('Â§ÑÁêÜÂ≠êÂõæÂ±Ç:', subLayer);
                                                let latLngs;

                                                // Ê†πÊçÆÂõæÂ±ÇÁ±ªÂûãËé∑ÂèñÂùêÊ†á
                                                if (subLayer instanceof L.Polygon) {
                                                    latLngs = subLayer.getLatLngs();
                                                    console.log('Â§öËæπÂΩ¢latLngs:', latLngs);
                                                } else if (subLayer instanceof L.MultiPolygon) {
                                                    // ÂØπ‰∫éMultiPolygonÔºåÂèñÁ¨¨‰∏Ä‰∏™Â§öËæπÂΩ¢
                                                    const multiLatLngs = subLayer.getLatLngs();
                                                    console.log('MultiPolygon latLngs:', multiLatLngs);
                                                    if (multiLatLngs && multiLatLngs.length > 0) {
                                                        latLngs = multiLatLngs[0];
                                                    }
                                                } else if (subLayer instanceof L.Rectangle) {
                                                    // ÂØπ‰∫éRectangleÔºåËé∑ÂèñÂÖ∂ËæπÁïåÂùêÊ†á
                                                    latLngs = subLayer.getLatLngs();
                                                    console.log('Áü©ÂΩ¢latLngs:', latLngs);
                                                }

                                                if (latLngs) {
                                                    // ‰ΩøÁî®Turf.jsËÆ°ÁÆóÈù¢ÁßØ
                                                    try {
                                                        // Â§ÑÁêÜÂ§öËæπÂΩ¢ÂùêÊ†áÔºåÊîØÊåÅÂ§ñÈÉ®ËæπÁïåÂíåÂÜÖÈÉ®Â≠îÊ¥û
                                                        const processPolygon = (polyCoords) => {
                                                            if (!Array.isArray(polyCoords) || polyCoords.length === 0) {
                                                                return null;
                                                            }

                                                            // Â¶ÇÊûúÊòØÂ§öËæπÂΩ¢Êï∞ÁªÑÔºàÂ§ñÈÉ®ËæπÁïå+Â≠îÊ¥ûÔºâÔºåÂàÜÂà´Â§ÑÁêÜ
                                                            let processedCoords = [];

                                                            // Â§ÑÁêÜÂ§öËæπÂΩ¢ÁöÑÊØè‰∏™ÁéØÔºàÁ¨¨‰∏Ä‰∏™ÊòØÂ§ñÈÉ®ËæπÁïåÔºåÂÖ∂‰ΩôÊòØÂ≠îÊ¥ûÔºâ
                                                            for (let i = 0; i < polyCoords.length; i++) {
                                                                let ring = polyCoords[i];
                                                                if (!Array.isArray(ring)) {
                                                                    ring = [ring]; // Â¶ÇÊûú‰∏çÊòØÊï∞ÁªÑÔºåËΩ¨Êç¢‰∏∫Êï∞ÁªÑ
                                                                }

                                                                // Â∞ÜLeafletÂùêÊ†áËΩ¨Êç¢‰∏∫GeoJSONÊ†ºÂºè [lng, lat]
                                                                let geoJsonRing = ring.map(latLng => {
                                                                    if (latLng.lat !== undefined && latLng.lng !== undefined) {
                                                                        return [latLng.lng, latLng.lat];
                                                                    } else if (Array.isArray(latLng) && latLng.length >= 2) {
                                                                        // Â¶ÇÊûúÂ∑≤ÁªèÊòØÊï∞ÁªÑÊ†ºÂºè [lat, lng] Êàñ [lng, lat]
                                                                        return [latLng[1], latLng[0]]; // ÂÅáËÆæÊòØ [lat, lng] Ê†ºÂºè
                                                                    }
                                                                    return null;
                                                                }).filter(coord => coord !== null);

                                                                // Á°Æ‰øùÁéØÊòØÈó≠ÂêàÁöÑÔºàËá≥Â∞ëÊúâ4‰∏™ÁÇπÔºåÈ¶ñÂ∞æÁõ∏ÂêåÔºâ
                                                                if (geoJsonRing.length >= 3) {
                                                                    // Â¶ÇÊûúÈ¶ñÂ∞æ‰∏çÁõ∏ÂêåÔºåÈó≠ÂêàÁéØ
                                                                    if (geoJsonRing[0][0] !== geoJsonRing[geoJsonRing.length - 1][0] ||
                                                                        geoJsonRing[0][1] !== geoJsonRing[geoJsonRing.length - 1][1]) {
                                                                        geoJsonRing.push(geoJsonRing[0]);
                                                                    }

                                                                    // Á°Æ‰øùËá≥Â∞ëÊúâ4‰∏™ÁÇπÔºàÈó≠ÂêàÂêéÔºâ
                                                                    if (geoJsonRing.length < 4) {
                                                                        // Â¶ÇÊûúÁÇπÊï∞‰∏çË∂≥4‰∏™ÔºåÂ§çÂà∂ÁÇπÁõ¥Âà∞ËææÂà∞4‰∏™
                                                                        while (geoJsonRing.length < 4) {
                                                                            geoJsonRing.push(geoJsonRing[geoJsonRing.length - 1]);
                                                                        }
                                                                    }
                                                                } else if (geoJsonRing.length === 2) {
                                                                    // Â¶ÇÊûúÂè™Êúâ2‰∏™ÁÇπÔºåÂ§çÂà∂ÂÆÉ‰ª¨ÂΩ¢ÊàêËá≥Â∞ë4‰∏™ÁÇπÁöÑÁéØ
                                                                    geoJsonRing.push(geoJsonRing[1]);
                                                                    geoJsonRing.push(geoJsonRing[0]);
                                                                } else if (geoJsonRing.length === 1) {
                                                                    // Â¶ÇÊûúÂè™Êúâ1‰∏™ÁÇπÔºåÂ§çÂà∂3Ê¨°ÂΩ¢Êàê4‰∏™ÁÇπÁöÑÁéØ
                                                                    for (let k = 0; k < 3; k++) {
                                                                        geoJsonRing.push(geoJsonRing[0]);
                                                                    }
                                                                }

                                                                processedCoords.push(geoJsonRing);
                                                            }

                                                            return processedCoords;
                                                        };

                                                        // Ê†πÊçÆlatLngsÁöÑÁªìÊûÑÂ§ÑÁêÜÂùêÊ†á
                                                        let coordinates;
                                                        if (Array.isArray(latLngs) && latLngs.length > 0) {
                                                            if (Array.isArray(latLngs[0])) {
                                                                // Â¶ÇÊûúÊòØÂ§öËæπÂΩ¢Êï∞ÁªÑÔºàÂåÖÂê´Â§ñÈÉ®ËæπÁïåÂíåÂ≠îÊ¥ûÔºâ
                                                                coordinates = processPolygon(latLngs);
                                                            } else {
                                                                // Â¶ÇÊûúÊòØÂçï‰∏™Â§öËæπÂΩ¢ËæπÁïå
                                                                coordinates = processPolygon([latLngs]);
                                                            }
                                                        } else {
                                                            // Âçï‰∏™Â§öËæπÂΩ¢ËæπÁïå
                                                            coordinates = processPolygon([latLngs]);
                                                        }

                                                        if (coordinates && coordinates.length > 0) {
                                                            const polygon = turf.polygon(coordinates);
                                                            const areaSqM = turf.area(polygon);
                                                            const areaMu = (areaSqM / 666.6667).toFixed(4); // ËΩ¨Êç¢‰∏∫‰∫©
                                                            console.log('‰ΩøÁî®Turf.jsËÆ°ÁÆóÂæóÂà∞ÁöÑÈù¢ÁßØ:', areaSqM, 'Âπ≥ÊñπÁ±≥ (', areaMu, '‰∫©)');
                                                            console.log('‰∏∫ÂõæÂ±ÇÊ∑ªÂä†Èù¢ÁßØÊ†áÁ≠æ:', areaMu, '‰∫©');
                                                            addAreaLabelToLayer(subLayer, `Èù¢ÁßØ: ${areaMu}‰∫©`); // ‰ΩøÁî®subLayerËÄå‰∏çÊòØlayer
                                                        } else {
                                                            console.log('Êó†Ê≥ïÂ§ÑÁêÜÂùêÊ†áÊï∞ÊçÆÔºåË∑≥ËøáÊ≠§ÂõæÂ±Ç');
                                                        }
                                                    } catch (e) {
                                                        console.error('‰ΩøÁî®Turf.jsËÆ°ÁÆóÈù¢ÁßØÊó∂Âá∫Èîô:', e);
                                                    }
                                                } else {
                                                    console.log('Êó†Ê≥ïËé∑ÂèñÂùêÊ†áÔºåË∑≥ËøáÊ≠§ÂõæÂ±Ç');
                                                }
                                            }
                                        } else {
                                            console.log('ÂõæÂ±ÇÊï∞ÁªÑ‰∏∫Á©∫Êàñ‰∏çÊòØÊï∞ÁªÑ');
                                        }
                                    });
                                } else {
                                    console.error('Turf.js‰πüÊú™ÂÆö‰πâÔºåÊó†Ê≥ïËÆ°ÁÆóÈù¢ÁßØ');
                                }
                            } else {
                                console.log('ÂºÄÂßã‰∏∫', outlineLayerGroup.getLayers().length, '‰∏™ËΩÆÂªìÊ∑ªÂä†Ê†áÁ≠æ');
                                let labelCount = 0;
                                outlineLayerGroup.eachLayer(function(layer) {
                                    console.log('Â§ÑÁêÜÂõæÂ±Ç:', layer);
                                    // Ëé∑ÂèñÂõæÂ±Ç‰∏≠ÁöÑÂÆûÈôÖÂá†‰ΩïË¶ÅÁ¥†ËøõË°åÈù¢ÁßØËÆ°ÁÆó
                                    let layers = [];

                                    // Â¶ÇÊûúlayerÊòØLayerGroupÊàñFeatureGroupÔºåËé∑ÂèñÂÖ∂ÊâÄÊúâÂ≠êÂõæÂ±Ç
                                    if (layer instanceof L.LayerGroup || layer instanceof L.FeatureGroup) {
                                        layers = layer.getLayers();
                                    } else {
                                        layers = layer.getLayers ? layer.getLayers() : [layer];
                                    }

                                    console.log('ÂõæÂ±ÇÊï∞ÁªÑÈïøÂ∫¶:', layers && Array.isArray(layers) ? layers.length : 0);
                                    if (layers && Array.isArray(layers) && layers.length > 0) {
                                        for (let j = 0; j < layers.length; j++) {
                                            const subLayer = layers[j];
                                            console.log('Â§ÑÁêÜÂ≠êÂõæÂ±Ç:', subLayer);
                                            let latLngs;

                                            // Ê†πÊçÆÂõæÂ±ÇÁ±ªÂûãËé∑ÂèñÂùêÊ†á
                                            if (subLayer instanceof L.Polygon) {
                                                latLngs = subLayer.getLatLngs();
                                                console.log('Â§öËæπÂΩ¢latLngs:', latLngs);
                                            } else if (subLayer instanceof L.MultiPolygon) {
                                                // ÂØπ‰∫éMultiPolygonÔºåÂèñÁ¨¨‰∏Ä‰∏™Â§öËæπÂΩ¢
                                                const multiLatLngs = subLayer.getLatLngs();
                                                console.log('MultiPolygon latLngs:', multiLatLngs);
                                                if (multiLatLngs && multiLatLngs.length > 0) {
                                                    latLngs = multiLatLngs[0];
                                                }
                                            } else if (subLayer instanceof L.Rectangle) {
                                                // ÂØπ‰∫éRectangleÔºåËé∑ÂèñÂÖ∂ËæπÁïåÂùêÊ†á
                                                latLngs = subLayer.getLatLngs();
                                                console.log('Áü©ÂΩ¢latLngs:', latLngs);
                                            }

                                            if (latLngs) {
                                                // Ê£ÄÊü•L.GeometryUtilÊòØÂê¶ÂèØÁî®ÔºåÂ¶ÇÊûú‰∏çÂèØÁî®Âàô‰ΩøÁî®Turf.js
                                                if (typeof L.GeometryUtil !== 'undefined' && typeof L.GeometryUtil.geodesicArea === 'function') {
                                                    const areaSqM = L.GeometryUtil.geodesicArea(latLngs[0] || latLngs);
                                                    const areaMu = (areaSqM / 666.6667).toFixed(4); // ËΩ¨Êç¢‰∏∫‰∫©
                                                    console.log('‰ΩøÁî®L.GeometryUtilËÆ°ÁÆóÂæóÂà∞ÁöÑÈù¢ÁßØ:', areaSqM, 'Âπ≥ÊñπÁ±≥ (', areaMu, '‰∫©)');
                                                    console.log('‰∏∫ÂõæÂ±ÇÊ∑ªÂä†Èù¢ÁßØÊ†áÁ≠æ:', areaMu, '‰∫©');
                                                    addAreaLabelToLayer(subLayer, `Èù¢ÁßØ: ${areaMu}‰∫©`); // ‰ΩøÁî®subLayerËÄå‰∏çÊòØlayer
                                                    labelCount++;
                                                } else {
                                                    console.log('L.GeometryUtilÊú™ÂÆö‰πâÊàñgeodesicAreaÊñπÊ≥ï‰∏çÂ≠òÂú®ÔºåÂ∞ùËØï‰ΩøÁî®Turf.js');
                                                    // ‰ΩøÁî®Turf.jsËÆ°ÁÆóÈù¢ÁßØ
                                                    try {
                                                        // Â§ÑÁêÜÂ§öËæπÂΩ¢ÂùêÊ†áÔºåÊîØÊåÅÂ§ñÈÉ®ËæπÁïåÂíåÂÜÖÈÉ®Â≠îÊ¥û
                                                        const processPolygon = (polyCoords) => {
                                                            if (!Array.isArray(polyCoords) || polyCoords.length === 0) {
                                                                return null;
                                                            }

                                                            // Â¶ÇÊûúÊòØÂ§öËæπÂΩ¢Êï∞ÁªÑÔºàÂ§ñÈÉ®ËæπÁïå+Â≠îÊ¥ûÔºâÔºåÂàÜÂà´Â§ÑÁêÜ
                                                            let processedCoords = [];

                                                            // Â§ÑÁêÜÂ§öËæπÂΩ¢ÁöÑÊØè‰∏™ÁéØÔºàÁ¨¨‰∏Ä‰∏™ÊòØÂ§ñÈÉ®ËæπÁïåÔºåÂÖ∂‰ΩôÊòØÂ≠îÊ¥ûÔºâ
                                                            for (let i = 0; i < polyCoords.length; i++) {
                                                                let ring = polyCoords[i];
                                                                if (!Array.isArray(ring)) {
                                                                    ring = [ring]; // Â¶ÇÊûú‰∏çÊòØÊï∞ÁªÑÔºåËΩ¨Êç¢‰∏∫Êï∞ÁªÑ
                                                                }

                                                                // Â∞ÜLeafletÂùêÊ†áËΩ¨Êç¢‰∏∫GeoJSONÊ†ºÂºè [lng, lat]
                                                                let geoJsonRing = ring.map(latLng => {
                                                                    if (latLng.lat !== undefined && latLng.lng !== undefined) {
                                                                        return [latLng.lng, latLng.lat];
                                                                    } else if (Array.isArray(latLng) && latLng.length >= 2) {
                                                                        // Â¶ÇÊûúÂ∑≤ÁªèÊòØÊï∞ÁªÑÊ†ºÂºè [lat, lng] Êàñ [lng, lat]
                                                                        return [latLng[1], latLng[0]]; // ÂÅáËÆæÊòØ [lat, lng] Ê†ºÂºè
                                                                    }
                                                                    return null;
                                                                }).filter(coord => coord !== null);

                                                                // Á°Æ‰øùÁéØÊòØÈó≠ÂêàÁöÑÔºàËá≥Â∞ëÊúâ4‰∏™ÁÇπÔºåÈ¶ñÂ∞æÁõ∏ÂêåÔºâ
                                                                if (geoJsonRing.length >= 3) {
                                                                    // Â¶ÇÊûúÈ¶ñÂ∞æ‰∏çÁõ∏ÂêåÔºåÈó≠ÂêàÁéØ
                                                                    if (geoJsonRing[0][0] !== geoJsonRing[geoJsonRing.length - 1][0] ||
                                                                        geoJsonRing[0][1] !== geoJsonRing[geoJsonRing.length - 1][1]) {
                                                                        geoJsonRing.push(geoJsonRing[0]);
                                                                    }

                                                                    // Á°Æ‰øùËá≥Â∞ëÊúâ4‰∏™ÁÇπÔºàÈó≠ÂêàÂêéÔºâ
                                                                    if (geoJsonRing.length < 4) {
                                                                        // Â¶ÇÊûúÁÇπÊï∞‰∏çË∂≥4‰∏™ÔºåÂ§çÂà∂ÁÇπÁõ¥Âà∞ËææÂà∞4‰∏™
                                                                        while (geoJsonRing.length < 4) {
                                                                            geoJsonRing.push(geoJsonRing[geoJsonRing.length - 1]);
                                                                        }
                                                                    }
                                                                } else if (geoJsonRing.length === 2) {
                                                                    // Â¶ÇÊûúÂè™Êúâ2‰∏™ÁÇπÔºåÂ§çÂà∂ÂÆÉ‰ª¨ÂΩ¢ÊàêËá≥Â∞ë4‰∏™ÁÇπÁöÑÁéØ
                                                                    geoJsonRing.push(geoJsonRing[1]);
                                                                    geoJsonRing.push(geoJsonRing[0]);
                                                                } else if (geoJsonRing.length === 1) {
                                                                    // Â¶ÇÊûúÂè™Êúâ1‰∏™ÁÇπÔºåÂ§çÂà∂3Ê¨°ÂΩ¢Êàê4‰∏™ÁÇπÁöÑÁéØ
                                                                    for (let k = 0; k < 3; k++) {
                                                                        geoJsonRing.push(geoJsonRing[0]);
                                                                    }
                                                                }

                                                                processedCoords.push(geoJsonRing);
                                                            }

                                                            return processedCoords;
                                                        };

                                                        // Ê†πÊçÆlatLngsÁöÑÁªìÊûÑÂ§ÑÁêÜÂùêÊ†á
                                                        let coordinates;
                                                        if (Array.isArray(latLngs) && latLngs.length > 0) {
                                                            if (Array.isArray(latLngs[0])) {
                                                                // Â¶ÇÊûúÊòØÂ§öËæπÂΩ¢Êï∞ÁªÑÔºàÂåÖÂê´Â§ñÈÉ®ËæπÁïåÂíåÂ≠îÊ¥ûÔºâ
                                                                coordinates = processPolygon(latLngs);
                                                            } else {
                                                                // Â¶ÇÊûúÊòØÂçï‰∏™Â§öËæπÂΩ¢ËæπÁïå
                                                                coordinates = processPolygon([latLngs]);
                                                            }
                                                        } else {
                                                            // Âçï‰∏™Â§öËæπÂΩ¢ËæπÁïå
                                                            coordinates = processPolygon([latLngs]);
                                                        }

                                                        if (coordinates && coordinates.length > 0) {
                                                            const polygon = turf.polygon(coordinates);
                                                            const areaSqM = turf.area(polygon);
                                                            const areaMu = (areaSqM / 666.6667).toFixed(4); // ËΩ¨Êç¢‰∏∫‰∫©
                                                            console.log('‰ΩøÁî®Turf.jsËÆ°ÁÆóÂæóÂà∞ÁöÑÈù¢ÁßØ:', areaSqM, 'Âπ≥ÊñπÁ±≥ (', areaMu, '‰∫©)');
                                                            console.log('‰∏∫ÂõæÂ±ÇÊ∑ªÂä†Èù¢ÁßØÊ†áÁ≠æ:', areaMu, '‰∫©');
                                                            addAreaLabelToLayer(subLayer, `Èù¢ÁßØ: ${areaMu}‰∫©`); // ‰ΩøÁî®subLayerËÄå‰∏çÊòØlayer
                                                            labelCount++;
                                                        } else {
                                                            console.log('Êó†Ê≥ïÂ§ÑÁêÜÂùêÊ†áÊï∞ÊçÆÔºåË∑≥ËøáÊ≠§ÂõæÂ±Ç');
                                                        }
                                                    } catch (e) {
                                                        console.error('‰ΩøÁî®Turf.jsËÆ°ÁÆóÈù¢ÁßØÊó∂Âá∫Èîô:', e);
                                                    }
                                                }
                                            } else {
                                                console.log('Êó†Ê≥ïËé∑ÂèñÂùêÊ†áÔºåË∑≥ËøáÊ≠§ÂõæÂ±Ç');
                                            }
                                        }
                                    } else {
                                        console.log('ÂõæÂ±ÇÊï∞ÁªÑ‰∏∫Á©∫Êàñ‰∏çÊòØÊï∞ÁªÑ');
                                    }
                                });
                                console.log('ÊÄªÂÖ±Â§ÑÁêÜ‰∫Ü', labelCount, '‰∏™Ê†áÁ≠æ');
                            }
                        } else {
                            console.log('ËΩÆÂªìÂõæÂ±ÇÁªÑ‰∏≠Ê≤°ÊúâÂõæÂ±Ç');
                        }
                    } else {
                        console.log('ËΩÆÂªìÂõæÂ±ÇÁªÑ‰∏çÂ≠òÂú®ÊàñÊ≤°ÊúâgetLayersÊñπÊ≥ï');
                    }
                } else {
                    // Á¶ÅÁî®Ê†áÁ≠æÔºöÈöêËóèÊâÄÊúâÊ†áÁ≠æ
                    console.log('Á¶ÅÁî®Ê†áÁ≠æÊòæÁ§∫ÔºåÊ∏ÖÈô§ÊâÄÊúâÊ†áÁ≠æ');
                    if (labelLayerGroup) {
                        labelLayerGroup.clearLayers();
                        console.log('Ê†áÁ≠æÂõæÂ±ÇÂ∑≤Ê∏ÖÁ©∫ÔºåÂΩìÂâçÂõæÂ±ÇÊï∞Èáè:', labelLayerGroup.getLayers().length);
                    } else {
                        console.log('Ê†áÁ≠æÂõæÂ±ÇÁªÑ‰∏çÂ≠òÂú®');
                    }
                    container.classList.add('labels-hidden');
                }

                // Á°Æ‰øùÊ†áÁ≠æÂõæÂ±ÇÂßãÁªàÂú®ÊúÄ‰∏äÂ±Ç
                if (labelLayerGroup) {
                    map.removeLayer(labelLayerGroup);
                    map.addLayer(labelLayerGroup);
                }
            });
        }

        updateStatus('È°µÈù¢Âä†ËΩΩÂÆåÊàê');

        // Ê∑ªÂä†ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÈöêËóèÂè≥ÈîÆËèúÂçïÁöÑ‰∫ã‰ª∂ÁõëÂê¨
        document.addEventListener('click', function(e) {
            // Â¶ÇÊûúÁÇπÂáªÁöÑ‰∏çÊòØÂè≥ÈîÆËèúÂçïÊú¨Ë∫´Ôºå‰πü‰∏çÊòØËé∑ÂèñÂú∞ÂùÄËèúÂçïÈ°πÔºåÂàôÈöêËóèËèúÂçï
            if (contextMenu && !contextMenu.contains(e.target) && 
                (!getAddressMenuItem || !getAddressMenuItem.contains(e.target))) {
                hideContextMenu();
            }
        });

        // ÈòªÊ≠¢Âè≥ÈîÆËèúÂçïÂÜÖÈÉ®ÁöÑÁÇπÂáª‰∫ã‰ª∂ÂÜíÊ≥°
        if (contextMenu) {
            contextMenu.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }
    });

    // ÂÖ®Â±ÄÂáΩÊï∞‰æõHTMLË∞ÉÁî®
    window.drawOutline = drawOutline;
    window.clearOutline = clearOutline;
    window.drawTrack = drawTrack;
    window.startPlayback = startPlayback;
    window.stopPlayback = stopPlayback;

    // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéËá™Âä®Ë∞ÉÁî®ËΩ®ËøπÂíåËΩÆÂªìÁªòÂà∂ÂäüËÉΩ
    document.addEventListener('DOMContentLoaded', function() {
        // ÂÖàË∞ÉÁî®ËΩ®ËøπTAB‰∏≠ÁöÑËΩ®ËøπÊåâÈíÆÊñπÊ≥ï
        drawTrack();
        // ÂÜçË∞ÉÁî®ËΩÆÂªìTAB‰∏≠ÁöÑÂõûÊâßËΩÆÂªìÊñπÊ≥ï
        drawOutline();
    });
</script>
</body>
</html>