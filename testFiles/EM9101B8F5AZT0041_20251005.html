<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>展示轮廓</title>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #mapContainer {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        #mapLoading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
            transition: opacity 0.3s;
        }

        .loading-text {
            font-size: 16px;
            color: #333;
            padding: 10px 20px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .wkt-input-container {
            position: absolute;
            top: 20px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            width: min(320px, 90vw);
            box-sizing: border-box;
            transition: all 0.3s;
        }

        .minimize-btn {
            position: absolute;
            top: -5px;
            right: -4px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #f0f0f0;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #666;
            z-index: 1001;
            transition: background 0.2s;
        }

        .minimize-btn:hover {
            background: #e0e0e0;
        }

        .content-wrapper {
            transition: all 0.3s;
        }

        .wkt-input-container.minimized {
            width: 40px;
            height: 40px;
            padding: 0;
        }

        .wkt-input-container.minimized .content-wrapper {
            display: none;
        }

        .wkt-input-container.minimized .min-icon {
            display: none;
        }

        .wkt-input-container.minimized .restore-icon {
            display: inline;
        }

        #wktTextarea {
            width: 100%;
            height: 120px;
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
            box-sizing: border-box;
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        /* 页签样式 */
        .tabs-header {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .tab-btn {
            flex: 1;
            padding: 6px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            background: #f5f5f5;
            color: #333;
            transition: background 0.2s;
        }
        .tab-btn.active { background: #337AFF; color: #fff; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        /* Multi → Polygons 分割器样式 */
        .split-section {
            margin-top: 10px;
            padding: 10px;
            background: #fafafa;
            border: 1px solid #eee;
            border-radius: 6px;
        }
        .split-section .title {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
        }
        .split-section .desc {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        #multiInput, #polyOutput {
            width: 100%;
            height: 90px;
            margin-bottom: 8px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
            box-sizing: border-box;
        }
        .split-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .split-actions button {
            flex: 1;
            padding: 6px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }
        #splitMultiBtn { background: #337AFF; color: #fff; }
        #splitMultiBtn:hover { background: #2860E0; }
        #copyPolysBtn { background: #f5f5f5; color: #333; }
        #copyPolysBtn:hover { background: #e0e0e0; }
        #drawButton,
        #clearButton,
        #drawTrackButton,
        #clearTrackButton {
            width: 50%;
            padding: 8px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        #drawButton,
        #drawTrackButton {
            background: #337AFF;
            color: white;
        }

        #drawButton:hover,
        #drawTrackButton:hover {
            background: #2860E0;
        }

        #clearButton,
        #clearTrackButton {
            background: #f5f5f5;
            color: #333;
        }

        #clearButton:hover,
        #clearTrackButton:hover {
            background: #e0e0e0;
        }

        #drawButton:disabled,
        #clearButton:disabled,
        #drawTrackButton:disabled,
        #clearTrackButton:disabled {
            background: #e0e0e0;
            color: #999;
            cursor: not-allowed;
        }

        .tip {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .area-label {
             position: absolute;
             background: rgba(255, 0, 0, 0.85);
             border: 1px solid #000;
             border-radius: 3px;
             padding: 4px 6px;
             font-size: 12px;
             color: #fff;
             font-weight: 600;
             box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
             white-space: nowrap;
             z-index: 9999;
             pointer-events: none;
         }
         /* 默认隐藏标签容器下的标签 */
          .labels-hidden .area-label { display: none; }

          /* Batch → Generator 样式 */
          .batch-section { margin-top: 10px; padding: 10px; background: #fafafa; border: 1px solid #eee; border-radius: 6px; }
          .batch-section .title { font-size: 13px; font-weight: 600; color: #333; margin-bottom: 6px; }
          .batch-section .desc { font-size: 12px; color: #666; margin-bottom: 8px; }
          #batchInput, #multiOutput { width: 100%; height: 90px; margin-bottom: 8px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; resize: vertical; box-sizing: border-box; }
          .batch-actions { display: flex; gap: 8px; margin-bottom: 8px; }
          .batch-actions button { flex: 1; padding: 6px 0; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; transition: background 0.2s; }
          #generateMultiBtn { background: #337AFF; color: #fff; }
          #generateMultiBtn:hover { background: #2860E0; }
          #copyMultiBtn { background: #f5f5f5; color: #333; }
          #copyMultiBtn:hover { background: #e0e0e0; }
      </style>
    <script src="https://api.tianditu.gov.cn/api?v=4.0&tk=648f621977051d0199ff0f965d3fd322"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
    <script src="https://lib.baomitu.com/terraformer/1.0.12/terraformer.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://unpkg.com/terraformer-wkt-parser@1.2.1/terraformer-wkt-parser.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- 已移除动态备用加载器 ensureTerraformer：改为仅使用静态脚本标签加载 Terraformer 核心库与 WKT 解析器 -->
    <script>
        // 检查Turf.js是否加载成功
        window.addEventListener('load', function () {
            if (typeof turf === 'undefined') {
                console.warn('Turf.js加载失败，已启用备用面积算法');
            } else {
                console.log('Turf.js加载成功');
            }
        });
    </script>
</head>

<body>
<div id="mapContainer">
    <div id="mapLoading">
        <div class="loading-text">地图正在加载中...</div>
    </div>
</div>

<div class="wkt-input-container">
    <div class="minimize-btn" id="minimizeBtn">
        <span class="min-icon">−</span>
        <span class="restore-icon" style="display:none;">+</span>
    </div>

    <div class="content-wrapper">
        <div class="tabs-header">
            <button class="tab-btn active" id="tabDrawBtn">轮廓</button>
            <button class="tab-btn" id="tabTrackBtn">轨迹</button>
            <button class="tab-btn" id="tabSplitBtn">分割器</button>
            <button class="tab-btn" id="tabBatchBtn">合并器</button>
        </div>
        <div class="tab-pane active" id="tabDraw">
            <div class="tip">请输入WKT字符串（支持POLYGON/MULTIPOLYGON）：</div>
            <textarea id="wktTextarea">MULTIPOLYGON (((124.4810007175829 45.336498526550436, 124.48101511080236 45.336525023143466, 124.48105923861348 45.33660125100487, 124.48106910687113 45.33661802751073, 124.4810871346715 45.33665406687277, 124.48112026913752 45.33671430340074, 124.48115719696024 45.33677718053197, 124.48119108277031 45.33683897233236, 124.48122611387096 45.336906028969814, 124.48126305973034 45.3369739295006, 124.48130078393146 45.33704739245627, 124.48130517465228 45.33705880833875, 124.48130857942222 45.337101368115775, 124.48127792415082 45.33711645245902, 124.48121313888959 45.33702880179146, 124.48121147708791 45.33702699841167, 124.48120935887688 45.33702545114866, 124.48120686174012 45.33702421660103, 124.48120407702258 45.337023339928294, 124.48120110658854 45.33702285319897, 124.48119805909597 45.3370227742175, 124.48119504602144 45.33702310587304, 124.48119217758273 45.337023836033666, 124.48118955870679 45.33702493799027, 124.48118728519141 45.337026371433495, 124.48118544020159 45.33702808392825, 124.48118409122657 45.33703001283185, 124.48118328761177 45.33703208758532, 124.48118305875323 45.337034232294585, 124.48118341302269 45.337036368506574, 124.48118433746109 45.337038418079, 124.48124733743951 45.33714241808728, 124.48124885036438 45.33714435999161, 124.48125087380203 45.337146054979904, 124.48125332919581 45.33714743724707, 124.4812561212192 45.337148453128854, 124.48125914147657 45.33714906318534, 124.48126227271146 45.33714924373213, 124.48126539335873 45.33714898775974, 124.4812659208415 45.337148867302474, 124.48126986108923 45.33715419821566, 124.4812716929817 45.33715614976376, 124.4812740579742 45.33715779160739, 124.48132205797702 45.337184791611506, 124.48132479384302 45.337186031378735, 124.48132782945422 45.337186853883736, 124.48133103854228 45.33718722491384, 124.48133428762281 45.3371871290358, 124.48133744154815 45.33718657023772, 124.48134036912847 45.33718557176321, 124.48134294858896 45.337184175144536, 124.48134507263514 45.33718243847502, 124.48134665291597 45.337180433992664, 124.4813476236986 45.33717824507533, 124.48136275033792 45.33712588361564, 124.4813709206165 45.33714265417676, 124.48141210657167 45.33721801580383, 124.48145504735184 45.33729790566598, 124.48149517894637 45.337376146805575, 124.4815401297184 45.33745605932605, 124.48157798113525 45.33752678174473, 124.48160988942605 45.337593589765206, 124.48161021102199 45.33759420347976, 124.4816460113093 45.33765685401117, 124.48167784520959 45.33772549589759, 124.48171204444347 45.33778989972467, 124.48174199124573 45.337847796905024, 124.48177696266401 45.33791773977823, 124.4818092014403 45.33797918684757, 124.48187118074554 45.3380881505143, 124.48190500563678 45.33814883637718, 124.48192211819318 45.33818503751288, 124.48195811817862 45.338251037517715, 124.48195883046327 45.338252156938594, 124.48197731480526 45.33827741888922, 124.481995873118 45.33832179749012, 124.4819947211586 45.33832378349576, 124.48199412482516 45.338325948680264, 124.48199413921559 45.33832815430945, 124.48199476377643 45.33833031553192, 124.48200183146413 45.338346466476565, 124.48201903586332 45.3383838833082, 124.4820429714129 45.33842975980139, 124.48207391107375 45.338493635264754, 124.4820743905295 45.3384945052743, 124.48210544121964 45.338544586184824, 124.48214340673053 45.338604531752445, 124.48217506776103 45.338655980948765, 124.48219183136538 45.33869246646135, 124.48219224182695 45.338693257479655, 124.48222121833558 45.33874321699947, 124.48225924073465 45.33881025564765, 124.48229924071991 45.33887925565298, 124.48233524411219 45.33894126152728, 124.48236614358672 45.3389930941893, 124.48240600533123 45.33907082463043, 124.48244208941718 45.3391379848173, 124.48246327600096 45.33917331672686, 124.48250717022248 45.33924913405221, 124.48255201795232 45.33933185323809, 124.48258393677814 45.339396688387616, 124.48261455571445 45.339455062361054, 124.48257136731443 45.33963076041838, 124.48255594111517 45.339677397793686, 124.48216265952276 45.34030406508703, 124.48196494009728 45.34056469515099, 124.4819636867636 45.34056686443858, 124.48196309787657 45.34056916977924, 124.48196283383504 45.34057168512241, 124.48193714922006 45.34059634233464, 124.48193560753947 45.34059815896989, 124.48193457599287 45.340600147193214, 124.48193409114313 45.34060223653296, 124.48192309111117 45.34071623653183, 124.48192315625118 45.34071826948247, 124.48192373945822 45.34072026092291, 124.48192482166236 45.34072214573604, 124.48194424544074 45.34074876356121, 124.48194409782609 45.340750169777266, 124.48194414761112 45.34075221471414, 124.48194472176297 45.34075421947062, 124.48194580128974 45.34075611773316, 124.48207480125765 45.34093411774945, 124.48207703220739 45.34093643131876, 124.48211010869493 45.34096292395902, 124.4821831099165 45.34103361985983, 124.48218548761237 45.34103545557245, 124.48225205521139 45.341076615743724, 124.48228803220056 45.34110543134076, 124.48229003459132 45.341106778811266, 124.48229233720966 45.34110786180279, 124.48229487068483 45.34110864768807, 124.48230954658715 45.34111216381147, 124.4823164876175 45.34111645558434, 124.48231829822224 45.34111742332553, 124.4824532982357 45.341179423335554, 124.48245595897963 45.341180407129094, 124.48245883415768 45.341181021507765, 124.4825008341656 45.341187021508816, 124.48250386727113 45.34118724497663, 124.48250690523139 45.341187057148076, 124.48250983692984 45.34118646489318, 124.48251255513667 45.34118548987429, 124.48254844296939 45.34116939942913, 124.48258287073325 45.34117764770028, 124.48258587580801 45.34117814514052, 124.48258896048104 45.34117822494759, 124.4825920091627 45.34117788413097, 124.48259490761208 45.34117713546179, 124.48259754721798 45.34117600699438, 124.48296492172825 45.340982336720344, 124.48325105041332 45.340860268172364, 124.4834171448242 45.34089771141519, 124.48341873005934 45.3408980063773, 124.48379773013014 45.34095400638717, 124.48380033249653 45.3409542355062, 124.48424033258352 45.34096723550764, 124.48424452602337 45.34096696698533, 124.48466352609945 45.34089996697153, 124.48507771877533 45.34082529714238, 124.48549885819489 45.340836146168485, 124.4858906937616 45.3409786318287, 124.48623109384665 45.34114883188296, 124.486375643899 45.34123855095974, 124.48680564391853 45.34149755099814, 124.486808208435 45.34149881149964, 124.48681107237711 45.341499694950606, 124.4868141256851 45.341500167400525, 124.48681725102219 45.3415002106934, 124.48682032828306 45.341499823165464, 124.48682323921038 45.34149901970925, 124.48682587193888 45.34149783120114, 124.48682812529408 45.34149630331485, 124.48682991268092 45.341494494766216, 124.48683116541112 45.341492475056775, 124.48683183534301 45.34149032180285, 124.48683189673153 45.341488117752796, 124.48683134721767 45.341485947607, 124.48683020791894 45.34148389476294, 124.48682852261803 45.34148203811027, 124.48682635608007 45.34148044899907, 124.48639644618646 45.34122150329952, 124.48625153512614 45.341131558513034, 124.4862502226248 45.34113082635281, 124.48590822265366 45.34095982637982, 124.48590630777696 45.3409590050951, 124.48551030782943 45.340815005119545, 124.48550704217327 45.34081412195274, 124.48550358204686 45.340813762132846, 124.48507658213133 45.340802762133926, 124.48507205052906 45.340803105029394, 124.48465626155634 45.34087806698216, 124.48423954534061 45.34094470179683, 124.48380298209129 45.34093180333452, 124.48342607332354 45.34087611232776, 124.48325385520538 45.340837288589654, 124.48325052900027 45.34083680645015, 124.48324713345453 45.34083683194192, 124.4832438225572 45.34083736390892, 124.48324074645872 45.340838378226245, 124.48294774648913 45.34096337820489, 124.48294645276263 45.34096399303372, 124.48292765696928 45.34097390174512, 124.48292724561028 45.34097392366935, 124.48292423443506 45.34097451545479, 124.48292144482714 45.34097551015531, 124.48254423030758 45.34114463698556, 124.48232580598993 45.34109230612649, 124.48227462922473 45.34106066251372, 124.482135019827 45.34094884267527, 124.48211454372759 45.34092901316183, 124.48203412330486 45.340822778809084, 124.4819767130502 45.340744105575496, 124.48199396145088 45.34057979142782, 124.48201285077931 45.340561657656515, 124.48201356996803 45.34056090541772, 124.48202756996562 45.34054490541609, 124.48202803039241 45.34054434355836, 124.48211325597016 45.34043303782936, 124.48219429221827 45.34031898644602, 124.48228843019764 45.34018478467107, 124.48242457532629 45.33998056055545, 124.4825585752815 45.33976756053906, 124.48255952850808 45.33976555465035, 124.48258631689806 45.33968456649648, 124.48274162116466 45.33943709544962, 124.48276821880806 45.33940928880477, 124.48276973616089 45.339407295550565, 124.48277065709186 45.33940512844105, 124.48277094432795 45.339402875186416, 124.48277058624382 45.33940062698339, 124.48276959733248 45.3393984748243, 124.48276801761841 45.33939650581418, 124.482767405037 45.33939600967022, 124.48280108494015 45.33934234172064, 124.48284042334075 45.339299069467906, 124.48284178137476 45.33929721752722, 124.48284263130324 45.339295220610204, 124.48284294391 45.33929314736034, 124.48284270844934 45.33929106904501, 124.48284193301527 45.339289057105724, 124.48279877570742 45.33920777264329, 124.4827338006671 45.3390948160853, 124.48262887331823 45.33890794555964, 124.4825519194968 45.33876403198958, 124.48247276878334 45.33862876053152, 124.482402504139 45.338505328505626, 124.48232390099712 45.3383839414239, 124.48227207581077 45.33826933788595, 124.48220902486415 45.33814023525048, 124.48214202483388 45.33800723525958, 124.48206991293904 45.33787901631074, 124.4820268128668 45.33779483847335, 124.48196620382897 45.33768753071904, 124.48195146187888 45.3376462532896, 124.48195042207294 45.33764420411796, 124.48194884204358 45.33764233459099, 124.48192617551682 45.33762061251944, 124.48192679257065 45.33762038107193, 124.48192915324024 45.337619036418175, 124.4819311099675 45.3376174007056, 124.4819325918847 45.33761553317557, 124.48193354532063 45.33761350146538, 124.4819339357442 45.33761137915842, 124.4819337490154 45.33760924311931, 124.48193299189711 45.33760717070997, 124.48191402881264 45.33757024261684, 124.48185406431895 45.33744831487817, 124.48179481696296 45.33734184594069, 124.48173281693924 45.33723184594899, 124.48172108683477 45.33721325041772, 124.48171241468785 45.33719012470892, 124.48171153881951 45.337188382960974, 124.4817102703005 45.33718676590566, 124.48168240515334 45.33715726164345, 124.48166420454197 45.33711661361504, 124.4816629409599 45.33711454232792, 124.48166111686461 45.33711269047315, 124.4816588055962 45.33711113250685, 124.48165610008193 45.33710993106889, 124.48165310910036 45.33710913446456, 124.48164995290752 45.3371087747223, 124.48164675840196 45.337108866305954, 124.48164365402249 45.33710940553332, 124.4816407645845 45.337110370724105, 124.4816382062614 45.33711172307164, 124.48163608191368 45.337113408203166, 124.48163447695329 45.33711535836594, 124.48163345590976 45.33711749515128, 124.4816332505506 45.33711865526185, 124.48162170358265 45.337110101951296, 124.48160652834518 45.337091486971744, 124.48160555013133 45.33708454167519, 124.48161626517872 45.337064148512525, 124.48161698067604 45.33706441326366, 124.48161991074478 45.337065032289836, 124.48162295449748 45.3370652453305, 124.48162599992459 45.33706504454582, 124.48162893495524 45.33706443732461, 124.48163165158101 45.33706344601246, 124.48163404983076 45.33706210708945, 124.4816360414494 45.337060469827584, 124.48163755314596 45.337058594477725, 124.48163852929046 45.33705655005227, 124.48163893396115 45.33705441178555, 124.48163875226616 45.33705225836524, 124.48163799089197 45.337050169036615, 124.48158197904958 45.33694114611939, 124.48152197902341 45.3368251461275, 124.48146472356166 45.336716684183706, 124.481398534024 45.33660437568811, 124.48132753400182 45.33649337569734, 124.48132540586897 45.336490935845234, 124.48129756357193 45.336466613872986, 124.48129126556444 45.33645387789699, 124.48129234893567 45.33645311359233, 124.48129411215298 45.33645123402671, 124.48129530855337 45.33644914423557, 124.48129589008325 45.33644692815572, 124.48129583338547 45.336444674796354, 124.48129514073737 45.33644247466401, 124.4812291407043 45.33630147467311, 124.4812278294082 45.33629940318057, 124.4812259553053 45.33629755945831, 124.48122359466502 45.33629601853912, 124.48122084355677 45.33629484313283, 124.48121781394065 45.33629408107421, 124.48121462911114 45.33629376337623, 124.48121141867911 45.33629390296807, 124.48120831329734 45.336294494168875, 124.48120543934385 45.33629551291888, 124.48120291377793 45.33629691775869, 124.48120083938099 45.33629865151642, 124.48119930057345 45.33630064363445, 124.48119835997936 45.336302813040774, 124.48119805587751 45.33630507144844, 124.48119905584635 45.336416071448966, 124.48119933522304 45.3364180970853, 124.48120012768439 45.33642005403362, 124.48120140727403 45.336421878196, 124.48120313208041 45.33642350982378, 124.4812052456091 45.336424895474536, 124.48121476774672 45.33643008936838, 124.48126927564607 45.33647770550294, 124.48129843992231 45.336536682147596, 124.48131718717062 45.33662797325128, 124.48127174823514 45.336550726194616, 124.48122676872427 45.33647276174384, 124.48118250538573 45.33640433125171, 124.48118011670311 45.3364016904624, 124.48112311670077 45.33635469046841, 124.48112093174363 45.3363532026874, 124.48111838643905 45.3363520340942, 124.48111557313656 45.33635122708813, 124.48111259390986 45.336350810949334, 124.4811095568522 45.336350800776366, 124.48110657215538 45.33635119693829, 124.48110374811155 45.33635198506139, 124.48110118718367 45.3363531365507, 124.4810989822885 45.33635460962738, 124.48109721342486 45.33635635084467, 124.48109594477154 45.33635829702702, 124.48109522235839 45.33636037756218, 124.48109507239631 45.336362516963355, 124.48109550032649 45.33636463760783, 124.48109622456616 45.33636675461935, 124.48108600000214 45.3363667546192, 124.48108278212844 45.3363669860138, 124.4810796966823 45.33636767067524, 124.48107687064122 45.33636878042713, 124.48107442030744 45.336370269599044, 124.4810724465215 45.336372076905974, 124.48107103051191 45.33637412797048, 124.48106957070821 45.33637693528498, 124.48104407106702 45.336387243646, 124.4810414623797 45.33638856058485, 124.48103928028753 45.33639021917723, 124.48103761312845 45.33639215227822, 124.48103652839443 45.33639428162995, 124.48103618350572 45.33639596651372, 124.48103576812625 45.33639532849402, 124.48103393499701 45.336393543241535, 124.48103164331422 45.336392044484626, 124.48102898112651 45.33639088980692, 124.48102605071756 45.336390123572194, 124.48102296467628 45.3363897752199, 124.48101984157141 45.336389858134034, 124.48101680139527 45.336390369128964, 124.48101396095437 45.336391288571825, 124.48096296095994 45.336412288568184, 124.48096057249951 45.33641349281629, 124.48095853760965 45.336414985521834, 124.48095692528837 45.33641671607088, 124.48095579020547 45.336418625784844, 124.480955170849 45.33642064991007, 124.48095508821966 45.336422719813484, 124.48095554511937 45.336424765309815, 124.48095652605589 45.33642671704136, 124.48097529216327 45.336455360058615, 124.48099609419684 45.33649399242494, 124.48099747233267 45.336495952402885, 124.48099936246876 45.3364976870921, 124.4810007175829 45.336498526550436), (124.48109550903648 45.33639237290927, 124.48110383697362 45.33638900629424, 124.48110850031682 45.3364026376097, 124.48110971238033 45.33640499160133, 124.481111633076 45.33640709802139, 124.48112525152325 45.336418900678126, 124.48116130195672 45.33647736086331, 124.48121010579253 45.336562020616434, 124.4812413705973 45.33662339235424, 124.48124717815037 45.3366604501884, 124.4812367828829 45.33664178629211, 124.48118578286383 45.336552786298896, 124.48113577675169 45.33646577568722, 124.48113523101483 45.3364649285757, 124.48109035360092 45.33640228721249, 124.48109550903648 45.33639237290927), (124.48124478679766 45.33656358336729, 124.48126625467896 45.33660007881003, 124.48126438725944 45.336598910146, 124.4812623517536 45.33659806274256, 124.48124478679766 45.33656358336729), (124.48144198254141 45.337021686182986, 124.48140497905972 45.336950146133134, 124.4813619040344 45.33687200321998, 124.48132288139476 45.33679796238582, 124.48129197715505 45.33674130523471, 124.48129321529497 45.33670911337667, 124.48132512041566 45.33676604210997, 124.48137507133609 45.336859949886254, 124.48142405617351 45.33695092202967, 124.4814700559353 45.33703992089979, 124.4815180460302 45.337130902166386, 124.48156614580475 45.337223087322734, 124.48161811956314 45.33731703993006, 124.48166709393053 45.33740799237055, 124.48171380223862 45.33749345906125, 124.48174161004054 45.33756825251686, 124.48173856595892 45.3375781905557, 124.48171201907466 45.33752821996127, 124.48167409954688 45.33744938730171, 124.48167283209122 45.33744740613896, 124.4816710479155 45.33744563394394, 124.48166678350397 45.337442164596574, 124.48166693883032 45.33744130674355, 124.48166670899352 45.33743907330661, 124.48166585624087 45.337436916269745, 124.48164484584545 45.33739889752638, 124.48159986563556 45.33731793318632, 124.48155090043903 45.33722799715406, 124.48150594183757 45.33714407447193, 124.48149300675266 45.3371192309548, 124.48149296685844 45.33711912254071, 124.48144296683697 45.33702312254748, 124.48144198254141 45.337021686182986), (124.48128480175461 45.3366316088349, 124.48129224765063 45.33664426684571, 124.48134211983833 45.33673104449135, 124.48138410358719 45.33681200997199, 124.48143006540222 45.33689693945372, 124.48147002856757 45.336973868585574, 124.48147133852176 45.3369757985264, 124.48147207391378 45.33697649947, 124.48148184809837 45.33699706783383, 124.48145390593457 45.33694300759681, 124.48140491735484 45.33685202884982, 124.48135492864256 45.336758050116714, 124.48130386550906 45.336666932814644, 124.48128480175461 45.3366316088349), (124.4814939789669 45.33695459637613, 124.4814598964311 45.33688899001807, 124.48141393627292 45.33680406367973, 124.48137177682021 45.33672277569185, 124.4813511241115 45.336686840030715, 124.48135375468911 45.336686186427734, 124.48135645716962 45.336685053740354, 124.48135879201999 45.33668356910556, 124.48136066847742 45.33668179023577, 124.48136201359809 45.336679786281316, 124.48136277509286 45.3366776351422, 124.48136292336021 45.33667542043997, 124.4813591644612 45.33662404909364, 124.48139815376078 45.33669210313756, 124.48144705915743 45.33678292748939, 124.48148899364107 45.33686380117709, 124.48152686728268 45.33693954850033, 124.48156529471306 45.33702625660185, 124.48157308906808 45.33708159664624, 124.48156704887694 45.337093092477986, 124.48156649727729 45.337094543768664, 124.4815579525749 45.337078095246596, 124.4815160393793 45.33699826062818, 124.48149711879779 45.336958427846994, 124.48149587208258 45.33695645576418, 124.48149411393472 45.33695468808496, 124.4814939789669 45.33695459637613), (124.4815726453315 45.33710637874494, 124.48159596710052 45.33712365414956, 124.48165217716421 45.337192605147955, 124.4816540292653 45.337194428335806, 124.48165635753921 45.33719595603883, 124.4816590693717 45.33719712748797, 124.48166205689131 45.3371978960852, 124.48166274521809 45.33719796945695, 124.48171707396305 45.337299955035654, 124.4817731122282 45.33740302618475, 124.48182601691529 45.33749785654882, 124.48186888996416 45.33758759088614, 124.48187429519112 45.337597351259085, 124.48187323882756 45.33759874817995, 124.48187232231669 45.337600950214615, 124.48187205875365 45.337603237619206, 124.48187245911544 45.337605515127386, 124.4818735067278 45.337607687884955, 124.48187515795955 45.33760966540036, 124.4818878512616 45.33762182982676, 124.48191001422099 45.33766185003914, 124.48195412060504 45.337753816602415, 124.48195350182276 45.33775376019474, 124.48195041796386 45.33775390304779, 124.4819474311068 45.337754462790706, 124.48194465346158 45.33775541839503, 124.48194218937874 45.33775673396069, 124.48194013142889 45.33775836006458, 124.48193855692487 45.337760235617324, 124.48193752501777 45.337762290158224, 124.48193707447426 45.33776444650237, 124.48193722222032 45.3377666236403, 124.48193796270563 45.33776873978136, 124.48194696270149 45.33778673978258, 124.48194828271266 45.337788732844814, 124.48195003400711 45.33779041653676, 124.4819721605134 45.337830114094004, 124.48197362050232 45.33783211705479, 124.48197561712665 45.337833874667965, 124.48197807030438 45.33783531643779, 124.48198088164139 45.337836384536615, 124.48198393837853 45.33783703612429, 124.48198711791363 45.3378372450664, 124.48199029271927 45.33783700298257, 124.48199333545803 45.337836319582436, 124.4819956392897 45.337835413041496, 124.48200106483354 45.337846938124265, 124.4820450648151 45.33792993813021, 124.48208502762586 45.338002872176276, 124.4821489371503 45.33813268846684, 124.48219283686285 45.33822148568905, 124.48222674236335 45.338300266165284, 124.48226394045591 45.33837569530416, 124.4822644217024 45.33837655517366, 124.48231325874994 45.338454295811644, 124.48236211454355 45.33854403098512, 124.48239821072222 45.33861020341199, 124.4824422107057 45.33868720341786, 124.48248622321489 45.338762226021, 124.48256612289575 45.338904048019636, 124.48260906707591 45.33898494291007, 124.4826421923835 45.33904017730622, 124.482665242612 45.339083259003935, 124.48271170990103 45.339163340964504, 124.48275183158432 45.33929450821455, 124.48272521837265 45.33925204033128, 124.48270483360798 45.33921387472757, 124.48265283999285 45.33912088618968, 124.48259785909993 45.339021920628504, 124.48254688771384 45.338928972850816, 124.48249890348184 45.33884000213013, 124.48244877216632 45.33875276669515, 124.48236181678487 45.33860184420434, 124.48231359562294 45.33851447244319, 124.48225573544528 45.33842169667933, 124.48221300014416 45.33834417686721, 124.48216711534265 45.33824741986673, 124.48211711531812 45.3381424198736, 124.48207201862573 45.33805322293414, 124.48203385030935 45.33798290529809, 124.48198285028934 45.337890905304924, 124.48198103024123 45.3378885187582, 124.48190303023266 45.337810518767135, 124.48190075839352 45.337808700129365, 124.481898005408 45.33780727669972, 124.48188871761954 45.33779552479587, 124.48187220593711 45.33775861635042, 124.48187098917585 45.33775660384287, 124.48186924290897 45.337754795585845, 124.48186703323458 45.33775326002385, 124.48186444379127 45.33775205527959, 124.48186177986808 45.33775128675186, 124.48185423030175 45.337735657803, 124.48185365106798 45.33773420972105, 124.48185285748667 45.337719131760736, 124.48185351122596 45.33771910503057, 124.48185659662802 45.33771852989553, 124.48185945783007 45.3377175329348, 124.48186198021301 45.33771615408647, 124.48186388847091 45.33771459129878, 124.48186896272165 45.337724739790715, 124.48187026920986 45.3377267167264, 124.48187209224287 45.337728478602074, 124.48187436323909 45.33772995913691, 124.48187699676508 45.33773110263401, 124.48187989374888 45.33773186607565, 124.4818829452077 45.33773222074155, 124.48188603634729 45.337732153289416, 124.48188905088054 45.33773166625672, 124.4818918754025 45.337730777965376, 124.48189440365618 45.337729521832436, 124.48189654053002 45.33772794511291, 124.48189820563606 45.337726107122144, 124.48189933633401 45.33772407700432, 124.48189989008769 45.33772193113131, 124.48189984606533 45.337719750229695, 124.48189920592301 45.33771761634371, 124.48188220591402 45.337679616346065, 124.48188184185068 45.33767889021348, 124.48186228156635 45.337643754206, 124.48185593214949 45.33763105628798, 124.481795941122 45.33751807324164, 124.48174495002546 45.33742109022373, 124.48169385012356 45.33732890526876, 124.48164385993844 45.33723892296898, 124.48159792381304 45.33715503964932, 124.4815726453315 45.33710637874494), (124.48175597116953 45.33750674021448, 124.48175372000232 45.33750805208179, 124.48175256328086 45.33750904130598, 124.48174442335824 45.33748714771365, 124.4817438778767 45.33748595561559, 124.48169689205528 45.337399981600356, 124.48164785421523 45.33730891266655, 124.48159591039463 45.33721501426572, 124.481582371647 45.337189065045415, 124.48161415202082 45.33724709855278, 124.48171509977566 45.33742900449305, 124.48175597116953 45.33750674021448), (124.48180897654706 45.33765536117736, 124.48181732750896 45.337672808724996, 124.48181526201587 45.33767282162619, 124.48181213682547 45.33767329043984, 124.4818092069115 45.3376741892863, 124.4818065899219 45.33767548207324, 124.48180439093974 45.33767711688992, 124.48180269826305 45.33767902809179, 124.48180157985986 45.33768113893622, 124.48180108063879 45.33768336466414, 124.48180122064564 45.3376856159034, 124.48181378198038 45.33774662819132, 124.48176605920582 45.337685963651516, 124.48175188395335 45.337641223094316, 124.48176012416656 45.33761432119967, 124.48176841503494 45.33764137561866, 124.48176938053386 45.33764348876551, 124.48177091586629 45.3376454269505, 124.4817729611887 45.337647114627565, 124.48177543677899 45.33764848601489, 124.48177824614439 45.33764948765888, 124.48178127978214 45.33765008051772, 124.48178441944779 45.33765024148312, 124.48178754276435 45.33764996428101, 124.48179052799202 45.337649259716095, 124.48179325877335 45.33764815525075, 124.48179562866858 45.3376466939345, 124.48179625282847 45.337646120390296, 124.48179684189134 45.337647172323194, 124.4817986173204 45.337649084575865, 124.48180090433688 45.33765070413106, 124.48180897654706 45.33765536117736), (124.48158886705139 45.33735984243, 124.48158912445876 45.337360306544, 124.48158895988887 45.33736033314266, 124.48158886705139 45.33735984243), (124.48160307603962 45.33743356148174, 124.48161385164828 45.33744818551995, 124.48161558359773 45.33745005511997, 124.48161780524308 45.33745164647007, 124.48162042896396 45.337452896808315, 124.48162335128244 45.33745375682204, 124.48162645694372 45.33745419259278, 124.48162962346233 45.33745418693401, 124.48163272595248 45.33745374006885, 124.4816356420538 45.33745286962147, 124.48163695827088 45.33745223550042, 124.48164490463003 45.33745870033, 124.48166049049071 45.33749110255827, 124.48165814657017 45.337490356521855, 124.4816551952357 45.33748986171103, 124.48165216444013 45.337489770073944, 124.4816491638894 45.33749008492761, 124.48164630219476 45.33749079487522, 124.48164368294127 45.337491874218735, 124.48164140093814 45.3374932838891, 124.48163953878738 45.337494972860306, 124.48163816389355 45.33749687999653, 124.48163732602373 45.33749893626494, 124.48163628917825 45.33750285323478, 124.48163135328434 45.337496769459555, 124.48160307603962 45.33743356148174), (124.4815680216641 45.33741971230274, 124.48155392390788 45.33739304091614, 124.48151390939884 45.337318013853896, 124.48147090938114 45.337238013859675, 124.48144792677881 45.33719704172422, 124.48140301834968 45.33710822287671, 124.48135696035794 45.337020110131256, 124.48130890902411 45.336935009143836, 124.481265997121 45.33685118128263, 124.48122492673299 45.336774046519686, 124.48118376604334 45.336703756649186, 124.48113482574935 45.33661786147808, 124.48109285598187 45.33654191622008, 124.48106474989022 45.33649272923353, 124.48102574987605 45.3364257292387, 124.48102433856452 45.33642383898621, 124.48101888879545 45.33641797000665, 124.48103257478577 45.336409416260096, 124.48103469942698 45.33640779971157, 124.48103633614416 45.33640592191173, 124.48103741360369 45.33640387109014, 124.48104125649259 45.33642077982041, 124.4810424534504 45.3364236046027, 124.48109127508202 45.33650032434039, 124.48112113039204 45.33655505903604, 124.48116622958328 45.336637235389354, 124.4812151589435 45.33672211288899, 124.48130009238966 45.336879989253205, 124.48134106957181 45.33695594700688, 124.48141909400744 45.33710499236772, 124.48154502625103 45.33733886664792, 124.48155741370695 45.33736364157311, 124.4815680216641 45.33741971230274), (124.48133942273883 45.3370515793097, 124.48133786711124 45.337052317468356, 124.48133617783672 45.33705350812857, 124.48133138854148 45.33704105596954, 124.48133099173076 45.33704017067252, 124.48130112669442 45.33698201249147, 124.48132711082467 45.33702802604163, 124.48133942273883 45.3370515793097), (124.48125865455034 45.33690305935589, 124.48125592447623 45.336898041503574, 124.48122096146332 45.33683111234059, 124.48118673087514 45.33676869659065, 124.48114980529967 45.336705823341035, 124.48113114262374 45.33667171572046, 124.48115420528661 45.336712193029484, 124.48119516436465 45.33678212456349, 124.4812360374554 45.336858886259144, 124.48125865455034 45.33690305935589), (124.48133875427752 45.33707930320179, 124.48134160414389 45.33708642787076, 124.48133981868884 45.337092608294405, 124.48133875427752 45.33707930320179), (124.48129278793483 45.33713656224461, 124.48133281010048 45.337116868789394, 124.48132157687165 45.337155752995734, 124.48129657946775 45.33714169195279, 124.48129278793483 45.33713656224461), (124.48165267626315 45.33754443250208, 124.48165431142667 45.33754350875965, 124.4816567183567 45.337549209382786, 124.48165700577198 45.33754982471331, 124.48169698400744 45.337627782312175, 124.48171334977957 45.337660513895834, 124.4817084146953 45.33767662545347, 124.48170805535426 45.33767894620069, 124.48170838319395 45.337681269266554, 124.48170938408545 45.337683494531795, 124.48171101489235 45.33768552609209, 124.48174076702507 45.337714971552344, 124.48175696737246 45.337746749551115, 124.4817929422414 45.33781969862663, 124.48183311039175 45.337901023044886, 124.48187712525969 45.33798205034778, 124.48195207389587 45.33811895658841, 124.48199395779748 45.33819973272522, 124.48202886766633 45.33827254477722, 124.48206584102661 45.33835248722374, 124.48210096251648 45.33842273974778, 124.48210128426544 45.3384233298103, 124.4821432842505 45.33849432981586, 124.48217213733918 45.33854308160822, 124.48221100660516 45.33861882688286, 124.4822121060037 45.33862051737259, 124.48221358543589 45.33862205694918, 124.48222023182556 45.33862787254133, 124.48222726725638 45.33863930512095, 124.48226915169957 45.33871409880377, 124.48231313404673 45.33879406674535, 124.48235824674371 45.338869267834944, 124.48239812358517 45.33894004926093, 124.48243214007894 45.3390040777947, 124.48248019270478 45.33909117196353, 124.48257813098672 45.33926406309148, 124.482618992647 45.33934080332033, 124.48265570358423 45.339416209610775, 124.48265730540811 45.33942067786376, 124.48265722142337 45.33942064591662, 124.48265437318983 45.33942000913694, 124.48265140651218 45.33941975828402, 124.48264842556053 45.33941990216614, 124.48264553500621 45.339420435731135, 124.48264283634643 45.33942134024371, 124.4826418449322 45.339421851445366, 124.48262495419446 45.339390096864705, 124.48258097837035 45.33930514361079, 124.48253384828399 45.339220900951524, 124.4824848640748 45.339131929674686, 124.48245279656993 45.33907680832137, 124.48241887706925 45.33901595277497, 124.482374913066 45.338934019899355, 124.48234478344328 45.338881786180174, 124.48230774602904 45.33881672158146, 124.48226582208872 45.338744852001305, 124.48222081885334 45.338661848688325, 124.48217181883454 45.33857484869487, 124.48212275706177 45.33849473540419, 124.48208995526669 45.33843509580477, 124.48208405118666 45.338423287666494, 124.48205305567477 45.338360296861374, 124.48201850094252 45.3382904232439, 124.4820187648002 45.33828968586596, 124.48201893029146 45.33828751709937, 124.4820185015487 45.338285366346014, 124.4820174945651 45.33828331383359, 124.48200673987795 45.338266768168516, 124.48195899071213 45.338175167769755, 124.48192101512313 45.338100215988256, 124.48188590578003 45.338037005110515, 124.48183898053172 45.33794714829686, 124.48179503985742 45.33786126429558, 124.48175695278245 45.33778309529029, 124.4817150182583 45.33770322004615, 124.48167705821415 45.337625302392055, 124.48164442894452 45.33755923593448, 124.4816460710135 45.337558698293044, 124.48164854959671 45.33755743209889, 124.4816506395108 45.337555855248695, 124.48165226375903 45.3375540258369, 124.48165336250071 45.337552011262844, 124.48165389525595 45.337549885747634, 124.48165384239712 45.337547727599656, 124.48165320587162 45.33754561632954, 124.48165267626315 45.33754443250208), (124.48261566146475 45.33958223620063, 124.48264671099736 45.33945592080107, 124.48264694521684 45.339453958579796, 124.48264669050741 45.33945199762859, 124.48264595467946 45.3394500980762, 124.48264559165453 45.339449406061156, 124.48265044408755 45.339446373290784, 124.48266410970434 45.33945583410205, 124.48267596554726 45.33947133790111, 124.48267767761074 45.3394731370061, 124.48267984713225 45.339474671156026, 124.48268239357003 45.33947588339693, 124.4826824030284 45.339475886223354, 124.48261566146475 45.33958223620063), (124.48273473972748 45.33939248951371, 124.4827320084247 45.339392590672894, 124.48272176980586 45.339388279678715, 124.48271491623014 45.33930832145835, 124.48271418793901 45.339305575474455, 124.48268305292869 45.33923689535313, 124.48268373676768 45.3392381757346, 124.48268381584971 45.33923843282493, 124.48268881584707 45.339249432825625, 124.4826894155881 45.339250545782974, 124.4826953176273 45.339259963946745, 124.48272208205138 45.33930997116405, 124.4827234668614 45.33931194696193, 124.4827253715143 45.33931369432168, 124.48272772284756 45.33931514612266, 124.4827304305403 45.33931624659746, 124.4827306157985 45.33931629083829, 124.48273641557294 45.3393255457891, 124.48273795145361 45.33932746321988, 124.48273998775993 45.33932913277938, 124.48274244639734 45.339330490438186, 124.48276679749328 45.33934140644829, 124.48273473972748 45.33939248951371), (124.48123454521385 45.33641244497214, 124.48123089483191 45.33641045385505, 124.48123085399348 45.33640592095178, 124.48123454521385 45.33641244497214), (124.48185325632706 45.3378734405927, 124.48189506347363 45.33795193566117, 124.48189980550671 45.33796093574995, 124.48186297779931 45.337893139303965, 124.48185325632706 45.3378734405927), (124.48221568037347 45.33856186950341, 124.48224545243411 45.338614101184206, 124.4822400866466 45.33860940612105, 124.48221568037347 45.33856186950341), (124.48268570233897 45.33934022866325, 124.48267285873561 45.339316919904114, 124.48261987227283 45.339220944469524, 124.48257088563824 45.33913096906115, 124.48252181897263 45.33904384872542, 124.48247788877975 45.338965972505896, 124.48245579491638 45.33892380631938, 124.48240279489636 45.33883080632643, 124.48235482364969 45.33874885419211, 124.4823139029161 45.33867300116123, 124.48228077832087 45.33861577734405, 124.4822237944154 45.33851580562513, 124.48217084952475 45.338428888213095, 124.48212508472338 45.33833835354414, 124.48207614577075 45.338233484418915, 124.48202689805782 45.33813499242557, 124.4819739224878 45.33803703764524, 124.48192494636653 45.337944083011934, 124.48187592656079 45.33785204566988, 124.48185572864182 45.33781600453554, 124.48186024221783 45.33781784681153, 124.48188090695396 45.337860626402104, 124.48188217692947 45.33786260505829, 124.48188396254984 45.33786437462784, 124.48188619720587 45.33786586910013, 124.48188879753765 45.337867032726564, 124.48189166654446 45.337867822100094, 124.48189469720313 45.33786820777458, 124.4818977764604 45.33786817536309, 124.4819007894499 45.33786772607472, 124.48190362377763 45.33786687666934, 124.48190617371394 45.337865658832506, 124.48190711118228 45.337864993299966, 124.48190907251524 45.33786747498422, 124.4819108340762 45.33786926900852, 124.48191305376531 45.33787078930628, 124.48191417362428 45.33787130270416, 124.48195707101519 45.33795194981778, 124.4820070908587 45.33804498696922, 124.48205605589102 45.33813292634412, 124.48209892076994 45.338218656146715, 124.48213688277112 45.33829857619114, 124.48217588275206 45.33838057619649, 124.48217653736009 45.33838173500451, 124.48222844093817 45.33846058854776, 124.48226722444242 45.33852423329932, 124.48231107233676 45.33860495332516, 124.48234719797047 45.33867418105707, 124.48239316788971 45.338755128125676, 124.48243606987263 45.338832950363766, 124.48249600536853 45.33894982464027, 124.48253814329435 45.339026083627566, 124.48258210363697 45.33910102234408, 124.48261395088976 45.339164716882856, 124.48264987342658 45.339237559843944, 124.48268320421096 45.33931108367761, 124.48268570233897 45.33934022866325), (124.48268001655728 45.3393968935342, 124.48269095404541 45.33940149879354, 124.48269335163593 45.33942947073427, 124.48268645889947 45.339410243629374, 124.48268608114954 45.3394093482177, 124.48268001655728 45.3393968935342), (124.48279005292608 45.33931280664314, 124.48275061548773 45.33918387669922, 124.48276914290881 45.339216085871755, 124.4828092678897 45.339291670182696, 124.48279005292608 45.33931280664314), (124.48242607830055 45.34114008295788, 124.48250970216165 45.34116011781512, 124.48250086773533 45.34116407876179, 124.48246815017407 45.3411594048239, 124.48242607830055 45.34114008295788), (124.48258297110993 45.34115391858795, 124.48260444502881 45.341144290654086, 124.4825851784563 45.3411544474281, 124.48258297110993 45.34115391858795)), ((124.50280980229009 45.34173758617667, 124.50313978278615 45.34172506659807, 124.50319219341155 45.34173437548179, 124.50394543077638 45.341956251813876, 124.5044343839268 45.342124175140135, 124.50449512542775 45.34223505252657, 124.50449653233424 45.34223702109925, 124.50449845679576 45.342238758284424, 124.50450082485641 45.34224019732301, 124.50450354551283 45.34224128291357, 124.50450651421174 45.34224197333741, 124.50450961686765 45.342242242061936, 124.50451273424721 45.342242078760194, 124.50451574655112 45.342241489707796, 124.50451853801819 45.34224049754171, 124.50452100137387 45.342239140390326, 124.50452304195287 45.34223747040827, 124.50452458133675 45.342235551772, 124.50452556036787 45.34223345821367, 124.50452594142281 45.34223127018755, 124.50452570985779 45.3422290717783, 124.50452487457193 45.34222694746951, 124.50446187454669 45.34211194747797, 124.50446054489987 45.342110065714834, 124.50445874179357 45.34210839138359, 124.50445652825516 45.34210698301018, 124.50445398165834 45.34210588982404, 124.50395898172717 45.341935889853154, 124.50395814585097 45.341935623475635, 124.50378744312671 45.34188534125658, 124.50437043223566 45.342038537545854, 124.50437345432763 45.34203910108462, 124.50437657424861 45.342039238014806, 124.50437967210142 45.342038943074265, 124.50438262883753 45.3420382275974, 124.50438533083093 45.34203711907961, 124.50438767424562 45.34203566012063, 124.50438956902549 45.34203390678745, 124.5043909423551 45.342031926459704, 124.50439174145835 45.34202979524031, 124.50439193562627 45.34202759503084, 124.5043915173969 45.3420254103841, 124.50439050284291 45.34202332525486, 124.5043889309529 45.34202141977341, 124.50438686213383 45.34201976716634, 124.5043843758893 45.342018430942396, 124.50438156776413 45.34201746245187, 124.50326656794515 45.34172446250342, 124.50326489446012 45.34172409522267, 124.50320228974176 45.34171297575794, 124.5031671459725 45.341702623516255, 124.50316371285165 45.34170191862089, 124.50316014332182 45.341701770925546, 124.50314289020547 45.34170242554199, 124.5028538945347 45.34165109523561, 124.50285092923079 45.34165077379434, 124.50284793103359 45.341650849743054, 124.5028450060746 45.34165132039323, 124.50284225789264 45.34165216908465, 124.50283978376899 45.34165336577497, 124.50283767128383 45.34165486810325, 124.50283599521569 45.34165662288943, 124.5027902541104 45.34171587180178, 124.50278781997714 45.34171614792856, 124.50278468283099 45.34171700852759, 124.50278187175402 45.34171831436876, 124.50277951201413 45.341720007260896, 124.50277770876646 45.341722011765036, 124.50269966245365 45.34183321567031, 124.50253799514684 45.34204262285409, 124.50230988566662 45.34236493536067, 124.50198506963318 45.342496243951985, 124.50198236831147 45.34249761883458, 124.50162455495708 45.342723346811916, 124.50119148392149 45.34269480347917, 124.50118835796475 45.34269481446134, 124.50118529511056 45.34269525529735, 124.50118241306257 45.342696109046166, 124.50117982257622 45.34269734289868, 124.50117762320237 45.3426989094387, 124.50117589946181 45.342700748464964, 124.50117471759688 45.34270278930473, 124.5011741230261 45.342704953529726, 124.50117413859853 45.34270715796999, 124.50117476371574 45.34270931791011, 124.50117597435502 45.34271135034479, 124.5011777239921 45.34271317716872, 124.50117994538955 45.342714728178, 124.50118255318017 45.34271594376825, 124.50118544714812 45.34271677722495, 124.50118851607976 45.34271719651882, 124.50162851616611 45.342746196523365, 124.50163179111782 45.342746174151955, 124.50163499051492 45.34274568042144, 124.50163797939719 45.34274473615885, 124.50164063168451 45.34274338119599, 124.50200238341854 45.34251516864671, 124.50232993040807 45.3423827560223, 124.50233247024474 45.342381481622034, 124.50233460999117 45.342379883121176, 124.50233626788344 45.34237802160181, 124.50248092741006 45.34217361180833, 124.50248185057603 45.3421738579142, 124.50248493404906 45.34217422016011, 124.50248805848607 45.342174151221435, 124.50249110381661 45.342173653747444, 124.50249395301016 45.342172746855816, 124.50249649657398 45.3421714653979, 124.5024986367602 45.34216985861942, 124.50250029132262 45.34216798826801, 124.5027279692732 45.34184358497722, 124.50280980229009 45.34173758617667), (124.50303529441791 45.34170650787414, 124.50282771519156 45.34171438342759, 124.50285809351601 45.34167503405039, 124.50303529441791 45.34170650787414)), ((124.49835911561183 45.345864453430856, 124.49805850914778 45.346208856774076, 124.49774501689933 45.34641884678605, 124.49774419555584 45.346419439034435, 124.49736542175772 45.346713487072975, 124.49702492111314 45.34687975491345, 124.49702253777885 45.34688118152331, 124.49702059493104 45.34688290859276, 124.49701916723244 45.34688486975156, 124.49701830954871 45.346886989633475, 124.49701805484017 45.34688918677265, 124.49701841289522 45.34689137673426, 124.4970193699541 45.3468934753593, 124.4970208892375 45.34689540199876, 124.4970229123605 45.34689708261298, 124.49702536157544 45.346898452616834, 124.4970281427603 45.346899459361865, 124.49703114903592 45.34690006415935, 124.49703426487244 45.34690024376728, 124.49703737053017 45.34689999128343, 124.49704034666023 45.3468993164106, 124.49704307889164 45.34689824508379, 124.49738507891924 45.34673124505648, 124.49738780446184 45.34672956100108, 124.49776740925488 45.346434867760024, 124.49808198310839 45.3462241531808, 124.49808458089164 45.34622189438364, 124.49838658083841 45.345875894348715, 124.49838715137355 45.34587518417141, 124.4986781512998 45.34548018413663, 124.49867931361484 45.34547813770428, 124.49867988743624 45.34547597069171, 124.49867985071232 45.345473766376, 124.49867920485458 45.34547160946778, 124.49867797468283 45.34546958285578, 124.49867620747209 45.34546776442159, 124.4986739711353 45.34546622404656, 124.49867135161351 45.34546502092642, 124.49866844957356 45.34546420129638, 124.4986653765391 45.34546379665436, 124.49866225060512 45.345463822550514, 124.49865919189932 45.345464277989656, 124.49865631796615 45.34546514546953, 124.49865373924904 45.3454663916534, 124.49865155484676 45.345467968651135, 124.49864984870457 45.345469815859616, 124.49835911561183 45.345864453430856)))</textarea>
            <div class="coord-settings" style="margin-bottom:8px;font-size:12px;color:#333;">
                <label>WKT坐标系：
                    <select id="coordSysSelect" style="margin-left:6px;">
                        <option value="wgs84" selected>WGS84</option>
                        <option value="gcj02">GCJ-02（国测局）</option>
                        <option value="bd09">BD-09（百度）</option>
                        <option value="cgcs2000">CGCS2000</option>
                    </select>
                </label>
                <!-- 已移除“不进行绘制坐标转换”选项，统一使用WGS84绘制 -->
            </div>

            <div class="button-group">
                <button id="drawButton" disabled>绘制轮廓</button>
                <button id="clearButton" disabled>清空轮廓</button>
            </div>
            <!-- 显示开关：仅保留显示亩数 -->
            <div class="display-toggles" style="margin-top:8px;font-size:12px;color:#333;">
                <label><input type="checkbox" id="toggleLabelsCheckbox"> 显示亩数</label>
            </div>
        </div>

        <div class="tab-pane" id="tabSplit">
            <!-- MultiPolygon → 多个 Polygon 分割器 -->
            <div class="split-section">
                <div class="title">MultiPolygon → 多个 Polygon 分割器</div>
                <div class="desc">输入一个 MULTIPOLYGON WKT，分割为多行 POLYGON WKT。</div>
                <textarea id="multiInput"></textarea>
                <div class="split-actions">
                    <button id="splitMultiBtn">分割为多个 POLYGON</button>
                    <button id="copyPolysBtn">复制结果</button>
                </div>
                <textarea id="polyOutput" readonly></textarea>
            </div>
        </div>

        <div class="tab-pane" id="tabBatch">
            <!-- 批量POLYGON → MULTIPOLYGON 生成器 -->
            <div class="batch-section">
                <div class="title">批量POLYGON → MULTIPOLYGON 合并器</div>
                <div class="desc">每行一个 POLYGON WKT（或用分号分隔）。生成后可一键填充到上方并绘制。</div>
                <textarea id="batchInput"></textarea>
                <div class="batch-actions">
                    <button id="generateMultiBtn">生成 MULTIPOLYGON</button>
                    <button id="copyMultiBtn">复制结果</button>
                </div>
                <textarea id="multiOutput" readonly></textarea>
            </div>
        </div>
        <div class="tab-pane" id="tabTrack">
            <div class="tip">请粘贴轨迹文本（支持两种格式：1）每行一条：定位时间yyyyMMddHHmmss, 经度, 纬度；2）单行#分隔：经度,纬度,定位时间yyyyMMddHHmmss#经度,纬度,定位时间yyyyMMddHHmmss#…）。</div>
            <div class="coord-settings" style="margin-bottom:8px;font-size:12px;color:#333;">
                <label>轨迹坐标系：
                    <select id="trackCoordSysSelect" style="margin-left:6px;">
                        <option value="wgs84" selected>WGS84</option>
                        <option value="gcj02">GCJ-02（国测局）</option>
                        <option value="bd09">BD-09（百度）</option>
                        <option value="cgcs2000">CGCS2000</option>
                    </select>
                </label>
            </div>
            <textarea id="trackTextarea" style="width:100%;height:120px;margin-bottom:10px;padding:8px;border:1px solid #ddd;border-radius:4px;font-family:monospace;resize:vertical;box-sizing:border-box;">20251005060816,124.504376,45.342028,4.3,0
20251005061446,124.503261,45.341735,19.0,0
20251005061456,124.502850,45.341662,8.8,0
20251005061506,124.502552,45.342048,19.8,0
20251005061516,124.502322,45.342373,7.1,0
20251005061526,124.501993,45.342506,15.5,0
20251005061536,124.501630,45.342735,13.5,0
20251005061546,124.501190,45.342706,7.2,0
20251005061556,124.500843,45.343088,26.2,0
20251005061606,124.500244,45.343708,32.6,0
20251005061616,124.499677,45.344322,27.1,0
20251005061626,124.499172,45.344880,27.9,0
20251005061636,124.498664,45.345475,27.5,0
20251005061646,124.498373,45.345870,11.8,0
20251005061656,124.498071,45.346216,18.1,0
20251005061706,124.497756,45.346427,14.5,0
20251005061716,124.497376,45.346722,16.8,0
20251005061726,124.497034,45.346889,12.5,0
20251005061736,124.496457,45.346638,21.7,0
20251005061746,124.495757,45.346331,22.1,0
20251005061756,124.495031,45.346009,28.2,0
20251005061806,124.494262,45.345676,25.1,0
20251005061816,124.493597,45.345394,14.6,0
20251005061826,124.492999,45.345123,27.3,0
20251005061836,124.492203,45.344772,24.3,0
20251005061846,124.491551,45.344263,30.5,0
20251005061856,124.490934,45.343717,23.6,0
20251005061906,124.490314,45.343263,23.0,0
20251005061916,124.489783,45.342880,17.9,0
20251005061926,124.489346,45.342651,19.8,0
20251005061937,124.488684,45.342378,21.7,0
20251005061947,124.487878,45.342018,27.7,0
20251005061957,124.487196,45.341683,24.7,0
20251005062007,124.486576,45.341343,21.5,0
20251005062017,124.485942,45.340985,25.8,0
20251005062027,124.485235,45.340797,18.5,0
20251005062037,124.484488,45.340913,25.1,0
20251005062047,124.483634,45.340914,22.8,0
20251005062057,124.482930,45.340985,22.4,0
20251005062107,124.482504,45.341176,1.4,0
20251005062117,124.482462,45.341170,4.3,0
20251005062127,124.482327,45.341108,4.2,0
20251005062137,124.482196,45.341027,4.6,0
20251005062147,124.482101,45.340935,4.2,0
20251005062157,124.482020,45.340828,4.8,0
20251005062207,124.481939,45.340717,4.1,0
20251005062217,124.481950,45.340603,4.9,0
20251005062227,124.482000,45.340555,3.5,0
20251005062237,124.482014,45.340539,3.6,0
20251005062247,124.482099,45.340428,5.4,0
20251005062257,124.482180,45.340314,3.1,0
20251005062307,124.482274,45.340180,11.1,0
20251005062317,124.482410,45.339976,9.7,0
20251005062327,124.482544,45.339763,9.7,0
20251005062337,124.482587,45.339633,3.7,0
20251005062347,124.482591,45.339627,0.0,0
20251005062357,124.482591,45.339627,0.0,0
20251005062602,124.482596,45.339624,0.0,0
20251005062612,124.482592,45.339623,0.0,0
20251005062622,124.482591,45.339618,0.0,0
20251005062632,124.482591,45.339618,0.0,0
20251005062642,124.482590,45.339619,0.0,0
20251005062652,124.482590,45.339621,0.0,0
20251005062702,124.482593,45.339624,0.0,0
20251005062838,124.482640,45.339512,0.0,0
20251005062848,124.482645,45.339490,0.0,0
20251005062858,124.482646,45.339489,0.0,0
20251005062908,124.482631,45.339454,1.9,0
20251005062918,124.482599,45.339393,2.2,0
20251005062928,124.482567,45.339328,3.9,0
20251005062938,124.482522,45.339245,3.8,0
20251005062948,124.482478,45.339169,3.2,0
20251005062958,124.482457,45.339134,2.9,0
20251005063008,124.482421,45.339067,3.1,0
20251005063018,124.482381,45.338989,2.7,0
20251005063028,124.482350,45.338937,2.2,0
20251005063038,124.482314,45.338875,2.9,0
20251005063048,124.482274,45.338806,3.0,0
20251005063058,124.482236,45.338739,2.6,0
20251005063108,124.482207,45.338689,2.7,0
20251005063118,124.482190,45.338652,3.3,0
20251005063128,124.482158,45.338600,2.2,0
20251005063138,124.482120,45.338540,2.6,0
20251005063148,124.482089,45.338490,2.1,0
20251005063158,124.482058,45.338426,3.0,0
20251005063208,124.482044,45.338399,4.1,0
20251005063218,124.482034,45.338380,3.5,0
20251005063228,124.482017,45.338343,2.4,0
20251005063238,124.482010,45.338327,1.2,0
20251005063248,124.482013,45.338323,3.7,0
20251005063258,124.481990,45.338268,3.5,0
20251005063308,124.482003,45.338288,5.8,0
20251005063318,124.481973,45.338247,2.5,0
20251005063328,124.481937,45.338181,2.8,0
20251005063338,124.481920,45.338145,2.3,0
20251005063348,124.481886,45.338084,2.4,0
20251005063358,124.481856,45.338031,2.5,0
20251005063408,124.481824,45.337975,2.4,0
20251005063418,124.481792,45.337914,3.0,0
20251005063429,124.481757,45.337844,2.3,0
20251005063439,124.481727,45.337786,2.4,0
20251005063449,124.481693,45.337722,2.8,0
20251005063459,124.481661,45.337653,2.5,0
20251005063509,124.481625,45.337590,2.8,0
20251005063519,124.481593,45.337523,2.9,0
20251005063529,124.481555,45.337452,3.3,0
20251005063539,124.481510,45.337372,3.4,0
20251005063549,124.481470,45.337294,3.5,0
20251005063559,124.481427,45.337214,3.3,0
20251005063609,124.481386,45.337139,3.3,0
20251005063619,124.481348,45.337061,3.3,0
20251005063629,124.481358,45.337086,3.4,0
20251005063639,124.481332,45.337176,3.5,0
20251005063649,124.481329,45.337191,0.0,0
20251005063659,124.481324,45.337201,0.0,0
20251005063709,124.481330,45.337193,0.0,0
20251005063719,124.481318,45.337210,0.0,0
20251005063729,124.481318,45.337210,0.0,0
20251005063739,124.481319,45.337209,0.0,0
20251005063749,124.481319,45.337209,0.0,0
20251005063759,124.481319,45.337209,0.0,0
20251005063809,124.481319,45.337209,0.0,0
20251005063819,124.481319,45.337209,0.0,0
20251005063829,124.481319,45.337209,0.0,0
20251005063839,124.481319,45.337209,0.0,0
20251005063849,124.481319,45.337209,0.0,0
20251005063859,124.481319,45.337209,0.0,0
20251005063909,124.481319,45.337209,0.0,0
20251005063919,124.481319,45.337209,0.0,0
20251005063929,124.481319,45.337209,0.0,0
20251005063939,124.481319,45.337209,0.0,0
20251005063949,124.481319,45.337209,0.0,0
20251005063959,124.481319,45.337209,0.0,0
20251005064009,124.481319,45.337209,0.0,0
20251005064019,124.481319,45.337209,0.0,0
20251005064029,124.481319,45.337209,0.0,0
20251005064039,124.481319,45.337209,0.0,0
20251005064049,124.481319,45.337209,0.0,0
20251005064059,124.481319,45.337209,0.0,0
20251005064109,124.481319,45.337209,0.0,0
20251005064119,124.481319,45.337209,0.0,0
20251005064129,124.481319,45.337209,0.0,0
20251005064139,124.481319,45.337209,0.0,0
20251005064149,124.481284,45.337149,5.9,0
20251005064159,124.481199,45.337034,2.4,0
20251005064209,124.481198,45.337032,0.0,0
20251005064219,124.481262,45.337138,4.6,0
20251005064229,124.481325,45.337107,2.8,0
20251005064239,124.481321,45.337057,0.8,0
20251005064249,124.481321,45.337054,0.0,0
20251005064259,124.481316,45.337044,2.2,0
20251005064309,124.481278,45.336970,3.5,0
20251005064319,124.481241,45.336902,4.2,0
20251005064329,124.481206,45.336835,3.3,0
20251005064339,124.481172,45.336773,2.5,0
20251005064349,124.481135,45.336710,2.6,0
20251005064359,124.481106,45.336657,5.2,0
20251005064409,124.481102,45.336650,4.3,0
20251005064419,124.481084,45.336614,2.1,0
20251005065456,124.481093,45.336632,0.0,0
20251005065506,124.481093,45.336632,0.0,0
20251005065516,124.481074,45.336597,3.1,0
20251005065526,124.481030,45.336521,3.3,0
20251005065536,124.480986,45.336440,3.9,0
20251005065546,124.481018,45.336500,0.0,0
20251005065556,124.481011,45.336490,2.7,0
20251005065606,124.480990,45.336451,0.6,0
20251005065616,124.480971,45.336422,1.8,0
20251005065626,124.481022,45.336401,1.9,0
20251005065636,124.480998,45.336416,0.3,0
20251005065646,124.481011,45.336430,2.5,0
20251005065656,124.481050,45.336497,3.2,0
20251005065706,124.481078,45.336546,2.7,0
20251005065716,124.481120,45.336622,3.7,0
20251005065726,124.481169,45.336708,3.6,0
20251005065736,124.481210,45.336778,3.4,0
20251005065746,124.481251,45.336855,3.4,0
20251005065756,124.481294,45.336939,3.4,0
20251005065806,124.481342,45.337024,3.7,0
20251005065816,124.481388,45.337112,3.6,0
20251005065826,124.481433,45.337201,3.6,0
20251005065836,124.481456,45.337242,3.5,0
20251005065846,124.481499,45.337322,3.4,0
20251005065856,124.481539,45.337397,3.1,0
20251005065906,124.481576,45.337467,3.4,0
20251005065916,124.481623,45.337550,3.6,0
20251005065926,124.481662,45.337629,3.3,0
20251005065936,124.481700,45.337707,3.4,0
20251005065946,124.481742,45.337787,3.3,0
20251005065956,124.481780,45.337865,3.3,0
20251005070006,124.481824,45.337951,3.9,0
20251005070016,124.481871,45.338041,3.9,0
20251005070026,124.481906,45.338104,3.2,0
20251005070036,124.481944,45.338179,3.3,0
20251005070046,124.481993,45.338273,4.5,0
20251005070056,124.482038,45.338364,3.4,0
20251005070106,124.482069,45.338427,4.2,0
20251005070116,124.482035,45.338359,0.2,0
20251005070126,124.482030,45.338348,0.0,0
20251005070136,124.482031,45.338348,0.0,0
20251005070146,124.482031,45.338348,0.0,0
20251005070156,124.482031,45.338349,0.0,0
20251005070206,124.482031,45.338349,0.0,0
20251005070216,124.482075,45.338439,3.7,0
20251005070226,124.482108,45.338499,2.5,0
20251005070236,124.482157,45.338579,3.7,0
20251005070246,124.482206,45.338666,3.7,0
20251005070256,124.482251,45.338749,1.9,0
20251005070306,124.482293,45.338821,3.6,0
20251005070316,124.482330,45.338886,4.9,0
20251005070326,124.482360,45.338938,3.3,0
20251005070336,124.482404,45.339020,3.2,0
20251005070346,124.482438,45.339081,7.7,0
20251005070356,124.482470,45.339136,3.1,0
20251005070406,124.482519,45.339225,3.9,0
20251005070416,124.482566,45.339309,3.6,0
20251005070426,124.482610,45.339394,3.7,0
20251005070436,124.482635,45.339441,2.5,0
20251005070446,124.482612,45.339398,0.0,0
20251005070456,124.482651,45.339431,4.9,0
20251005070506,124.482677,45.339449,4.1,0
20251005070516,124.482690,45.339466,2.9,0
20251005070526,124.482676,45.339497,0.0,0
20251005070536,124.482676,45.339497,0.0,0
20251005070801,124.482671,45.339413,2.5,0
20251005070811,124.482634,45.339337,3.5,0
20251005070821,124.482593,45.339260,3.4,0
20251005070831,124.482546,45.339177,3.8,0
20251005070841,124.482495,45.339087,3.8,0
20251005070851,124.482447,45.339000,3.5,0
20251005070901,124.482413,45.338936,4.6,0
20251005070911,124.482373,45.338865,3.7,0
20251005070921,124.482328,45.338790,3.7,0
20251005070931,124.482284,45.338710,3.0,0
20251005070941,124.482242,45.338635,3.1,0
20251005070951,124.482234,45.338622,7.4,0
20251005071001,124.482243,45.338704,0.0,0
20251005071011,124.482243,45.338704,0.0,0
20251005071021,124.482243,45.338704,0.0,0
20251005071031,124.482243,45.338703,0.0,0
20251005071041,124.482243,45.338703,0.0,0
20251005071051,124.482226,45.338615,3.6,0
20251005071101,124.482187,45.338539,3.3,0
20251005071111,124.482158,45.338490,1.4,0
20251005071121,124.482116,45.338419,3.1,0
20251005071131,124.482081,45.338349,2.8,0
20251005071141,124.482044,45.338269,2.9,0
20251005071151,124.482009,45.338196,3.1,0
20251005071201,124.481967,45.338115,3.5,0
20251005071211,124.481937,45.338060,3.6,0
20251005071221,124.481892,45.337978,3.4,0
20251005071231,124.481848,45.337897,3.3,0
20251005071241,124.481808,45.337816,2.6,0
20251005071251,124.481772,45.337743,3.1,0
20251005071301,124.481746,45.337692,1.7,0
20251005071311,124.481712,45.337624,3.7,0
20251005071321,124.481672,45.337546,3.5,0
20251005071331,124.481653,45.337501,3.5,0
20251005071341,124.481644,45.337535,2.2,0
20251005071351,124.481601,45.337482,1.6,0
20251005071401,124.481638,45.337549,5.8,0
20251005071411,124.481587,45.337435,3.8,0
20251005071421,124.481573,45.337361,2.7,0
20251005071431,124.481560,45.337335,1.2,0
20251005071441,124.481564,45.337342,0.0,0
20251005071451,124.481564,45.337342,0.0,0
20251005071501,124.481564,45.337342,0.0,0
20251005071511,124.481564,45.337342,0.0,0
20251005071521,124.481564,45.337342,0.0,0
20251005071531,124.481564,45.337342,0.0,0
20251005072027,124.481434,45.337101,2.9,0
20251005072037,124.481397,45.337030,2.9,0
20251005072047,124.481356,45.336952,2.9,0
20251005072057,124.481315,45.336876,3.4,0
20251005072107,124.481272,45.336796,3.3,0
20251005072117,124.481230,45.336718,3.1,0
20251005072127,124.481181,45.336633,3.5,0
20251005072137,124.481136,45.336551,3.8,0
20251005072147,124.481106,45.336496,3.1,0
20251005072157,124.481057,45.336419,2.1,0
20251005072207,124.481071,45.336441,0.0,0
20251005072217,124.481052,45.336397,4.7,0
20251005072227,124.481099,45.336378,1.3,0
20251005072237,124.481146,45.336367,0.0,0
20251005072247,124.481146,45.336368,0.0,0
20251005072257,124.481086,45.336378,3.2,0
20251005072307,124.481073,45.336403,3.6,0
20251005072317,124.481121,45.336470,3.2,0
20251005072327,124.481171,45.336557,3.8,0
20251005072337,124.481222,45.336646,3.6,0
20251005072347,124.481266,45.336725,3.2,0
20251005072357,124.481308,45.336802,3.2,0
20251005072407,124.481347,45.336876,3.2,0
20251005072417,124.481390,45.336954,3.3,0
20251005072427,124.481435,45.337041,3.9,0
20251005072437,124.481478,45.337123,4.1,0
20251005072447,124.481424,45.337018,0.0,0
20251005072457,124.481424,45.337018,0.0,0
20251005072507,124.481424,45.337018,0.0,0
20251005072517,124.481424,45.337018,0.0,0
20251005072527,124.481424,45.337018,0.0,0
20251005072537,124.481424,45.337018,0.0,0
20251005072547,124.481424,45.337019,0.0,0
20251005072557,124.481424,45.337019,0.0,0
20251005072607,124.481428,45.337027,1.6,0
20251005072617,124.481491,45.337148,3.1,0
20251005072627,124.481536,45.337232,3.4,0
20251005072637,124.481585,45.337322,3.7,0
20251005072647,124.481630,45.337403,3.6,0
20251005072657,124.481651,45.337441,5.1,0
20251005072707,124.481594,45.337371,6.6,0
20251005072717,124.481628,45.337443,2.0,0
20251005072727,124.481600,45.337405,5.6,0
20251005072737,124.481659,45.337453,4.3,0
20251005072747,124.481697,45.337532,2.3,0
20251005072757,124.481731,45.337596,2.9,0
20251005072807,124.481719,45.337589,5.8,0
20251005072817,124.481751,45.337690,3.8,0
20251005072827,124.481810,45.337765,3.1,0
20251005072837,124.481861,45.337856,3.9,0
20251005072847,124.481910,45.337948,3.9,0
20251005072857,124.481959,45.338041,4.1,0
20251005072907,124.482012,45.338139,4.1,0
20251005072917,124.482061,45.338237,4.2,0
20251005072927,124.482110,45.338342,3.9,0
20251005072937,124.482156,45.338433,3.5,0
20251005072947,124.482209,45.338520,4.3,0
20251005072957,124.482266,45.338620,4.2,0
20251005073007,124.482299,45.338677,2.0,0
20251005073017,124.482340,45.338753,3.1,0
20251005073027,124.482388,45.338835,3.9,0
20251005073037,124.482441,45.338928,4.5,0
20251005073047,124.482463,45.338970,3.3,0
20251005073057,124.482507,45.339048,3.8,0
20251005073107,124.482556,45.339135,3.6,0
20251005073117,124.482605,45.339225,3.7,0
20251005073127,124.482658,45.339321,4.1,0
20251005073137,124.482685,45.339370,7.8,0
20251005073147,124.482646,45.339309,0.0,0
20251005073157,124.482646,45.339309,0.0,0
20251005073207,124.482646,45.339309,0.0,0
20251005073217,124.482646,45.339309,0.0,0
20251005073227,124.482646,45.339309,0.0,0
20251005073237,124.482646,45.339310,0.0,0
20251005073247,124.482646,45.339310,0.0,0
20251005073257,124.482651,45.339327,1.5,0
20251005073307,124.482658,45.339359,0.0,0
20251005073317,124.482658,45.339359,0.0,0
20251005073327,124.482671,45.339380,2.0,0
20251005073337,124.482728,45.339404,2.3,0
20251005073347,124.482755,45.339403,2.3,0
20251005073357,124.482711,45.339449,0.1,0
20251005074013,124.482699,45.339309,3.1,0
20251005074023,124.482665,45.339234,3.1,0
20251005074033,124.482629,45.339161,3.0,0
20251005074043,124.482597,45.339097,2.6,0
20251005074053,124.482553,45.339022,3.4,0
20251005074103,124.482511,45.338946,3.1,0
20251005074113,124.482490,45.338905,3.4,0
20251005074123,124.482451,45.338829,3.1,0
20251005074133,124.482408,45.338751,3.4,0
20251005074143,124.482362,45.338670,3.9,0
20251005074153,124.482326,45.338601,3.4,0
20251005074203,124.482282,45.338520,3.4,0
20251005074213,124.482243,45.338456,2.8,0
20251005074223,124.482191,45.338377,3.1,0
20251005074233,124.482152,45.338295,3.5,0
20251005074243,124.482114,45.338215,3.5,0
20251005074253,124.482071,45.338129,3.5,0
20251005074303,124.482022,45.338041,4.0,0
20251005074313,124.481972,45.337948,3.9,0
20251005074323,124.481922,45.337854,4.1,0
20251005074333,124.481923,45.337862,8.1,0
20251005074343,124.481874,45.337800,3.7,0
20251005074353,124.481857,45.337762,1.5,0
20251005074403,124.481896,45.337857,2.5,0
20251005074413,124.481839,45.337739,2.5,0
20251005074423,124.481817,45.337684,1.6,0
20251005074433,124.481831,45.337752,4.3,0
20251005074443,124.481821,45.337775,5.8,0
20251005074453,124.481724,45.337679,8.0,0
20251005074503,124.481758,45.337568,3.4,0
20251005074513,124.481729,45.337490,3.3,0
20251005074523,124.481682,45.337404,3.6,0
20251005074533,124.481633,45.337313,3.9,0
20251005074543,124.481581,45.337219,4.2,0
20251005074553,124.481533,45.337127,3.7,0
20251005074603,124.481485,45.337036,3.8,0
20251005074613,124.481439,45.336947,3.7,0
20251005074623,124.481390,45.336856,3.9,0
20251005074633,124.481340,45.336762,3.9,0
20251005074643,124.481289,45.336671,3.7,0
20251005074653,124.481255,45.336608,5.5,0
20251005074703,124.481276,45.336742,1.3,0
20251005074713,124.481275,45.336742,0.0,0
20251005074723,124.481275,45.336742,0.0,0
20251005074733,124.481275,45.336742,0.0,0
20251005074743,124.481275,45.336742,0.0,0
20251005074753,124.481279,45.336664,4.5,0
20251005074803,124.481225,45.336558,3.4,0
20251005074813,124.481176,45.336473,3.6,0
20251005074823,124.481139,45.336413,5.8,0
20251005074833,124.481124,45.336400,4.6,0
20251005074843,124.481147,45.336357,0.0,0
20251005074853,124.481111,45.336362,3.2,0
20251005074903,124.481168,45.336409,2.3,0
20251005074913,124.481174,45.336414,0.0,0
20251005074923,124.481174,45.336414,0.0,0
20251005074933,124.481212,45.336477,3.5,0
20251005074943,124.481257,45.336555,3.3,0
20251005074953,124.481307,45.336640,3.7,0
20251005075003,124.481357,45.336727,3.5,0
20251005075013,124.481399,45.336808,3.6,0
20251005075023,124.481445,45.336893,3.8,0
20251005075033,124.481485,45.336970,3.7,0
20251005075043,124.481482,45.336962,2.6,0
20251005075053,124.481501,45.337002,3.3,0
20251005075103,124.481543,45.337082,3.5,0
20251005075113,124.481583,45.337159,3.3,0
20251005075123,124.481629,45.337243,3.6,0
20251005075133,124.481679,45.337333,4.1,0
20251005075143,124.481730,45.337425,3.8,0
20251005075153,124.481781,45.337522,4.2,0
20251005075203,124.481811,45.337576,0.0,0
20251005075213,124.481841,45.337635,3.5,0
20251005075223,124.481884,45.337721,2.7,0
20251005075233,124.481867,45.337683,4.9,0
20251005075243,124.481813,45.337586,2.8,0
20251005075253,124.481765,45.337516,9.2,0
20251005075303,124.481791,45.337624,3.3,0
20251005075313,124.481765,45.337577,5.0,0
20251005075323,124.481784,45.337639,0.9,0
20251005075333,124.481795,45.337591,6.8,0
20251005075343,124.481851,45.337708,3.9,0
20251005075353,124.481837,45.337657,6.6,0
20251005075403,124.481811,45.337642,3.0,0
20251005075413,124.481833,45.337645,7.3,0
20251005075423,124.481841,45.337797,4.1,0
20251005075433,124.481890,45.337817,4.9,0
20251005075443,124.481968,45.337895,4.1,0
20251005075453,124.482019,45.337987,3.9,0
20251005075503,124.482057,45.338057,3.7,0
20251005075513,124.482102,45.338146,4.2,0
20251005075523,124.482152,45.338251,4.2,0
20251005075533,124.482198,45.338348,3.3,0
20251005075543,124.482241,45.338426,3.5,0
20251005075553,124.482299,45.338519,3.6,0
20251005075603,124.482347,45.338606,3.4,0
20251005075613,124.482389,45.338679,3.1,0
20251005075623,124.482434,45.338757,3.8,0
20251005075633,124.482484,45.338844,3.8,0
20251005075643,124.482532,45.338933,3.7,0
20251005075653,124.482583,45.339026,4.3,0
20251005075703,124.482638,45.339125,4.2,0
20251005075713,124.482690,45.339218,3.9,0
20251005075723,124.482737,45.339306,4.0,0
20251005075733,124.482699,45.339235,1.9,0
20251005075743,124.482700,45.339236,0.0,0
20251005075753,124.482700,45.339236,0.0,0
20251005075803,124.482700,45.339236,0.0,0
20251005075813,124.482700,45.339236,0.0,0
20251005075823,124.482700,45.339236,0.0,0
20251005075833,124.482704,45.339246,2.7,0
20251005075843,124.482735,45.339306,0.0,0
20251005075853,124.482735,45.339307,0.0,0
20251005075903,124.482751,45.339321,5.6,0
20251005075913,124.482780,45.339334,3.3,0
20251005075923,124.482779,45.339330,3.3,0
20251005082034,124.482727,45.339160,3.3,0
20251005082044,124.482680,45.339079,3.3,0
20251005082054,124.482657,45.339036,0.5,0
20251005082104,124.482624,45.338981,3.1,0
20251005082114,124.482581,45.338900,3.3,0
20251005082124,124.482541,45.338829,2.6,0
20251005082134,124.482501,45.338758,3.2,0
20251005082144,124.482457,45.338683,3.2,0
20251005082154,124.482413,45.338606,3.3,0
20251005082204,124.482377,45.338540,3.9,0
20251005082214,124.482328,45.338450,3.6,0
20251005082224,124.482279,45.338372,3.8,0
20251005082234,124.482242,45.338297,3.7,0
20251005082244,124.482208,45.338218,2.8,0
20251005082254,124.482164,45.338129,3.6,0
20251005082304,124.482135,45.338070,0.3,0
20251005082314,124.482100,45.337999,3.2,0
20251005082324,124.482060,45.337926,3.0,0
20251005082334,124.482016,45.337843,3.6,0
20251005082344,124.481993,45.337794,3.2,0
20251005082354,124.481984,45.337775,7.3,0
20251005082404,124.481987,45.337826,3.4,0
20251005082414,124.481953,45.337765,1.0,0
20251005082424,124.481962,45.337783,3.7,0
20251005082434,124.481972,45.337756,5.0,0
20251005082444,124.481945,45.337696,0.0,0
20251005082454,124.481925,45.337658,3.2,0
20251005082504,124.481884,45.337584,2.9,0
20251005082514,124.481841,45.337494,3.9,0
20251005082524,124.481788,45.337399,3.8,0
20251005082534,124.481732,45.337296,4.6,0
20251005082544,124.481675,45.337189,4.3,0
20251005082554,124.481646,45.337134,5.9,0
20251005082604,124.481679,45.337187,5.1,0
20251005082614,124.481649,45.337120,2.9,0
20251005082625,124.481666,45.337187,7.6,0
20251005082635,124.481591,45.337095,3.3,0
20251005082645,124.481581,45.337024,3.2,0
20251005082655,124.481542,45.336936,4.2,0
20251005082705,124.481504,45.336860,1.6,0
20251005082715,124.481462,45.336779,3.6,0
20251005082725,124.481413,45.336688,4.3,0
20251005082735,124.481358,45.336592,3.0,0
20251005082745,124.481335,45.336547,3.8,0
20251005082755,124.481338,45.336553,5.5,0
20251005082805,124.481347,45.336676,0.5,0
20251005082815,124.481347,45.336676,0.0,0
20251005082825,124.481343,45.336675,0.0,0
20251005082835,124.481343,45.336674,0.0,0
20251005082845,124.481343,45.336673,0.0,0
20251005082855,124.481337,45.336646,3.5,0
20251005082905,124.481314,45.336534,4.7,0
20251005082915,124.481269,45.336443,3.4,0
20251005082925,124.481226,45.336367,5.2,0
20251005082935,124.481280,45.336446,5.6,0
20251005082945,124.481214,45.336305,0.8,0
20251005082955,124.481215,45.336416,2.1,0
20251005083005,124.481226,45.336422,1.3,0
20251005083015,124.481290,45.336464,0.0,0
20251005083025,124.481313,45.336498,4.3,0
20251005083035,124.481384,45.336609,5.0,0
20251005083045,124.481450,45.336721,4.5,0
20251005083055,124.481507,45.336829,4.7,0
20251005083105,124.481567,45.336945,4.7,0
20251005083115,124.481623,45.337054,4.1,0
20251005083125,124.481613,45.337038,7.4,0
20251005083135,124.481582,45.337097,5.8,0
20251005083145,124.481663,45.337157,2.4,0
20251005083155,124.481697,45.337193,2.2,0
20251005083205,124.481706,45.337217,0.1,0
20251005083215,124.481718,45.337236,3.8,0
20251005083225,124.481780,45.337346,5.1,0
20251005083235,124.481839,45.337452,5.2,0
20251005083245,124.481899,45.337574,4.5,0
20251005083255,124.481918,45.337611,2.3,0
20251005083305,124.481916,45.337608,2.7,0
20251005083315,124.481888,45.337603,4.7,0
20251005083325,124.481942,45.337660,0.0,0
20251005083335,124.481936,45.337649,4.1,0
20251005083345,124.481951,45.337691,4.3,0
20251005083355,124.482012,45.337799,4.3,0
20251005083405,124.482055,45.337883,4.0,0
20251005083415,124.482127,45.338011,5.6,0
20251005083425,124.482194,45.338144,5.2,0
20251005083435,124.482257,45.338273,5.4,0
20251005083445,124.482309,45.338388,4.4,0
20251005083455,124.482388,45.338510,5.9,0
20251005083505,124.482458,45.338633,4.9,0
20251005083515,124.482537,45.338768,6.0,0
20251005083525,124.482614,45.338912,5.9,0
20251005083535,124.482678,45.339026,7.9,0
20251005083545,124.482719,45.339099,4.5,0
20251005083555,124.482784,45.339212,5.2,0
20251005083605,124.482827,45.339293,5.3,0
20251005083615,124.482776,45.339207,0.0,0
20251005083625,124.482779,45.339206,0.0,0
20251005083635,124.482783,45.339206,0.0,0
20251005083645,124.482781,45.339207,0.0,0
20251005083655,124.482780,45.339206,0.0,0
20251005083704,124.482778,45.339204,0.0,0
20251005083714,124.482776,45.339203,0.0,0
20251005083724,124.482787,45.339337,6.4,0
20251005084211,124.482177,45.340309,11.1,0
20251005084221,124.481979,45.340570,10.9,0
20251005084231,124.481960,45.340751,6.9,0
20251005084241,124.482089,45.340929,10.2,0
20251005084251,124.482300,45.341098,8.2,0
20251005084301,124.482588,45.341167,15.2,0
20251005084311,124.482956,45.340973,13.0,0
20251005084321,124.483249,45.340848,4.7,0
20251005084331,124.483422,45.340887,5.8,0
20251005084341,124.483801,45.340943,12.3,0
20251005084351,124.484241,45.340956,12.4,0
20251005084401,124.484660,45.340889,12.0,0
20251005084411,124.485076,45.340814,12.0,0
20251005084421,124.485503,45.340825,12.5,0
20251005084431,124.485899,45.340969,13.2,0
20251005084441,124.486241,45.341140,5.8,0
20251005084451,124.486386,45.341230,11.8,0
20251005084501,124.486816,45.341489,19.0,0
20251005084511,124.487368,45.341774,20.2,0
20251005084521,124.488019,45.342091,26.7,0
20251005084531,124.488742,45.342407,26.5,0
20251005084541,124.489540,45.342743,20.3,0
20251005084551,124.490077,45.343100,25.4,0
20251005084601,124.490628,45.343495,19.0,0
20251005084611,124.491196,45.343951,27.5,0
20251005084621,124.491773,45.344479,21.1,0
20251005084631,124.491996,45.344665,11.0,0
20251005084641,124.492699,45.344993,31.3,0
20251005084651,124.493614,45.345395,28.4,0
20251005084701,124.494504,45.345782,29.5,0
20251005084711,124.495389,45.346173,30.8,0
20251005084721,124.496215,45.346533,21.4,0
20251005084731,124.496913,45.346840,19.0,0
20251005084741,124.497293,45.346812,20.4,0
20251005084751,124.497809,45.346415,19.7,0
20251005084801,124.498221,45.346053,31.6,0
20251005084811,124.498868,45.345265,34.4,0
20251005084821,124.499345,45.344694,13.9,0
20251005084831,124.499570,45.344453,22.9,0
20251005084841,124.500174,45.343811,24.0,0
20251005084851,124.500282,45.343675,0.1,0
20251005084901,124.500333,45.343620,0.9,0
20251005084911,124.500429,45.343543,16.4,0
20251005084921,124.500865,45.343085,23.3,0
20251005084931,124.501137,45.342763,8.5,0
20251005084941,124.501511,45.342725,13.2,0
20251005084951,124.501911,45.342585,18.0,0
20251005085001,124.502207,45.342403,8.5,0
20251005085011,124.502486,45.342163,21.6,0
20251005085021,124.502792,45.341727,12.2,0
20251005085031,124.503161,45.341713,19.6,0
20251005085041,124.503952,45.341946,17.9,0
20251005153234,124.504474,45.342040,0.0,0
20251005153244,124.504471,45.342047,0.0,0
20251005153254,124.504447,45.342116,4.8,0
20251005153304,124.504510,45.342231,7.7,0</textarea>
            <div class="button-group">
                <button id="drawTrackButton" disabled style="flex: 1;">绘制轨迹</button>
                <button id="showTrackPointsButton" disabled style="flex: 1;" class="btn-warning">打点</button>
                <button id="clearTrackButton" disabled style="flex: 1;">清空轨迹</button>
            </div>
            <!-- 回放控制 -->
            <div class="split-section" style="margin-top:8px;">
                <div class="title">轨迹回放</div>
                <div class="playback-actions" style="display:flex;gap:8px;margin-bottom:8px;">
                    <button id="playbackStartBtn" disabled>开始</button>
                    <button id="playbackPauseBtn" disabled>继续</button>
                    <button id="playbackStopBtn" disabled>结束</button>
                </div>
                <div class="playback-speed" style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                    <label>速度：
                        <select id="playbackSpeedSelect" disabled>
                            <option value="1" selected>1×</option>
                            <option value="2">2×</option>
                            <option value="4">4×</option>
                            <option value="8">8×</option>
                            <option value="16">16×</option>
                            <option value="32">32×</option>
                            <option value="64">64×</option>
                            <option value="128">128×</option>
                            <option value="256">256×</option>
                            <option value="512">512×</option>
                            <option value="1024">1024×</option>
                        </select>
                    </label>
                    <span id="playbackTimeLabel" style="font-size:12px;color:#666;">时间：—</span>
                </div>
                <div class="playback-time" style="display:flex;flex-direction:column;gap:4px;margin-bottom:8px;">
                    <label class="playback-time-label" style="display:flex;align-items:center;gap:8px;flex:1 1 auto;min-width:0;">
                        <span class="playback-time-text" style="white-space:nowrap;">起始时间：</span>
                        <input type="range" id="playbackTimeSlider" disabled min="0" max="0" step="1000" value="0" style="flex:1 1 auto;min-width:0;max-width:100%;vertical-align:middle;">
                    </label>
                    <span id="playbackTimeCursor" style="font-size:12px;color:#666;align-self:flex-end;">—</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let map;
    let currentPolygons = []; // 存储多边形和其标签
    let currentTracks = []; // 存储轨迹折线及相关覆盖物
    let mapLoaded = false;
    let mapLabelHandlers = []; // 存储地图事件处理器
    let labelsEnabled = false; // 标签显示开关（默认关闭）
    let isDrawing = false; // 绘制进行中防止重复点击

    window.onload = function () {
        if (typeof T === 'undefined') {
            alert("天地图API加载失败，请检查网络或密钥！");
            return;
        }
        initMap();
        bindDrawEvent();
        bindMinimizeEvent();
        bindTabs();
        bindBatchGenerator();
        bindMultiSplitter();
        bindLabelsToggle(); // 绑定标签显示开关
        bindTrackEvents();  // 绑定轨迹绘制与清空
        bindPlaybackControls(); // 绑定轨迹回放
    };

    function initMap() {
        showLoading();
        disableButtons(true);

        try {
            map = new T.Map("mapContainer", {
                zoom: 12,
                center: new T.LngLat(116.40769, 39.90403)
            });

            // 已移除测试标签
            map.enableScrollWheelZoom();

            // 添加地图类型控件
            const mapTypeCtrl = new T.Control.MapType({
                mapTypes: [TMAP_NORMAL_MAP, TMAP_SATELLITE_MAP, TMAP_TERRAIN_MAP],
                position: T_ANCHOR_TOP_LEFT
            });
            map.addControl(mapTypeCtrl);

            // 加载影像底图（卫星）
            const tk = "648f621977051d0199ff0f965d3fd322";

            // 方案1：使用默认地图类型（作为备选）
            map.setMapType(TMAP_SATELLITE_MAP);

            // 方案2：手动添加影像图层（底图 + 标注）
            const vecLayer = new T.TileLayer(`https://t0.tianditu.gov.cn/img_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=img&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`);
            const cvaLayer = new T.TileLayer(`https://t0.tianditu.gov.cn/cia_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cia&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`);

            // 添加图层并监听加载状态
            vecLayer.addEventListener("load", function () {
                console.log("影像底图加载完成");
            });

            vecLayer.addEventListener("error", function (e) {
                console.error("影像底图加载错误:", e);
                alert("影像底图加载错误，将使用默认地图类型");
            });

            map.addLayer(vecLayer);
            map.addLayer(cvaLayer);

            // 监听地图加载事件
            map.addEventListener("loaded", function () {
                console.log("地图加载完成");
                markMapLoaded();
            });
            map.addEventListener("load", function () {
                console.log("地图load事件触发");
                markMapLoaded();
            });
            map.addEventListener("tilesloaded", function () {
                console.log("地图瓦片加载完成");
                markMapLoaded();
            });
            // 监听地图加载失败事件
            map.addEventListener("error", function (e) {
                console.error("地图加载错误:", e);
                alert("地图加载错误: " + e.message);
                hideLoading();
            });

            // 监听地图移动事件，用于更新标签位置
            const moveHandler = function () {
                updateAllLabelsPosition();
            };
            map.addEventListener("move", moveHandler);
            map.addEventListener("zoom", moveHandler);

            // 存储事件处理器，用于清理
            mapLabelHandlers.push({ event: "move", handler: moveHandler });
            mapLabelHandlers.push({ event: "zoom", handler: moveHandler });

            // 超时容错
            setTimeout(() => {
                if (!mapLoaded) markMapLoaded();
            }, 8000);

        } catch (error) {
            alert("地图初始化失败：" + error.message);
            console.error(error);
            hideLoading();
        }
    }

    function markMapLoaded() {
        if (!mapLoaded) {
            mapLoaded = true;
            hideLoading();
            disableButtons(false);
            disableTrackButtons(false);
            // 仅开启速度选择，回放按钮按状态控制
            const speedSel = document.getElementById('playbackSpeedSelect');
            if (speedSel) speedSel.disabled = false;
            updatePlaybackButtonsState('idle');
        }
    }

    function showLoading() {
        const loading = document.getElementById("mapLoading");
        loading.style.display = "flex";
        loading.style.opacity = "1";
    }

    function hideLoading() {
        const loading = document.getElementById("mapLoading");
        loading.style.opacity = "0";
        setTimeout(() => loading.style.display = "none", 300);
    }

    function disableButtons(disabled) {
        document.getElementById("drawButton").disabled = disabled;
        document.getElementById("clearButton").disabled = disabled;
    }

    function disableTrackButtons(disabled) {
        const drawTrackBtn = document.getElementById("drawTrackButton");
        const showTrackPointsBtn = document.getElementById("showTrackPointsButton");
        const clearTrackBtn = document.getElementById("clearTrackButton");
        if (drawTrackBtn) drawTrackBtn.disabled = disabled;
        if (showTrackPointsBtn) showTrackPointsBtn.disabled = disabled;
        if (clearTrackBtn) clearTrackBtn.disabled = disabled;
    }
    // 回放控件的禁用/启用
    function disablePlaybackButtons(disabled) {
        ["playbackStartBtn","playbackPauseBtn","playbackStopBtn","playbackSpeedSelect","playbackTimeSlider"].forEach(id=>{
            const el = document.getElementById(id);
            if (el) el.disabled = disabled;
        });
    }

    // 回放按钮状态管理：空闲/播放/暂停
    function updatePlaybackButtonsState(state){
        try {
            const startBtn = document.getElementById('playbackStartBtn');
            const pauseBtn = document.getElementById('playbackPauseBtn');
            const stopBtn = document.getElementById('playbackStopBtn');
            if (!startBtn || !pauseBtn || !stopBtn) return;
            if (state === 'idle') {
                startBtn.disabled = false;
                pauseBtn.disabled = true;
                stopBtn.disabled = true;
                pauseBtn.textContent = '继续';
            } else if (state === 'playing') {
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
                pauseBtn.textContent = '暂停';
            } else if (state === 'paused') {
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
                pauseBtn.textContent = '继续';
            }
        } catch(e) { console.warn('更新按钮状态失败:', e); }
    }

    function bindDrawEvent() {
        document.getElementById("drawButton").addEventListener("click", function () {
            if (isDrawing) { console.log('绘制进行中，忽略重复点击'); return; }
            isDrawing = true;
            disableButtons(true);
            showLoading();
            try {
                const wktStr = document.getElementById("wktTextarea").value.trim();
                if (!wktStr) { alert("请输入WKT字符串！"); return; }
                clearOverlays();
                const geojson = parseWkt(wktStr);
    
                const polygonData = [];
                if (geojson.type === "Polygon") {
                    polygonData.push({ index: 1, coordinates: geojson.coordinates });
                } else if (geojson.type === "MultiPolygon") {
                    geojson.coordinates.forEach((polygon, index) => {
                        polygonData.push({ index: index + 1, coordinates: polygon });
                    });
                }
    
                // 重置并绘制
                polygonInfoList = [];
                polygonData.forEach(pd => processPolygon(pd.index, pd.coordinates));
    
                // 视图居中到所有已绘制轮廓
                try { fitViewportToPolygons(); } catch (e) { console.warn('视图居中失败', e); }
    
                // 在视图稳定后再创建/更新标签
                setTimeout(() => {
                    if (labelsEnabled) {
                        try {
                            createAllLabels();
                            updateAllLabelsPosition();
                        } catch (e) {
                            console.warn('创建或更新标签失败:', e);
                        }
                    }
                }, 150);
            } catch (e) {
                alert('绘制失败：' + (e && e.message ? e.message : e));
                console.error('绘制异常:', e);
            } finally {
                hideLoading();
                isDrawing = false;
                disableButtons(false);
            }
        });

        document.getElementById("clearButton").addEventListener("click", function () {
            if (isDrawing) { console.log('绘制进行中，暂不清空'); return; }
            clearOverlays();
            console.log("已清空所有轮廓");
        });
    }

    // 存储多边形数据，用于后续标签创建
    let polygonInfoList = [];

    // 处理单个多边形的绘制和面积计算
    function processPolygon(actualPolygonIndex, polygonCoords) {
        console.log('开始处理多边形', actualPolygonIndex);

        // 坐标系选择（绘制始终使用WGS84坐标）
        const coordSys = (document.getElementById('coordSysSelect') && document.getElementById('coordSysSelect').value) || 'wgs84';

        // 统一转换为WGS84用于绘制与面积计算
        function toWgs(point){
            const lng = point[0], lat = point[1];
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                return [lng, lat];
            } else if (coordSys === 'gcj02') {
                const w = gcj02ToWgs84(lng, lat);
                return [w.lng, w.lat];
            } else if (coordSys === 'bd09') {
                const gcj = bd09ToGcj02(lng, lat);
                const w = gcj02ToWgs84(gcj.lng, gcj.lat);
                return [w.lng, w.lat];
            }
            return [lng, lat];
        }
        const coordsWGS84 = polygonCoords.map(ring => ring.map(toWgs));
        let outerRingWGS = coordsWGS84[0] || [];

        // 生成用于绘制的坐标（直接使用WGS84坐标）
        const rings = coordsWGS84.map(ring => ring.map(([lng, lat]) => new T.LngLat(lng, lat)));


         // 创建半透明填充的多边形（无边框）
          const polygon = new T.Polygon(rings, {
              color: "#FFD700",
              weight: 1,
              opacity: 1,
              fillColor: "#FFFF00",
              fillOpacity: 0.35
          });
 
          // 使用WGS84坐标计算面积（更准确的面积计算）
         let areaSqm;
         let areaMu;



         try {
             // 检查Turf.js是否可用
             if (typeof turf !== 'undefined' && turf.area) {
                 // 使用Turf.js计算多边形面积
                // 构造GeoJSON格式的多边形
                const geoJsonPolygon = {
                    type: "Polygon",
                    coordinates: coordsWGS84
                };


                 // 使用Turf.js计算面积（平方米）
                 areaSqm = turf.area(geoJsonPolygon);
                 areaMu = (areaSqm / 666.6667).toFixed(4); // 转换为亩
                 console.log(`多边形${actualPolygonIndex}面积计算结果(Turf.js): ${areaSqm}平方米 = ${areaMu}亩`);
             } else {
                 // 如果Turf.js不可用，回退到之前的计算方法
                 console.warn('Turf.js不可用，使用备用计算方法');
                 // 计算带孔洞的多边形面积
                 areaSqm = 0;
                 // 计算外环面积
                 outerRingWGS = coordsWGS84[0] || [];
                 areaSqm += calculatePolygonArea(outerRingWGS);

                 // 减去内环（孔洞）面积
                 for (let i = 1; i < coordsWGS84.length; i++) {
                     const innerRingArea = calculatePolygonArea(coordsWGS84[i]);
                     areaSqm -= innerRingArea;
                 }

                  areaMu = (areaSqm / 666.6667).toFixed(4); // 使用更精确的转换系数
                  console.log(`多边形${actualPolygonIndex}面积计算结果(备用): ${areaSqm}平方米 = ${areaMu}亩`);
              }
          } catch (error) {
              console.error(`面积计算失败:`, error);
              areaSqm = 0;
              areaMu = '0.0000';
          }

          // 计算多边形的中心点和底部中心点（WGS84）
          const centerPoint = calculatePolygonCenter(outerRingWGS);
          const bottomCenterPoint = calculatePolygonBottomCenter(outerRingWGS);

          // 添加多边形到地图
          if (map) {
              map.addOverLay(polygon);
              console.log(`多边形${actualPolygonIndex}已添加到地图`);
          } else {
              console.error('地图对象不存在');
          }

          // 存储多边形信息，用于后续标签创建
          polygonInfoList.push({
              index: actualPolygonIndex,
              polygon: polygon,
              area: areaMu,
              bottomCenter: { lng: bottomCenterPoint.lng, lat: bottomCenterPoint.lat },
              ringPoints: rings
          });
      }

    // 视图居中：根据已绘制的GCJ-02点
    function fitViewportToPolygons() {
        const points = [];
        try {
            if (!map || !map.setViewport) return;
            polygonInfoList.forEach(info => {
                if (!info || !info.ringPoints) return;
                info.ringPoints.forEach(ring => {
                    ring.forEach(ll => points.push(ll));
                });
            });
            if (!points.length) return;
            map.setViewport(points);
        } catch (e) {
            try {
                const lngs = points.map(p => p.lng);
                const lats = points.map(p => p.lat);
                const center = new T.LngLat(
                    (Math.min(...lngs) + Math.max(...lngs)) / 2,
                    (Math.min(...lats) + Math.max(...lats)) / 2
                );
                if (map && map.panTo) map.panTo(center);
            } catch (e2) {
                console.warn('视图居中失败:', e2);
            }
        }
    }

    // 统一创建所有多边形的标签
    function createAllLabels() {
        const mapContainer = document.getElementById('mapContainer');
        if (!mapContainer || !map) return;

        polygonInfoList.forEach(info => {
            if (!info) return;
            // 防止重复创建
            if (info.labelRef) return;
            // 创建标签元素
            const labelDiv = document.createElement('div');
            labelDiv.className = 'area-label';
            labelDiv.innerHTML = `多边形${info.index}：${info.area}亩`;

            // 添加到地图容器并根据屏幕边界定位到轮廓下方
            mapContainer.appendChild(labelDiv);
            positionLabelForPolygon(labelDiv, info);

            // 记录引用，避免重复创建
            info.labelRef = labelDiv;

            // 存储到 currentPolygons 以复用现有定位/清理逻辑
            const labelObj = {
                domElement: labelDiv,
                isDomLabel: true,
                polygonInfo: info
            };
            currentPolygons.push({ polygon: info.polygon, label: labelObj });
        });

        // 不清空 polygonInfoList，便于开关随时创建/隐藏标签
    }

    // 根据多边形屏幕边界定位标签，保证始终在轮廓下方
    function positionLabelForPolygon(labelDiv, info) {
        if (!map || !info || !info.ringPoints) return;
        const points = [];
        info.ringPoints.forEach(ring => {
            ring.forEach(ll => {
                const p = map.lngLatToContainerPoint(ll);
                points.push(p);
            });
        });
        if (!points.length) return;
        const minX = Math.min(...points.map(p => p.x));
        const maxX = Math.max(...points.map(p => p.x));
        const maxY = Math.max(...points.map(p => p.y));
        const container = document.getElementById('mapContainer');
        const labelWidth = labelDiv.offsetWidth;
        const labelHeight = labelDiv.offsetHeight;
        const targetLeft = Math.round((minX + maxX) / 2 - labelWidth / 2);
        const targetTop = Math.round(maxY + 6);
        const clampedLeft = Math.max(0, Math.min(targetLeft, container.clientWidth - labelWidth));
        const clampedTop = Math.max(0, Math.min(targetTop, container.clientHeight - labelHeight));
        labelDiv.style.left = clampedLeft + 'px';
        labelDiv.style.top = clampedTop + 'px';
    }

    // 更新所有标签位置（地图move/zoom时调用）
    function updateAllLabelsPosition() {
        try {
            if (!map) return;
            const container = document.getElementById('mapContainer');
            if (!container) return;
            currentPolygons.forEach(item => {
                if (!item || !item.label) return;
                const labelObj = item.label;
                if (labelObj.isDomLabel && labelObj.domElement && labelObj.polygonInfo) {
                    // 确保标签在容器中
                    if (!labelObj.domElement.parentNode) {
                        container.appendChild(labelObj.domElement);
                    }
                    positionLabelForPolygon(labelObj.domElement, labelObj.polygonInfo);
                }
            });
        } catch (e) {
            console.warn('更新标签位置时出错:', e);
        }
    }
    // 确保在全局可用（处理第三方库事件回调作用域差异）
    window.updateAllLabelsPosition = updateAllLabelsPosition;

    // 绑定“显示亩数标签”开关（默认隐藏）
    function bindLabelsToggle() {
        const cb = document.getElementById('toggleLabelsCheckbox');
        const container = document.getElementById('mapContainer');
        if (!cb || !container) return;
        // 默认隐藏标签
        container.classList.add('labels-hidden');
        cb.addEventListener('change', () => {
            labelsEnabled = cb.checked;
            if (labelsEnabled) {
                container.classList.remove('labels-hidden');
                const hasAnyLabel = currentPolygons.some(item => item && item.label && item.label.domElement);
                if (!hasAnyLabel) {
                    try { createAllLabels(); } catch (e) { console.warn('创建标签失败:', e); }
                }
                updateAllLabelsPosition();
            } else {
                container.classList.add('labels-hidden');
            }
        });
    }

    /**
     * 计算多边形中心点（比底部中心更适合显示标签）
     */
    function calculatePolygonCenter(outerRing) {
        let sumLng = 0, sumLat = 0;
        const len = outerRing.length;

        for (let i = 0; i < len; i++) {
            sumLng += outerRing[i][0];
            sumLat += outerRing[i][1];
        }

        return {
            lng: sumLng / len,
            lat: sumLat / len
        };
    }

    /**
     * 计算多边形面积（球面多边形面积计算）
     * 使用更准确的球面坐标面积计算方法，确保面积与视觉大小一致
     */
    function calculatePolygonArea(coordinates) {
        // 地球半径（米）- 使用更精确的值
        const R = 6371000.8;
        const n = coordinates.length;

        // 将所有坐标转换为弧度
        const coordsRad = coordinates.map(point => [
            point[0] * Math.PI / 180,
            point[1] * Math.PI / 180
        ]);

        let areaRad = 0;

        // 使用更准确的球面多边形面积公式（Girard定理）
        for (let i = 0; i < n; i++) {
            const j = (i + 1) % n;
            const lon1 = coordsRad[i][0];
            const lat1 = coordsRad[i][1];
            const lon2 = coordsRad[j][0];
            const lat2 = coordsRad[j][1];

            // 计算球面多边形面积增量
            const dlon = lon2 - lon1;
            const sinLat1 = Math.sin(lat1);
            const sinLat2 = Math.sin(lat2);
            const cosLat1 = Math.cos(lat1);
            const cosLat2 = Math.cos(lat2);

            // 使用更精确的公式
            areaRad += dlon * (sinLat1 * cosLat2 * Math.cos(dlon / 2) + sinLat2 * cosLat1);
        }

        // 计算总面积（平方米）
        const areaSqm = Math.abs(areaRad) * R * R * 0.5;

        return areaSqm;
    }

    /**
     * 清空所有多边形和标签（同时处理 polygonInfoList 与 currentPolygons）
     */
    function clearOverlays() {
        try {
            // 先移除 polygonInfoList 中记录的多边形与其DOM标签
            polygonInfoList.forEach(info => {
                if (info && info.polygon && map && map.removeOverLay) {
                    try { map.removeOverLay(info.polygon); } catch (e) { console.warn('移除多边形失败:', e); }
                }
                if (info && info.labelRef && info.labelRef.parentNode) {
                    try { info.labelRef.parentNode.removeChild(info.labelRef); } catch (e) { console.warn('移除DOM标签失败:', e); }
                    info.labelRef = null;
                }
            });

            // 再处理 currentPolygons（兼容旧路径与标签对象）
            currentPolygons.forEach(item => {
                if (item.polygon && map && map.removeOverLay) {
                    try { map.removeOverLay(item.polygon); } catch (e) { console.warn('移除多边形失败:', e); }
                }
                if (item.label) {
                    if (item.label.domElement && item.label.domElement.parentNode) {
                        try { item.label.domElement.parentNode.removeChild(item.label.domElement); } catch (e) { console.warn('移除DOM标签失败:', e); }
                    } else if (map && map.removeOverLay && !item.label.isDomLabel) {
                        try { map.removeOverLay(item.label); } catch (e) { console.warn('移除地图覆盖物标签失败:', e); }
                    }
                }
            });

            // 清空记录数组
            currentPolygons = [];
            polygonInfoList = [];

            console.log('已清空所有多边形和标签（保留事件监听器）');
        } catch (error) {
            console.error('清空覆盖物时出错:', error);
        }
    }

    // 其他辅助函数（保持不变）
    function bindMinimizeEvent() {
        const container = document.querySelector(".wkt-input-container");
        const btn = document.getElementById("minimizeBtn");
        const minIcon = btn?.querySelector(".min-icon");
        const restoreIcon = btn?.querySelector(".restore-icon");

        btn?.addEventListener("click", () => {
            const minimized = container.classList.toggle("minimized");
            if (minIcon && restoreIcon) {
                if (minimized) {
                    minIcon.style.display = "none";
                    restoreIcon.style.display = "";
                } else {
                    minIcon.style.display = "";
                    restoreIcon.style.display = "none";
                }
            }
        });
    }

    // 在脚本内部补充：页签切换（3个页签）
     function bindTabs() {
         const tabs = [
             { btn: document.getElementById('tabDrawBtn'), pane: document.getElementById('tabDraw'), key: 'draw' },
             { btn: document.getElementById('tabTrackBtn'), pane: document.getElementById('tabTrack'), key: 'track' },
             { btn: document.getElementById('tabSplitBtn'), pane: document.getElementById('tabSplit'), key: 'split' },
             { btn: document.getElementById('tabBatchBtn'), pane: document.getElementById('tabBatch'), key: 'batch' },
         ];
         if (tabs.some(t => !t.btn || !t.pane)) return;
         function activate(key) {
             tabs.forEach(t => {
                 const active = t.key === key;
                 t.btn.classList.toggle('active', active);
                 t.pane.classList.toggle('active', active);
             });
         }
         tabs.forEach(t => t.btn.addEventListener('click', () => activate(t.key)));
         activate('draw');
     }
    function updateParserStatus() {
        const el = document.getElementById('parserStatus');
        if (!el) return;
        const ok = (typeof Terraformer !== 'undefined' && Terraformer.WKT && typeof Terraformer.WKT.parse === 'function');
        if (ok) {
            el.textContent = 'Terraformer WKT Parser';
            el.style.color = '#2f8f2f';
        } else {
            el.textContent = '本地回退解析（仅支持POLYGON/MULTIPOLYGON）';
            el.style.color = '#c77d1e';
        }
    }
     function parseWkt(wkt) {
         wkt = wkt.trim();
         // 优先使用成熟库（Terraformer WKT Parser）
         if (typeof Terraformer !== 'undefined' && Terraformer.WKT && Terraformer.WKT.parse) {
             try {
                 return Terraformer.WKT.parse(wkt);
             } catch (e) {
                 console.warn('Terraformer解析失败，尝试本地回退解析:', e);
             }
         } else {
             // 不再提示“未加载”，由状态栏展示回退信息
         }
         // 回退解析：仅支持 POLYGON / MULTIPOLYGON
         const typeMatch = wkt.match(/^\s*(POLYGON|MULTIPOLYGON)\s*\(/i);
         if (!typeMatch) throw new Error('仅支持POLYGON/MULTIPOLYGON');
         const type = typeMatch[1].toUpperCase();
         const inner = wkt.substring(wkt.indexOf('('));
         if (type === 'POLYGON') {
             const coords = parsePolygonCoords(inner.replace(/^\(/, '').replace(/\)$/, ''));
             return { type: 'Polygon', coordinates: coords };
         } else {
             const trimmed = inner.replace(/^\(\(/, '').replace(/\)\)$/, '');
             const coords = parseMultiPolygonCoords(trimmed);
             return { type: 'MultiPolygon', coordinates: coords };
         }
     }

     function bindMultiSplitter() {
         const input = document.getElementById('multiInput');
         const output = document.getElementById('polyOutput');
         const splitBtn = document.getElementById('splitMultiBtn');
         const copyBtn = document.getElementById('copyPolysBtn');
         if (!input || !output || !splitBtn || !copyBtn) return;

         // 本地WKT序列化辅助
         function ringToText(ring) {
             if (!ring || !ring.length) return '()';
             const first = ring[0];
             const last = ring[ring.length - 1];
             const closed = (first[0] === last[0] && first[1] === last[1]) ? ring : ring.concat([[first[0], first[1]]]);
             return '(' + closed.map(pt => pt[0] + ' ' + pt[1]).join(', ') + ')';
         }
         function toWktPolygonCoords(coords) {
             return 'POLYGON(' + coords.map(ringToText).join(', ') + ')';
         }
         function toWktMulti(coords) {
             return 'MULTIPOLYGON(' + coords.map(poly => '(' + poly.map(ringToText).join(', ') + ')').join(', ') + ')';
         }

         function polygonsFromMulti(text) {
             const geo = parseWkt(text.trim());
             if (geo.type !== 'MultiPolygon') throw new Error('请输入有效的 MULTIPOLYGON WKT');
             const polys = geo.coordinates.map(rings => toWktPolygonCoords(rings));
             return polys;
         }
         splitBtn.addEventListener('click', () => {
             try {
                 const list = polygonsFromMulti(input.value.trim());
                 output.value = list.join('\n');
             } catch (e) {
                 alert('分割失败：' + e.message);
             }
         });
         copyBtn.addEventListener('click', async () => {
             const val = output.value.trim();
             if (!val) { alert('没有可复制的结果'); return; }
             try { await navigator.clipboard.writeText(val); alert('已复制到剪贴板'); } catch (e) { console.warn('复制失败', e); }
         });
     }

     function bindBatchGenerator() {
         const batchInput = document.getElementById('batchInput');
         const output = document.getElementById('multiOutput');
         const genBtn = document.getElementById('generateMultiBtn');
         const copyBtn = document.getElementById('copyMultiBtn');

         // 本地WKT序列化辅助（与分割器保持一致）
         function ringToText(ring) {
             if (!ring || !ring.length) return '()';
             const first = ring[0];
             const last = ring[ring.length - 1];
             const closed = (first[0] === last[0] && first[1] === last[1]) ? ring : ring.concat([[first[0], first[1]]]);
             return '(' + closed.map(pt => pt[0] + ' ' + pt[1]).join(', ') + ')';
         }
         function toWktMulti(coords) {
             return 'MULTIPOLYGON(' + coords.map(poly => '(' + poly.map(ringToText).join(', ') + ')').join(', ') + ')';
         }

         genBtn.addEventListener('click', () => {
             try {
                 const lines = batchInput.value.trim().split(/\n|;/).map(s => s.trim()).filter(Boolean);
                 if (lines.length === 0) throw new Error('请按每行或分号输入至少一个POLYGON');
                 const polygons = lines.map((line, idx) => {
                     const g = parseWkt(line);
                     if (g.type !== 'Polygon') throw new Error(`第${idx + 1}行不是有效的POLYGON WKT`);
                     return g;
                 });
                 const multiGeo = { type: 'MultiPolygon', coordinates: polygons.map(p => p.coordinates) };
                 output.value = toWktMulti(multiGeo.coordinates);
             } catch (e) {
                 alert('生成失败：' + e.message);
             }
         });

         copyBtn.addEventListener('click', async () => {
             const val = output.value.trim();
             if (!val) { alert('没有可复制的结果'); return; }
             try { await navigator.clipboard.writeText(val); alert('已复制到剪贴板'); } catch (e) { console.warn('复制失败', e); }
         });

     }

     function setExampleWkt() {
         const exampleWkt = "MULTIPOLYGON(" +
             "(" +
             "(116.35 39.93, 116.39 39.93, 116.39 39.90, 116.35 39.90, 116.35 39.93)," + // 外环
             "(116.36 39.92, 116.38 39.92, 116.38 39.91, 116.36 39.91, 116.36 39.92)" +  // 内环
             ")," +
             "(" +
             "(116.40 39.95, 116.43 39.97, 116.46 39.96, 116.49 39.98, 116.52 39.95, 116.55 39.93, 116.58 39.94, 116.61 39.92, 116.64 39.95, 116.40 39.95)" +
             ")" +
             ")";
         document.getElementById("wktTextarea").value = exampleWkt;
     }

     function parsePolygonCoords(coordStr) {
         const ringStrs = coordStr.split(/\)\s*,\s*\(/).map(s => s.replace(/[()]/g, '').trim());
         const rings = [];
         ringStrs.forEach(ringStr => {
             const pts = ringStr.split(/,\s*/).map(pointStr => {
                 const [lng, lat] = pointStr.split(/\s+/).map(Number);
                 if (isNaN(lng) || isNaN(lat)) throw new Error("坐标格式错误：" + pointStr);
                 return [lng, lat];
             });
             // 自动拆分：如果一个ring中包含多次回到起点（闭合），则拆分为多个环
             // 兼容用户将外环与内环错误地写在同一对括号中的情况
             let start = 0;
             while (start < pts.length) {
                 const startPt = pts[start];
                 let closeIdx = -1;
                 for (let i = start + 1; i < pts.length; i++) {
                     if (pts[i][0] === startPt[0] && pts[i][1] === startPt[1]) {
                         closeIdx = i;
                         break;
                     }
                 }
                 if (closeIdx === -1) {
                     // 未找到闭合：将剩余点视为一个环，并强制闭合
                     const ring = pts.slice(start);
                     if (ring.length && (ring[0][0] !== ring[ring.length - 1][0] || ring[0][1] !== ring[ring.length - 1][1])) {
                         ring.push([ring[0][0], ring[0][1]]);
                     }
                     rings.push(ring);
                     break;
                 } else {
                     const ring = pts.slice(start, closeIdx + 1);
                     rings.push(ring);
                     start = closeIdx + 1;
                 }
             }
         });
         return rings;
     }

     function parseMultiPolygonCoords(coordStr) {
         const polygonStrs = coordStr.split(/\)\s*\)\s*,\s*\(\s*\(/).map(s => s.replace(/[()]/g, '').trim());
         return polygonStrs.map(polygonStr => parsePolygonCoords(polygonStr));
     }

     function wgs84ToGcj02(lng, lat) {
         const x_PI = 3.14159265358979324 * 3000.0 / 180.0;
         const PI = 3.1415926535897932384626;
         const a = 6378245.0;
         const ee = 0.00669342162296594323;

         if (outOfChina(lng, lat)) return { lng, lat };

         let dlat = transformLat(lng - 105.0, lat - 35.0);
         let dlng = transformLng(lng - 105.0, lat - 35.0);
         const radlat = lat / 180.0 * PI;
         let magic = Math.sin(radlat);
         magic = 1 - ee * magic * magic;
         const sqrtmagic = Math.sqrt(magic);
         dlat = (dlat * 180.0) / ((a * (1 - ee)) / (magic * sqrtmagic) * PI);
         dlng = (dlng * 180.0) / (a / sqrtmagic * Math.cos(radlat) * PI);

         return { lng: lng + dlng, lat: lat + dlat };

         function outOfChina(lng, lat) {
             return (lng < 72.004 || lng > 137.8347) || (lat < 0.8293 || lat > 55.8271);
         }

         function transformLat(x, y) {
             let ret = -100.0 + 2.0 * x + 3.0 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * Math.sqrt(Math.abs(x));
             ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
             ret += (20.0 * Math.sin(y * PI) + 40.0 * Math.sin(y / 3.0 * PI)) * 2.0 / 3.0;
             ret += (160.0 * Math.sin(y / 12.0 * PI) + 320 * Math.sin(y * PI / 30.0)) * 2.0 / 3.0;
             return ret;
         }

         function transformLng(x, y) {
             let ret = 300.0 + x + 2.0 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * Math.sqrt(Math.abs(x));
             ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
             ret += (20.0 * Math.sin(x * PI) + 40.0 * Math.sin(x / 3.0 * PI)) * 2.0 / 3.0;
             ret += (150.0 * Math.sin(x / 12.0 * PI) + 300.0 * Math.sin(x / 30.0 * PI)) * 2.0 / 3.0;
             return ret;
         }
     }

     function gcj02ToWgs84(lng, lat) {
         const g = wgs84ToGcj02(lng, lat);
         return { lng: lng * 2 - g.lng, lat: lat * 2 - g.lat };
     }

     function bd09ToGcj02(bdLng, bdLat) {
         const x_PI = 3.14159265358979324 * 3000.0 / 180.0;
         const x = bdLng - 0.0065;
         const y = bdLat - 0.006;
         const z = Math.sqrt(x * x + y * y) - 0.00002 * Math.sin(y * x_PI);
         const theta = Math.atan2(y, x) - 0.000003 * Math.cos(x * x_PI);
         const ggLng = z * Math.cos(theta);
         const ggLat = z * Math.sin(theta);
         return { lng: ggLng, lat: ggLat };
     }

     function calculatePolygonBottomCenter(outerRing) {
         let minLat = Infinity;
         let bottomPoints = [];
         outerRing.forEach(point => {
             const lat = point[1];
             if (lat < minLat) {
                 minLat = lat;
                 bottomPoints = [point];
             } else if (lat === minLat) {
                 bottomPoints.push(point);
             }
         });

         const sumLng = bottomPoints.reduce((sum, point) => sum + point[0], 0);
         const centerLng = sumLng / bottomPoints.length;

         return { lng: centerLng, lat: minLat };
     }

     function fitBounds(geojson) {
         try {
             const allPoints = [];
             function collectPoints(coords) {
                 if (typeof coords[0] === 'number') {
                     allPoints.push(coords);
                 } else {
                     coords.forEach(coord => collectPoints(coord));
                 }
             }
             collectPoints(geojson.coordinates);

             if (allPoints.length === 0) return;

             const lats = allPoints.map(p => p[1]);
             const lngs = allPoints.map(p => p[0]);
             const minLng = Math.min(...lngs);
             const maxLng = Math.max(...lngs);
             const minLat = Math.min(...lats);
             const maxLat = Math.max(...lats);

             const sw = wgs84ToGcj02(minLng, minLat);
             const ne = wgs84ToGcj02(maxLng, maxLat);

             // 修复setViewport方法的使用，确保参数格式正确
             if (map && map.setViewport) {
                 map.setViewport([
                     new T.LngLat(sw.lng, sw.lat),
                     new T.LngLat(ne.lng, ne.lat)
                 ], { padding: [50, 50] });
             } else {
                 console.warn('地图对象或setViewport方法不可用');
             }
         } catch (error) {
             console.error('调整视图范围时出错:', error);
         }
     }
// 轨迹绘制与解析
    function bindTrackEvents() {
        const drawBtn = document.getElementById('drawTrackButton');
        const showPointsBtn = document.getElementById('showTrackPointsButton');
        const clearBtn = document.getElementById('clearTrackButton');
        const ta = document.getElementById('trackTextarea');
        if (!drawBtn || !showPointsBtn || !clearBtn || !ta) return;

        drawBtn.addEventListener('click', function(){
            try {
                const text = ta.value.trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const points = parseTrackText(text);
                if (points.length < 2) { alert('有效轨迹点不足，至少需要两点'); return; }
                drawTrackFromPoints(points);
                fitViewportToTrack(points);
            } catch (e) {
                alert('绘制轨迹失败：' + (e && e.message ? e.message : e));
                console.error('绘制轨迹异常:', e);
            }
        });

        showPointsBtn.addEventListener('click', function(){
            try {
                const text = ta.value.trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const points = parseTrackText(text);
                if (points.length === 0) { alert('未找到有效轨迹点'); return; }
                showTrackPoints(points);
                fitViewportToTrack(points);
            } catch (e) {
                alert('显示轨迹点失败：' + (e && e.message ? e.message : e));
                console.error('显示轨迹点异常:', e);
            }
        });

        clearBtn.addEventListener('click', function(){
            clearTrackOverlays();
            console.log('已清空轨迹');
        });
    }

    function showTrackPoints(points) {
        // 先移除旧轨迹（不影响轮廓）
        clearTrackOverlays(false);
        
        if (!map || !points || points.length === 0) {
            console.log('无轨迹点可显示');
            return;
        }
        
        console.log(`准备显示${points.length}个轨迹点`);
        
        // 使用批量处理和更小的图标来提高性能
        // 创建一个更小的红点SVG图标
        const smallRedDotIcon = new T.Icon({
            iconUrl: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1" height="1"><circle cx="0.5" cy="0.5" r="0.3" fill="%23FF0000"/></svg>',
            iconSize: new T.Point(1, 1),
            iconAnchor: new T.Point(0.5, 0.5)
        });
        
        // 优化批量添加点的速度
        const batchSize = 2000; // 增加每批处理的点数
        const concurrentBatches = 4; // 并发批次数量
        
        // 预创建点击事件处理函数，避免重复创建
        function createClickHandler(point, index) {
            return function() {
                const infoWindow = new T.InfoWindow({
                    content: `点${index + 1}<br/>经度: ${point.lng.toFixed(6)}<br/>纬度: ${point.lat.toFixed(6)}`,
                    offset: new T.Point(0, -20)
                });
                infoWindow.open(map, point);
            };
        }
        
        // 使用setTimeout实现更高效的批量添加，避免阻塞UI
        let currentIndex = 0;
        
        function addBatch() {
            if (currentIndex >= points.length) {
                console.log(`已显示${points.length}个轨迹点`);
                return;
            }
            
            // 添加当前批次的点
            const endIndex = Math.min(currentIndex + batchSize, points.length);
            const markersToAdd = [];
            
            // 先创建所有标记
            for (let i = currentIndex; i < endIndex; i++) {
                const point = points[i];
                const index = i;
                
                const marker = new T.Marker(point, {
                    icon: smallRedDotIcon
                });
                
                // 添加点击事件
                marker.addEventListener('click', createClickHandler(point, index));
                
                markersToAdd.push(marker);
            }
            
            // 批量添加到地图和数组
            markersToAdd.forEach(marker => {
                map.addOverLay(marker);
                currentTracks.push(marker);
            });
            
            currentIndex = endIndex;
            
            // 使用setTimeout而不是requestAnimationFrame，减少对渲染周期的依赖
            // 设置为0，将任务放入微任务队列，但允许UI有短暂的呼吸空间
            setTimeout(addBatch, 0);
        }
        
        // 启动批量添加
        addBatch();
    }
    
    // 恢复原始的clearTrackOverlays函数
    function clearTrackOverlays(resetArray = true){        
        try {
            currentTracks.forEach(pl => {
                if (pl && map && map.removeOverLay) {
                    try { map.removeOverLay(pl); } catch (e) { console.warn('移除轨迹失败:', e); }
                }
            });
            if (resetArray) currentTracks = [];
        } catch (e) {
            console.warn('清空轨迹时出错:', e);
        }
    }

    function parseTrackText(text){
        // 选择输入坐标系（优先使用轨迹页签专属选择器，若未设置则回退到绘制页签选择器）
        const coordSysEl = document.getElementById('trackCoordSysSelect') || document.getElementById('coordSysSelect');
        const coordSys = (coordSysEl && coordSysEl.value) || 'wgs84';
        const isHash = text.indexOf('#') !== -1;
        const items = isHash ? text.split('#') : text.split(/\r?\n/);
        const pts = [];
        for (let i=0;i<items.length;i++){
            const raw = items[i];
            if (!raw) continue;
            const line = raw.trim();
            if (!line) continue;
            const parts = line.split(',');
            if (parts.length < 3) continue;
            let lng = parseFloat((parts[isHash ? 0 : 1] || '').trim());
            let lat = parseFloat((parts[isHash ? 1 : 2] || '').trim());
            // 初步过滤：数值合法性与正常范围
            if (!isFinite(lng) || !isFinite(lat)) continue;
            if (lng === 0 || lat === 0) continue; // 丢弃0.0异常点
            if (lng < -180 || lng > 180 || lat < -90 || lat > 90) continue; // 超出经纬度范围丢弃

            // 将输入坐标转换为WGS84
            let w;
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                w = { lng, lat };
            } else if (coordSys === 'gcj02') {
                w = gcj02ToWgs84(lng, lat);
            } else if (coordSys === 'bd09') {
                const g = bd09ToGcj02(lng, lat);
                w = gcj02ToWgs84(g.lng, g.lat);
            } else {
                w = { lng, lat };
            }
            // 转换结果兜底检查
            if (!isFinite(w.lng) || !isFinite(w.lat)) continue;
            if (w.lng < -180 || w.lng > 180 || w.lat < -90 || w.lat > 90) continue;

            // 使用WGS84坐标绘制到地图
            pts.push(new T.LngLat(w.lng, w.lat));
        }
        return pts;
    }

    function drawTrackFromPoints(points){
        // 先移除旧轨迹（不影响轮廓）
        clearTrackOverlays(false);
        const polyline = new T.Polyline(points, {
            color: '#FF3B30',
            weight: 2.5,
            opacity: 0.9
        });
        if (map) {
            map.addOverLay(polyline);
        }
        currentTracks.push(polyline);
    }

    function clearTrackOverlays(resetArray = true){
        try {
            currentTracks.forEach(pl => {
                if (pl && map && map.removeOverLay) {
                    try { map.removeOverLay(pl); } catch (e) { console.warn('移除轨迹失败:', e); }
                }
            });
            if (resetArray) currentTracks = [];
        } catch (e) {
            console.warn('清空轨迹时出错:', e);
        }
    }


    function fitViewportToTrack(points){
        try {
            if (!map || !map.setViewport || !points || !points.length) return;
            map.setViewport(points);
        } catch (e) {
            console.warn('轨迹视图居中失败:', e);
        }
    }

    // ========= 轨迹回放功能 =========
    let playbackState = { points: [], idx: 0, speed: 1, timer: null, running: false, marker: null, line: null, path: [] };

    function bindPlaybackControls(){
        const startBtn = document.getElementById('playbackStartBtn');
        const pauseBtn = document.getElementById('playbackPauseBtn');
        const stopBtn = document.getElementById('playbackStopBtn');
        const speedSel = document.getElementById('playbackSpeedSelect');
        const timeSlider = document.getElementById('playbackTimeSlider');
        const timeCursor = document.getElementById('playbackTimeCursor');
        const ta = document.getElementById('trackTextarea');
        if (!startBtn || !pauseBtn || !stopBtn || !speedSel) return;

        // 初始按钮状态
        updatePlaybackButtonsState('idle');

        startBtn.addEventListener('click', function(){
            try {
                const text = (ta && ta.value || '').trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const pts = parseTrackTextWithTime(text);
                if (pts.length < 2) { alert('有效轨迹点不足，至少需要两点'); return; }
                startPlayback(pts);
                // 状态在startPlayback中已设置为playing
            } catch (e) {
                alert('开始回放失败：' + (e && e.message ? e.message : e));
                console.error('开始回放异常:', e);
            }
        });

        pauseBtn.addEventListener('click', function(){
            if (!playbackState.running) {
                // 继续
                playbackState.running = true;
                scheduleNext();
                updatePlaybackButtonsState('playing');
            } else {
                // 暂停
                if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
                playbackState.running = false;
                updatePlaybackButtonsState('paused');
            }
        });

        stopBtn.addEventListener('click', function(){ 
            stopPlayback(); 
            updatePlaybackButtonsState('idle');
        });

        speedSel.addEventListener('change', function(){
            const v = parseFloat(speedSel.value);
            playbackState.speed = (isFinite(v) && v > 0) ? v : 1;
        });

        if (timeSlider) {
            timeSlider.addEventListener('input', function(){
                const ms = parseInt(timeSlider.value, 10);
                const txt = formatTimeForLabel(ms);
                if (timeCursor) timeCursor.textContent = txt;
            });
            timeSlider.addEventListener('change', function(){
                jumpToSliderTime();
            });
        }
    }

    function parseTrackTextWithTime(text){
        const coordSysEl = document.getElementById('trackCoordSysSelect') || document.getElementById('coordSysSelect');
        const coordSys = (coordSysEl && coordSysEl.value) || 'wgs84';
        const isHash = text.indexOf('#') !== -1;
        const items = isHash ? text.split('#') : text.split(/\r?\n/);
        const out = [];
        for (let i=0;i<items.length;i++){
            const raw = items[i];
            if (!raw) continue;
            const line = raw.trim();
            if (!line) continue;
            const parts = line.split(',');
            if (parts.length < 3) continue;
            const tsRaw = (parts[isHash ? 2 : 0] || '').trim();
            const ts = (tsRaw || '').replace(/\D/g,'');
            let lng = parseFloat((parts[isHash ? 0 : 1] || '').trim());
            let lat = parseFloat((parts[isHash ? 1 : 2] || '').trim());
            if (!isFinite(lng) || !isFinite(lat)) continue;
            if (lng === 0 || lat === 0) continue;
            if (lng < -180 || lng > 180 || lat < -90 || lat > 90) continue;
            const t = parseTimestamp(ts);
            if (!t) continue;
            let w;
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                w = { lng, lat };
            } else if (coordSys === 'gcj02') {
                w = gcj02ToWgs84(lng, lat);
            } else if (coordSys === 'bd09') {
                const g = bd09ToGcj02(lng, lat);
                w = gcj02ToWgs84(g.lng, g.lat);
            } else { w = { lng, lat }; }
            if (!isFinite(w.lng) || !isFinite(w.lat)) continue;
            if (w.lng < -180 || w.lng > 180 || w.lat < -90 || w.lat > 90) continue;
            out.push({ ll: new T.LngLat(w.lng, w.lat), time: t, ts });
        }
        out.sort((a,b)=>a.time - b.time);
        return out;
    }

    function parseTimestamp(ts){
        const tstr = (ts || '').replace(/\D/g,'');
        const m = tstr && tstr.match(/^\d{14}$/);
        if (!m) return null;
        const y = parseInt(tstr.slice(0,4),10);
        const M = parseInt(tstr.slice(4,6),10) - 1;
        const d = parseInt(tstr.slice(6,8),10);
        const h = parseInt(tstr.slice(8,10),10);
        const m2 = parseInt(tstr.slice(10,12),10);
        const s = parseInt(tstr.slice(12,14),10);
        const dt = new Date(y,M,d,h,m2,s);
        return isNaN(dt.getTime()) ? null : dt;
    }

    function startPlayback(points){
        console.log('[Playback] startPlayback: 点数=', points && points.length);
        stopPlayback();
        playbackState.points = points;
        playbackState.idx = 0;
        playbackState.speed = playbackState.speed || 1;
        playbackState.running = true;
        // 配置时间滑动条，并尊重现有滑块位置作为起始
        configureTimeSlider(points);
        // 启用滑块
        const slider = document.getElementById('playbackTimeSlider');
        if (slider) slider.disabled = false;
        let initIdx = 0;
        if (slider && slider.min && slider.max) {
            const ms = parseInt(slider.value, 10);
            if (isFinite(ms)) initIdx = findIndexByTime(points, ms);
        }
        playbackState.idx = initIdx;
        const first = points[initIdx];
        console.log('[Playback] 首点:', first && first.ts, first && first.ll, 'initIdx=', initIdx);
        playbackState.path = points.slice(0, initIdx+1).map(p=>p.ll);
        playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 3, opacity: 0.9 });
        if (map) {
            map.addOverLay(playbackState.line);
        }
        currentTracks.push(playbackState.line);
        // 创建并定位DOM标记以保证可见移动
        ensurePlaybackDom(first.ll);
        updatePlaybackDom(first.ll);
        updatePlaybackTimeLabel(first.ts);
        try { fitViewportToTrack(points.map(p=>p.ll)); } catch(e){}
        // 更新按钮状态
        updatePlaybackButtonsState('playing');
        scheduleNext();
    }

    function scheduleNext(){
        if (!playbackState.running) return;
        if (!playbackState.points || playbackState.idx >= playbackState.points.length - 1) {
            playbackState.running = false;
            console.log('[Playback] 回放结束：idx=', playbackState.idx, '点数=', playbackState.points ? playbackState.points.length : 0);
            updatePlaybackButtonsState('idle'); // 播放结束后按钮回到初始状态：开始可点，继续/结束灰化
            return;
        }
        const next = playbackState.points[playbackState.idx+1];
        const speed = playbackState.speed || 1;
        const delay = Math.max(4, Math.round(1000 / speed)); // 1x=1000ms/点，2x=500ms/点...
        console.log('[Playback] scheduleNext: idx=', playbackState.idx, '->', playbackState.idx+1, 'delay=', delay, 'speed=', speed);
        playbackState.timer = setTimeout(()=>{
            playbackState.idx++;
            const nextLL = next.ll;
            console.log('[Playback] 下一点:', next && next.ts, nextLL);
            try {
                // 维护路径数组
                playbackState.path = playbackState.path || [];
                playbackState.path.push(nextLL);
                console.log('[Playback] 路径长度=', playbackState.path.length);
                // 使用DOM标记进行移动（容器/图层坐标）
                if (!playbackDom.el) console.log('[Playback] DOM标记不存在，将尝试创建');
                updatePlaybackDom(nextLL);
                // 折线更新：优先setLngLats，兜底重建
                if (playbackState.line && typeof playbackState.line.setLngLats === 'function') {
                    try { playbackState.line.setLngLats(playbackState.path); }
                    catch(e){
                        console.warn('[Playback] setLngLats失败，重建折线', e);
                        if (map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                        playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 3, opacity: 0.9 });
                        if (map) map.addOverLay(playbackState.line);
                    }
                } else {
                    console.log('[Playback] 折线不支持setLngLats，重建');
                    if (playbackState.line && map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                    playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 3, opacity: 0.9 });
                    if (map) map.addOverLay(playbackState.line);
                }
            } catch(e) { console.warn('更新回放覆盖物失败:', e); }
            updatePlaybackTimeLabel(next.ts);
            scheduleNext();
        }, delay);
    }

    function stopPlayback(){
        if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
        playbackState.running = false;
        playbackState.idx = 0;
        try {
            // 移除DOM标记
            removePlaybackDom();
            if (playbackState.marker && map) map.removeOverLay(playbackState.marker);
            if (playbackState.line && map) map.removeOverLay(playbackState.line);
        } catch(e){}
        playbackState.marker = null;
        playbackState.line = null;
        updatePlaybackTimeLabel('—');
        // 按钮回到初始状态
        updatePlaybackButtonsState('idle');
    }

    function updatePlaybackTimeLabel(text){
        const el = document.getElementById('playbackTimeLabel');
        if (el) el.textContent = '时间：' + (text || '—');
    }

    // 时间滑动条：配置与跳转
    function configureTimeSlider(points){
        try {
            const slider = document.getElementById('playbackTimeSlider');
            const cursor = document.getElementById('playbackTimeCursor');
            if (!slider || !points || !points.length) return;
            const minMs = points[0].time.getTime();
            const maxMs = points[points.length - 1].time.getTime();
            const prev = parseInt(slider.value, 10);
            slider.min = String(minMs);
            slider.max = String(maxMs);
            slider.step = '1000'; // 以秒为步进
            let val = (isFinite(prev) && prev >= minMs && prev <= maxMs) ? prev : minMs;
            slider.value = String(val);
            if (cursor) cursor.textContent = formatTimeForLabel(val);
        } catch(e) { console.warn('配置时间滑动条失败:', e); }
    }
    function formatTimeForLabel(ms){
        if (!isFinite(ms)) return '—';
        const d = new Date(ms);
        const pad = n => String(n).padStart(2,'0');
        const y = d.getFullYear();
        const M = pad(d.getMonth()+1);
        const da = pad(d.getDate());
        const h = pad(d.getHours());
        const m = pad(d.getMinutes());
        const s = pad(d.getSeconds());
        return `${y}-${M}-${da} ${h}:${m}:${s}`;
    }
    function findIndexByTime(points, ms){
        try {
            if (!points || !points.length) return 0;
            const n = points.length;
            const minMs = points[0].time.getTime();
            const maxMs = points[n-1].time.getTime();
            if (!isFinite(ms)) return 0;
            if (ms <= minMs) return 0;
            if (ms >= maxMs) return n-1;
            let lo = 0, hi = n - 1, ans = 0;
            while (lo <= hi) {
                const mid = (lo + hi) >> 1;
                const t = points[mid].time.getTime();
                if (t < ms) { lo = mid + 1; ans = lo; }
                else { hi = mid - 1; ans = mid; }
            }
            return Math.max(0, Math.min(n-1, ans));
        } catch(e){ console.warn('findIndexByTime失败:', e); return 0; }
    }
    function jumpToSliderTime(){
        try {
            const slider = document.getElementById('playbackTimeSlider');
            if (!slider || !playbackState.points || !playbackState.points.length) return;
            const ms = parseInt(slider.value, 10);
            if (!isFinite(ms)) return;
            const idx = findIndexByTime(playbackState.points, ms);
            playbackState.idx = idx;
            const pts = playbackState.points;
            const ll = pts[idx].ll;
            playbackState.path = pts.slice(0, idx+1).map(p=>p.ll);
            // 更新折线
            try {
                if (playbackState.line && typeof playbackState.line.setLngLats === 'function') {
                    playbackState.line.setLngLats(playbackState.path);
                } else {
                    if (playbackState.line && map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                    playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 3, opacity: 0.9 });
                    if (map) map.addOverLay(playbackState.line);
                }
            } catch(e){ console.warn('滑块更新折线失败:', e); }
            // 更新标记与时间
            ensurePlaybackDom(ll);
            updatePlaybackDom(ll);
            updatePlaybackTimeLabel(pts[idx].ts);
            // 若正在播放，立即按新位置继续
            if (playbackState.running) {
                if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
                scheduleNext();
            }
        } catch(e) { console.warn('滑块跳转失败:', e); }
    }

    // DOM标记：使用容器坐标实现可见移动
    let playbackDom = { el: null, lastLL: null, bound: false };

    function ensurePlaybackDom(ll){
        try {
            playbackDom.lastLL = ll;
            const pane = (map && map.getPanes && map.getPanes().overlayPane) || document.getElementById('mapContainer');
            if (!pane) { console.warn('未找到overlayPane或mapContainer'); return; }
            if (!playbackDom.el) {
                const el = document.createElement('div');
                el.id = 'playbackDomMarker';
                el.style.position = 'absolute';
                el.style.width = '16px';
                el.style.height = '16px';
                el.style.borderRadius = '50%';
                el.style.background = '#2C64A7';
                el.style.border = '2px solid #fff';
                el.style.boxShadow = '0 0 0 1px rgba(0,0,0,.25)';
                el.style.zIndex = '9999';
                pane.appendChild(el);
                playbackDom.el = el;
                console.log('[Playback] 创建DOM标记，父节点=', pane === document.getElementById('mapContainer') ? '#mapContainer' : 'overlayPane');
                bindPlaybackDomEvents();
            }
            updatePlaybackDom(ll);
        } catch(e) { console.warn('创建DOM标记失败:', e); }
    }

    function updatePlaybackDom(ll){
        try {
            playbackDom.lastLL = ll;
            if (!map || !playbackDom.el || !ll) { console.log('[Playback] update取消：map/el/ll缺失'); return; }
            let p;
            if (typeof map.lngLatToLayerPoint === 'function') {
                p = map.lngLatToLayerPoint(ll);
                console.log('[Playback] 使用layerPoint定位:', ll && ll.lng, ll && ll.lat, '=>', p && p.x, p && p.y);
            } else if (typeof map.lngLatToContainerPoint === 'function') {
                p = map.lngLatToContainerPoint(ll);
                console.log('[Playback] 使用containerPoint定位:', ll && ll.lng, ll && ll.lat, '=>', p && p.x, p && p.y);
            } else {
                console.warn('地图对象不支持lngLat到像素坐标转换');
                return;
            }
            playbackDom.el.style.left = p.x + 'px';
            playbackDom.el.style.top = p.y + 'px';
        } catch(e) { console.warn('更新DOM标记位置失败:', e); }
    }

    function bindPlaybackDomEvents(){
        if (playbackDom.bound) return;
        const updater = function(){
            try {
                if (!map || !playbackDom.el || !playbackDom.lastLL) return;
                let p;
                if (typeof map.lngLatToLayerPoint === 'function') {
                    p = map.lngLatToLayerPoint(playbackDom.lastLL);
                } else if (typeof map.lngLatToContainerPoint === 'function') {
                    p = map.lngLatToContainerPoint(playbackDom.lastLL);
                }
                if (!p) return;
                playbackDom.el.style.left = p.x + 'px';
                playbackDom.el.style.top = p.y + 'px';
            } catch(e){}
        };
        try {
            map.addEventListener('move', updater);
            map.addEventListener('zoom', updater);
            playbackDom.bound = true;
        } catch(e){}
    }

    function removePlaybackDom(){
        try {
            const el = playbackDom.el;
            playbackDom.lastLL = null;
            if (el && el.parentNode) el.parentNode.removeChild(el);
        } catch(e){}
        playbackDom.el = null;
        playbackDom.bound = false;
    }

</script>
</body>

</html>
