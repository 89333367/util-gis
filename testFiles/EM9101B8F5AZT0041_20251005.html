<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>展示轮廓</title>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #mapContainer {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        #mapLoading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
            transition: opacity 0.3s;
        }

        .loading-text {
            font-size: 16px;
            color: #333;
            padding: 10px 20px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .wkt-input-container {
            position: absolute;
            top: 20px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            width: min(320px, 90vw);
            box-sizing: border-box;
            transition: all 0.3s;
        }

        .minimize-btn {
            position: absolute;
            top: -5px;
            right: -4px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #f0f0f0;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #666;
            z-index: 1001;
            transition: background 0.2s;
        }

        .minimize-btn:hover {
            background: #e0e0e0;
        }

        .content-wrapper {
            transition: all 0.3s;
        }

        .wkt-input-container.minimized {
            width: 40px;
            height: 40px;
            padding: 0;
        }

        .wkt-input-container.minimized .content-wrapper {
            display: none;
        }

        .wkt-input-container.minimized .min-icon {
            display: none;
        }

        .wkt-input-container.minimized .restore-icon {
            display: inline;
        }

        #wktTextarea {
            width: 100%;
            height: 120px;
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
            box-sizing: border-box;
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        /* 页签样式 */
        .tabs-header {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .tab-btn {
            flex: 1;
            padding: 6px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            background: #f5f5f5;
            color: #333;
            transition: background 0.2s;
        }
        .tab-btn.active { background: #337AFF; color: #fff; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        /* Multi → Polygons 分割器样式 */
        .split-section {
            margin-top: 10px;
            padding: 10px;
            background: #fafafa;
            border: 1px solid #eee;
            border-radius: 6px;
        }
        .split-section .title {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
        }
        .split-section .desc {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        #multiInput, #polyOutput {
            width: 100%;
            height: 90px;
            margin-bottom: 8px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
            box-sizing: border-box;
        }
        .split-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .split-actions button {
            flex: 1;
            padding: 6px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }
        #splitMultiBtn { background: #337AFF; color: #fff; }
        #splitMultiBtn:hover { background: #2860E0; }
        #copyPolysBtn { background: #f5f5f5; color: #333; }
        #copyPolysBtn:hover { background: #e0e0e0; }
        #drawButton,
        #clearButton,
        #drawTrackButton,
        #clearTrackButton {
            width: 50%;
            padding: 8px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        #drawButton,
        #drawTrackButton {
            background: #337AFF;
            color: white;
        }

        #drawButton:hover,
        #drawTrackButton:hover {
            background: #2860E0;
        }

        #clearButton,
        #clearTrackButton {
            background: #f5f5f5;
            color: #333;
        }

        #clearButton:hover,
        #clearTrackButton:hover {
            background: #e0e0e0;
        }

        #drawButton:disabled,
        #clearButton:disabled,
        #drawTrackButton:disabled,
        #clearTrackButton:disabled {
            background: #e0e0e0;
            color: #999;
            cursor: not-allowed;
        }

        .tip {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .area-label {
             position: absolute;
             background: rgba(255, 0, 0, 0.85);
             border: 1px solid #000;
             border-radius: 3px;
             padding: 4px 6px;
             font-size: 12px;
             color: #fff;
             font-weight: 600;
             box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
             white-space: nowrap;
             z-index: 9999;
             pointer-events: none;
         }
         /* 默认隐藏标签容器下的标签 */
          .labels-hidden .area-label { display: none; }

          /* Batch → Generator 样式 */
          .batch-section { margin-top: 10px; padding: 10px; background: #fafafa; border: 1px solid #eee; border-radius: 6px; }
          .batch-section .title { font-size: 13px; font-weight: 600; color: #333; margin-bottom: 6px; }
          .batch-section .desc { font-size: 12px; color: #666; margin-bottom: 8px; }
          #batchInput, #multiOutput { width: 100%; height: 90px; margin-bottom: 8px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; resize: vertical; box-sizing: border-box; }
          .batch-actions { display: flex; gap: 8px; margin-bottom: 8px; }
          .batch-actions button { flex: 1; padding: 6px 0; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; transition: background 0.2s; }
          #generateMultiBtn { background: #337AFF; color: #fff; }
          #generateMultiBtn:hover { background: #2860E0; }
          #copyMultiBtn { background: #f5f5f5; color: #333; }
          #copyMultiBtn:hover { background: #e0e0e0; }
      </style>
    <script src="https://api.tianditu.gov.cn/api?v=4.0&tk=648f621977051d0199ff0f965d3fd322"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
    <script src="https://lib.baomitu.com/terraformer/1.0.12/terraformer.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://unpkg.com/terraformer-wkt-parser@1.2.1/terraformer-wkt-parser.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- 已移除动态备用加载器 ensureTerraformer：改为仅使用静态脚本标签加载 Terraformer 核心库与 WKT 解析器 -->
    <script>
        // 检查Turf.js是否加载成功
        window.addEventListener('load', function () {
            if (typeof turf === 'undefined') {
                console.warn('Turf.js加载失败，已启用备用面积算法');
            } else {
                console.log('Turf.js加载成功');
            }
        });
    </script>
</head>

<body>
<div id="mapContainer">
    <div id="mapLoading">
        <div class="loading-text">地图正在加载中...</div>
    </div>
</div>

<div class="wkt-input-container">
    <div class="minimize-btn" id="minimizeBtn">
        <span class="min-icon">−</span>
        <span class="restore-icon" style="display:none;">+</span>
    </div>

    <div class="content-wrapper">
        <div class="tabs-header">
            <button class="tab-btn active" id="tabDrawBtn">轮廓</button>
            <button class="tab-btn" id="tabTrackBtn">轨迹</button>
            <button class="tab-btn" id="tabSplitBtn">分割器</button>
            <button class="tab-btn" id="tabBatchBtn">合并器</button>
        </div>
        <div class="tab-pane active" id="tabDraw">
            <div class="tip">请输入WKT字符串（支持POLYGON/MULTIPOLYGON）：</div>
            <textarea id="wktTextarea">POLYGON ((124.48100672860085 45.336507936751495, 124.48107813231422 45.3366360629408, 124.48108720290716 45.33665418882465, 124.48115714647254 45.3367770897171, 124.48126304678573 45.33697390454504, 124.4813052030675 45.33705625639571, 124.48130860669964 45.3371013546935, 124.48127792415082 45.33711645245903, 124.48121455967079 45.33703072402865, 124.48121266998713 45.33702759423501, 124.4812112050013 45.33702569734945, 124.48120925281407 45.33702403300163, 124.48120688545177 45.33702266259802, 124.48120419025888 45.33702163669995, 124.48120126667504 45.33702099315819, 124.48119822256663 45.33702075571632, 124.48119517024651 45.33702093313482, 124.48119222233086 45.33702151886779, 124.4811894875835 45.337022491304495, 124.48118706690369 45.33702381456667, 124.48118504960289 45.33702543983227, 124.48118351010987 45.337027307136765, 124.48118250522464 45.337029347585535, 124.48118207202278 45.33703148589576, 124.48118222648728 45.33703364317399, 124.48118296291945 45.33703573982692, 124.48118396291902 45.33703773982707, 124.48118486110955 45.33703919820498, 124.481185706971 45.337040342608795, 124.4812473299902 45.33714240576971, 124.4812488408264 45.33714435017134, 124.48125086322864 45.337146047708586, 124.48125331857565 45.33714743238927, 124.48125611141516 45.337148450383616, 124.48125913317493 45.33714906211681, 124.48126226638324 45.33714924380757, 124.48126538923594 45.33714898839267, 124.48126592069832 45.33714886710881, 124.48126952833806 45.33715374802388, 124.48130210283286 45.337209590043, 124.48130220238492 45.337211523906106, 124.48130294279478 45.33721369942592, 124.48130427920968 45.33721572851243, 124.48130615873087 45.337217530848896, 124.4813085069617 45.337219035093916, 124.48131123095301 45.33722018170537, 124.48131422288157 45.337220925297274, 124.48131736431878 45.33722123643623, 124.48132053091813 45.337221102806474, 124.48132359733684 45.33722052969748, 124.48132644219768 45.337219539794454, 124.48132895289339 45.33721817228045, 124.48133103004379 45.33721648128542, 124.48133203004367 45.33721548128529, 124.48133360187846 45.337213516978856, 124.48133410871874 45.33721241205009, 124.48134427367943 45.337198011683235, 124.48134537926958 45.337195968136015, 124.48134590304251 45.33719381230044, 124.48134582518315 45.33719162573454, 124.48134542247595 45.337190355149794, 124.48136305855182 45.3371265003675, 124.48137110614424 45.33714301485403, 124.48145505476307 45.33729792011803, 124.48149513328516 45.337376064691824, 124.48157800378242 45.3375268291623, 124.48160988942605 45.337593589765206, 124.48161021102199 45.33759420347976, 124.4816460113093 45.33765685401117, 124.4816780225635 45.337725857389216, 124.48180902250657 45.337978857406945, 124.48190501690527 45.338148860239784, 124.48192211819318 45.33818503751288, 124.48195811817862 45.338251037517715, 124.48195883046327 45.338252156938594, 124.48197731480526 45.33827741888922, 124.481995873118 45.33832179749012, 124.4819947211586 45.33832378349576, 124.48199412482516 45.338325948680264, 124.48199413921559 45.33832815430945, 124.48199476377643 45.33833031553192, 124.4820019288248 45.33834667162889, 124.48207392879097 45.338493671638744, 124.48207440361705 45.338494526324794, 124.48217507954044 45.338656006586255, 124.48219183136538 45.33869246646135, 124.48219224181658 45.338693257461756, 124.48236613847693 45.33899307942372, 124.4824420438652 45.33913789898626, 124.48250718163168 45.33924915509596, 124.48255204586839 45.3393319047278, 124.48261585304796 45.33945752517774, 124.48262961875093 45.33948964517279, 124.48262447061343 45.339509379678105, 124.48258294909957 45.33960832451939, 124.48258254777528 45.33960846447204, 124.48258004238852 45.3396098305642, 124.48257796922661 45.33961151890117, 124.48257696922649 45.33961251890107, 124.48257538463257 45.339614503783004, 124.48257439971066 45.339616673145855, 124.48257405487266 45.33961893798011, 124.48257436426726 45.33962120535908, 124.48257531520005 45.3396233822516, 124.48257554105095 45.33962375867, 124.48257256996179 45.33962821530191, 124.48257147152884 45.33963044535102, 124.48255594111517 45.339677397793785, 124.48216241876257 45.34030444871738, 124.48216143990797 45.340306542321436, 124.48216105901899 45.340308730372726, 124.48216129073305 45.34031092878562, 124.48216212614547 45.34031305307638, 124.48216353315192 45.34031502160967, 124.48216545768203 45.34031675873584, 124.48216782577713 45.34031819769809, 124.48217054643257 45.34031928319789, 124.48217351509527 45.34031997352005, 124.48217661768102 45.34032024213587, 124.48217973495903 45.34032007872261, 124.48218274713412 45.34031948956012, 124.48218553844998 45.34031849728963, 124.48218800163781 45.34031714004353, 124.48219004203881 45.34031546998008, 124.48219158124137 45.340313551278875, 124.48253230368883 45.33977063380852, 124.48253236092586 45.339770686425375, 124.48253471085616 45.33977214010475, 124.48253741776315 45.33977324253494, 124.48254037762202 45.33977395135015, 124.4825434766869 45.339774239311005, 124.48254659586256 45.33977409535133, 124.48254961528053 45.3397735250034, 124.48255241890637 45.3397725501854, 124.48255489899822 45.33977120835903, 124.48255696024758 45.339769551089965, 124.48255852344171 45.339767642066185, 124.48255952850808 45.33976555465035, 124.48258631689806 45.339684566496445, 124.48274162116476 45.33943709544954, 124.48276821880806 45.33940928880477, 124.48276973616089 45.339407295550565, 124.48277065709186 45.33940512844105, 124.48277094432795 45.339402875186416, 124.48277058624382 45.33940062698339, 124.48276959733248 45.3393984748243, 124.48276801761841 45.33939650581418, 124.48276740503708 45.33939600967023, 124.48280158103678 45.33934155120427, 124.48280268932584 45.339339006843566, 124.48280291863679 45.33933635005156, 124.48279769611898 45.33927273059779, 124.48281228945368 45.33929733894708, 124.48281375133568 45.33929925744922, 124.4828157101894 45.33930094122769, 124.48281809253629 45.33930232712214, 124.48282080901191 45.33930336314615, 124.48282375771824 45.339304010437324, 124.48282682804617 45.339304244715066, 124.48282990482433 45.33930405719137, 124.48283287263929 45.33930345490046, 124.48283562016525 45.339302460434915, 124.4828380443394 45.33930111109821, 124.4828400542283 45.33929945750548, 124.48284157443909 45.33929756168475, 124.4828425479469 45.33929549475031, 124.48284293823446 45.33929333423513, 124.48284273066183 45.339291161182416, 124.48284193301527 45.339289057105724, 124.48279880661866 45.33920782678415, 124.48279873036275 45.33920769221582, 124.48279894236381 45.33920578587244, 124.48279858266115 45.339203615485445, 124.48279763457391 45.33920153513518, 124.4827961339008 45.339199623373474, 124.48279413730566 45.339197952386385, 124.48279277421233 45.339197181426215, 124.48262886446497 45.338907929002914, 124.48255176721837 45.33876375811341, 124.48240276716345 45.3385057581332, 124.48232390099712 45.3383839414239, 124.48227205009636 45.3382692856502, 124.48214205003632 45.33800728566792, 124.48206991293904 45.33787901631074, 124.4820268128668 45.33779483847335, 124.48196620382897 45.33768753071904, 124.48195738213477 45.33766283000133, 124.48195757184124 45.337662418068724, 124.48195794094185 45.337660248128195, 124.48195770794432 45.33765806881572, 124.48195688164925 45.33765596244514, 124.48195088164682 45.33764496244594, 124.48194943558784 45.337642944448135, 124.48194744635879 45.337641171262526, 124.48194499437972 45.337639714574905, 124.48194217877851 45.33763863327586, 124.48194061399717 45.33763829524704, 124.48192444516086 45.33762122814945, 124.48192549815545 45.337620924376424, 124.4819281763782 45.33761965724965, 124.4819304382843 45.33761803595397, 124.48193219133896 45.33761612681679, 124.48193336382455 45.33761400794106, 124.48193390777473 45.337611766010205, 124.48193380093663 45.33760949274181, 124.48193304768077 45.33760728113548, 124.48185380865294 45.33744783117897, 124.48172116729667 45.33721346498253, 124.48171241468785 45.33719012470892, 124.48171153881951 45.337188382960974, 124.4817102703005 45.33718676590566, 124.48168240515334 45.33715726164345, 124.48166420454197 45.33711661361504, 124.4816629409599 45.33711454232792, 124.48166111686461 45.33711269047315, 124.4816588055962 45.33711113250685, 124.48165610008193 45.33710993106889, 124.48165310910036 45.33710913446456, 124.48164995290752 45.3371087747223, 124.48164675840196 45.337108866305954, 124.48164365402249 45.33710940553332, 124.4816407645845 45.337110370724105, 124.4816382062614 45.33711172307164, 124.48163608191368 45.337113408203166, 124.48163447695329 45.33711535836594, 124.48163345590976 45.33711749515128, 124.4816332505506 45.33711865526185, 124.48162170358265 45.337110101951296, 124.48160652834518 45.337091486971744, 124.48160555013133 45.33708454167519, 124.48161626543528 45.3370641480241, 124.48161699391677 45.33706441706585, 124.48161992827833 45.3370650347248, 124.4816229759416 45.3370652453635, 124.48162602449229 45.337065041212426, 124.48162896148342 45.337064429801806, 124.4816316785828 45.33706343368376, 124.48163407556915 45.3370620896005, 124.48163606402854 45.3370604471291, 124.48163757061609 45.33705856685278, 124.48163853976061 45.33705651812629, 124.48163893571494 45.33705437651773, 124.48163874387416 45.33705222102117, 124.48163797131457 45.337050131142945, 124.48146497123969 45.33671713116637, 124.48139850072968 45.33660432398521, 124.48130450070101 45.33645932399741, 124.48130287076378 45.336457362457296, 124.4813007147189 45.33645567223464, 124.48129398754962 45.33645136685219, 124.48129411215298 45.33645123402671, 124.48129530855337 45.33644914423557, 124.48129589008325 45.33644692815572, 124.48129583338547 45.336444674796354, 124.48129514073737 45.33644247466401, 124.4812291407043 45.33630147467311, 124.4812278294082 45.33629940318057, 124.4812259553053 45.33629755945831, 124.48122359466502 45.33629601853912, 124.48122084355677 45.33629484313283, 124.48121781394065 45.33629408107421, 124.48121462911114 45.33629376337623, 124.48121141867911 45.33629390296807, 124.48120831329734 45.336294494168875, 124.48120543934385 45.33629551291888, 124.48120291377793 45.33629691775869, 124.48120083938099 45.33629865151642, 124.48119930057345 45.33630064363445, 124.48119835997936 45.336302813040774, 124.48119805587751 45.33630507144844, 124.48119905584635 45.336416071448966, 124.48119941665092 45.33641837980026, 124.4812004420587 45.33642058665715, 124.48120208833778 45.33642259790097, 124.48120428527736 45.33642432775559, 124.48126075033784 45.336460465410724, 124.48129844050152 45.33653668331898, 124.48131768699639 45.336630261310724, 124.48118874045838 45.33640971310336, 124.48118760056015 45.33640813082292, 124.48118612188635 45.336406694737484, 124.48115236413861 45.336378831220856, 124.48115270754683 45.336378189196374, 124.48115519346482 45.336377187830074, 124.48115750210957 45.3363757878012, 124.48115939133251 45.33637410379198, 124.48116079224366 45.33637219720943, 124.481161653759 45.33637013757664, 124.48116194446382 45.33636799999762, 124.4811619444635 45.33636699999764, 124.4811616601727 45.33636488592211, 124.48116085940431 45.33636294875289, 124.48116191822581 45.336360969214525, 124.48116272140015 45.33635887443933, 124.48116293915305 45.3363567098652, 124.48116256337606 45.336354556094896, 124.48116160806204 45.33635249332885, 124.48116010878427 45.33635059837877, 124.48115812137193 45.33634894180734, 124.4811557198306 45.336347585300636, 124.4811529935871 45.33634657937123, 124.48115004415916 45.33634596147713, 124.4811469813752 45.33634575462698, 124.4811439192848 45.3363459665233, 124.48110791929152 45.336350966522254, 124.48110502902803 45.33635157291541, 124.48110235232735 45.33635255225238, 124.48109998492656 45.33635386950541, 124.48109801149997 45.3363554775605, 124.48109650263098 45.33635731890267, 124.48109551228691 45.33635932767288, 124.48109507588956 45.33636143202383, 124.48109520904741 45.33636355668948, 124.48109564128953 45.33636483801789, 124.48108233314285 45.336367056039265, 124.48107936047876 45.336367775987235, 124.48107664581404 45.336368893221234, 124.48107429463552 45.33637036432766, 124.48107239830554 45.33637213214206, 124.48107103051191 45.33637412797048, 124.48106957070821 45.33637693528498, 124.48104407106702 45.336387243646, 124.48104157369525 45.336388492090364, 124.48103946061445 45.336390054117864, 124.48103780970821 45.33639187215557, 124.48103668182534 45.33639387919454, 124.48103614390604 45.33639590568893, 124.48103576812625 45.33639532849402, 124.48103393499701 45.336393543241535, 124.48103164331422 45.336392044484626, 124.48102898112651 45.33639088980692, 124.48102605071756 45.336390123572194, 124.48102296467628 45.3363897752199, 124.48101984157141 45.336389858134034, 124.48101680139527 45.336390369128964, 124.48101396095437 45.336391288571825, 124.48096296095994 45.336412288568184, 124.48096057249951 45.33641349281629, 124.48095853760965 45.336414985521834, 124.48095692528837 45.33641671607088, 124.48095579020547 45.336418625784844, 124.480955170849 45.33642064991007, 124.48095508821966 45.336422719813484, 124.48095554511937 45.336424765309815, 124.48095652605589 45.33642671704136, 124.48097535964716 45.33645546306031, 124.48100321134838 45.33650420355913, 124.48100464555279 45.33650614389097, 124.48100658539241 45.33650785159869, 124.48100672860085 45.336507936751495), (124.48124869996612 45.33657126477993, 124.48126513958013 45.33659938280893, 124.48126432287846 45.33659887724666, 124.48126235332134 45.33659806582006, 124.48124869996612 45.33657126477993), (124.48109550903648 45.3363923729093, 124.4811055405764 45.33638831760319, 124.48111430454767 45.33638626646256, 124.48110908176808 45.33639603077879, 124.48110823929679 45.33639829759039, 124.48110808123688 45.336400638329415, 124.4811086144523 45.336402951348894, 124.48110981578805 45.336405136205485, 124.481111633076 45.33640709802139, 124.48112525152325 45.336418900678126, 124.48116130195672 45.33647736086331, 124.48121010579253 45.336562020616434, 124.48124122086264 45.33662309843055, 124.48124691021818 45.336661217234024, 124.48113579876893 45.336465814201425, 124.48113523101483 45.3364649285757, 124.48109035360092 45.33640228721249, 124.48109550903648 45.3363923729093), (124.48129273139922 45.33670735992269, 124.48132511163345 45.33676602520687, 124.48142405968495 45.336950928221405, 124.48156612082968 45.33722304188499, 124.48171380176028 45.337493457774556, 124.48174161004054 45.33756825251686, 124.48173856595892 45.3375781905557, 124.48171201907466 45.33752821996127, 124.48167409954688 45.33744938730171, 124.48167283209122 45.33744740613896, 124.4816710479155 45.33744563394394, 124.48166678396942 45.33744216497526, 124.48166693826553 45.33744132101057, 124.48166671271284 45.33743908845162, 124.48166586470462 45.337436931618214, 124.48155090921621 45.33722801261199, 124.48140495193246 45.33695009408608, 124.48129106881954 45.33673978038669, 124.48129273139922 45.33670735992269), (124.4810427229813 45.33641411488004, 124.48104209753062 45.336415001424015, 124.48104127782116 45.336417128746035, 124.48104106230603 45.33641932797928, 124.4810414592674 45.33642151460847, 124.4810424534504 45.3364236046027, 124.48109127907341 45.336500330612644, 124.48116612566595 45.33663705045245, 124.48121515389848 45.33672210413745, 124.48154449104308 45.33733739309513, 124.48154496283058 45.33733873980687, 124.48155741370695 45.33736364157311, 124.48156823397768 45.33742083453266, 124.48144795016627 45.337197089745885, 124.48135698966469 45.337020166662114, 124.48130889095924 45.33693497715397, 124.48122478723609 45.336773793836755, 124.48102578716154 45.33642579386324, 124.48102433856452 45.33642383898621, 124.48101888879545 45.33641797000665, 124.48103257478577 45.336409416260096, 124.48103469942698 45.33640779971157, 124.48103633614416 45.33640592191173, 124.48103742205325 45.33640385500741, 124.48103772171943 45.33640253299718, 124.4810427229813 45.33641411488004), (124.48158838948908 45.33735829419289, 124.48158946634045 45.337360251287265, 124.48158895988887 45.33736033314266, 124.48158880467238 45.337359512712595, 124.48158838948908 45.33735829419289), (124.48160307603962 45.33743356148174, 124.48161385164828 45.33744818551995, 124.48161558359773 45.33745005511997, 124.48161780524308 45.33745164647007, 124.48162042896396 45.337452896808315, 124.48162335128244 45.33745375682204, 124.48162645694372 45.33745419259278, 124.48162962346233 45.33745418693401, 124.48163272595248 45.33745374006885, 124.4816356420538 45.33745286962147, 124.48163695827088 45.33745223550042, 124.48164490463003 45.33745870033, 124.48166049049071 45.33749110255827, 124.48165814657017 45.337490356521855, 124.4816551952357 45.33748986171103, 124.48165216444013 45.337489770073944, 124.4816491638894 45.33749008492761, 124.48164630219476 45.33749079487522, 124.48164368294127 45.337491874218735, 124.48164140093814 45.3374932838891, 124.48163953878738 45.337494972860306, 124.48163816389355 45.33749687999653, 124.48163732602373 45.33749893626494, 124.48163628917825 45.33750285323478, 124.48163135328434 45.337496769459555, 124.48160307603962 45.33743356148174), (124.48133925888764 45.337051657058495, 124.48133786711124 45.337052317468356, 124.48133682211186 45.33705305402074, 124.48133599717391 45.33705018128379, 124.48130080292357 45.336981433343354, 124.48132709503263 45.33702799807668, 124.48133925888764 45.337051657058495), (124.48123344597913 45.336855502056416, 124.48118690725661 45.33676901013577, 124.48111692382159 45.336646033853484, 124.48111400056419 45.33664018734505, 124.48119512102576 45.336782045735006, 124.48123344597913 45.336855502056416), (124.48129278793483 45.33713656224462, 124.48133329603331 45.33711662967932, 124.48131692832877 45.3371758919783, 124.48129874554039 45.33714472148, 124.48129813890989 45.33714380178076, 124.48129278793483 45.33713656224462), (124.4813398916816 45.33709274888169, 124.48133890542842 45.33707968107933, 124.48134162386596 45.33708647717594, 124.4813398916816 45.33709274888169), (124.48165267626315 45.33754443250208, 124.48165431142667 45.33754350875965, 124.4816567183567 45.337549209382786, 124.48165696750101 45.337549749245085, 124.48171303030406 45.33766155688705, 124.4817084146953 45.33767662545347, 124.48170805535426 45.33767894620069, 124.48170838319395 45.337681269266554, 124.48170938408545 45.337683494531795, 124.48171101489235 45.33768552609209, 124.4817388744965 45.33771309853229, 124.48183296742097 45.33790074926905, 124.48195207125046 45.338118951486585, 124.48199394240302 45.33819970303597, 124.48206586667959 45.33835254220908, 124.48210096251648 45.33842273974778, 124.4821012846962 45.33842333053845, 124.48217213706268 45.338543081069446, 124.48221042558805 45.338617694645436, 124.48221829715932 45.338658904731545, 124.48217185548675 45.338574914371264, 124.48212275706177 45.33849473540419, 124.48208996617676 45.3384351156414, 124.48201849604504 45.33829043693032, 124.4820187648002 45.33828968586596, 124.48201893029146 45.33828751709937, 124.4820185015487 45.338285366346014, 124.4820174945651 45.33828331383359, 124.48200673050485 45.338266753748385, 124.48179500356262 45.337861192466434, 124.48164449387932 45.33755921467371, 124.4816460710135 45.337558698293044, 124.48164854959671 45.33755743209889, 124.4816506395108 45.337555855248695, 124.48165226375903 45.3375540258369, 124.48165336250071 45.337552011262844, 124.48165389525595 45.337549885747634, 124.48165384239712 45.337547727599656, 124.48165320587162 45.33754561632954, 124.48165267626315 45.33754443250208), (124.48175188395335 45.337641223094316, 124.48176012416656 45.33761432119967, 124.48176841503494 45.33764137561866, 124.48176938053386 45.33764348876551, 124.48177091586629 45.3376454269505, 124.4817729611887 45.337647114627565, 124.48177543677899 45.33764848601489, 124.48177824614439 45.33764948765888, 124.48178127978214 45.33765008051772, 124.48178441944779 45.33765024148312, 124.48178754276435 45.33764996428101, 124.48179052799202 45.337649259716095, 124.48179325877335 45.33764815525075, 124.48179562866858 45.3376466939345, 124.48179625282847 45.337646120390296, 124.48179684189134 45.337647172323194, 124.4817986173204 45.337649084575865, 124.48180090433688 45.33765070413106, 124.48180897654706 45.33765536117736, 124.48181732750896 45.337672808724996, 124.48181526201587 45.33767282162619, 124.48181213682547 45.33767329043984, 124.4818092069115 45.3376741892863, 124.4818065899219 45.33767548207324, 124.48180439093974 45.33767711688992, 124.48180269826305 45.33767902809179, 124.48180157985986 45.33768113893622, 124.48180108063879 45.33768336466414, 124.48180122064564 45.3376856159034, 124.48181378198038 45.33774662819132, 124.48176605920582 45.337685963651516, 124.48175188395335 45.337641223094316), (124.48265035157594 45.339526958967845, 124.48265528980372 45.33951519124736, 124.48265568214929 45.33951403473856, 124.48266005648138 45.33949726644991, 124.4826600686957 45.33949747165138, 124.4826605167549 45.33949968760766, 124.48266157826443 45.33950179708022, 124.48266321116722 45.339503716491166, 124.48266437389942 45.33950461495228, 124.48265035157594 45.339526958967845), (124.48273473972748 45.33939248951371, 124.4827320084247 45.339392590672894, 124.48272176980586 45.339388279678715, 124.48271491623014 45.33930832145835, 124.48271418793901 45.339305575474455, 124.48268780970726 45.33924738825135, 124.48269705417268 45.33926426934079, 124.48271993894474 45.33931069273833, 124.48272105658 45.339312455217865, 124.48272258522508 45.33931405689413, 124.4827385852241 45.33932805689587, 124.4827403747976 45.33932938494841, 124.48274244639734 45.339330490438186, 124.48276679749338 45.339341406448305, 124.48273473972748 45.33939248951371), (124.48123532466958 45.336413822615285, 124.4812308996677 45.33641099061125, 124.48123085399348 45.33640592095174, 124.48123532466958 45.336413822615285), (124.48135080892033 45.33668691223985, 124.48135091773041 45.336686900633524, 124.48135385701595 45.33668615236335, 124.48135653292083 45.33668501413687, 124.48135884266246 45.336683529673834, 124.48136069752256 45.33668175599307, 124.48136202625551 45.33667976122236, 124.48136277782395 45.33667762198163, 124.48136292336021 45.33667542043997, 124.4813591644612 45.33662404909364, 124.48139815376078 45.33669210313756, 124.48144704333822 45.33678289811084, 124.4815268815129 45.336939580609574, 124.48156529471306 45.33702625660185, 124.48157308906808 45.33708159664624, 124.48156704887694 45.337093092477986, 124.48156642552816 45.337094732545005, 124.48151604363598 45.33699826958963, 124.48149711879779 45.336958427846994, 124.48149587208258 45.33695645576418, 124.48149411393472 45.33695468808496, 124.48149384819375 45.336954507517596, 124.48137174052458 45.33672271307912, 124.48135080892033 45.33668691223985), (124.4814720750109 45.33697650226859, 124.48147898965007 45.33699105378501, 124.48146886136418 45.336971653060886, 124.48147005347558 45.33697391620038, 124.48147137343031 45.33697583924134, 124.4814720750109 45.33697650226859), (124.48144541153712 45.33692713517514, 124.48135491747436 45.336758029183784, 124.48130470020905 45.33666704649127, 124.48134215184916 45.33673110283702, 124.48144541153712 45.33692713517514), (124.4815799964143 45.337184531368635, 124.48171511492377 45.337429031541284, 124.48175664999135 45.33750646125975, 124.4817560595113 45.33750668873332, 124.48175372000232 45.33750805208179, 124.48175256328086 45.33750904130598, 124.48174442335824 45.33748714771365, 124.48174387922934 45.33748595809138, 124.48159592175217 45.3372150360833, 124.4815799964143 45.337184531368635), (124.48185963983165 45.33763900887189, 124.48182591321876 45.33757202084598, 124.48174485622722 45.33742091625305, 124.48159791032687 45.33715501427291, 124.48157242177464 45.33710621314695, 124.48159596710052 45.33712365414956, 124.48165217716421 45.337192605147955, 124.4816540292653 45.337194428335806, 124.48165635753921 45.33719595603883, 124.4816590693717 45.33719712748797, 124.48166205689131 45.3371978960852, 124.48166294520047 45.33719799077395, 124.48171713626276 45.3373000700671, 124.48182600540082 45.337497832448605, 124.48186911551461 45.337588032312276, 124.48187423656569 45.337597434921136, 124.4818734036766 45.33759847394342, 124.4818724174701 45.33760061648251, 124.4818720565254 45.337602854662244, 124.48187233532582 45.33760509867376, 124.48187324268449 45.33760725847426, 124.48187474219266 45.337609247399946, 124.48188868702921 45.33762396696685, 124.48192994555627 45.33769972031163, 124.48195429606812 45.3377538325975, 124.48195350182276 45.33775376019474, 124.48195041796386 45.33775390304779, 124.4819474311068 45.337754462790706, 124.48194465346158 45.33775541839503, 124.48194218937874 45.33775673396069, 124.48194013142889 45.33775836006458, 124.48193855692487 45.337760235617324, 124.48193752501777 45.337762290158224, 124.48193707447426 45.33776444650237, 124.48193722222032 45.3377666236403, 124.48193796270563 45.33776873978136, 124.48194696270149 45.33778673978258, 124.48194828271266 45.337788732844814, 124.48195003400711 45.33779041653676, 124.4819721605134 45.337830114094004, 124.48197362050232 45.33783211705479, 124.48197561712665 45.337833874667965, 124.48197807030438 45.33783531643779, 124.48198088164139 45.337836384536615, 124.48198393837853 45.33783703612429, 124.48198711791363 45.3378372450664, 124.48199029271927 45.33783700298257, 124.48199333545803 45.337836319582436, 124.48199564170335 45.33783541209174, 124.48200109379277 45.337846992325964, 124.48208501387137 45.3380028439762, 124.48219283507085 45.338221481525245, 124.48222674236335 45.338300266165284, 124.48226394045591 45.33837569530416, 124.4822644217024 45.33837655517366, 124.48231325959729 45.33845429716045, 124.48239811602826 45.33861003374249, 124.48248620950527 45.33876220168625, 124.48256612289575 45.338904048019636, 124.48260922506616 45.3389852285953, 124.48271170234003 45.339163320251224, 124.4827554620744 45.339306984490825, 124.48275277437185 45.33930463275139, 124.4827527285861 45.339304152355375, 124.48275191794818 45.339302028832165, 124.48272041462934 45.339243167410515, 124.48271506103865 45.33923230726263, 124.48271303065748 45.33922951887139, 124.48271203065738 45.33922851887153, 124.48271136297156 45.33922797160244, 124.482498874394 45.33883994860724, 124.4823618177124 45.3386018458854, 124.48231359562294 45.33851447244319, 124.48225573544528 45.33842169667933, 124.48221299827091 45.338344173469295, 124.48211711835259 45.33814242625231, 124.48207186791467 45.338052937166665, 124.48198286787927 45.337890937178614, 124.48198103024123 45.3378885187582, 124.48190303023266 45.337810518767135, 124.48190075839352 45.337808700129365, 124.481898005408 45.33780727669972, 124.48188871761954 45.33779552479587, 124.48187220593711 45.33775861635042, 124.48187098917585 45.33775660384287, 124.48186924290897 45.337754795585845, 124.48186703323458 45.33775326002385, 124.48186444379127 45.33775205527959, 124.48186177986808 45.33775128675186, 124.48185423030175 45.337735657803, 124.48185365106798 45.33773420972105, 124.48185285748667 45.337719131760736, 124.48185351122596 45.33771910503057, 124.48185659662802 45.33771852989553, 124.48185945783007 45.3377175329348, 124.48186198021301 45.33771615408647, 124.48186386366027 45.337714611617706, 124.48186897421952 45.33772476270742, 124.48187028566518 45.337726736339924, 124.4818721123213 45.33772849447367, 124.48187438556559 45.33772997106032, 124.4818770199983 45.33773111062845, 124.48187991665088 45.337731870367605, 124.48188296670398 45.337732221736395, 124.4818860555752 45.33773215153485, 124.48188906722403 45.337731662400266, 124.48189188851093 45.3377307727081, 124.48189441344773 45.337729515881705, 124.48189654717942 45.33772793913664, 124.48189820954742 45.33772610170701, 124.48189933810113 45.33772407262004, 124.48189989044383 45.33772192810308, 124.48189984582574 45.3377197487198, 124.48189920592301 45.33771761634371, 124.48188220591402 45.337679616346065, 124.48188184185068 45.33767889021348, 124.48185963983165 45.33763900887189), (124.48185572877546 45.33781600459009, 124.48186024221783 45.33781784681153, 124.48188090695396 45.337860626402104, 124.48188217692947 45.33786260505829, 124.48188396254984 45.33786437462784, 124.48188619720587 45.33786586910013, 124.48188879753765 45.337867032726564, 124.48189166654446 45.337867822100094, 124.48189469720313 45.33786820777458, 124.4818977764604 45.33786817536309, 124.4819007894499 45.33786772607472, 124.48190362377763 45.33786687666934, 124.48190617371394 45.337865658832506, 124.48190711118228 45.337864993299966, 124.48190907251524 45.33786747498422, 124.4819108340762 45.33786926900852, 124.48191305376531 45.33787078930628, 124.48191434910666 45.337871383153804, 124.48205603150073 45.338132877563446, 124.48209892128804 45.33821865718299, 124.48217588178672 45.33838057416609, 124.48217653736009 45.33838173500451, 124.48222844093817 45.33846058854776, 124.48226720526674 45.33852420183157, 124.48234716871666 45.33867412917195, 124.48243608391276 45.33883297774213, 124.4824962037829 45.33895019140245, 124.4825820761565 45.33910096738316, 124.48261395088976 45.339164716882856, 124.48264987342658 45.339237559843944, 124.48268320421096 45.33931108367761, 124.48268570715598 45.33934028486276, 124.48245585880737 45.33892392021855, 124.48235483772972 45.33874888029164, 124.48231378270235 45.33867278506356, 124.48222378266878 45.33851578507555, 124.48217084952475 45.338428888213095, 124.48212508472338 45.33833835354414, 124.48207614577075 45.338233484418915, 124.48202692330119 45.338135039416954, 124.48187592323839 45.33785203943733, 124.48185572877546 45.33781600459009), (124.48224614520257 45.33861480036707, 124.48224531323906 45.338614075463184, 124.4822428146349 45.33861262916093, 124.48224130510965 45.338612069223096, 124.4822409933944 45.33861117311337, 124.4822146291436 45.33855982229509, 124.48224614520257 45.33861480036707), (124.4818985421799 45.337958290187885, 124.48186295926543 45.337893104518045, 124.48185044647556 45.33786815020355, 124.4818985421799 45.337958290187885), (124.4822489675224 45.338714372325676, 124.48225052101138 45.33871391582208, 124.48225307575476 45.338712715704034, 124.48225525708888 45.3387111925805, 124.48225698417306 45.33870940289866, 124.4822581930013 45.33870741298447, 124.48225883877437 45.338705296584514, 124.48225889755977 45.33870313213292, 124.48225807858022 45.33869567034922, 124.48231316789143 45.3387941277534, 124.4823981775299 45.3389401471748, 124.48248019270478 45.33909117196353, 124.48257813098672 45.33926406309148, 124.482618992647 45.33934080332033, 124.48265516595977 45.33941510530221, 124.48265528227235 45.33941705936624, 124.48262694415793 45.339393080963404, 124.48258082857639 45.33930486569676, 124.482418871603 45.33901594258786, 124.48237477018124 45.33893376316942, 124.48226581360818 45.33874483855395, 124.4822489675224 45.338714372325676), (124.48264559054694 45.339449379399525, 124.48264585395157 45.339449237952635, 124.48264791984568 45.33944759059077, 124.48264947965481 45.3394457056064, 124.48265731007649 45.33945112666818, 124.48265906551194 45.339480618109754, 124.48264626337475 45.33945074647197, 124.48264601124734 45.33945020765105, 124.48264559054694 45.339449379399525), (124.48268864740196 45.339441359056586, 124.48268693128216 45.339412528345534, 124.48268608114954 45.3394093482177, 124.48268001655728 45.3393968935342, 124.48269095404541 45.33940149879354, 124.48269501410884 45.339448866267254, 124.48269103444889 45.339443662096954, 124.48268974549197 45.33944224266517, 124.48268864740196 45.339441359056586), (124.48276136406365 45.33921927518603, 124.48275022128261 45.339182693198076, 124.48276044853156 45.33920074120404, 124.48276019493649 45.33920151210225, 124.48276008140188 45.33920364994238, 124.48276024420106 45.33920563314481, 124.48276005484092 45.33920703869534, 124.48276037189628 45.33920923169504, 124.48276057856373 45.339209706314435, 124.48276136406365 45.33921927518603))</textarea>
            <div class="coord-settings" style="margin-bottom:8px;font-size:12px;color:#333;">
                <label>WKT坐标系：
                    <select id="coordSysSelect" style="margin-left:6px;">
                        <option value="wgs84" selected>WGS84</option>
                        <option value="gcj02">GCJ-02（国测局）</option>
                        <option value="bd09">BD-09（百度）</option>
                        <option value="cgcs2000">CGCS2000</option>
                    </select>
                </label>
                <!-- 已移除“不进行绘制坐标转换”选项，统一使用WGS84绘制 -->
            </div>

            <div class="button-group">
                <button id="drawButton" disabled>绘制轮廓</button>
                <button id="clearButton" disabled>清空轮廓</button>
            </div>
            <!-- 显示开关：仅保留显示亩数 -->
            <div class="display-toggles" style="margin-top:8px;font-size:12px;color:#333;">
                <label><input type="checkbox" id="toggleLabelsCheckbox"> 显示亩数</label>
            </div>
        </div>

        <div class="tab-pane" id="tabSplit">
            <!-- MultiPolygon → 多个 Polygon 分割器 -->
            <div class="split-section">
                <div class="title">MultiPolygon → 多个 Polygon 分割器</div>
                <div class="desc">输入一个 MULTIPOLYGON WKT，分割为多行 POLYGON WKT。</div>
                <textarea id="multiInput"></textarea>
                <div class="split-actions">
                    <button id="splitMultiBtn">分割为多个 POLYGON</button>
                    <button id="copyPolysBtn">复制结果</button>
                </div>
                <textarea id="polyOutput" readonly></textarea>
            </div>
        </div>

        <div class="tab-pane" id="tabBatch">
            <!-- 批量POLYGON → MULTIPOLYGON 生成器 -->
            <div class="batch-section">
                <div class="title">批量POLYGON → MULTIPOLYGON 合并器</div>
                <div class="desc">每行一个 POLYGON WKT（或用分号分隔）。生成后可一键填充到上方并绘制。</div>
                <textarea id="batchInput"></textarea>
                <div class="batch-actions">
                    <button id="generateMultiBtn">生成 MULTIPOLYGON</button>
                    <button id="copyMultiBtn">复制结果</button>
                </div>
                <textarea id="multiOutput" readonly></textarea>
            </div>
        </div>
        <div class="tab-pane" id="tabTrack">
            <div class="tip">请粘贴轨迹文本（支持两种格式：1）每行一条：定位时间yyyyMMddHHmmss, 经度, 纬度；2）单行#分隔：经度,纬度,定位时间yyyyMMddHHmmss#经度,纬度,定位时间yyyyMMddHHmmss#…）。</div>
            <div class="coord-settings" style="margin-bottom:8px;font-size:12px;color:#333;">
                <label>轨迹坐标系：
                    <select id="trackCoordSysSelect" style="margin-left:6px;">
                        <option value="wgs84" selected>WGS84</option>
                        <option value="gcj02">GCJ-02（国测局）</option>
                        <option value="bd09">BD-09（百度）</option>
                        <option value="cgcs2000">CGCS2000</option>
                    </select>
                </label>
            </div>
            <textarea id="trackTextarea" style="width:100%;height:120px;margin-bottom:10px;padding:8px;border:1px solid #ddd;border-radius:4px;font-family:monospace;resize:vertical;box-sizing:border-box;">20251005060816,124.504376,45.342028
20251005061446,124.503261,45.341735
20251005061456,124.502850,45.341662
20251005061506,124.502552,45.342048
20251005061516,124.502322,45.342373
20251005061526,124.501993,45.342506
20251005061536,124.501630,45.342735
20251005061546,124.501190,45.342706
20251005061556,124.500843,45.343088
20251005061606,124.500244,45.343708
20251005061616,124.499677,45.344322
20251005061626,124.499172,45.344880
20251005061636,124.498664,45.345475
20251005061646,124.498373,45.345870
20251005061656,124.498071,45.346216
20251005061706,124.497756,45.346427
20251005061716,124.497376,45.346722
20251005061726,124.497034,45.346889
20251005061736,124.496457,45.346638
20251005061746,124.495757,45.346331
20251005061756,124.495031,45.346009
20251005061806,124.494262,45.345676
20251005061816,124.493597,45.345394
20251005061826,124.492999,45.345123
20251005061836,124.492203,45.344772
20251005061846,124.491551,45.344263
20251005061856,124.490934,45.343717
20251005061906,124.490314,45.343263
20251005061916,124.489783,45.342880
20251005061926,124.489346,45.342651
20251005061937,124.488684,45.342378
20251005061947,124.487878,45.342018
20251005061957,124.487196,45.341683
20251005062007,124.486576,45.341343
20251005062017,124.485942,45.340985
20251005062027,124.485235,45.340797
20251005062037,124.484488,45.340913
20251005062047,124.483634,45.340914
20251005062057,124.482930,45.340985
20251005062107,124.482504,45.341176
20251005062117,124.482462,45.341170
20251005062127,124.482327,45.341108
20251005062137,124.482196,45.341027
20251005062147,124.482101,45.340935
20251005062157,124.482020,45.340828
20251005062207,124.481939,45.340717
20251005062217,124.481950,45.340603
20251005062227,124.482000,45.340555
20251005062237,124.482014,45.340539
20251005062247,124.482099,45.340428
20251005062257,124.482180,45.340314
20251005062307,124.482274,45.340180
20251005062317,124.482410,45.339976
20251005062327,124.482544,45.339763
20251005062337,124.482587,45.339633
20251005062347,124.482591,45.339627
20251005062357,124.482591,45.339627
20251005062602,124.482596,45.339624
20251005062612,124.482592,45.339623
20251005062622,124.482591,45.339618
20251005062632,124.482591,45.339618
20251005062642,124.482590,45.339619
20251005062652,124.482590,45.339621
20251005062702,124.482593,45.339624
20251005062838,124.482640,45.339512
20251005062848,124.482645,45.339490
20251005062858,124.482646,45.339489
20251005062908,124.482631,45.339454
20251005062918,124.482599,45.339393
20251005062928,124.482567,45.339328
20251005062938,124.482522,45.339245
20251005062948,124.482478,45.339169
20251005062958,124.482457,45.339134
20251005063008,124.482421,45.339067
20251005063018,124.482381,45.338989
20251005063028,124.482350,45.338937
20251005063038,124.482314,45.338875
20251005063048,124.482274,45.338806
20251005063058,124.482236,45.338739
20251005063108,124.482207,45.338689
20251005063118,124.482190,45.338652
20251005063128,124.482158,45.338600
20251005063138,124.482120,45.338540
20251005063148,124.482089,45.338490
20251005063158,124.482058,45.338426
20251005063208,124.482044,45.338399
20251005063218,124.482034,45.338380
20251005063228,124.482017,45.338343
20251005063238,124.482010,45.338327
20251005063248,124.482013,45.338323
20251005063258,124.481990,45.338268
20251005063308,124.482003,45.338288
20251005063318,124.481973,45.338247
20251005063328,124.481937,45.338181
20251005063338,124.481920,45.338145
20251005063348,124.481886,45.338084
20251005063358,124.481856,45.338031
20251005063408,124.481824,45.337975
20251005063418,124.481792,45.337914
20251005063429,124.481757,45.337844
20251005063439,124.481727,45.337786
20251005063449,124.481693,45.337722
20251005063459,124.481661,45.337653
20251005063509,124.481625,45.337590
20251005063519,124.481593,45.337523
20251005063529,124.481555,45.337452
20251005063539,124.481510,45.337372
20251005063549,124.481470,45.337294
20251005063559,124.481427,45.337214
20251005063609,124.481386,45.337139
20251005063619,124.481348,45.337061
20251005063629,124.481358,45.337086
20251005063639,124.481332,45.337176
20251005063649,124.481329,45.337191
20251005063659,124.481324,45.337201
20251005063709,124.481330,45.337193
20251005063719,124.481318,45.337210
20251005063729,124.481318,45.337210
20251005063739,124.481319,45.337209
20251005063749,124.481319,45.337209
20251005063759,124.481319,45.337209
20251005063809,124.481319,45.337209
20251005063819,124.481319,45.337209
20251005063829,124.481319,45.337209
20251005063839,124.481319,45.337209
20251005063849,124.481319,45.337209
20251005063859,124.481319,45.337209
20251005063909,124.481319,45.337209
20251005063919,124.481319,45.337209
20251005063929,124.481319,45.337209
20251005063939,124.481319,45.337209
20251005063949,124.481319,45.337209
20251005063959,124.481319,45.337209
20251005064009,124.481319,45.337209
20251005064019,124.481319,45.337209
20251005064029,124.481319,45.337209
20251005064039,124.481319,45.337209
20251005064049,124.481319,45.337209
20251005064059,124.481319,45.337209
20251005064109,124.481319,45.337209
20251005064119,124.481319,45.337209
20251005064129,124.481319,45.337209
20251005064139,124.481319,45.337209
20251005064149,124.481284,45.337149
20251005064159,124.481199,45.337034
20251005064209,124.481198,45.337032
20251005064219,124.481262,45.337138
20251005064229,124.481325,45.337107
20251005064239,124.481321,45.337057
20251005064249,124.481321,45.337054
20251005064259,124.481316,45.337044
20251005064309,124.481278,45.336970
20251005064319,124.481241,45.336902
20251005064329,124.481206,45.336835
20251005064339,124.481172,45.336773
20251005064349,124.481135,45.336710
20251005064359,124.481106,45.336657
20251005064409,124.481102,45.336650
20251005064419,124.481084,45.336614
20251005065456,124.481093,45.336632
20251005065506,124.481093,45.336632
20251005065516,124.481074,45.336597
20251005065526,124.481030,45.336521
20251005065536,124.480986,45.336440
20251005065546,124.481018,45.336500
20251005065556,124.481011,45.336490
20251005065606,124.480990,45.336451
20251005065616,124.480971,45.336422
20251005065626,124.481022,45.336401
20251005065636,124.480998,45.336416
20251005065646,124.481011,45.336430
20251005065656,124.481050,45.336497
20251005065706,124.481078,45.336546
20251005065716,124.481120,45.336622
20251005065726,124.481169,45.336708
20251005065736,124.481210,45.336778
20251005065746,124.481251,45.336855
20251005065756,124.481294,45.336939
20251005065806,124.481342,45.337024
20251005065816,124.481388,45.337112
20251005065826,124.481433,45.337201
20251005065836,124.481456,45.337242
20251005065846,124.481499,45.337322
20251005065856,124.481539,45.337397
20251005065906,124.481576,45.337467
20251005065916,124.481623,45.337550
20251005065926,124.481662,45.337629
20251005065936,124.481700,45.337707
20251005065946,124.481742,45.337787
20251005065956,124.481780,45.337865
20251005070006,124.481824,45.337951
20251005070016,124.481871,45.338041
20251005070026,124.481906,45.338104
20251005070036,124.481944,45.338179
20251005070046,124.481993,45.338273
20251005070056,124.482038,45.338364
20251005070106,124.482069,45.338427
20251005070116,124.482035,45.338359
20251005070126,124.482030,45.338348
20251005070136,124.482031,45.338348
20251005070146,124.482031,45.338348
20251005070156,124.482031,45.338349
20251005070206,124.482031,45.338349
20251005070216,124.482075,45.338439
20251005070226,124.482108,45.338499
20251005070236,124.482157,45.338579
20251005070246,124.482206,45.338666
20251005070256,124.482251,45.338749
20251005070306,124.482293,45.338821
20251005070316,124.482330,45.338886
20251005070326,124.482360,45.338938
20251005070336,124.482404,45.339020
20251005070346,124.482438,45.339081
20251005070356,124.482470,45.339136
20251005070406,124.482519,45.339225
20251005070416,124.482566,45.339309
20251005070426,124.482610,45.339394
20251005070436,124.482635,45.339441
20251005070446,124.482612,45.339398
20251005070456,124.482651,45.339431
20251005070506,124.482677,45.339449
20251005070516,124.482690,45.339466
20251005070526,124.482676,45.339497
20251005070536,124.482676,45.339497
20251005070801,124.482671,45.339413
20251005070811,124.482634,45.339337
20251005070821,124.482593,45.339260
20251005070831,124.482546,45.339177
20251005070841,124.482495,45.339087
20251005070851,124.482447,45.339000
20251005070901,124.482413,45.338936
20251005070911,124.482373,45.338865
20251005070921,124.482328,45.338790
20251005070931,124.482284,45.338710
20251005070941,124.482242,45.338635
20251005070951,124.482234,45.338622
20251005071001,124.482243,45.338704
20251005071011,124.482243,45.338704
20251005071021,124.482243,45.338704
20251005071031,124.482243,45.338703
20251005071041,124.482243,45.338703
20251005071051,124.482226,45.338615
20251005071101,124.482187,45.338539
20251005071111,124.482158,45.338490
20251005071121,124.482116,45.338419
20251005071131,124.482081,45.338349
20251005071141,124.482044,45.338269
20251005071151,124.482009,45.338196
20251005071201,124.481967,45.338115
20251005071211,124.481937,45.338060
20251005071221,124.481892,45.337978
20251005071231,124.481848,45.337897
20251005071241,124.481808,45.337816
20251005071251,124.481772,45.337743
20251005071301,124.481746,45.337692
20251005071311,124.481712,45.337624
20251005071321,124.481672,45.337546
20251005071331,124.481653,45.337501
20251005071341,124.481644,45.337535
20251005071351,124.481601,45.337482
20251005071401,124.481638,45.337549
20251005071411,124.481587,45.337435
20251005071421,124.481573,45.337361
20251005071431,124.481560,45.337335
20251005071441,124.481564,45.337342
20251005071451,124.481564,45.337342
20251005071501,124.481564,45.337342
20251005071511,124.481564,45.337342
20251005071521,124.481564,45.337342
20251005071531,124.481564,45.337342
20251005072027,124.481434,45.337101
20251005072037,124.481397,45.337030
20251005072047,124.481356,45.336952
20251005072057,124.481315,45.336876
20251005072107,124.481272,45.336796
20251005072117,124.481230,45.336718
20251005072127,124.481181,45.336633
20251005072137,124.481136,45.336551
20251005072147,124.481106,45.336496
20251005072157,124.481057,45.336419
20251005072207,124.481071,45.336441
20251005072217,124.481052,45.336397
20251005072227,124.481099,45.336378
20251005072237,124.481146,45.336367
20251005072247,124.481146,45.336368
20251005072257,124.481086,45.336378
20251005072307,124.481073,45.336403
20251005072317,124.481121,45.336470
20251005072327,124.481171,45.336557
20251005072337,124.481222,45.336646
20251005072347,124.481266,45.336725
20251005072357,124.481308,45.336802
20251005072407,124.481347,45.336876
20251005072417,124.481390,45.336954
20251005072427,124.481435,45.337041
20251005072437,124.481478,45.337123
20251005072447,124.481424,45.337018
20251005072457,124.481424,45.337018
20251005072507,124.481424,45.337018
20251005072517,124.481424,45.337018
20251005072527,124.481424,45.337018
20251005072537,124.481424,45.337018
20251005072547,124.481424,45.337019
20251005072557,124.481424,45.337019
20251005072607,124.481428,45.337027
20251005072617,124.481491,45.337148
20251005072627,124.481536,45.337232
20251005072637,124.481585,45.337322
20251005072647,124.481630,45.337403
20251005072657,124.481651,45.337441
20251005072707,124.481594,45.337371
20251005072717,124.481628,45.337443
20251005072727,124.481600,45.337405
20251005072737,124.481659,45.337453
20251005072747,124.481697,45.337532
20251005072757,124.481731,45.337596
20251005072807,124.481719,45.337589
20251005072817,124.481751,45.337690
20251005072827,124.481810,45.337765
20251005072837,124.481861,45.337856
20251005072847,124.481910,45.337948
20251005072857,124.481959,45.338041
20251005072907,124.482012,45.338139
20251005072917,124.482061,45.338237
20251005072927,124.482110,45.338342
20251005072937,124.482156,45.338433
20251005072947,124.482209,45.338520
20251005072957,124.482266,45.338620
20251005073007,124.482299,45.338677
20251005073017,124.482340,45.338753
20251005073027,124.482388,45.338835
20251005073037,124.482441,45.338928
20251005073047,124.482463,45.338970
20251005073057,124.482507,45.339048
20251005073107,124.482556,45.339135
20251005073117,124.482605,45.339225
20251005073127,124.482658,45.339321
20251005073137,124.482685,45.339370
20251005073147,124.482646,45.339309
20251005073157,124.482646,45.339309
20251005073207,124.482646,45.339309
20251005073217,124.482646,45.339309
20251005073227,124.482646,45.339309
20251005073237,124.482646,45.339310
20251005073247,124.482646,45.339310
20251005073257,124.482651,45.339327
20251005073307,124.482658,45.339359
20251005073317,124.482658,45.339359
20251005073327,124.482671,45.339380
20251005073337,124.482728,45.339404
20251005073347,124.482755,45.339403
20251005073357,124.482711,45.339449
20251005074013,124.482699,45.339309
20251005074023,124.482665,45.339234
20251005074033,124.482629,45.339161
20251005074043,124.482597,45.339097
20251005074053,124.482553,45.339022
20251005074103,124.482511,45.338946
20251005074113,124.482490,45.338905
20251005074123,124.482451,45.338829
20251005074133,124.482408,45.338751
20251005074143,124.482362,45.338670
20251005074153,124.482326,45.338601
20251005074203,124.482282,45.338520
20251005074213,124.482243,45.338456
20251005074223,124.482191,45.338377
20251005074233,124.482152,45.338295
20251005074243,124.482114,45.338215
20251005074253,124.482071,45.338129
20251005074303,124.482022,45.338041
20251005074313,124.481972,45.337948
20251005074323,124.481922,45.337854
20251005074333,124.481923,45.337862
20251005074343,124.481874,45.337800
20251005074353,124.481857,45.337762
20251005074403,124.481896,45.337857
20251005074413,124.481839,45.337739
20251005074423,124.481817,45.337684
20251005074433,124.481831,45.337752
20251005074443,124.481821,45.337775
20251005074453,124.481724,45.337679
20251005074503,124.481758,45.337568
20251005074513,124.481729,45.337490
20251005074523,124.481682,45.337404
20251005074533,124.481633,45.337313
20251005074543,124.481581,45.337219
20251005074553,124.481533,45.337127
20251005074603,124.481485,45.337036
20251005074613,124.481439,45.336947
20251005074623,124.481390,45.336856
20251005074633,124.481340,45.336762
20251005074643,124.481289,45.336671
20251005074653,124.481255,45.336608
20251005074703,124.481276,45.336742
20251005074713,124.481275,45.336742
20251005074723,124.481275,45.336742
20251005074733,124.481275,45.336742
20251005074743,124.481275,45.336742
20251005074753,124.481279,45.336664
20251005074803,124.481225,45.336558
20251005074813,124.481176,45.336473
20251005074823,124.481139,45.336413
20251005074833,124.481124,45.336400
20251005074843,124.481147,45.336357
20251005074853,124.481111,45.336362
20251005074903,124.481168,45.336409
20251005074913,124.481174,45.336414
20251005074923,124.481174,45.336414
20251005074933,124.481212,45.336477
20251005074943,124.481257,45.336555
20251005074953,124.481307,45.336640
20251005075003,124.481357,45.336727
20251005075013,124.481399,45.336808
20251005075023,124.481445,45.336893
20251005075033,124.481485,45.336970
20251005075043,124.481482,45.336962
20251005075053,124.481501,45.337002
20251005075103,124.481543,45.337082
20251005075113,124.481583,45.337159
20251005075123,124.481629,45.337243
20251005075133,124.481679,45.337333
20251005075143,124.481730,45.337425
20251005075153,124.481781,45.337522
20251005075203,124.481811,45.337576
20251005075213,124.481841,45.337635
20251005075223,124.481884,45.337721
20251005075233,124.481867,45.337683
20251005075243,124.481813,45.337586
20251005075253,124.481765,45.337516
20251005075303,124.481791,45.337624
20251005075313,124.481765,45.337577
20251005075323,124.481784,45.337639
20251005075333,124.481795,45.337591
20251005075343,124.481851,45.337708
20251005075353,124.481837,45.337657
20251005075403,124.481811,45.337642
20251005075413,124.481833,45.337645
20251005075423,124.481841,45.337797
20251005075433,124.481890,45.337817
20251005075443,124.481968,45.337895
20251005075453,124.482019,45.337987
20251005075503,124.482057,45.338057
20251005075513,124.482102,45.338146
20251005075523,124.482152,45.338251
20251005075533,124.482198,45.338348
20251005075543,124.482241,45.338426
20251005075553,124.482299,45.338519
20251005075603,124.482347,45.338606
20251005075613,124.482389,45.338679
20251005075623,124.482434,45.338757
20251005075633,124.482484,45.338844
20251005075643,124.482532,45.338933
20251005075653,124.482583,45.339026
20251005075703,124.482638,45.339125
20251005075713,124.482690,45.339218
20251005075723,124.482737,45.339306
20251005075733,124.482699,45.339235
20251005075743,124.482700,45.339236
20251005075753,124.482700,45.339236
20251005075803,124.482700,45.339236
20251005075813,124.482700,45.339236
20251005075823,124.482700,45.339236
20251005075833,124.482704,45.339246
20251005075843,124.482735,45.339306
20251005075853,124.482735,45.339307
20251005075903,124.482751,45.339321
20251005075913,124.482780,45.339334
20251005075923,124.482779,45.339330
20251005082034,124.482727,45.339160
20251005082044,124.482680,45.339079
20251005082054,124.482657,45.339036
20251005082104,124.482624,45.338981
20251005082114,124.482581,45.338900
20251005082124,124.482541,45.338829
20251005082134,124.482501,45.338758
20251005082144,124.482457,45.338683
20251005082154,124.482413,45.338606
20251005082204,124.482377,45.338540
20251005082214,124.482328,45.338450
20251005082224,124.482279,45.338372
20251005082234,124.482242,45.338297
20251005082244,124.482208,45.338218
20251005082254,124.482164,45.338129
20251005082304,124.482135,45.338070
20251005082314,124.482100,45.337999
20251005082324,124.482060,45.337926
20251005082334,124.482016,45.337843
20251005082344,124.481993,45.337794
20251005082354,124.481984,45.337775
20251005082404,124.481987,45.337826
20251005082414,124.481953,45.337765
20251005082424,124.481962,45.337783
20251005082434,124.481972,45.337756
20251005082444,124.481945,45.337696
20251005082454,124.481925,45.337658
20251005082504,124.481884,45.337584
20251005082514,124.481841,45.337494
20251005082524,124.481788,45.337399
20251005082534,124.481732,45.337296
20251005082544,124.481675,45.337189
20251005082554,124.481646,45.337134
20251005082604,124.481679,45.337187
20251005082614,124.481649,45.337120
20251005082625,124.481666,45.337187
20251005082635,124.481591,45.337095
20251005082645,124.481581,45.337024
20251005082655,124.481542,45.336936
20251005082705,124.481504,45.336860
20251005082715,124.481462,45.336779
20251005082725,124.481413,45.336688
20251005082735,124.481358,45.336592
20251005082745,124.481335,45.336547
20251005082755,124.481338,45.336553
20251005082805,124.481347,45.336676
20251005082815,124.481347,45.336676
20251005082825,124.481343,45.336675
20251005082835,124.481343,45.336674
20251005082845,124.481343,45.336673
20251005082855,124.481337,45.336646
20251005082905,124.481314,45.336534
20251005082915,124.481269,45.336443
20251005082925,124.481226,45.336367
20251005082935,124.481280,45.336446
20251005082945,124.481214,45.336305
20251005082955,124.481215,45.336416
20251005083005,124.481226,45.336422
20251005083015,124.481290,45.336464
20251005083025,124.481313,45.336498
20251005083035,124.481384,45.336609
20251005083045,124.481450,45.336721
20251005083055,124.481507,45.336829
20251005083105,124.481567,45.336945
20251005083115,124.481623,45.337054
20251005083125,124.481613,45.337038
20251005083135,124.481582,45.337097
20251005083145,124.481663,45.337157
20251005083155,124.481697,45.337193
20251005083205,124.481706,45.337217
20251005083215,124.481718,45.337236
20251005083225,124.481780,45.337346
20251005083235,124.481839,45.337452
20251005083245,124.481899,45.337574
20251005083255,124.481918,45.337611
20251005083305,124.481916,45.337608
20251005083315,124.481888,45.337603
20251005083325,124.481942,45.337660
20251005083335,124.481936,45.337649
20251005083345,124.481951,45.337691
20251005083355,124.482012,45.337799
20251005083405,124.482055,45.337883
20251005083415,124.482127,45.338011
20251005083425,124.482194,45.338144
20251005083435,124.482257,45.338273
20251005083445,124.482309,45.338388
20251005083455,124.482388,45.338510
20251005083505,124.482458,45.338633
20251005083515,124.482537,45.338768
20251005083525,124.482614,45.338912
20251005083535,124.482678,45.339026
20251005083545,124.482719,45.339099
20251005083555,124.482784,45.339212
20251005083605,124.482827,45.339293
20251005083615,124.482776,45.339207
20251005083625,124.482779,45.339206
20251005083635,124.482783,45.339206
20251005083645,124.482781,45.339207
20251005083655,124.482780,45.339206
20251005083704,124.482778,45.339204
20251005083714,124.482776,45.339203
20251005083724,124.482787,45.339337
20251005084211,124.482177,45.340309
20251005084221,124.481979,45.340570
20251005084231,124.481960,45.340751
20251005084241,124.482089,45.340929
20251005084251,124.482300,45.341098
20251005084301,124.482588,45.341167
20251005084311,124.482956,45.340973
20251005084321,124.483249,45.340848
20251005084331,124.483422,45.340887
20251005084341,124.483801,45.340943
20251005084351,124.484241,45.340956
20251005084401,124.484660,45.340889
20251005084411,124.485076,45.340814
20251005084421,124.485503,45.340825
20251005084431,124.485899,45.340969
20251005084441,124.486241,45.341140
20251005084451,124.486386,45.341230
20251005084501,124.486816,45.341489
20251005084511,124.487368,45.341774
20251005084521,124.488019,45.342091
20251005084531,124.488742,45.342407
20251005084541,124.489540,45.342743
20251005084551,124.490077,45.343100
20251005084601,124.490628,45.343495
20251005084611,124.491196,45.343951
20251005084621,124.491773,45.344479
20251005084631,124.491996,45.344665
20251005084641,124.492699,45.344993
20251005084651,124.493614,45.345395
20251005084701,124.494504,45.345782
20251005084711,124.495389,45.346173
20251005084721,124.496215,45.346533
20251005084731,124.496913,45.346840
20251005084741,124.497293,45.346812
20251005084751,124.497809,45.346415
20251005084801,124.498221,45.346053
20251005084811,124.498868,45.345265
20251005084821,124.499345,45.344694
20251005084831,124.499570,45.344453
20251005084841,124.500174,45.343811
20251005084851,124.500282,45.343675
20251005084901,124.500333,45.343620
20251005084911,124.500429,45.343543
20251005084921,124.500865,45.343085
20251005084931,124.501137,45.342763
20251005084941,124.501511,45.342725
20251005084951,124.501911,45.342585
20251005085001,124.502207,45.342403
20251005085011,124.502486,45.342163
20251005085021,124.502792,45.341727
20251005085031,124.503161,45.341713
20251005085041,124.503952,45.341946
20251005153234,124.504474,45.342040
20251005153244,124.504471,45.342047
20251005153254,124.504447,45.342116
20251005153304,124.504510,45.342231</textarea>
            <div class="button-group">
                <button id="drawTrackButton" disabled style="flex: 1;">绘制轨迹</button>
                <button id="showTrackPointsButton" disabled style="flex: 1;" class="btn-warning">打点</button>
                <button id="clearTrackButton" disabled style="flex: 1;">清空轨迹</button>
            </div>
            <!-- 回放控制 -->
            <div class="split-section" style="margin-top:8px;">
                <div class="title">轨迹回放</div>
                <div class="playback-actions" style="display:flex;gap:8px;margin-bottom:8px;">
                    <button id="playbackStartBtn" disabled>开始</button>
                    <button id="playbackPauseBtn" disabled>继续</button>
                    <button id="playbackStopBtn" disabled>结束</button>
                </div>
                <div class="playback-speed" style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                    <label>速度：
                        <select id="playbackSpeedSelect" disabled>
                            <option value="1" selected>1×</option>
                            <option value="2">2×</option>
                            <option value="4">4×</option>
                            <option value="8">8×</option>
                            <option value="16">16×</option>
                            <option value="32">32×</option>
                            <option value="64">64×</option>
                            <option value="128">128×</option>
                            <option value="256">256×</option>
                            <option value="512">512×</option>
                            <option value="1024">1024×</option>
                        </select>
                    </label>
                    <span id="playbackTimeLabel" style="font-size:12px;color:#666;">时间：—</span>
                </div>
                <div class="playback-time" style="display:flex;flex-direction:column;gap:4px;margin-bottom:8px;">
                    <label class="playback-time-label" style="display:flex;align-items:center;gap:8px;flex:1 1 auto;min-width:0;">
                        <span class="playback-time-text" style="white-space:nowrap;">起始时间：</span>
                        <input type="range" id="playbackTimeSlider" disabled min="0" max="0" step="1000" value="0" style="flex:1 1 auto;min-width:0;max-width:100%;vertical-align:middle;">
                    </label>
                    <span id="playbackTimeCursor" style="font-size:12px;color:#666;align-self:flex-end;">—</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let map;
    let currentPolygons = []; // 存储多边形和其标签
    let currentTracks = []; // 存储轨迹折线及相关覆盖物
    let mapLoaded = false;
    let mapLabelHandlers = []; // 存储地图事件处理器
    let labelsEnabled = false; // 标签显示开关（默认关闭）
    let isDrawing = false; // 绘制进行中防止重复点击

    window.onload = function () {
        if (typeof T === 'undefined') {
            alert("天地图API加载失败，请检查网络或密钥！");
            return;
        }
        initMap();
        bindDrawEvent();
        bindMinimizeEvent();
        bindTabs();
        bindBatchGenerator();
        bindMultiSplitter();
        bindLabelsToggle(); // 绑定标签显示开关
        bindTrackEvents();  // 绑定轨迹绘制与清空
        bindPlaybackControls(); // 绑定轨迹回放
    };

    function initMap() {
        showLoading();
        disableButtons(true);

        try {
            map = new T.Map("mapContainer", {
                zoom: 12,
                center: new T.LngLat(116.40769, 39.90403)
            });

            // 已移除测试标签
            map.enableScrollWheelZoom();

            // 添加地图类型控件
            const mapTypeCtrl = new T.Control.MapType({
                mapTypes: [TMAP_NORMAL_MAP, TMAP_SATELLITE_MAP, TMAP_TERRAIN_MAP],
                position: T_ANCHOR_TOP_LEFT
            });
            map.addControl(mapTypeCtrl);

            // 加载影像底图（卫星）
            const tk = "648f621977051d0199ff0f965d3fd322";

            // 方案1：使用默认地图类型（作为备选）
            map.setMapType(TMAP_SATELLITE_MAP);

            // 方案2：手动添加影像图层（底图 + 标注）
            const vecLayer = new T.TileLayer(`https://t0.tianditu.gov.cn/img_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=img&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`);
            const cvaLayer = new T.TileLayer(`https://t0.tianditu.gov.cn/cia_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cia&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`);

            // 添加图层并监听加载状态
            vecLayer.addEventListener("load", function () {
                console.log("影像底图加载完成");
            });

            vecLayer.addEventListener("error", function (e) {
                console.error("影像底图加载错误:", e);
                alert("影像底图加载错误，将使用默认地图类型");
            });

            map.addLayer(vecLayer);
            map.addLayer(cvaLayer);

            // 监听地图加载事件
            map.addEventListener("loaded", function () {
                console.log("地图加载完成");
                markMapLoaded();
            });
            map.addEventListener("load", function () {
                console.log("地图load事件触发");
                markMapLoaded();
            });
            map.addEventListener("tilesloaded", function () {
                console.log("地图瓦片加载完成");
                markMapLoaded();
            });
            // 监听地图加载失败事件
            map.addEventListener("error", function (e) {
                console.error("地图加载错误:", e);
                alert("地图加载错误: " + e.message);
                hideLoading();
            });

            // 监听地图移动事件，用于更新标签位置
            const moveHandler = function () {
                updateAllLabelsPosition();
            };
            map.addEventListener("move", moveHandler);
            map.addEventListener("zoom", moveHandler);

            // 存储事件处理器，用于清理
            mapLabelHandlers.push({ event: "move", handler: moveHandler });
            mapLabelHandlers.push({ event: "zoom", handler: moveHandler });

            // 超时容错
            setTimeout(() => {
                if (!mapLoaded) markMapLoaded();
            }, 8000);

        } catch (error) {
            alert("地图初始化失败：" + error.message);
            console.error(error);
            hideLoading();
        }
    }

    function markMapLoaded() {
        if (!mapLoaded) {
            mapLoaded = true;
            hideLoading();
            disableButtons(false);
            disableTrackButtons(false);
            // 仅开启速度选择，回放按钮按状态控制
            const speedSel = document.getElementById('playbackSpeedSelect');
            if (speedSel) speedSel.disabled = false;
            updatePlaybackButtonsState('idle');
        }
    }

    function showLoading() {
        const loading = document.getElementById("mapLoading");
        loading.style.display = "flex";
        loading.style.opacity = "1";
    }

    function hideLoading() {
        const loading = document.getElementById("mapLoading");
        loading.style.opacity = "0";
        setTimeout(() => loading.style.display = "none", 300);
    }

    function disableButtons(disabled) {
        document.getElementById("drawButton").disabled = disabled;
        document.getElementById("clearButton").disabled = disabled;
    }

    function disableTrackButtons(disabled) {
        const drawTrackBtn = document.getElementById("drawTrackButton");
        const showTrackPointsBtn = document.getElementById("showTrackPointsButton");
        const clearTrackBtn = document.getElementById("clearTrackButton");
        if (drawTrackBtn) drawTrackBtn.disabled = disabled;
        if (showTrackPointsBtn) showTrackPointsBtn.disabled = disabled;
        if (clearTrackBtn) clearTrackBtn.disabled = disabled;
    }
    // 回放控件的禁用/启用
    function disablePlaybackButtons(disabled) {
        ["playbackStartBtn","playbackPauseBtn","playbackStopBtn","playbackSpeedSelect","playbackTimeSlider"].forEach(id=>{
            const el = document.getElementById(id);
            if (el) el.disabled = disabled;
        });
    }

    // 回放按钮状态管理：空闲/播放/暂停
    function updatePlaybackButtonsState(state){
        try {
            const startBtn = document.getElementById('playbackStartBtn');
            const pauseBtn = document.getElementById('playbackPauseBtn');
            const stopBtn = document.getElementById('playbackStopBtn');
            if (!startBtn || !pauseBtn || !stopBtn) return;
            if (state === 'idle') {
                startBtn.disabled = false;
                pauseBtn.disabled = true;
                stopBtn.disabled = true;
                pauseBtn.textContent = '继续';
            } else if (state === 'playing') {
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
                pauseBtn.textContent = '暂停';
            } else if (state === 'paused') {
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
                pauseBtn.textContent = '继续';
            }
        } catch(e) { console.warn('更新按钮状态失败:', e); }
    }

    function bindDrawEvent() {
        document.getElementById("drawButton").addEventListener("click", function () {
            if (isDrawing) { console.log('绘制进行中，忽略重复点击'); return; }
            isDrawing = true;
            disableButtons(true);
            showLoading();
            try {
                const wktStr = document.getElementById("wktTextarea").value.trim();
                if (!wktStr) { alert("请输入WKT字符串！"); return; }
                clearOverlays();
                const geojson = parseWkt(wktStr);
    
                const polygonData = [];
                if (geojson.type === "Polygon") {
                    polygonData.push({ index: 1, coordinates: geojson.coordinates });
                } else if (geojson.type === "MultiPolygon") {
                    geojson.coordinates.forEach((polygon, index) => {
                        polygonData.push({ index: index + 1, coordinates: polygon });
                    });
                }
    
                // 重置并绘制
                polygonInfoList = [];
                polygonData.forEach(pd => processPolygon(pd.index, pd.coordinates));
    
                // 视图居中到所有已绘制轮廓
                try { fitViewportToPolygons(); } catch (e) { console.warn('视图居中失败', e); }
    
                // 在视图稳定后再创建/更新标签
                setTimeout(() => {
                    if (labelsEnabled) {
                        try {
                            createAllLabels();
                            updateAllLabelsPosition();
                        } catch (e) {
                            console.warn('创建或更新标签失败:', e);
                        }
                    }
                }, 150);
            } catch (e) {
                alert('绘制失败：' + (e && e.message ? e.message : e));
                console.error('绘制异常:', e);
            } finally {
                hideLoading();
                isDrawing = false;
                disableButtons(false);
            }
        });

        document.getElementById("clearButton").addEventListener("click", function () {
            if (isDrawing) { console.log('绘制进行中，暂不清空'); return; }
            clearOverlays();
            console.log("已清空所有轮廓");
        });
    }

    // 存储多边形数据，用于后续标签创建
    let polygonInfoList = [];

    // 处理单个多边形的绘制和面积计算
    function processPolygon(actualPolygonIndex, polygonCoords) {
        console.log('开始处理多边形', actualPolygonIndex);

        // 坐标系选择（绘制始终使用WGS84坐标）
        const coordSys = (document.getElementById('coordSysSelect') && document.getElementById('coordSysSelect').value) || 'wgs84';

        // 统一转换为WGS84用于绘制与面积计算
        function toWgs(point){
            const lng = point[0], lat = point[1];
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                return [lng, lat];
            } else if (coordSys === 'gcj02') {
                const w = gcj02ToWgs84(lng, lat);
                return [w.lng, w.lat];
            } else if (coordSys === 'bd09') {
                const gcj = bd09ToGcj02(lng, lat);
                const w = gcj02ToWgs84(gcj.lng, gcj.lat);
                return [w.lng, w.lat];
            }
            return [lng, lat];
        }
        const coordsWGS84 = polygonCoords.map(ring => ring.map(toWgs));
        let outerRingWGS = coordsWGS84[0] || [];

        // 生成用于绘制的坐标（直接使用WGS84坐标）
        const rings = coordsWGS84.map(ring => ring.map(([lng, lat]) => new T.LngLat(lng, lat)));


         // 创建半透明填充的多边形（无边框）
          const polygon = new T.Polygon(rings, {
              color: "#FFD700",
              weight: 1,
              opacity: 1,
              fillColor: "#FFFF00",
              fillOpacity: 0.35
          });
 
          // 使用WGS84坐标计算面积（更准确的面积计算）
         let areaSqm;
         let areaMu;



         try {
             // 检查Turf.js是否可用
             if (typeof turf !== 'undefined' && turf.area) {
                 // 使用Turf.js计算多边形面积
                // 构造GeoJSON格式的多边形
                const geoJsonPolygon = {
                    type: "Polygon",
                    coordinates: coordsWGS84
                };


                 // 使用Turf.js计算面积（平方米）
                 areaSqm = turf.area(geoJsonPolygon);
                 areaMu = (areaSqm / 666.6667).toFixed(4); // 转换为亩
                 console.log(`多边形${actualPolygonIndex}面积计算结果(Turf.js): ${areaSqm}平方米 = ${areaMu}亩`);
             } else {
                 // 如果Turf.js不可用，回退到之前的计算方法
                 console.warn('Turf.js不可用，使用备用计算方法');
                 // 计算带孔洞的多边形面积
                 areaSqm = 0;
                 // 计算外环面积
                 outerRingWGS = coordsWGS84[0] || [];
                 areaSqm += calculatePolygonArea(outerRingWGS);

                 // 减去内环（孔洞）面积
                 for (let i = 1; i < coordsWGS84.length; i++) {
                     const innerRingArea = calculatePolygonArea(coordsWGS84[i]);
                     areaSqm -= innerRingArea;
                 }

                  areaMu = (areaSqm / 666.6667).toFixed(4); // 使用更精确的转换系数
                  console.log(`多边形${actualPolygonIndex}面积计算结果(备用): ${areaSqm}平方米 = ${areaMu}亩`);
              }
          } catch (error) {
              console.error(`面积计算失败:`, error);
              areaSqm = 0;
              areaMu = '0.0000';
          }

          // 计算多边形的中心点和底部中心点（WGS84）
          const centerPoint = calculatePolygonCenter(outerRingWGS);
          const bottomCenterPoint = calculatePolygonBottomCenter(outerRingWGS);

          // 添加多边形到地图
          if (map) {
              map.addOverLay(polygon);
              console.log(`多边形${actualPolygonIndex}已添加到地图`);
          } else {
              console.error('地图对象不存在');
          }

          // 存储多边形信息，用于后续标签创建
          polygonInfoList.push({
              index: actualPolygonIndex,
              polygon: polygon,
              area: areaMu,
              bottomCenter: { lng: bottomCenterPoint.lng, lat: bottomCenterPoint.lat },
              ringPoints: rings
          });
      }

    // 视图居中：根据已绘制的GCJ-02点
    function fitViewportToPolygons() {
        const points = [];
        try {
            if (!map || !map.setViewport) return;
            polygonInfoList.forEach(info => {
                if (!info || !info.ringPoints) return;
                info.ringPoints.forEach(ring => {
                    ring.forEach(ll => points.push(ll));
                });
            });
            if (!points.length) return;
            map.setViewport(points);
        } catch (e) {
            try {
                const lngs = points.map(p => p.lng);
                const lats = points.map(p => p.lat);
                const center = new T.LngLat(
                    (Math.min(...lngs) + Math.max(...lngs)) / 2,
                    (Math.min(...lats) + Math.max(...lats)) / 2
                );
                if (map && map.panTo) map.panTo(center);
            } catch (e2) {
                console.warn('视图居中失败:', e2);
            }
        }
    }

    // 统一创建所有多边形的标签
    function createAllLabels() {
        const mapContainer = document.getElementById('mapContainer');
        if (!mapContainer || !map) return;

        polygonInfoList.forEach(info => {
            if (!info) return;
            // 防止重复创建
            if (info.labelRef) return;
            // 创建标签元素
            const labelDiv = document.createElement('div');
            labelDiv.className = 'area-label';
            labelDiv.innerHTML = `多边形${info.index}：${info.area}亩`;

            // 添加到地图容器并根据屏幕边界定位到轮廓下方
            mapContainer.appendChild(labelDiv);
            positionLabelForPolygon(labelDiv, info);

            // 记录引用，避免重复创建
            info.labelRef = labelDiv;

            // 存储到 currentPolygons 以复用现有定位/清理逻辑
            const labelObj = {
                domElement: labelDiv,
                isDomLabel: true,
                polygonInfo: info
            };
            currentPolygons.push({ polygon: info.polygon, label: labelObj });
        });

        // 不清空 polygonInfoList，便于开关随时创建/隐藏标签
    }

    // 根据多边形屏幕边界定位标签，保证始终在轮廓下方
    function positionLabelForPolygon(labelDiv, info) {
        if (!map || !info || !info.ringPoints) return;
        const points = [];
        info.ringPoints.forEach(ring => {
            ring.forEach(ll => {
                const p = map.lngLatToContainerPoint(ll);
                points.push(p);
            });
        });
        if (!points.length) return;
        const minX = Math.min(...points.map(p => p.x));
        const maxX = Math.max(...points.map(p => p.x));
        const maxY = Math.max(...points.map(p => p.y));
        const container = document.getElementById('mapContainer');
        const labelWidth = labelDiv.offsetWidth;
        const labelHeight = labelDiv.offsetHeight;
        const targetLeft = Math.round((minX + maxX) / 2 - labelWidth / 2);
        const targetTop = Math.round(maxY + 6);
        const clampedLeft = Math.max(0, Math.min(targetLeft, container.clientWidth - labelWidth));
        const clampedTop = Math.max(0, Math.min(targetTop, container.clientHeight - labelHeight));
        labelDiv.style.left = clampedLeft + 'px';
        labelDiv.style.top = clampedTop + 'px';
    }

    // 更新所有标签位置（地图move/zoom时调用）
    function updateAllLabelsPosition() {
        try {
            if (!map) return;
            const container = document.getElementById('mapContainer');
            if (!container) return;
            currentPolygons.forEach(item => {
                if (!item || !item.label) return;
                const labelObj = item.label;
                if (labelObj.isDomLabel && labelObj.domElement && labelObj.polygonInfo) {
                    // 确保标签在容器中
                    if (!labelObj.domElement.parentNode) {
                        container.appendChild(labelObj.domElement);
                    }
                    positionLabelForPolygon(labelObj.domElement, labelObj.polygonInfo);
                }
            });
        } catch (e) {
            console.warn('更新标签位置时出错:', e);
        }
    }
    // 确保在全局可用（处理第三方库事件回调作用域差异）
    window.updateAllLabelsPosition = updateAllLabelsPosition;

    // 绑定“显示亩数标签”开关（默认隐藏）
    function bindLabelsToggle() {
        const cb = document.getElementById('toggleLabelsCheckbox');
        const container = document.getElementById('mapContainer');
        if (!cb || !container) return;
        // 默认隐藏标签
        container.classList.add('labels-hidden');
        cb.addEventListener('change', () => {
            labelsEnabled = cb.checked;
            if (labelsEnabled) {
                container.classList.remove('labels-hidden');
                const hasAnyLabel = currentPolygons.some(item => item && item.label && item.label.domElement);
                if (!hasAnyLabel) {
                    try { createAllLabels(); } catch (e) { console.warn('创建标签失败:', e); }
                }
                updateAllLabelsPosition();
            } else {
                container.classList.add('labels-hidden');
            }
        });
    }

    /**
     * 计算多边形中心点（比底部中心更适合显示标签）
     */
    function calculatePolygonCenter(outerRing) {
        let sumLng = 0, sumLat = 0;
        const len = outerRing.length;

        for (let i = 0; i < len; i++) {
            sumLng += outerRing[i][0];
            sumLat += outerRing[i][1];
        }

        return {
            lng: sumLng / len,
            lat: sumLat / len
        };
    }

    /**
     * 计算多边形面积（球面多边形面积计算）
     * 使用更准确的球面坐标面积计算方法，确保面积与视觉大小一致
     */
    function calculatePolygonArea(coordinates) {
        // 地球半径（米）- 使用更精确的值
        const R = 6371000.8;
        const n = coordinates.length;

        // 将所有坐标转换为弧度
        const coordsRad = coordinates.map(point => [
            point[0] * Math.PI / 180,
            point[1] * Math.PI / 180
        ]);

        let areaRad = 0;

        // 使用更准确的球面多边形面积公式（Girard定理）
        for (let i = 0; i < n; i++) {
            const j = (i + 1) % n;
            const lon1 = coordsRad[i][0];
            const lat1 = coordsRad[i][1];
            const lon2 = coordsRad[j][0];
            const lat2 = coordsRad[j][1];

            // 计算球面多边形面积增量
            const dlon = lon2 - lon1;
            const sinLat1 = Math.sin(lat1);
            const sinLat2 = Math.sin(lat2);
            const cosLat1 = Math.cos(lat1);
            const cosLat2 = Math.cos(lat2);

            // 使用更精确的公式
            areaRad += dlon * (sinLat1 * cosLat2 * Math.cos(dlon / 2) + sinLat2 * cosLat1);
        }

        // 计算总面积（平方米）
        const areaSqm = Math.abs(areaRad) * R * R * 0.5;

        return areaSqm;
    }

    /**
     * 清空所有多边形和标签（同时处理 polygonInfoList 与 currentPolygons）
     */
    function clearOverlays() {
        try {
            // 先移除 polygonInfoList 中记录的多边形与其DOM标签
            polygonInfoList.forEach(info => {
                if (info && info.polygon && map && map.removeOverLay) {
                    try { map.removeOverLay(info.polygon); } catch (e) { console.warn('移除多边形失败:', e); }
                }
                if (info && info.labelRef && info.labelRef.parentNode) {
                    try { info.labelRef.parentNode.removeChild(info.labelRef); } catch (e) { console.warn('移除DOM标签失败:', e); }
                    info.labelRef = null;
                }
            });

            // 再处理 currentPolygons（兼容旧路径与标签对象）
            currentPolygons.forEach(item => {
                if (item.polygon && map && map.removeOverLay) {
                    try { map.removeOverLay(item.polygon); } catch (e) { console.warn('移除多边形失败:', e); }
                }
                if (item.label) {
                    if (item.label.domElement && item.label.domElement.parentNode) {
                        try { item.label.domElement.parentNode.removeChild(item.label.domElement); } catch (e) { console.warn('移除DOM标签失败:', e); }
                    } else if (map && map.removeOverLay && !item.label.isDomLabel) {
                        try { map.removeOverLay(item.label); } catch (e) { console.warn('移除地图覆盖物标签失败:', e); }
                    }
                }
            });

            // 清空记录数组
            currentPolygons = [];
            polygonInfoList = [];

            console.log('已清空所有多边形和标签（保留事件监听器）');
        } catch (error) {
            console.error('清空覆盖物时出错:', error);
        }
    }

    // 其他辅助函数（保持不变）
    function bindMinimizeEvent() {
        const container = document.querySelector(".wkt-input-container");
        const btn = document.getElementById("minimizeBtn");
        const minIcon = btn?.querySelector(".min-icon");
        const restoreIcon = btn?.querySelector(".restore-icon");

        btn?.addEventListener("click", () => {
            const minimized = container.classList.toggle("minimized");
            if (minIcon && restoreIcon) {
                if (minimized) {
                    minIcon.style.display = "none";
                    restoreIcon.style.display = "";
                } else {
                    minIcon.style.display = "";
                    restoreIcon.style.display = "none";
                }
            }
        });
    }

    // 在脚本内部补充：页签切换（3个页签）
     function bindTabs() {
         const tabs = [
             { btn: document.getElementById('tabDrawBtn'), pane: document.getElementById('tabDraw'), key: 'draw' },
             { btn: document.getElementById('tabTrackBtn'), pane: document.getElementById('tabTrack'), key: 'track' },
             { btn: document.getElementById('tabSplitBtn'), pane: document.getElementById('tabSplit'), key: 'split' },
             { btn: document.getElementById('tabBatchBtn'), pane: document.getElementById('tabBatch'), key: 'batch' },
         ];
         if (tabs.some(t => !t.btn || !t.pane)) return;
         function activate(key) {
             tabs.forEach(t => {
                 const active = t.key === key;
                 t.btn.classList.toggle('active', active);
                 t.pane.classList.toggle('active', active);
             });
         }
         tabs.forEach(t => t.btn.addEventListener('click', () => activate(t.key)));
         activate('draw');
     }
    function updateParserStatus() {
        const el = document.getElementById('parserStatus');
        if (!el) return;
        const ok = (typeof Terraformer !== 'undefined' && Terraformer.WKT && typeof Terraformer.WKT.parse === 'function');
        if (ok) {
            el.textContent = 'Terraformer WKT Parser';
            el.style.color = '#2f8f2f';
        } else {
            el.textContent = '本地回退解析（仅支持POLYGON/MULTIPOLYGON）';
            el.style.color = '#c77d1e';
        }
    }
     function parseWkt(wkt) {
         wkt = wkt.trim();
         // 优先使用成熟库（Terraformer WKT Parser）
         if (typeof Terraformer !== 'undefined' && Terraformer.WKT && Terraformer.WKT.parse) {
             try {
                 return Terraformer.WKT.parse(wkt);
             } catch (e) {
                 console.warn('Terraformer解析失败，尝试本地回退解析:', e);
             }
         } else {
             // 不再提示“未加载”，由状态栏展示回退信息
         }
         // 回退解析：仅支持 POLYGON / MULTIPOLYGON
         const typeMatch = wkt.match(/^\s*(POLYGON|MULTIPOLYGON)\s*\(/i);
         if (!typeMatch) throw new Error('仅支持POLYGON/MULTIPOLYGON');
         const type = typeMatch[1].toUpperCase();
         const inner = wkt.substring(wkt.indexOf('('));
         if (type === 'POLYGON') {
             const coords = parsePolygonCoords(inner.replace(/^\(/, '').replace(/\)$/, ''));
             return { type: 'Polygon', coordinates: coords };
         } else {
             const trimmed = inner.replace(/^\(\(/, '').replace(/\)\)$/, '');
             const coords = parseMultiPolygonCoords(trimmed);
             return { type: 'MultiPolygon', coordinates: coords };
         }
     }

     function bindMultiSplitter() {
         const input = document.getElementById('multiInput');
         const output = document.getElementById('polyOutput');
         const splitBtn = document.getElementById('splitMultiBtn');
         const copyBtn = document.getElementById('copyPolysBtn');
         if (!input || !output || !splitBtn || !copyBtn) return;

         // 本地WKT序列化辅助
         function ringToText(ring) {
             if (!ring || !ring.length) return '()';
             const first = ring[0];
             const last = ring[ring.length - 1];
             const closed = (first[0] === last[0] && first[1] === last[1]) ? ring : ring.concat([[first[0], first[1]]]);
             return '(' + closed.map(pt => pt[0] + ' ' + pt[1]).join(', ') + ')';
         }
         function toWktPolygonCoords(coords) {
             return 'POLYGON(' + coords.map(ringToText).join(', ') + ')';
         }
         function toWktMulti(coords) {
             return 'MULTIPOLYGON(' + coords.map(poly => '(' + poly.map(ringToText).join(', ') + ')').join(', ') + ')';
         }

         function polygonsFromMulti(text) {
             const geo = parseWkt(text.trim());
             if (geo.type !== 'MultiPolygon') throw new Error('请输入有效的 MULTIPOLYGON WKT');
             const polys = geo.coordinates.map(rings => toWktPolygonCoords(rings));
             return polys;
         }
         splitBtn.addEventListener('click', () => {
             try {
                 const list = polygonsFromMulti(input.value.trim());
                 output.value = list.join('\n');
             } catch (e) {
                 alert('分割失败：' + e.message);
             }
         });
         copyBtn.addEventListener('click', async () => {
             const val = output.value.trim();
             if (!val) { alert('没有可复制的结果'); return; }
             try { await navigator.clipboard.writeText(val); alert('已复制到剪贴板'); } catch (e) { console.warn('复制失败', e); }
         });
     }

     function bindBatchGenerator() {
         const batchInput = document.getElementById('batchInput');
         const output = document.getElementById('multiOutput');
         const genBtn = document.getElementById('generateMultiBtn');
         const copyBtn = document.getElementById('copyMultiBtn');

         // 本地WKT序列化辅助（与分割器保持一致）
         function ringToText(ring) {
             if (!ring || !ring.length) return '()';
             const first = ring[0];
             const last = ring[ring.length - 1];
             const closed = (first[0] === last[0] && first[1] === last[1]) ? ring : ring.concat([[first[0], first[1]]]);
             return '(' + closed.map(pt => pt[0] + ' ' + pt[1]).join(', ') + ')';
         }
         function toWktMulti(coords) {
             return 'MULTIPOLYGON(' + coords.map(poly => '(' + poly.map(ringToText).join(', ') + ')').join(', ') + ')';
         }

         genBtn.addEventListener('click', () => {
             try {
                 const lines = batchInput.value.trim().split(/\n|;/).map(s => s.trim()).filter(Boolean);
                 if (lines.length === 0) throw new Error('请按每行或分号输入至少一个POLYGON');
                 const polygons = lines.map((line, idx) => {
                     const g = parseWkt(line);
                     if (g.type !== 'Polygon') throw new Error(`第${idx + 1}行不是有效的POLYGON WKT`);
                     return g;
                 });
                 const multiGeo = { type: 'MultiPolygon', coordinates: polygons.map(p => p.coordinates) };
                 output.value = toWktMulti(multiGeo.coordinates);
             } catch (e) {
                 alert('生成失败：' + e.message);
             }
         });

         copyBtn.addEventListener('click', async () => {
             const val = output.value.trim();
             if (!val) { alert('没有可复制的结果'); return; }
             try { await navigator.clipboard.writeText(val); alert('已复制到剪贴板'); } catch (e) { console.warn('复制失败', e); }
         });

     }

     function setExampleWkt() {
         const exampleWkt = "MULTIPOLYGON(" +
             "(" +
             "(116.35 39.93, 116.39 39.93, 116.39 39.90, 116.35 39.90, 116.35 39.93)," + // 外环
             "(116.36 39.92, 116.38 39.92, 116.38 39.91, 116.36 39.91, 116.36 39.92)" +  // 内环
             ")," +
             "(" +
             "(116.40 39.95, 116.43 39.97, 116.46 39.96, 116.49 39.98, 116.52 39.95, 116.55 39.93, 116.58 39.94, 116.61 39.92, 116.64 39.95, 116.40 39.95)" +
             ")" +
             ")";
         document.getElementById("wktTextarea").value = exampleWkt;
     }

     function parsePolygonCoords(coordStr) {
         const ringStrs = coordStr.split(/\)\s*,\s*\(/).map(s => s.replace(/[()]/g, '').trim());
         const rings = [];
         ringStrs.forEach(ringStr => {
             const pts = ringStr.split(/,\s*/).map(pointStr => {
                 const [lng, lat] = pointStr.split(/\s+/).map(Number);
                 if (isNaN(lng) || isNaN(lat)) throw new Error("坐标格式错误：" + pointStr);
                 return [lng, lat];
             });
             // 自动拆分：如果一个ring中包含多次回到起点（闭合），则拆分为多个环
             // 兼容用户将外环与内环错误地写在同一对括号中的情况
             let start = 0;
             while (start < pts.length) {
                 const startPt = pts[start];
                 let closeIdx = -1;
                 for (let i = start + 1; i < pts.length; i++) {
                     if (pts[i][0] === startPt[0] && pts[i][1] === startPt[1]) {
                         closeIdx = i;
                         break;
                     }
                 }
                 if (closeIdx === -1) {
                     // 未找到闭合：将剩余点视为一个环，并强制闭合
                     const ring = pts.slice(start);
                     if (ring.length && (ring[0][0] !== ring[ring.length - 1][0] || ring[0][1] !== ring[ring.length - 1][1])) {
                         ring.push([ring[0][0], ring[0][1]]);
                     }
                     rings.push(ring);
                     break;
                 } else {
                     const ring = pts.slice(start, closeIdx + 1);
                     rings.push(ring);
                     start = closeIdx + 1;
                 }
             }
         });
         return rings;
     }

     function parseMultiPolygonCoords(coordStr) {
         const polygonStrs = coordStr.split(/\)\s*\)\s*,\s*\(\s*\(/).map(s => s.replace(/[()]/g, '').trim());
         return polygonStrs.map(polygonStr => parsePolygonCoords(polygonStr));
     }

     function wgs84ToGcj02(lng, lat) {
         const x_PI = 3.14159265358979324 * 3000.0 / 180.0;
         const PI = 3.1415926535897932384626;
         const a = 6378245.0;
         const ee = 0.00669342162296594323;

         if (outOfChina(lng, lat)) return { lng, lat };

         let dlat = transformLat(lng - 105.0, lat - 35.0);
         let dlng = transformLng(lng - 105.0, lat - 35.0);
         const radlat = lat / 180.0 * PI;
         let magic = Math.sin(radlat);
         magic = 1 - ee * magic * magic;
         const sqrtmagic = Math.sqrt(magic);
         dlat = (dlat * 180.0) / ((a * (1 - ee)) / (magic * sqrtmagic) * PI);
         dlng = (dlng * 180.0) / (a / sqrtmagic * Math.cos(radlat) * PI);

         return { lng: lng + dlng, lat: lat + dlat };

         function outOfChina(lng, lat) {
             return (lng < 72.004 || lng > 137.8347) || (lat < 0.8293 || lat > 55.8271);
         }

         function transformLat(x, y) {
             let ret = -100.0 + 2.0 * x + 3.0 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * Math.sqrt(Math.abs(x));
             ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
             ret += (20.0 * Math.sin(y * PI) + 40.0 * Math.sin(y / 3.0 * PI)) * 2.0 / 3.0;
             ret += (160.0 * Math.sin(y / 12.0 * PI) + 320 * Math.sin(y * PI / 30.0)) * 2.0 / 3.0;
             return ret;
         }

         function transformLng(x, y) {
             let ret = 300.0 + x + 2.0 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * Math.sqrt(Math.abs(x));
             ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
             ret += (20.0 * Math.sin(x * PI) + 40.0 * Math.sin(x / 3.0 * PI)) * 2.0 / 3.0;
             ret += (150.0 * Math.sin(x / 12.0 * PI) + 300.0 * Math.sin(x / 30.0 * PI)) * 2.0 / 3.0;
             return ret;
         }
     }

     function gcj02ToWgs84(lng, lat) {
         const g = wgs84ToGcj02(lng, lat);
         return { lng: lng * 2 - g.lng, lat: lat * 2 - g.lat };
     }

     function bd09ToGcj02(bdLng, bdLat) {
         const x_PI = 3.14159265358979324 * 3000.0 / 180.0;
         const x = bdLng - 0.0065;
         const y = bdLat - 0.006;
         const z = Math.sqrt(x * x + y * y) - 0.00002 * Math.sin(y * x_PI);
         const theta = Math.atan2(y, x) - 0.000003 * Math.cos(x * x_PI);
         const ggLng = z * Math.cos(theta);
         const ggLat = z * Math.sin(theta);
         return { lng: ggLng, lat: ggLat };
     }

     function calculatePolygonBottomCenter(outerRing) {
         let minLat = Infinity;
         let bottomPoints = [];
         outerRing.forEach(point => {
             const lat = point[1];
             if (lat < minLat) {
                 minLat = lat;
                 bottomPoints = [point];
             } else if (lat === minLat) {
                 bottomPoints.push(point);
             }
         });

         const sumLng = bottomPoints.reduce((sum, point) => sum + point[0], 0);
         const centerLng = sumLng / bottomPoints.length;

         return { lng: centerLng, lat: minLat };
     }

     function fitBounds(geojson) {
         try {
             const allPoints = [];
             function collectPoints(coords) {
                 if (typeof coords[0] === 'number') {
                     allPoints.push(coords);
                 } else {
                     coords.forEach(coord => collectPoints(coord));
                 }
             }
             collectPoints(geojson.coordinates);

             if (allPoints.length === 0) return;

             const lats = allPoints.map(p => p[1]);
             const lngs = allPoints.map(p => p[0]);
             const minLng = Math.min(...lngs);
             const maxLng = Math.max(...lngs);
             const minLat = Math.min(...lats);
             const maxLat = Math.max(...lats);

             const sw = wgs84ToGcj02(minLng, minLat);
             const ne = wgs84ToGcj02(maxLng, maxLat);

             // 修复setViewport方法的使用，确保参数格式正确
             if (map && map.setViewport) {
                 map.setViewport([
                     new T.LngLat(sw.lng, sw.lat),
                     new T.LngLat(ne.lng, ne.lat)
                 ], { padding: [50, 50] });
             } else {
                 console.warn('地图对象或setViewport方法不可用');
             }
         } catch (error) {
             console.error('调整视图范围时出错:', error);
         }
     }
// 轨迹绘制与解析
    function bindTrackEvents() {
        const drawBtn = document.getElementById('drawTrackButton');
        const showPointsBtn = document.getElementById('showTrackPointsButton');
        const clearBtn = document.getElementById('clearTrackButton');
        const ta = document.getElementById('trackTextarea');
        if (!drawBtn || !showPointsBtn || !clearBtn || !ta) return;

        drawBtn.addEventListener('click', function(){
            try {
                const text = ta.value.trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const points = parseTrackText(text);
                if (points.length < 2) { alert('有效轨迹点不足，至少需要两点'); return; }
                drawTrackFromPoints(points);
                fitViewportToTrack(points);
            } catch (e) {
                alert('绘制轨迹失败：' + (e && e.message ? e.message : e));
                console.error('绘制轨迹异常:', e);
            }
        });

        showPointsBtn.addEventListener('click', function(){
            try {
                const text = ta.value.trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const points = parseTrackText(text);
                if (points.length === 0) { alert('未找到有效轨迹点'); return; }
                showTrackPoints(points);
                fitViewportToTrack(points);
            } catch (e) {
                alert('显示轨迹点失败：' + (e && e.message ? e.message : e));
                console.error('显示轨迹点异常:', e);
            }
        });

        clearBtn.addEventListener('click', function(){
            clearTrackOverlays();
            console.log('已清空轨迹');
        });
    }

    function showTrackPoints(points) {
        // 先移除旧轨迹（不影响轮廓）
        clearTrackOverlays(false);
        
        if (!map || !points || points.length === 0) {
            console.log('无轨迹点可显示');
            return;
        }
        
        console.log(`准备显示${points.length}个轨迹点`);
        
        // 使用批量处理和更小的图标来提高性能
        // 创建一个更小的红点SVG图标
        const smallRedDotIcon = new T.Icon({
            iconUrl: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1" height="1"><circle cx="0.5" cy="0.5" r="0.3" fill="%23FF0000"/></svg>',
            iconSize: new T.Point(1, 1),
            iconAnchor: new T.Point(0.5, 0.5)
        });
        
        // 优化批量添加点的速度
        const batchSize = 2000; // 增加每批处理的点数
        const concurrentBatches = 4; // 并发批次数量
        
        // 预创建点击事件处理函数，避免重复创建
        function createClickHandler(point, index) {
            return function() {
                const infoWindow = new T.InfoWindow({
                    content: `点${index + 1}<br/>经度: ${point.lng.toFixed(6)}<br/>纬度: ${point.lat.toFixed(6)}`,
                    offset: new T.Point(0, -20)
                });
                infoWindow.open(map, point);
            };
        }
        
        // 使用setTimeout实现更高效的批量添加，避免阻塞UI
        let currentIndex = 0;
        
        function addBatch() {
            if (currentIndex >= points.length) {
                console.log(`已显示${points.length}个轨迹点`);
                return;
            }
            
            // 添加当前批次的点
            const endIndex = Math.min(currentIndex + batchSize, points.length);
            const markersToAdd = [];
            
            // 先创建所有标记
            for (let i = currentIndex; i < endIndex; i++) {
                const point = points[i];
                const index = i;
                
                const marker = new T.Marker(point, {
                    icon: smallRedDotIcon
                });
                
                // 添加点击事件
                marker.addEventListener('click', createClickHandler(point, index));
                
                markersToAdd.push(marker);
            }
            
            // 批量添加到地图和数组
            markersToAdd.forEach(marker => {
                map.addOverLay(marker);
                currentTracks.push(marker);
            });
            
            currentIndex = endIndex;
            
            // 使用setTimeout而不是requestAnimationFrame，减少对渲染周期的依赖
            // 设置为0，将任务放入微任务队列，但允许UI有短暂的呼吸空间
            setTimeout(addBatch, 0);
        }
        
        // 启动批量添加
        addBatch();
    }
    
    // 恢复原始的clearTrackOverlays函数
    function clearTrackOverlays(resetArray = true){        
        try {
            currentTracks.forEach(pl => {
                if (pl && map && map.removeOverLay) {
                    try { map.removeOverLay(pl); } catch (e) { console.warn('移除轨迹失败:', e); }
                }
            });
            if (resetArray) currentTracks = [];
        } catch (e) {
            console.warn('清空轨迹时出错:', e);
        }
    }

    function parseTrackText(text){
        // 选择输入坐标系（优先使用轨迹页签专属选择器，若未设置则回退到绘制页签选择器）
        const coordSysEl = document.getElementById('trackCoordSysSelect') || document.getElementById('coordSysSelect');
        const coordSys = (coordSysEl && coordSysEl.value) || 'wgs84';
        const isHash = text.indexOf('#') !== -1;
        const items = isHash ? text.split('#') : text.split(/\r?\n/);
        const pts = [];
        for (let i=0;i<items.length;i++){
            const raw = items[i];
            if (!raw) continue;
            const line = raw.trim();
            if (!line) continue;
            const parts = line.split(',');
            if (parts.length < 3) continue;
            let lng = parseFloat((parts[isHash ? 0 : 1] || '').trim());
            let lat = parseFloat((parts[isHash ? 1 : 2] || '').trim());
            // 初步过滤：数值合法性与正常范围
            if (!isFinite(lng) || !isFinite(lat)) continue;
            if (lng === 0 || lat === 0) continue; // 丢弃0.0异常点
            if (lng < -180 || lng > 180 || lat < -90 || lat > 90) continue; // 超出经纬度范围丢弃

            // 将输入坐标转换为WGS84
            let w;
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                w = { lng, lat };
            } else if (coordSys === 'gcj02') {
                w = gcj02ToWgs84(lng, lat);
            } else if (coordSys === 'bd09') {
                const g = bd09ToGcj02(lng, lat);
                w = gcj02ToWgs84(g.lng, g.lat);
            } else {
                w = { lng, lat };
            }
            // 转换结果兜底检查
            if (!isFinite(w.lng) || !isFinite(w.lat)) continue;
            if (w.lng < -180 || w.lng > 180 || w.lat < -90 || w.lat > 90) continue;

            // 使用WGS84坐标绘制到地图
            pts.push(new T.LngLat(w.lng, w.lat));
        }
        return pts;
    }

    function drawTrackFromPoints(points){
        // 先移除旧轨迹（不影响轮廓）
        clearTrackOverlays(false);
        const polyline = new T.Polyline(points, {
            color: '#FF3B30',
            weight: 1,
            opacity: 0.9
        });
        if (map) {
            map.addOverLay(polyline);
        }
        currentTracks.push(polyline);
    }

    function clearTrackOverlays(resetArray = true){
        try {
            currentTracks.forEach(pl => {
                if (pl && map && map.removeOverLay) {
                    try { map.removeOverLay(pl); } catch (e) { console.warn('移除轨迹失败:', e); }
                }
            });
            if (resetArray) currentTracks = [];
        } catch (e) {
            console.warn('清空轨迹时出错:', e);
        }
    }


    function fitViewportToTrack(points){
        try {
            if (!map || !map.setViewport || !points || !points.length) return;
            map.setViewport(points);
        } catch (e) {
            console.warn('轨迹视图居中失败:', e);
        }
    }

    // ========= 轨迹回放功能 =========
    let playbackState = { points: [], idx: 0, speed: 1, timer: null, running: false, marker: null, line: null, path: [] };

    function bindPlaybackControls(){
        const startBtn = document.getElementById('playbackStartBtn');
        const pauseBtn = document.getElementById('playbackPauseBtn');
        const stopBtn = document.getElementById('playbackStopBtn');
        const speedSel = document.getElementById('playbackSpeedSelect');
        const timeSlider = document.getElementById('playbackTimeSlider');
        const timeCursor = document.getElementById('playbackTimeCursor');
        const ta = document.getElementById('trackTextarea');
        if (!startBtn || !pauseBtn || !stopBtn || !speedSel) return;

        // 初始按钮状态
        updatePlaybackButtonsState('idle');

        startBtn.addEventListener('click', function(){
            try {
                const text = (ta && ta.value || '').trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const pts = parseTrackTextWithTime(text);
                if (pts.length < 2) { alert('有效轨迹点不足，至少需要两点'); return; }
                startPlayback(pts);
                // 状态在startPlayback中已设置为playing
            } catch (e) {
                alert('开始回放失败：' + (e && e.message ? e.message : e));
                console.error('开始回放异常:', e);
            }
        });

        pauseBtn.addEventListener('click', function(){
            if (!playbackState.running) {
                // 继续
                playbackState.running = true;
                scheduleNext();
                updatePlaybackButtonsState('playing');
            } else {
                // 暂停
                if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
                playbackState.running = false;
                updatePlaybackButtonsState('paused');
            }
        });

        stopBtn.addEventListener('click', function(){ 
            stopPlayback(); 
            updatePlaybackButtonsState('idle');
        });

        speedSel.addEventListener('change', function(){
            const v = parseFloat(speedSel.value);
            playbackState.speed = (isFinite(v) && v > 0) ? v : 1;
        });

        if (timeSlider) {
            timeSlider.addEventListener('input', function(){
                const ms = parseInt(timeSlider.value, 10);
                const txt = formatTimeForLabel(ms);
                if (timeCursor) timeCursor.textContent = txt;
            });
            timeSlider.addEventListener('change', function(){
                jumpToSliderTime();
            });
        }
    }

    function parseTrackTextWithTime(text){
        const coordSysEl = document.getElementById('trackCoordSysSelect') || document.getElementById('coordSysSelect');
        const coordSys = (coordSysEl && coordSysEl.value) || 'wgs84';
        const isHash = text.indexOf('#') !== -1;
        const items = isHash ? text.split('#') : text.split(/\r?\n/);
        const out = [];
        for (let i=0;i<items.length;i++){
            const raw = items[i];
            if (!raw) continue;
            const line = raw.trim();
            if (!line) continue;
            const parts = line.split(',');
            if (parts.length < 3) continue;
            const tsRaw = (parts[isHash ? 2 : 0] || '').trim();
            const ts = (tsRaw || '').replace(/\D/g,'');
            let lng = parseFloat((parts[isHash ? 0 : 1] || '').trim());
            let lat = parseFloat((parts[isHash ? 1 : 2] || '').trim());
            if (!isFinite(lng) || !isFinite(lat)) continue;
            if (lng === 0 || lat === 0) continue;
            if (lng < -180 || lng > 180 || lat < -90 || lat > 90) continue;
            const t = parseTimestamp(ts);
            if (!t) continue;
            let w;
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                w = { lng, lat };
            } else if (coordSys === 'gcj02') {
                w = gcj02ToWgs84(lng, lat);
            } else if (coordSys === 'bd09') {
                const g = bd09ToGcj02(lng, lat);
                w = gcj02ToWgs84(g.lng, g.lat);
            } else { w = { lng, lat }; }
            if (!isFinite(w.lng) || !isFinite(w.lat)) continue;
            if (w.lng < -180 || w.lng > 180 || w.lat < -90 || w.lat > 90) continue;
            out.push({ ll: new T.LngLat(w.lng, w.lat), time: t, ts });
        }
        out.sort((a,b)=>a.time - b.time);
        return out;
    }

    function parseTimestamp(ts){
        const tstr = (ts || '').replace(/\D/g,'');
        const m = tstr && tstr.match(/^\d{14}$/);
        if (!m) return null;
        const y = parseInt(tstr.slice(0,4),10);
        const M = parseInt(tstr.slice(4,6),10) - 1;
        const d = parseInt(tstr.slice(6,8),10);
        const h = parseInt(tstr.slice(8,10),10);
        const m2 = parseInt(tstr.slice(10,12),10);
        const s = parseInt(tstr.slice(12,14),10);
        const dt = new Date(y,M,d,h,m2,s);
        return isNaN(dt.getTime()) ? null : dt;
    }

    function startPlayback(points){
        console.log('[Playback] startPlayback: 点数=', points && points.length);
        stopPlayback();
        playbackState.points = points;
        playbackState.idx = 0;
        playbackState.speed = playbackState.speed || 1;
        playbackState.running = true;
        // 配置时间滑动条，并尊重现有滑块位置作为起始
        configureTimeSlider(points);
        // 启用滑块
        const slider = document.getElementById('playbackTimeSlider');
        if (slider) slider.disabled = false;
        let initIdx = 0;
        if (slider && slider.min && slider.max) {
            const ms = parseInt(slider.value, 10);
            if (isFinite(ms)) initIdx = findIndexByTime(points, ms);
        }
        playbackState.idx = initIdx;
        const first = points[initIdx];
        console.log('[Playback] 首点:', first && first.ts, first && first.ll, 'initIdx=', initIdx);
        playbackState.path = points.slice(0, initIdx+1).map(p=>p.ll);
        playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 1, opacity: 0.9 });
        if (map) {
            map.addOverLay(playbackState.line);
        }
        currentTracks.push(playbackState.line);
        // 创建并定位DOM标记以保证可见移动
        ensurePlaybackDom(first.ll);
        updatePlaybackDom(first.ll);
        updatePlaybackTimeLabel(first.ts);
        try { fitViewportToTrack(points.map(p=>p.ll)); } catch(e){}
        // 更新按钮状态
        updatePlaybackButtonsState('playing');
        scheduleNext();
    }

    function scheduleNext(){
        if (!playbackState.running) return;
        if (!playbackState.points || playbackState.idx >= playbackState.points.length - 1) {
            playbackState.running = false;
            console.log('[Playback] 回放结束：idx=', playbackState.idx, '点数=', playbackState.points ? playbackState.points.length : 0);
            updatePlaybackButtonsState('idle'); // 播放结束后按钮回到初始状态：开始可点，继续/结束灰化
            return;
        }
        const next = playbackState.points[playbackState.idx+1];
        const speed = playbackState.speed || 1;
        const delay = Math.max(4, Math.round(1000 / speed)); // 1x=1000ms/点，2x=500ms/点...
        console.log('[Playback] scheduleNext: idx=', playbackState.idx, '->', playbackState.idx+1, 'delay=', delay, 'speed=', speed);
        playbackState.timer = setTimeout(()=>{
            playbackState.idx++;
            const nextLL = next.ll;
            console.log('[Playback] 下一点:', next && next.ts, nextLL);
            try {
                // 维护路径数组
                playbackState.path = playbackState.path || [];
                playbackState.path.push(nextLL);
                console.log('[Playback] 路径长度=', playbackState.path.length);
                // 使用DOM标记进行移动（容器/图层坐标）
                if (!playbackDom.el) console.log('[Playback] DOM标记不存在，将尝试创建');
                updatePlaybackDom(nextLL);
                // 折线更新：优先setLngLats，兜底重建
                if (playbackState.line && typeof playbackState.line.setLngLats === 'function') {
                    try { playbackState.line.setLngLats(playbackState.path); }
                    catch(e){
                        console.warn('[Playback] setLngLats失败，重建折线', e);
                        if (map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                        playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 1, opacity: 0.9 });
                        if (map) map.addOverLay(playbackState.line);
                    }
                } else {
                    console.log('[Playback] 折线不支持setLngLats，重建');
                    if (playbackState.line && map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                    playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 1, opacity: 0.9 });
                    if (map) map.addOverLay(playbackState.line);
                }
            } catch(e) { console.warn('更新回放覆盖物失败:', e); }
            updatePlaybackTimeLabel(next.ts);
            scheduleNext();
        }, delay);
    }

    function stopPlayback(){
        if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
        playbackState.running = false;
        playbackState.idx = 0;
        try {
            // 移除DOM标记
            removePlaybackDom();
            if (playbackState.marker && map) map.removeOverLay(playbackState.marker);
            if (playbackState.line && map) map.removeOverLay(playbackState.line);
        } catch(e){}
        playbackState.marker = null;
        playbackState.line = null;
        updatePlaybackTimeLabel('—');
        // 按钮回到初始状态
        updatePlaybackButtonsState('idle');
    }

    function updatePlaybackTimeLabel(text){
        const el = document.getElementById('playbackTimeLabel');
        if (el) el.textContent = '时间：' + (text || '—');
    }

    // 时间滑动条：配置与跳转
    function configureTimeSlider(points){
        try {
            const slider = document.getElementById('playbackTimeSlider');
            const cursor = document.getElementById('playbackTimeCursor');
            if (!slider || !points || !points.length) return;
            const minMs = points[0].time.getTime();
            const maxMs = points[points.length - 1].time.getTime();
            const prev = parseInt(slider.value, 10);
            slider.min = String(minMs);
            slider.max = String(maxMs);
            slider.step = '1000'; // 以秒为步进
            let val = (isFinite(prev) && prev >= minMs && prev <= maxMs) ? prev : minMs;
            slider.value = String(val);
            if (cursor) cursor.textContent = formatTimeForLabel(val);
        } catch(e) { console.warn('配置时间滑动条失败:', e); }
    }
    function formatTimeForLabel(ms){
        if (!isFinite(ms)) return '—';
        const d = new Date(ms);
        const pad = n => String(n).padStart(2,'0');
        const y = d.getFullYear();
        const M = pad(d.getMonth()+1);
        const da = pad(d.getDate());
        const h = pad(d.getHours());
        const m = pad(d.getMinutes());
        const s = pad(d.getSeconds());
        return `${y}-${M}-${da} ${h}:${m}:${s}`;
    }
    function findIndexByTime(points, ms){
        try {
            if (!points || !points.length) return 0;
            const n = points.length;
            const minMs = points[0].time.getTime();
            const maxMs = points[n-1].time.getTime();
            if (!isFinite(ms)) return 0;
            if (ms <= minMs) return 0;
            if (ms >= maxMs) return n-1;
            let lo = 0, hi = n - 1, ans = 0;
            while (lo <= hi) {
                const mid = (lo + hi) >> 1;
                const t = points[mid].time.getTime();
                if (t < ms) { lo = mid + 1; ans = lo; }
                else { hi = mid - 1; ans = mid; }
            }
            return Math.max(0, Math.min(n-1, ans));
        } catch(e){ console.warn('findIndexByTime失败:', e); return 0; }
    }
    function jumpToSliderTime(){
        try {
            const slider = document.getElementById('playbackTimeSlider');
            if (!slider || !playbackState.points || !playbackState.points.length) return;
            const ms = parseInt(slider.value, 10);
            if (!isFinite(ms)) return;
            const idx = findIndexByTime(playbackState.points, ms);
            playbackState.idx = idx;
            const pts = playbackState.points;
            const ll = pts[idx].ll;
            playbackState.path = pts.slice(0, idx+1).map(p=>p.ll);
            // 更新折线
            try {
                if (playbackState.line && typeof playbackState.line.setLngLats === 'function') {
                    playbackState.line.setLngLats(playbackState.path);
                } else {
                    if (playbackState.line && map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                    playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 1, opacity: 0.9 });
                    if (map) map.addOverLay(playbackState.line);
                }
            } catch(e){ console.warn('滑块更新折线失败:', e); }
            // 更新标记与时间
            ensurePlaybackDom(ll);
            updatePlaybackDom(ll);
            updatePlaybackTimeLabel(pts[idx].ts);
            // 若正在播放，立即按新位置继续
            if (playbackState.running) {
                if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
                scheduleNext();
            }
        } catch(e) { console.warn('滑块跳转失败:', e); }
    }

    // DOM标记：使用容器坐标实现可见移动
    let playbackDom = { el: null, lastLL: null, bound: false };

    function ensurePlaybackDom(ll){
        try {
            playbackDom.lastLL = ll;
            const pane = (map && map.getPanes && map.getPanes().overlayPane) || document.getElementById('mapContainer');
            if (!pane) { console.warn('未找到overlayPane或mapContainer'); return; }
            if (!playbackDom.el) {
                const el = document.createElement('div');
                el.id = 'playbackDomMarker';
                el.style.position = 'absolute';
                el.style.width = '0';
                el.style.height = '0';
                el.style.borderLeft = '3px solid transparent';
                el.style.borderRight = '3px solid transparent';
                el.style.borderBottom = '4px solid #2C64A7';
                el.style.borderTop = '0';
                el.style.transform = 'translate(-50%, -50%)';
                el.style.zIndex = '9999';
                // 添加伪元素来增强箭头效果
                el.style.clipPath = 'polygon(50% 0, 100% 100%, 0 100%)';
                pane.appendChild(el);
                playbackDom.el = el;
                console.log('[Playback] 创建DOM标记，父节点=', pane === document.getElementById('mapContainer') ? '#mapContainer' : 'overlayPane');
                bindPlaybackDomEvents();
            }
            updatePlaybackDom(ll);
        } catch(e) { console.warn('创建DOM标记失败:', e); }
    }

    function updatePlaybackDom(ll){
        try {
            playbackDom.lastLL = ll;
            if (!map || !playbackDom.el || !ll) { console.log('[Playback] update取消：map/el/ll缺失'); return; }
            let p;
            if (typeof map.lngLatToLayerPoint === 'function') {
                p = map.lngLatToLayerPoint(ll);
                console.log('[Playback] 使用layerPoint定位:', ll && ll.lng, ll && ll.lat, '=>', p && p.x, p && p.y);
            } else if (typeof map.lngLatToContainerPoint === 'function') {
                p = map.lngLatToContainerPoint(ll);
                console.log('[Playback] 使用containerPoint定位:', ll && ll.lng, ll && ll.lat, '=>', p && p.x, p && p.y);
            } else {
                console.warn('地图对象不支持lngLat到像素坐标转换');
                return;
            }
            playbackDom.el.style.left = p.x + 'px';
            playbackDom.el.style.top = p.y + 'px';
        } catch(e) { console.warn('更新DOM标记位置失败:', e); }
    }

    function bindPlaybackDomEvents(){
        if (playbackDom.bound) return;
        const updater = function(){
            try {
                if (!map || !playbackDom.el || !playbackDom.lastLL) return;
                let p;
                if (typeof map.lngLatToLayerPoint === 'function') {
                    p = map.lngLatToLayerPoint(playbackDom.lastLL);
                } else if (typeof map.lngLatToContainerPoint === 'function') {
                    p = map.lngLatToContainerPoint(playbackDom.lastLL);
                }
                if (!p) return;
                playbackDom.el.style.left = p.x + 'px';
                playbackDom.el.style.top = p.y + 'px';
            } catch(e){}
        };
        try {
            map.addEventListener('move', updater);
            map.addEventListener('zoom', updater);
            playbackDom.bound = true;
        } catch(e){}
    }

    function removePlaybackDom(){
        try {
            const el = playbackDom.el;
            playbackDom.lastLL = null;
            if (el && el.parentNode) el.parentNode.removeChild(el);
        } catch(e){}
        playbackDom.el = null;
        playbackDom.bound = false;
    }

</script>
</body>

</html>
