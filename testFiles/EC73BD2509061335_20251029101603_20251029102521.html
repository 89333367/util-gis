<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>展示轮廓</title>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #mapContainer {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        #mapLoading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
            transition: opacity 0.3s;
        }

        .loading-text {
            font-size: 16px;
            color: #333;
            padding: 10px 20px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .wkt-input-container {
            position: absolute;
            top: 20px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            width: min(320px, 90vw);
            box-sizing: border-box;
            transition: all 0.3s;
        }

        .minimize-btn {
            position: absolute;
            top: -5px;
            right: -4px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #f0f0f0;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #666;
            z-index: 1001;
            transition: background 0.2s;
        }

        .minimize-btn:hover {
            background: #e0e0e0;
        }

        .content-wrapper {
            transition: all 0.3s;
        }

        .wkt-input-container.minimized {
            width: 40px;
            height: 40px;
            padding: 0;
        }

        .wkt-input-container.minimized .content-wrapper {
            display: none;
        }

        .wkt-input-container.minimized .min-icon {
            display: none;
        }

        .wkt-input-container.minimized .restore-icon {
            display: inline;
        }

        #wktTextarea {
            width: 100%;
            height: 120px;
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
            box-sizing: border-box;
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        /* 页签样式 */
        .tabs-header {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .tab-btn {
            flex: 1;
            padding: 6px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            background: #f5f5f5;
            color: #333;
            transition: background 0.2s;
        }
        .tab-btn.active { background: #337AFF; color: #fff; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        /* Multi → Polygons 分割器样式 */
        .split-section {
            margin-top: 10px;
            padding: 10px;
            background: #fafafa;
            border: 1px solid #eee;
            border-radius: 6px;
        }
        .split-section .title {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
        }
        .split-section .desc {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        #multiInput, #polyOutput {
            width: 100%;
            height: 90px;
            margin-bottom: 8px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
            box-sizing: border-box;
        }
        .split-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .split-actions button {
            flex: 1;
            padding: 6px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }
        #splitMultiBtn { background: #337AFF; color: #fff; }
        #splitMultiBtn:hover { background: #2860E0; }
        #copyPolysBtn { background: #f5f5f5; color: #333; }
        #copyPolysBtn:hover { background: #e0e0e0; }
        #drawButton,
        #clearButton,
        #drawTrackButton,
        #clearTrackButton {
            width: 50%;
            padding: 8px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        #drawButton,
        #drawTrackButton {
            background: #337AFF;
            color: white;
        }

        #drawButton:hover,
        #drawTrackButton:hover {
            background: #2860E0;
        }

        #clearButton,
        #clearTrackButton {
            background: #f5f5f5;
            color: #333;
        }

        #clearButton:hover,
        #clearTrackButton:hover {
            background: #e0e0e0;
        }

        #drawButton:disabled,
        #clearButton:disabled,
        #drawTrackButton:disabled,
        #clearTrackButton:disabled {
            background: #e0e0e0;
            color: #999;
            cursor: not-allowed;
        }

        .tip {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .area-label {
             position: absolute;
             background: rgba(255, 0, 0, 0.85);
             border: 1px solid #000;
             border-radius: 3px;
             padding: 4px 6px;
             font-size: 12px;
             color: #fff;
             font-weight: 600;
             box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
             white-space: nowrap;
             z-index: 9999;
             pointer-events: none;
         }
         /* 默认隐藏标签容器下的标签 */
          .labels-hidden .area-label { display: none; }

          /* Batch → Generator 样式 */
          .batch-section { margin-top: 10px; padding: 10px; background: #fafafa; border: 1px solid #eee; border-radius: 6px; }
          .batch-section .title { font-size: 13px; font-weight: 600; color: #333; margin-bottom: 6px; }
          .batch-section .desc { font-size: 12px; color: #666; margin-bottom: 8px; }
          #batchInput, #multiOutput { width: 100%; height: 90px; margin-bottom: 8px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; resize: vertical; box-sizing: border-box; }
          .batch-actions { display: flex; gap: 8px; margin-bottom: 8px; }
          .batch-actions button { flex: 1; padding: 6px 0; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; transition: background 0.2s; }
          #generateMultiBtn { background: #337AFF; color: #fff; }
          #generateMultiBtn:hover { background: #2860E0; }
          #copyMultiBtn { background: #f5f5f5; color: #333; }
          #copyMultiBtn:hover { background: #e0e0e0; }
      </style>
    <script src="https://api.tianditu.gov.cn/api?v=4.0&tk=648f621977051d0199ff0f965d3fd322"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
    <script src="https://lib.baomitu.com/terraformer/1.0.12/terraformer.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://unpkg.com/terraformer-wkt-parser@1.2.1/terraformer-wkt-parser.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- 已移除动态备用加载器 ensureTerraformer：改为仅使用静态脚本标签加载 Terraformer 核心库与 WKT 解析器 -->
    <script>
        // 检查Turf.js是否加载成功
        window.addEventListener('load', function () {
            if (typeof turf === 'undefined') {
                console.warn('Turf.js加载失败，已启用备用面积算法');
            } else {
                console.log('Turf.js加载成功');
            }
        });
    </script>
</head>

<body>
<div id="mapContainer">
    <div id="mapLoading">
        <div class="loading-text">地图正在加载中...</div>
    </div>
</div>

<div class="wkt-input-container">
    <div class="minimize-btn" id="minimizeBtn">
        <span class="min-icon">−</span>
        <span class="restore-icon" style="display:none;">+</span>
    </div>

    <div class="content-wrapper">
        <div class="tabs-header">
            <button class="tab-btn active" id="tabDrawBtn">轮廓</button>
            <button class="tab-btn" id="tabTrackBtn">轨迹</button>
            <button class="tab-btn" id="tabSplitBtn">分割器</button>
            <button class="tab-btn" id="tabBatchBtn">合并器</button>
        </div>
        <div class="tab-pane active" id="tabDraw">
            <div class="tip">请输入WKT字符串（支持POLYGON/MULTIPOLYGON）：</div>
            <textarea id="wktTextarea">POLYGON ((116.34986393562214 40.04652190651035, 116.34986369677934 40.04652301545172, 116.3498636892013 40.04652310408089, 116.34986376272578 40.04652479466379, 116.34986377798748 40.046524882706656, 116.34986428291067 40.04652652911939, 116.3498643204155 40.0465266131332, 116.3498652169543 40.04652811737625, 116.3498652563762 40.046528192209195, 116.34986535069433 40.04652839722147, 116.34986540955059 40.046528591282886, 116.34986541143947 40.04652879054102, 116.34986535626855 40.0465289852409, 116.34986490898036 40.04653000449329, 116.34986488365281 40.04653008755106, 116.34986459894206 40.04653169707625, 116.34986459449924 40.046531782315796, 116.3498647107824 40.04653340418606, 116.34986472738422 40.04653348853425, 116.34986524046857 40.046535064273606, 116.34986527751656 40.04653514468983, 116.34986616890343 40.04653661748608, 116.34986622506123 40.04653669106968, 116.3498674626115 40.04653800782072, 116.34986753585572 40.04653807192043, 116.34986907494972 40.04653918515115, 116.34986916263856 40.04653923745481, 116.34987089155958 40.04654007964005, 116.34987106123963 40.04654018010711, 116.3498712042895 40.04654030263338, 116.34987131592949 40.046540443124876, 116.34987148075942 40.046540700921724, 116.34987272775793 40.04654208415429, 116.34987280331504 40.046542152298535, 116.349874403437 40.04654333342722, 116.34987449507857 40.04654338870058, 116.34987636821954 40.04654430246185, 116.34987647230503 40.046544342668604, 116.34987854404346 40.046544952758, 116.34987865643701 40.04654497630041, 116.34988034004448 40.046545193426624, 116.34988055793806 40.04654523845596, 116.34988076056285 40.046545314745956, 116.34988232675195 40.046546055981814, 116.34988242126012 40.04654609201495, 116.34988441866767 40.0465466819489, 116.34988847617201 40.046547570666235, 116.34988872955833 40.04654765186522, 116.34989090310714 40.046548591647934, 116.34989107627524 40.04654868313633, 116.34989347917161 40.04655021361194, 116.3498936746063 40.046550372579986, 116.34989453262614 40.04655126696187, 116.3498973749979 40.046553872659075, 116.34989867841105 40.04655489378363, 116.34990338141506 40.04655802685949, 116.34990347148246 40.0465580936604, 116.34990467283245 40.046559085236105, 116.34990628916411 40.04656031419288, 116.34990763385423 40.046561192256995, 116.3499110022151 40.04656307656579, 116.34991302184355 40.046563977008, 116.34991313368249 40.046564015457484, 116.34991391435258 40.04656421135349, 116.34991410464292 40.04656427387847, 116.3499145250081 40.046564447210855, 116.34991469878321 40.046564534953745, 116.3499212217684 40.04656850755404, 116.3499229341246 40.046569367333724, 116.34992302906925 40.04656940594671, 116.34992491687346 40.04657001034276, 116.34992501940751 40.046570034954186, 116.34992701922569 40.04657036371064, 116.34992712588769 40.04657037348963, 116.34992916177852 40.04657041533542, 116.34992935322167 40.04657043143761, 116.34992953864756 40.046570471422, 116.34993700719832 40.04657260453746, 116.34993719361911 40.04657267269095, 116.34993736158494 40.04657276492937, 116.34994347372178 40.04657679120653, 116.34994593253275 40.04657803177224, 116.34994827134082 40.04657891805744, 116.34994846965479 40.04657901318995, 116.3499486394506 40.04657913668421, 116.34995298171563 40.04658299550988, 116.34995456381336 40.0465841520547, 116.34995465421886 40.04658420621983, 116.34995649918484 40.04658510299736, 116.34995660160766 40.046585142559735, 116.34995863883539 40.046585745338476, 116.3499587493353 40.04658576877609, 116.34995942089614 40.04658585793577, 116.34995966079396 40.04658591049465, 116.34995988077995 40.04658600088921, 116.34997248556807 40.046592594751786, 116.34997450465198 40.04659343204537, 116.3499746159689 40.046593467369284, 116.34997681528286 40.04659396871032, 116.34997693365753 40.046593985745396, 116.34997727248492 40.04659400711242, 116.34997748197462 40.046594035202844, 116.34997768140896 40.04659409192835, 116.34997786421984 40.04659417542078, 116.34997915779975 40.04659489580702, 116.3499793280261 40.046595011520296, 116.349979465989 40.046595150310246, 116.34997956649941 40.04659530695669, 116.34997962577674 40.046595475567734, 116.34997964159162 40.04659564980158, 116.34997961334908 40.04659582310485, 116.34997954211151 40.04659598895923, 116.3499761714915 40.04660185320211, 116.34997578394145 40.04660261496267, 116.34997290679362 40.046609059771974, 116.34997167588266 40.04661177231019, 116.3499682249823 40.04662037858463, 116.3499679311487 40.04662127642052, 116.34996553461369 40.04663055307801, 116.34996518601467 40.046632092489574, 116.34996512985266 40.0466322520392, 116.34996415217562 40.04663427212677, 116.34996252612599 40.046638020524775, 116.34996187554405 40.04663938014804, 116.34995778214501 40.046648834897844, 116.34995608217373 40.04665281498809, 116.34995395243517 40.04665719196326, 116.34995024537879 40.04666498795631, 116.34995020344506 40.04666506488993, 116.34994989530982 40.04666556399596, 116.34994922221605 40.0466669390299, 116.3499488655784 40.046667786924964, 116.34994737515345 40.046672025381014, 116.34994577842545 40.04667682554244, 116.34994493915251 40.04667944534217, 116.34994440293359 40.046681247078105, 116.34994436082142 40.04668135627747, 116.34994305007483 40.046684103911126, 116.34994161482497 40.046687540641784, 116.34994114929196 40.04668919897784, 116.3499411365011 40.04668928544641, 116.34994111414792 40.0466911082383, 116.34994109845853 40.046691246869806, 116.34994105516762 40.04669138198877, 116.34993793178008 40.04669865562804, 116.34993587688575 40.046703380401915, 116.3499356084646 40.046704280622734, 116.34993552179489 40.046704470577644, 116.34993453750941 40.04670603956707, 116.34993379421816 40.046707577792695, 116.34993376545567 40.04670766102525, 116.34993341794559 40.046709278954324, 116.34993341037607 40.04670936487512, 116.34993347094154 40.04671100403938, 116.34993348484306 40.04671108949167, 116.34993395125872 40.046712689657504, 116.34993398612065 40.04671277150151, 116.34993484124736 40.0467142738695, 116.34993489578864 40.04671434909754, 116.34993610820429 40.04671569846196, 116.34993618042063 40.04671576430947, 116.34993770557335 40.046716911086286, 116.34993779281122 40.046716965133854, 116.34993957465815 40.04671786718389, 116.34993967371169 40.046717907445334, 116.34994164958457 40.04671853250994, 116.34994175091894 40.04671855657209, 116.34994288111511 40.046718740653596, 116.3499438493796 40.046718881035375, 116.34994395363418 40.04671888877845, 116.34994483102682 40.046718893168155, 116.34994527465335 40.046718909657365, 116.349945400383 40.04671890055494, 116.34994551790805 40.046718896604716, 116.34994609088665 40.0467188994714, 116.34994620249155 40.046718891775534, 116.34994683615562 40.0467188003981, 116.34994694235681 40.046718788920984, 116.34994732341339 40.0467187613337, 116.3499474311376 40.04671874559635, 116.34994777296953 40.04671866954947, 116.34994787222098 40.04671865103039, 116.34994836066137 40.04671857705208, 116.34994892157894 40.04671841662088, 116.34994900446023 40.046718395581365, 116.34994943658496 40.046718299447136, 116.34994953859024 40.04671826852624, 116.34994995295935 40.04671810691519, 116.34995005207487 40.046718072604065, 116.34995046734409 40.04671794631013, 116.3499505664607 40.04671790740974, 116.34995091628788 40.0467177360337, 116.34995101585889 40.046717692366165, 116.34995140035466 40.04671754240623, 116.3499514930524 40.04671749738962, 116.34995187569969 40.0467172703492, 116.34995196193482 40.04671722378406, 116.34995235344084 40.04671703199008, 116.34995244116915 40.04671697935734, 116.34995272949413 40.04671676952202, 116.34995281911537 40.04671671058177, 116.34995314563412 40.046716516844754, 116.34995322576283 40.046716459316414, 116.34995355896946 40.04671617055773, 116.3499536299611 40.04671611418592, 116.34995397988533 40.046715859520276, 116.34995405304463 40.04671579506327, 116.34995427403206 40.04671555814897, 116.34995434969214 40.04671548531319, 116.34995461102115 40.046715258844095, 116.34995467576204 40.04671519082773, 116.3499549425783 40.046714846909694, 116.34995499668712 40.04671478341114, 116.34995528772434 40.046714471398445, 116.34995534366249 40.04671439745387, 116.34995549477307 40.046714145085794, 116.34995554705036 40.04671406784547, 116.3499557944627 40.04671374182511, 116.34995972689583 40.046707374823384, 116.34996466226056 40.04669878030708, 116.34996497627291 40.04669817840937, 116.34996664418965 40.04669463408515, 116.3499679821483 40.04669153837716, 116.34996846435895 40.04668990274557, 116.34996847860326 40.04668981537031, 116.34996853634817 40.04668813900032, 116.34996852813909 40.04668805116701, 116.34996816399341 40.04668641965634, 116.34996814731053 40.04668625137804, 116.349968171772 40.046686083662365, 116.3499682365189 40.046685922399114, 116.34996833927745 40.04668577325149, 116.349968476439 40.04668564145724, 116.34996965256774 40.04668470643878, 116.34996972374745 40.046684637432804, 116.349970905134 40.0466832275331, 116.34997095721441 40.0466831495025, 116.34997178954696 40.04668152430602, 116.34997240855917 40.04668008111102, 116.34997312853096 40.046678141316384, 116.34997413628163 40.0466752362011, 116.34997416611527 40.04667508062529, 116.34997423794982 40.04667487641899, 116.34997434365044 40.04667467406539, 116.34997438139857 40.046674609304524, 116.34997449766641 40.04667442920952, 116.34997453878117 40.046674345454235, 116.34997477590755 40.046673662986514, 116.349974794922 40.0466736139052, 116.34997498609705 40.046673167277646, 116.34997504899361 40.0466728905366, 116.34997513149811 40.046672588442156, 116.34997516271241 40.046672197681936, 116.34997516956966 40.04667214109839, 116.34997528643977 40.04667142296441, 116.34997528956953 40.04667133625614, 116.34997526216836 40.04667102512274, 116.34997524555062 40.04667068961934, 116.34997525851057 40.046670517516645, 116.3499753139021 40.046670350464936, 116.34997590602546 40.04666908674874, 116.34997759967322 40.04666576643248, 116.34997796723168 40.04666493386633, 116.34997884703826 40.046662587714344, 116.34997889608944 40.046662482116105, 116.34998126629944 40.046658235121456, 116.34998277642647 40.0466554335611, 116.34998476977258 40.04665151647452, 116.34998688890464 40.04664718866812, 116.34998719680368 40.046646474985664, 116.34998851301292 40.04664296235068, 116.34998857638091 40.04664283205581, 116.3499903470752 40.046639903518276, 116.34999089567981 40.046638813631695, 116.34999187245359 40.046636435398895, 116.34999190582053 40.04663636461262, 116.3500002987475 40.04662064465715, 116.35000032568558 40.04662059801122, 116.35000432489834 40.04661417058802, 116.35000444329627 40.04661402010208, 116.35000459748974 40.04661389016896, 116.35000478159905 40.04661378574312, 116.35000498860403 40.04661371080647, 116.35000521061124 40.046613668216416, 116.35000543915544 40.04661365959698, 116.35000566552176 40.04661368527681, 116.35000588107879 40.04661374427671, 116.35000607760705 40.04661383434695, 116.35000624761264 40.046613952053065, 116.35000638461301 40.04661409290676, 116.35001167901139 40.0466208180047, 116.35001260352752 40.046621807622365, 116.3500127352132 40.046621989991685, 116.35001280878143 40.046622190751414, 116.35001318774428 40.046624013299855, 116.3500132176361 40.04662409844099, 116.35001401385027 40.046625703948614, 116.3500140664596 40.046625784593225, 116.35001526407878 40.04662723542975, 116.35001533572634 40.046627305516864, 116.35001697161202 40.04662860488387, 116.350017638219 40.046629038516365, 116.3500184806412 40.046629538046446, 116.35002136820194 40.04663109133219, 116.35002360112078 40.04663202527137, 116.35002372324297 40.04663206319494, 116.35002630325118 40.04663260530857, 116.35002659162387 40.0466326399863, 116.35002678213462 40.04663267565788, 116.35002702212235 40.046632737341476, 116.3500294804983 40.0466331880553, 116.35002960981768 40.04663320014494, 116.35003225404053 40.04663321075543, 116.35003569714321 40.04663292693392, 116.35003659917355 40.04663278253282, 116.3500368184883 40.04663276373611, 116.35003703849954 40.04663277687382, 116.35003725140453 40.04663282148, 116.35003744965255 40.04663289597272, 116.35003762621291 40.0466329977101, 116.35004426813764 40.04663763666847, 116.35004594784562 40.0466386053916, 116.35004604189957 40.046638649640244, 116.35004792812974 40.04663935857744, 116.35004803132333 40.04663938846398, 116.3500500572261 40.04663981254457, 116.35005016588603 40.04663982700519, 116.35005225937023 40.04663995113831, 116.35005236963035 40.04663994965857, 116.35005445619886 40.046639769426875, 116.35005456413565 40.04663975205941, 116.35005656953814 40.04663927387647, 116.35005667131088 40.04663924123924, 116.35005806896176 40.04663866862504, 116.35005833626252 40.04663858959433, 116.35005867663672 40.04663852426245, 116.35005878379188 40.04663849492704, 116.35006074392672 40.04663778634783, 116.35006084165997 40.04663774161708, 116.35006258610272 40.04663675467672, 116.35006267071199 40.046636696245, 116.35006413339504 40.04663546832209, 116.35006420167652 40.04663539840187, 116.35006532720352 40.04663397600182, 116.350065376571 40.04663389724133, 116.35006612231523 40.04663233423424, 116.35006615089885 40.046632249616756, 116.35006648861653 40.04663060519875, 116.3500664953338 40.04663051792847, 116.35006641223482 40.04662885437829, 116.35006639683148 40.04662876776162, 116.35006589606259 40.046627148082145, 116.35006585912218 40.04662706539895, 116.35006495964929 40.046625550933676, 116.35006490257032 40.046625475314364, 116.35006363845912 40.04662412342021, 116.3500635634042 40.04662405772993, 116.35006198253042 40.04662291960732, 116.35006189342255 40.04662286697179, 116.35005995611972 40.046621942790466, 116.35005620236697 40.04662051211496, 116.3500559520019 40.04662038349627, 116.35005305149318 40.046618435912585, 116.35005008664143 40.04661654968816, 116.35004822185857 40.04661558839211, 116.35004811783587 40.046615545770905, 116.35004717190174 40.04661524798521, 116.35004701187013 40.04661518624354, 116.35004686594736 40.04661510648316, 116.35003925182221 40.04661023049402, 116.35003916379394 40.04661016799086, 116.35003239265767 40.04660484182186, 116.35003073327793 40.04660376768454, 116.35003063941737 40.04660371808071, 116.35002968899731 40.04660331448701, 116.3500295252083 40.04660323039817, 116.350025133288 40.04660053927088, 116.3500249905732 40.046600435657936, 116.35002487236933 40.04660031518741, 116.35002478199456 40.04660018124093, 116.35002443351527 40.04659953794711, 116.35002169129467 40.04659589663857, 116.35002164736747 40.04659583248408, 116.35002074569508 40.04659437622872, 116.35001948135276 40.04659278247681, 116.35001874682185 40.04659204133876, 116.35001863379695 40.04659190279686, 116.35001855523154 40.04659175083155, 116.35001851371578 40.04659159045298, 116.3500185106185 40.04659142694866, 116.35001854604171 40.04659126570918, 116.35001861881769 40.04659111205052, 116.3500194002206 40.046589836427735, 116.3500230391708 40.046583517822974, 116.35002568338135 40.04657881384873, 116.35002926417715 40.04657263744795, 116.35002929716848 40.04657258515028, 116.35003071478697 40.04657051122639, 116.35003192866155 40.046568586083566, 116.35003217423005 40.04656812839131, 116.35003230028468 40.04656795228609, 116.35003239490638 40.04656784928543, 116.35003250764193 40.04656774438571, 116.35003318268983 40.04656720502751, 116.35003405520321 40.04656635752532, 116.35003514250803 40.046565099129516, 116.35003556310818 40.046564515588265, 116.35003675716291 40.04656302782337, 116.35003952159083 40.046558674364235, 116.35004219440367 40.0465545083272, 116.3500448660848 40.046550275960115, 116.35004493274327 40.046550184370744, 116.35004515487988 40.046549917013834, 116.35004786578563 40.04654593005626, 116.35005064243863 40.04654133953973, 116.35005312601322 40.04653702305718, 116.35005320402803 40.046536909961155, 116.35005392928268 40.04653601814621, 116.35005849823743 40.04652895137609, 116.35005859450528 40.046528828229945, 116.35005888849817 40.046528512307795, 116.35006176300412 40.04652468070102, 116.35006229873292 40.04652387365335, 116.3500656471589 40.04651815154384, 116.35006571978987 40.04651804656139, 116.35006631232075 40.04651731166899, 116.35006642765116 40.04651719200389, 116.35006792290585 40.04651588255252, 116.35006798945912 40.04651581104679, 116.35006848618859 40.04651514807963, 116.35006860653348 40.04651501629871, 116.35006904937632 40.04651461343284, 116.35007018537652 40.0465133793082, 116.35007162698805 40.0465114928268, 116.35007176579471 40.046511346981454, 116.3500719396912 40.04651122536857, 116.35007214167678 40.04651113288408, 116.35007239694406 40.046511041287125, 116.35008046247711 40.046507598903545, 116.35008239794331 40.046506553325294, 116.35008249135655 40.04650649046827, 116.35008409535487 40.046505154413445, 116.35008416937623 40.04650507780539, 116.35008458707215 40.0465045327775, 116.35008471287674 40.04650439855704, 116.35008486850187 40.0465042842852, 116.35009020354539 40.046501031667674, 116.3500917574749 40.04649988715381, 116.3500930268656 40.04649876128493, 116.35009338151318 40.04649837737394, 116.35009352195654 40.04649825166994, 116.35009368998698 40.04649814786715, 116.35009387991698 40.04649806947905, 116.35009558968417 40.04649751282898, 116.35009727646393 40.04649683115936, 116.35009736071709 40.046496789677974, 116.35009887056293 40.04649589761815, 116.35009894349824 40.04649584632744, 116.35010029781743 40.046494711086936, 116.35010641878313 40.046488615862366, 116.35010752642285 40.04648712170945, 116.35010764117786 40.04648699394271, 116.35010778277977 40.046486883221654, 116.35010794702062 40.046486792836696, 116.35010831991089 40.046486622946894, 116.35011050511207 40.046485378037566, 116.35011141901454 40.046484722299574, 116.35011157643928 40.046484627316005, 116.35011341892567 40.04648369944507, 116.35011397106175 40.04648340448116, 116.35011558258628 40.04648248886254, 116.35011698931167 40.04648154762245, 116.35011852493844 40.046480346776825, 116.35011862885514 40.04648027468372, 116.3501215960663 40.04647845112532, 116.35012535121062 40.04647606281189, 116.35012694766496 40.04647481866795, 116.35012702234086 40.04647474713655, 116.35012825627486 40.04647328016524, 116.35012831048715 40.04647319846711, 116.35012913095838 40.046471569440904, 116.35012916244666 40.04647148098267, 116.35012938563337 40.04647044935993, 116.35012948497238 40.0464702076624, 116.35013058846064 40.046468439160044, 116.35013062850187 40.046468351657886, 116.35013116851128 40.046466601722024, 116.350131183949 40.04646650920485, 116.35013123251984 40.04646461641989, 116.35013111970727 40.04646357532301, 116.3501311248081 40.04646338829955, 116.35013118007262 40.04646320612065, 116.35013128311634 40.04646303664655, 116.3501314294934 40.04646288718939, 116.3501332718186 40.04646136510806, 116.3501346772884 40.04645989872423, 116.35013576749343 40.04645851258326, 116.35013581231325 40.0464584415307, 116.35013655366379 40.04645692381362, 116.35013689401683 40.046455982837024, 116.35013697526371 40.046455820754176, 116.35013709548518 40.04645567367303, 116.35013725020926 40.04645554706486, 116.35013743368037 40.04645544563931, 116.35013786204676 40.04645525407897, 116.3501379656362 40.04645519492236, 116.35013987601829 40.046453816760135, 116.35014112672684 40.04645269220856, 116.3501426424463 40.04645121984229, 116.35014374886958 40.04644991093276, 116.35014379860486 40.04644983835114, 116.350144288039 40.04644893183366, 116.3501443754686 40.046448801171195, 116.35014448937943 40.046448683173665, 116.35014494179076 40.0464482867241, 116.3501466942898 40.0464463072091, 116.35014812767916 40.04644412565993, 116.35014825329534 40.04644397420943, 116.35014912810114 40.0464431210036, 116.3501492768637 40.04644300063611, 116.35015034833508 40.04644228012049, 116.35015193072577 40.04644098028659, 116.35015200403804 40.04644090586535, 116.35015320129024 40.04643938434508, 116.3501532529998 40.04643929988299, 116.3501540151022 40.046437621004806, 116.35015404297444 40.04643753015205, 116.35015433699925 40.04643576645479, 116.35015433983017 40.04643567313616, 116.35015415307345 40.04643390082489, 116.35015413074046 40.04643380907136, 116.35015386243522 40.04643311565598, 116.35015383650395 40.04643303528254, 116.35015346495122 40.04643160505458, 116.35015343062817 40.04643151899717, 116.35015256653296 40.04642993857883, 116.35015251057281 40.04642985950932, 116.3501512538089 40.046428443239144, 116.35015117845863 40.04642837433257, 116.35014957949747 40.04642717908766, 116.35014948888352 40.046427123782856, 116.35014751010388 40.046426152439885, 116.3501454743302 40.0464253568502, 116.35014519843925 40.04642520705117, 116.35014440034911 40.0464246244191, 116.35014430994076 40.04642457032252, 116.3501424651404 40.046423674785224, 116.35014236273703 40.046423635283524, 116.35014032605828 40.04642303355582, 116.35014021559498 40.04642301016702, 116.35013806530618 40.04642272537287, 116.35013795102829 40.04642271899591, 116.35013576976372 40.046422762079764, 116.35013565606288 40.04642277295972, 116.35013352764717 40.046423142265894, 116.35013341889287 40.04642316998462, 116.35013142511997 40.046423851320874, 116.35013132549128 40.0464238948133, 116.35012954298101 40.04642486199609, 116.35012945630669 40.04642491959088, 116.35012795355954 40.046426135451945, 116.35012788317066 40.04642620493572, 116.3501267179362 40.04642762275042, 116.35012666653803 40.046427701452615, 116.35012588359541 40.04642926673543, 116.35012585316301 40.04642935163155, 116.35012548260072 40.04643100422924, 116.3501254743033 40.04643109205691, 116.35012553036196 40.046432768461564, 116.35012554451839 40.046432855845126, 116.35012602504361 40.04643449163289, 116.35012606110988 40.04643457521524, 116.35012680000989 40.04643585236109, 116.35012687787383 40.046436039897635, 116.35012690085931 40.04643623595619, 116.35012686786803 40.04643643116925, 116.35012678047634 40.046436616209625, 116.350126479012 40.046437086566435, 116.35012630155545 40.0464372887234, 116.35012529096518 40.046438157811174, 116.35012388508817 40.046439653169706, 116.35012382279538 40.046439737218, 116.35012344669798 40.04644040254125, 116.3501233537542 40.046440535295446, 116.3501232332993 40.04644065427437, 116.35012308870849 40.04644075614412, 116.35012163789654 40.04644161826419, 116.35011901862948 40.046443493412085, 116.35011758030114 40.04644474167634, 116.35011751426701 40.046444811690804, 116.35011636631585 40.046446326765455, 116.35011592496276 40.04644706749543, 116.3501153309807 40.04644828763236, 116.35011466780668 40.04645001188416, 116.35011456000555 40.04645020538704, 116.35011439670394 40.04645037437238, 116.35011262677605 40.04645181723181, 116.35010968761588 40.04645485296708, 116.35010857184433 40.04645627125486, 116.35010852292517 40.046456349723385, 116.35010778405449 40.04645790625564, 116.35010775573551 40.046457990499526, 116.35010742115277 40.04645962730505, 116.35010741449614 40.046459714164214, 116.35010749675324 40.0464613698393, 116.35010750652509 40.04646142506556, 116.35010751627345 40.046461582457894, 116.35010750739643 40.046461752798194, 116.35010753685826 40.04646299060912, 116.35010750837195 40.04646320511614, 116.35010741435734 40.046463408270846, 116.35010686135085 40.04646426242377, 116.35010673073543 40.04646442047572, 116.35010656041857 40.04646455435438, 116.3501049283419 40.04646559491935, 116.35010474563389 40.046465690583155, 116.35010454279829 40.046465758169994, 116.35010432705515 40.04646579527408, 116.35010410608375 40.04646580057468, 116.35010388774974 40.046465773883135, 116.35010367982473 40.04646571614951, 116.35010348970985 40.04646562942888, 116.35010332417222 40.04646551680807, 116.35010318910437 40.046465382295835, 116.35010308931386 40.04646523068018, 116.35010302835285 40.04646506735789, 116.35010300839136 40.04646489814247, 116.35010303013978 40.046464729057185, 116.35010307706773 40.046464544518194, 116.35010311216101 40.046464440151304, 116.35010338875792 40.04646378280923, 116.35010387441267 40.046462099713054, 116.35010388819232 40.046462009965715, 116.35010392515015 40.04646030783361, 116.35010388533966 40.04646006569788, 116.35010387611115 40.04645995748524, 116.35010386851091 40.04645883504926, 116.35010385723378 40.046458749537564, 116.35010344081594 40.04645714451008, 116.35010340855573 40.04645706221342, 116.35010260204398 40.046455547508494, 116.35010254998143 40.04645547143935, 116.35010138289597 40.04645410249862, 116.35010131293714 40.04645403544186, 116.35009982799635 40.04645286237192, 116.35009974270156 40.04645280678173, 116.3500979942582 40.046451872520144, 116.3500978967497 40.04645183043137, 116.35009594880161 40.04645116917463, 116.35009584264795 40.04645114212763, 116.3500937664948 40.04645077807936, 116.35009365558201 40.046450767064286, 116.35009152721645 40.046450713549575, 116.35009141560384 40.04645071896958, 116.35008931292964 40.04645097794721, 116.35008920470298 40.046450999603884, 116.35008720468302 40.04645156159467, 116.3500871038035 40.046451598695306, 116.350085279644 40.046452443128906, 116.3500851898042 40.046452494315425, 116.35008360827416 40.046453590283456, 116.35008353366722 40.04645365292251, 116.35008218931297 40.04645503149325, 116.35008112982895 40.04645636066383, 116.3500806635046 40.046457000099736, 116.35007817158372 40.04646075700151, 116.35007806005706 40.04646089341365, 116.35007736891995 40.04646159131739, 116.35007670961744 40.046462326789786, 116.35007573557913 40.04646363099706, 116.35007491608717 40.04646496888143, 116.35007330043331 40.04646737035062, 116.35007000533838 40.04647271890907, 116.35006997730483 40.046472761461374, 116.35006753776722 40.046476233150955, 116.35006502263074 40.04647986907739, 116.35006464926107 40.04648045711368, 116.35005988609424 40.04648866809354, 116.3500585471356 40.04649121904966, 116.35005850463504 40.04649129079788, 116.35005769560816 40.046492511828966, 116.35005739199988 40.04649300470424, 116.35005548461395 40.04649634708512, 116.35005535899012 40.046496515246524, 116.35005518944058 40.04649665884281, 116.35005498382557 40.046496771216866, 116.35005475167728 40.04649684715907, 116.35004744906891 40.046498549824946, 116.35004494660842 40.046499392936646, 116.35004128157766 40.046501032771445, 116.35004114105963 40.04650108630909, 116.35002907062102 40.04650493499031, 116.35001985569016 40.04650820092129, 116.3500130547408 40.046510775070104, 116.35001299305182 40.04651079673764, 116.35000448627615 40.04651355880228, 116.350003801399 40.046513800429786, 116.34999178497971 40.0465183873425, 116.34999159916437 40.046518443663196, 116.34998138076027 40.04652078993177, 116.34998119494328 40.04652082024758, 116.34997966372684 40.046520971748066, 116.34997955560945 40.04652099059123, 116.34997755051884 40.04652149778681, 116.34997744897463 40.046521531978364, 116.34997659619741 40.046521896773996, 116.34997635930321 40.04652197332551, 116.34996960978685 40.04652351083249, 116.34996064784868 40.04652584838266, 116.34995964619628 40.04652614857313, 116.34995618183665 40.04652732336832, 116.34995608045152 40.046527353513106, 116.3499514991409 40.04652853102258, 116.34994986650653 40.046529065153855, 116.34994967279542 40.04652914848613, 116.34994947326477 40.046529216423195, 116.34994822682746 40.04652953790253, 116.3499479931701 40.04652957832505, 116.34994775369945 40.04652958139169, 116.34994751841957 40.04652954697437, 116.34994729715923 40.046529476510905, 116.34994715198043 40.0465294162487, 116.3499449426084 40.04652865829728, 116.34994482270025 40.0465286285945, 116.34994247204442 40.0465282552985, 116.34994234814506 40.04652824615536, 116.3499398217513 40.04652827506247, 116.34993467922031 40.0465287530258, 116.34993456864295 40.04652875924259, 116.3499315098549 40.046528819663116, 116.34993144212518 40.04652881949613, 116.3499263108791 40.04652869281554, 116.3499238051812 40.04652884057851, 116.34991765567104 40.046529709924194, 116.34991614811891 40.04653000812427, 116.34991593102798 40.04653003470204, 116.34991571129827 40.04653002965026, 116.34991549666272 40.04652999314673, 116.34991530482677 40.04652994563973, 116.34991311448353 40.046529606403936, 116.34991299876809 40.04652959766065, 116.34991063937919 40.04652960720553, 116.34990890820895 40.046529745699154, 116.34990867469952 40.04652974640181, 116.34990641209315 40.04652957914685, 116.3499062908457 40.0465295800163, 116.34990384667452 40.04652980091102, 116.34990370277684 40.04652982561448, 116.34990337058372 40.04652984534174, 116.3499023995036 40.0465297963614, 116.34990080401839 40.046529818497326, 116.34990053785879 40.046529798738256, 116.34990028445763 40.04652973311979, 116.34990005701026 40.04652962505888, 116.34989986924114 40.04652951119139, 116.34989896590173 40.04652909202933, 116.34989878708762 40.04652899006605, 116.34989863659669 40.0465288639487, 116.34989851986231 40.04652871823074, 116.3498984410992 40.0465285581733, 116.34989840315107 40.04652838955525, 116.34989840738817 40.04652821846455, 116.34989845365745 40.04652805107841, 116.34989854028825 40.04652789344031, 116.34989965247244 40.04652630920859, 116.3499000082903 40.04652565863371, 116.3499006484778 40.04652408277857, 116.34990067043259 40.04652400302986, 116.34990090813173 40.04652244299258, 116.34990091074444 40.046522361503335, 116.3499007615744 40.046520714330285, 116.34990061717977 40.046520044376635, 116.34990011396346 40.04651853253145, 116.34990007828037 40.04651845540869, 116.34989922777626 40.046517040819445, 116.34989917448156 40.04651696995116, 116.34989800419571 40.046515697406825, 116.3498979350573 40.046515635144075, 116.3498964838232 40.046514546871144, 116.34989640113601 40.04651449528064, 116.34989573564415 40.0465141523088, 116.34989555961982 40.04651404108895, 116.34989525941107 40.046513810328776, 116.34989516907743 40.04651375355549, 116.34989331680097 40.04651280970444, 116.34989321359242 40.0465127678558, 116.34989115425162 40.046512125638124, 116.3498910422824 40.046512100382294, 116.34988885797743 40.046511785401485, 116.34988874171127 40.046511777745366, 116.34988827217565 40.0465117829883, 116.34988802658864 40.04651176578543, 116.34988652243594 40.04651153588489, 116.34988346375913 40.046511378608045, 116.34988043347269 40.04651153532009, 116.34987744005113 40.04651177994721, 116.34987572048976 40.04651202503118, 116.34987563281008 40.04651204309983, 116.34987390153655 40.046512517448186, 116.34987317446648 40.04651276897194, 116.34987161741856 40.04651341736737, 116.34986930394236 40.04651455940369, 116.34986754703468 40.04651563003004, 116.34986746751274 40.046515689133535, 116.34986608367448 40.04651693604091, 116.34986601949552 40.04651700657379, 116.34986497044936 40.04651843341624, 116.34986492494978 40.0465185120606, 116.34986424919924 40.04652006646832, 116.34986422469393 40.04652014818661, 116.34986393562214 40.04652190651035), (116.34992552620734 40.0465485432582, 116.3499253415147 40.04654844878435, 116.34992518330175 40.046548329249596, 116.34992505724014 40.04654818893893, 116.34992496784874 40.04654803288209, 116.34992491833205 40.0465478666733, 116.34992491046506 40.046547696270686, 116.34992494452976 40.046547527782685, 116.34992501930508 40.04654736724917, 116.34992513211044 40.046547220424785, 116.34992527890218 40.0465470925728, 116.34992545441824 40.046546988276354, 116.34992565236678 40.046546911274184, 116.34992586565187 40.04654686432662, 116.34992672579641 40.04654674121049, 116.34992697948768 40.04654672648952, 116.3499310137961 40.046546830123106, 116.34993232628543 40.04654682118273, 116.3499325461017 40.04654683564774, 116.34993275849415 40.046546881522154, 116.34993295593385 40.04654695717984, 116.34993313142223 40.04654705993892, 116.34993403134034 40.0465476982834, 116.3499341215111 40.04654775079432, 116.34993595643267 40.04654861832892, 116.34993605807637 40.04654865650618, 116.34993807608133 40.04654923612644, 116.34993818539076 40.04654925854003, 116.3499403108822 40.04654952853263, 116.34994042376229 40.04654953434286, 116.34994257711723 40.04654948459369, 116.34994268933944 40.046549473582886, 116.34994430591516 40.046549190658475, 116.34994455803383 40.046549168199654, 116.34994484856894 40.04654916666297, 116.34994496083414 40.046549157585986, 116.34994720490614 40.0465487986954, 116.34995186739708 40.04654768035946, 116.34995865868737 40.04654584184257, 116.34996021177287 40.04654531646902, 116.34996033926494 40.04654526336186, 116.34996052685158 40.04654520081804, 116.34996404185428 40.04654429971165, 116.34996511544789 40.04654398086954, 116.3499686149065 40.04654279417189, 116.34996871025103 40.04654276559373, 116.34997653620994 40.04654071842861, 116.34998507424513 40.04653877110997, 116.34998612757902 40.04653845511674, 116.34998634371172 40.0465384080436, 116.34998679609973 40.04653834472365, 116.34999940959466 40.04653544512316, 116.35000126626396 40.04653487901097, 116.35001388944565 40.04653006048459, 116.35001395327771 40.04653003792597, 116.35002295801564 40.046527103627504, 116.3500337036523 40.04652317363787, 116.35003391293814 40.04652311510939, 116.35003413285247 40.046523088069925, 116.35003435545141 40.0465230934962, 116.35003457269413 40.04652313119222, 116.35003477673315 40.04652319979629, 116.35003496019813 40.04652329683026, 116.35003511646187 40.046523418789015, 116.35003523987965 40.04652356126708, 116.35003532599326 40.046523719117786, 116.35003537169214 40.04652388663913, 116.35003537532559 40.04652405777984, 116.35003533676219 40.046524226357846, 116.35003525739505 40.04652438628367, 116.35003372277123 40.04652676949471, 116.3500336835544 40.04652682535411, 116.35003239871361 40.04652851050091, 116.35002678293554 40.046538048710964, 116.35002673745937 40.046538117865055, 116.35002434928388 40.046541391543144, 116.35002394129627 40.04654200168959, 116.35002110070963 40.046546657125894, 116.3500171484242 40.04655270294723, 116.35001637134881 40.04655400247991, 116.35001626857863 40.04655414066405, 116.35001621600172 40.046554198757306, 116.35001580621058 40.0465547303097, 116.35001560970132 40.046554920829905, 116.35001519617416 40.04655522601356, 116.35001512261832 40.04655529211357, 116.35001381280358 40.04655674152569, 116.35001355720512 40.04655709169554, 116.35001342791874 40.04655723447916, 116.3500130213834 40.04655760190662, 116.35001257487973 40.046558057364805, 116.35001108143781 40.04656003710224, 116.35000964780451 40.04656250568262, 116.35000962063356 40.04656254928471, 116.35000885742728 40.04656369409379, 116.350007168546 40.04656637943635, 116.35000614945974 40.04656808113864, 116.3500060257774 40.04656824151422, 116.35000586177937 40.046568378881666, 116.35000566449357 40.04656848735434, 116.35000544237438 40.04656856228383, 116.35000416908262 40.04656887566511, 116.3500040593996 40.046568912558335, 116.35000207486662 40.04656977607686, 116.35000197844077 40.04656982873665, 116.35000017895301 40.046571048738805, 116.34999802523292 40.04657283953478, 116.34999665440884 40.04657422979711, 116.34999494445383 40.04657635502653, 116.34999487339728 40.046576433663596, 116.34999235484335 40.04657892677727, 116.349992200637 40.04657905241869, 116.34999201805809 40.04657915312483, 116.34999181382217 40.04657922519156, 116.34999159544151 40.04657926596813, 116.34999137094835 40.04657927395475, 116.34999114859991 40.046579248857626, 116.34999093657476 40.046579191599875, 116.34999074267128 40.046579104287524, 116.34998685966573 40.04657694653286, 116.34998509691754 40.0465761438035, 116.34998499970123 40.0465761083764, 116.34998307597152 40.0465755676493, 116.34998297195466 40.04657554651326, 116.34998132358267 40.0465753338257, 116.34998108076881 40.04657528133969, 116.34998085819522 40.046575190133545, 116.3499688290658 40.046568896756476, 116.34996761996274 40.04656838501549, 116.34996744815291 40.04656829625413, 116.3499672993486 40.046568185641185, 116.34996462763873 40.046565814136294, 116.3499630117627 40.04656463740308, 116.34996292045031 40.0465645831238, 116.34996093069061 40.04656363323891, 116.34995769453985 40.046562406908116, 116.34995744961766 40.04656228259647, 116.34995084404869 40.04655792584203, 116.34994924467834 40.046557045905445, 116.34994915675203 40.04655700605371, 116.34994728584503 40.04655632512726, 116.34993327138126 40.04655232241369, 116.3499321460624 40.046552088135016, 116.34993192479786 40.046552022995925, 116.34993172510706 40.046551924979454, 116.34992832092482 40.04654985376717, 116.34992657496208 40.04654897569927, 116.34992552620734 40.0465485432582))</textarea>
            <div class="coord-settings" style="margin-bottom:8px;font-size:12px;color:#333;">
                <label>WKT坐标系：
                    <select id="coordSysSelect" style="margin-left:6px;">
                        <option value="wgs84" selected>WGS84</option>
                        <option value="gcj02">GCJ-02（国测局）</option>
                        <option value="bd09">BD-09（百度）</option>
                        <option value="cgcs2000">CGCS2000</option>
                    </select>
                </label>
                <!-- 已移除“不进行绘制坐标转换”选项，统一使用WGS84绘制 -->
            </div>

            <div class="button-group">
                <button id="drawButton" disabled>绘制轮廓</button>
                <button id="clearButton" disabled>清空轮廓</button>
            </div>
            <!-- 显示开关：仅保留显示亩数 -->
            <div class="display-toggles" style="margin-top:8px;font-size:12px;color:#333;">
                <label><input type="checkbox" id="toggleLabelsCheckbox"> 显示亩数</label>
            </div>
        </div>

        <div class="tab-pane" id="tabSplit">
            <!-- MultiPolygon → 多个 Polygon 分割器 -->
            <div class="split-section">
                <div class="title">MultiPolygon → 多个 Polygon 分割器</div>
                <div class="desc">输入一个 MULTIPOLYGON WKT，分割为多行 POLYGON WKT。</div>
                <textarea id="multiInput"></textarea>
                <div class="split-actions">
                    <button id="splitMultiBtn">分割为多个 POLYGON</button>
                    <button id="copyPolysBtn">复制结果</button>
                </div>
                <textarea id="polyOutput" readonly></textarea>
            </div>
        </div>

        <div class="tab-pane" id="tabBatch">
            <!-- 批量POLYGON → MULTIPOLYGON 生成器 -->
            <div class="batch-section">
                <div class="title">批量POLYGON → MULTIPOLYGON 合并器</div>
                <div class="desc">每行一个 POLYGON WKT（或用分号分隔）。生成后可一键填充到上方并绘制。</div>
                <textarea id="batchInput"></textarea>
                <div class="batch-actions">
                    <button id="generateMultiBtn">生成 MULTIPOLYGON</button>
                    <button id="copyMultiBtn">复制结果</button>
                </div>
                <textarea id="multiOutput" readonly></textarea>
            </div>
        </div>
        <div class="tab-pane" id="tabTrack">
            <div class="tip">请粘贴轨迹文本（支持两种格式：1）每行一条：定位时间yyyyMMddHHmmss, 经度, 纬度；2）单行#分隔：经度,纬度,定位时间yyyyMMddHHmmss#经度,纬度,定位时间yyyyMMddHHmmss#…）。</div>
            <div class="coord-settings" style="margin-bottom:8px;font-size:12px;color:#333;">
                <label>轨迹坐标系：
                    <select id="trackCoordSysSelect" style="margin-left:6px;">
                        <option value="wgs84" selected>WGS84</option>
                        <option value="gcj02">GCJ-02（国测局）</option>
                        <option value="bd09">BD-09（百度）</option>
                        <option value="cgcs2000">CGCS2000</option>
                    </select>
                </label>
            </div>
            <textarea id="trackTextarea" style="width:100%;height:120px;margin-bottom:10px;padding:8px;border:1px solid #ddd;border-radius:4px;font-family:monospace;resize:vertical;box-sizing:border-box;">20251029101604,116.35009053,40.04646576,0,185
20251029101605,116.35009049,40.04646580,0,260
20251029101607,116.35009106,40.04646441,0,278
20251029101608,116.35009126,40.04646380,0,302
20251029101609,116.35009148,40.04646320,0,190
20251029101610,116.35009151,40.04646301,0,151
20251029101611,116.35009173,40.04646221,0,200
20251029101613,116.35009193,40.04646151,0,315
20251029101614,116.35009193,40.04646151,0,295
20251029101615,116.35009225,40.04646100,0,139
20251029101616,116.35009168,40.04646166,0,221
20251029101617,116.35009138,40.04646190,0,323
20251029101618,116.35009153,40.04646128,0,64
20251029101619,116.35009221,40.04645970,0.1,181
20251029101621,116.35009111,40.04646108,0,316
20251029101622,116.35009016,40.04646251,0,192
20251029101623,116.35008853,40.04646498,0,178
20251029101624,116.35008853,40.04646498,0,213
20251029101625,116.35008851,40.04646500,0,239
20251029101626,116.35008815,40.04646563,0,199
20251029101627,116.35008701,40.04646671,0,338
20251029101628,116.35008696,40.04646678,0,153
20251029101629,116.35008653,40.04646733,0,25
20251029101630,116.35008636,40.04646743,0,126
20251029101631,116.35008635,40.04646745,0,257
20251029101632,116.35008543,40.04646895,0,207
20251029101633,116.35008395,40.04647116,0,149
20251029101634,116.35008390,40.04647121,0,206
20251029101635,116.35008045,40.04647681,0.1,123
20251029101636,116.35007785,40.04648051,0,196
20251029101637,116.35007536,40.04648411,0,185
20251029101638,116.35007265,40.04648900,0,146
20251029101639,116.35007066,40.04649231,0,358
20251029101640,116.35007058,40.04649235,0,158
20251029101641,116.35007058,40.04649238,0,230
20251029101642,116.35006921,40.04649498,0,153
20251029101643,116.35006814,40.04649661,0,37
20251029101644,116.35006813,40.04649661,0,279
20251029101645,116.35006635,40.04649996,0,194
20251029101646,116.35006603,40.04650033,0,169
20251029101647,116.35006603,40.04650035,0,246
20251029101648,116.35006601,40.04650035,0,197
20251029101649,116.35006599,40.04650036,0,218
20251029101650,116.35006601,40.04650035,0,217
20251029101651,116.35006601,40.04650035,0,244
20251029101652,116.35006599,40.04650036,0,245
20251029101653,116.35006601,40.04650035,0,93
20251029101654,116.35006601,40.04650035,0,303
20251029101655,116.35006601,40.04650033,0,161
20251029101656,116.35006521,40.04650164,0,218
20251029101657,116.35006506,40.04650173,0,221
20251029101658,116.35006508,40.04650173,0,216
20251029101659,116.35006508,40.04650173,0,259
20251029101700,116.35006508,40.04650173,0,270
20251029101701,116.35006506,40.04650173,0,249
20251029101702,116.35006505,40.04650175,0,186
20251029101703,116.35006505,40.04650175,0,197
20251029101704,116.35006505,40.04650173,0,332
20251029101705,116.35006426,40.04650285,0,30
20251029101706,116.35006368,40.04650371,0.4,323
20251029101707,116.35006173,40.04650666,0.4,339
20251029101708,116.35006011,40.04650878,0.3,339
20251029101709,116.35006010,40.04650880,0,303
20251029101710,116.35006010,40.04650880,0,238
20251029101711,116.35005998,40.04650891,0,171
20251029101712,116.35005953,40.04650920,0,190
20251029101713,116.35005880,40.04650998,0,206
20251029101714,116.35005880,40.04650998,0,320
20251029101715,116.35005875,40.04651001,0,162
20251029101716,116.35005843,40.04651061,0,50
20251029101717,116.35005831,40.04651046,2.1,153
20251029101718,116.35005893,40.04650878,0,107
20251029101719,116.35005875,40.04650905,0,162
20251029101720,116.35005866,40.04650910,0,306
20251029101721,116.35005871,40.04650906,0,209
20251029101722,116.35005868,40.04650906,0,310
20251029101723,116.35005843,40.04650936,0,102
20251029101724,116.35005685,40.04651195,0,105
20251029101725,116.35005531,40.04651386,0,330
20251029101726,116.35005160,40.04652020,0.1,271
20251029101727,116.35004871,40.04652405,0,274
20251029101728,116.35004861,40.04652408,0,167
20251029101729,116.35004855,40.04652410,0,144
20251029101730,116.35004855,40.04652410,0,205
20251029101731,116.35004796,40.04652496,0,193
20251029101732,116.35004341,40.04653205,0,122
20251029101733,116.35004310,40.04653218,0,199
20251029101734,116.35003993,40.04653769,0,304
20251029101735,116.35003723,40.04654215,0,297
20251029101736,116.35003476,40.04654576,0,247
20251029101737,116.35003473,40.04654576,0,137
20251029101738,116.35003468,40.04654578,0,222
20251029101739,116.35003456,40.04654581,0,118
20251029101740,116.35003458,40.04654590,0,244
20251029101741,116.35003165,40.04655058,0,337
20251029101742,116.35002900,40.04655471,0,13
20251029101743,116.35002770,40.04655673,0,247
20251029101744,116.35002761,40.04655676,0,230
20251029101745,116.35002625,40.04655905,0,192
20251029101746,116.35002621,40.04655890,0,135
20251029101747,116.35002605,40.04655910,0,206
20251029101748,116.35002486,40.04656078,0,298
20251029101749,116.35002398,40.04656163,0,306
20251029101750,116.35002406,40.04656111,0,308
20251029101751,116.35002306,40.04656248,0,143
20251029101752,116.35002229,40.04656311,0,287
20251029101753,116.35002190,40.04656350,0,313
20251029101754,116.35002166,40.04656398,0,243
20251029101755,116.35002168,40.04656390,0,43
20251029101756,116.35002136,40.04656470,0,237
20251029101757,116.35002035,40.04656631,0,215
20251029101758,116.35002020,40.04656643,0,137
20251029101759,116.35001983,40.04656705,0,195
20251029101800,116.35001930,40.04656781,0,191
20251029101801,116.35001928,40.04656781,0,192
20251029101802,116.35001873,40.04656868,0,165
20251029101803,116.35001781,40.04657015,0,62
20251029101804,116.35001606,40.04657306,0,273
20251029101805,116.35001575,40.04657368,0,114
20251029101806,116.35001495,40.04657520,0,163
20251029101807,116.35001371,40.04657736,0,48
20251029101808,116.35001228,40.04657995,0,63
20251029101809,116.35001186,40.04658068,0,49
20251029101810,116.35000951,40.04658466,0,137
20251029101811,116.35000868,40.04658620,0,235
20251029101812,116.35000858,40.04658625,0,213
20251029101813,116.35000811,40.04658699,0,166
20251029101814,116.35000685,40.04658918,0,252
20251029101815,116.35000618,40.04659033,0,76
20251029101816,116.35000370,40.04659488,0.1,125
20251029101817,116.34999921,40.04660186,0,214
20251029101818,116.34999828,40.04660326,0,222
20251029101819,116.34999826,40.04660326,0,235
20251029101820,116.34999806,40.04660331,0,222
20251029101821,116.34999823,40.04660328,0,261
20251029101822,116.34999821,40.04660330,0,219
20251029101823,116.34999821,40.04660330,0,246
20251029101824,116.34999803,40.04660330,0,229
20251029101825,116.34999646,40.04660561,0,24
20251029101826,116.34999536,40.04660763,0,24
20251029101827,116.34999533,40.04660763,0,193
20251029101828,116.34999473,40.04660858,0,233
20251029101829,116.34999385,40.04661013,0,275
20251029101830,116.34999116,40.04661446,0,197
20251029101831,116.34999068,40.04661503,0,215
20251029101832,116.34998960,40.04661696,0,139
20251029101833,116.34998825,40.04661933,0,175
20251029101834,116.34998625,40.04662323,0.1,189
20251029101835,116.34998275,40.04662973,0,182
20251029101836,116.34998086,40.04663333,0,216
20251029101837,116.34997971,40.04663613,0,205
20251029101838,116.34997843,40.04663818,0,315
20251029101839,116.34997753,40.04663973,0,342
20251029101840,116.34997593,40.04664400,0.1,344
20251029101841,116.34997380,40.04664835,0.1,278
20251029101842,116.34997186,40.04665216,0.1,300
20251029101843,116.34997050,40.04665468,0,259
20251029101844,116.34996870,40.04665781,0,273
20251029101845,116.34996781,40.04665950,0,172
20251029101846,116.34996670,40.04666246,0,152
20251029101847,116.34996588,40.04666396,0.1,170
20251029101848,116.34996493,40.04666593,0,200
20251029101849,116.34996413,40.04666753,0,279
20251029101850,116.34996368,40.04666860,0,299
20251029101851,116.34996335,40.04666933,0.1,197
20251029101852,116.34996308,40.04666995,0,201
20251029101853,116.34996306,40.04667020,0,83
20251029101855,116.34996355,40.04666985,0.2,287
20251029101856,116.34996336,40.04666975,0.1,337
20251029101857,116.34996303,40.04667154,0.1,329
20251029101859,116.34996350,40.04667108,0,205
20251029101900,116.34996343,40.04667126,0,0
20251029101901,116.34996356,40.04667121,0,182
20251029101902,116.34996343,40.04667128,0.1,162
20251029101904,116.34996358,40.04667113,0,132
20251029101905,116.34996283,40.04667244,0.1,246
20251029101906,116.34996265,40.04667273,0,204
20251029101907,116.34996271,40.04667269,0,303
20251029101908,116.34996281,40.04667295,0,294
20251029101910,116.34996281,40.04667295,0,234
20251029101911,116.34996216,40.04667463,0,297
20251029101912,116.34996181,40.04667581,0,203
20251029101913,116.34996126,40.04667731,0,281
20251029101914,116.34996051,40.04667908,0.1,166
20251029101925,116.34995685,40.04668874,0.4,339
20251029101926,116.34995563,40.04669156,0.4,343
20251029101927,116.34995395,40.04669513,1,349
20251029101928,116.34994900,40.04670375,0.1,313
20251029101929,116.34994510,40.04670993,0,141
20251029101930,116.34994518,40.04670991,0,188
20251029101931,116.34994519,40.04670991,0,293
20251029101932,116.34994518,40.04670991,0,294
20251029101943,116.34994700,40.04670620,0,242
20251029101944,116.34994905,40.04670150,0.5,218
20251029101945,116.34995295,40.04669251,0,211
20251029101946,116.34995343,40.04669130,0,195
20251029101947,116.34995338,40.04669131,0,158
20251029101948,116.34995326,40.04669135,0,308
20251029101949,116.34995335,40.04669133,0,316
20251029101950,116.34995361,40.04669066,0,265
20251029101951,116.34995386,40.04668920,0,247
20251029101952,116.34995388,40.04668920,0,263
20251029101953,116.34995388,40.04668920,0,306
20251029101954,116.34995278,40.04669026,0,250
20251029101955,116.34995421,40.04668685,0,203
20251029101956,116.34995564,40.04668388,0,275
20251029101957,116.34995566,40.04668386,0,213
20251029101958,116.34995636,40.04668146,0,149
20251029101959,116.34995713,40.04667906,0,235
20251029102000,116.34995873,40.04667425,0,168
20251029102001,116.34995920,40.04667290,0,92
20251029102002,116.34995925,40.04667288,0,127
20251029102003,116.34996018,40.04667013,0,31
20251029102004,116.34996088,40.04666870,0,22
20251029102005,116.34996105,40.04666865,0,249
20251029102006,116.34996101,40.04666865,0,232
20251029102007,116.34996108,40.04666863,0,293
20251029102008,116.34996100,40.04666865,0,163
20251029102009,116.34996100,40.04666865,0,244
20251029102010,116.34996101,40.04666865,0,270
20251029102011,116.34996101,40.04666865,0,252
20251029102012,116.34996101,40.04666865,0,204
20251029102013,116.34996098,40.04666865,0,240
20251029102014,116.34996106,40.04666858,0,309
20251029102015,116.34996109,40.04666861,0,200
20251029102016,116.34996496,40.04666028,0,280
20251029102017,116.34996665,40.04665686,0,239
20251029102018,116.34996663,40.04665691,0,271
20251029102019,116.34996663,40.04665691,0,296
20251029102020,116.34996666,40.04665688,0,185
20251029102021,116.34996668,40.04665686,0,279
20251029102022,116.34996715,40.04665578,0,207
20251029102023,116.34996890,40.04665168,0,188
20251029102024,116.34997021,40.04664871,0,152
20251029102025,116.34997300,40.04664221,0.1,336
20251029102026,116.34997350,40.04664118,0,343
20251029102027,116.34997351,40.04664116,0,243
20251029102028,116.34997350,40.04664123,0,218
20251029102029,116.34997353,40.04664123,0,199
20251029102030,116.34997353,40.04664123,0,259
20251029102031,116.34997321,40.04664198,0,91
20251029102032,116.34997398,40.04664008,0.7,166
20251029102033,116.34997514,40.04663740,0,307
20251029102034,116.34997625,40.04663518,0.2,352
20251029102035,116.34997653,40.04663453,0,197
20251029102037,116.34997655,40.04663451,0,182
20251029102038,116.34997703,40.04663230,0,275
20251029102039,116.34997810,40.04662813,1,179
20251029102040,116.34997811,40.04662808,0,336
20251029102041,116.34997813,40.04662808,0,166
20251029102042,116.34997813,40.04662806,0,186
20251029102043,116.34997813,40.04662804,0,319
20251029102044,116.34997814,40.04662804,0,327
20251029102045,116.34997868,40.04662636,0.1,245
20251029102046,116.34997943,40.04662301,0,252
20251029102047,116.34998029,40.04662098,0,255
20251029102048,116.34998029,40.04662098,0,171
20251029102049,116.34998029,40.04662099,0,204
20251029102050,116.34998033,40.04662098,0,159
20251029102051,116.34998085,40.04661959,0,241
20251029102052,116.34998288,40.04661441,0,57
20251029102053,116.34998396,40.04661205,0,275
20251029102054,116.34998401,40.04661198,0,318
20251029102055,116.34998400,40.04661203,0,341
20251029102056,116.34998398,40.04661203,0,339
20251029102057,116.34998401,40.04661199,0,39
20251029102058,116.34998403,40.04661198,0,228
20251029102059,116.34998688,40.04660551,0.1,220
20251029102100,116.34998735,40.04660480,0,198
20251029102101,116.34998730,40.04660486,0,3
20251029102102,116.34998731,40.04660485,0,79
20251029102103,116.34998943,40.04660123,0,51
20251029102104,116.34999326,40.04659441,0,6
20251029102105,116.34999341,40.04659433,0,3
20251029102106,116.34999343,40.04659431,0,339
20251029102107,116.34999551,40.04659121,0,166
20251029102108,116.34999601,40.04659050,0,70
20251029102109,116.34999811,40.04658826,0,180
20251029102110,116.34999811,40.04658826,0,154
20251029102111,116.34999811,40.04658825,0,144
20251029102112,116.34999943,40.04658668,0.2,157
20251029102113,116.35000158,40.04658448,0,63
20251029102114,116.35000455,40.04658154,0,32
20251029102115,116.35000665,40.04657893,0,358
20251029102116,116.35000881,40.04657714,0,221
20251029102117,116.35000938,40.04657786,0,166
20251029102118,116.35000938,40.04657788,0,130
20251029102119,116.35000936,40.04657789,0,125
20251029102120,116.35000936,40.04657789,0,118
20251029102121,116.35000936,40.04657789,0,127
20251029102122,116.35000645,40.04658103,0,55
20251029102123,116.35000591,40.04658141,0,76
20251029102124,116.35000591,40.04658141,0,44
20251029102125,116.35000591,40.04658143,0,120
20251029102126,116.35000528,40.04658260,0,171
20251029102127,116.35000530,40.04658303,0,200
20251029102128,116.35000530,40.04658304,0,131
20251029102129,116.35000528,40.04658304,0,154
20251029102130,116.35000530,40.04658304,0,120
20251029102131,116.35000530,40.04658304,0,112
20251029102132,116.35000528,40.04658304,0,129
20251029102133,116.35000530,40.04658304,0,69
20251029102134,116.35000530,40.04658304,0,1
20251029102135,116.35000528,40.04658306,0,117
20251029102136,116.35000190,40.04658828,0.7,233
20251029102137,116.35000151,40.04658873,0.1,319
20251029102138,116.35000151,40.04658873,0.2,341
20251029102139,116.35000153,40.04658875,0.2,357
20251029102140,116.35000151,40.04658875,0.1,353
20251029102141,116.35000149,40.04658876,0.1,4
20251029102142,116.35000355,40.04659093,0.1,23
20251029102143,116.35000438,40.04659258,0,38
20251029102144,116.35000453,40.04659281,0,104
20251029102145,116.35000801,40.04659606,0.1,13
20251029102146,116.35000895,40.04659703,0,352
20251029102147,116.35001018,40.04659826,0.1,296
20251029102148,116.35001128,40.04660005,0.5,173
20251029102149,116.35001433,40.04660410,0.3,355
20251029102150,116.35001528,40.04660708,0,325
20251029102152,116.35001568,40.04660755,0.1,347
20251029102153,116.35001615,40.04660910,0,345
20251029102155,116.35002168,40.04661613,0.2,97
20251029102156,116.35002553,40.04661868,0.5,74
20251029102157,116.35002553,40.04661868,0.3,66
20251029102158,116.35002823,40.04662231,0.2,116
20251029102159,116.35002453,40.04662160,0.1,25
20251029102200,116.35002453,40.04662168,0,70
20251029102201,116.35002453,40.04662171,0,139
20251029102202,116.35002451,40.04662171,0,109
20251029102203,116.35002520,40.04662216,0.1,130
20251029102204,116.35002805,40.04662370,0.3,159
20251029102205,116.35002963,40.04662389,0.3,136
20251029102206,116.35003096,40.04662426,0.1,99
20251029102207,116.35003441,40.04662398,2.7,186
20251029102208,116.35003655,40.04662188,0.5,191
20251029102209,116.35003833,40.04662216,0.3,329
20251029102210,116.35004011,40.04662293,0.1,135
20251029102211,116.35004266,40.04662351,0.1,112
20251029102212,116.35004533,40.04662521,0.1,82
20251029102213,116.35004950,40.04662801,0.4,166
20251029102214,116.35005480,40.04663003,0,34
20251029102215,116.35005263,40.04662925,0.1,135
20251029102216,116.35005211,40.04663095,0.2,134
20251029102217,116.35003881,40.04662165,0.2,132
20251029102218,116.35003125,40.04661683,0.2,121
20251029102219,116.35002405,40.04661116,0,132
20251029102220,116.35002411,40.04661143,0,127
20251029102221,116.35001391,40.04660518,0,85
20251029102222,116.35000681,40.04660123,0.1,89
20251029102223,116.34999664,40.04659351,0.1,44
20251029102224,116.34998003,40.04658426,0.1,56
20251029102225,116.34997903,40.04658513,0,108
20251029102226,116.34996228,40.04657636,0,200
20251029102227,116.34996181,40.04657708,0,242
20251029102228,116.34995580,40.04657173,0,74
20251029102229,116.34995105,40.04656993,0,124
20251029102230,116.34994325,40.04656478,0,50
20251029102231,116.34993835,40.04656338,0,95
20251029102232,116.34992914,40.04656075,0,309
20251029102233,116.34992899,40.04656108,0,134
20251029102234,116.34992890,40.04656119,0,103
20251029102235,116.34992846,40.04656143,0,100
20251029102236,116.34992108,40.04655693,0,37
20251029102237,116.34991800,40.04655566,0,94
20251029102238,116.34991786,40.04655578,0,107
20251029102239,116.34991451,40.04655390,0,197
20251029102240,116.34991291,40.04655268,0,113
20251029102241,116.34991300,40.04655270,0,82
20251029102242,116.34991161,40.04655159,0,316
20251029102243,116.34990638,40.04654811,0,358
20251029102244,116.34990353,40.04654550,0,315
20251029102245,116.34990248,40.04654425,0,103
20251029102246,116.34989766,40.04654118,0,155
20251029102247,116.34989315,40.04653923,0,0
20251029102248,116.34988758,40.04653801,0,19
20251029102249,116.34988618,40.04653630,0.1,110
20251029102250,116.34988176,40.04653363,0.1,104
20251029102251,116.34987906,40.04653208,0.1,82
20251029102252,116.34987903,40.04653156,0.7,45
20251029102253,116.34987878,40.04653163,0.6,112
20251029102254,116.34988148,40.04652993,1.9,116
20251029102255,116.34988053,40.04652798,0.9,104
20251029102256,116.34987876,40.04652618,0.8,107
20251029102257,116.34987813,40.04652478,0.5,113
20251029102258,116.34987596,40.04652458,0.5,111
20251029102259,116.34987616,40.04652455,0.5,127
20251029102300,116.34987626,40.04652416,0.4,120
20251029102301,116.34987538,40.04652365,0.3,131
20251029102302,116.34987585,40.04652295,0.2,137
20251029102303,116.34987628,40.04652226,0.1,146
20251029102304,116.34987565,40.04652213,0,98
20251029102305,116.34987585,40.04652203,0,93
20251029102306,116.34987798,40.04652098,0.1,93
20251029102307,116.34987871,40.04652073,0.5,92
20251029102309,116.34988168,40.04652049,0.4,57
20251029102310,116.34988418,40.04652036,0.3,65
20251029102311,116.34988563,40.04652058,0.2,53
20251029102312,116.34988700,40.04652081,0.3,35
20251029102313,116.34988763,40.04652093,0.1,26
20251029102314,116.34988741,40.04652101,0.1,32
20251029102315,116.34988780,40.04652075,0.1,51
20251029102316,116.34988745,40.04652106,0.1,45
20251029102317,116.34988786,40.04652110,0.1,24
20251029102318,116.34988844,40.04652125,0,40
20251029102319,116.34988906,40.04652151,0.1,35
20251029102320,116.34988920,40.04652218,0.2,44
20251029102321,116.34988885,40.04652283,0.1,41
20251029102322,116.34988433,40.04652425,0.4,37
20251029102323,116.34988455,40.04652426,0.6,91
20251029102324,116.34988483,40.04652479,0.1,67
20251029102325,116.34988486,40.04652550,0.1,69
20251029102326,116.34988330,40.04652656,0,28
20251029102327,116.34988146,40.04652763,0.2,1
20251029102328,116.34988093,40.04652840,0.1,348
20251029102329,116.34988066,40.04652873,0.1,335
20251029102330,116.34987931,40.04652908,0.1,331
20251029102331,116.34987871,40.04653011,0.1,335
20251029102332,116.34987840,40.04653059,0.1,335
20251029102333,116.34987835,40.04653063,0.1,315
20251029102334,116.34987796,40.04653078,0.1,329
20251029102335,116.34987691,40.04653143,0.1,352
20251029102336,116.34987630,40.04653210,0.1,19
20251029102337,116.34987746,40.04653218,0.1,10
20251029102338,116.34987796,40.04653191,0,1
20251029102339,116.34987801,40.04653205,0.5,163
20251029102340,116.34987951,40.04653365,0.5,15
20251029102341,116.34988118,40.04653431,0.2,28
20251029102342,116.34988226,40.04653480,0.2,7
20251029102343,116.34988168,40.04653628,0.1,319
20251029102344,116.34988401,40.04653604,0.2,0
20251029102345,116.34988698,40.04653603,0.2,14
20251029102346,116.34988893,40.04653601,0.2,16
20251029102347,116.34989135,40.04653618,0.2,68
20251029102348,116.34989291,40.04653675,0.1,27
20251029102349,116.34989329,40.04653893,0.3,51
20251029102350,116.34990266,40.04653880,0.5,43
20251029102351,116.34990413,40.04653898,0.2,96
20251029102352,116.34990646,40.04653858,0.2,104
20251029102353,116.34990691,40.04653896,0.1,92
20251029102354,116.34990856,40.04653886,0.2,91
20251029102355,116.34991191,40.04653856,0.1,74
20251029102356,116.34991179,40.04653921,0.6,286
20251029102357,116.34991100,40.04653961,0.4,296
20251029102358,116.34991500,40.04653930,0.5,315
20251029102359,116.34991720,40.04653923,0.1,163
20251029102400,116.34991981,40.04653856,0.1,59
20251029102401,116.34992598,40.04653769,0.2,46
20251029102402,116.34993143,40.04653783,0.2,37
20251029102403,116.34993548,40.04653775,0.2,21
20251029102404,116.34994129,40.04653721,0.2,38
20251029102405,116.34994341,40.04653816,0.5,355
20251029102406,116.34994115,40.04654055,0.1,285
20251029102407,116.34994393,40.04653984,0,43
20251029102408,116.34994368,40.04654021,0,107
20251029102409,116.34994796,40.04653919,0,40
20251029102410,116.34995473,40.04653736,0,38
20251029102411,116.34995525,40.04653706,0,68
20251029102412,116.34996036,40.04653575,0,101
20251029102413,116.34996440,40.04653438,0,16
20251029102414,116.34997296,40.04653214,0,6
20251029102415,116.34998170,40.04653015,0.1,27
20251029102416,116.34998220,40.04652976,0,13
20251029102417,116.34998338,40.04652973,0,333
20251029102418,116.34999601,40.04652683,0.7,48
20251029102420,116.35000903,40.04652186,0.1,18
20251029102421,116.35001790,40.04651898,0.1,21
20251029102422,116.35002476,40.04651638,0.1,355
20251029102423,116.35003354,40.04651326,0.1,1
20251029102424,116.35004643,40.04650915,0.1,346
20251029102425,116.35005090,40.04650715,0.1,339
20251029102426,116.35005951,40.04650515,0.1,334
20251029102427,116.35006668,40.04650318,0.1,340
20251029102428,116.35007473,40.04649975,0,354
20251029102429,116.35007473,40.04649860,0,305
20251029102430,116.35007673,40.04649775,0,255
20251029102431,116.35008289,40.04649400,0,331
20251029102432,116.35008416,40.04649288,0,339
20251029102433,116.35008390,40.04649286,0,329
20251029102434,116.35008434,40.04649169,0,2
20251029102435,116.35008590,40.04649088,0,145
20251029102436,116.35009100,40.04648923,0,48
20251029102437,116.35009711,40.04648316,1.5,199
20251029102438,116.35009843,40.04648060,0.5,263
20251029102439,116.35009935,40.04648015,0.3,314
20251029102440,116.35010246,40.04647883,0.2,338
20251029102441,116.35010423,40.04647756,0.1,340
20251029102442,116.35010701,40.04647616,0.1,349
20251029102443,116.35010860,40.04647526,0.2,340
20251029102444,116.35011071,40.04647361,0.1,354
20251029102445,116.35011413,40.04647151,0,348
20251029102446,116.35011598,40.04647025,0,338
20251029102447,116.35011785,40.04646915,0,343
20251029102448,116.35011738,40.04646815,0,278
20251029102450,116.35011956,40.04646541,0,330
20251029102451,116.35011921,40.04646218,0,319
20251029102452,116.35011931,40.04646065,0,284
20251029102453,116.35011911,40.04646020,0,333
20251029102454,116.35011916,40.04646018,0,318
20251029102455,116.35012206,40.04645716,0.1,20
20251029102456,116.35012215,40.04645713,0,355
20251029102457,116.35012386,40.04645601,0,344
20251029102458,116.35012513,40.04645458,0,351
20251029102459,116.35012525,40.04645455,0,331
20251029102500,116.35012610,40.04645220,0.1,12
20251029102501,116.35012658,40.04645081,0.1,30
20251029102502,116.35012703,40.04645006,0,331
20251029102503,116.35012965,40.04644819,1,38
20251029102504,116.35013093,40.04644800,0.1,100
20251029102505,116.35013221,40.04644685,0.1,118
20251029102506,116.35013341,40.04644568,0.1,145
20251029102507,116.35013403,40.04644415,0.1,129
20251029102508,116.35013620,40.04644230,0.1,74
20251029102509,116.35013786,40.04643971,0,79
20251029102510,116.35013825,40.04643918,0,229
20251029102511,116.35014021,40.04643715,0,207
20251029102512,116.35014060,40.04643685,0,96
20251029102513,116.35014063,40.04643683,0,59
20251029102514,116.35014068,40.04643681,0,116
20251029102515,116.35014255,40.04643555,0,78
20251029102516,116.35014263,40.04643551,0,99
20251029102517,116.35014238,40.04643523,0,75
20251029102518,116.35014225,40.04643420,0,152
20251029102519,116.35013790,40.04643250,0,106
20251029102520,116.35013779,40.04643226,0,112
20251029102521,116.35013716,40.04643170,0,148</textarea>
            <div class="button-group">
                <button id="drawTrackButton" disabled style="flex: 1;">绘制轨迹</button>
                <button id="showTrackPointsButton" disabled style="flex: 1;" class="btn-warning">打点</button>
                <button id="clearTrackButton" disabled style="flex: 1;">清空轨迹</button>
            </div>
            <!-- 回放控制 -->
            <div class="split-section" style="margin-top:8px;">
                <div class="title">轨迹回放</div>
                <div class="playback-actions" style="display:flex;gap:8px;margin-bottom:8px;">
                    <button id="playbackStartBtn" disabled>开始</button>
                    <button id="playbackPauseBtn" disabled>继续</button>
                    <button id="playbackStopBtn" disabled>结束</button>
                </div>
                <div class="playback-speed" style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                    <label>速度：
                        <select id="playbackSpeedSelect" disabled>
                            <option value="1" selected>1×</option>
                            <option value="2">2×</option>
                            <option value="4">4×</option>
                            <option value="8">8×</option>
                            <option value="16">16×</option>
                            <option value="32">32×</option>
                            <option value="64">64×</option>
                            <option value="128">128×</option>
                            <option value="256">256×</option>
                            <option value="512">512×</option>
                            <option value="1024">1024×</option>
                        </select>
                    </label>
                    <span id="playbackTimeLabel" style="font-size:12px;color:#666;">时间：—</span>
                </div>
                <div class="playback-time" style="display:flex;flex-direction:column;gap:4px;margin-bottom:8px;">
                    <label class="playback-time-label" style="display:flex;align-items:center;gap:8px;flex:1 1 auto;min-width:0;">
                        <span class="playback-time-text" style="white-space:nowrap;">起始时间：</span>
                        <input type="range" id="playbackTimeSlider" disabled min="0" max="0" step="1000" value="0" style="flex:1 1 auto;min-width:0;max-width:100%;vertical-align:middle;">
                    </label>
                    <span id="playbackTimeCursor" style="font-size:12px;color:#666;align-self:flex-end;">—</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let map;
    let currentPolygons = []; // 存储多边形和其标签
    let currentTracks = []; // 存储轨迹折线及相关覆盖物
    let mapLoaded = false;
    let mapLabelHandlers = []; // 存储地图事件处理器
    let labelsEnabled = false; // 标签显示开关（默认关闭）
    let isDrawing = false; // 绘制进行中防止重复点击

    window.onload = function () {
        if (typeof T === 'undefined') {
            alert("天地图API加载失败，请检查网络或密钥！");
            return;
        }
        initMap();
        bindDrawEvent();
        bindMinimizeEvent();
        bindTabs();
        bindBatchGenerator();
        bindMultiSplitter();
        bindLabelsToggle(); // 绑定标签显示开关
        bindTrackEvents();  // 绑定轨迹绘制与清空
        bindPlaybackControls(); // 绑定轨迹回放
    };

    function initMap() {
        showLoading();
        disableButtons(true);

        try {
            map = new T.Map("mapContainer", {
                zoom: 12,
                center: new T.LngLat(116.40769, 39.90403)
            });

            // 已移除测试标签
            map.enableScrollWheelZoom();

            // 添加地图类型控件
            const mapTypeCtrl = new T.Control.MapType({
                mapTypes: [TMAP_NORMAL_MAP, TMAP_SATELLITE_MAP, TMAP_TERRAIN_MAP],
                position: T_ANCHOR_TOP_LEFT
            });
            map.addControl(mapTypeCtrl);

            // 加载影像底图（卫星）
            const tk = "648f621977051d0199ff0f965d3fd322";

            // 方案1：使用默认地图类型（作为备选）
            map.setMapType(TMAP_SATELLITE_MAP);

            // 方案2：手动添加影像图层（底图 + 标注）
            const vecLayer = new T.TileLayer(`https://t0.tianditu.gov.cn/img_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=img&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`);
            const cvaLayer = new T.TileLayer(`https://t0.tianditu.gov.cn/cia_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cia&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`);

            // 添加图层并监听加载状态
            vecLayer.addEventListener("load", function () {
                console.log("影像底图加载完成");
            });

            vecLayer.addEventListener("error", function (e) {
                console.error("影像底图加载错误:", e);
                alert("影像底图加载错误，将使用默认地图类型");
            });

            map.addLayer(vecLayer);
            map.addLayer(cvaLayer);

            // 监听地图加载事件
            map.addEventListener("loaded", function () {
                console.log("地图加载完成");
                markMapLoaded();
            });
            map.addEventListener("load", function () {
                console.log("地图load事件触发");
                markMapLoaded();
            });
            map.addEventListener("tilesloaded", function () {
                console.log("地图瓦片加载完成");
                markMapLoaded();
            });
            // 监听地图加载失败事件
            map.addEventListener("error", function (e) {
                console.error("地图加载错误:", e);
                alert("地图加载错误: " + e.message);
                hideLoading();
            });

            // 监听地图移动事件，用于更新标签位置
            const moveHandler = function () {
                updateAllLabelsPosition();
            };
            map.addEventListener("move", moveHandler);
            map.addEventListener("zoom", moveHandler);

            // 存储事件处理器，用于清理
            mapLabelHandlers.push({ event: "move", handler: moveHandler });
            mapLabelHandlers.push({ event: "zoom", handler: moveHandler });

            // 超时容错
            setTimeout(() => {
                if (!mapLoaded) markMapLoaded();
            }, 8000);

        } catch (error) {
            alert("地图初始化失败：" + error.message);
            console.error(error);
            hideLoading();
        }
    }

    function markMapLoaded() {
        if (!mapLoaded) {
            mapLoaded = true;
            hideLoading();
            disableButtons(false);
            disableTrackButtons(false);
            // 仅开启速度选择，回放按钮按状态控制
            const speedSel = document.getElementById('playbackSpeedSelect');
            if (speedSel) speedSel.disabled = false;
            updatePlaybackButtonsState('idle');
        }
    }

    function showLoading() {
        const loading = document.getElementById("mapLoading");
        loading.style.display = "flex";
        loading.style.opacity = "1";
    }

    function hideLoading() {
        const loading = document.getElementById("mapLoading");
        loading.style.opacity = "0";
        setTimeout(() => loading.style.display = "none", 300);
    }

    function disableButtons(disabled) {
        document.getElementById("drawButton").disabled = disabled;
        document.getElementById("clearButton").disabled = disabled;
    }

    function disableTrackButtons(disabled) {
        const drawTrackBtn = document.getElementById("drawTrackButton");
        const showTrackPointsBtn = document.getElementById("showTrackPointsButton");
        const clearTrackBtn = document.getElementById("clearTrackButton");
        if (drawTrackBtn) drawTrackBtn.disabled = disabled;
        if (showTrackPointsBtn) showTrackPointsBtn.disabled = disabled;
        if (clearTrackBtn) clearTrackBtn.disabled = disabled;
    }
    // 回放控件的禁用/启用
    function disablePlaybackButtons(disabled) {
        ["playbackStartBtn","playbackPauseBtn","playbackStopBtn","playbackSpeedSelect","playbackTimeSlider"].forEach(id=>{
            const el = document.getElementById(id);
            if (el) el.disabled = disabled;
        });
    }

    // 回放按钮状态管理：空闲/播放/暂停
    function updatePlaybackButtonsState(state){
        try {
            const startBtn = document.getElementById('playbackStartBtn');
            const pauseBtn = document.getElementById('playbackPauseBtn');
            const stopBtn = document.getElementById('playbackStopBtn');
            if (!startBtn || !pauseBtn || !stopBtn) return;
            if (state === 'idle') {
                startBtn.disabled = false;
                pauseBtn.disabled = true;
                stopBtn.disabled = true;
                pauseBtn.textContent = '继续';
            } else if (state === 'playing') {
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
                pauseBtn.textContent = '暂停';
            } else if (state === 'paused') {
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
                pauseBtn.textContent = '继续';
            }
        } catch(e) { console.warn('更新按钮状态失败:', e); }
    }

    function bindDrawEvent() {
        document.getElementById("drawButton").addEventListener("click", function () {
            if (isDrawing) { console.log('绘制进行中，忽略重复点击'); return; }
            isDrawing = true;
            disableButtons(true);
            showLoading();
            try {
                const wktStr = document.getElementById("wktTextarea").value.trim();
                if (!wktStr) { alert("请输入WKT字符串！"); return; }
                clearOverlays();
                const geojson = parseWkt(wktStr);
    
                const polygonData = [];
                if (geojson.type === "Polygon") {
                    polygonData.push({ index: 1, coordinates: geojson.coordinates });
                } else if (geojson.type === "MultiPolygon") {
                    geojson.coordinates.forEach((polygon, index) => {
                        polygonData.push({ index: index + 1, coordinates: polygon });
                    });
                }
    
                // 重置并绘制
                polygonInfoList = [];
                polygonData.forEach(pd => processPolygon(pd.index, pd.coordinates));
    
                // 视图居中到所有已绘制轮廓
                try { fitViewportToPolygons(); } catch (e) { console.warn('视图居中失败', e); }
    
                // 在视图稳定后再创建/更新标签
                setTimeout(() => {
                    if (labelsEnabled) {
                        try {
                            createAllLabels();
                            updateAllLabelsPosition();
                        } catch (e) {
                            console.warn('创建或更新标签失败:', e);
                        }
                    }
                }, 150);
            } catch (e) {
                alert('绘制失败：' + (e && e.message ? e.message : e));
                console.error('绘制异常:', e);
            } finally {
                hideLoading();
                isDrawing = false;
                disableButtons(false);
            }
        });

        document.getElementById("clearButton").addEventListener("click", function () {
            if (isDrawing) { console.log('绘制进行中，暂不清空'); return; }
            clearOverlays();
            console.log("已清空所有轮廓");
        });
    }

    // 存储多边形数据，用于后续标签创建
    let polygonInfoList = [];

    // 处理单个多边形的绘制和面积计算
    function processPolygon(actualPolygonIndex, polygonCoords) {
        console.log('开始处理多边形', actualPolygonIndex);

        // 坐标系选择（绘制始终使用WGS84坐标）
        const coordSys = (document.getElementById('coordSysSelect') && document.getElementById('coordSysSelect').value) || 'wgs84';

        // 统一转换为WGS84用于绘制与面积计算
        function toWgs(point){
            const lng = point[0], lat = point[1];
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                return [lng, lat];
            } else if (coordSys === 'gcj02') {
                const w = gcj02ToWgs84(lng, lat);
                return [w.lng, w.lat];
            } else if (coordSys === 'bd09') {
                const gcj = bd09ToGcj02(lng, lat);
                const w = gcj02ToWgs84(gcj.lng, gcj.lat);
                return [w.lng, w.lat];
            }
            return [lng, lat];
        }
        const coordsWGS84 = polygonCoords.map(ring => ring.map(toWgs));
        let outerRingWGS = coordsWGS84[0] || [];

        // 生成用于绘制的坐标（直接使用WGS84坐标）
        const rings = coordsWGS84.map(ring => ring.map(([lng, lat]) => new T.LngLat(lng, lat)));


         // 创建半透明填充的多边形（无边框）
          const polygon = new T.Polygon(rings, {
              color: "#FFD700",
              weight: 1,
              opacity: 1,
              fillColor: "#FFFF00",
              fillOpacity: 0.35
          });
 
          // 使用WGS84坐标计算面积（更准确的面积计算）
         let areaSqm;
         let areaMu;



         try {
             // 检查Turf.js是否可用
             if (typeof turf !== 'undefined' && turf.area) {
                 // 使用Turf.js计算多边形面积
                // 构造GeoJSON格式的多边形
                const geoJsonPolygon = {
                    type: "Polygon",
                    coordinates: coordsWGS84
                };


                 // 使用Turf.js计算面积（平方米）
                 areaSqm = turf.area(geoJsonPolygon);
                 areaMu = (areaSqm / 666.6667).toFixed(4); // 转换为亩
                 console.log(`多边形${actualPolygonIndex}面积计算结果(Turf.js): ${areaSqm}平方米 = ${areaMu}亩`);
             } else {
                 // 如果Turf.js不可用，回退到之前的计算方法
                 console.warn('Turf.js不可用，使用备用计算方法');
                 // 计算带孔洞的多边形面积
                 areaSqm = 0;
                 // 计算外环面积
                 outerRingWGS = coordsWGS84[0] || [];
                 areaSqm += calculatePolygonArea(outerRingWGS);

                 // 减去内环（孔洞）面积
                 for (let i = 1; i < coordsWGS84.length; i++) {
                     const innerRingArea = calculatePolygonArea(coordsWGS84[i]);
                     areaSqm -= innerRingArea;
                 }

                  areaMu = (areaSqm / 666.6667).toFixed(4); // 使用更精确的转换系数
                  console.log(`多边形${actualPolygonIndex}面积计算结果(备用): ${areaSqm}平方米 = ${areaMu}亩`);
              }
          } catch (error) {
              console.error(`面积计算失败:`, error);
              areaSqm = 0;
              areaMu = '0.0000';
          }

          // 计算多边形的中心点和底部中心点（WGS84）
          const centerPoint = calculatePolygonCenter(outerRingWGS);
          const bottomCenterPoint = calculatePolygonBottomCenter(outerRingWGS);

          // 添加多边形到地图
          if (map) {
              map.addOverLay(polygon);
              console.log(`多边形${actualPolygonIndex}已添加到地图`);
          } else {
              console.error('地图对象不存在');
          }

          // 存储多边形信息，用于后续标签创建
          polygonInfoList.push({
              index: actualPolygonIndex,
              polygon: polygon,
              area: areaMu,
              bottomCenter: { lng: bottomCenterPoint.lng, lat: bottomCenterPoint.lat },
              ringPoints: rings
          });
      }

    // 视图居中：根据已绘制的GCJ-02点
    function fitViewportToPolygons() {
        const points = [];
        try {
            if (!map || !map.setViewport) return;
            polygonInfoList.forEach(info => {
                if (!info || !info.ringPoints) return;
                info.ringPoints.forEach(ring => {
                    ring.forEach(ll => points.push(ll));
                });
            });
            if (!points.length) return;
            map.setViewport(points);
        } catch (e) {
            try {
                const lngs = points.map(p => p.lng);
                const lats = points.map(p => p.lat);
                const center = new T.LngLat(
                    (Math.min(...lngs) + Math.max(...lngs)) / 2,
                    (Math.min(...lats) + Math.max(...lats)) / 2
                );
                if (map && map.panTo) map.panTo(center);
            } catch (e2) {
                console.warn('视图居中失败:', e2);
            }
        }
    }

    // 统一创建所有多边形的标签
    function createAllLabels() {
        const mapContainer = document.getElementById('mapContainer');
        if (!mapContainer || !map) return;

        polygonInfoList.forEach(info => {
            if (!info) return;
            // 防止重复创建
            if (info.labelRef) return;
            // 创建标签元素
            const labelDiv = document.createElement('div');
            labelDiv.className = 'area-label';
            labelDiv.innerHTML = `多边形${info.index}：${info.area}亩`;

            // 添加到地图容器并根据屏幕边界定位到轮廓下方
            mapContainer.appendChild(labelDiv);
            positionLabelForPolygon(labelDiv, info);

            // 记录引用，避免重复创建
            info.labelRef = labelDiv;

            // 存储到 currentPolygons 以复用现有定位/清理逻辑
            const labelObj = {
                domElement: labelDiv,
                isDomLabel: true,
                polygonInfo: info
            };
            currentPolygons.push({ polygon: info.polygon, label: labelObj });
        });

        // 不清空 polygonInfoList，便于开关随时创建/隐藏标签
    }

    // 根据多边形屏幕边界定位标签，保证始终在轮廓下方
    function positionLabelForPolygon(labelDiv, info) {
        if (!map || !info || !info.ringPoints) return;
        const points = [];
        info.ringPoints.forEach(ring => {
            ring.forEach(ll => {
                const p = map.lngLatToContainerPoint(ll);
                points.push(p);
            });
        });
        if (!points.length) return;
        const minX = Math.min(...points.map(p => p.x));
        const maxX = Math.max(...points.map(p => p.x));
        const maxY = Math.max(...points.map(p => p.y));
        const container = document.getElementById('mapContainer');
        const labelWidth = labelDiv.offsetWidth;
        const labelHeight = labelDiv.offsetHeight;
        const targetLeft = Math.round((minX + maxX) / 2 - labelWidth / 2);
        const targetTop = Math.round(maxY + 6);
        const clampedLeft = Math.max(0, Math.min(targetLeft, container.clientWidth - labelWidth));
        const clampedTop = Math.max(0, Math.min(targetTop, container.clientHeight - labelHeight));
        labelDiv.style.left = clampedLeft + 'px';
        labelDiv.style.top = clampedTop + 'px';
    }

    // 更新所有标签位置（地图move/zoom时调用）
    function updateAllLabelsPosition() {
        try {
            if (!map) return;
            const container = document.getElementById('mapContainer');
            if (!container) return;
            currentPolygons.forEach(item => {
                if (!item || !item.label) return;
                const labelObj = item.label;
                if (labelObj.isDomLabel && labelObj.domElement && labelObj.polygonInfo) {
                    // 确保标签在容器中
                    if (!labelObj.domElement.parentNode) {
                        container.appendChild(labelObj.domElement);
                    }
                    positionLabelForPolygon(labelObj.domElement, labelObj.polygonInfo);
                }
            });
        } catch (e) {
            console.warn('更新标签位置时出错:', e);
        }
    }
    // 确保在全局可用（处理第三方库事件回调作用域差异）
    window.updateAllLabelsPosition = updateAllLabelsPosition;

    // 绑定“显示亩数标签”开关（默认隐藏）
    function bindLabelsToggle() {
        const cb = document.getElementById('toggleLabelsCheckbox');
        const container = document.getElementById('mapContainer');
        if (!cb || !container) return;
        // 默认隐藏标签
        container.classList.add('labels-hidden');
        cb.addEventListener('change', () => {
            labelsEnabled = cb.checked;
            if (labelsEnabled) {
                container.classList.remove('labels-hidden');
                const hasAnyLabel = currentPolygons.some(item => item && item.label && item.label.domElement);
                if (!hasAnyLabel) {
                    try { createAllLabels(); } catch (e) { console.warn('创建标签失败:', e); }
                }
                updateAllLabelsPosition();
            } else {
                container.classList.add('labels-hidden');
            }
        });
    }

    /**
     * 计算多边形中心点（比底部中心更适合显示标签）
     */
    function calculatePolygonCenter(outerRing) {
        let sumLng = 0, sumLat = 0;
        const len = outerRing.length;

        for (let i = 0; i < len; i++) {
            sumLng += outerRing[i][0];
            sumLat += outerRing[i][1];
        }

        return {
            lng: sumLng / len,
            lat: sumLat / len
        };
    }

    /**
     * 计算多边形面积（球面多边形面积计算）
     * 使用更准确的球面坐标面积计算方法，确保面积与视觉大小一致
     */
    function calculatePolygonArea(coordinates) {
        // 地球半径（米）- 使用更精确的值
        const R = 6371000.8;
        const n = coordinates.length;

        // 将所有坐标转换为弧度
        const coordsRad = coordinates.map(point => [
            point[0] * Math.PI / 180,
            point[1] * Math.PI / 180
        ]);

        let areaRad = 0;

        // 使用更准确的球面多边形面积公式（Girard定理）
        for (let i = 0; i < n; i++) {
            const j = (i + 1) % n;
            const lon1 = coordsRad[i][0];
            const lat1 = coordsRad[i][1];
            const lon2 = coordsRad[j][0];
            const lat2 = coordsRad[j][1];

            // 计算球面多边形面积增量
            const dlon = lon2 - lon1;
            const sinLat1 = Math.sin(lat1);
            const sinLat2 = Math.sin(lat2);
            const cosLat1 = Math.cos(lat1);
            const cosLat2 = Math.cos(lat2);

            // 使用更精确的公式
            areaRad += dlon * (sinLat1 * cosLat2 * Math.cos(dlon / 2) + sinLat2 * cosLat1);
        }

        // 计算总面积（平方米）
        const areaSqm = Math.abs(areaRad) * R * R * 0.5;

        return areaSqm;
    }

    /**
     * 清空所有多边形和标签（同时处理 polygonInfoList 与 currentPolygons）
     */
    function clearOverlays() {
        try {
            // 先移除 polygonInfoList 中记录的多边形与其DOM标签
            polygonInfoList.forEach(info => {
                if (info && info.polygon && map && map.removeOverLay) {
                    try { map.removeOverLay(info.polygon); } catch (e) { console.warn('移除多边形失败:', e); }
                }
                if (info && info.labelRef && info.labelRef.parentNode) {
                    try { info.labelRef.parentNode.removeChild(info.labelRef); } catch (e) { console.warn('移除DOM标签失败:', e); }
                    info.labelRef = null;
                }
            });

            // 再处理 currentPolygons（兼容旧路径与标签对象）
            currentPolygons.forEach(item => {
                if (item.polygon && map && map.removeOverLay) {
                    try { map.removeOverLay(item.polygon); } catch (e) { console.warn('移除多边形失败:', e); }
                }
                if (item.label) {
                    if (item.label.domElement && item.label.domElement.parentNode) {
                        try { item.label.domElement.parentNode.removeChild(item.label.domElement); } catch (e) { console.warn('移除DOM标签失败:', e); }
                    } else if (map && map.removeOverLay && !item.label.isDomLabel) {
                        try { map.removeOverLay(item.label); } catch (e) { console.warn('移除地图覆盖物标签失败:', e); }
                    }
                }
            });

            // 清空记录数组
            currentPolygons = [];
            polygonInfoList = [];

            console.log('已清空所有多边形和标签（保留事件监听器）');
        } catch (error) {
            console.error('清空覆盖物时出错:', error);
        }
    }

    // 其他辅助函数（保持不变）
    function bindMinimizeEvent() {
        const container = document.querySelector(".wkt-input-container");
        const btn = document.getElementById("minimizeBtn");
        const minIcon = btn?.querySelector(".min-icon");
        const restoreIcon = btn?.querySelector(".restore-icon");

        btn?.addEventListener("click", () => {
            const minimized = container.classList.toggle("minimized");
            if (minIcon && restoreIcon) {
                if (minimized) {
                    minIcon.style.display = "none";
                    restoreIcon.style.display = "";
                } else {
                    minIcon.style.display = "";
                    restoreIcon.style.display = "none";
                }
            }
        });
    }

    // 在脚本内部补充：页签切换（3个页签）
     function bindTabs() {
         const tabs = [
             { btn: document.getElementById('tabDrawBtn'), pane: document.getElementById('tabDraw'), key: 'draw' },
             { btn: document.getElementById('tabTrackBtn'), pane: document.getElementById('tabTrack'), key: 'track' },
             { btn: document.getElementById('tabSplitBtn'), pane: document.getElementById('tabSplit'), key: 'split' },
             { btn: document.getElementById('tabBatchBtn'), pane: document.getElementById('tabBatch'), key: 'batch' },
         ];
         if (tabs.some(t => !t.btn || !t.pane)) return;
         function activate(key) {
             tabs.forEach(t => {
                 const active = t.key === key;
                 t.btn.classList.toggle('active', active);
                 t.pane.classList.toggle('active', active);
             });
         }
         tabs.forEach(t => t.btn.addEventListener('click', () => activate(t.key)));
         activate('draw');
     }
    function updateParserStatus() {
        const el = document.getElementById('parserStatus');
        if (!el) return;
        const ok = (typeof Terraformer !== 'undefined' && Terraformer.WKT && typeof Terraformer.WKT.parse === 'function');
        if (ok) {
            el.textContent = 'Terraformer WKT Parser';
            el.style.color = '#2f8f2f';
        } else {
            el.textContent = '本地回退解析（仅支持POLYGON/MULTIPOLYGON）';
            el.style.color = '#c77d1e';
        }
    }
     function parseWkt(wkt) {
         wkt = wkt.trim();
         // 优先使用成熟库（Terraformer WKT Parser）
         if (typeof Terraformer !== 'undefined' && Terraformer.WKT && Terraformer.WKT.parse) {
             try {
                 return Terraformer.WKT.parse(wkt);
             } catch (e) {
                 console.warn('Terraformer解析失败，尝试本地回退解析:', e);
             }
         } else {
             // 不再提示“未加载”，由状态栏展示回退信息
         }
         // 回退解析：仅支持 POLYGON / MULTIPOLYGON
         const typeMatch = wkt.match(/^\s*(POLYGON|MULTIPOLYGON)\s*\(/i);
         if (!typeMatch) throw new Error('仅支持POLYGON/MULTIPOLYGON');
         const type = typeMatch[1].toUpperCase();
         const inner = wkt.substring(wkt.indexOf('('));
         if (type === 'POLYGON') {
             const coords = parsePolygonCoords(inner.replace(/^\(/, '').replace(/\)$/, ''));
             return { type: 'Polygon', coordinates: coords };
         } else {
             const trimmed = inner.replace(/^\(\(/, '').replace(/\)\)$/, '');
             const coords = parseMultiPolygonCoords(trimmed);
             return { type: 'MultiPolygon', coordinates: coords };
         }
     }

     function bindMultiSplitter() {
         const input = document.getElementById('multiInput');
         const output = document.getElementById('polyOutput');
         const splitBtn = document.getElementById('splitMultiBtn');
         const copyBtn = document.getElementById('copyPolysBtn');
         if (!input || !output || !splitBtn || !copyBtn) return;

         // 本地WKT序列化辅助
         function ringToText(ring) {
             if (!ring || !ring.length) return '()';
             const first = ring[0];
             const last = ring[ring.length - 1];
             const closed = (first[0] === last[0] && first[1] === last[1]) ? ring : ring.concat([[first[0], first[1]]]);
             return '(' + closed.map(pt => pt[0] + ' ' + pt[1]).join(', ') + ')';
         }
         function toWktPolygonCoords(coords) {
             return 'POLYGON(' + coords.map(ringToText).join(', ') + ')';
         }
         function toWktMulti(coords) {
             return 'MULTIPOLYGON(' + coords.map(poly => '(' + poly.map(ringToText).join(', ') + ')').join(', ') + ')';
         }

         function polygonsFromMulti(text) {
             const geo = parseWkt(text.trim());
             if (geo.type !== 'MultiPolygon') throw new Error('请输入有效的 MULTIPOLYGON WKT');
             const polys = geo.coordinates.map(rings => toWktPolygonCoords(rings));
             return polys;
         }
         splitBtn.addEventListener('click', () => {
             try {
                 const list = polygonsFromMulti(input.value.trim());
                 output.value = list.join('\n');
             } catch (e) {
                 alert('分割失败：' + e.message);
             }
         });
         copyBtn.addEventListener('click', async () => {
             const val = output.value.trim();
             if (!val) { alert('没有可复制的结果'); return; }
             try { await navigator.clipboard.writeText(val); alert('已复制到剪贴板'); } catch (e) { console.warn('复制失败', e); }
         });
     }

     function bindBatchGenerator() {
         const batchInput = document.getElementById('batchInput');
         const output = document.getElementById('multiOutput');
         const genBtn = document.getElementById('generateMultiBtn');
         const copyBtn = document.getElementById('copyMultiBtn');

         // 本地WKT序列化辅助（与分割器保持一致）
         function ringToText(ring) {
             if (!ring || !ring.length) return '()';
             const first = ring[0];
             const last = ring[ring.length - 1];
             const closed = (first[0] === last[0] && first[1] === last[1]) ? ring : ring.concat([[first[0], first[1]]]);
             return '(' + closed.map(pt => pt[0] + ' ' + pt[1]).join(', ') + ')';
         }
         function toWktMulti(coords) {
             return 'MULTIPOLYGON(' + coords.map(poly => '(' + poly.map(ringToText).join(', ') + ')').join(', ') + ')';
         }

         genBtn.addEventListener('click', () => {
             try {
                 const lines = batchInput.value.trim().split(/\n|;/).map(s => s.trim()).filter(Boolean);
                 if (lines.length === 0) throw new Error('请按每行或分号输入至少一个POLYGON');
                 const polygons = lines.map((line, idx) => {
                     const g = parseWkt(line);
                     if (g.type !== 'Polygon') throw new Error(`第${idx + 1}行不是有效的POLYGON WKT`);
                     return g;
                 });
                 const multiGeo = { type: 'MultiPolygon', coordinates: polygons.map(p => p.coordinates) };
                 output.value = toWktMulti(multiGeo.coordinates);
             } catch (e) {
                 alert('生成失败：' + e.message);
             }
         });

         copyBtn.addEventListener('click', async () => {
             const val = output.value.trim();
             if (!val) { alert('没有可复制的结果'); return; }
             try { await navigator.clipboard.writeText(val); alert('已复制到剪贴板'); } catch (e) { console.warn('复制失败', e); }
         });

     }

     function setExampleWkt() {
         const exampleWkt = "MULTIPOLYGON(" +
             "(" +
             "(116.35 39.93, 116.39 39.93, 116.39 39.90, 116.35 39.90, 116.35 39.93)," + // 外环
             "(116.36 39.92, 116.38 39.92, 116.38 39.91, 116.36 39.91, 116.36 39.92)" +  // 内环
             ")," +
             "(" +
             "(116.40 39.95, 116.43 39.97, 116.46 39.96, 116.49 39.98, 116.52 39.95, 116.55 39.93, 116.58 39.94, 116.61 39.92, 116.64 39.95, 116.40 39.95)" +
             ")" +
             ")";
         document.getElementById("wktTextarea").value = exampleWkt;
     }

     function parsePolygonCoords(coordStr) {
         const ringStrs = coordStr.split(/\)\s*,\s*\(/).map(s => s.replace(/[()]/g, '').trim());
         const rings = [];
         ringStrs.forEach(ringStr => {
             const pts = ringStr.split(/,\s*/).map(pointStr => {
                 const [lng, lat] = pointStr.split(/\s+/).map(Number);
                 if (isNaN(lng) || isNaN(lat)) throw new Error("坐标格式错误：" + pointStr);
                 return [lng, lat];
             });
             // 自动拆分：如果一个ring中包含多次回到起点（闭合），则拆分为多个环
             // 兼容用户将外环与内环错误地写在同一对括号中的情况
             let start = 0;
             while (start < pts.length) {
                 const startPt = pts[start];
                 let closeIdx = -1;
                 for (let i = start + 1; i < pts.length; i++) {
                     if (pts[i][0] === startPt[0] && pts[i][1] === startPt[1]) {
                         closeIdx = i;
                         break;
                     }
                 }
                 if (closeIdx === -1) {
                     // 未找到闭合：将剩余点视为一个环，并强制闭合
                     const ring = pts.slice(start);
                     if (ring.length && (ring[0][0] !== ring[ring.length - 1][0] || ring[0][1] !== ring[ring.length - 1][1])) {
                         ring.push([ring[0][0], ring[0][1]]);
                     }
                     rings.push(ring);
                     break;
                 } else {
                     const ring = pts.slice(start, closeIdx + 1);
                     rings.push(ring);
                     start = closeIdx + 1;
                 }
             }
         });
         return rings;
     }

     function parseMultiPolygonCoords(coordStr) {
         const polygonStrs = coordStr.split(/\)\s*\)\s*,\s*\(\s*\(/).map(s => s.replace(/[()]/g, '').trim());
         return polygonStrs.map(polygonStr => parsePolygonCoords(polygonStr));
     }

     function wgs84ToGcj02(lng, lat) {
         const x_PI = 3.14159265358979324 * 3000.0 / 180.0;
         const PI = 3.1415926535897932384626;
         const a = 6378245.0;
         const ee = 0.00669342162296594323;

         if (outOfChina(lng, lat)) return { lng, lat };

         let dlat = transformLat(lng - 105.0, lat - 35.0);
         let dlng = transformLng(lng - 105.0, lat - 35.0);
         const radlat = lat / 180.0 * PI;
         let magic = Math.sin(radlat);
         magic = 1 - ee * magic * magic;
         const sqrtmagic = Math.sqrt(magic);
         dlat = (dlat * 180.0) / ((a * (1 - ee)) / (magic * sqrtmagic) * PI);
         dlng = (dlng * 180.0) / (a / sqrtmagic * Math.cos(radlat) * PI);

         return { lng: lng + dlng, lat: lat + dlat };

         function outOfChina(lng, lat) {
             return (lng < 72.004 || lng > 137.8347) || (lat < 0.8293 || lat > 55.8271);
         }

         function transformLat(x, y) {
             let ret = -100.0 + 2.0 * x + 3.0 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * Math.sqrt(Math.abs(x));
             ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
             ret += (20.0 * Math.sin(y * PI) + 40.0 * Math.sin(y / 3.0 * PI)) * 2.0 / 3.0;
             ret += (160.0 * Math.sin(y / 12.0 * PI) + 320 * Math.sin(y * PI / 30.0)) * 2.0 / 3.0;
             return ret;
         }

         function transformLng(x, y) {
             let ret = 300.0 + x + 2.0 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * Math.sqrt(Math.abs(x));
             ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
             ret += (20.0 * Math.sin(x * PI) + 40.0 * Math.sin(x / 3.0 * PI)) * 2.0 / 3.0;
             ret += (150.0 * Math.sin(x / 12.0 * PI) + 300.0 * Math.sin(x / 30.0 * PI)) * 2.0 / 3.0;
             return ret;
         }
     }

     function gcj02ToWgs84(lng, lat) {
         const g = wgs84ToGcj02(lng, lat);
         return { lng: lng * 2 - g.lng, lat: lat * 2 - g.lat };
     }

     function bd09ToGcj02(bdLng, bdLat) {
         const x_PI = 3.14159265358979324 * 3000.0 / 180.0;
         const x = bdLng - 0.0065;
         const y = bdLat - 0.006;
         const z = Math.sqrt(x * x + y * y) - 0.00002 * Math.sin(y * x_PI);
         const theta = Math.atan2(y, x) - 0.000003 * Math.cos(x * x_PI);
         const ggLng = z * Math.cos(theta);
         const ggLat = z * Math.sin(theta);
         return { lng: ggLng, lat: ggLat };
     }

     function calculatePolygonBottomCenter(outerRing) {
         let minLat = Infinity;
         let bottomPoints = [];
         outerRing.forEach(point => {
             const lat = point[1];
             if (lat < minLat) {
                 minLat = lat;
                 bottomPoints = [point];
             } else if (lat === minLat) {
                 bottomPoints.push(point);
             }
         });

         const sumLng = bottomPoints.reduce((sum, point) => sum + point[0], 0);
         const centerLng = sumLng / bottomPoints.length;

         return { lng: centerLng, lat: minLat };
     }

     function fitBounds(geojson) {
         try {
             const allPoints = [];
             function collectPoints(coords) {
                 if (typeof coords[0] === 'number') {
                     allPoints.push(coords);
                 } else {
                     coords.forEach(coord => collectPoints(coord));
                 }
             }
             collectPoints(geojson.coordinates);

             if (allPoints.length === 0) return;

             const lats = allPoints.map(p => p[1]);
             const lngs = allPoints.map(p => p[0]);
             const minLng = Math.min(...lngs);
             const maxLng = Math.max(...lngs);
             const minLat = Math.min(...lats);
             const maxLat = Math.max(...lats);

             const sw = wgs84ToGcj02(minLng, minLat);
             const ne = wgs84ToGcj02(maxLng, maxLat);

             // 修复setViewport方法的使用，确保参数格式正确
             if (map && map.setViewport) {
                 map.setViewport([
                     new T.LngLat(sw.lng, sw.lat),
                     new T.LngLat(ne.lng, ne.lat)
                 ], { padding: [50, 50] });
             } else {
                 console.warn('地图对象或setViewport方法不可用');
             }
         } catch (error) {
             console.error('调整视图范围时出错:', error);
         }
     }
// 轨迹绘制与解析
    function bindTrackEvents() {
        const drawBtn = document.getElementById('drawTrackButton');
        const showPointsBtn = document.getElementById('showTrackPointsButton');
        const clearBtn = document.getElementById('clearTrackButton');
        const ta = document.getElementById('trackTextarea');
        if (!drawBtn || !showPointsBtn || !clearBtn || !ta) return;

        drawBtn.addEventListener('click', function(){
            try {
                const text = ta.value.trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const points = parseTrackText(text);
                if (points.length < 2) { alert('有效轨迹点不足，至少需要两点'); return; }
                drawTrackFromPoints(points);
                fitViewportToTrack(points);
            } catch (e) {
                alert('绘制轨迹失败：' + (e && e.message ? e.message : e));
                console.error('绘制轨迹异常:', e);
            }
        });

        showPointsBtn.addEventListener('click', function(){
            try {
                const text = ta.value.trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const points = parseTrackText(text);
                if (points.length === 0) { alert('未找到有效轨迹点'); return; }
                showTrackPoints(points);
                fitViewportToTrack(points);
            } catch (e) {
                alert('显示轨迹点失败：' + (e && e.message ? e.message : e));
                console.error('显示轨迹点异常:', e);
            }
        });

        clearBtn.addEventListener('click', function(){
            clearTrackOverlays();
            console.log('已清空轨迹');
        });
    }

    function showTrackPoints(points) {
        // 先移除旧轨迹（不影响轮廓）
        clearTrackOverlays(false);
        
        if (!map || !points || points.length === 0) {
            console.log('无轨迹点可显示');
            return;
        }
        
        console.log(`准备显示${points.length}个轨迹点`);
        
        // 使用批量处理和更小的图标来提高性能
        // 创建一个更小的红点SVG图标
        const smallRedDotIcon = new T.Icon({
            iconUrl: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1" height="1"><circle cx="0.5" cy="0.5" r="0.3" fill="%23FF0000"/></svg>',
            iconSize: new T.Point(1, 1),
            iconAnchor: new T.Point(0.5, 0.5)
        });
        
        // 优化批量添加点的速度
        const batchSize = 2000; // 增加每批处理的点数
        const concurrentBatches = 4; // 并发批次数量
        
        // 预创建点击事件处理函数，避免重复创建
        function createClickHandler(point, index) {
            return function() {
                const infoWindow = new T.InfoWindow({
                    content: `点${index + 1}<br/>经度: ${point.lng.toFixed(6)}<br/>纬度: ${point.lat.toFixed(6)}`,
                    offset: new T.Point(0, -20)
                });
                infoWindow.open(map, point);
            };
        }
        
        // 使用setTimeout实现更高效的批量添加，避免阻塞UI
        let currentIndex = 0;
        
        function addBatch() {
            if (currentIndex >= points.length) {
                console.log(`已显示${points.length}个轨迹点`);
                return;
            }
            
            // 添加当前批次的点
            const endIndex = Math.min(currentIndex + batchSize, points.length);
            const markersToAdd = [];
            
            // 先创建所有标记
            for (let i = currentIndex; i < endIndex; i++) {
                const point = points[i];
                const index = i;
                
                const marker = new T.Marker(point, {
                    icon: smallRedDotIcon
                });
                
                // 添加点击事件
                marker.addEventListener('click', createClickHandler(point, index));
                
                markersToAdd.push(marker);
            }
            
            // 批量添加到地图和数组
            markersToAdd.forEach(marker => {
                map.addOverLay(marker);
                currentTracks.push(marker);
            });
            
            currentIndex = endIndex;
            
            // 使用setTimeout而不是requestAnimationFrame，减少对渲染周期的依赖
            // 设置为0，将任务放入微任务队列，但允许UI有短暂的呼吸空间
            setTimeout(addBatch, 0);
        }
        
        // 启动批量添加
        addBatch();
    }
    
    // 恢复原始的clearTrackOverlays函数
    function clearTrackOverlays(resetArray = true){        
        try {
            currentTracks.forEach(pl => {
                if (pl && map && map.removeOverLay) {
                    try { map.removeOverLay(pl); } catch (e) { console.warn('移除轨迹失败:', e); }
                }
            });
            if (resetArray) currentTracks = [];
        } catch (e) {
            console.warn('清空轨迹时出错:', e);
        }
    }

    function parseTrackText(text){
        // 选择输入坐标系（优先使用轨迹页签专属选择器，若未设置则回退到绘制页签选择器）
        const coordSysEl = document.getElementById('trackCoordSysSelect') || document.getElementById('coordSysSelect');
        const coordSys = (coordSysEl && coordSysEl.value) || 'wgs84';
        const isHash = text.indexOf('#') !== -1;
        const items = isHash ? text.split('#') : text.split(/\r?\n/);
        const pts = [];
        for (let i=0;i<items.length;i++){
            const raw = items[i];
            if (!raw) continue;
            const line = raw.trim();
            if (!line) continue;
            const parts = line.split(',');
            if (parts.length < 3) continue;
            let lng = parseFloat((parts[isHash ? 0 : 1] || '').trim());
            let lat = parseFloat((parts[isHash ? 1 : 2] || '').trim());
            // 初步过滤：数值合法性与正常范围
            if (!isFinite(lng) || !isFinite(lat)) continue;
            if (lng === 0 || lat === 0) continue; // 丢弃0.0异常点
            if (lng < -180 || lng > 180 || lat < -90 || lat > 90) continue; // 超出经纬度范围丢弃

            // 将输入坐标转换为WGS84
            let w;
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                w = { lng, lat };
            } else if (coordSys === 'gcj02') {
                w = gcj02ToWgs84(lng, lat);
            } else if (coordSys === 'bd09') {
                const g = bd09ToGcj02(lng, lat);
                w = gcj02ToWgs84(g.lng, g.lat);
            } else {
                w = { lng, lat };
            }
            // 转换结果兜底检查
            if (!isFinite(w.lng) || !isFinite(w.lat)) continue;
            if (w.lng < -180 || w.lng > 180 || w.lat < -90 || w.lat > 90) continue;

            // 使用WGS84坐标绘制到地图
            pts.push(new T.LngLat(w.lng, w.lat));
        }
        return pts;
    }

    function drawTrackFromPoints(points){
        // 先移除旧轨迹（不影响轮廓）
        clearTrackOverlays(false);
        const polyline = new T.Polyline(points, {
            color: '#FF3B30',
            weight: 1,
            opacity: 0.9
        });
        if (map) {
            map.addOverLay(polyline);
        }
        currentTracks.push(polyline);
    }

    function clearTrackOverlays(resetArray = true){
        try {
            currentTracks.forEach(pl => {
                if (pl && map && map.removeOverLay) {
                    try { map.removeOverLay(pl); } catch (e) { console.warn('移除轨迹失败:', e); }
                }
            });
            if (resetArray) currentTracks = [];
        } catch (e) {
            console.warn('清空轨迹时出错:', e);
        }
    }


    function fitViewportToTrack(points){
        try {
            if (!map || !map.setViewport || !points || !points.length) return;
            map.setViewport(points);
        } catch (e) {
            console.warn('轨迹视图居中失败:', e);
        }
    }

    // ========= 轨迹回放功能 =========
    let playbackState = { points: [], idx: 0, speed: 1, timer: null, running: false, marker: null, line: null, path: [] };

    function bindPlaybackControls(){
        const startBtn = document.getElementById('playbackStartBtn');
        const pauseBtn = document.getElementById('playbackPauseBtn');
        const stopBtn = document.getElementById('playbackStopBtn');
        const speedSel = document.getElementById('playbackSpeedSelect');
        const timeSlider = document.getElementById('playbackTimeSlider');
        const timeCursor = document.getElementById('playbackTimeCursor');
        const ta = document.getElementById('trackTextarea');
        if (!startBtn || !pauseBtn || !stopBtn || !speedSel) return;

        // 初始按钮状态
        updatePlaybackButtonsState('idle');

        startBtn.addEventListener('click', function(){
            try {
                const text = (ta && ta.value || '').trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const pts = parseTrackTextWithTime(text);
                if (pts.length < 2) { alert('有效轨迹点不足，至少需要两点'); return; }
                startPlayback(pts);
                // 状态在startPlayback中已设置为playing
            } catch (e) {
                alert('开始回放失败：' + (e && e.message ? e.message : e));
                console.error('开始回放异常:', e);
            }
        });

        pauseBtn.addEventListener('click', function(){
            if (!playbackState.running) {
                // 继续
                playbackState.running = true;
                scheduleNext();
                updatePlaybackButtonsState('playing');
            } else {
                // 暂停
                if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
                playbackState.running = false;
                updatePlaybackButtonsState('paused');
            }
        });

        stopBtn.addEventListener('click', function(){ 
            stopPlayback(); 
            updatePlaybackButtonsState('idle');
        });

        speedSel.addEventListener('change', function(){
            const v = parseFloat(speedSel.value);
            playbackState.speed = (isFinite(v) && v > 0) ? v : 1;
        });

        if (timeSlider) {
            timeSlider.addEventListener('input', function(){
                const ms = parseInt(timeSlider.value, 10);
                const txt = formatTimeForLabel(ms);
                if (timeCursor) timeCursor.textContent = txt;
            });
            timeSlider.addEventListener('change', function(){
                jumpToSliderTime();
            });
        }
    }

    function parseTrackTextWithTime(text){
        const coordSysEl = document.getElementById('trackCoordSysSelect') || document.getElementById('coordSysSelect');
        const coordSys = (coordSysEl && coordSysEl.value) || 'wgs84';
        const isHash = text.indexOf('#') !== -1;
        const items = isHash ? text.split('#') : text.split(/\r?\n/);
        const out = [];
        for (let i=0;i<items.length;i++){
            const raw = items[i];
            if (!raw) continue;
            const line = raw.trim();
            if (!line) continue;
            const parts = line.split(',');
            if (parts.length < 3) continue;
            const tsRaw = (parts[isHash ? 2 : 0] || '').trim();
            const ts = (tsRaw || '').replace(/\D/g,'');
            let lng = parseFloat((parts[isHash ? 0 : 1] || '').trim());
            let lat = parseFloat((parts[isHash ? 1 : 2] || '').trim());
            if (!isFinite(lng) || !isFinite(lat)) continue;
            if (lng === 0 || lat === 0) continue;
            if (lng < -180 || lng > 180 || lat < -90 || lat > 90) continue;
            const t = parseTimestamp(ts);
            if (!t) continue;
            let w;
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                w = { lng, lat };
            } else if (coordSys === 'gcj02') {
                w = gcj02ToWgs84(lng, lat);
            } else if (coordSys === 'bd09') {
                const g = bd09ToGcj02(lng, lat);
                w = gcj02ToWgs84(g.lng, g.lat);
            } else { w = { lng, lat }; }
            if (!isFinite(w.lng) || !isFinite(w.lat)) continue;
            if (w.lng < -180 || w.lng > 180 || w.lat < -90 || w.lat > 90) continue;
            out.push({ ll: new T.LngLat(w.lng, w.lat), time: t, ts });
        }
        out.sort((a,b)=>a.time - b.time);
        return out;
    }

    function parseTimestamp(ts){
        const tstr = (ts || '').replace(/\D/g,'');
        const m = tstr && tstr.match(/^\d{14}$/);
        if (!m) return null;
        const y = parseInt(tstr.slice(0,4),10);
        const M = parseInt(tstr.slice(4,6),10) - 1;
        const d = parseInt(tstr.slice(6,8),10);
        const h = parseInt(tstr.slice(8,10),10);
        const m2 = parseInt(tstr.slice(10,12),10);
        const s = parseInt(tstr.slice(12,14),10);
        const dt = new Date(y,M,d,h,m2,s);
        return isNaN(dt.getTime()) ? null : dt;
    }

    function startPlayback(points){
        console.log('[Playback] startPlayback: 点数=', points && points.length);
        stopPlayback();
        playbackState.points = points;
        playbackState.idx = 0;
        playbackState.speed = playbackState.speed || 1;
        playbackState.running = true;
        // 配置时间滑动条，并尊重现有滑块位置作为起始
        configureTimeSlider(points);
        // 启用滑块
        const slider = document.getElementById('playbackTimeSlider');
        if (slider) slider.disabled = false;
        let initIdx = 0;
        if (slider && slider.min && slider.max) {
            const ms = parseInt(slider.value, 10);
            if (isFinite(ms)) initIdx = findIndexByTime(points, ms);
        }
        playbackState.idx = initIdx;
        const first = points[initIdx];
        console.log('[Playback] 首点:', first && first.ts, first && first.ll, 'initIdx=', initIdx);
        playbackState.path = points.slice(0, initIdx+1).map(p=>p.ll);
        playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 1, opacity: 0.9 });
        if (map) {
            map.addOverLay(playbackState.line);
        }
        currentTracks.push(playbackState.line);
        // 创建并定位DOM标记以保证可见移动
        ensurePlaybackDom(first.ll);
        updatePlaybackDom(first.ll);
        updatePlaybackTimeLabel(first.ts);
        try { fitViewportToTrack(points.map(p=>p.ll)); } catch(e){}
        // 更新按钮状态
        updatePlaybackButtonsState('playing');
        scheduleNext();
    }

    function scheduleNext(){
        if (!playbackState.running) return;
        if (!playbackState.points || playbackState.idx >= playbackState.points.length - 1) {
            playbackState.running = false;
            console.log('[Playback] 回放结束：idx=', playbackState.idx, '点数=', playbackState.points ? playbackState.points.length : 0);
            updatePlaybackButtonsState('idle'); // 播放结束后按钮回到初始状态：开始可点，继续/结束灰化
            return;
        }
        const next = playbackState.points[playbackState.idx+1];
        const speed = playbackState.speed || 1;
        const delay = Math.max(4, Math.round(1000 / speed)); // 1x=1000ms/点，2x=500ms/点...
        console.log('[Playback] scheduleNext: idx=', playbackState.idx, '->', playbackState.idx+1, 'delay=', delay, 'speed=', speed);
        playbackState.timer = setTimeout(()=>{
            playbackState.idx++;
            const nextLL = next.ll;
            console.log('[Playback] 下一点:', next && next.ts, nextLL);
            try {
                // 维护路径数组
                playbackState.path = playbackState.path || [];
                playbackState.path.push(nextLL);
                console.log('[Playback] 路径长度=', playbackState.path.length);
                // 使用DOM标记进行移动（容器/图层坐标）
                if (!playbackDom.el) console.log('[Playback] DOM标记不存在，将尝试创建');
                updatePlaybackDom(nextLL);
                // 折线更新：优先setLngLats，兜底重建
                if (playbackState.line && typeof playbackState.line.setLngLats === 'function') {
                    try { playbackState.line.setLngLats(playbackState.path); }
                    catch(e){
                        console.warn('[Playback] setLngLats失败，重建折线', e);
                        if (map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                        playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 1, opacity: 0.9 });
                        if (map) map.addOverLay(playbackState.line);
                    }
                } else {
                    console.log('[Playback] 折线不支持setLngLats，重建');
                    if (playbackState.line && map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                    playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 1, opacity: 0.9 });
                    if (map) map.addOverLay(playbackState.line);
                }
            } catch(e) { console.warn('更新回放覆盖物失败:', e); }
            updatePlaybackTimeLabel(next.ts);
            scheduleNext();
        }, delay);
    }

    function stopPlayback(){
        if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
        playbackState.running = false;
        playbackState.idx = 0;
        try {
            // 移除DOM标记
            removePlaybackDom();
            if (playbackState.marker && map) map.removeOverLay(playbackState.marker);
            if (playbackState.line && map) map.removeOverLay(playbackState.line);
        } catch(e){}
        playbackState.marker = null;
        playbackState.line = null;
        updatePlaybackTimeLabel('—');
        // 按钮回到初始状态
        updatePlaybackButtonsState('idle');
    }

    function updatePlaybackTimeLabel(text){
        const el = document.getElementById('playbackTimeLabel');
        if (el) el.textContent = '时间：' + (text || '—');
    }

    // 时间滑动条：配置与跳转
    function configureTimeSlider(points){
        try {
            const slider = document.getElementById('playbackTimeSlider');
            const cursor = document.getElementById('playbackTimeCursor');
            if (!slider || !points || !points.length) return;
            const minMs = points[0].time.getTime();
            const maxMs = points[points.length - 1].time.getTime();
            const prev = parseInt(slider.value, 10);
            slider.min = String(minMs);
            slider.max = String(maxMs);
            slider.step = '1000'; // 以秒为步进
            let val = (isFinite(prev) && prev >= minMs && prev <= maxMs) ? prev : minMs;
            slider.value = String(val);
            if (cursor) cursor.textContent = formatTimeForLabel(val);
        } catch(e) { console.warn('配置时间滑动条失败:', e); }
    }
    function formatTimeForLabel(ms){
        if (!isFinite(ms)) return '—';
        const d = new Date(ms);
        const pad = n => String(n).padStart(2,'0');
        const y = d.getFullYear();
        const M = pad(d.getMonth()+1);
        const da = pad(d.getDate());
        const h = pad(d.getHours());
        const m = pad(d.getMinutes());
        const s = pad(d.getSeconds());
        return `${y}-${M}-${da} ${h}:${m}:${s}`;
    }
    function findIndexByTime(points, ms){
        try {
            if (!points || !points.length) return 0;
            const n = points.length;
            const minMs = points[0].time.getTime();
            const maxMs = points[n-1].time.getTime();
            if (!isFinite(ms)) return 0;
            if (ms <= minMs) return 0;
            if (ms >= maxMs) return n-1;
            let lo = 0, hi = n - 1, ans = 0;
            while (lo <= hi) {
                const mid = (lo + hi) >> 1;
                const t = points[mid].time.getTime();
                if (t < ms) { lo = mid + 1; ans = lo; }
                else { hi = mid - 1; ans = mid; }
            }
            return Math.max(0, Math.min(n-1, ans));
        } catch(e){ console.warn('findIndexByTime失败:', e); return 0; }
    }
    function jumpToSliderTime(){
        try {
            const slider = document.getElementById('playbackTimeSlider');
            if (!slider || !playbackState.points || !playbackState.points.length) return;
            const ms = parseInt(slider.value, 10);
            if (!isFinite(ms)) return;
            const idx = findIndexByTime(playbackState.points, ms);
            playbackState.idx = idx;
            const pts = playbackState.points;
            const ll = pts[idx].ll;
            playbackState.path = pts.slice(0, idx+1).map(p=>p.ll);
            // 更新折线
            try {
                if (playbackState.line && typeof playbackState.line.setLngLats === 'function') {
                    playbackState.line.setLngLats(playbackState.path);
                } else {
                    if (playbackState.line && map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                    playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 1, opacity: 0.9 });
                    if (map) map.addOverLay(playbackState.line);
                }
            } catch(e){ console.warn('滑块更新折线失败:', e); }
            // 更新标记与时间
            ensurePlaybackDom(ll);
            updatePlaybackDom(ll);
            updatePlaybackTimeLabel(pts[idx].ts);
            // 若正在播放，立即按新位置继续
            if (playbackState.running) {
                if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
                scheduleNext();
            }
        } catch(e) { console.warn('滑块跳转失败:', e); }
    }

    // DOM标记：使用容器坐标实现可见移动
    let playbackDom = { el: null, lastLL: null, bound: false };

    function ensurePlaybackDom(ll){
        try {
            playbackDom.lastLL = ll;
            const pane = (map && map.getPanes && map.getPanes().overlayPane) || document.getElementById('mapContainer');
            if (!pane) { console.warn('未找到overlayPane或mapContainer'); return; }
            if (!playbackDom.el) {
                const el = document.createElement('div');
                el.id = 'playbackDomMarker';
                el.style.position = 'absolute';
                el.style.width = '16px';
                el.style.height = '16px';
                el.style.borderRadius = '50%';
                el.style.background = '#2C64A7';
                el.style.border = '2px solid #fff';
                el.style.boxShadow = '0 0 0 1px rgba(0,0,0,.25)';
                el.style.zIndex = '9999';
                pane.appendChild(el);
                playbackDom.el = el;
                console.log('[Playback] 创建DOM标记，父节点=', pane === document.getElementById('mapContainer') ? '#mapContainer' : 'overlayPane');
                bindPlaybackDomEvents();
            }
            updatePlaybackDom(ll);
        } catch(e) { console.warn('创建DOM标记失败:', e); }
    }

    function updatePlaybackDom(ll){
        try {
            playbackDom.lastLL = ll;
            if (!map || !playbackDom.el || !ll) { console.log('[Playback] update取消：map/el/ll缺失'); return; }
            let p;
            if (typeof map.lngLatToLayerPoint === 'function') {
                p = map.lngLatToLayerPoint(ll);
                console.log('[Playback] 使用layerPoint定位:', ll && ll.lng, ll && ll.lat, '=>', p && p.x, p && p.y);
            } else if (typeof map.lngLatToContainerPoint === 'function') {
                p = map.lngLatToContainerPoint(ll);
                console.log('[Playback] 使用containerPoint定位:', ll && ll.lng, ll && ll.lat, '=>', p && p.x, p && p.y);
            } else {
                console.warn('地图对象不支持lngLat到像素坐标转换');
                return;
            }
            playbackDom.el.style.left = p.x + 'px';
            playbackDom.el.style.top = p.y + 'px';
        } catch(e) { console.warn('更新DOM标记位置失败:', e); }
    }

    function bindPlaybackDomEvents(){
        if (playbackDom.bound) return;
        const updater = function(){
            try {
                if (!map || !playbackDom.el || !playbackDom.lastLL) return;
                let p;
                if (typeof map.lngLatToLayerPoint === 'function') {
                    p = map.lngLatToLayerPoint(playbackDom.lastLL);
                } else if (typeof map.lngLatToContainerPoint === 'function') {
                    p = map.lngLatToContainerPoint(playbackDom.lastLL);
                }
                if (!p) return;
                playbackDom.el.style.left = p.x + 'px';
                playbackDom.el.style.top = p.y + 'px';
            } catch(e){}
        };
        try {
            map.addEventListener('move', updater);
            map.addEventListener('zoom', updater);
            playbackDom.bound = true;
        } catch(e){}
    }

    function removePlaybackDom(){
        try {
            const el = playbackDom.el;
            playbackDom.lastLL = null;
            if (el && el.parentNode) el.parentNode.removeChild(el);
        } catch(e){}
        playbackDom.el = null;
        playbackDom.bound = false;
    }

</script>
</body>

</html>
