<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>展示轮廓</title>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #mapContainer {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        #mapLoading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
            transition: opacity 0.3s;
        }

        .loading-text {
            font-size: 16px;
            color: #333;
            padding: 10px 20px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .wkt-input-container {
            position: absolute;
            top: 20px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            width: min(320px, 90vw);
            box-sizing: border-box;
            transition: all 0.3s;
        }

        .minimize-btn {
            position: absolute;
            top: -5px;
            right: -4px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #f0f0f0;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #666;
            z-index: 1001;
            transition: background 0.2s;
        }

        .minimize-btn:hover {
            background: #e0e0e0;
        }

        .content-wrapper {
            transition: all 0.3s;
        }

        .wkt-input-container.minimized {
            width: 40px;
            height: 40px;
            padding: 0;
        }

        .wkt-input-container.minimized .content-wrapper {
            display: none;
        }

        .wkt-input-container.minimized .min-icon {
            display: none;
        }

        .wkt-input-container.minimized .restore-icon {
            display: inline;
        }

        #wktTextarea {
            width: 100%;
            height: 120px;
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
            box-sizing: border-box;
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        /* 页签样式 */
        .tabs-header {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .tab-btn {
            flex: 1;
            padding: 6px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            background: #f5f5f5;
            color: #333;
            transition: background 0.2s;
        }
        .tab-btn.active { background: #337AFF; color: #fff; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        /* Multi → Polygons 分割器样式 */
        .split-section {
            margin-top: 10px;
            padding: 10px;
            background: #fafafa;
            border: 1px solid #eee;
            border-radius: 6px;
        }
        .split-section .title {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
        }
        .split-section .desc {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        #multiInput, #polyOutput {
            width: 100%;
            height: 90px;
            margin-bottom: 8px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
            box-sizing: border-box;
        }
        .split-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .split-actions button {
            flex: 1;
            padding: 6px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }
        #splitMultiBtn { background: #337AFF; color: #fff; }
        #splitMultiBtn:hover { background: #2860E0; }
        #copyPolysBtn { background: #f5f5f5; color: #333; }
        #copyPolysBtn:hover { background: #e0e0e0; }
        #drawButton,
        #clearButton,
        #drawTrackButton,
        #clearTrackButton {
            width: 50%;
            padding: 8px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        #drawButton,
        #drawTrackButton {
            background: #337AFF;
            color: white;
        }

        #drawButton:hover,
        #drawTrackButton:hover {
            background: #2860E0;
        }

        #clearButton,
        #clearTrackButton {
            background: #f5f5f5;
            color: #333;
        }

        #clearButton:hover,
        #clearTrackButton:hover {
            background: #e0e0e0;
        }

        #drawButton:disabled,
        #clearButton:disabled,
        #drawTrackButton:disabled,
        #clearTrackButton:disabled {
            background: #e0e0e0;
            color: #999;
            cursor: not-allowed;
        }

        .tip {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .area-label {
             position: absolute;
             background: rgba(255, 0, 0, 0.85);
             border: 1px solid #000;
             border-radius: 3px;
             padding: 4px 6px;
             font-size: 12px;
             color: #fff;
             font-weight: 600;
             box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
             white-space: nowrap;
             z-index: 9999;
             pointer-events: none;
         }
         /* 默认隐藏标签容器下的标签 */
          .labels-hidden .area-label { display: none; }

          /* Batch → Generator 样式 */
          .batch-section { margin-top: 10px; padding: 10px; background: #fafafa; border: 1px solid #eee; border-radius: 6px; }
          .batch-section .title { font-size: 13px; font-weight: 600; color: #333; margin-bottom: 6px; }
          .batch-section .desc { font-size: 12px; color: #666; margin-bottom: 8px; }
          #batchInput, #multiOutput { width: 100%; height: 90px; margin-bottom: 8px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; resize: vertical; box-sizing: border-box; }
          .batch-actions { display: flex; gap: 8px; margin-bottom: 8px; }
          .batch-actions button { flex: 1; padding: 6px 0; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; transition: background 0.2s; }
          #generateMultiBtn { background: #337AFF; color: #fff; }
          #generateMultiBtn:hover { background: #2860E0; }
          #copyMultiBtn { background: #f5f5f5; color: #333; }
          #copyMultiBtn:hover { background: #e0e0e0; }
      </style>
    <script src="https://api.tianditu.gov.cn/api?v=4.0&tk=648f621977051d0199ff0f965d3fd322"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
    <script src="https://lib.baomitu.com/terraformer/1.0.12/terraformer.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://unpkg.com/terraformer-wkt-parser@1.2.1/terraformer-wkt-parser.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- 已移除动态备用加载器 ensureTerraformer：改为仅使用静态脚本标签加载 Terraformer 核心库与 WKT 解析器 -->
    <script>
        // 检查Turf.js是否加载成功
        window.addEventListener('load', function () {
            if (typeof turf === 'undefined') {
                console.warn('Turf.js加载失败，已启用备用面积算法');
            } else {
                console.log('Turf.js加载成功');
            }
        });
    </script>
</head>

<body>
<div id="mapContainer">
    <div id="mapLoading">
        <div class="loading-text">地图正在加载中...</div>
    </div>
</div>

<div class="wkt-input-container">
    <div class="minimize-btn" id="minimizeBtn">
        <span class="min-icon">−</span>
        <span class="restore-icon" style="display:none;">+</span>
    </div>

    <div class="content-wrapper">
        <div class="tabs-header">
            <button class="tab-btn active" id="tabDrawBtn">轮廓</button>
            <button class="tab-btn" id="tabTrackBtn">轨迹</button>
            <button class="tab-btn" id="tabSplitBtn">分割器</button>
            <button class="tab-btn" id="tabBatchBtn">合并器</button>
        </div>
        <div class="tab-pane active" id="tabDraw">
            <div class="tip">请输入WKT字符串（支持POLYGON/MULTIPOLYGON）：</div>
            <textarea id="wktTextarea">POLYGON ((116.34986546276276 40.0465285347786, 116.34986548323006 40.046528588949656, 116.34986548861538 40.04652864520629, 116.34986547868387 40.046528701096165, 116.3498654538685 40.04652875418295, 116.34986530127308 40.04652899728591, 116.34986528935734 40.04652902234996, 116.34986472139539 40.04653072383468, 116.3498647161396 40.04653075021307, 116.34986459557499 40.04653250435084, 116.34986459718552 40.046532531007294, 116.34986492874633 40.04653426901034, 116.3498649371602 40.046534294900304, 116.34986570784409 40.04653594861134, 116.34986572273087 40.04653597271925, 116.3498669023157 40.046537477288375, 116.34986692309208 40.04653749866913, 116.34986846531997 40.04653879509379, 116.34986849107428 40.04653881284223, 116.34987036456015 40.04653986502694, 116.34987105377682 40.046540177255984, 116.34987112142043 40.046540217119706, 116.34987117459102 40.0465402683244, 116.34987231353702 40.046541689598286, 116.34987233331907 40.04654170977059, 116.34987379130222 40.046542937709475, 116.34987381563357 40.04654295469046, 116.34987554612091 40.04654395199893, 116.34987557414837 40.046543965193095, 116.34987751636382 40.04654469684502, 116.3498775471026 40.04654470578862, 116.34987963283575 40.04654514608854, 116.34987966520546 40.04654515046722, 116.34988051019873 40.04654520278329, 116.34988057571515 40.04654521169432, 116.3498806378735 40.04654522993299, 116.34988069444708 40.046545256845945, 116.34988132198927 40.0465456227546, 116.34988134765234 40.04654563517944, 116.34988315627459 40.046546349390525, 116.34989102737592 40.04654882472709, 116.34989108759855 40.04654884914158, 116.34989114056764 40.04654888202043, 116.34990630972383 40.0465603318849, 116.34990778681129 40.04656127601604, 116.34992173743585 40.046568805261586, 116.34992335652765 40.04656953580844, 116.34992338214171 40.046569545304344, 116.3499251610037 40.046570071521614, 116.34993796324055 40.04657297128468, 116.3499380185073 40.046572987810585, 116.34993806937325 40.04657301124107, 116.34994779764934 40.046578398613406, 116.34994785819595 40.04657844122403, 116.34995295007722 40.046582972674926, 116.34995422861292 40.04658394584081, 116.34995424941789 40.0465839593781, 116.34995573204282 40.04658477963024, 116.34997295619729 40.04659283000946, 116.34997502506849 40.04659359205416, 116.34997505783824 40.0465936011725, 116.34997708219845 40.04659399482983, 116.34997715196737 40.04659401463448, 116.34997721475328 40.04659404527681, 116.34997969762303 40.04659556252431, 116.34997974585558 40.046595598268205, 116.34997978438781 40.04659564039599, 116.34997981182008 40.04659568737725, 116.34997982715558 40.046595737505235, 116.34997982983748 40.04659578895888, 116.34997981976821 40.046595839869, 116.34997979731355 40.046595888386086, 116.34997626024645 40.04660170503114, 116.34997566626737 40.0466028965868, 116.34993578647021 40.046703590499526, 116.34993565865426 40.04670408187971, 116.34993563769575 40.046704134180445, 116.34993438526118 40.046706409479235, 116.34993371105925 40.046708069456514, 116.34993370408242 40.046708095324774, 116.34993346422026 40.04670982442253, 116.34993346394398 40.04670985083961, 116.34993366761225 40.04671158267723, 116.34993367404716 40.04671160862823, 116.34993431341891 40.04671327665212, 116.34993432631728 40.04671330113893, 116.34993537682209 40.046714841247905, 116.34993539568899 40.04671486333084, 116.34993681695647 40.04671621633922, 116.3499368410657 40.04671623516845, 116.34993857847755 40.046717349081, 116.34993860690354 40.04671736393378, 116.3499405936914 40.04671819594303, 116.34994062534182 40.04671820624846, 116.34994278515481 40.046718724381016, 116.34994281881323 40.046718729742935, 116.34994506865083 40.04671891408723, 116.3499451030235 40.046718914299554, 116.34994735642587 40.0467187577714, 116.34994739019204 40.046718752825946, 116.34994956056211 40.04671826144063, 116.34994959242405 40.04671825152747, 116.34995159635604 40.04671744416849, 116.34995162508893 40.0467174296688, 116.34995338557212 40.04671633736286, 116.34995341007294 40.04671631883321, 116.3499548594536 40.04671498355669, 116.34995487870746 40.046714961791395, 116.34995597630376 40.046713410998336, 116.34996764476163 40.04669224045836, 116.34996831893815 40.04669058054116, 116.34996832591496 40.04669055467289, 116.34996856577618 40.04668882557505, 116.34996856605244 40.04668879915798, 116.34996836238335 40.046687067320434, 116.3499683559484 40.046687041369374, 116.34996802194195 40.04668616999805, 116.34996800887745 40.04668611653622, 116.3499680100122 40.04668606214668, 116.34996802530031 40.04668600903426, 116.34996805412203 40.046685959352, 116.34996809530892 40.046685915113876, 116.34996814719135 40.04668587811321, 116.349968443904 40.04668570576446, 116.34996846916262 40.046685687847024, 116.34996997336701 40.04668438887884, 116.3499699935928 40.04668436751766, 116.34997113915855 40.046682867975576, 116.34997115351958 40.04668284408186, 116.34997190616208 40.04668117615789, 116.34997534451054 40.046670205730905, 116.34997535750676 40.04667017334318, 116.34999357466431 40.0466331911314, 116.34999358312665 40.046633175457465, 116.35000569263151 40.04661259690547, 116.35000572887131 40.04661254907784, 116.35000577703204 40.04661250792933, 116.35000583509265 40.046612475186784, 116.35000590061654 40.04661245222424, 116.35000597085394 40.046612440005305, 116.35000604285746 40.046612439042796, 116.3500061136054 40.04661244937708, 116.35000618012869 40.046612470574466, 116.35000623963576 40.046612501745415, 116.35000628962933 40.046612541581815, 116.35000632801137 40.04661258841192, 116.35001118706715 40.04662013514285, 116.35001260704017 40.046621829300506, 116.3500127809854 40.04662199341986, 116.3500128218873 40.04662204175234, 116.35001284851401 40.046622095654264, 116.35001285965289 40.046622152670935, 116.350012902563 40.04662293506374, 116.35001290717375 40.04662296059618, 116.35001341835061 40.046624611065724, 116.35001342920243 40.046624635457604, 116.35001433989 40.046626180942106, 116.35001435658607 40.04662620330032, 116.35001563346997 40.046627587263956, 116.35001565539893 40.04662760677, 116.35001725176889 40.04662877858505, 116.35001727803092 40.046628794466365, 116.35001916459534 40.04662972418237, 116.35002561673257 40.046632273400945, 116.35002784485411 40.04663294022703, 116.35002787987698 40.04663294760615, 116.35003023892075 40.0466332472729, 116.35003027517043 40.04663324894746, 116.35003266393421 40.046633168606604, 116.35003269972145 40.04663316452001, 116.3500350504922 40.04663269927461, 116.3500364221613 40.046632308432734, 116.35003648414933 40.046632295575876, 116.3500365481462 40.04663229159827, 116.35003661201696 40.046632296632595, 116.35003667363097 40.04663231051093, 116.35003673093306 40.0466323327703, 116.35003678201156 40.04663236266819, 116.35004420039937 40.0466375930272, 116.35004594009098 40.046638604895016, 116.3500459682975 40.04663861828112, 116.35004792464304 40.04663936045928, 116.35004795562297 40.04663936952675, 116.35005005874217 40.046639815509195, 116.3500500913888 40.04663981993422, 116.35005226613468 40.04663995378545, 116.35005229928161 40.04663995340989, 116.35005446794833 40.046639770347255, 116.35005450041118 40.04663976518454, 116.35005658551013 40.046639271749115, 116.35005661612884 40.04663926198371, 116.35005822416109 40.046638605948544, 116.35005829595073 40.04663858404378, 116.35005900510836 40.046638434466814, 116.35005903801037 40.04663842469949, 116.35006110886833 40.046637617510086, 116.35006113856133 40.04663760287874, 116.35006295728758 40.046636493461065, 116.35006298256893 40.04663647455823, 116.35006447555386 40.046635107813785, 116.35006449540023 40.04663508540476, 116.35006560221744 40.04663351665038, 116.35006561582598 40.04663349164178, 116.35006629167849 40.04663178437094, 116.35006629849865 40.04663175777412, 116.35006651603291 40.04662998108559, 116.35006651578816 40.0466299539781, 116.35006626619985 40.04662817978021, 116.35006625890017 40.04662815325884, 116.35006555229089 40.04662645335947, 116.35006553823187 40.04662642849792, 116.35006440320034 40.04662487169719, 116.3500643829511 40.04662484950168, 116.35006286543624 40.04662349880923, 116.35006283991157 40.04662348024727, 116.35006097225899 40.04662237480022, 116.35004955769939 40.04661692048493, 116.35004950562984 40.04661689010269, 116.35003197743508 40.046604527914376, 116.35003133796805 40.046604107940595, 116.35002427658934 40.04659979283469, 116.35002422185879 40.04659975108531, 116.35002418028927 40.046599701169185, 116.35002067668124 40.04659425865669, 116.3500197584283 40.04659307219668, 116.3500183060066 40.04659148439428, 116.35001827052511 40.04659143552906, 116.35001824890311 40.046591382094334, 116.35001824206809 40.04659132638241, 116.35001825031328 40.04659127078335, 116.35001827328495 40.04659121768229, 116.35002835506718 40.04657408496225, 116.35002836318787 40.04657407208218, 116.35007030155654 40.04651181280641, 116.35007034594172 40.0465117619926, 116.35007040406909 40.046511720160154, 116.3500704729557 40.04651168945573, 116.35007237620943 40.04651105014548, 116.35008042354188 40.04650762027999, 116.35008197301023 40.04650682824675, 116.35008199514581 40.04650681483446, 116.350083378847 40.046505826282065, 116.35009140686215 40.04649909310751, 116.35009145648334 40.046499058714055, 116.35009151367588 40.046499032157996, 116.35009608945039 40.04649734080536, 116.35009786563725 40.04649652675874, 116.35009789108031 40.04649651257843, 116.3500994497027 40.04649546802105, 116.35009947136439 40.04649545064334, 116.35010078100103 40.046494189514135, 116.35010708698134 40.04648686507036, 116.35010712303979 40.0464868299099, 116.35010716615798 40.04648679980848, 116.35012499485308 40.046476286458024, 116.35012661955169 40.04647512132793, 116.35012664190444 40.04647510188157, 116.35012794596008 40.04647371906628, 116.3501279629859 40.0464736967716, 116.35012891082462 40.04647212345158, 116.35013061942584 40.04646838238028, 116.35013116586742 40.0464666426548, 116.35013117063902 40.04646661582, 116.35013125104638 40.046464799966515, 116.35013112250031 40.04646331169131, 116.35013112443423 40.04646326033904, 116.35013113898098 40.04646321019649, 116.35013116561477 40.046463163076695, 116.35013120337231 40.04646312068338, 116.35013425355595 40.04646031181901, 116.35013554714253 40.046458845497135, 116.35013556373792 40.046458821915216, 116.35013646430616 40.04645716191607, 116.35013715786589 40.046455412430426, 116.35013718466482 40.04645536302411, 116.35013722361157 40.04645531864798, 116.35013727317734 40.04645528104389, 116.35013958164467 40.04645384720259, 116.35014179573828 40.04645202981987, 116.35015221067522 40.04644069282643, 116.35015337803077 40.04643909395263, 116.3501533924007 40.04643906839014, 116.35015410713254 40.04643731924206, 116.35015411435766 40.046437291955634, 116.35015434594197 40.046435467242524, 116.35015434571396 40.04643543939736, 116.3501540842578 40.04643361706987, 116.35015407658614 40.04643358985509, 116.35015333325889 40.04643184776113, 116.35015331847144 40.04643182233994, 116.35015212502688 40.04643023489968, 116.3501521038347 40.04643021244179, 116.35015048564908 40.04642882765676, 116.3501450151781 40.04642501907637, 116.35014319778388 40.0464239832417, 116.35014316830032 40.04642396966107, 116.3501411229238 40.04642322623574, 116.35014109055898 40.04642321733661, 116.35013889577056 40.04642279487166, 116.35013886176885 40.046422790996175, 116.35013660191264 40.04642270572664, 116.3501365675805 40.04642270702371, 116.35013432950176 40.046422962226465, 116.35013429615863 40.046422968646226, 116.35013216586529 40.046423554513964, 116.35013213479242 40.046423565809725, 116.35013019415071 40.04642445982786, 116.35013016654202 40.046424475565665, 116.35012849012965 40.046425643377425, 116.35012846704625 40.04642566295246, 116.35012711928674 40.04642705967959, 116.35012710161568 40.046427082339825, 116.3501261343026 40.04642865430689, 116.35012612272337 40.04642867918085, 116.35012557302971 40.04643036597868, 116.35012556798715 40.04643039210996, 116.35012545703776 40.04643212891564, 116.35012545872542 40.046432155301495, 116.35012579078403 40.0464338753697, 116.35012579913719 40.046433900995765, 116.35012656144303 40.04643553822595, 116.35012657614067 40.04643556210693, 116.35012722081052 40.04643638867195, 116.35012724981574 40.04643643556517, 116.35012726661358 40.04643648585668, 116.35012727058368 40.04643653768901, 116.35012726157939 40.04643658914785, 116.35012723993327 40.046436638332644, 116.35012720644482 40.046436683426826, 116.35012360994672 40.046440597465, 116.35012354354504 40.04644065187608, 116.35011966237016 40.046443058713045, 116.35011803039514 40.046444294519546, 116.35011800815072 40.04644431509079, 116.35011672596254 40.0464457742476, 116.35011670950472 40.04644579770252, 116.35011581572667 40.046447448004194, 116.3501147540259 40.04645012611367, 116.35011472697852 40.04645017587365, 116.35011468761112 40.04645022051394, 116.35011010683534 40.04645443762885, 116.35010886596879 40.046455829881786, 116.35010884981828 40.04645585231872, 116.35010797449134 40.04645739995477, 116.35010796416202 40.04645742433569, 116.35010748603256 40.04645907136766, 116.35010748191355 40.04645909671558, 116.35010741888736 40.04646080925691, 116.35010766451718 40.046463653110095, 116.35010766231133 40.04646370609674, 116.35010764668488 40.04646375773227, 116.35010761823953 40.046463806028555, 116.35010757807052 40.04646384912608, 116.35010752772459 40.046463885365455, 116.35010290846526 40.046466608873374, 116.35010284786958 40.04646663761483, 116.35010278098093 40.046466656381966, 116.35010271054361 40.04646666440478, 116.35010263944778 40.04646666135411, 116.35010257061032 40.046466647355096, 116.35010250685559 40.046466622982145, 116.35010245079938 40.04646658923524, 116.35010240474185 40.046466547498994, 116.3501023705725 40.04646649948584, 116.35010234969333 40.04646644716571, 116.35010234296108 40.04646639268527, 116.35010235065181 40.046466338279814, 116.35010367261523 40.046461563837305, 116.35010392405755 40.0464598779871, 116.35010392467271 40.04645985220849, 116.3501037538264 40.04645816044046, 116.35010374804334 40.046458135043984, 116.35010316116514 40.046456499231915, 116.35010314919607 40.04645647514724, 116.35010216776158 40.04645495515109, 116.35010215004412 40.046454933258765, 116.350100809968 40.04645358470147, 116.3501007871506 40.046453565802494, 116.3500991374712 40.04645243803273, 116.35009911038823 40.046452422818355, 116.35009721147313 40.04645155710491, 116.35009718111633 40.0464515461325, 116.35009510245344 40.04645097415493, 116.3500950699333 40.04645096782578, 116.35009288758845 40.04645071051474, 116.35009285409554 40.04645070906055, 116.35009064792828 40.046450775831985, 116.35009061468774 40.04645077930593, 116.35008846542974 40.04645116771644, 116.35008843365814 40.04645117599138, 116.35008641995837 40.04645187182764, 116.35008639081823 40.04645188460087, 116.35008458636555 40.046452862399605, 116.35008456092292 40.04645287920381, 116.35008303174837 40.046454103183905, 116.35008301101239 40.04645412332852, 116.35008179616393 40.046455571069856, 116.35005401880262 40.046496807796316, 116.35005398175373 40.04649685175484, 116.35005393436529 40.04649688939355, 116.35005387841804 40.04649691929801, 116.35005381601461 40.04649694034441, 116.35004724473872 40.04649859408579, 116.35004593649916 40.046498992030344, 116.34999172347979 40.04651842930868, 116.34999168363923 40.04651844138072, 116.34994754000766 40.04652948131404, 116.34994746927924 40.046529492986835, 116.34994739693956 40.04652949328588, 116.34994732605179 40.04652948219852, 116.349947259618 40.04652946019425, 116.3499471783356 40.046529425252224, 116.34994496704097 40.046528660649464, 116.34994493210418 40.04652865182079, 116.3499425649754 40.046528259169705, 116.34994252854676 40.04652825614923, 116.34994007003439 40.046528253143485, 116.34991615847863 40.04653014775409, 116.34991609271088 40.0465301482115, 116.34991602798337 40.046530139245704, 116.34991394066905 40.04652969181404, 116.34991390655493 40.0465296872401, 116.34991158979648 40.04652955756766, 116.34989970654772 40.04652979370132, 116.34989963413037 40.046529789371085, 116.34989956441679 40.04652977369498, 116.34989950038336 40.04652974734226, 116.34989944476388 40.046529711438, 116.34989901258622 40.04652936798994, 116.3498989886331 40.046529352118654, 116.34989726269768 40.04652840475281, 116.34989721275096 40.04652837146619, 116.34989717179644 40.04652833158126, 116.3498971412825 40.04652828650862, 116.34989712228825 40.0465282378423, 116.34989711548553 40.04652818730346, 116.34989712111498 40.046528136679434, 116.34989713897735 40.04652808776063, 116.34989716844098 40.04652804227709, 116.34989720846387 40.04652800183742, 116.34989766816167 40.046527618340356, 116.34989906975387 40.04652618953219, 116.3498990880848 40.04652616629295, 116.34990008793334 40.04652455071475, 116.34990009982403 40.04652452512128, 116.34990065753202 40.046522788210105, 116.34990066249847 40.04652276130445, 116.34990075537978 40.046520973712965, 116.34990075322058 40.046520946587925, 116.34990037749701 40.04651918102941, 116.34990036829998 40.046519154789785, 116.34989953925482 40.04651748308166, 116.34989952339393 40.04651745879375, 116.34989827474995 40.04651594893543, 116.34989825287082 40.04651592758798, 116.34989663541911 40.04651464099617, 116.3498966084107 40.046514623456495, 116.3498946879443 40.046513612465674, 116.34989465702144 40.046513599496265, 116.34989247835034 40.04651289592324, 116.34988759910529 40.04651174732833, 116.34988548769826 40.046511411649256, 116.34988545513545 40.04651140887391, 116.34988329938676 40.04651138085688, 116.3498832668417 40.046511382777325, 116.34988110985698 40.04651166880742, 116.34987257913674 40.04651344035761, 116.34987041940818 40.046514072710536, 116.34987038801779 40.04651408479217, 116.34986843554447 40.04651503515106, 116.34986840791508 40.04651505179716, 116.34986674095107 40.04651628206567, 116.34986671819021 40.046516302609206, 116.34986540357357 40.04651776345866, 116.34986538659466 40.04651778707536, 116.34986447703523 40.04651941993283, 116.34986446651949 40.04651944567483, 116.34986399848763 40.04652118506851, 116.3498639948693 40.046521211805484, 116.3498639887538 40.046523014977524, 116.34986430031681 40.04652546441898, 116.34986472953968 40.04652714618852, 116.34986473924147 40.04652717113488, 116.34986546276276 40.0465285347786), (116.3500060186182 40.046568332992955, 116.35000598750447 40.04656837527111, 116.35000594704378 40.04656841258445, 116.35000589854384 40.046568443726976, 116.35000584357225 40.04656846769214, 116.35000578390563 40.04656848370536, 116.35000486885907 40.04656866024692, 116.35000483636918 40.04656866920763, 116.35000278365602 40.046569417968875, 116.35000275407941 40.04656943164801, 116.35000093201074 40.046570474967744, 116.35000090658923 40.04657049276853, 116.34999936387085 40.04657181083551, 116.34999187054133 40.04657963199787, 116.34999182324214 40.04657967219797, 116.34999176645441 40.04657970433358, 116.34999170246358 40.04657972711148, 116.34999163384491 40.04657973961501, 116.34999156335961 40.04657974134099, 116.34999149384443 40.04657973221999, 116.34999142809664 40.046579712619035, 116.34999136876236 40.04657968332694, 116.34998730888378 40.04657720394042, 116.34998547468679 40.046576286764115, 116.34998544522429 40.04657627492149, 116.3499834188053 40.046575640297846, 116.34998338696408 40.04657563294168, 116.34998124111627 40.04657530365932, 116.3499812080407 40.04657530105395, 116.34998064238223 40.0465752979246, 116.34998057957215 40.046575293223654, 116.3499805188677 40.04657527996772, 116.34998046222528 40.04657525858397, 116.34996952204156 40.04657014427041, 116.34996947762392 40.04657011967102, 116.34996943871472 40.046570090069594, 116.34996465460011 40.04656583415586, 116.3499626337987 40.04656441426222, 116.34995008765667 40.04655746758308, 116.34994841759202 40.04655669829701, 116.34994839111079 40.04655668832748, 116.34994654848668 40.046556138362966, 116.34993367478513 40.04655322241318, 116.34993362143038 40.04655320660158, 116.34993357211701 40.046553184351026, 116.34992414974997 40.0465480982995, 116.3499240960908 40.046548062608046, 116.34992405285197 40.04654801936135, 116.34992402179547 40.0465479703218, 116.34992400418687 40.046547917487764, 116.34992400074378 40.04654786301233, 116.34992401160655 40.0465478091154, 116.34992403633241 40.04654775799335, 116.34992407391383 40.04654771172946, 116.34992412281925 40.04654767220902, 116.34992418105574 40.046547641042544, 116.34992424625023 40.0465476195001, 116.34992431574577 40.04654760845956, 116.34993278408385 40.046546937478574, 116.34993285879192 40.046546937692575, 116.34993293175407 40.046546950034745, 116.34993299967503 40.04654697394766, 116.34993305948724 40.04654700835134, 116.3499340249001 40.04654769810754, 116.34993405180637 40.04654771390157, 116.34993594503912 40.04654861719421, 116.34993597539295 40.04654862871997, 116.34993805920143 40.04654923556264, 116.34993809187165 40.04654924239061, 116.34994028857848 40.04654953016233, 116.34994032234708 40.046549532037936, 116.34994255006656 40.04654949001156, 116.34994258354979 40.04654948687658, 116.34994479202167 40.04654910976662, 116.34999964586859 40.04653539077802, 116.35000097363583 40.046534987921845, 116.35003606625467 40.04652240598499, 116.35003612948887 40.04652238874349, 116.35003619583352 40.04652238104933, 116.35003626287185 40.046522383182804, 116.35003632816169 40.0465223950662, 116.35003638932463 40.046522416266605, 116.35003644413264 40.04652244601172, 116.35003649058896 40.04652248321796, 116.35003652700138 40.04652252652998, 116.35003655204349 40.04652257436994, 116.3500365648029 40.04652262499511, 116.35003656481494 40.04652267656129, 116.35003655207902 40.04652272718995, 116.35003652705922 40.0465227750368, 116.35000740598211 40.046566006469625, 116.35000713123374 40.04656644224331, 116.3500060186182 40.046568332992955))</textarea>
            <div class="coord-settings" style="margin-bottom:8px;font-size:12px;color:#333;">
                <label>WKT坐标系：
                    <select id="coordSysSelect" style="margin-left:6px;">
                        <option value="wgs84" selected>WGS84</option>
                        <option value="gcj02">GCJ-02（国测局）</option>
                        <option value="bd09">BD-09（百度）</option>
                        <option value="cgcs2000">CGCS2000</option>
                    </select>
                </label>
                <!-- 已移除“不进行绘制坐标转换”选项，统一使用WGS84绘制 -->
            </div>

            <div class="button-group">
                <button id="drawButton" disabled>绘制轮廓</button>
                <button id="clearButton" disabled>清空轮廓</button>
            </div>
            <!-- 显示开关：仅保留显示亩数 -->
            <div class="display-toggles" style="margin-top:8px;font-size:12px;color:#333;">
                <label><input type="checkbox" id="toggleLabelsCheckbox"> 显示亩数</label>
            </div>
        </div>

        <div class="tab-pane" id="tabSplit">
            <!-- MultiPolygon → 多个 Polygon 分割器 -->
            <div class="split-section">
                <div class="title">MultiPolygon → 多个 Polygon 分割器</div>
                <div class="desc">输入一个 MULTIPOLYGON WKT，分割为多行 POLYGON WKT。</div>
                <textarea id="multiInput"></textarea>
                <div class="split-actions">
                    <button id="splitMultiBtn">分割为多个 POLYGON</button>
                    <button id="copyPolysBtn">复制结果</button>
                </div>
                <textarea id="polyOutput" readonly></textarea>
            </div>
        </div>

        <div class="tab-pane" id="tabBatch">
            <!-- 批量POLYGON → MULTIPOLYGON 生成器 -->
            <div class="batch-section">
                <div class="title">批量POLYGON → MULTIPOLYGON 合并器</div>
                <div class="desc">每行一个 POLYGON WKT（或用分号分隔）。生成后可一键填充到上方并绘制。</div>
                <textarea id="batchInput"></textarea>
                <div class="batch-actions">
                    <button id="generateMultiBtn">生成 MULTIPOLYGON</button>
                    <button id="copyMultiBtn">复制结果</button>
                </div>
                <textarea id="multiOutput" readonly></textarea>
            </div>
        </div>
        <div class="tab-pane" id="tabTrack">
            <div class="tip">请粘贴轨迹文本（支持两种格式：1）每行一条：定位时间yyyyMMddHHmmss, 经度, 纬度；2）单行#分隔：经度,纬度,定位时间yyyyMMddHHmmss#经度,纬度,定位时间yyyyMMddHHmmss#…）。</div>
            <div class="coord-settings" style="margin-bottom:8px;font-size:12px;color:#333;">
                <label>轨迹坐标系：
                    <select id="trackCoordSysSelect" style="margin-left:6px;">
                        <option value="wgs84" selected>WGS84</option>
                        <option value="gcj02">GCJ-02（国测局）</option>
                        <option value="bd09">BD-09（百度）</option>
                        <option value="cgcs2000">CGCS2000</option>
                    </select>
                </label>
            </div>
            <textarea id="trackTextarea" style="width:100%;height:120px;margin-bottom:10px;padding:8px;border:1px solid #ddd;border-radius:4px;font-family:monospace;resize:vertical;box-sizing:border-box;">20251029101604,116.35009053,40.04646576
20251029101605,116.35009049,40.04646580
20251029101607,116.35009106,40.04646441
20251029101608,116.35009126,40.04646380
20251029101609,116.35009148,40.04646320
20251029101610,116.35009151,40.04646301
20251029101611,116.35009173,40.04646221
20251029101613,116.35009193,40.04646151
20251029101614,116.35009193,40.04646151
20251029101615,116.35009225,40.04646100
20251029101616,116.35009168,40.04646166
20251029101617,116.35009138,40.04646190
20251029101618,116.35009153,40.04646128
20251029101619,116.35009221,40.04645970
20251029101621,116.35009111,40.04646108
20251029101622,116.35009016,40.04646251
20251029101623,116.35008853,40.04646498
20251029101624,116.35008853,40.04646498
20251029101625,116.35008851,40.04646500
20251029101626,116.35008815,40.04646563
20251029101627,116.35008701,40.04646671
20251029101628,116.35008696,40.04646678
20251029101629,116.35008653,40.04646733
20251029101630,116.35008636,40.04646743
20251029101631,116.35008635,40.04646745
20251029101632,116.35008543,40.04646895
20251029101633,116.35008395,40.04647116
20251029101634,116.35008390,40.04647121
20251029101635,116.35008045,40.04647681
20251029101636,116.35007785,40.04648051
20251029101637,116.35007536,40.04648411
20251029101638,116.35007265,40.04648900
20251029101639,116.35007066,40.04649231
20251029101640,116.35007058,40.04649235
20251029101641,116.35007058,40.04649238
20251029101642,116.35006921,40.04649498
20251029101643,116.35006814,40.04649661
20251029101644,116.35006813,40.04649661
20251029101645,116.35006635,40.04649996
20251029101646,116.35006603,40.04650033
20251029101647,116.35006603,40.04650035
20251029101648,116.35006601,40.04650035
20251029101649,116.35006599,40.04650036
20251029101650,116.35006601,40.04650035
20251029101651,116.35006601,40.04650035
20251029101652,116.35006599,40.04650036
20251029101653,116.35006601,40.04650035
20251029101654,116.35006601,40.04650035
20251029101655,116.35006601,40.04650033
20251029101656,116.35006521,40.04650164
20251029101657,116.35006506,40.04650173
20251029101658,116.35006508,40.04650173
20251029101659,116.35006508,40.04650173
20251029101700,116.35006508,40.04650173
20251029101701,116.35006506,40.04650173
20251029101702,116.35006505,40.04650175
20251029101703,116.35006505,40.04650175
20251029101704,116.35006505,40.04650173
20251029101705,116.35006426,40.04650285
20251029101706,116.35006368,40.04650371
20251029101707,116.35006173,40.04650666
20251029101708,116.35006011,40.04650878
20251029101709,116.35006010,40.04650880
20251029101710,116.35006010,40.04650880
20251029101711,116.35005998,40.04650891
20251029101712,116.35005953,40.04650920
20251029101713,116.35005880,40.04650998
20251029101714,116.35005880,40.04650998
20251029101715,116.35005875,40.04651001
20251029101716,116.35005843,40.04651061
20251029101717,116.35005831,40.04651046
20251029101718,116.35005893,40.04650878
20251029101719,116.35005875,40.04650905
20251029101720,116.35005866,40.04650910
20251029101721,116.35005871,40.04650906
20251029101722,116.35005868,40.04650906
20251029101723,116.35005843,40.04650936
20251029101724,116.35005685,40.04651195
20251029101725,116.35005531,40.04651386
20251029101726,116.35005160,40.04652020
20251029101727,116.35004871,40.04652405
20251029101728,116.35004861,40.04652408
20251029101729,116.35004855,40.04652410
20251029101730,116.35004855,40.04652410
20251029101731,116.35004796,40.04652496
20251029101732,116.35004341,40.04653205
20251029101733,116.35004310,40.04653218
20251029101734,116.35003993,40.04653769
20251029101735,116.35003723,40.04654215
20251029101736,116.35003476,40.04654576
20251029101737,116.35003473,40.04654576
20251029101738,116.35003468,40.04654578
20251029101739,116.35003456,40.04654581
20251029101740,116.35003458,40.04654590
20251029101741,116.35003165,40.04655058
20251029101742,116.35002900,40.04655471
20251029101743,116.35002770,40.04655673
20251029101744,116.35002761,40.04655676
20251029101745,116.35002625,40.04655905
20251029101746,116.35002621,40.04655890
20251029101747,116.35002605,40.04655910
20251029101748,116.35002486,40.04656078
20251029101749,116.35002398,40.04656163
20251029101750,116.35002406,40.04656111
20251029101751,116.35002306,40.04656248
20251029101752,116.35002229,40.04656311
20251029101753,116.35002190,40.04656350
20251029101754,116.35002166,40.04656398
20251029101755,116.35002168,40.04656390
20251029101756,116.35002136,40.04656470
20251029101757,116.35002035,40.04656631
20251029101758,116.35002020,40.04656643
20251029101759,116.35001983,40.04656705
20251029101800,116.35001930,40.04656781
20251029101801,116.35001928,40.04656781
20251029101802,116.35001873,40.04656868
20251029101803,116.35001781,40.04657015
20251029101804,116.35001606,40.04657306
20251029101805,116.35001575,40.04657368
20251029101806,116.35001495,40.04657520
20251029101807,116.35001371,40.04657736
20251029101808,116.35001228,40.04657995
20251029101809,116.35001186,40.04658068
20251029101810,116.35000951,40.04658466
20251029101811,116.35000868,40.04658620
20251029101812,116.35000858,40.04658625
20251029101813,116.35000811,40.04658699
20251029101814,116.35000685,40.04658918
20251029101815,116.35000618,40.04659033
20251029101816,116.35000370,40.04659488
20251029101817,116.34999921,40.04660186
20251029101818,116.34999828,40.04660326
20251029101819,116.34999826,40.04660326
20251029101820,116.34999806,40.04660331
20251029101821,116.34999823,40.04660328
20251029101822,116.34999821,40.04660330
20251029101823,116.34999821,40.04660330
20251029101824,116.34999803,40.04660330
20251029101825,116.34999646,40.04660561
20251029101826,116.34999536,40.04660763
20251029101827,116.34999533,40.04660763
20251029101828,116.34999473,40.04660858
20251029101829,116.34999385,40.04661013
20251029101830,116.34999116,40.04661446
20251029101831,116.34999068,40.04661503
20251029101832,116.34998960,40.04661696
20251029101833,116.34998825,40.04661933
20251029101834,116.34998625,40.04662323
20251029101835,116.34998275,40.04662973
20251029101836,116.34998086,40.04663333
20251029101837,116.34997971,40.04663613
20251029101838,116.34997843,40.04663818
20251029101839,116.34997753,40.04663973
20251029101840,116.34997593,40.04664400
20251029101841,116.34997380,40.04664835
20251029101842,116.34997186,40.04665216
20251029101843,116.34997050,40.04665468
20251029101844,116.34996870,40.04665781
20251029101845,116.34996781,40.04665950
20251029101846,116.34996670,40.04666246
20251029101847,116.34996588,40.04666396
20251029101848,116.34996493,40.04666593
20251029101849,116.34996413,40.04666753
20251029101850,116.34996368,40.04666860
20251029101851,116.34996335,40.04666933
20251029101852,116.34996308,40.04666995
20251029101853,116.34996306,40.04667020
20251029101855,116.34996355,40.04666985
20251029101856,116.34996336,40.04666975
20251029101857,116.34996303,40.04667154
20251029101859,116.34996350,40.04667108
20251029101900,116.34996343,40.04667126
20251029101901,116.34996356,40.04667121
20251029101902,116.34996343,40.04667128
20251029101904,116.34996358,40.04667113
20251029101905,116.34996283,40.04667244
20251029101906,116.34996265,40.04667273
20251029101907,116.34996271,40.04667269
20251029101908,116.34996281,40.04667295
20251029101910,116.34996281,40.04667295
20251029101911,116.34996216,40.04667463
20251029101912,116.34996181,40.04667581
20251029101913,116.34996126,40.04667731
20251029101914,116.34996051,40.04667908
20251029101925,116.34995685,40.04668874
20251029101926,116.34995563,40.04669156
20251029101927,116.34995395,40.04669513
20251029101928,116.34994900,40.04670375
20251029101929,116.34994510,40.04670993
20251029101930,116.34994518,40.04670991
20251029101931,116.34994519,40.04670991
20251029101932,116.34994518,40.04670991
20251029101943,116.34994700,40.04670620
20251029101944,116.34994905,40.04670150
20251029101945,116.34995295,40.04669251
20251029101946,116.34995343,40.04669130
20251029101947,116.34995338,40.04669131
20251029101948,116.34995326,40.04669135
20251029101949,116.34995335,40.04669133
20251029101950,116.34995361,40.04669066
20251029101951,116.34995386,40.04668920
20251029101952,116.34995388,40.04668920
20251029101953,116.34995388,40.04668920
20251029101954,116.34995278,40.04669026
20251029101955,116.34995421,40.04668685
20251029101956,116.34995564,40.04668388
20251029101957,116.34995566,40.04668386
20251029101958,116.34995636,40.04668146
20251029101959,116.34995713,40.04667906
20251029102000,116.34995873,40.04667425
20251029102001,116.34995920,40.04667290
20251029102002,116.34995925,40.04667288
20251029102003,116.34996018,40.04667013
20251029102004,116.34996088,40.04666870
20251029102005,116.34996105,40.04666865
20251029102006,116.34996101,40.04666865
20251029102007,116.34996108,40.04666863
20251029102008,116.34996100,40.04666865
20251029102009,116.34996100,40.04666865
20251029102010,116.34996101,40.04666865
20251029102011,116.34996101,40.04666865
20251029102012,116.34996101,40.04666865
20251029102013,116.34996098,40.04666865
20251029102014,116.34996106,40.04666858
20251029102015,116.34996109,40.04666861
20251029102016,116.34996496,40.04666028
20251029102017,116.34996665,40.04665686
20251029102018,116.34996663,40.04665691
20251029102019,116.34996663,40.04665691
20251029102020,116.34996666,40.04665688
20251029102021,116.34996668,40.04665686
20251029102022,116.34996715,40.04665578
20251029102023,116.34996890,40.04665168
20251029102024,116.34997021,40.04664871
20251029102025,116.34997300,40.04664221
20251029102026,116.34997350,40.04664118
20251029102027,116.34997351,40.04664116
20251029102028,116.34997350,40.04664123
20251029102029,116.34997353,40.04664123
20251029102030,116.34997353,40.04664123
20251029102031,116.34997321,40.04664198
20251029102032,116.34997398,40.04664008
20251029102033,116.34997514,40.04663740
20251029102034,116.34997625,40.04663518
20251029102035,116.34997653,40.04663453
20251029102037,116.34997655,40.04663451
20251029102038,116.34997703,40.04663230
20251029102039,116.34997810,40.04662813
20251029102040,116.34997811,40.04662808
20251029102041,116.34997813,40.04662808
20251029102042,116.34997813,40.04662806
20251029102043,116.34997813,40.04662804
20251029102044,116.34997814,40.04662804
20251029102045,116.34997868,40.04662636
20251029102046,116.34997943,40.04662301
20251029102047,116.34998029,40.04662098
20251029102048,116.34998029,40.04662098
20251029102049,116.34998029,40.04662099
20251029102050,116.34998033,40.04662098
20251029102051,116.34998085,40.04661959
20251029102052,116.34998288,40.04661441
20251029102053,116.34998396,40.04661205
20251029102054,116.34998401,40.04661198
20251029102055,116.34998400,40.04661203
20251029102056,116.34998398,40.04661203
20251029102057,116.34998401,40.04661199
20251029102058,116.34998403,40.04661198
20251029102059,116.34998688,40.04660551
20251029102100,116.34998735,40.04660480
20251029102101,116.34998730,40.04660486
20251029102102,116.34998731,40.04660485
20251029102103,116.34998943,40.04660123
20251029102104,116.34999326,40.04659441
20251029102105,116.34999341,40.04659433
20251029102106,116.34999343,40.04659431
20251029102107,116.34999551,40.04659121
20251029102108,116.34999601,40.04659050
20251029102109,116.34999811,40.04658826
20251029102110,116.34999811,40.04658826
20251029102111,116.34999811,40.04658825
20251029102112,116.34999943,40.04658668
20251029102113,116.35000158,40.04658448
20251029102114,116.35000455,40.04658154
20251029102115,116.35000665,40.04657893
20251029102116,116.35000881,40.04657714
20251029102117,116.35000938,40.04657786
20251029102118,116.35000938,40.04657788
20251029102119,116.35000936,40.04657789
20251029102120,116.35000936,40.04657789
20251029102121,116.35000936,40.04657789
20251029102122,116.35000645,40.04658103
20251029102123,116.35000591,40.04658141
20251029102124,116.35000591,40.04658141
20251029102125,116.35000591,40.04658143
20251029102126,116.35000528,40.04658260
20251029102127,116.35000530,40.04658303
20251029102128,116.35000530,40.04658304
20251029102129,116.35000528,40.04658304
20251029102130,116.35000530,40.04658304
20251029102131,116.35000530,40.04658304
20251029102132,116.35000528,40.04658304
20251029102133,116.35000530,40.04658304
20251029102134,116.35000530,40.04658304
20251029102135,116.35000528,40.04658306
20251029102136,116.35000190,40.04658828
20251029102137,116.35000151,40.04658873
20251029102138,116.35000151,40.04658873
20251029102139,116.35000153,40.04658875
20251029102140,116.35000151,40.04658875
20251029102141,116.35000149,40.04658876
20251029102142,116.35000355,40.04659093
20251029102143,116.35000438,40.04659258
20251029102144,116.35000453,40.04659281
20251029102145,116.35000801,40.04659606
20251029102146,116.35000895,40.04659703
20251029102147,116.35001018,40.04659826
20251029102148,116.35001128,40.04660005
20251029102149,116.35001433,40.04660410
20251029102150,116.35001528,40.04660708
20251029102152,116.35001568,40.04660755
20251029102153,116.35001615,40.04660910
20251029102155,116.35002168,40.04661613
20251029102156,116.35002553,40.04661868
20251029102157,116.35002553,40.04661868
20251029102158,116.35002823,40.04662231
20251029102159,116.35002453,40.04662160
20251029102200,116.35002453,40.04662168
20251029102201,116.35002453,40.04662171
20251029102202,116.35002451,40.04662171
20251029102203,116.35002520,40.04662216
20251029102204,116.35002805,40.04662370
20251029102205,116.35002963,40.04662389
20251029102206,116.35003096,40.04662426
20251029102207,116.35003441,40.04662398
20251029102208,116.35003655,40.04662188
20251029102209,116.35003833,40.04662216
20251029102210,116.35004011,40.04662293
20251029102211,116.35004266,40.04662351
20251029102212,116.35004533,40.04662521
20251029102213,116.35004950,40.04662801
20251029102214,116.35005480,40.04663003
20251029102215,116.35005263,40.04662925
20251029102216,116.35005211,40.04663095
20251029102217,116.35003881,40.04662165
20251029102218,116.35003125,40.04661683
20251029102219,116.35002405,40.04661116
20251029102220,116.35002411,40.04661143
20251029102221,116.35001391,40.04660518
20251029102222,116.35000681,40.04660123
20251029102223,116.34999664,40.04659351
20251029102224,116.34998003,40.04658426
20251029102225,116.34997903,40.04658513
20251029102226,116.34996228,40.04657636
20251029102227,116.34996181,40.04657708
20251029102228,116.34995580,40.04657173
20251029102229,116.34995105,40.04656993
20251029102230,116.34994325,40.04656478
20251029102231,116.34993835,40.04656338
20251029102232,116.34992914,40.04656075
20251029102233,116.34992899,40.04656108
20251029102234,116.34992890,40.04656119
20251029102235,116.34992846,40.04656143
20251029102236,116.34992108,40.04655693
20251029102237,116.34991800,40.04655566
20251029102238,116.34991786,40.04655578
20251029102239,116.34991451,40.04655390
20251029102240,116.34991291,40.04655268
20251029102241,116.34991300,40.04655270
20251029102242,116.34991161,40.04655159
20251029102243,116.34990638,40.04654811
20251029102244,116.34990353,40.04654550
20251029102245,116.34990248,40.04654425
20251029102246,116.34989766,40.04654118
20251029102247,116.34989315,40.04653923
20251029102248,116.34988758,40.04653801
20251029102249,116.34988618,40.04653630
20251029102250,116.34988176,40.04653363
20251029102251,116.34987906,40.04653208
20251029102252,116.34987903,40.04653156
20251029102253,116.34987878,40.04653163
20251029102254,116.34988148,40.04652993
20251029102255,116.34988053,40.04652798
20251029102256,116.34987876,40.04652618
20251029102257,116.34987813,40.04652478
20251029102258,116.34987596,40.04652458
20251029102259,116.34987616,40.04652455
20251029102300,116.34987626,40.04652416
20251029102301,116.34987538,40.04652365
20251029102302,116.34987585,40.04652295
20251029102303,116.34987628,40.04652226
20251029102304,116.34987565,40.04652213
20251029102305,116.34987585,40.04652203
20251029102306,116.34987798,40.04652098
20251029102307,116.34987871,40.04652073
20251029102309,116.34988168,40.04652049
20251029102310,116.34988418,40.04652036
20251029102311,116.34988563,40.04652058
20251029102312,116.34988700,40.04652081
20251029102313,116.34988763,40.04652093
20251029102314,116.34988741,40.04652101
20251029102315,116.34988780,40.04652075
20251029102316,116.34988745,40.04652106
20251029102317,116.34988786,40.04652110
20251029102318,116.34988844,40.04652125
20251029102319,116.34988906,40.04652151
20251029102320,116.34988920,40.04652218
20251029102321,116.34988885,40.04652283
20251029102322,116.34988433,40.04652425
20251029102323,116.34988455,40.04652426
20251029102324,116.34988483,40.04652479
20251029102325,116.34988486,40.04652550
20251029102326,116.34988330,40.04652656
20251029102327,116.34988146,40.04652763
20251029102328,116.34988093,40.04652840
20251029102329,116.34988066,40.04652873
20251029102330,116.34987931,40.04652908
20251029102331,116.34987871,40.04653011
20251029102332,116.34987840,40.04653059
20251029102333,116.34987835,40.04653063
20251029102334,116.34987796,40.04653078
20251029102335,116.34987691,40.04653143
20251029102336,116.34987630,40.04653210
20251029102337,116.34987746,40.04653218
20251029102338,116.34987796,40.04653191
20251029102339,116.34987801,40.04653205
20251029102340,116.34987951,40.04653365
20251029102341,116.34988118,40.04653431
20251029102342,116.34988226,40.04653480
20251029102343,116.34988168,40.04653628
20251029102344,116.34988401,40.04653604
20251029102345,116.34988698,40.04653603
20251029102346,116.34988893,40.04653601
20251029102347,116.34989135,40.04653618
20251029102348,116.34989291,40.04653675
20251029102349,116.34989329,40.04653893
20251029102350,116.34990266,40.04653880
20251029102351,116.34990413,40.04653898
20251029102352,116.34990646,40.04653858
20251029102353,116.34990691,40.04653896
20251029102354,116.34990856,40.04653886
20251029102355,116.34991191,40.04653856
20251029102356,116.34991179,40.04653921
20251029102357,116.34991100,40.04653961
20251029102358,116.34991500,40.04653930
20251029102359,116.34991720,40.04653923
20251029102400,116.34991981,40.04653856
20251029102401,116.34992598,40.04653769
20251029102402,116.34993143,40.04653783
20251029102403,116.34993548,40.04653775
20251029102404,116.34994129,40.04653721
20251029102405,116.34994341,40.04653816
20251029102406,116.34994115,40.04654055
20251029102407,116.34994393,40.04653984
20251029102408,116.34994368,40.04654021
20251029102409,116.34994796,40.04653919
20251029102410,116.34995473,40.04653736
20251029102411,116.34995525,40.04653706
20251029102412,116.34996036,40.04653575
20251029102413,116.34996440,40.04653438
20251029102414,116.34997296,40.04653214
20251029102415,116.34998170,40.04653015
20251029102416,116.34998220,40.04652976
20251029102417,116.34998338,40.04652973
20251029102418,116.34999601,40.04652683
20251029102420,116.35000903,40.04652186
20251029102421,116.35001790,40.04651898
20251029102422,116.35002476,40.04651638
20251029102423,116.35003354,40.04651326
20251029102424,116.35004643,40.04650915
20251029102425,116.35005090,40.04650715
20251029102426,116.35005951,40.04650515
20251029102427,116.35006668,40.04650318
20251029102428,116.35007473,40.04649975
20251029102429,116.35007473,40.04649860
20251029102430,116.35007673,40.04649775
20251029102431,116.35008289,40.04649400
20251029102432,116.35008416,40.04649288
20251029102433,116.35008390,40.04649286
20251029102434,116.35008434,40.04649169
20251029102435,116.35008590,40.04649088
20251029102436,116.35009100,40.04648923
20251029102437,116.35009711,40.04648316
20251029102438,116.35009843,40.04648060
20251029102439,116.35009935,40.04648015
20251029102440,116.35010246,40.04647883
20251029102441,116.35010423,40.04647756
20251029102442,116.35010701,40.04647616
20251029102443,116.35010860,40.04647526
20251029102444,116.35011071,40.04647361
20251029102445,116.35011413,40.04647151
20251029102446,116.35011598,40.04647025
20251029102447,116.35011785,40.04646915
20251029102448,116.35011738,40.04646815
20251029102450,116.35011956,40.04646541
20251029102451,116.35011921,40.04646218
20251029102452,116.35011931,40.04646065
20251029102453,116.35011911,40.04646020
20251029102454,116.35011916,40.04646018
20251029102455,116.35012206,40.04645716
20251029102456,116.35012215,40.04645713
20251029102457,116.35012386,40.04645601
20251029102458,116.35012513,40.04645458
20251029102459,116.35012525,40.04645455
20251029102500,116.35012610,40.04645220
20251029102501,116.35012658,40.04645081
20251029102502,116.35012703,40.04645006
20251029102503,116.35012965,40.04644819
20251029102504,116.35013093,40.04644800
20251029102505,116.35013221,40.04644685
20251029102506,116.35013341,40.04644568
20251029102507,116.35013403,40.04644415
20251029102508,116.35013620,40.04644230
20251029102509,116.35013786,40.04643971
20251029102510,116.35013825,40.04643918
20251029102511,116.35014021,40.04643715
20251029102512,116.35014060,40.04643685
20251029102513,116.35014063,40.04643683
20251029102514,116.35014068,40.04643681
20251029102515,116.35014255,40.04643555
20251029102516,116.35014263,40.04643551
20251029102517,116.35014238,40.04643523
20251029102518,116.35014225,40.04643420
20251029102519,116.35013790,40.04643250
20251029102520,116.35013779,40.04643226
20251029102521,116.35013716,40.04643170</textarea>
            <div class="button-group">
                <button id="drawTrackButton" disabled style="flex: 1;">绘制轨迹</button>
                <button id="showTrackPointsButton" disabled style="flex: 1;" class="btn-warning">打点</button>
                <button id="clearTrackButton" disabled style="flex: 1;">清空轨迹</button>
            </div>
            <!-- 回放控制 -->
            <div class="split-section" style="margin-top:8px;">
                <div class="title">轨迹回放</div>
                <div class="playback-actions" style="display:flex;gap:8px;margin-bottom:8px;">
                    <button id="playbackStartBtn" disabled>开始</button>
                    <button id="playbackPauseBtn" disabled>继续</button>
                    <button id="playbackStopBtn" disabled>结束</button>
                </div>
                <div class="playback-speed" style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                    <label>速度：
                        <select id="playbackSpeedSelect" disabled>
                            <option value="1" selected>1×</option>
                            <option value="2">2×</option>
                            <option value="4">4×</option>
                            <option value="8">8×</option>
                            <option value="16">16×</option>
                            <option value="32">32×</option>
                            <option value="64">64×</option>
                            <option value="128">128×</option>
                            <option value="256">256×</option>
                            <option value="512">512×</option>
                            <option value="1024">1024×</option>
                        </select>
                    </label>
                    <span id="playbackTimeLabel" style="font-size:12px;color:#666;">时间：—</span>
                </div>
                <div class="playback-time" style="display:flex;flex-direction:column;gap:4px;margin-bottom:8px;">
                    <label class="playback-time-label" style="display:flex;align-items:center;gap:8px;flex:1 1 auto;min-width:0;">
                        <span class="playback-time-text" style="white-space:nowrap;">起始时间：</span>
                        <input type="range" id="playbackTimeSlider" disabled min="0" max="0" step="1000" value="0" style="flex:1 1 auto;min-width:0;max-width:100%;vertical-align:middle;">
                    </label>
                    <span id="playbackTimeCursor" style="font-size:12px;color:#666;align-self:flex-end;">—</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let map;
    let currentPolygons = []; // 存储多边形和其标签
    let currentTracks = []; // 存储轨迹折线及相关覆盖物
    let mapLoaded = false;
    let mapLabelHandlers = []; // 存储地图事件处理器
    let labelsEnabled = false; // 标签显示开关（默认关闭）
    let isDrawing = false; // 绘制进行中防止重复点击

    window.onload = function () {
        if (typeof T === 'undefined') {
            alert("天地图API加载失败，请检查网络或密钥！");
            return;
        }
        initMap();
        bindDrawEvent();
        bindMinimizeEvent();
        bindTabs();
        bindBatchGenerator();
        bindMultiSplitter();
        bindLabelsToggle(); // 绑定标签显示开关
        bindTrackEvents();  // 绑定轨迹绘制与清空
        bindPlaybackControls(); // 绑定轨迹回放
    };

    function initMap() {
        showLoading();
        disableButtons(true);

        try {
            map = new T.Map("mapContainer", {
                zoom: 12,
                center: new T.LngLat(116.40769, 39.90403)
            });

            // 已移除测试标签
            map.enableScrollWheelZoom();

            // 添加地图类型控件
            const mapTypeCtrl = new T.Control.MapType({
                mapTypes: [TMAP_NORMAL_MAP, TMAP_SATELLITE_MAP, TMAP_TERRAIN_MAP],
                position: T_ANCHOR_TOP_LEFT
            });
            map.addControl(mapTypeCtrl);

            // 加载影像底图（卫星）
            const tk = "648f621977051d0199ff0f965d3fd322";

            // 方案1：使用默认地图类型（作为备选）
            map.setMapType(TMAP_SATELLITE_MAP);

            // 方案2：手动添加影像图层（底图 + 标注）
            const vecLayer = new T.TileLayer(`https://t0.tianditu.gov.cn/img_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=img&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`);
            const cvaLayer = new T.TileLayer(`https://t0.tianditu.gov.cn/cia_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cia&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`);

            // 添加图层并监听加载状态
            vecLayer.addEventListener("load", function () {
                console.log("影像底图加载完成");
            });

            vecLayer.addEventListener("error", function (e) {
                console.error("影像底图加载错误:", e);
                alert("影像底图加载错误，将使用默认地图类型");
            });

            map.addLayer(vecLayer);
            map.addLayer(cvaLayer);

            // 监听地图加载事件
            map.addEventListener("loaded", function () {
                console.log("地图加载完成");
                markMapLoaded();
            });
            map.addEventListener("load", function () {
                console.log("地图load事件触发");
                markMapLoaded();
            });
            map.addEventListener("tilesloaded", function () {
                console.log("地图瓦片加载完成");
                markMapLoaded();
            });
            // 监听地图加载失败事件
            map.addEventListener("error", function (e) {
                console.error("地图加载错误:", e);
                alert("地图加载错误: " + e.message);
                hideLoading();
            });

            // 监听地图移动事件，用于更新标签位置
            const moveHandler = function () {
                updateAllLabelsPosition();
            };
            map.addEventListener("move", moveHandler);
            map.addEventListener("zoom", moveHandler);

            // 存储事件处理器，用于清理
            mapLabelHandlers.push({ event: "move", handler: moveHandler });
            mapLabelHandlers.push({ event: "zoom", handler: moveHandler });

            // 超时容错
            setTimeout(() => {
                if (!mapLoaded) markMapLoaded();
            }, 8000);

        } catch (error) {
            alert("地图初始化失败：" + error.message);
            console.error(error);
            hideLoading();
        }
    }

    function markMapLoaded() {
        if (!mapLoaded) {
            mapLoaded = true;
            hideLoading();
            disableButtons(false);
            disableTrackButtons(false);
            // 仅开启速度选择，回放按钮按状态控制
            const speedSel = document.getElementById('playbackSpeedSelect');
            if (speedSel) speedSel.disabled = false;
            updatePlaybackButtonsState('idle');
        }
    }

    function showLoading() {
        const loading = document.getElementById("mapLoading");
        loading.style.display = "flex";
        loading.style.opacity = "1";
    }

    function hideLoading() {
        const loading = document.getElementById("mapLoading");
        loading.style.opacity = "0";
        setTimeout(() => loading.style.display = "none", 300);
    }

    function disableButtons(disabled) {
        document.getElementById("drawButton").disabled = disabled;
        document.getElementById("clearButton").disabled = disabled;
    }

    function disableTrackButtons(disabled) {
        const drawTrackBtn = document.getElementById("drawTrackButton");
        const showTrackPointsBtn = document.getElementById("showTrackPointsButton");
        const clearTrackBtn = document.getElementById("clearTrackButton");
        if (drawTrackBtn) drawTrackBtn.disabled = disabled;
        if (showTrackPointsBtn) showTrackPointsBtn.disabled = disabled;
        if (clearTrackBtn) clearTrackBtn.disabled = disabled;
    }
    // 回放控件的禁用/启用
    function disablePlaybackButtons(disabled) {
        ["playbackStartBtn","playbackPauseBtn","playbackStopBtn","playbackSpeedSelect","playbackTimeSlider"].forEach(id=>{
            const el = document.getElementById(id);
            if (el) el.disabled = disabled;
        });
    }

    // 回放按钮状态管理：空闲/播放/暂停
    function updatePlaybackButtonsState(state){
        try {
            const startBtn = document.getElementById('playbackStartBtn');
            const pauseBtn = document.getElementById('playbackPauseBtn');
            const stopBtn = document.getElementById('playbackStopBtn');
            if (!startBtn || !pauseBtn || !stopBtn) return;
            if (state === 'idle') {
                startBtn.disabled = false;
                pauseBtn.disabled = true;
                stopBtn.disabled = true;
                pauseBtn.textContent = '继续';
            } else if (state === 'playing') {
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
                pauseBtn.textContent = '暂停';
            } else if (state === 'paused') {
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
                pauseBtn.textContent = '继续';
            }
        } catch(e) { console.warn('更新按钮状态失败:', e); }
    }

    function bindDrawEvent() {
        document.getElementById("drawButton").addEventListener("click", function () {
            if (isDrawing) { console.log('绘制进行中，忽略重复点击'); return; }
            isDrawing = true;
            disableButtons(true);
            showLoading();
            try {
                const wktStr = document.getElementById("wktTextarea").value.trim();
                if (!wktStr) { alert("请输入WKT字符串！"); return; }
                clearOverlays();
                const geojson = parseWkt(wktStr);
    
                const polygonData = [];
                if (geojson.type === "Polygon") {
                    polygonData.push({ index: 1, coordinates: geojson.coordinates });
                } else if (geojson.type === "MultiPolygon") {
                    geojson.coordinates.forEach((polygon, index) => {
                        polygonData.push({ index: index + 1, coordinates: polygon });
                    });
                }
    
                // 重置并绘制
                polygonInfoList = [];
                polygonData.forEach(pd => processPolygon(pd.index, pd.coordinates));
    
                // 视图居中到所有已绘制轮廓
                try { fitViewportToPolygons(); } catch (e) { console.warn('视图居中失败', e); }
    
                // 在视图稳定后再创建/更新标签
                setTimeout(() => {
                    if (labelsEnabled) {
                        try {
                            createAllLabels();
                            updateAllLabelsPosition();
                        } catch (e) {
                            console.warn('创建或更新标签失败:', e);
                        }
                    }
                }, 150);
            } catch (e) {
                alert('绘制失败：' + (e && e.message ? e.message : e));
                console.error('绘制异常:', e);
            } finally {
                hideLoading();
                isDrawing = false;
                disableButtons(false);
            }
        });

        document.getElementById("clearButton").addEventListener("click", function () {
            if (isDrawing) { console.log('绘制进行中，暂不清空'); return; }
            clearOverlays();
            console.log("已清空所有轮廓");
        });
    }

    // 存储多边形数据，用于后续标签创建
    let polygonInfoList = [];

    // 处理单个多边形的绘制和面积计算
    function processPolygon(actualPolygonIndex, polygonCoords) {
        console.log('开始处理多边形', actualPolygonIndex);

        // 坐标系选择（绘制始终使用WGS84坐标）
        const coordSys = (document.getElementById('coordSysSelect') && document.getElementById('coordSysSelect').value) || 'wgs84';

        // 统一转换为WGS84用于绘制与面积计算
        function toWgs(point){
            const lng = point[0], lat = point[1];
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                return [lng, lat];
            } else if (coordSys === 'gcj02') {
                const w = gcj02ToWgs84(lng, lat);
                return [w.lng, w.lat];
            } else if (coordSys === 'bd09') {
                const gcj = bd09ToGcj02(lng, lat);
                const w = gcj02ToWgs84(gcj.lng, gcj.lat);
                return [w.lng, w.lat];
            }
            return [lng, lat];
        }
        const coordsWGS84 = polygonCoords.map(ring => ring.map(toWgs));
        let outerRingWGS = coordsWGS84[0] || [];

        // 生成用于绘制的坐标（直接使用WGS84坐标）
        const rings = coordsWGS84.map(ring => ring.map(([lng, lat]) => new T.LngLat(lng, lat)));


         // 创建半透明填充的多边形（无边框）
          const polygon = new T.Polygon(rings, {
              color: "#FFD700",
              weight: 1,
              opacity: 1,
              fillColor: "#FFFF00",
              fillOpacity: 0.35
          });
 
          // 使用WGS84坐标计算面积（更准确的面积计算）
         let areaSqm;
         let areaMu;



         try {
             // 检查Turf.js是否可用
             if (typeof turf !== 'undefined' && turf.area) {
                 // 使用Turf.js计算多边形面积
                // 构造GeoJSON格式的多边形
                const geoJsonPolygon = {
                    type: "Polygon",
                    coordinates: coordsWGS84
                };


                 // 使用Turf.js计算面积（平方米）
                 areaSqm = turf.area(geoJsonPolygon);
                 areaMu = (areaSqm / 666.6667).toFixed(4); // 转换为亩
                 console.log(`多边形${actualPolygonIndex}面积计算结果(Turf.js): ${areaSqm}平方米 = ${areaMu}亩`);
             } else {
                 // 如果Turf.js不可用，回退到之前的计算方法
                 console.warn('Turf.js不可用，使用备用计算方法');
                 // 计算带孔洞的多边形面积
                 areaSqm = 0;
                 // 计算外环面积
                 outerRingWGS = coordsWGS84[0] || [];
                 areaSqm += calculatePolygonArea(outerRingWGS);

                 // 减去内环（孔洞）面积
                 for (let i = 1; i < coordsWGS84.length; i++) {
                     const innerRingArea = calculatePolygonArea(coordsWGS84[i]);
                     areaSqm -= innerRingArea;
                 }

                  areaMu = (areaSqm / 666.6667).toFixed(4); // 使用更精确的转换系数
                  console.log(`多边形${actualPolygonIndex}面积计算结果(备用): ${areaSqm}平方米 = ${areaMu}亩`);
              }
          } catch (error) {
              console.error(`面积计算失败:`, error);
              areaSqm = 0;
              areaMu = '0.0000';
          }

          // 计算多边形的中心点和底部中心点（WGS84）
          const centerPoint = calculatePolygonCenter(outerRingWGS);
          const bottomCenterPoint = calculatePolygonBottomCenter(outerRingWGS);

          // 添加多边形到地图
          if (map) {
              map.addOverLay(polygon);
              console.log(`多边形${actualPolygonIndex}已添加到地图`);
          } else {
              console.error('地图对象不存在');
          }

          // 存储多边形信息，用于后续标签创建
          polygonInfoList.push({
              index: actualPolygonIndex,
              polygon: polygon,
              area: areaMu,
              bottomCenter: { lng: bottomCenterPoint.lng, lat: bottomCenterPoint.lat },
              ringPoints: rings
          });
      }

    // 视图居中：根据已绘制的GCJ-02点
    function fitViewportToPolygons() {
        const points = [];
        try {
            if (!map || !map.setViewport) return;
            polygonInfoList.forEach(info => {
                if (!info || !info.ringPoints) return;
                info.ringPoints.forEach(ring => {
                    ring.forEach(ll => points.push(ll));
                });
            });
            if (!points.length) return;
            map.setViewport(points);
        } catch (e) {
            try {
                const lngs = points.map(p => p.lng);
                const lats = points.map(p => p.lat);
                const center = new T.LngLat(
                    (Math.min(...lngs) + Math.max(...lngs)) / 2,
                    (Math.min(...lats) + Math.max(...lats)) / 2
                );
                if (map && map.panTo) map.panTo(center);
            } catch (e2) {
                console.warn('视图居中失败:', e2);
            }
        }
    }

    // 统一创建所有多边形的标签
    function createAllLabels() {
        const mapContainer = document.getElementById('mapContainer');
        if (!mapContainer || !map) return;

        polygonInfoList.forEach(info => {
            if (!info) return;
            // 防止重复创建
            if (info.labelRef) return;
            // 创建标签元素
            const labelDiv = document.createElement('div');
            labelDiv.className = 'area-label';
            labelDiv.innerHTML = `多边形${info.index}：${info.area}亩`;

            // 添加到地图容器并根据屏幕边界定位到轮廓下方
            mapContainer.appendChild(labelDiv);
            positionLabelForPolygon(labelDiv, info);

            // 记录引用，避免重复创建
            info.labelRef = labelDiv;

            // 存储到 currentPolygons 以复用现有定位/清理逻辑
            const labelObj = {
                domElement: labelDiv,
                isDomLabel: true,
                polygonInfo: info
            };
            currentPolygons.push({ polygon: info.polygon, label: labelObj });
        });

        // 不清空 polygonInfoList，便于开关随时创建/隐藏标签
    }

    // 根据多边形屏幕边界定位标签，保证始终在轮廓下方
    function positionLabelForPolygon(labelDiv, info) {
        if (!map || !info || !info.ringPoints) return;
        const points = [];
        info.ringPoints.forEach(ring => {
            ring.forEach(ll => {
                const p = map.lngLatToContainerPoint(ll);
                points.push(p);
            });
        });
        if (!points.length) return;
        const minX = Math.min(...points.map(p => p.x));
        const maxX = Math.max(...points.map(p => p.x));
        const maxY = Math.max(...points.map(p => p.y));
        const container = document.getElementById('mapContainer');
        const labelWidth = labelDiv.offsetWidth;
        const labelHeight = labelDiv.offsetHeight;
        const targetLeft = Math.round((minX + maxX) / 2 - labelWidth / 2);
        const targetTop = Math.round(maxY + 6);
        const clampedLeft = Math.max(0, Math.min(targetLeft, container.clientWidth - labelWidth));
        const clampedTop = Math.max(0, Math.min(targetTop, container.clientHeight - labelHeight));
        labelDiv.style.left = clampedLeft + 'px';
        labelDiv.style.top = clampedTop + 'px';
    }

    // 更新所有标签位置（地图move/zoom时调用）
    function updateAllLabelsPosition() {
        try {
            if (!map) return;
            const container = document.getElementById('mapContainer');
            if (!container) return;
            currentPolygons.forEach(item => {
                if (!item || !item.label) return;
                const labelObj = item.label;
                if (labelObj.isDomLabel && labelObj.domElement && labelObj.polygonInfo) {
                    // 确保标签在容器中
                    if (!labelObj.domElement.parentNode) {
                        container.appendChild(labelObj.domElement);
                    }
                    positionLabelForPolygon(labelObj.domElement, labelObj.polygonInfo);
                }
            });
        } catch (e) {
            console.warn('更新标签位置时出错:', e);
        }
    }
    // 确保在全局可用（处理第三方库事件回调作用域差异）
    window.updateAllLabelsPosition = updateAllLabelsPosition;

    // 绑定“显示亩数标签”开关（默认隐藏）
    function bindLabelsToggle() {
        const cb = document.getElementById('toggleLabelsCheckbox');
        const container = document.getElementById('mapContainer');
        if (!cb || !container) return;
        // 默认隐藏标签
        container.classList.add('labels-hidden');
        cb.addEventListener('change', () => {
            labelsEnabled = cb.checked;
            if (labelsEnabled) {
                container.classList.remove('labels-hidden');
                const hasAnyLabel = currentPolygons.some(item => item && item.label && item.label.domElement);
                if (!hasAnyLabel) {
                    try { createAllLabels(); } catch (e) { console.warn('创建标签失败:', e); }
                }
                updateAllLabelsPosition();
            } else {
                container.classList.add('labels-hidden');
            }
        });
    }

    /**
     * 计算多边形中心点（比底部中心更适合显示标签）
     */
    function calculatePolygonCenter(outerRing) {
        let sumLng = 0, sumLat = 0;
        const len = outerRing.length;

        for (let i = 0; i < len; i++) {
            sumLng += outerRing[i][0];
            sumLat += outerRing[i][1];
        }

        return {
            lng: sumLng / len,
            lat: sumLat / len
        };
    }

    /**
     * 计算多边形面积（球面多边形面积计算）
     * 使用更准确的球面坐标面积计算方法，确保面积与视觉大小一致
     */
    function calculatePolygonArea(coordinates) {
        // 地球半径（米）- 使用更精确的值
        const R = 6371000.8;
        const n = coordinates.length;

        // 将所有坐标转换为弧度
        const coordsRad = coordinates.map(point => [
            point[0] * Math.PI / 180,
            point[1] * Math.PI / 180
        ]);

        let areaRad = 0;

        // 使用更准确的球面多边形面积公式（Girard定理）
        for (let i = 0; i < n; i++) {
            const j = (i + 1) % n;
            const lon1 = coordsRad[i][0];
            const lat1 = coordsRad[i][1];
            const lon2 = coordsRad[j][0];
            const lat2 = coordsRad[j][1];

            // 计算球面多边形面积增量
            const dlon = lon2 - lon1;
            const sinLat1 = Math.sin(lat1);
            const sinLat2 = Math.sin(lat2);
            const cosLat1 = Math.cos(lat1);
            const cosLat2 = Math.cos(lat2);

            // 使用更精确的公式
            areaRad += dlon * (sinLat1 * cosLat2 * Math.cos(dlon / 2) + sinLat2 * cosLat1);
        }

        // 计算总面积（平方米）
        const areaSqm = Math.abs(areaRad) * R * R * 0.5;

        return areaSqm;
    }

    /**
     * 清空所有多边形和标签（同时处理 polygonInfoList 与 currentPolygons）
     */
    function clearOverlays() {
        try {
            // 先移除 polygonInfoList 中记录的多边形与其DOM标签
            polygonInfoList.forEach(info => {
                if (info && info.polygon && map && map.removeOverLay) {
                    try { map.removeOverLay(info.polygon); } catch (e) { console.warn('移除多边形失败:', e); }
                }
                if (info && info.labelRef && info.labelRef.parentNode) {
                    try { info.labelRef.parentNode.removeChild(info.labelRef); } catch (e) { console.warn('移除DOM标签失败:', e); }
                    info.labelRef = null;
                }
            });

            // 再处理 currentPolygons（兼容旧路径与标签对象）
            currentPolygons.forEach(item => {
                if (item.polygon && map && map.removeOverLay) {
                    try { map.removeOverLay(item.polygon); } catch (e) { console.warn('移除多边形失败:', e); }
                }
                if (item.label) {
                    if (item.label.domElement && item.label.domElement.parentNode) {
                        try { item.label.domElement.parentNode.removeChild(item.label.domElement); } catch (e) { console.warn('移除DOM标签失败:', e); }
                    } else if (map && map.removeOverLay && !item.label.isDomLabel) {
                        try { map.removeOverLay(item.label); } catch (e) { console.warn('移除地图覆盖物标签失败:', e); }
                    }
                }
            });

            // 清空记录数组
            currentPolygons = [];
            polygonInfoList = [];

            console.log('已清空所有多边形和标签（保留事件监听器）');
        } catch (error) {
            console.error('清空覆盖物时出错:', error);
        }
    }

    // 其他辅助函数（保持不变）
    function bindMinimizeEvent() {
        const container = document.querySelector(".wkt-input-container");
        const btn = document.getElementById("minimizeBtn");
        const minIcon = btn?.querySelector(".min-icon");
        const restoreIcon = btn?.querySelector(".restore-icon");

        btn?.addEventListener("click", () => {
            const minimized = container.classList.toggle("minimized");
            if (minIcon && restoreIcon) {
                if (minimized) {
                    minIcon.style.display = "none";
                    restoreIcon.style.display = "";
                } else {
                    minIcon.style.display = "";
                    restoreIcon.style.display = "none";
                }
            }
        });
    }

    // 在脚本内部补充：页签切换（3个页签）
     function bindTabs() {
         const tabs = [
             { btn: document.getElementById('tabDrawBtn'), pane: document.getElementById('tabDraw'), key: 'draw' },
             { btn: document.getElementById('tabTrackBtn'), pane: document.getElementById('tabTrack'), key: 'track' },
             { btn: document.getElementById('tabSplitBtn'), pane: document.getElementById('tabSplit'), key: 'split' },
             { btn: document.getElementById('tabBatchBtn'), pane: document.getElementById('tabBatch'), key: 'batch' },
         ];
         if (tabs.some(t => !t.btn || !t.pane)) return;
         function activate(key) {
             tabs.forEach(t => {
                 const active = t.key === key;
                 t.btn.classList.toggle('active', active);
                 t.pane.classList.toggle('active', active);
             });
         }
         tabs.forEach(t => t.btn.addEventListener('click', () => activate(t.key)));
         activate('draw');
     }
    function updateParserStatus() {
        const el = document.getElementById('parserStatus');
        if (!el) return;
        const ok = (typeof Terraformer !== 'undefined' && Terraformer.WKT && typeof Terraformer.WKT.parse === 'function');
        if (ok) {
            el.textContent = 'Terraformer WKT Parser';
            el.style.color = '#2f8f2f';
        } else {
            el.textContent = '本地回退解析（仅支持POLYGON/MULTIPOLYGON）';
            el.style.color = '#c77d1e';
        }
    }
     function parseWkt(wkt) {
         wkt = wkt.trim();
         // 优先使用成熟库（Terraformer WKT Parser）
         if (typeof Terraformer !== 'undefined' && Terraformer.WKT && Terraformer.WKT.parse) {
             try {
                 return Terraformer.WKT.parse(wkt);
             } catch (e) {
                 console.warn('Terraformer解析失败，尝试本地回退解析:', e);
             }
         } else {
             // 不再提示“未加载”，由状态栏展示回退信息
         }
         // 回退解析：仅支持 POLYGON / MULTIPOLYGON
         const typeMatch = wkt.match(/^\s*(POLYGON|MULTIPOLYGON)\s*\(/i);
         if (!typeMatch) throw new Error('仅支持POLYGON/MULTIPOLYGON');
         const type = typeMatch[1].toUpperCase();
         const inner = wkt.substring(wkt.indexOf('('));
         if (type === 'POLYGON') {
             const coords = parsePolygonCoords(inner.replace(/^\(/, '').replace(/\)$/, ''));
             return { type: 'Polygon', coordinates: coords };
         } else {
             const trimmed = inner.replace(/^\(\(/, '').replace(/\)\)$/, '');
             const coords = parseMultiPolygonCoords(trimmed);
             return { type: 'MultiPolygon', coordinates: coords };
         }
     }

     function bindMultiSplitter() {
         const input = document.getElementById('multiInput');
         const output = document.getElementById('polyOutput');
         const splitBtn = document.getElementById('splitMultiBtn');
         const copyBtn = document.getElementById('copyPolysBtn');
         if (!input || !output || !splitBtn || !copyBtn) return;

         // 本地WKT序列化辅助
         function ringToText(ring) {
             if (!ring || !ring.length) return '()';
             const first = ring[0];
             const last = ring[ring.length - 1];
             const closed = (first[0] === last[0] && first[1] === last[1]) ? ring : ring.concat([[first[0], first[1]]]);
             return '(' + closed.map(pt => pt[0] + ' ' + pt[1]).join(', ') + ')';
         }
         function toWktPolygonCoords(coords) {
             return 'POLYGON(' + coords.map(ringToText).join(', ') + ')';
         }
         function toWktMulti(coords) {
             return 'MULTIPOLYGON(' + coords.map(poly => '(' + poly.map(ringToText).join(', ') + ')').join(', ') + ')';
         }

         function polygonsFromMulti(text) {
             const geo = parseWkt(text.trim());
             if (geo.type !== 'MultiPolygon') throw new Error('请输入有效的 MULTIPOLYGON WKT');
             const polys = geo.coordinates.map(rings => toWktPolygonCoords(rings));
             return polys;
         }
         splitBtn.addEventListener('click', () => {
             try {
                 const list = polygonsFromMulti(input.value.trim());
                 output.value = list.join('\n');
             } catch (e) {
                 alert('分割失败：' + e.message);
             }
         });
         copyBtn.addEventListener('click', async () => {
             const val = output.value.trim();
             if (!val) { alert('没有可复制的结果'); return; }
             try { await navigator.clipboard.writeText(val); alert('已复制到剪贴板'); } catch (e) { console.warn('复制失败', e); }
         });
     }

     function bindBatchGenerator() {
         const batchInput = document.getElementById('batchInput');
         const output = document.getElementById('multiOutput');
         const genBtn = document.getElementById('generateMultiBtn');
         const copyBtn = document.getElementById('copyMultiBtn');

         // 本地WKT序列化辅助（与分割器保持一致）
         function ringToText(ring) {
             if (!ring || !ring.length) return '()';
             const first = ring[0];
             const last = ring[ring.length - 1];
             const closed = (first[0] === last[0] && first[1] === last[1]) ? ring : ring.concat([[first[0], first[1]]]);
             return '(' + closed.map(pt => pt[0] + ' ' + pt[1]).join(', ') + ')';
         }
         function toWktMulti(coords) {
             return 'MULTIPOLYGON(' + coords.map(poly => '(' + poly.map(ringToText).join(', ') + ')').join(', ') + ')';
         }

         genBtn.addEventListener('click', () => {
             try {
                 const lines = batchInput.value.trim().split(/\n|;/).map(s => s.trim()).filter(Boolean);
                 if (lines.length === 0) throw new Error('请按每行或分号输入至少一个POLYGON');
                 const polygons = lines.map((line, idx) => {
                     const g = parseWkt(line);
                     if (g.type !== 'Polygon') throw new Error(`第${idx + 1}行不是有效的POLYGON WKT`);
                     return g;
                 });
                 const multiGeo = { type: 'MultiPolygon', coordinates: polygons.map(p => p.coordinates) };
                 output.value = toWktMulti(multiGeo.coordinates);
             } catch (e) {
                 alert('生成失败：' + e.message);
             }
         });

         copyBtn.addEventListener('click', async () => {
             const val = output.value.trim();
             if (!val) { alert('没有可复制的结果'); return; }
             try { await navigator.clipboard.writeText(val); alert('已复制到剪贴板'); } catch (e) { console.warn('复制失败', e); }
         });

     }

     function setExampleWkt() {
         const exampleWkt = "MULTIPOLYGON(" +
             "(" +
             "(116.35 39.93, 116.39 39.93, 116.39 39.90, 116.35 39.90, 116.35 39.93)," + // 外环
             "(116.36 39.92, 116.38 39.92, 116.38 39.91, 116.36 39.91, 116.36 39.92)" +  // 内环
             ")," +
             "(" +
             "(116.40 39.95, 116.43 39.97, 116.46 39.96, 116.49 39.98, 116.52 39.95, 116.55 39.93, 116.58 39.94, 116.61 39.92, 116.64 39.95, 116.40 39.95)" +
             ")" +
             ")";
         document.getElementById("wktTextarea").value = exampleWkt;
     }

     function parsePolygonCoords(coordStr) {
         const ringStrs = coordStr.split(/\)\s*,\s*\(/).map(s => s.replace(/[()]/g, '').trim());
         const rings = [];
         ringStrs.forEach(ringStr => {
             const pts = ringStr.split(/,\s*/).map(pointStr => {
                 const [lng, lat] = pointStr.split(/\s+/).map(Number);
                 if (isNaN(lng) || isNaN(lat)) throw new Error("坐标格式错误：" + pointStr);
                 return [lng, lat];
             });
             // 自动拆分：如果一个ring中包含多次回到起点（闭合），则拆分为多个环
             // 兼容用户将外环与内环错误地写在同一对括号中的情况
             let start = 0;
             while (start < pts.length) {
                 const startPt = pts[start];
                 let closeIdx = -1;
                 for (let i = start + 1; i < pts.length; i++) {
                     if (pts[i][0] === startPt[0] && pts[i][1] === startPt[1]) {
                         closeIdx = i;
                         break;
                     }
                 }
                 if (closeIdx === -1) {
                     // 未找到闭合：将剩余点视为一个环，并强制闭合
                     const ring = pts.slice(start);
                     if (ring.length && (ring[0][0] !== ring[ring.length - 1][0] || ring[0][1] !== ring[ring.length - 1][1])) {
                         ring.push([ring[0][0], ring[0][1]]);
                     }
                     rings.push(ring);
                     break;
                 } else {
                     const ring = pts.slice(start, closeIdx + 1);
                     rings.push(ring);
                     start = closeIdx + 1;
                 }
             }
         });
         return rings;
     }

     function parseMultiPolygonCoords(coordStr) {
         const polygonStrs = coordStr.split(/\)\s*\)\s*,\s*\(\s*\(/).map(s => s.replace(/[()]/g, '').trim());
         return polygonStrs.map(polygonStr => parsePolygonCoords(polygonStr));
     }

     function wgs84ToGcj02(lng, lat) {
         const x_PI = 3.14159265358979324 * 3000.0 / 180.0;
         const PI = 3.1415926535897932384626;
         const a = 6378245.0;
         const ee = 0.00669342162296594323;

         if (outOfChina(lng, lat)) return { lng, lat };

         let dlat = transformLat(lng - 105.0, lat - 35.0);
         let dlng = transformLng(lng - 105.0, lat - 35.0);
         const radlat = lat / 180.0 * PI;
         let magic = Math.sin(radlat);
         magic = 1 - ee * magic * magic;
         const sqrtmagic = Math.sqrt(magic);
         dlat = (dlat * 180.0) / ((a * (1 - ee)) / (magic * sqrtmagic) * PI);
         dlng = (dlng * 180.0) / (a / sqrtmagic * Math.cos(radlat) * PI);

         return { lng: lng + dlng, lat: lat + dlat };

         function outOfChina(lng, lat) {
             return (lng < 72.004 || lng > 137.8347) || (lat < 0.8293 || lat > 55.8271);
         }

         function transformLat(x, y) {
             let ret = -100.0 + 2.0 * x + 3.0 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * Math.sqrt(Math.abs(x));
             ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
             ret += (20.0 * Math.sin(y * PI) + 40.0 * Math.sin(y / 3.0 * PI)) * 2.0 / 3.0;
             ret += (160.0 * Math.sin(y / 12.0 * PI) + 320 * Math.sin(y * PI / 30.0)) * 2.0 / 3.0;
             return ret;
         }

         function transformLng(x, y) {
             let ret = 300.0 + x + 2.0 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * Math.sqrt(Math.abs(x));
             ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
             ret += (20.0 * Math.sin(x * PI) + 40.0 * Math.sin(x / 3.0 * PI)) * 2.0 / 3.0;
             ret += (150.0 * Math.sin(x / 12.0 * PI) + 300.0 * Math.sin(x / 30.0 * PI)) * 2.0 / 3.0;
             return ret;
         }
     }

     function gcj02ToWgs84(lng, lat) {
         const g = wgs84ToGcj02(lng, lat);
         return { lng: lng * 2 - g.lng, lat: lat * 2 - g.lat };
     }

     function bd09ToGcj02(bdLng, bdLat) {
         const x_PI = 3.14159265358979324 * 3000.0 / 180.0;
         const x = bdLng - 0.0065;
         const y = bdLat - 0.006;
         const z = Math.sqrt(x * x + y * y) - 0.00002 * Math.sin(y * x_PI);
         const theta = Math.atan2(y, x) - 0.000003 * Math.cos(x * x_PI);
         const ggLng = z * Math.cos(theta);
         const ggLat = z * Math.sin(theta);
         return { lng: ggLng, lat: ggLat };
     }

     function calculatePolygonBottomCenter(outerRing) {
         let minLat = Infinity;
         let bottomPoints = [];
         outerRing.forEach(point => {
             const lat = point[1];
             if (lat < minLat) {
                 minLat = lat;
                 bottomPoints = [point];
             } else if (lat === minLat) {
                 bottomPoints.push(point);
             }
         });

         const sumLng = bottomPoints.reduce((sum, point) => sum + point[0], 0);
         const centerLng = sumLng / bottomPoints.length;

         return { lng: centerLng, lat: minLat };
     }

     function fitBounds(geojson) {
         try {
             const allPoints = [];
             function collectPoints(coords) {
                 if (typeof coords[0] === 'number') {
                     allPoints.push(coords);
                 } else {
                     coords.forEach(coord => collectPoints(coord));
                 }
             }
             collectPoints(geojson.coordinates);

             if (allPoints.length === 0) return;

             const lats = allPoints.map(p => p[1]);
             const lngs = allPoints.map(p => p[0]);
             const minLng = Math.min(...lngs);
             const maxLng = Math.max(...lngs);
             const minLat = Math.min(...lats);
             const maxLat = Math.max(...lats);

             const sw = wgs84ToGcj02(minLng, minLat);
             const ne = wgs84ToGcj02(maxLng, maxLat);

             // 修复setViewport方法的使用，确保参数格式正确
             if (map && map.setViewport) {
                 map.setViewport([
                     new T.LngLat(sw.lng, sw.lat),
                     new T.LngLat(ne.lng, ne.lat)
                 ], { padding: [50, 50] });
             } else {
                 console.warn('地图对象或setViewport方法不可用');
             }
         } catch (error) {
             console.error('调整视图范围时出错:', error);
         }
     }
// 轨迹绘制与解析
    function bindTrackEvents() {
        const drawBtn = document.getElementById('drawTrackButton');
        const showPointsBtn = document.getElementById('showTrackPointsButton');
        const clearBtn = document.getElementById('clearTrackButton');
        const ta = document.getElementById('trackTextarea');
        if (!drawBtn || !showPointsBtn || !clearBtn || !ta) return;

        drawBtn.addEventListener('click', function(){
            try {
                const text = ta.value.trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const points = parseTrackText(text);
                if (points.length < 2) { alert('有效轨迹点不足，至少需要两点'); return; }
                drawTrackFromPoints(points);
                fitViewportToTrack(points);
            } catch (e) {
                alert('绘制轨迹失败：' + (e && e.message ? e.message : e));
                console.error('绘制轨迹异常:', e);
            }
        });

        showPointsBtn.addEventListener('click', function(){
            try {
                const text = ta.value.trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const points = parseTrackText(text);
                if (points.length === 0) { alert('未找到有效轨迹点'); return; }
                showTrackPoints(points);
                fitViewportToTrack(points);
            } catch (e) {
                alert('显示轨迹点失败：' + (e && e.message ? e.message : e));
                console.error('显示轨迹点异常:', e);
            }
        });

        clearBtn.addEventListener('click', function(){
            clearTrackOverlays();
            console.log('已清空轨迹');
        });
    }

    function showTrackPoints(points) {
        // 先移除旧轨迹（不影响轮廓）
        clearTrackOverlays(false);
        
        if (!map || !points || points.length === 0) {
            console.log('无轨迹点可显示');
            return;
        }
        
        console.log(`准备显示${points.length}个轨迹点`);
        
        // 使用批量处理和更小的图标来提高性能
        // 创建一个更小的红点SVG图标
        const smallRedDotIcon = new T.Icon({
            iconUrl: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1" height="1"><circle cx="0.5" cy="0.5" r="0.3" fill="%23FF0000"/></svg>',
            iconSize: new T.Point(1, 1),
            iconAnchor: new T.Point(0.5, 0.5)
        });
        
        // 优化批量添加点的速度
        const batchSize = 2000; // 增加每批处理的点数
        const concurrentBatches = 4; // 并发批次数量
        
        // 预创建点击事件处理函数，避免重复创建
        function createClickHandler(point, index) {
            return function() {
                const infoWindow = new T.InfoWindow({
                    content: `点${index + 1}<br/>经度: ${point.lng.toFixed(6)}<br/>纬度: ${point.lat.toFixed(6)}`,
                    offset: new T.Point(0, -20)
                });
                infoWindow.open(map, point);
            };
        }
        
        // 使用setTimeout实现更高效的批量添加，避免阻塞UI
        let currentIndex = 0;
        
        function addBatch() {
            if (currentIndex >= points.length) {
                console.log(`已显示${points.length}个轨迹点`);
                return;
            }
            
            // 添加当前批次的点
            const endIndex = Math.min(currentIndex + batchSize, points.length);
            const markersToAdd = [];
            
            // 先创建所有标记
            for (let i = currentIndex; i < endIndex; i++) {
                const point = points[i];
                const index = i;
                
                const marker = new T.Marker(point, {
                    icon: smallRedDotIcon
                });
                
                // 添加点击事件
                marker.addEventListener('click', createClickHandler(point, index));
                
                markersToAdd.push(marker);
            }
            
            // 批量添加到地图和数组
            markersToAdd.forEach(marker => {
                map.addOverLay(marker);
                currentTracks.push(marker);
            });
            
            currentIndex = endIndex;
            
            // 使用setTimeout而不是requestAnimationFrame，减少对渲染周期的依赖
            // 设置为0，将任务放入微任务队列，但允许UI有短暂的呼吸空间
            setTimeout(addBatch, 0);
        }
        
        // 启动批量添加
        addBatch();
    }
    
    // 恢复原始的clearTrackOverlays函数
    function clearTrackOverlays(resetArray = true){        
        try {
            currentTracks.forEach(pl => {
                if (pl && map && map.removeOverLay) {
                    try { map.removeOverLay(pl); } catch (e) { console.warn('移除轨迹失败:', e); }
                }
            });
            if (resetArray) currentTracks = [];
        } catch (e) {
            console.warn('清空轨迹时出错:', e);
        }
    }

    function parseTrackText(text){
        // 选择输入坐标系（优先使用轨迹页签专属选择器，若未设置则回退到绘制页签选择器）
        const coordSysEl = document.getElementById('trackCoordSysSelect') || document.getElementById('coordSysSelect');
        const coordSys = (coordSysEl && coordSysEl.value) || 'wgs84';
        const isHash = text.indexOf('#') !== -1;
        const items = isHash ? text.split('#') : text.split(/\r?\n/);
        const pts = [];
        for (let i=0;i<items.length;i++){
            const raw = items[i];
            if (!raw) continue;
            const line = raw.trim();
            if (!line) continue;
            const parts = line.split(',');
            if (parts.length < 3) continue;
            let lng = parseFloat((parts[isHash ? 0 : 1] || '').trim());
            let lat = parseFloat((parts[isHash ? 1 : 2] || '').trim());
            // 初步过滤：数值合法性与正常范围
            if (!isFinite(lng) || !isFinite(lat)) continue;
            if (lng === 0 || lat === 0) continue; // 丢弃0.0异常点
            if (lng < -180 || lng > 180 || lat < -90 || lat > 90) continue; // 超出经纬度范围丢弃

            // 将输入坐标转换为WGS84
            let w;
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                w = { lng, lat };
            } else if (coordSys === 'gcj02') {
                w = gcj02ToWgs84(lng, lat);
            } else if (coordSys === 'bd09') {
                const g = bd09ToGcj02(lng, lat);
                w = gcj02ToWgs84(g.lng, g.lat);
            } else {
                w = { lng, lat };
            }
            // 转换结果兜底检查
            if (!isFinite(w.lng) || !isFinite(w.lat)) continue;
            if (w.lng < -180 || w.lng > 180 || w.lat < -90 || w.lat > 90) continue;

            // 使用WGS84坐标绘制到地图
            pts.push(new T.LngLat(w.lng, w.lat));
        }
        return pts;
    }

    function drawTrackFromPoints(points){
        // 先移除旧轨迹（不影响轮廓）
        clearTrackOverlays(false);
        const polyline = new T.Polyline(points, {
            color: '#FF3B30',
            weight: 1,
            opacity: 0.9
        });
        if (map) {
            map.addOverLay(polyline);
        }
        currentTracks.push(polyline);
    }

    function clearTrackOverlays(resetArray = true){
        try {
            currentTracks.forEach(pl => {
                if (pl && map && map.removeOverLay) {
                    try { map.removeOverLay(pl); } catch (e) { console.warn('移除轨迹失败:', e); }
                }
            });
            if (resetArray) currentTracks = [];
        } catch (e) {
            console.warn('清空轨迹时出错:', e);
        }
    }


    function fitViewportToTrack(points){
        try {
            if (!map || !map.setViewport || !points || !points.length) return;
            map.setViewport(points);
        } catch (e) {
            console.warn('轨迹视图居中失败:', e);
        }
    }

    // ========= 轨迹回放功能 =========
    let playbackState = { points: [], idx: 0, speed: 1, timer: null, running: false, marker: null, line: null, path: [] };

    function bindPlaybackControls(){
        const startBtn = document.getElementById('playbackStartBtn');
        const pauseBtn = document.getElementById('playbackPauseBtn');
        const stopBtn = document.getElementById('playbackStopBtn');
        const speedSel = document.getElementById('playbackSpeedSelect');
        const timeSlider = document.getElementById('playbackTimeSlider');
        const timeCursor = document.getElementById('playbackTimeCursor');
        const ta = document.getElementById('trackTextarea');
        if (!startBtn || !pauseBtn || !stopBtn || !speedSel) return;

        // 初始按钮状态
        updatePlaybackButtonsState('idle');

        startBtn.addEventListener('click', function(){
            try {
                const text = (ta && ta.value || '').trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const pts = parseTrackTextWithTime(text);
                if (pts.length < 2) { alert('有效轨迹点不足，至少需要两点'); return; }
                startPlayback(pts);
                // 状态在startPlayback中已设置为playing
            } catch (e) {
                alert('开始回放失败：' + (e && e.message ? e.message : e));
                console.error('开始回放异常:', e);
            }
        });

        pauseBtn.addEventListener('click', function(){
            if (!playbackState.running) {
                // 继续
                playbackState.running = true;
                scheduleNext();
                updatePlaybackButtonsState('playing');
            } else {
                // 暂停
                if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
                playbackState.running = false;
                updatePlaybackButtonsState('paused');
            }
        });

        stopBtn.addEventListener('click', function(){ 
            stopPlayback(); 
            updatePlaybackButtonsState('idle');
        });

        speedSel.addEventListener('change', function(){
            const v = parseFloat(speedSel.value);
            playbackState.speed = (isFinite(v) && v > 0) ? v : 1;
        });

        if (timeSlider) {
            timeSlider.addEventListener('input', function(){
                const ms = parseInt(timeSlider.value, 10);
                const txt = formatTimeForLabel(ms);
                if (timeCursor) timeCursor.textContent = txt;
            });
            timeSlider.addEventListener('change', function(){
                jumpToSliderTime();
            });
        }
    }

    function parseTrackTextWithTime(text){
        const coordSysEl = document.getElementById('trackCoordSysSelect') || document.getElementById('coordSysSelect');
        const coordSys = (coordSysEl && coordSysEl.value) || 'wgs84';
        const isHash = text.indexOf('#') !== -1;
        const items = isHash ? text.split('#') : text.split(/\r?\n/);
        const out = [];
        for (let i=0;i<items.length;i++){
            const raw = items[i];
            if (!raw) continue;
            const line = raw.trim();
            if (!line) continue;
            const parts = line.split(',');
            if (parts.length < 3) continue;
            const tsRaw = (parts[isHash ? 2 : 0] || '').trim();
            const ts = (tsRaw || '').replace(/\D/g,'');
            let lng = parseFloat((parts[isHash ? 0 : 1] || '').trim());
            let lat = parseFloat((parts[isHash ? 1 : 2] || '').trim());
            if (!isFinite(lng) || !isFinite(lat)) continue;
            if (lng === 0 || lat === 0) continue;
            if (lng < -180 || lng > 180 || lat < -90 || lat > 90) continue;
            const t = parseTimestamp(ts);
            if (!t) continue;
            let w;
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                w = { lng, lat };
            } else if (coordSys === 'gcj02') {
                w = gcj02ToWgs84(lng, lat);
            } else if (coordSys === 'bd09') {
                const g = bd09ToGcj02(lng, lat);
                w = gcj02ToWgs84(g.lng, g.lat);
            } else { w = { lng, lat }; }
            if (!isFinite(w.lng) || !isFinite(w.lat)) continue;
            if (w.lng < -180 || w.lng > 180 || w.lat < -90 || w.lat > 90) continue;
            out.push({ ll: new T.LngLat(w.lng, w.lat), time: t, ts });
        }
        out.sort((a,b)=>a.time - b.time);
        return out;
    }

    function parseTimestamp(ts){
        const tstr = (ts || '').replace(/\D/g,'');
        const m = tstr && tstr.match(/^\d{14}$/);
        if (!m) return null;
        const y = parseInt(tstr.slice(0,4),10);
        const M = parseInt(tstr.slice(4,6),10) - 1;
        const d = parseInt(tstr.slice(6,8),10);
        const h = parseInt(tstr.slice(8,10),10);
        const m2 = parseInt(tstr.slice(10,12),10);
        const s = parseInt(tstr.slice(12,14),10);
        const dt = new Date(y,M,d,h,m2,s);
        return isNaN(dt.getTime()) ? null : dt;
    }

    function startPlayback(points){
        console.log('[Playback] startPlayback: 点数=', points && points.length);
        stopPlayback();
        playbackState.points = points;
        playbackState.idx = 0;
        playbackState.speed = playbackState.speed || 1;
        playbackState.running = true;
        // 配置时间滑动条，并尊重现有滑块位置作为起始
        configureTimeSlider(points);
        // 启用滑块
        const slider = document.getElementById('playbackTimeSlider');
        if (slider) slider.disabled = false;
        let initIdx = 0;
        if (slider && slider.min && slider.max) {
            const ms = parseInt(slider.value, 10);
            if (isFinite(ms)) initIdx = findIndexByTime(points, ms);
        }
        playbackState.idx = initIdx;
        const first = points[initIdx];
        console.log('[Playback] 首点:', first && first.ts, first && first.ll, 'initIdx=', initIdx);
        playbackState.path = points.slice(0, initIdx+1).map(p=>p.ll);
        playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 1, opacity: 0.9 });
        if (map) {
            map.addOverLay(playbackState.line);
        }
        currentTracks.push(playbackState.line);
        // 创建并定位DOM标记以保证可见移动
        ensurePlaybackDom(first.ll);
        updatePlaybackDom(first.ll);
        updatePlaybackTimeLabel(first.ts);
        try { fitViewportToTrack(points.map(p=>p.ll)); } catch(e){}
        // 更新按钮状态
        updatePlaybackButtonsState('playing');
        scheduleNext();
    }

    function scheduleNext(){
        if (!playbackState.running) return;
        if (!playbackState.points || playbackState.idx >= playbackState.points.length - 1) {
            playbackState.running = false;
            console.log('[Playback] 回放结束：idx=', playbackState.idx, '点数=', playbackState.points ? playbackState.points.length : 0);
            updatePlaybackButtonsState('idle'); // 播放结束后按钮回到初始状态：开始可点，继续/结束灰化
            return;
        }
        const next = playbackState.points[playbackState.idx+1];
        const speed = playbackState.speed || 1;
        const delay = Math.max(4, Math.round(1000 / speed)); // 1x=1000ms/点，2x=500ms/点...
        console.log('[Playback] scheduleNext: idx=', playbackState.idx, '->', playbackState.idx+1, 'delay=', delay, 'speed=', speed);
        playbackState.timer = setTimeout(()=>{
            playbackState.idx++;
            const nextLL = next.ll;
            console.log('[Playback] 下一点:', next && next.ts, nextLL);
            try {
                // 维护路径数组
                playbackState.path = playbackState.path || [];
                playbackState.path.push(nextLL);
                console.log('[Playback] 路径长度=', playbackState.path.length);
                // 使用DOM标记进行移动（容器/图层坐标）
                if (!playbackDom.el) console.log('[Playback] DOM标记不存在，将尝试创建');
                updatePlaybackDom(nextLL);
                // 折线更新：优先setLngLats，兜底重建
                if (playbackState.line && typeof playbackState.line.setLngLats === 'function') {
                    try { playbackState.line.setLngLats(playbackState.path); }
                    catch(e){
                        console.warn('[Playback] setLngLats失败，重建折线', e);
                        if (map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                        playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 1, opacity: 0.9 });
                        if (map) map.addOverLay(playbackState.line);
                    }
                } else {
                    console.log('[Playback] 折线不支持setLngLats，重建');
                    if (playbackState.line && map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                    playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 1, opacity: 0.9 });
                    if (map) map.addOverLay(playbackState.line);
                }
            } catch(e) { console.warn('更新回放覆盖物失败:', e); }
            updatePlaybackTimeLabel(next.ts);
            scheduleNext();
        }, delay);
    }

    function stopPlayback(){
        if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
        playbackState.running = false;
        playbackState.idx = 0;
        try {
            // 移除DOM标记
            removePlaybackDom();
            if (playbackState.marker && map) map.removeOverLay(playbackState.marker);
            if (playbackState.line && map) map.removeOverLay(playbackState.line);
        } catch(e){}
        playbackState.marker = null;
        playbackState.line = null;
        updatePlaybackTimeLabel('—');
        // 按钮回到初始状态
        updatePlaybackButtonsState('idle');
    }

    function updatePlaybackTimeLabel(text){
        const el = document.getElementById('playbackTimeLabel');
        if (el) el.textContent = '时间：' + (text || '—');
    }

    // 时间滑动条：配置与跳转
    function configureTimeSlider(points){
        try {
            const slider = document.getElementById('playbackTimeSlider');
            const cursor = document.getElementById('playbackTimeCursor');
            if (!slider || !points || !points.length) return;
            const minMs = points[0].time.getTime();
            const maxMs = points[points.length - 1].time.getTime();
            const prev = parseInt(slider.value, 10);
            slider.min = String(minMs);
            slider.max = String(maxMs);
            slider.step = '1000'; // 以秒为步进
            let val = (isFinite(prev) && prev >= minMs && prev <= maxMs) ? prev : minMs;
            slider.value = String(val);
            if (cursor) cursor.textContent = formatTimeForLabel(val);
        } catch(e) { console.warn('配置时间滑动条失败:', e); }
    }
    function formatTimeForLabel(ms){
        if (!isFinite(ms)) return '—';
        const d = new Date(ms);
        const pad = n => String(n).padStart(2,'0');
        const y = d.getFullYear();
        const M = pad(d.getMonth()+1);
        const da = pad(d.getDate());
        const h = pad(d.getHours());
        const m = pad(d.getMinutes());
        const s = pad(d.getSeconds());
        return `${y}-${M}-${da} ${h}:${m}:${s}`;
    }
    function findIndexByTime(points, ms){
        try {
            if (!points || !points.length) return 0;
            const n = points.length;
            const minMs = points[0].time.getTime();
            const maxMs = points[n-1].time.getTime();
            if (!isFinite(ms)) return 0;
            if (ms <= minMs) return 0;
            if (ms >= maxMs) return n-1;
            let lo = 0, hi = n - 1, ans = 0;
            while (lo <= hi) {
                const mid = (lo + hi) >> 1;
                const t = points[mid].time.getTime();
                if (t < ms) { lo = mid + 1; ans = lo; }
                else { hi = mid - 1; ans = mid; }
            }
            return Math.max(0, Math.min(n-1, ans));
        } catch(e){ console.warn('findIndexByTime失败:', e); return 0; }
    }
    function jumpToSliderTime(){
        try {
            const slider = document.getElementById('playbackTimeSlider');
            if (!slider || !playbackState.points || !playbackState.points.length) return;
            const ms = parseInt(slider.value, 10);
            if (!isFinite(ms)) return;
            const idx = findIndexByTime(playbackState.points, ms);
            playbackState.idx = idx;
            const pts = playbackState.points;
            const ll = pts[idx].ll;
            playbackState.path = pts.slice(0, idx+1).map(p=>p.ll);
            // 更新折线
            try {
                if (playbackState.line && typeof playbackState.line.setLngLats === 'function') {
                    playbackState.line.setLngLats(playbackState.path);
                } else {
                    if (playbackState.line && map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                    playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 1, opacity: 0.9 });
                    if (map) map.addOverLay(playbackState.line);
                }
            } catch(e){ console.warn('滑块更新折线失败:', e); }
            // 更新标记与时间
            ensurePlaybackDom(ll);
            updatePlaybackDom(ll);
            updatePlaybackTimeLabel(pts[idx].ts);
            // 若正在播放，立即按新位置继续
            if (playbackState.running) {
                if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
                scheduleNext();
            }
        } catch(e) { console.warn('滑块跳转失败:', e); }
    }

    // DOM标记：使用容器坐标实现可见移动
    let playbackDom = { el: null, lastLL: null, bound: false };

    function ensurePlaybackDom(ll){
        try {
            playbackDom.lastLL = ll;
            const pane = (map && map.getPanes && map.getPanes().overlayPane) || document.getElementById('mapContainer');
            if (!pane) { console.warn('未找到overlayPane或mapContainer'); return; }
            if (!playbackDom.el) {
                const el = document.createElement('div');
                el.id = 'playbackDomMarker';
                el.style.position = 'absolute';
                el.style.width = '0';
                el.style.height = '0';
                el.style.borderLeft = '3px solid transparent';
                el.style.borderRight = '3px solid transparent';
                el.style.borderBottom = '4px solid #2C64A7';
                el.style.borderTop = '0';
                el.style.transform = 'translate(-50%, -50%)';
                el.style.zIndex = '9999';
                // 添加伪元素来增强箭头效果
                el.style.clipPath = 'polygon(50% 0, 100% 100%, 0 100%)';
                pane.appendChild(el);
                playbackDom.el = el;
                console.log('[Playback] 创建DOM标记，父节点=', pane === document.getElementById('mapContainer') ? '#mapContainer' : 'overlayPane');
                bindPlaybackDomEvents();
            }
            updatePlaybackDom(ll);
        } catch(e) { console.warn('创建DOM标记失败:', e); }
    }

    function updatePlaybackDom(ll){
        try {
            playbackDom.lastLL = ll;
            if (!map || !playbackDom.el || !ll) { console.log('[Playback] update取消：map/el/ll缺失'); return; }
            let p;
            if (typeof map.lngLatToLayerPoint === 'function') {
                p = map.lngLatToLayerPoint(ll);
                console.log('[Playback] 使用layerPoint定位:', ll && ll.lng, ll && ll.lat, '=>', p && p.x, p && p.y);
            } else if (typeof map.lngLatToContainerPoint === 'function') {
                p = map.lngLatToContainerPoint(ll);
                console.log('[Playback] 使用containerPoint定位:', ll && ll.lng, ll && ll.lat, '=>', p && p.x, p && p.y);
            } else {
                console.warn('地图对象不支持lngLat到像素坐标转换');
                return;
            }
            playbackDom.el.style.left = p.x + 'px';
            playbackDom.el.style.top = p.y + 'px';
        } catch(e) { console.warn('更新DOM标记位置失败:', e); }
    }

    function bindPlaybackDomEvents(){
        if (playbackDom.bound) return;
        const updater = function(){
            try {
                if (!map || !playbackDom.el || !playbackDom.lastLL) return;
                let p;
                if (typeof map.lngLatToLayerPoint === 'function') {
                    p = map.lngLatToLayerPoint(playbackDom.lastLL);
                } else if (typeof map.lngLatToContainerPoint === 'function') {
                    p = map.lngLatToContainerPoint(playbackDom.lastLL);
                }
                if (!p) return;
                playbackDom.el.style.left = p.x + 'px';
                playbackDom.el.style.top = p.y + 'px';
            } catch(e){}
        };
        try {
            map.addEventListener('move', updater);
            map.addEventListener('zoom', updater);
            playbackDom.bound = true;
        } catch(e){}
    }

    function removePlaybackDom(){
        try {
            const el = playbackDom.el;
            playbackDom.lastLL = null;
            if (el && el.parentNode) el.parentNode.removeChild(el);
        } catch(e){}
        playbackDom.el = null;
        playbackDom.bound = false;
    }

</script>
</body>

</html>
