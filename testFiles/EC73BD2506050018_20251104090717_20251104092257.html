<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Âú∞ÂùóËΩÆÂªìÂèä‰∫©Êï∞Â±ïÁ§∫</title>

    <!-- APIÂØÜÈí•ÈÖçÁΩÆ - Êú¨Âú∞Êñá‰ª∂ÁéØÂ¢É‰ΩøÁî®ÁôæÂ∫¶Âú∞ÂõæÔºåWebÁéØÂ¢É‰ΩøÁî®Â§©Âú∞Âõæ -->
    <script>
        // ÁôæÂ∫¶Âú∞ÂõæAPIÂØÜÈí•ÔºàÊú¨Âú∞Êñá‰ª∂ÁéØÂ¢É‰ΩøÁî®Ôºâ
        const BAIDU_MAP_AK = 'vMMZdKUVyHa5p2m5GZl2w4sNlF0dwr52';
        // Â§©Âú∞ÂõæAPIÂØÜÈí•ÔºàWebÁéØÂ¢É‰ΩøÁî®Ôºâ
        const TIANDITU_MAP_TK = '9ed3674d01dd7c129ab38e3c38bf651a';
    </script>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

    <!-- Â§©Âú∞Âõæ API -->
    <script>
        // Âä®ÊÄÅÂä†ËΩΩÂ§©Âú∞ÂõæAPIÔºåÈÅøÂÖçdocument.write
        const tiandituScript = document.createElement('script');
        tiandituScript.src = 'https://api.tianditu.gov.cn/api?v=4.0&tk=' + TIANDITU_MAP_TK;
        tiandituScript.async = true;
        document.head.appendChild(tiandituScript);
    </script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Turf.js Áî®‰∫éÂá†‰ΩïËÆ°ÁÆó -->
    <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

    <!-- WKTËß£ÊûêÂ∫ì -->
    <script src="https://unpkg.com/wellknown@0.5.0/wellknown.js"></script>

    <!-- Leaflet Geometry Util for area calculation -->
    <script src="https://unpkg.com/leaflet-geometryutil@0.11.0/src/leaflet.geometryutil.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f0f0;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            width: 100%;
            height: 100vh;
            margin: 0;
            background: white;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            position: relative;
        }
        
        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: transparent;
            color: white;
            padding: 0;
            text-align: left;
            z-index: 1000;
            display: none;
        }
        
        .header.show {
            display: block;
        }
        
        .header h1 {
            font-size: 18px;
            margin: 0;
            display: inline-block;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 12px;
            margin: 0 0 0 20px;
            display: inline-block;
        }
        
        .main-content {
            position: relative;
            height: 100vh;
            width: 100%;
        }
        
        .left-panel {
            width: 350px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
            position: absolute;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 1001;
            transition: transform 0.3s ease;
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
        }
        
        .left-panel.collapsed {
            transform: translateX(-350px);
            z-index: 9999; /* Á°Æ‰øùÈù¢ÊùøÂú®Âõ∫ÂÆöÊåâÈíÆ‰πã‰∏ã */
        }
        
        .left-panel.collapsed .panel-toggle {
            left: 100%;
            display: none !important;
        }
        

        
        .toolbar {
            padding: 15px;
            background: white;
            border-bottom: 1px solid #e9ecef;
        }
        
        .toolbar h3 {
            margin-bottom: 10px;
            color: #495057;
            font-size: 16px;
        }
        
        .tool-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .tool-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            background: #6c757d;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .tool-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }
        
        .tool-btn.active {
            background: #007bff;
        }
        
        .wkt-input {
            flex: 1;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }
        
        .tab-container {
            margin-bottom: 15px;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 8px;
            padding: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s ease;
            font-size: 13px;
            font-weight: 500;
        }
        
        .tab.active {
            background: #007bff;
            color: white;
            box-shadow: 0 2px 4px rgba(0,123,255,0.3);
        }
        
        .tab-content {
            display: none;
            margin-top: 15px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
            font-size: 13px;
        }
        
        .input-group textarea {
            width: 100%;
            height: 80px;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            resize: vertical;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            transition: border-color 0.3s ease;
        }
        
        .input-group textarea:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .button-group {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            flex: 1;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #1e7e34;
            transform: translateY(-1px);
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-primary:disabled {
            background: #6c757d;
            border-color: #6c757d;
        }
        
        .btn-secondary:disabled {
            background: #6c757d;
            border-color: #6c757d;
        }
        
        .btn-warning:disabled {
            background: #6c757d;
            border-color: #6c757d;
            color: white;
        }
        
        .color-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 6px;
        }
        
        .color-picker {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #dee2e6;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .color-picker:hover {
            border-color: #007bff;
            transform: scale(1.1);
        }
        
        .color-label {
            font-size: 12px;
            color: #495057;
            font-weight: 500;
        }
        
        .map-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: #e9ecef;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        

        
        .header-toggle {
            position: fixed;
            top: 10px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            z-index: 1001;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }
        
        .header-toggle:hover {
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .panel-toggle-fixed {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: #007bff;
            color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
            z-index: 10000;
        }
        
        .panel-toggle-fixed:hover {
            background: #0056b3;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .map-control-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .map-control-btn:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .playback-player {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            z-index: 1000;
            width: 600px;
            max-width: 90vw;
            overflow: hidden;
        }
        
        .player-header {
            background: #007bff;
            color: white;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .player-title {
            font-size: 14px;
            font-weight: 500;
        }
        
        .player-close {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s ease;
        }
        
        .player-close:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .player-controls {
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .player-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: #007bff;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .player-btn:hover {
            background: #0056b3;
            transform: scale(1.05);
        }
        
        .player-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .player-speed {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 8px;
        }
        
        .player-speed label {
            font-size: 12px;
            color: #495057;
            font-weight: 500;
        }
        
        .player-speed input[type="range"] {
            width: 80px;
        }
        
        .player-speed span {
            font-size: 12px;
            color: #6c757d;
            min-width: 25px;
        }
        
        .player-progress {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 8px;
        }
        
        .player-progress input[type="range"] {
            flex: 1;
            height: 4px;
            border-radius: 2px;
            background: #e9ecef;
            outline: none;
            -webkit-appearance: none;
        }
        
        .player-progress input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #007bff;
            cursor: pointer;
        }
        
        .player-progress span {
            font-size: 12px;
            color: #495057;
            font-weight: 500;
            min-width: 80px;
        }
        
        .speed-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .speed-control label {
            font-size: 12px;
            color: #495057;
            font-weight: 500;
        }
        
        .speed-control input[type="range"] {
            width: 80px;
        }
        
        .speed-value {
            font-size: 12px;
            color: #6c757d;
            min-width: 30px;
        }
        
        .time-slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .time-slider {
            flex: 1;
            height: 4px;
            border-radius: 2px;
            background: #e9ecef;
            outline: none;
            -webkit-appearance: none;
        }
        
        .time-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #007bff;
            cursor: pointer;
        }
        
        .time-label {
            font-size: 11px;
            color: #495057;
            font-weight: 500;
            min-width: 120px;
        }
        
        .status-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px 15px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            font-size: 12px;
            color: #495057;
        }
        
        .measure-result {
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1001;
        }
        
        .coordinate-info {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            font-size: 11px;
            color: #495057;
        }
        
        .hidden {
            display: none !important;
        }
        
        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
                height: auto;
            }
            
            .left-panel {
                width: 100%;
                height: 400px;
            }
            
            .map-container {
                height: 500px;
            }
        }
        
        .area-label {
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            pointer-events: none;
            z-index: 1000; /* Á°Æ‰øùÊ†áÁ≠æÂú®ÊúÄ‰∏äÂ±Ç */
        }
        
        /* ÈªòËÆ§ÈöêËóèÊ†áÁ≠æÂÆπÂô®‰∏ãÁöÑÊ†áÁ≠æ */
        .labels-hidden .area-label { display: none; }

        /* Âè≥ÈîÆËèúÂçïÊ†∑Âºè */
        .context-menu {
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 10000;
            min-width: 120px;
            display: none;
        }

        .context-menu-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 12px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }

        .context-menu-item:last-child {
            border-bottom: none;
        }

        .context-menu-item:hover {
            background-color: #f0f0f0;
        }

        .context-menu-item.disabled {
            color: #999;
            cursor: not-allowed;
        }

        .context-menu-item.disabled:hover {
            background-color: white;
        }

        /* CanvasËΩ®ËøπÁÇπ‰ºòÂåñÊ†∑Âºè */
        .leaflet-canvas {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            image-rendering: pixelated;
        }
        
        /* ÊûÅÂ∞èËΩ®ËøπÁÇπÊ†∑Âºè */
        .leaflet-marker-icon.tiny-point {
            width: 1px !important;
            height: 1px !important;
            min-width: 1px !important;
            min-height: 1px !important;
            border-radius: 50% !important;
            opacity: 0.8 !important;
        }
        
        /* CanvasÊ∏≤ÊüìÁöÑCircleMarker‰ºòÂåñ */
        .leaflet-canvas-pane circle {
            vector-effect: non-scaling-stroke;
            shape-rendering: optimizeSpeed;
        }
        
        /* ËΩ®ËøπÁÇπÊÇ¨ÂÅúÊó∂ÊòæÁ§∫ÊâãÂûãÊåáÈíà */
        .leaflet-marker-icon.tiny-point:hover {
            cursor: pointer !important;
        }
        
        /* CircleMarkerÊÇ¨ÂÅúÊó∂ÊòæÁ§∫ÊâãÂûãÊåáÈíà */
        .leaflet-canvas-pane circle:hover {
            cursor: pointer !important;
        }
        
        /* ÊôÆÈÄömarkerÊÇ¨ÂÅúÊó∂ÊòæÁ§∫ÊâãÂûãÊåáÈíà */
        .leaflet-marker-icon:hover {
            cursor: pointer !important;
        }
        
        /* ËΩ®ËøπÁÇπCanvasÂõæÂ±Ç‰ºòÂåñ */
        .leaflet-layer canvas {
            will-change: transform;
            transform: translateZ(0);
        }
    </style>
</head>
<body>
<div class="container">
    <div class="main-content">
        <div class="left-panel">

            <div class="toolbar">
                <h3>üõ†Ô∏è Â∑•ÂÖ∑Ê†è</h3>
                <div class="tool-buttons">
                    <button class="tool-btn" id="measureDistanceBtn" title="ÊµãË∑ù">üìè ÊµãË∑ù</button>
                    <button class="tool-btn" id="measureAreaBtn" title="ÊµãÈù¢">üìê ÊµãÈù¢</button>
                    <button class="tool-btn" id="mapTypeBtn" title="ÂàáÊç¢Âú∞Âõæ">üó∫Ô∏è Ë°óÈÅìÂõæ</button>
                    <button class="tool-btn" id="clearAllBtn" title="Ê∏ÖÁ©∫ÊâÄÊúâ">üóëÔ∏è Ê∏ÖÁ©∫</button>
                </div>
            </div>

            <div class="wkt-input">
                <div class="tab-container">
                    <div class="tabs">
                        <div class="tab active" data-tab="outline">ËΩÆÂªì</div>
                        <div class="tab" data-tab="track">ËΩ®Ëøπ</div>
                    </div>

                    <div class="tab-content active" id="outline-tab">
                        <div class="input-group">
                            <textarea id="outlineWkt" style="height: 400px;"
                                      placeholder="ËæìÂÖ•Â§öËæπÂΩ¢WKTÔºåÊîØÊåÅÂ§öË°åËæìÂÖ•ÔºåÊØèË°å‰∏Ä‰∏™WKT">POLYGON ((107.79296373408772 22.54069094138887, 107.79296005345041 22.54069127639061, 107.79295650788939 22.540692253365812, 107.79295322594834 22.54069383689442, 107.79295032661344 22.540695969565885, 107.79294791499973 22.540698574060553, 107.79294607853974 22.54070155595294, 107.79294488381414 22.54070480713501, 107.79294437413756 22.5407082097357, 107.79294456798834 22.54071164039428, 107.79294545833834 22.54071497473275, 107.79294701290829 22.540718091865205, 107.79294885745792 22.540721021731155, 107.79294957708858 22.54072256641754, 107.79295017508247 22.54072432679921, 107.79295057551701 22.54072613487703, 107.79295077416725 22.540727971574995, 107.79295076893715 22.540729817512144, 107.79295055988162 22.54073165321344, 107.79295014920689 22.540733459308356, 107.7929495412459 22.540735216741112, 107.79294874241302 22.540736906969464, 107.79294776113697 22.54073851215922, 107.79294687795502 22.540739663235403, 107.79294272415464 22.54074364469204, 107.79294024076384 22.54074658006944, 107.79293846090714 22.540749927386567, 107.79293746079318 22.54075354332062, 107.79293728324396 22.54075727304733, 107.79293866422998 22.540778823627907, 107.79293970192694 22.540783662707994, 107.79294111248063 22.54078744128153, 107.79294190650363 22.540791254049836, 107.79294189932509 22.540794677154857, 107.79294055525509 22.54080062172714, 107.79294016050126 22.540803512325702, 107.79294027179755 22.540806424255592, 107.79294278936332 22.54082643755368, 107.79294367119242 22.540830094405315, 107.79294534724725 22.540833503155664, 107.79294774522069 22.540836516746705, 107.79295076166106 22.540839005168113, 107.79295426643496 22.540840861066066, 107.79295810834196 22.540842004374664, 107.79296212163688 22.540842385770038, 107.79306315836328 22.54084218962392, 107.79341565178507 22.540841587743287, 107.79341942593656 22.54084123727016, 107.79342305479736 22.540840212115487, 107.79342639997958 22.540838551373845, 107.79342933391395 22.5408363183781, 107.79343174471383 22.54083359828421, 107.79343354044285 22.54083049482375, 107.79343465262042 22.54082712634808, 107.79343503883332 22.540823621314974, 107.7934346843532 22.540820113389877, 107.7934341050283 22.540817336051177, 107.7934339795 22.540813799098718, 107.79343451606901 22.54081053465164, 107.79343584871286 22.540806989886885, 107.79344533712579 22.540789665122862, 107.79344669893506 22.540786448436336, 107.79344737540464 22.540783049546846, 107.79344734170691 22.540779593199595, 107.79344659907882 22.540776206248562, 107.79344517477604 22.540773013000788, 107.79344312107307 22.540770130654032, 107.79344051334435 22.54076766499545, 107.79343744729819 22.54076570651901, 107.79343538145984 22.540764642043687, 107.79343196283568 22.540762208796643, 107.79342945267184 22.540759544797986, 107.7934275556963 22.54075647416921, 107.79342634603834 22.540753116903353, 107.79342587096833 22.540749604193977, 107.7934261490509 22.540746073309393, 107.79342729909997 22.540742228706133, 107.79342826115641 22.540740225029076, 107.7934294401259 22.540736964888442, 107.79342993172907 22.54073355616929, 107.79342971810364 22.54073012272717, 107.7934288070117 22.54072678931591, 107.79342723155773 22.540723677054736, 107.79342504898574 22.540720899027363, 107.79342233859937 22.540718556173175, 107.79341919888023 22.54071673361956, 107.79341574390975 22.540715497588845, 107.79341108483888 22.540714289697334, 107.79340787863002 22.540712844687086, 107.7934050371993 22.540710900677556, 107.79340262430696 22.54070850858304, 107.79340071783692 22.540705744341157, 107.79339874043997 22.540701240103516, 107.79339694951696 22.540698091366515, 107.79339452768782 22.540695330729275, 107.7933915693052 22.540693065744023, 107.79338818962516 22.540691384652742, 107.79338452031752 22.540690352949426, 107.79338070433538 22.54069001082839, 107.79327451851074 22.54069027060841, 107.79296373408772 22.54069094138887))</textarea>
                        </div>
                        <div class="button-group">
                            <button class="btn btn-primary" onclick="drawOutline()">üéØ ÁªòÂà∂ËΩÆÂªì</button>
                            <button class="btn btn-secondary" onclick="clearOutline()">üßπ Ê∏ÖÈô§ËΩÆÂªì</button>
                        </div>
                        <div class="input-group">
                            <label><input type="checkbox" id="toggleLabelsCheckbox"> ÊòæÁ§∫‰∫©Êï∞</label>
                        </div>
                    </div>

                    <div class="tab-content" id="track-tab">
                        <div class="time-range-settings" style="margin-bottom:8px;font-size:12px;color:#333;">
                            <label>Êó∂Èó¥ËåÉÂõ¥ÈÄâÂèñ(ÁïôÁ©∫ÂàôÊòæÁ§∫ÊâÄÊúâËΩ®Ëøπ)</label>
                            <input type="text" id="timeRangeInput"
                                   style="width:100%;margin-top:4px;padding:4px;border:1px solid #ddd;border-radius:4px;font-size:12px;"
                                   placeholder="Ê†ºÂºèÔºöyyyy-MM-ddTHH:mm:ss - yyyy-MM-ddTHH:mm:ss">
                        </div>
                        <textarea id="trackTextarea"
                                  style="width:100%;height:400px;margin-bottom:10px;padding:8px;border:1px solid #ddd;border-radius:4px;font-family:monospace;resize:vertical;box-sizing:border-box;">20251104090717,107.79342390,22.54082890
20251104090718,107.79342385,22.54082890
20251104090719,107.79342386,22.54082888
20251104090720,107.79342388,22.54082890
20251104090721,107.79342385,22.54082890
20251104090722,107.79342388,22.54082890
20251104090723,107.79342390,22.54082888
20251104090724,107.79342388,22.54082890
20251104090725,107.79342386,22.54082888
20251104090726,107.79342385,22.54082890
20251104090727,107.79342383,22.54082890
20251104090728,107.79342385,22.54082890
20251104090729,107.79342381,22.54082890
20251104090730,107.79342383,22.54082890
20251104090731,107.79342383,22.54082888
20251104090732,107.79342381,22.54082891
20251104090733,107.79342381,22.54082891
20251104090734,107.79342381,22.54082891
20251104090735,107.79342381,22.54082890
20251104090736,107.79342380,22.54082891
20251104090737,107.79342380,22.54082893
20251104090738,107.79342380,22.54082891
20251104090739,107.79342380,22.54082893
20251104090740,107.79342380,22.54082893
20251104090741,107.79342381,22.54082893
20251104090742,107.79342380,22.54082891
20251104090743,107.79342380,22.54082893
20251104090744,107.79342380,22.54082891
20251104090745,107.79342378,22.54082893
20251104090746,107.79342378,22.54082893
20251104090747,107.79342380,22.54082891
20251104090748,107.79342378,22.54082893
20251104090749,107.79342380,22.54082891
20251104090750,107.79342380,22.54082891
20251104090751,107.79342376,22.54082893
20251104090752,107.79342378,22.54082893
20251104090753,107.79342380,22.54082891
20251104090754,107.79342378,22.54082890
20251104090755,107.79342380,22.54082890
20251104090756,107.79342376,22.54082893
20251104090757,107.79342378,22.54082893
20251104090758,107.79342371,22.54082893
20251104090759,107.79342370,22.54082893
20251104090800,107.79342373,22.54082891
20251104090801,107.79342371,22.54082893
20251104090802,107.79342370,22.54082895
20251104090803,107.79342371,22.54082895
20251104090804,107.79342360,22.54082891
20251104090805,107.79342356,22.54082895
20251104090806,107.79341820,22.54082895
20251104090807,107.79341276,22.54082896
20251104090808,107.79340720,22.54082896
20251104090809,107.79340166,22.54082898
20251104090810,107.79339613,22.54082893
20251104090811,107.79339058,22.54082890
20251104090812,107.79338506,22.54082898
20251104090813,107.79337946,22.54082896
20251104090814,107.79337391,22.54082908
20251104090815,107.79336838,22.54082910
20251104090816,107.79336281,22.54082913
20251104090817,107.79335726,22.54082905
20251104090818,107.79335170,22.54082905
20251104090819,107.79334613,22.54082903
20251104090820,107.79334061,22.54082898
20251104090821,107.79333508,22.54082903
20251104090822,107.79332958,22.54082906
20251104090823,107.79332400,22.54082908
20251104090824,107.79331845,22.54082906
20251104090825,107.79331288,22.54082908
20251104090826,107.79330730,22.54082908
20251104090827,107.79330181,22.54082911
20251104090828,107.79329623,22.54082916
20251104090829,107.79329073,22.54082910
20251104090830,107.79328518,22.54082916
20251104090831,107.79327966,22.54082915
20251104090832,107.79327413,22.54082916
20251104090833,107.79326855,22.54082915
20251104090834,107.79326303,22.54082913
20251104090835,107.79325746,22.54082913
20251104090836,107.79325193,22.54082915
20251104090837,107.79324631,22.54082915
20251104090838,107.79324083,22.54082915
20251104090839,107.79323530,22.54082913
20251104090840,107.79322976,22.54082916
20251104090841,107.79322420,22.54082925
20251104090842,107.79321863,22.54082928
20251104090843,107.79321308,22.54082928
20251104090844,107.79320746,22.54082931
20251104090845,107.79320191,22.54082928
20251104090846,107.79319633,22.54082935
20251104090847,107.79319076,22.54082933
20251104090848,107.79318533,22.54082938
20251104090849,107.79317981,22.54082936
20251104090850,107.79317428,22.54082946
20251104090851,107.79316876,22.54082941
20251104090852,107.79316319,22.54082945
20251104090853,107.79315761,22.54082946
20251104090854,107.79315198,22.54082941
20251104090855,107.79314641,22.54082941
20251104090856,107.79314086,22.54082943
20251104090857,107.79313535,22.54082940
20251104090858,107.79312980,22.54082940
20251104090859,107.79312430,22.54082948
20251104090900,107.79311878,22.54082943
20251104090901,107.79311318,22.54082941
20251104090903,107.79310208,22.54082955
20251104090905,107.79309091,22.54082946
20251104090906,107.79309091,22.54082946
20251104090907,107.79307986,22.54082955
20251104090908,107.79307430,22.54082955
20251104090909,107.79306873,22.54082953
20251104090910,107.79306316,22.54082956
20251104090911,107.79305764,22.54082953
20251104090912,107.79305211,22.54082955
20251104090913,107.79304653,22.54082956
20251104090914,107.79304106,22.54082960
20251104090915,107.79303556,22.54082958
20251104090917,107.79302450,22.54082961
20251104090918,107.79301890,22.54082963
20251104090919,107.79301333,22.54082965
20251104090920,107.79300775,22.54082966
20251104090921,107.79300215,22.54082968
20251104090922,107.79299661,22.54082970
20251104090923,107.79299110,22.54082968
20251104090924,107.79298551,22.54082966
20251104090925,107.79298000,22.54082965
20251104090926,107.79297450,22.54082968
20251104090927,107.79296890,22.54082973
20251104090928,107.79296351,22.54082971
20251104090930,107.79295880,22.54082976
20251104090931,107.79295870,22.54082973
20251104090932,107.79295875,22.54082973
20251104090933,107.79295810,22.54082973
20251104090934,107.79295671,22.54082978
20251104090935,107.79295676,22.54082976
20251104090936,107.79295673,22.54082975
20251104090937,107.79295671,22.54082976
20251104090938,107.79295568,22.54082970
20251104090939,107.79295576,22.54082970
20251104090941,107.79295581,22.54082970
20251104090942,107.79295580,22.54082970
20251104090943,107.79295585,22.54082971
20251104090944,107.79295583,22.54082971
20251104090946,107.79295583,22.54082968
20251104090947,107.79295585,22.54082970
20251104090948,107.79295585,22.54082968
20251104090949,107.79295583,22.54082971
20251104090950,107.79295586,22.54082970
20251104090951,107.79295581,22.54082971
20251104090952,107.79295576,22.54082970
20251104090953,107.79295578,22.54082970
20251104090954,107.79295576,22.54082973
20251104090955,107.79295576,22.54082970
20251104090956,107.79295581,22.54082970
20251104090957,107.79295576,22.54082971
20251104090958,107.79295574,22.54082971
20251104090959,107.79295566,22.54082971
20251104091000,107.79295006,22.54082968
20251104091001,107.79294460,22.54082968
20251104091002,107.79293988,22.54082973
20251104091003,107.79293751,22.54082976
20251104091004,107.79293059,22.54082961
20251104091005,107.79292018,22.54082971
20251104091006,107.79290976,22.54083080
20251104091007,107.79289960,22.54083353
20251104091008,107.79289006,22.54083768
20251104091009,107.79288120,22.54084298
20251104091010,107.79287258,22.54084870
20251104091011,107.79286398,22.54085431
20251104091012,107.79285499,22.54085943
20251104091013,107.79284559,22.54086340
20251104091014,107.79283540,22.54086528
20251104091015,107.79282498,22.54086421
20251104091016,107.79281556,22.54086001
20251104091017,107.79280793,22.54085318
20251104091018,107.79280283,22.54084455
20251104091019,107.79280091,22.54083495
20251104091020,107.79280220,22.54082531
20251104091021,107.79280663,22.54081646
20251104091022,107.79281373,22.54080940
20251104091023,107.79282291,22.54080451
20251104091024,107.79283295,22.54080196
20251104091025,107.79284308,22.54080101
20251104091026,107.79285325,22.54080146
20251104091027,107.79286358,22.54080268
20251104091028,107.79287406,22.54080331
20251104091029,107.79288435,22.54080358
20251104091030,107.79289476,22.54080378
20251104091031,107.79290513,22.54080393
20251104091032,107.79291524,22.54080401
20251104091033,107.79292336,22.54080403
20251104091034,107.79292896,22.54080403
20251104091035,107.79293383,22.54080400
20251104091036,107.79293835,22.54080395
20251104091037,107.79294083,22.54080390
20251104091038,107.79294496,22.54080400
20251104091039,107.79295088,22.54080406
20251104091040,107.79295203,22.54080408
20251104091041,107.79295213,22.54080405
20251104091042,107.79295209,22.54080403
20251104091043,107.79295209,22.54080406
20251104091044,107.79295209,22.54080405
20251104091045,107.79295375,22.54080401
20251104091046,107.79295353,22.54080406
20251104091047,107.79295355,22.54080406
20251104091048,107.79295350,22.54080405
20251104091049,107.79295348,22.54080410
20251104091050,107.79295355,22.54080406
20251104091051,107.79295355,22.54080406
20251104091052,107.79295356,22.54080405
20251104091053,107.79295355,22.54080408
20251104091054,107.79295359,22.54080405
20251104091055,107.79295356,22.54080405
20251104091056,107.79295361,22.54080403
20251104091057,107.79295361,22.54080403
20251104091058,107.79295359,22.54080405
20251104091059,107.79295359,22.54080408
20251104091100,107.79295361,22.54080408
20251104091101,107.79295363,22.54080406
20251104091102,107.79295365,22.54080408
20251104091103,107.79295361,22.54080405
20251104091104,107.79295365,22.54080408
20251104091105,107.79295361,22.54080406
20251104091106,107.79295368,22.54080405
20251104091107,107.79295361,22.54080411
20251104091108,107.79295366,22.54080406
20251104091109,107.79295365,22.54080406
20251104091110,107.79295476,22.54080405
20251104091111,107.79296010,22.54080413
20251104091112,107.79296790,22.54080411
20251104091113,107.79297583,22.54080408
20251104091114,107.79298378,22.54080410
20251104091115,107.79299164,22.54080406
20251104091116,107.79299956,22.54080410
20251104091117,107.79300748,22.54080411
20251104091118,107.79301543,22.54080410
20251104091119,107.79302335,22.54080415
20251104091120,107.79303118,22.54080403
20251104091121,107.79303903,22.54080391
20251104091122,107.79304693,22.54080398
20251104091123,107.79305480,22.54080398
20251104091124,107.79306281,22.54080398
20251104091125,107.79307078,22.54080393
20251104091126,107.79307868,22.54080390
20251104091127,107.79308653,22.54080373
20251104091128,107.79309445,22.54080378
20251104091129,107.79310235,22.54080370
20251104091130,107.79311025,22.54080388
20251104091131,107.79311816,22.54080388
20251104091132,107.79312603,22.54080390
20251104091134,107.79314191,22.54080380
20251104091135,107.79314988,22.54080380
20251104091136,107.79315780,22.54080385
20251104091137,107.79316570,22.54080380
20251104091138,107.79317360,22.54080380
20251104091140,107.79318943,22.54080358
20251104091141,107.79319741,22.54080356
20251104091142,107.79320528,22.54080365
20251104091143,107.79321318,22.54080365
20251104091144,107.79322106,22.54080363
20251104091145,107.79322896,22.54080355
20251104091146,107.79323686,22.54080351
20251104091147,107.79324478,22.54080356
20251104091148,107.79325271,22.54080360
20251104091149,107.79326060,22.54080365
20251104091150,107.79326851,22.54080360
20251104091151,107.79327643,22.54080360
20251104091152,107.79328433,22.54080353
20251104091153,107.79329230,22.54080345
20251104091154,107.79330013,22.54080353
20251104091155,107.79330805,22.54080353
20251104091156,107.79331595,22.54080355
20251104091157,107.79332386,22.54080353
20251104091158,107.79333173,22.54080343
20251104091159,107.79333963,22.54080341
20251104091200,107.79334755,22.54080345
20251104091201,107.79335548,22.54080348
20251104091202,107.79336346,22.54080350
20251104091204,107.79337931,22.54080340
20251104091205,107.79338715,22.54080331
20251104091206,107.79339501,22.54080326
20251104091207,107.79340298,22.54080325
20251104091208,107.79341090,22.54080340
20251104091209,107.79341773,22.54080333
20251104091210,107.79341955,22.54080331
20251104091211,107.79341935,22.54080335
20251104091212,107.79341960,22.54080331
20251104091213,107.79342201,22.54080330
20251104091214,107.79342243,22.54080340
20251104091215,107.79342246,22.54080331
20251104091216,107.79342250,22.54080331
20251104091217,107.79342246,22.54080331
20251104091218,107.79342244,22.54080326
20251104091219,107.79342250,22.54080330
20251104091220,107.79342248,22.54080328
20251104091221,107.79342251,22.54080331
20251104091222,107.79342255,22.54080328
20251104091223,107.79342253,22.54080326
20251104091224,107.79342250,22.54080330
20251104091225,107.79342253,22.54080328
20251104091226,107.79342248,22.54080331
20251104091227,107.79342251,22.54080328
20251104091228,107.79342250,22.54080325
20251104091229,107.79342250,22.54080330
20251104091230,107.79342251,22.54080330
20251104091231,107.79342250,22.54080328
20251104091232,107.79342246,22.54080330
20251104091233,107.79342251,22.54080328
20251104091234,107.79342253,22.54080328
20251104091235,107.79342250,22.54080330
20251104091236,107.79342375,22.54080325
20251104091237,107.79342733,22.54080326
20251104091238,107.79343670,22.54080330
20251104091239,107.79344709,22.54080316
20251104091240,107.79345743,22.54080191
20251104091241,107.79346744,22.54079900
20251104091242,107.79347673,22.54079455
20251104091243,107.79348534,22.54078875
20251104091244,107.79349308,22.54078220
20251104091245,107.79350016,22.54077495
20251104091246,107.79350715,22.54076763
20251104091247,107.79351496,22.54076126
20251104091248,107.79352425,22.54075711
20251104091249,107.79353461,22.54075598
20251104091250,107.79354486,22.54075773
20251104091251,107.79355413,22.54076223
20251104091252,107.79356151,22.54076925
20251104091253,107.79356626,22.54077795
20251104091254,107.79356753,22.54078776
20251104091255,107.79356593,22.54079721
20251104091256,107.79356083,22.54080575
20251104091257,107.79355330,22.54081245
20251104091258,107.79354409,22.54081700
20251104091259,107.79353373,22.54081875
20251104091300,107.79352335,22.54081790
20251104091301,107.79351331,22.54081481
20251104091302,107.79350376,22.54081048
20251104091303,107.79349471,22.54080566
20251104091304,107.79348588,22.54080031
20251104091305,107.79347721,22.54079473
20251104091306,107.79346851,22.54078918
20251104091307,107.79345968,22.54078408
20251104091308,107.79345035,22.54077995
20251104091309,107.79344021,22.54077738
20251104091310,107.79342968,22.54077683
20251104091311,107.79341921,22.54077761
20251104091312,107.79341111,22.54077843
20251104091313,107.79341075,22.54077845
20251104091314,107.79341066,22.54077841
20251104091315,107.79341075,22.54077843
20251104091316,107.79341483,22.54077823
20251104091317,107.79342451,22.54077775
20251104091318,107.79343533,22.54077815
20251104091319,107.79344586,22.54077846
20251104091320,107.79345640,22.54077840
20251104091321,107.79346456,22.54077836
20251104091322,107.79346551,22.54077841
20251104091323,107.79346528,22.54077836
20251104091324,107.79346401,22.54077836
20251104091325,107.79345846,22.54077840
20251104091326,107.79345286,22.54077848
20251104091327,107.79344738,22.54077853
20251104091328,107.79344183,22.54077858
20251104091329,107.79343626,22.54077863
20251104091330,107.79343066,22.54077866
20251104091331,107.79342506,22.54077863
20251104091332,107.79342300,22.54077866
20251104091333,107.79342291,22.54077861
20251104091334,107.79342294,22.54077865
20251104091335,107.79342114,22.54077865
20251104091336,107.79342033,22.54077860
20251104091337,107.79342028,22.54077860
20251104091338,107.79342031,22.54077863
20251104091339,107.79342033,22.54077861
20251104091340,107.79342031,22.54077861
20251104091341,107.79342033,22.54077861
20251104091342,107.79342028,22.54077861
20251104091343,107.79342031,22.54077865
20251104091344,107.79342033,22.54077863
20251104091345,107.79342035,22.54077861
20251104091346,107.79342031,22.54077863
20251104091347,107.79342036,22.54077865
20251104091348,107.79342008,22.54077866
20251104091349,107.79341886,22.54077865
20251104091350,107.79341681,22.54077863
20251104091351,107.79341346,22.54077860
20251104091352,107.79340880,22.54077861
20251104091353,107.79340258,22.54077860
20251104091354,107.79339195,22.54077870
20251104091355,107.79338136,22.54077865
20251104091356,107.79337088,22.54077856
20251104091357,107.79336041,22.54077856
20251104091358,107.79334975,22.54077865
20251104091359,107.79333931,22.54077861
20251104091400,107.79332873,22.54077868
20251104091401,107.79331823,22.54077861
20251104091402,107.79330775,22.54077850
20251104091403,107.79329728,22.54077865
20251104091405,107.79327624,22.54077866
20251104091406,107.79326568,22.54077850
20251104091407,107.79325518,22.54077861
20251104091408,107.79324465,22.54077876
20251104091409,107.79323421,22.54077881
20251104091410,107.79322371,22.54077883
20251104091412,107.79320265,22.54077875
20251104091413,107.79319216,22.54077885
20251104091414,107.79318168,22.54077891
20251104091415,107.79317115,22.54077885
20251104091416,107.79316061,22.54077888
20251104091417,107.79314998,22.54077891
20251104091418,107.79313950,22.54077901
20251104091419,107.79312895,22.54077903
20251104091420,107.79311841,22.54077893
20251104091421,107.79310795,22.54077893
20251104091422,107.79309748,22.54077906
20251104091423,107.79308700,22.54077910
20251104091424,107.79307643,22.54077906
20251104091425,107.79306590,22.54077896
20251104091426,107.79305543,22.54077896
20251104091427,107.79304500,22.54077910
20251104091429,107.79302388,22.54077911
20251104091430,107.79301338,22.54077905
20251104091431,107.79300291,22.54077911
20251104091432,107.79299236,22.54077920
20251104091433,107.79298176,22.54077921
20251104091434,107.79297220,22.54077921
20251104091435,107.79296520,22.54077916
20251104091436,107.79296036,22.54077918
20251104091437,107.79295526,22.54077915
20251104091438,107.79295215,22.54077925
20251104091439,107.79295225,22.54077923
20251104091440,107.79295218,22.54077923
20251104091441,107.79295221,22.54077920
20251104091442,107.79295221,22.54077925
20251104091443,107.79295216,22.54077928
20251104091444,107.79295220,22.54077921
20251104091445,107.79295225,22.54077925
20251104091446,107.79295218,22.54077921
20251104091447,107.79295218,22.54077921
20251104091448,107.79295216,22.54077926
20251104091449,107.79295215,22.54077925
20251104091450,107.79295213,22.54077925
20251104091451,107.79295211,22.54077925
20251104091452,107.79295215,22.54077926
20251104091453,107.79295215,22.54077923
20251104091454,107.79295213,22.54077923
20251104091455,107.79295211,22.54077923
20251104091456,107.79295116,22.54077921
20251104091457,107.79294653,22.54077928
20251104091458,107.79293691,22.54077943
20251104091459,107.79292655,22.54078023
20251104091500,107.79291631,22.54078223
20251104091501,107.79290673,22.54078635
20251104091502,107.79289825,22.54079210
20251104091503,107.79288986,22.54079808
20251104091504,107.79288079,22.54080296
20251104091505,107.79287091,22.54080598
20251104091506,107.79286058,22.54080611
20251104091507,107.79285055,22.54080328
20251104091508,107.79284206,22.54079746
20251104091509,107.79283596,22.54078965
20251104091510,107.79283243,22.54078051
20251104091511,107.79283248,22.54077073
20251104091512,107.79283571,22.54076143
20251104091513,107.79284158,22.54075325
20251104091514,107.79284935,22.54074678
20251104091515,107.79285866,22.54074241
20251104091516,107.79286913,22.54074065
20251104091517,107.79287961,22.54074143
20251104091518,107.79288993,22.54074338
20251104091519,107.79289998,22.54074606
20251104091520,107.79291013,22.54074863
20251104091521,107.79292028,22.54075113
20251104091522,107.79293070,22.54075255
20251104091523,107.79294110,22.54075316
20251104091524,107.79294943,22.54075333
20251104091525,107.79295143,22.54075333
20251104091526,107.79295126,22.54075333
20251104091527,107.79295120,22.54075333
20251104091528,107.79294828,22.54075330
20251104091529,107.79293743,22.54075318
20251104091530,107.79292678,22.54075370
20251104091531,107.79291611,22.54075358
20251104091532,107.79290575,22.54075368
20251104091533,107.79290041,22.54075378
20251104091534,107.79290073,22.54075380
20251104091535,107.79290190,22.54075371
20251104091536,107.79290756,22.54075373
20251104091537,107.79291315,22.54075380
20251104091538,107.79291868,22.54075383
20251104091539,107.79292426,22.54075391
20251104091540,107.79292980,22.54075395
20251104091541,107.79293531,22.54075395
20251104091542,107.79294088,22.54075395
20251104091543,107.79294638,22.54075383
20251104091544,107.79295086,22.54075381
20251104091545,107.79295056,22.54075381
20251104091546,107.79295061,22.54075383
20251104091547,107.79295063,22.54075380
20251104091548,107.79295060,22.54075383
20251104091549,107.79295058,22.54075383
20251104091550,107.79295060,22.54075381
20251104091551,107.79295064,22.54075380
20251104091552,107.79295063,22.54075380
20251104091553,107.79295228,22.54075381
20251104091554,107.79295193,22.54075381
20251104091555,107.79295191,22.54075383
20251104091556,107.79295190,22.54075383
20251104091557,107.79295195,22.54075380
20251104091558,107.79295193,22.54075380
20251104091559,107.79295190,22.54075380
20251104091600,107.79295191,22.54075380
20251104091601,107.79295190,22.54075380
20251104091602,107.79295190,22.54075381
20251104091603,107.79295191,22.54075380
20251104091604,107.79295186,22.54075381
20251104091605,107.79295185,22.54075380
20251104091606,107.79295186,22.54075378
20251104091607,107.79295186,22.54075383
20251104091608,107.79295271,22.54075381
20251104091609,107.79295573,22.54075383
20251104091610,107.79296078,22.54075385
20251104091611,107.79296781,22.54075371
20251104091612,107.79297801,22.54075368
20251104091613,107.79298841,22.54075375
20251104091614,107.79299891,22.54075368
20251104091615,107.79300948,22.54075373
20251104091616,107.79302005,22.54075370
20251104091617,107.79303048,22.54075375
20251104091618,107.79304090,22.54075376
20251104091619,107.79305148,22.54075375
20251104091620,107.79306203,22.54075378
20251104091621,107.79307241,22.54075380
20251104091622,107.79308291,22.54075378
20251104091623,107.79309348,22.54075380
20251104091624,107.79310396,22.54075373
20251104091625,107.79311448,22.54075368
20251104091626,107.79312499,22.54075370
20251104091627,107.79313558,22.54075358
20251104091628,107.79314608,22.54075355
20251104091629,107.79315668,22.54075358
20251104091630,107.79316723,22.54075358
20251104091631,107.79317770,22.54075356
20251104091633,107.79319860,22.54075351
20251104091634,107.79320918,22.54075350
20251104091636,107.79323015,22.54075348
20251104091637,107.79324068,22.54075341
20251104091638,107.79325110,22.54075341
20251104091639,107.79326170,22.54075336
20251104091640,107.79327216,22.54075335
20251104091641,107.79328269,22.54075343
20251104091643,107.79330376,22.54075346
20251104091644,107.79331421,22.54075328
20251104091645,107.79332478,22.54075323
20251104091646,107.79333523,22.54075316
20251104091647,107.79334571,22.54075321
20251104091649,107.79336683,22.54075315
20251104091650,107.79337736,22.54075313
20251104091651,107.79338778,22.54075316
20251104091652,107.79339721,22.54075316
20251104091653,107.79340424,22.54075315
20251104091654,107.79340886,22.54075310
20251104091655,107.79341271,22.54075306
20251104091656,107.79341780,22.54075300
20251104091657,107.79342173,22.54075296
20251104091658,107.79342300,22.54075295
20251104091659,107.79342286,22.54075298
20251104091700,107.79342285,22.54075296
20251104091701,107.79342281,22.54075296
20251104091702,107.79342286,22.54075298
20251104091703,107.79342286,22.54075298
20251104091704,107.79342281,22.54075298
20251104091705,107.79342290,22.54075295
20251104091706,107.79342285,22.54075295
20251104091707,107.79342373,22.54075296
20251104091708,107.79343026,22.54075290
20251104091709,107.79344125,22.54075266
20251104091710,107.79345181,22.54075205
20251104091711,107.79346225,22.54075146
20251104091712,107.79347266,22.54075213
20251104091713,107.79348296,22.54075411
20251104091714,107.79349279,22.54075735
20251104091715,107.79350238,22.54076146
20251104091716,107.79351205,22.54076518
20251104091717,107.79352213,22.54076696
20251104091718,107.79353250,22.54076611
20251104091719,107.79354210,22.54076240
20251104091720,107.79355028,22.54075630
20251104091721,107.79355580,22.54074821
20251104091722,107.79355901,22.54073903
20251104091723,107.79355883,22.54072938
20251104091724,107.79355576,22.54072013
20251104091725,107.79354980,22.54071213
20251104091726,107.79354148,22.54070613
20251104091727,107.79353178,22.54070260
20251104091728,107.79352126,22.54070181
20251104091729,107.79351116,22.54070330
20251104091730,107.79350115,22.54070558
20251104091731,107.79349181,22.54070783
20251104091732,107.79348543,22.54070898
20251104091733,107.79348184,22.54070955
20251104091734,107.79348048,22.54070973
20251104091735,107.79347901,22.54070998
20251104091736,107.79347306,22.54071098
20251104091737,107.79346531,22.54071335
20251104091738,107.79345695,22.54071716
20251104091739,107.79344833,22.54072176
20251104091740,107.79343970,22.54072611
20251104091741,107.79343128,22.54072925
20251104091742,107.79342263,22.54073046
20251104091743,107.79341531,22.54073025
20251104091744,107.79341111,22.54072983
20251104091745,107.79341141,22.54072978
20251104091746,107.79341150,22.54072975
20251104091747,107.79341156,22.54072980
20251104091748,107.79341203,22.54072990
20251104091749,107.79341656,22.54073040
20251104091750,107.79342313,22.54073106
20251104091751,107.79343081,22.54073056
20251104091752,107.79344033,22.54072861
20251104091753,107.79345040,22.54072643
20251104091754,107.79346045,22.54072573
20251104091755,107.79347050,22.54072656
20251104091756,107.79347840,22.54072775
20251104091757,107.79348336,22.54072853
20251104091758,107.79348708,22.54072861
20251104091759,107.79348718,22.54072868
20251104091800,107.79348720,22.54072866
20251104091801,107.79348714,22.54072870
20251104091802,107.79348551,22.54072868
20251104091803,107.79347926,22.54072850
20251104091804,107.79347021,22.54072821
20251104091805,107.79345978,22.54072806
20251104091806,107.79344945,22.54072806
20251104091807,107.79343921,22.54072803
20251104091808,107.79343130,22.54072808
20251104091809,107.79342623,22.54072813
20251104091810,107.79342375,22.54072815
20251104091811,107.79342079,22.54072818
20251104091812,107.79342093,22.54072821
20251104091813,107.79342095,22.54072815
20251104091814,107.79342091,22.54072821
20251104091815,107.79342095,22.54072825
20251104091816,107.79342098,22.54072819
20251104091817,107.79342098,22.54072821
20251104091818,107.79342100,22.54072819
20251104091819,107.79342100,22.54072821
20251104091820,107.79342101,22.54072818
20251104091821,107.79342100,22.54072819
20251104091822,107.79342098,22.54072819
20251104091823,107.79342098,22.54072819
20251104091824,107.79342098,22.54072819
20251104091825,107.79342096,22.54072819
20251104091826,107.79342095,22.54072821
20251104091827,107.79342100,22.54072819
20251104091828,107.79342096,22.54072819
20251104091829,107.79342098,22.54072819
20251104091830,107.79342098,22.54072821
20251104091831,107.79342095,22.54072821
20251104091832,107.79342096,22.54072821
20251104091833,107.79342101,22.54072823
20251104091834,107.79342096,22.54072821
20251104091835,107.79342098,22.54072819
20251104091836,107.79342098,22.54072819
20251104091837,107.79342101,22.54072819
20251104091838,107.79342100,22.54072823
20251104091839,107.79342098,22.54072823
20251104091840,107.79342098,22.54072821
20251104091841,107.79342098,22.54072821
20251104091842,107.79342096,22.54072819
20251104091843,107.79342098,22.54072821
20251104091844,107.79342101,22.54072823
20251104091845,107.79342098,22.54072821
20251104091846,107.79342103,22.54072821
20251104091847,107.79342098,22.54072823
20251104091848,107.79342101,22.54072823
20251104091849,107.79342070,22.54072823
20251104091850,107.79341730,22.54072826
20251104091851,107.79341073,22.54072826
20251104091852,107.79340175,22.54072826
20251104091853,107.79339158,22.54072818
20251104091854,107.79338108,22.54072821
20251104091855,107.79337054,22.54072819
20251104091856,107.79336009,22.54072825
20251104091857,107.79334956,22.54072823
20251104091859,107.79332851,22.54072823
20251104091901,107.79330749,22.54072826
20251104091903,107.79328645,22.54072830
20251104091904,107.79327591,22.54072833
20251104091905,107.79326546,22.54072843
20251104091907,107.79324450,22.54072830
20251104091908,107.79323391,22.54072841
20251104091909,107.79322338,22.54072855
20251104091910,107.79321296,22.54072860
20251104091911,107.79320243,22.54072851
20251104091912,107.79319190,22.54072850
20251104091913,107.79318139,22.54072846
20251104091914,107.79317086,22.54072848
20251104091915,107.79316038,22.54072845
20251104091916,107.79314969,22.54072855
20251104091917,107.79313920,22.54072845
20251104091919,107.79311828,22.54072850
20251104091920,107.79310770,22.54072853
20251104091922,107.79308673,22.54072861
20251104091923,107.79307618,22.54072860
20251104091924,107.79306565,22.54072873
20251104091925,107.79305523,22.54072875
20251104091926,107.79304474,22.54072871
20251104091927,107.79303425,22.54072875
20251104091928,107.79302365,22.54072876
20251104091929,107.79301313,22.54072891
20251104091930,107.79300268,22.54072880
20251104091931,107.79299215,22.54072875
20251104091932,107.79298163,22.54072876
20251104091933,107.79297113,22.54072888
20251104091934,107.79296068,22.54072888
20251104091935,107.79295060,22.54072883
20251104091936,107.79294811,22.54072893
20251104091937,107.79294796,22.54072888
20251104091938,107.79294798,22.54072890
20251104091939,107.79294803,22.54072888
20251104091940,107.79294798,22.54072886
20251104091941,107.79294800,22.54072890
20251104091942,107.79294801,22.54072885
20251104091943,107.79294801,22.54072893
20251104091944,107.79294800,22.54072890
20251104091945,107.79294796,22.54072893
20251104091946,107.79294805,22.54072890
20251104091947,107.79294743,22.54072893
20251104091948,107.79294051,22.54072891
20251104091949,107.79293410,22.54072925
20251104091950,107.79292349,22.54073038
20251104091951,107.79291339,22.54073245
20251104091952,107.79290356,22.54073568
20251104091953,107.79289435,22.54074043
20251104091954,107.79288548,22.54074561
20251104091955,107.79287610,22.54074981
20251104091956,107.79286603,22.54075173
20251104091957,107.79285553,22.54075063
20251104091958,107.79284620,22.54074628
20251104091959,107.79283846,22.54073965
20251104092000,107.79283335,22.54073113
20251104092001,107.79283151,22.54072163
20251104092002,107.79283293,22.54071195
20251104092003,107.79283746,22.54070321
20251104092004,107.79284475,22.54069628
20251104092005,107.79285401,22.54069181
20251104092006,107.79286435,22.54069001
20251104092007,107.79287436,22.54069053
20251104092008,107.79288168,22.54069150
20251104092009,107.79288641,22.54069225
20251104092010,107.79288943,22.54069278
20251104092011,107.79289480,22.54069421
20251104092012,107.79290199,22.54069663
20251104092013,107.79291035,22.54069998
20251104092014,107.79291945,22.54070256
20251104092015,107.79292913,22.54070361
20251104092016,107.79293891,22.54070363
20251104092017,107.79294626,22.54070358
20251104092018,107.79294863,22.54070350
20251104092019,107.79294856,22.54070345
20251104092020,107.79294853,22.54070348
20251104092021,107.79294851,22.54070345
20251104092022,107.79294841,22.54070350
20251104092023,107.79294873,22.54070350
20251104092024,107.79295011,22.54070354
20251104092025,107.79295010,22.54070356
20251104092026,107.79295013,22.54070353
20251104092027,107.79295011,22.54070354
20251104092028,107.79295016,22.54070351
20251104092029,107.79295018,22.54070351
20251104092030,107.79295011,22.54070351
20251104092031,107.79295015,22.54070354
20251104092032,107.79295018,22.54070348
20251104092033,107.79295015,22.54070353
20251104092034,107.79295011,22.54070353
20251104092035,107.79295016,22.54070353
20251104092036,107.79295020,22.54070353
20251104092037,107.79295016,22.54070351
20251104092038,107.79295015,22.54070353
20251104092039,107.79295015,22.54070354
20251104092040,107.79295015,22.54070354
20251104092041,107.79295015,22.54070351
20251104092042,107.79295016,22.54070353
20251104092043,107.79295016,22.54070351
20251104092044,107.79295013,22.54070353
20251104092045,107.79295013,22.54070350
20251104092046,107.79295016,22.54070353
20251104092047,107.79295013,22.54070351
20251104092048,107.79295015,22.54070353
20251104092049,107.79295016,22.54070353
20251104092050,107.79295016,22.54070354
20251104092051,107.79295015,22.54070353
20251104092052,107.79295016,22.54070351
20251104092053,107.79295018,22.54070351
20251104092054,107.79295011,22.54070353
20251104092055,107.79295010,22.54070351
20251104092056,107.79295015,22.54070354
20251104092057,107.79295013,22.54070353
20251104092058,107.79295013,22.54070350
20251104092059,107.79295011,22.54070351
20251104092100,107.79295015,22.54070351
20251104092101,107.79295018,22.54070354
20251104092102,107.79295010,22.54070351
20251104092103,107.79295013,22.54070351
20251104092104,107.79295006,22.54070350
20251104092105,107.79295010,22.54070350
20251104092106,107.79295008,22.54070350
20251104092107,107.79295011,22.54070350
20251104092108,107.79295006,22.54070353
20251104092109,107.79295008,22.54070351
20251104092110,107.79295034,22.54070353
20251104092111,107.79295408,22.54070351
20251104092112,107.79296125,22.54070353
20251104092113,107.79297171,22.54070346
20251104092114,107.79298226,22.54070346
20251104092115,107.79299281,22.54070356
20251104092116,107.79300333,22.54070360
20251104092117,107.79301396,22.54070363
20251104092118,107.79302443,22.54070356
20251104092119,107.79303495,22.54070346
20251104092120,107.79304545,22.54070354
20251104092121,107.79305591,22.54070356
20251104092122,107.79306641,22.54070353
20251104092123,107.79307681,22.54070340
20251104092124,107.79308533,22.54070336
20251104092125,107.79309276,22.54070341
20251104092126,107.79310054,22.54070343
20251104092128,107.79311633,22.54070340
20251104092129,107.79312423,22.54070335
20251104092130,107.79313226,22.54070328
20251104092132,107.79314808,22.54070321
20251104092133,107.79314808,22.54070321
20251104092134,107.79316386,22.54070313
20251104092135,107.79317173,22.54070308
20251104092136,107.79317965,22.54070308
20251104092138,107.79319555,22.54070305
20251104092139,107.79320348,22.54070310
20251104092140,107.79321140,22.54070306
20251104092141,107.79321925,22.54070295
20251104092142,107.79322721,22.54070293
20251104092143,107.79323513,22.54070293
20251104092144,107.79324306,22.54070303
20251104092145,107.79325089,22.54070305
20251104092146,107.79325881,22.54070313
20251104092147,107.79326670,22.54070300
20251104092148,107.79327460,22.54070290
20251104092149,107.79328249,22.54070288
20251104092150,107.79329045,22.54070286
20251104092151,107.79329830,22.54070285
20251104092152,107.79330631,22.54070288
20251104092153,107.79331424,22.54070281
20251104092154,107.79332213,22.54070270
20251104092155,107.79333005,22.54070265
20251104092156,107.79333790,22.54070266
20251104092157,107.79334580,22.54070268
20251104092158,107.79335371,22.54070273
20251104092159,107.79336161,22.54070275
20251104092200,107.79336951,22.54070268
20251104092201,107.79337744,22.54070260
20251104092202,107.79338536,22.54070256
20251104092203,107.79339330,22.54070255
20251104092204,107.79340125,22.54070258
20251104092205,107.79340911,22.54070260
20251104092206,107.79341700,22.54070251
20251104092207,107.79342178,22.54070245
20251104092208,107.79342156,22.54070248
20251104092209,107.79342153,22.54070250
20251104092210,107.79342153,22.54070250
20251104092211,107.79342150,22.54070251
20251104092212,107.79342150,22.54070250
20251104092213,107.79342151,22.54070246
20251104092214,107.79342151,22.54070248
20251104092215,107.79342148,22.54070248
20251104092216,107.79342153,22.54070250
20251104092217,107.79342148,22.54070250
20251104092218,107.79342151,22.54070250
20251104092219,107.79342153,22.54070246
20251104092220,107.79342148,22.54070248
20251104092221,107.79342153,22.54070245
20251104092222,107.79342153,22.54070250
20251104092223,107.79342151,22.54070248
20251104092224,107.79342148,22.54070248
20251104092225,107.79342150,22.54070246
20251104092226,107.79342146,22.54070250
20251104092227,107.79342150,22.54070246
20251104092228,107.79342150,22.54070241
20251104092229,107.79342150,22.54070250
20251104092230,107.79342150,22.54070245
20251104092231,107.79342146,22.54070250
20251104092232,107.79342148,22.54070246
20251104092233,107.79342148,22.54070248
20251104092234,107.79342146,22.54070250
20251104092235,107.79342150,22.54070246
20251104092236,107.79342145,22.54070245
20251104092237,107.79342148,22.54070246
20251104092238,107.79342145,22.54070243
20251104092239,107.79342150,22.54070245
20251104092240,107.79342146,22.54070246
20251104092241,107.79342143,22.54070246
20251104092242,107.79342146,22.54070245
20251104092243,107.79342145,22.54070246
20251104092244,107.79342148,22.54070246
20251104092245,107.79342143,22.54070245
20251104092246,107.79342141,22.54070243
20251104092247,107.79342148,22.54070246
20251104092248,107.79342145,22.54070248
20251104092249,107.79342140,22.54070250
20251104092250,107.79342145,22.54070246
20251104092251,107.79342145,22.54070250
20251104092252,107.79342143,22.54070248</textarea>
                        <div class="button-group">
                            <button id="drawTrackButton" class="btn btn-primary">üéØ ËΩ®Ëøπ</button>
                            <button id="showTrackPointsButton" class="btn btn-warning">üìç ÊâìÁÇπ</button>
                            <button id="clearTrackButton" class="btn btn-secondary">üßπ Ê∏ÖÁ©∫</button>
                        </div>
                        <!-- ËΩ®ËøπÈ¢úËâ≤ÈÄâÊã©Âô® -->
                        <div class="color-picker-container" style="margin-top:8px;">
                            <div style="display:flex;align-items:center;gap:8px;">
                                <div style="display:flex;align-items:center;gap:4px;">
                                    <label style="font-size:12px;">ËΩ®ËøπÁ∫øÈ¢úËâ≤:</label>
                                    <div id="trackLineColorPicker" class="color-picker"
                                         style="width:24px;height:24px;border:1px solid #ccc;cursor:pointer;background-color:#FF0000;"></div>
                                    <input type="color" id="trackLineColorInput" value="#FF0000" style="display:none;">
                                </div>
                                <div style="display:flex;align-items:center;gap:4px;">
                                    <label style="font-size:12px;">ËΩ®ËøπÁÇπÈ¢úËâ≤:</label>
                                    <div id="trackPointColorPicker" class="color-picker"
                                         style="width:24px;height:24px;border:1px solid #ccc;cursor:pointer;background-color:#68EAF3;"></div>
                                    <input type="color" id="trackPointColorInput" value="#68EAF3" style="display:none;">
                                </div>
                            </div>
                        </div>
                        <!-- ËΩ®ËøπÂõûÊîæ -->
                        <div class="split-section" style="margin-top:8px;">
                            <div class="playback-actions" style="display:flex;gap:8px;margin-bottom:8px;">
                                <button id="playbackToggleBtn" class="btn btn-primary">‚ñ∂Ô∏è ËΩ®ËøπÂõûÊîæ</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>

            <!-- Â∑•ÂÖ∑Ê†èÂàáÊç¢ÊåâÈíÆ -->
            <button class="panel-toggle-fixed" id="panelToggleFixed" title="Â±ïÂºÄ/Êî∂Áº©Â∑•ÂÖ∑Ê†è">‚óÄ‚ñ∂</button>

            <div class="status-info" id="statusInfo" style="display: none;">
                Â∞±Áª™
            </div>

            <div class="coordinate-info" id="coordinateInfo">
                ÁªèÂ∫¶: -, Á∫¨Â∫¶: -
            </div>

            <!-- Âè≥ÈîÆËèúÂçï -->
            <div class="context-menu" id="contextMenu">
                <div class="context-menu-item" id="getAddressMenuItem">üìç Ëé∑ÂèñÂú∞ÂùÄ</div>
            </div>

            <!-- ËΩ®ËøπÂõûÊîæÊí≠ÊîæÂô® -->
            <div class="playback-player" id="playbackPlayer" style="display: none;">
                <div class="player-header">
                    <span class="player-title">ËΩ®ËøπÂõûÊîæ</span>
                    <button class="player-close" id="playerCloseBtn" title="ÂÖ≥Èó≠">‚úï</button>
                </div>
                <div class="player-controls">
                    <button class="player-btn" id="playerPlayBtn" title="Êí≠Êîæ">‚ñ∂Ô∏è</button>
                    <button class="player-btn" id="playerStopBtn" title="ÂÅúÊ≠¢">‚èπÔ∏è</button>

                    <div class="player-speed">
                        <label>ÈÄüÂ∫¶:</label>
                        <input type="range" id="playerSpeedSlider" min="1" max="2048" step="1" value="1">
                        <span id="playerSpeedValue">1x</span>
                    </div>

                    <div class="player-progress">
                        <input type="range" id="playerProgressSlider" min="0" max="100" value="0">
                        <div id="playerTimeLabel" style="display: flex; flex-direction: column; align-items: center; min-width: 80px;">
                            <div id="currentTime" style="font-size: 12px; line-height: 1.2;">00:00:00</div>
                            <div id="totalTime" style="font-size: 10px; line-height: 1.2; color: #666;">00:00:00</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ÂÖ®Â±ÄÂèòÈáè
    let map;
    let currentMapType = 'street';
    let currentBaseLayer;
    let currentSatelliteLayer;

    // ÂõæÂ±ÇÁªÑ
    let outlineLayerGroup;
    let trackLayerGroup;
    let measureLayerGroup;
    let labelLayerGroup;

    // Ê†áÁ≠æÁõ∏ÂÖ≥
    let labelsEnabled = false;

    // ÂΩìÂâçÂá†‰ΩïÂõæÂΩ¢
    let currentOutline = null;
    let currentTrack = null;

    // ËΩ®ËøπÂõûÊîæÁõ∏ÂÖ≥
    let playbackState = {
        isPlaying: false,
        points: [],
        currentIndex: 0,
        speed: 1,
        marker: null,
        polyline: null,
        timer: null
    };

    // Êñ∞Êí≠ÊîæÂô®ÂÖÉÁ¥†
    let playbackPlayer;
    let playerCloseBtn;
    let playerPlayBtn;
    let playerStopBtn;
    let playerSpeedSlider;
    let playerSpeedValue;
    let playerProgressSlider;
    let playerTimeLabel;

    // ÊµãÈáèÁõ∏ÂÖ≥
    let measureState = {
        isActive: false,
        mode: '',
        points: [],
        tempLine: null,
        lines: [],
        markers: [],
        labels: [],
        polygon: null,
        areaLabel: null
    };

    // È¢úËâ≤ÈÖçÁΩÆ
    let currentOutlineColor = "#FFD700";
    let currentFillColor = "#FFFF00";
    let currentFillOpacity = 0.5;
    let currentTrackLineColor = "#FF0000";
    let currentTrackPointColor = "#68EAF3";

    // Áä∂ÊÄÅ‰ø°ÊÅØÂÆöÊó∂Âô®
    let statusMessageTimer = null;

    // Âè≥ÈîÆËèúÂçïÁõ∏ÂÖ≥
    let contextMenu = null;
    let getAddressMenuItem = null;
    let lastRightClickLatLng = null;

    // Â§öËæπÂΩ¢È¢úËâ≤ÊñπÊ°à
    const polygonColors = [
        { outline: "#FFD700", fill: "#FFFF00", opacity: 0.5 },
        { outline: "#FF0000", fill: "#FF6666", opacity: 0.5 },
        { outline: "#00FF00", fill: "#66FF66", opacity: 0.5 },
        { outline: "#0000FF", fill: "#6666FF", opacity: 0.5 },
        { outline: "#FF00FF", fill: "#FF66FF", opacity: 0.5 },
        { outline: "#00FFFF", fill: "#66FFFF", opacity: 0.5 },
        { outline: "#FFA500", fill: "#FFCC66", opacity: 0.5 },
        { outline: "#800080", fill: "#CC66CC", opacity: 0.5 },
        { outline: "#008000", fill: "#66CC66", opacity: 0.5 },
        { outline: "#800000", fill: "#CC6666", opacity: 0.5 }
    ];

    // ÊòæÁ§∫Êí≠ÊîæÂô®
    function showPlaybackPlayer() {
        if (playbackPlayer) {
            playbackPlayer.style.display = 'block';
            updatePlayerControls();
            
            // ÂêåÊ≠•ÊóßÁâàÊéßÂà∂Èù¢ÊùøÁä∂ÊÄÅÔºå‰øùÊåÅÂΩìÂâçÊí≠Êîæ‰ΩçÁΩÆ
            if (playerProgressSlider && playbackState.points.length > 0) {
                playerProgressSlider.disabled = false;
                playerProgressSlider.max = 100;
                // ‰∏çÈáçÁΩÆËøõÂ∫¶Êù°ÂÄºÔºå‰øùÊåÅÂΩìÂâçÊí≠Êîæ‰ΩçÁΩÆ
                if (playbackState.points.length > 0 && playbackState.currentIndex >= 0) {
                    const percentage = Math.round((playbackState.currentIndex / (playbackState.points.length - 1)) * 100);
                    playerProgressSlider.value = percentage;
                }
            }
            if (playerTimeLabel && playbackState.points.length > 0) {
                // Ê†πÊçÆÂΩìÂâçÊí≠Êîæ‰ΩçÁΩÆÊõ¥Êñ∞Êó∂Èó¥ÊòæÁ§∫
                if (playbackState.currentIndex >= 0 && playbackState.currentIndex < playbackState.points.length) {
                    const currentPoint = playbackState.points[playbackState.currentIndex];
                    const lastPoint = playbackState.points[playbackState.points.length - 1];
                    
                    if (currentPoint && lastPoint) {
                        function formatTime(timestamp) {
                            const date = parseTimestamp(timestamp);
                            if (!date) return '00:00:00';
                            
                            const hours = date.getHours().toString().padStart(2, '0');
                            const minutes = date.getMinutes().toString().padStart(2, '0');
                            const seconds = date.getSeconds().toString().padStart(2, '0');
                            return hours + ':' + minutes + ':' + seconds;
                        }
                        
                        const currentTime = formatTime(currentPoint.timestamp);
                        const totalTime = formatTime(lastPoint.timestamp);
                        
                        // ÂàÜÂà´Êõ¥Êñ∞‰∏§Ë°åÊó∂Èó¥ÊòæÁ§∫
                        const currentTimeElement = document.getElementById('currentTime');
                        const totalTimeElement = document.getElementById('totalTime');
                        
                        if (currentTimeElement) currentTimeElement.textContent = currentTime;
                        if (totalTimeElement) totalTimeElement.textContent = totalTime;
                    }
                }
            }
        }
    }

    // ÈöêËóèÊí≠ÊîæÂô®
    function hidePlaybackPlayer() {
        if (playbackPlayer) {
            playbackPlayer.style.display = 'none';
            // Âè™ÊöÇÂÅúÊí≠ÊîæÔºå‰∏çÈáçÁΩÆËøõÂ∫¶
            if (playbackState.isPlaying) {
                pausePlayback();
            }
            
            // ÈáçÁΩÆÊí≠ÊîæÂô®ÊéßÂà∂Áä∂ÊÄÅ
            updatePlayerControls();
        }
    }

    // Â∫îÁî®Êó∂Èó¥ËåÉÂõ¥ËøáÊª§
    function applyTimeRangeFilter() {
        const timeRangeText = document.getElementById('timeRangeInput').value.trim();
        
        if (!timeRangeText) {
            // Ê≤°ÊúâÊó∂Èó¥ËåÉÂõ¥Ôºå‰ΩøÁî®ÊâÄÊúâÁÇπ
            playbackState.filteredPoints = playbackState.points.slice();
            return;
        }
        
        // Ëß£ÊûêÊó∂Èó¥ËåÉÂõ¥
        const timeRangeMatch = timeRangeText.match(/^([\d-]+T[\d:]+)\s*-\s*([\d-]+T[\d:]+)$/);
        if (!timeRangeMatch) {
            // Ê†ºÂºè‰∏çÊ≠£Á°ÆÔºå‰ΩøÁî®ÊâÄÊúâÁÇπ
            playbackState.filteredPoints = playbackState.points.slice();
            return;
        }
        
        const startTimeStr = timeRangeMatch[1];
        const endTimeStr = timeRangeMatch[2];
        
        const startTime = new Date(startTimeStr);
        const endTime = new Date(endTimeStr);
        
        if (isNaN(startTime.getTime()) || isNaN(endTime.getTime())) {
            // Êó∂Èó¥Ëß£ÊûêÂ§±Ë¥•Ôºå‰ΩøÁî®ÊâÄÊúâÁÇπ
            playbackState.filteredPoints = playbackState.points.slice();
            return;
        }
        
        // ËøáÊª§ËΩ®ËøπÁÇπ
        playbackState.filteredPoints = playbackState.points.filter(point => {
            const pointTime = parseTimestamp(point.timestamp);
            return pointTime && pointTime >= startTime && pointTime <= endTime;
        });
        
        // Â¶ÇÊûúËøáÊª§ÂêéÁÇπÊï∞‰∏çË∂≥Ôºå‰ΩøÁî®ÊâÄÊúâÁÇπ
        if (playbackState.filteredPoints.length < 2) {
            playbackState.filteredPoints = playbackState.points.slice();
        }
    }

    // ÂàáÊç¢Êí≠ÊîæÁä∂ÊÄÅ
    function togglePlayback() {
        if (playbackState.isPlaying) {
            pausePlayback();
        } else {
            // ÂºÄÂßãÊí≠ÊîæÂâçÂ∫îÁî®Êó∂Èó¥ËåÉÂõ¥ËøáÊª§
            applyTimeRangeFilter();
            startPlayback();
        }
        
        // Êõ¥Êñ∞Êí≠ÊîæÂô®ÊéßÂà∂Áä∂ÊÄÅ
        updatePlayerControls();
    }

    // Êõ¥Êñ∞Êí≠ÊîæÂô®ÊéßÂà∂Áä∂ÊÄÅ
    function updatePlayerControls() {
        const hasTrack = playbackState.points && playbackState.points.length > 0;
        
        if (playerPlayBtn) playerPlayBtn.disabled = !hasTrack;
        if (playerStopBtn) playerStopBtn.disabled = !hasTrack;
        if (playerSpeedSlider) playerSpeedSlider.disabled = !hasTrack;
        if (playerProgressSlider) playerProgressSlider.disabled = !hasTrack;
        
        if (playbackState.isPlaying) {
            if (playerPlayBtn) playerPlayBtn.innerHTML = '‚è∏Ô∏è';
            if (playerPlayBtn) playerPlayBtn.title = 'ÊöÇÂÅú';
        } else {
            if (playerPlayBtn) playerPlayBtn.innerHTML = '‚ñ∂Ô∏è';
            if (playerPlayBtn) playerPlayBtn.title = 'Êí≠Êîæ';
        }
    }

    // ÂàùÂßãÂåñÂú∞Âõæ
    function initMap() {
        console.log('initMap called');

        // ÂàõÂª∫Âú∞Âõæ
        map = L.map('map', {
            center: [39.9042, 116.4074], // Âåó‰∫¨
            zoom: 11,
            zoomControl: false,
            attributionControl: false
        });

        console.log('Map created:', map);

        // ‰∏çÊ∑ªÂä†Áº©ÊîæÊéß‰ª∂Ôºå‰ΩøÁî®ÊªöËΩÆÁº©ÊîæÂú∞Âõæ

        // ÂàùÂßãÂåñÂõæÂ±ÇÁªÑ
        outlineLayerGroup = L.layerGroup().addTo(map);
        trackLayerGroup = L.layerGroup().addTo(map);
        measureLayerGroup = L.layerGroup().addTo(map);
        // ÂÖà‰∏çÊ∑ªÂä†Ê†áÁ≠æÂõæÂ±ÇÔºåÁ®çÂêéÁ°Æ‰øùÂÆÉÂú®ÊúÄ‰∏äÂ±Ç
        labelLayerGroup = L.layerGroup();
        map.addLayer(labelLayerGroup);

        console.log('Layer groups created');

        // ÂàùÂßãÂåñÂú∞ÂõæÁ±ªÂûã
        currentMapType = 'satellite';

        // Ê∑ªÂä†Âü∫Á°ÄÂõæÂ±Ç
        addBaseLayers();

        // ÁªëÂÆö‰∫ã‰ª∂
        bindMapEvents();

        // Êõ¥Êñ∞Áä∂ÊÄÅ
        updateStatus('Âú∞ÂõæÂàùÂßãÂåñÂÆåÊàê');

        console.log('initMap completed');

        // Á°Æ‰øùÊ†áÁ≠æÂõæÂ±ÇÂú®ÊúÄ‰∏äÂ±Ç
        map.removeLayer(labelLayerGroup);
        map.addLayer(labelLayerGroup);

        // ÂàùÂßãÂåñÊñ∞Êí≠ÊîæÂô®ÂÖÉÁ¥†
        playbackPlayer = document.getElementById('playbackPlayer');
        playerCloseBtn = document.getElementById('playerCloseBtn');
        playerPlayBtn = document.getElementById('playerPlayBtn');
        playerStopBtn = document.getElementById('playerStopBtn');
        playerSpeedSlider = document.getElementById('playerSpeedSlider');
        playerSpeedValue = document.getElementById('playerSpeedValue');
        playerProgressSlider = document.getElementById('playerProgressSlider');
        playerTimeLabel = document.getElementById('playerTimeLabel');

        // ÂàùÂßãÂåñÈÄüÂ∫¶ÊòæÁ§∫
        if (playerSpeedValue) {
            playerSpeedValue.textContent = '1x';
        }

        // ÂàùÂßãÂåñÊí≠ÊîæÂô®ÊåâÈíÆÁä∂ÊÄÅÔºà‰ΩøÁî®updatePlayerControlsÂáΩÊï∞Ôºâ
        updatePlayerControls();
    }

    // Ê∑ªÂä†Âü∫Á°ÄÂõæÂ±Ç
    function addBaseLayers() {
        console.log('addBaseLayers called');

        // Â§©Âú∞ÂõæË°óÈÅìÂõæ
        const tk = TIANDITU_MAP_TK;

        // Â§©Âú∞ÂõæË°óÈÅìÂõæ - ‰ΩøÁî®XYZÁì¶ÁâáÊúçÂä°
        const vecLayer = L.tileLayer(`https://t{s}.tianditu.gov.cn/vec_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=vec&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`, {
            attribution: '¬© Â§©Âú∞Âõæ',
            maxZoom: 18,
            tileSize: 256,
            subdomains: ['0', '1', '2', '3', '4', '5', '6', '7']
        });

        // Â§©Âú∞ÂõæË°óÈÅìÂõæÊ†áÊ≥®
        const cvaLayer = L.tileLayer(`https://t{s}.tianditu.gov.cn/cva_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cva&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`, {
            attribution: '¬© Â§©Âú∞Âõæ',
            maxZoom: 18,
            tileSize: 256,
            subdomains: ['0', '1', '2', '3', '4', '5', '6', '7']
        });

        // Â§©Âú∞ÂõæÂç´ÊòüÂõæ - ‰ΩøÁî®XYZÁì¶ÁâáÊúçÂä°
        const imgLayer = L.tileLayer(`https://t{s}.tianditu.gov.cn/img_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=img&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`, {
            attribution: '¬© Â§©Âú∞Âõæ',
            maxZoom: 18,
            tileSize: 256,
            subdomains: ['0', '1', '2', '3', '4', '5', '6', '7']
        });

        // Â§©Âú∞ÂõæÂç´ÊòüÂõæÊ†áÊ≥®
        const ciaLayer = L.tileLayer(`https://t{s}.tianditu.gov.cn/cia_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cia&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`, {
            attribution: '¬© Â§©Âú∞Âõæ',
            maxZoom: 18,
            tileSize: 256,
            subdomains: ['0', '1', '2', '3', '4', '5', '6', '7']
        });

        // Ê∑ªÂä†ÂõæÂ±ÇÂä†ËΩΩ‰∫ã‰ª∂ÁõëÂê¨
        vecLayer.on('load', function() {
            console.log('Â§©Âú∞ÂõæË°óÈÅìÂõæÂ±ÇÂä†ËΩΩÂÆåÊàê');
            updateStatus('Â§©Âú∞ÂõæË°óÈÅìÂõæÂ±ÇÂä†ËΩΩÂÆåÊàê');
        });

        imgLayer.on('load', function() {
            console.log('Â§©Âú∞ÂõæÂç´ÊòüÂõæÂ±ÇÂä†ËΩΩÂÆåÊàê');
            updateStatus('Â§©Âú∞ÂõæÂç´ÊòüÂõæÂ±ÇÂä†ËΩΩÂÆåÊàê');
        });

        vecLayer.on('error', function(e) {
            console.error('Â§©Âú∞ÂõæË°óÈÅìÂõæÂ±ÇÂä†ËΩΩÈîôËØØ:', e);
            updateStatus('Â§©Âú∞ÂõæË°óÈÅìÂõæÂ±ÇÂä†ËΩΩÂ§±Ë¥•');
        });

        imgLayer.on('error', function(e) {
            console.error('Â§©Âú∞ÂõæÂç´ÊòüÂõæÂ±ÇÂä†ËΩΩÈîôËØØ:', e);
            updateStatus('Â§©Âú∞ÂõæÂç´ÊòüÂõæÂ±ÇÂä†ËΩΩÂ§±Ë¥•');
        });

        // ÂàõÂª∫ÂõæÂ±ÇÁªÑ
        currentBaseLayer = L.layerGroup([vecLayer, cvaLayer]);
        currentSatelliteLayer = L.layerGroup([imgLayer, ciaLayer]);

        console.log('currentBaseLayer created:', currentBaseLayer);
        console.log('currentSatelliteLayer created:', currentSatelliteLayer);

        // ÈªòËÆ§ÊòæÁ§∫Âç´ÊòüÂõæ
        currentSatelliteLayer.addTo(map);

        console.log('Satellite layer added to map');
        console.log('currentMapType initialized to: satellite');
    }

    // ÁªëÂÆöÂú∞Âõæ‰∫ã‰ª∂
    function bindMapEvents() {
        // Èº†Ê†áÁßªÂä®‰∫ã‰ª∂ - Êõ¥Êñ∞ÂùêÊ†áÊòæÁ§∫
        map.on('mousemove', function(e) {
            const lat = e.latlng.lat.toFixed(6);
            const lng = e.latlng.lng.toFixed(6);
            const coordinateInfo = document.getElementById('coordinateInfo');
            if (coordinateInfo) {
                coordinateInfo.textContent = `ÁªèÂ∫¶: ${lng}, Á∫¨Â∫¶: ${lat}`;
            }
        });

        // Âè≥ÈîÆËèúÂçï‰∫ã‰ª∂
        map.on('contextmenu', function(e) {
            // Â¶ÇÊûúÂú®ÊµãÈáèÊ®°Âºè‰∏ãÔºå‰∏çÊòæÁ§∫Âè≥ÈîÆËèúÂçïÔºàËÆ©ÊµãÈáèÊ®°ÂºèÁöÑÂè≥ÈîÆÂ§ÑÁêÜÊé•ÁÆ°Ôºâ
            if (measureState.isActive) {
                return;
            }

            // ‰øùÂ≠òÂè≥ÈîÆÁÇπÂáªÁöÑÂùêÊ†á
            lastRightClickLatLng = e.latlng;

            // ÊòæÁ§∫Âè≥ÈîÆËèúÂçï
            showContextMenu(e.originalEvent);

            // ÈòªÊ≠¢ÈªòËÆ§Âè≥ÈîÆËèúÂçï
            if (e.originalEvent) {
                e.originalEvent.preventDefault();
                e.originalEvent.stopPropagation();
            }

            return false;
        });

        // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÈöêËóèÂè≥ÈîÆËèúÂçï
        map.on('click', function() {
            hideContextMenu();
        });

        // Âú∞ÂõæÊéß‰ª∂‰∫ã‰ª∂
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const resetViewBtn = document.getElementById('resetViewBtn');

        if (zoomInBtn) {
            zoomInBtn.addEventListener('click', function() {
                map.zoomIn();
            });
        }

        if (zoomOutBtn) {
            zoomOutBtn.addEventListener('click', function() {
                map.zoomOut();
            });
        }

        if (resetViewBtn) {
            resetViewBtn.addEventListener('click', function() {
                map.setView([39.9042, 116.4074], 11);
            });
        }
    }

    // Áä∂ÊÄÅÊõ¥Êñ∞
    function updateStatus(message) {
        const statusInfo = document.getElementById('statusInfo');
        if (statusInfo) {
            // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®
            if (statusMessageTimer) {
                clearTimeout(statusMessageTimer);
                statusMessageTimer = null;
            }
            
            statusInfo.textContent = message;
            statusInfo.style.display = 'block';
            
            // ËÆæÁΩÆÊñ∞ÁöÑÂÆöÊó∂Âô®
            statusMessageTimer = setTimeout(() => {
                statusInfo.style.display = 'none';
                statusMessageTimer = null;
            }, 1000);
        }
    }

    // Âè≥ÈîÆËèúÂçïÂäüËÉΩÂáΩÊï∞
    function showContextMenu(event) {
        if (!contextMenu) {
            contextMenu = document.getElementById('contextMenu');
            getAddressMenuItem = document.getElementById('getAddressMenuItem');
            
            // ÁªëÂÆöËèúÂçïÈ°πÁÇπÂáª‰∫ã‰ª∂
            if (getAddressMenuItem) {
                getAddressMenuItem.addEventListener('click', handleGetAddress);
            }
        }

        if (contextMenu && event) {
            // ËÆæÁΩÆËèúÂçï‰ΩçÁΩÆ
            contextMenu.style.left = event.pageX + 'px';
            contextMenu.style.top = event.pageY + 'px';
            contextMenu.style.display = 'block';
        }
    }

    function hideContextMenu() {
        if (contextMenu) {
            contextMenu.style.display = 'none';
        }
    }

    // Â§ÑÁêÜËé∑ÂèñÂú∞ÂùÄÂäüËÉΩ
    function handleGetAddress() {
        if (!lastRightClickLatLng) {
            updateStatus('Ê≤°ÊúâÊúâÊïàÁöÑÂùêÊ†áÁÇπ');
            return;
        }

        const lat = lastRightClickLatLng.lat;
        const lng = lastRightClickLatLng.lng;

        // Ë∞ÉÁî®Â§©Âú∞ÂõæÈÄÜÂú∞ÁêÜÁºñÁ†ÅAPI
        getAddressFromTianDiTu(lat, lng);
        
        // ÈöêËóèÂè≥ÈîÆËèúÂçï
        hideContextMenu();
    }

    // Â§©Âú∞ÂõæÈÄÜÂú∞ÁêÜÁºñÁ†Å
    function getAddressFromTianDiTu(lat, lng) {
        // ‰ΩøÁî®Â§©Âú∞ÂõæÈÄÜÂú∞ÁêÜÁºñÁ†ÅAPIÔºå‰ΩøÁî®ÂêéÂè∞tk
        const tk = TIANDITU_MAP_TK;
        const postStr = `{'lon':${lng},'lat':${lat},'ver':1}`;
        const url = `https://api.tianditu.gov.cn/geocoder?postStr=${postStr}&type=geocode&tk=${tk}`;

        console.log('ËØ∑Ê±ÇURL:', url);
        console.log('ÂùêÊ†á:', lat, lng);
        console.log('postStr:', postStr);
        updateStatus('Ê≠£Âú®Ëé∑ÂèñÂú∞ÂùÄ‰ø°ÊÅØ...');

        // Âà§Êñ≠ÊòØÂê¶Âú®Êú¨Âú∞Êñá‰ª∂ÁéØÂ¢É‰∏≠ËøêË°å
        const isLocalFile = window.location.protocol === 'file:';
        
        if (isLocalFile) {
            // Êú¨Âú∞Êñá‰ª∂ÁéØÂ¢ÉÔºö‰ΩøÁî®JSONPÊñπÂºè
            console.log('Ê£ÄÊµãÂà∞Êú¨Âú∞Êñá‰ª∂ËÆøÈóÆÔºå‰ΩøÁî®JSONPÊñπÂºè');
            tryJSONPApproach(lat, lng, tk);
        } else {
            // WebÂÆπÂô®ÁéØÂ¢ÉÔºöÁõ¥Êé•ÂèëÈÄÅGETËØ∑Ê±Ç
            console.log('WebÂÆπÂô®ÁéØÂ¢ÉÔºåÁõ¥Êé•ÂèëÈÄÅGETËØ∑Ê±Ç');
            fetch(url)
            .then(response => {
                console.log('ÂìçÂ∫îÁä∂ÊÄÅ:', response.status, response.statusText);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('ÂìçÂ∫îÊï∞ÊçÆ:', data);
                handleTiandituResponse(lat, lng, data);
            })
            .catch(error => {
                console.error('ÈÄÜÂú∞ÁêÜÁºñÁ†ÅËØ∑Ê±ÇÂ§±Ë¥•:', error);
                // Â§±Ë¥•ÂêéÁõ¥Êé•‰ΩøÁî®Â§áÁî®ÊñπÊ°àÊòæÁ§∫ÂùêÊ†á
                useFallbackAddress(lat, lng);
            });
        }
    }

    // ‰∏ìÈó®‰∏∫Êú¨Âú∞Êñá‰ª∂ÁéØÂ¢ÉËÆæËÆ°ÁöÑÊñπÊ°à
    function tryJSONPApproach(lat, lng, tk) {
        // Êú¨Âú∞Êñá‰ª∂ÁéØÂ¢É‰ΩøÁî®ÁôæÂ∫¶Âú∞ÂõæAPI - JSONPÊñπÂºèËé∑ÂèñÂú∞ÂùÄ‰ø°ÊÅØ
        const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
        
        // ÁôæÂ∫¶Âú∞ÂõæAPIÈÖçÁΩÆ - ‰ΩøÁî®È°∂ÈÉ®ÂÆö‰πâÁöÑÂ∏∏Èáè
        const baiduAk = BAIDU_MAP_AK;
        const url = `https://api.map.baidu.com/reverse_geocoding/v3/?ak=${baiduAk}&extensions_poi=1&entire_poi=1&sort_strategy=distance&output=json&coordtype=wgs84ll&location=${lat},${lng}&callback=${callbackName}`;
        
        console.log('ÁôæÂ∫¶Âú∞ÂõæJSONPËØ∑Ê±ÇURL:', url);
        
        // ÂàõÂª∫ÂÖ®Â±ÄÂõûË∞ÉÂáΩÊï∞
        window[callbackName] = function(data) {
            console.log('ÁôæÂ∫¶Âú∞ÂõæJSONPÂìçÂ∫îÊï∞ÊçÆ:', data);
            cleanup();
            
            if (data && data.status === 0 && data.result) {
                // Â§ÑÁêÜÁôæÂ∫¶Âú∞ÂõæÂìçÂ∫îÊï∞ÊçÆÔºåËΩ¨Êç¢‰∏∫Â§©Âú∞ÂõæÊ†ºÂºè
                const addressData = {
                    result: {
                        formatted_address: data.result.formatted_address || data.result.address
                    }
                };
                
                // Â¶ÇÊûúÊúâPOI‰ø°ÊÅØÔºåÊ∑ªÂä†Âà∞Âú∞ÂùÄ‰∏≠
                if (data.result.pois && data.result.pois.length > 0) {
                    const nearestPoi = data.result.pois[0];
                    addressData.result.formatted_address += ` (${nearestPoi.name})`;
                }
                
                handleTiandituResponse(lat, lng, addressData);
            } else {
                console.log('ÁôæÂ∫¶Âú∞ÂõæJSONPËøîÂõûÊï∞ÊçÆÊ†ºÂºè‰∏çÊ≠£Á°ÆÊàñÁä∂ÊÄÅÈîôËØØÔºå‰ΩøÁî®Â§áÁî®ÊñπÊ°à');
                useFallbackAddress(lat, lng);
            }
        };
        
        // ÂàõÂª∫scriptÊ†áÁ≠æ
        const script = document.createElement('script');
        script.src = url;
        
        let timeoutId;
        
        function cleanup() {
            if (timeoutId) clearTimeout(timeoutId);
            if (window[callbackName]) delete window[callbackName];
            if (script.parentNode) document.body.removeChild(script);
        }
        
        script.onerror = function() {
            cleanup();
            console.log('ÁôæÂ∫¶Âú∞ÂõæJSONPËØ∑Ê±ÇÂ§±Ë¥•Ôºå‰ΩøÁî®Â§áÁî®ÊñπÊ°à');
            useFallbackAddress(lat, lng);
        };
        
        // ËÆæÁΩÆË∂ÖÊó∂
        timeoutId = setTimeout(() => {
            cleanup();
            console.log('ÁôæÂ∫¶Âú∞ÂõæJSONPËØ∑Ê±ÇË∂ÖÊó∂Ôºå‰ΩøÁî®Â§áÁî®ÊñπÊ°à');
            useFallbackAddress(lat, lng);
        }, 8000); // 8ÁßíË∂ÖÊó∂
        
        document.body.appendChild(script);
    }

    // Â§ÑÁêÜÂ§©Âú∞ÂõæAPIÂìçÂ∫îÊï∞ÊçÆ
    function handleTiandituResponse(lat, lng, data) {
        if (data && data.result && data.result.formatted_address) {
            const address = data.result.formatted_address;
            showAddressLabel(lat, lng, address);
            updateStatus('Âú∞ÂùÄËé∑ÂèñÊàêÂäü');
        } else if (data && data.msg) {
            updateStatus(`Âú∞ÂùÄËé∑ÂèñÂ§±Ë¥•Ôºö${data.msg}`);
        } else {
            updateStatus('Âú∞ÂùÄËé∑ÂèñÂ§±Ë¥•ÔºöÊú™ÊâæÂà∞Âú∞ÂùÄ‰ø°ÊÅØ');
        }
    }

    // ÊúÄÁªàÂ§áÁî®ÊñπÊ°àÔºöÊòæÁ§∫ÂùêÊ†á‰ø°ÊÅØ
    function useFallbackAddress(lat, lng) {
        const fallbackAddress = `ÂùêÊ†á‰ΩçÁΩÆÔºö${lng.toFixed(6)}, ${lat.toFixed(6)}`;
        showAddressLabel(lat, lng, fallbackAddress);
        updateStatus('Âú∞ÂùÄÊúçÂä°ÊöÇ‰∏çÂèØÁî®ÔºåÊòæÁ§∫ÂùêÊ†á‰ø°ÊÅØ');
    }

    // ÊòæÁ§∫Âú∞ÂùÄÊ†áÁ≠æ
    function showAddressLabel(lat, lng, address) {
        // ÂàõÂª∫Âú∞ÂùÄÊ†áÁ≠æ
        const label = L.marker([lat, lng], {
            icon: L.divIcon({
                className: 'address-label',
                html: `<div style="background: white; border: 2px solid #007bff; border-radius: 6px; padding: 8px 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); font-size: 12px; max-width: 300px; word-wrap: break-word;">
                        <div style="font-weight: bold; color: #007bff; margin-bottom: 4px;">üìç Âú∞ÂùÄ‰ø°ÊÅØ</div>
                        <div style="color: #333;">${address}</div>
                        <div style="font-size: 10px; color: #666; margin-top: 4px;">
                            ÂùêÊ†á: ${lng.toFixed(6)}, ${lat.toFixed(6)}
                        </div>
                     </div>`,
                iconSize: [300, 'auto'],
                iconAnchor: [150, 0]
            })
        }).addTo(labelLayerGroup);

        // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂ÔºåÁÇπÂáªÂèØ‰ª•Âà†Èô§Ê†áÁ≠æ
        label.on('click', function() {
            labelLayerGroup.removeLayer(label);
            updateStatus('Âú∞ÂùÄÊ†áÁ≠æÂ∑≤Âà†Èô§');
        });

        // 3ÁßíÂêéËá™Âä®ÈöêËóèÊ†áÁ≠æ
        setTimeout(() => {
            if (labelLayerGroup.hasLayer(label)) {
                labelLayerGroup.removeLayer(label);
            }
        }, 10000); // 10ÁßíÂêéËá™Âä®ÈöêËóè
    }

    // Ê†áÁ≠æÈ°µÂàáÊç¢
    function bindTabEvents() {
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');

        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const targetTab = this.dataset.tab;

                // ÁßªÈô§ÊâÄÊúâÊ¥ªÂä®Áä∂ÊÄÅ
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));

                // Ê∑ªÂä†Ê¥ªÂä®Áä∂ÊÄÅ
                this.classList.add('active');
                document.getElementById(targetTab + '-tab').classList.add('active');
            });
        });
    }

    // È¢úËâ≤ÈÄâÊã©Âô®‰∫ã‰ª∂
    function bindColorPickerEvents() {
        // ËΩ®ËøπÁ∫øÈ¢úËâ≤
        const trackLineColorPicker = document.getElementById('trackLineColorPicker');
        const trackLineColorInput = document.getElementById('trackLineColorInput');

        if (trackLineColorPicker && trackLineColorInput) {
            trackLineColorPicker.addEventListener('click', function() {
                trackLineColorInput.click();
            });

            trackLineColorInput.addEventListener('change', function() {
                currentTrackLineColor = this.value;
                trackLineColorPicker.style.backgroundColor = currentTrackLineColor;
            });
        }

        // ËΩ®ËøπÁÇπÈ¢úËâ≤
        const trackPointColorPicker = document.getElementById('trackPointColorPicker');
        const trackPointColorInput = document.getElementById('trackPointColorInput');

        if (trackPointColorPicker && trackPointColorInput) {
            trackPointColorPicker.addEventListener('click', function() {
                trackPointColorInput.click();
            });

            trackPointColorInput.addEventListener('change', function() {
                currentTrackPointColor = this.value;
                trackPointColorPicker.style.backgroundColor = currentTrackPointColor;
            });
        }
    }

    // Â∑•ÂÖ∑ÊåâÈíÆ‰∫ã‰ª∂
    function bindToolEvents() {
        // ÊµãË∑ùÊåâÈíÆ
        const measureDistanceBtn = document.getElementById('measureDistanceBtn');
        if (measureDistanceBtn) {
            measureDistanceBtn.addEventListener('click', startMeasureDistance);
        }

        // ÊµãÈù¢ÊåâÈíÆ
        const measureAreaBtn = document.getElementById('measureAreaBtn');
        if (measureAreaBtn) {
            measureAreaBtn.addEventListener('click', startMeasureArea);
        }

        // Âú∞ÂõæÁ±ªÂûãÂàáÊç¢
        const mapTypeBtn = document.getElementById('mapTypeBtn');
        if (mapTypeBtn) {
            mapTypeBtn.addEventListener('click', toggleMapType);
        }

        // Ê∏ÖÁ©∫ÊâÄÊúâ
        const clearAllBtn = document.getElementById('clearAllBtn');
        if (clearAllBtn) {
            clearAllBtn.addEventListener('click', clearAll);
        }

        // ËΩ®ËøπÁõ∏ÂÖ≥ÊåâÈíÆ
        const drawTrackBtn = document.getElementById('drawTrackButton');
        const showTrackPointsBtn = document.getElementById('showTrackPointsButton');
        const clearTrackBtn = document.getElementById('clearTrackButton');

        if (drawTrackBtn) drawTrackBtn.addEventListener('click', drawTrack);
        if (showTrackPointsBtn) showTrackPointsBtn.addEventListener('click', showTrackPoints);
        if (clearTrackBtn) clearTrackBtn.addEventListener('click', clearTrack);

        // ËΩ®ËøπÂõûÊîæÂàáÊç¢ÊåâÈíÆ - ÂßãÁªàÂèØÁÇπÂáªÔºåÁÇπÂáªÊó∂ËøõË°åÂàùÂßãÂåñÊ£ÄÊü•
        const playbackToggleBtn = document.getElementById('playbackToggleBtn');
        if (playbackToggleBtn) {
            // ÁßªÈô§disabledÂ±ûÊÄßÔºå‰ΩøÊåâÈíÆÂßãÁªàÂèØÁÇπÂáª
            playbackToggleBtn.disabled = false;
            
            playbackToggleBtn.addEventListener('click', function() {
                // Â¶ÇÊûúÊí≠ÊîæÂô®Â∑≤ÊòæÁ§∫ÔºåÂàôÈöêËóè
                if (playbackPlayer.style.display === 'block') {
                    hidePlaybackPlayer();
                    return;
                }
                
                // Ê£ÄÊü•ÊòØÂê¶ÊúâËΩ®ËøπÊï∞ÊçÆ
                if (!playbackState.points || playbackState.points.length === 0) {
                    // Â∞ùËØï‰ªétextareaËß£ÊûêËΩ®ËøπÊï∞ÊçÆ
                    const trackTextarea = document.getElementById('trackTextarea');
                    if (trackTextarea && trackTextarea.value.trim()) {
                        try {
                            parseTrackPoints(trackTextarea.value.trim());
                        } catch (e) {
                            updateStatus('ËΩ®ËøπÊï∞ÊçÆÊ†ºÂºèÈîôËØØÔºåÊó†Ê≥ïÊâìÂºÄÊí≠ÊîæÂô®');
                            return;
                        }
                    }
                }
                
                // ÂÜçÊ¨°Ê£ÄÊü•ÊòØÂê¶ÊúâÊúâÊïàËΩ®ËøπÊï∞ÊçÆ
                if (!playbackState.points || playbackState.points.length === 0) {
                    updateStatus('Ê≤°ÊúâÊúâÊïàÁöÑËΩ®ËøπÊï∞ÊçÆÔºåÊó†Ê≥ïÊâìÂºÄÊí≠ÊîæÂô®');
                    return;
                }
                
                // ÊòæÁ§∫Êí≠ÊîæÂô®
                showPlaybackPlayer();
            });
        }

        // Êñ∞Êí≠ÊîæÂô®ÊéßÂà∂‰∫ã‰ª∂
        if (playerCloseBtn) playerCloseBtn.addEventListener('click', hidePlaybackPlayer);
        if (playerPlayBtn) playerPlayBtn.addEventListener('click', togglePlayback);

        if (playerStopBtn) playerStopBtn.addEventListener('click', stopPlayback);
        
        // ÂàùÂßãÂåñÊí≠ÊîæÂô®ÊåâÈíÆÁä∂ÊÄÅ
        updatePlayerControls();
        
        // ÈÄüÂ∫¶ÊªëÂùó
        if (playerSpeedSlider) {
            playerSpeedSlider.addEventListener('input', function() {
                // Â∞ÜÊªëÂùóÂÄºËΩ¨Êç¢‰∏∫ÊåáÊï∞ÂÄçÊï∞Ôºö1,2,4,8,16,32,64,128,256,512,1024
                const sliderValue = parseInt(this.value);
                let speed;
                
                if (sliderValue === 1) {
                    speed = 1;
                } else {
                    // ËÆ°ÁÆó2ÁöÑÂπÇÊ¨°Ôºö2^0=1, 2^1=2, 2^2=4, ..., 2^10=1024
                    const power = Math.floor(Math.log2(sliderValue));
                    speed = Math.pow(2, power);
                }
                
                // ÈôêÂà∂ÊúÄÂ§ßÂÄº
                speed = Math.min(speed, 1024);
                
                // Á°Æ‰øùÊòØ2ÁöÑÂπÇÊ¨°ÂÄçÊï∞Ôºö1,2,4,8,16,32,64,128,256,512,1024
                const validSpeeds = [1, 2, 4, 8, 16, 32, 64, 128, 256, 512, 1024];
                speed = validSpeeds.find(s => s >= speed) || 1024;
                
                playbackState.speed = speed;
                if (playerSpeedValue) playerSpeedValue.textContent = speed + 'x';
                
                // Â¶ÇÊûúÊ≠£Âú®Êí≠ÊîæÔºåÂ∫îÁî®Êñ∞ÈÄüÂ∫¶Ôºà‰øùÊåÅÂΩìÂâç‰ΩçÁΩÆÁªßÁª≠Êí≠ÊîæÔºâ
                if (playbackState.isPlaying) {
                    // ‰∏çÈúÄË¶ÅÊöÇÂÅúÂíåÈáçÊñ∞ÂºÄÂßãÔºåÈÄüÂ∫¶‰ºöÂú®‰∏ã‰∏Ä‰∏™ÁÇπËá™Âä®Â∫îÁî®
                    updateStatus(`Êí≠ÊîæÈÄüÂ∫¶Â∑≤Ë∞ÉÊï¥‰∏∫ ${speed}x`);
                }
            });
        }
        
        // ËøõÂ∫¶ÊªëÂùó
        if (playerProgressSlider) {
            playerProgressSlider.addEventListener('input', function() {
                const percentage = parseInt(this.value);
                if (playbackState.filteredPoints && playbackState.filteredPoints.length > 0) {
                    const index = Math.floor((percentage / 100) * (playbackState.filteredPoints.length - 1));
                    const wasPlaying = playbackState.isPlaying; // ËÆ∞ÂΩïÊí≠ÊîæÁä∂ÊÄÅ
                    jumpToPoint(index);
                    // Â¶ÇÊûú‰πãÂâçÂú®Êí≠ÊîæÔºåÁªßÁª≠Êí≠Êîæ
                    if (wasPlaying) {
                        setTimeout(() => {
                            playbackState.isPlaying = true;
                            playbackNextPoint();
                        }, 100);
                    }
                }
            });
        }

        // ËΩ®ËøπÊñáÊú¨Ê°Ü‰∫ã‰ª∂ÁõëÂê¨ - Ê†πÊçÆÂÜÖÂÆπÂêØÁî®/Á¶ÅÁî®ÊåâÈíÆ
        const trackTextarea = document.getElementById('trackTextarea');
        if (trackTextarea) {
            function updateTrackButtons() {
                const hasContent = trackTextarea.value.trim().length > 0;
                if (drawTrackBtn) drawTrackBtn.disabled = !hasContent;
                if (showTrackPointsBtn) showTrackPointsBtn.disabled = !hasContent;
                if (clearTrackBtn) clearTrackBtn.disabled = !hasContent;
                
                // Â¶ÇÊûúÊúâËΩ®ËøπÂÜÖÂÆπÔºåÂ∞ùËØïËá™Âä®Ëß£Êûê‰ª•ÂêØÁî®Êí≠ÊîæÊåâÈíÆ
                if (hasContent) {
                    try {
                        const trackText = trackTextarea.value.trim();
                        const lines = trackText.split('\n');
                        let hasValidTrackData = false;
                        
                        // Ê£ÄÊü•ÊòØÂê¶ÊúâÊúâÊïàÁöÑËΩ®ËøπÊï∞ÊçÆÊ†ºÂºè
                        for (let line of lines) {
                            line = line.trim();
                            if (!line) continue;
                            
                            const parts = line.split(',');
                            if (parts.length >= 3) {
                                // Ê£ÄÊü•‰∏§ÁßçÊ†ºÂºèÔºöÁªèÂ∫¶,Á∫¨Â∫¶,Êó∂Èó¥Êà≥ Êàñ Êó∂Èó¥Êà≥,ÁªèÂ∫¶,Á∫¨Â∫¶
                                const part1 = parts[0].trim();
                                const part2 = parts[1].trim();
                                const part3 = parts[2].trim();
                                
                                // Â¶ÇÊûúÊòØÊúâÊïàÁöÑÊï∞Â≠óÊ†ºÂºèÔºåÂàôËÆ§‰∏∫ÊúâÊúâÊïàËΩ®ËøπÊï∞ÊçÆ
                                if ((!isNaN(part1) && !isNaN(part2) && part3) || 
                                    (!isNaN(part2) && !isNaN(part3) && part1)) {
                                    hasValidTrackData = true;
                                    break;
                                }
                            }
                        }
                        
                        // Êí≠ÊîæÊåâÈíÆÁé∞Âú®ÂßãÁªàÂèØÁÇπÂáªÔºå‰∏çÈúÄË¶ÅÊ†πÊçÆËß£ÊûêÁªìÊûúÂêØÁî®/Á¶ÅÁî®
                        // Â¶ÇÊûúÊâæÂà∞ÊúâÊïàÊï∞ÊçÆÔºåËá™Âä®Ëß£ÊûêÂà∞playbackState
                        if (hasValidTrackData) {
                            const points = [];
                            lines.forEach(line => {
                                line = line.trim();
                                if (!line) return;
                                
                                const parts = line.split(',');
                                if (parts.length >= 3) {
                                    let lng, lat, timestamp;
                                    
                                    // Âà§Êñ≠Ê†ºÂºè
                                    if (parts[0].trim().length > 10 && !isNaN(parts[0].trim())) {
                                        // Ê†ºÂºèÔºöÊó∂Èó¥Êà≥,ÁªèÂ∫¶,Á∫¨Â∫¶
                                        timestamp = parts[0].trim();
                                        lng = parseFloat(parts[1].trim());
                                        lat = parseFloat(parts[2].trim());
                                    } else {
                                        // Ê†ºÂºèÔºöÁªèÂ∫¶,Á∫¨Â∫¶,Êó∂Èó¥Êà≥
                                        lng = parseFloat(parts[0].trim());
                                        lat = parseFloat(parts[1].trim());
                                        timestamp = parts[2].trim();
                                    }
                                    
                                    if (!isNaN(lng) && !isNaN(lat) && timestamp && lat !== 0 && lng !== 0) {
                                        points.push({
                                            lat: lat,
                                            lng: lng,
                                            timestamp: timestamp
                                        });
                                    }
                                }
                            });
                            
                            // ‰øùÂ≠òËß£ÊûêÁöÑËΩ®ËøπÁÇπ
                            if (points.length > 0) {
                                playbackState.points = points;
                            }
                        }
                        
                    } catch (e) {
                        // Ëß£ÊûêÂ§±Ë¥•Êó∂ÔºåÊ∏ÖÁ©∫ËΩ®ËøπÁÇπ
                        playbackState.points = [];
                    }
                } else {
                    // Ê≤°ÊúâÂÜÖÂÆπÊó∂ÔºåÊ∏ÖÁ©∫ËΩ®ËøπÁÇπ
                    playbackState.points = [];
                }
            }
            
            // ÂàùÂßãÁä∂ÊÄÅ
            updateTrackButtons();
            
            // ÁõëÂê¨ËæìÂÖ•‰∫ã‰ª∂
            trackTextarea.addEventListener('input', updateTrackButtons);
            trackTextarea.addEventListener('change', updateTrackButtons);
        }
    }

    // ËΩÆÂªìÁªòÂà∂ÂáΩÊï∞
    function drawOutline() {
        const wktText = document.getElementById('outlineWkt').value.trim();
        if (!wktText) {
            alert('ËØ∑ËæìÂÖ•WKTÊï∞ÊçÆ');
            return;
        }

        clearOutline();

        try {
            // Ê£ÄÊü•ÊòØÂê¶‰∏∫Â§öË°åWKT
            const wktLines = wktText.split('\n').filter(line => line.trim());
            let polygonData = [];

            if (wktLines.length === 1) {
                // ÂçïË°åWKT - ‰ΩøÁî®ÂéüÂßãÈÄªËæë
                const geojson = wellknown.parse(wktLines[0].trim());
                if (geojson.type === "Polygon") {
                    polygonData.push({ index: 1, geojson: geojson, colorIndex: 0 });
                } else if (geojson.type === "MultiPolygon") {
                    geojson.coordinates.forEach((polygon, index) => {
                        // Â∞ÜMultiPolygonÁöÑÊØè‰∏™Â≠êÂ§öËæπÂΩ¢ËΩ¨Êç¢‰∏∫ÂçïÁã¨ÁöÑPolygon
                        const singlePolygon = {
                            type: "Polygon",
                            coordinates: polygon
                        };
                        polygonData.push({ index: index + 1, geojson: singlePolygon, colorIndex: index });
                    });
                }
            } else {
                // Â§öË°åWKT - ÊØèË°å‰∏Ä‰∏™Â§öËæπÂΩ¢
                wktLines.forEach((line, index) => {
                    if (line.trim()) {
                        try {
                            const geojson = wellknown.parse(line.trim());
                            if (geojson.type === "Polygon") {
                                polygonData.push({ index: index + 1, geojson: geojson, colorIndex: index });
                            } else if (geojson.type === "MultiPolygon") {
                                // Â¶ÇÊûú‰∏ÄË°åÊòØMultiPolygonÔºåÊãÜÂàÜÊàêÂ§ö‰∏™Polygon
                                geojson.coordinates.forEach((polygon, subIndex) => {
                                    const singlePolygon = {
                                        type: "Polygon",
                                        coordinates: polygon
                                    };
                                    polygonData.push({
                                        index: index + 1 + subIndex * 0.1,
                                        geojson: singlePolygon,
                                        colorIndex: index
                                    });
                                });
                            }
                        } catch (e) {
                            console.warn(`Á¨¨${index + 1}Ë°åWKTËß£ÊûêÂ§±Ë¥•:`, e);
                        }
                    }
                });
            }

            // ‰∏∫ÊØè‰∏™Â§öËæπÂΩ¢ÂàõÂª∫ÂõæÂ±Ç
            polygonData.forEach((data, idx) => {
                const colorScheme = polygonColors[data.colorIndex % polygonColors.length];
                const style = {
                    color: colorScheme.outline,
                    weight: 1,
                    opacity: 1,
                    fillColor: colorScheme.fill,
                    fillOpacity: colorScheme.opacity
                };

                const polygonLayer = L.geoJSON(data.geojson, {
                    style: style
                });

                outlineLayerGroup.addLayer(polygonLayer);

                // ËÆ°ÁÆóÈù¢ÁßØÂπ∂Ê∑ªÂä†‰∫©Êï∞Ê†áÁ≠æ
                if (typeof L !== 'undefined' && typeof L.GeometryUtil !== 'undefined' && typeof L.GeometryUtil.geodesicArea === 'function') {
                    try {
                        // Ëé∑ÂèñÂõæÂ±Ç‰∏≠ÁöÑË¶ÅÁ¥†ËøõË°åÈù¢ÁßØËÆ°ÁÆó
                        let layers = [];

                        // Â¶ÇÊûúpolygonLayerÊòØLayerGroupÊàñFeatureGroupÔºåËé∑ÂèñÂÖ∂ÊâÄÊúâÂ≠êÂõæÂ±Ç
                        if (polygonLayer instanceof L.LayerGroup || polygonLayer instanceof L.FeatureGroup) {
                            layers = polygonLayer.getLayers();
                        } else {
                            // ÂØπ‰∫éÂÖ∂‰ªñÁ±ªÂûãÁöÑÂõæÂ±ÇÔºåÊ£ÄÊü•ÊòØÂê¶ÊúâgetLayersÊñπÊ≥ï
                            layers = polygonLayer.getLayers ? polygonLayer.getLayers() : [polygonLayer];
                        }

                        if (layers && Array.isArray(layers) && layers.length > 0) {
                            for (let j = 0; j < layers.length; j++) {
                                const layer = layers[j];
                                let latLngs;

                                // Ê†πÊçÆÂõæÂ±ÇÁ±ªÂûãËé∑ÂèñÂùêÊ†á
                                if (layer && typeof layer.getLatLngs === 'function') {
                                    if (layer instanceof L.Polygon) {
                                        latLngs = layer.getLatLngs();
                                    } else if (layer instanceof L.MultiPolygon) {
                                        // ÂØπ‰∫éMultiPolygonÔºåÂèñÁ¨¨‰∏Ä‰∏™Â§öËæπÂΩ¢
                                        const multiLatLngs = layer.getLatLngs();
                                        if (multiLatLngs && Array.isArray(multiLatLngs) && multiLatLngs.length > 0) {
                                            latLngs = multiLatLngs[0];
                                        }
                                    }

                                    if (latLngs) {
                                        // Â§ÑÁêÜlatLngsÊ†ºÂºèÔºåÁ°Æ‰øùÊ≠£Á°ÆËÆ°ÁÆóÈù¢ÁßØ
                                        let areaLatLngs = latLngs;
                                        if (Array.isArray(latLngs) && latLngs.length > 0) {
                                            areaLatLngs = latLngs[0] || latLngs;
                                        }

                                        let areaSqM, areaMu;
                                        if (typeof L.GeometryUtil !== 'undefined' && typeof L.GeometryUtil.geodesicArea === 'function') {
                                            areaSqM = L.GeometryUtil.geodesicArea(areaLatLngs);
                                            areaMu = (areaSqM / 666.6667).toFixed(4); // ËΩ¨Êç¢‰∏∫‰∫©
                                            console.log('‰ΩøÁî®L.GeometryUtilËÆ°ÁÆóÂ§öËæπÂΩ¢Èù¢ÁßØ:', areaSqM, 'Âπ≥ÊñπÁ±≥ (', areaMu, '‰∫©)');
                                        } else if (typeof turf !== 'undefined') {
                                            // ‰ΩøÁî®Turf.js‰Ωú‰∏∫Â§áÈÄâÊñπÊ°à
                                            try {
                                                // Â§ÑÁêÜÂ§öËæπÂΩ¢ÂùêÊ†áÔºåÊîØÊåÅÂ§ñÈÉ®ËæπÁïåÂíåÂÜÖÈÉ®Â≠îÊ¥û
                                                const processPolygon = (polyCoords) => {
                                                    if (!Array.isArray(polyCoords) || polyCoords.length === 0) {
                                                        return null;
                                                    }

                                                    // Â¶ÇÊûúÊòØÂ§öËæπÂΩ¢Êï∞ÁªÑÔºàÂ§ñÈÉ®ËæπÁïå+Â≠îÊ¥ûÔºâÔºåÂàÜÂà´Â§ÑÁêÜ
                                                    let processedCoords = [];

                                                    // Â§ÑÁêÜÂ§öËæπÂΩ¢ÁöÑÊØè‰∏™ÁéØÔºàÁ¨¨‰∏Ä‰∏™ÊòØÂ§ñÈÉ®ËæπÁïåÔºåÂÖ∂‰ΩôÊòØÂ≠îÊ¥ûÔºâ
                                                    for (let i = 0; i < polyCoords.length; i++) {
                                                        let ring = polyCoords[i];
                                                        if (!Array.isArray(ring)) {
                                                            ring = [ring]; // Â¶ÇÊûú‰∏çÊòØÊï∞ÁªÑÔºåËΩ¨Êç¢‰∏∫Êï∞ÁªÑ
                                                        }

                                                        // Â∞ÜLeafletÂùêÊ†áËΩ¨Êç¢‰∏∫GeoJSONÊ†ºÂºè [lng, lat]
                                                        let geoJsonRing = ring.map(latLng => {
                                                            if (latLng.lat !== undefined && latLng.lng !== undefined) {
                                                                return [latLng.lng, latLng.lat];
                                                            } else if (Array.isArray(latLng) && latLng.length >= 2) {
                                                                // Â¶ÇÊûúÂ∑≤ÁªèÊòØÊï∞ÁªÑÊ†ºÂºè [lat, lng] Êàñ [lng, lat]
                                                                return [latLng[1], latLng[0]]; // ÂÅáËÆæÊòØ [lat, lng] Ê†ºÂºè
                                                            }
                                                            return null;
                                                        }).filter(coord => coord !== null);

                                                        // Á°Æ‰øùÁéØÊòØÈó≠ÂêàÁöÑÔºàËá≥Â∞ëÊúâ4‰∏™ÁÇπÔºåÈ¶ñÂ∞æÁõ∏ÂêåÔºâ
                                                        if (geoJsonRing.length >= 3) {
                                                            // Â¶ÇÊûúÈ¶ñÂ∞æ‰∏çÁõ∏ÂêåÔºåÈó≠ÂêàÁéØ
                                                            if (geoJsonRing[0][0] !== geoJsonRing[geoJsonRing.length - 1][0] ||
                                                                geoJsonRing[0][1] !== geoJsonRing[geoJsonRing.length - 1][1]) {
                                                                geoJsonRing.push(geoJsonRing[0]);
                                                            }

                                                            // Á°Æ‰øùËá≥Â∞ëÊúâ4‰∏™ÁÇπÔºàÈó≠ÂêàÂêéÔºâ
                                                            if (geoJsonRing.length < 4) {
                                                                // Â¶ÇÊûúÁÇπÊï∞‰∏çË∂≥4‰∏™ÔºåÂ§çÂà∂ÁÇπÁõ¥Âà∞ËææÂà∞4‰∏™
                                                                while (geoJsonRing.length < 4) {
                                                                    geoJsonRing.push(geoJsonRing[geoJsonRing.length - 1]);
                                                                }
                                                            }
                                                        } else if (geoJsonRing.length === 2) {
                                                            // Â¶ÇÊûúÂè™Êúâ2‰∏™ÁÇπÔºåÂ§çÂà∂ÂÆÉ‰ª¨ÂΩ¢ÊàêËá≥Â∞ë4‰∏™ÁÇπÁöÑÁéØ
                                                            geoJsonRing.push(geoJsonRing[1]);
                                                            geoJsonRing.push(geoJsonRing[0]);
                                                        } else if (geoJsonRing.length === 1) {
                                                            // Â¶ÇÊûúÂè™Êúâ1‰∏™ÁÇπÔºåÂ§çÂà∂3Ê¨°ÂΩ¢Êàê4‰∏™ÁÇπÁöÑÁéØ
                                                            for (let k = 0; k < 3; k++) {
                                                                geoJsonRing.push(geoJsonRing[0]);
                                                            }
                                                        }

                                                        processedCoords.push(geoJsonRing);
                                                    }

                                                    return processedCoords;
                                                };

                                                // Ê†πÊçÆareaLatLngsÁöÑÁªìÊûÑÂ§ÑÁêÜÂùêÊ†á
                                                let coordinates;
                                                if (Array.isArray(areaLatLngs) && areaLatLngs.length > 0) {
                                                    if (Array.isArray(areaLatLngs[0])) {
                                                        // Â¶ÇÊûúÊòØÂ§öËæπÂΩ¢Êï∞ÁªÑÔºàÂåÖÂê´Â§ñÈÉ®ËæπÁïåÂíåÂ≠îÊ¥ûÔºâ
                                                        coordinates = processPolygon(areaLatLngs);
                                                    } else {
                                                        // Â¶ÇÊûúÊòØÂçï‰∏™Â§öËæπÂΩ¢ËæπÁïå
                                                        coordinates = processPolygon([areaLatLngs]);
                                                    }
                                                } else {
                                                    // Âçï‰∏™Â§öËæπÂΩ¢ËæπÁïå
                                                    coordinates = processPolygon([areaLatLngs]);
                                                }

                                                if (coordinates && coordinates.length > 0) {
                                                    const polygon = turf.polygon(coordinates);
                                                    areaSqM = turf.area(polygon);
                                                    areaMu = (areaSqM / 666.6667).toFixed(4); // ËΩ¨Êç¢‰∏∫‰∫©
                                                    console.log('‰ΩøÁî®Turf.jsËÆ°ÁÆóÂ§öËæπÂΩ¢Èù¢ÁßØ:', areaSqM, 'Âπ≥ÊñπÁ±≥ (', areaMu, '‰∫©)');
                                                } else {
                                                    console.log('Êó†Ê≥ïÂ§ÑÁêÜÂùêÊ†áÊï∞ÊçÆÔºå‰ΩøÁî®ÈªòËÆ§Èù¢ÁßØ');
                                                    areaSqM = 0;
                                                    areaMu = '0.0000';
                                                }
                                            } catch (e) {
                                                console.error('‰ΩøÁî®Turf.jsËÆ°ÁÆóÈù¢ÁßØÊó∂Âá∫Èîô:', e);
                                                areaSqM = 0;
                                                areaMu = '0.0000';
                                            }
                                        } else {
                                            console.error('L.GeometryUtilÂíåTurf.jsÈÉΩ‰∏çÂèØÁî®ÔºåÊó†Ê≥ïËÆ°ÁÆóÈù¢ÁßØ');
                                            areaSqM = 0;
                                            areaMu = '0.0000';
                                        }

                                        console.log('ËÆ°ÁÆóÂ§öËæπÂΩ¢Èù¢ÁßØ:', areaSqM, 'Âπ≥ÊñπÁ±≥ (', areaMu, '‰∫©)');

                                        // Â¶ÇÊûúÊ†áÁ≠æÂ∑≤ÂêØÁî®ÔºåÂàôÊ∑ªÂä†Èù¢ÁßØÊ†áÁ≠æ
                                        if (labelsEnabled) {
                                            console.log('Ê†áÁ≠æÂ∑≤ÂêØÁî®Ôºå‰∏∫Â§öËæπÂΩ¢Ê∑ªÂä†Èù¢ÁßØÊ†áÁ≠æ');
                                            addAreaLabelToLayer(polygonLayer, `Èù¢ÁßØ: ${areaMu}‰∫©`);
                                            console.log('ÂΩìÂâçÊ†áÁ≠æÂõæÂ±Ç‰∏≠ÁöÑÂõæÂ±ÇÊï∞Èáè:', labelLayerGroup.getLayers().length);
                                        } else {
                                            console.log('Ê†áÁ≠æÊú™ÂêØÁî®Ôºå‰∏çÊ∑ªÂä†Èù¢ÁßØÊ†áÁ≠æ');
                                        }
                                        break; // Âè™Â§ÑÁêÜÁ¨¨‰∏Ä‰∏™ÊúâÊïàÁöÑÂõæÂ±ÇÊù•ËÆ°ÁÆóÈù¢ÁßØ
                                    }
                                }
                            }
                        }
                    } catch (areaError) {
                        console.warn('Èù¢ÁßØËÆ°ÁÆóÈîôËØØ:', areaError);
                    }
                }
            });

            // Ëá™ÈÄÇÂ∫îËßÜÈáé
            if (outlineLayerGroup && outlineLayerGroup.getLayers && outlineLayerGroup.getLayers().length > 0) {
                // ËÆ°ÁÆóÊâÄÊúâÂ≠êÂõæÂ±ÇÁöÑÊï¥‰ΩìËæπÁïå
                const layers = outlineLayerGroup.getLayers();
                let groupBounds = null;

                for (let i = 0; i < layers.length; i++) {
                    const layer = layers[i];
                    let layerBounds;

                    // Ê£ÄÊü•ÂõæÂ±ÇÊòØÂê¶‰∏∫LayerGroupÊàñFeatureGroup
                    if (layer instanceof L.LayerGroup || layer instanceof L.FeatureGroup) {
                        try {
                            layerBounds = layer.getBounds();
                        } catch (e) {
                            // Â¶ÇÊûúLayerGroup/FeatureGroupÊ≤°ÊúâgetBoundsÊñπÊ≥ïÔºåÈÅçÂéÜÂÖ∂Â≠êÂõæÂ±Ç
                            const subLayers = layer.getLayers();
                            for (let j = 0; j < subLayers.length; j++) {
                                try {
                                    const subLayerBounds = subLayers[j].getBounds();
                                    if (subLayerBounds && subLayerBounds.isValid && subLayerBounds.isValid()) {
                                        if (!groupBounds) {
                                            groupBounds = subLayerBounds;
                                        } else {
                                            groupBounds.extend(subLayerBounds);
                                        }
                                    }
                                } catch (e) {
                                    continue;
                                }
                            }
                            continue; // ÁªßÁª≠Â§ñÂ±ÇÂæ™ÁéØ
                        }
                    } else {
                        try {
                            layerBounds = layer.getBounds();
                        } catch (e) {
                            continue; // Â∞ùËØï‰∏ã‰∏Ä‰∏™ÂõæÂ±Ç
                        }
                    }

                    if (layerBounds && layerBounds.isValid && layerBounds.isValid()) {
                        if (!groupBounds) {
                            groupBounds = layerBounds;
                        } else {
                            groupBounds.extend(layerBounds);
                        }
                    }
                }

                if (groupBounds && groupBounds.isValid && groupBounds.isValid()) {
                    map.fitBounds(groupBounds, { padding: [20, 20] });
                }
            }

            updateStatus(`ËΩÆÂªìÁªòÂà∂ÂÆåÊàêÔºåÂÖ±${polygonData.length}‰∏™Â§öËæπÂΩ¢`);

        } catch (error) {
            console.error('WKTËß£ÊûêÈîôËØØ:', error);
            updateStatus('WKTËß£ÊûêÂ§±Ë¥•: ' + error.message);
        }
    }

    // Ê∏ÖÈô§ËΩÆÂªì
    function clearOutline() {
        outlineLayerGroup.clearLayers();
        currentOutline = null;
        updateStatus('ËΩÆÂªìÂ∑≤Ê∏ÖÈô§');
    }

    // ‰∏∫ÂõæÂ±ÇÊ∑ªÂä†Ê†áÁ≠æ
    function addLabelsToLayer(layer, prefix) {
        try {
            // Â¶ÇÊûúlayerÊòØLayerGroupÊàñFeatureGroupÔºåÈúÄË¶ÅËé∑ÂèñÂÖ∂‰∏≠ÁöÑÁ¨¨‰∏Ä‰∏™ÂõæÂ±ÇÊù•Ëé∑ÂèñËæπÁïå
            let bounds;
            if (layer instanceof L.LayerGroup || layer instanceof L.FeatureGroup) {
                const layers = layer.getLayers();
                if (layers && layers.length > 0) {
                    // ÈÅçÂéÜÊâÄÊúâÂ≠êÂõæÂ±ÇÊù•Ëé∑ÂèñÊúâÊïàÁöÑËæπÁïå
                    for (let i = 0; i < layers.length; i++) {
                        try {
                            const subLayer = layers[i];
                            let subLayerBounds;

                            // Ê£ÄÊü•Â≠êÂõæÂ±ÇÊòØÂê¶‰∏∫LayerGroupÊàñFeatureGroup
                            if (subLayer instanceof L.LayerGroup || subLayer instanceof L.FeatureGroup) {
                                // ÈÄíÂΩíÂ§ÑÁêÜÂµåÂ•óÁöÑLayerGroupÊàñFeatureGroup
                                const subSubLayers = subLayer.getLayers();
                                for (let j = 0; j < subSubLayers.length; j++) {
                                    try {
                                        const subSubLayerBounds = subSubLayers[j].getBounds();
                                        if (subSubLayerBounds && subSubLayerBounds.isValid && subSubLayerBounds.isValid()) {
                                            subLayerBounds = subSubLayerBounds;
                                            break;
                                        }
                                    } catch (e) {
                                        continue;
                                    }
                                }
                            } else {
                                subLayerBounds = subLayer.getBounds();
                            }

                            if (subLayerBounds && subLayerBounds.isValid && subLayerBounds.isValid()) {
                                bounds = subLayerBounds;
                                break; // ‰ΩøÁî®Á¨¨‰∏Ä‰∏™ÊúâÊïàÁöÑËæπÁïå
                            }
                        } catch (e) {
                            continue; // Â∞ùËØï‰∏ã‰∏Ä‰∏™ÂõæÂ±Ç
                        }
                    }
                }
            } else {
                // Â¶ÇÊûúÊòØÂçï‰∏™ÂõæÂ±ÇÔºåÁõ¥Êé•Ëé∑ÂèñËæπÁïå
                try {
                    bounds = layer.getBounds();
                } catch (e) {
                    console.error('Ëé∑ÂèñÂõæÂ±ÇËæπÁïåÂ§±Ë¥•:', e);
                    return; // Â¶ÇÊûúÊó†Ê≥ïËé∑ÂèñËæπÁïåÔºåÂàô‰∏çÊ∑ªÂä†Ê†áÁ≠æ
                }
            }

            if (bounds && bounds.isValid && bounds.isValid()) {
                const center = bounds.getCenter();
                const label = L.divIcon({
                    className: 'custom-label',
                    html: `<div style="background: rgba(0,0,0,0.8); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; white-space: nowrap;">${prefix}</div>`,
                    iconSize: null,
                    iconAnchor: [0, 0]
                });

                const labelMarker = L.marker(center, { icon: label });
                labelLayerGroup.addLayer(labelMarker);
            }
        } catch (error) {
            console.error('Ê∑ªÂä†Ê†áÁ≠æÈîôËØØ:', error);
        }
    }

    // ‰∏∫ÂõæÂ±ÇÊ∑ªÂä†Èù¢ÁßØÊ†áÁ≠æ
    function addAreaLabelToLayer(layer, areaText) {
        try {
            console.log('Â∞ùËØï‰∏∫ÂõæÂ±ÇÊ∑ªÂä†Èù¢ÁßØÊ†áÁ≠æ:', areaText);
            // Â¶ÇÊûúlayerÊòØLayerGroupÊàñFeatureGroupÔºåÈúÄË¶ÅËé∑ÂèñÂÖ∂‰∏≠ÁöÑÁ¨¨‰∏Ä‰∏™ÂõæÂ±ÇÊù•Ëé∑ÂèñËæπÁïå
            let bounds;
            if (layer instanceof L.LayerGroup || layer instanceof L.FeatureGroup) {
                const layers = layer.getLayers();
                if (layers && layers.length > 0) {
                    // ÈÅçÂéÜÊâÄÊúâÂ≠êÂõæÂ±ÇÊù•Ëé∑ÂèñÊúâÊïàÁöÑËæπÁïå
                    for (let i = 0; i < layers.length; i++) {
                        try {
                            const subLayer = layers[i];
                            let subLayerBounds;

                            // Ê£ÄÊü•Â≠êÂõæÂ±ÇÊòØÂê¶‰∏∫LayerGroupÊàñFeatureGroup
                            if (subLayer instanceof L.LayerGroup || subLayer instanceof L.FeatureGroup) {
                                // ÈÄíÂΩíÂ§ÑÁêÜÂµåÂ•óÁöÑLayerGroupÊàñFeatureGroup
                                const subSubLayers = subLayer.getLayers();
                                for (let j = 0; j < subSubLayers.length; j++) {
                                    try {
                                        const subSubLayerBounds = subSubLayers[j].getBounds();
                                        if (subSubLayerBounds && subSubLayerBounds.isValid && subSubLayerBounds.isValid()) {
                                            subLayerBounds = subSubLayerBounds;
                                            break;
                                        }
                                    } catch (e) {
                                        continue;
                                    }
                                }
                            } else {
                                subLayerBounds = subLayer.getBounds();
                            }

                            if (subLayerBounds && subLayerBounds.isValid && subLayerBounds.isValid()) {
                                bounds = subLayerBounds;
                                break; // ‰ΩøÁî®Á¨¨‰∏Ä‰∏™ÊúâÊïàÁöÑËæπÁïå
                            }
                        } catch (e) {
                            continue; // Â∞ùËØï‰∏ã‰∏Ä‰∏™ÂõæÂ±Ç
                        }
                    }
                }
            } else {
                // Â¶ÇÊûúÊòØÂçï‰∏™ÂõæÂ±ÇÔºåÁõ¥Êé•Ëé∑ÂèñËæπÁïå
                try {
                    bounds = layer.getBounds();
                } catch (e) {
                    console.error('Ëé∑ÂèñÂõæÂ±ÇËæπÁïåÂ§±Ë¥•:', e);
                    return; // Â¶ÇÊûúÊó†Ê≥ïËé∑ÂèñËæπÁïåÔºåÂàô‰∏çÊ∑ªÂä†Ê†áÁ≠æ
                }
            }

            if (bounds && bounds.isValid && bounds.isValid()) {
                const center = bounds.getCenter();
                const label = L.divIcon({
                    className: 'area-label',
                    html: areaText,
                    iconSize: null,
                    iconAnchor: null // ‰ΩøÁî®ÈªòËÆ§ÈîöÁÇπ
                });

                const labelMarker = L.marker(center, { icon: label });
                labelLayerGroup.addLayer(labelMarker);
                console.log('ÊàêÂäüÊ∑ªÂä†Èù¢ÁßØÊ†áÁ≠æÂà∞ÂõæÂ±ÇÁªÑ');
                console.log('ÂΩìÂâçÊ†áÁ≠æÂõæÂ±Ç‰∏≠ÁöÑÂõæÂ±ÇÊï∞Èáè:', labelLayerGroup.getLayers().length);
            } else {
                console.warn('Êó†Ê≥ïËé∑ÂèñÂõæÂ±ÇËæπÁïåÔºåÊó†Ê≥ïÊ∑ªÂä†Èù¢ÁßØÊ†áÁ≠æ');
            }
        } catch (error) {
            console.error('Ê∑ªÂä†Èù¢ÁßØÊ†áÁ≠æÈîôËØØ:', error);
        }
    }

    // ËΩ®ËøπÁªòÂà∂ÂáΩÊï∞
    function drawTrack() {
        const trackText = document.getElementById('trackTextarea').value.trim();
        const timeRangeText = document.getElementById('timeRangeInput').value.trim();

        if (!trackText) {
            alert('ËØ∑Á≤òË¥¥ËΩ®ËøπÊñáÊú¨ÔºàÊó∂Èó¥Êà≥,ÁªèÂ∫¶,Á∫¨Â∫¶Ôºâ');
            return;
        }

        // Ê∏ÖÈô§ËΩ®ËøπÊòæÁ§∫Ôºå‰ΩÜ‰øùÁïôËΩ®ËøπÁÇπÊï∞ÊçÆÁî®‰∫éÂõûÊîæ
        trackLayerGroup.clearLayers();
        currentTrack = null;
        
        // ÂÅúÊ≠¢ÂõûÊîæ‰ΩÜ‰∏çÈáçÁΩÆpointsÊï∞ÊçÆÂíåcurrentIndex
        playbackState.isPlaying = false;
        if (playbackState.timer) {
            clearTimeout(playbackState.timer);
            playbackState.timer = null;
        }
        
        // Ê∏ÖÈô§ÂõûÊîæÂÖÉÁ¥†
        if (playbackState.marker) {
            map.removeLayer(playbackState.marker);
            playbackState.marker = null;
        }
        if (playbackState.polyline) {
            map.removeLayer(playbackState.polyline);
            playbackState.polyline = null;
        }

        // Ëß£ÊûêÊó∂Èó¥ËåÉÂõ¥
        let startTime, endTime;
        if (timeRangeText) {
            const timeParts = timeRangeText.split(' - ');
            if (timeParts.length === 2) {
                startTime = new Date(timeParts[0].trim());
                endTime = new Date(timeParts[1].trim());

                if (isNaN(startTime.getTime()) || isNaN(endTime.getTime())) {
                    alert('Êó∂Èó¥ËåÉÂõ¥Ê†ºÂºè‰∏çÊ≠£Á°ÆÔºåËØ∑‰ΩøÁî®Ê†ºÂºèÔºö2025-10-23T13:56:49 - 2025-10-23T15:51:31');
                    return;
                }
            }
        }

        // Ëß£ÊûêËΩ®ËøπÊï∞ÊçÆ
        const points = [];
        const lines = trackText.split('\n');

        lines.forEach(line => {
            line = line.trim();
            if (!line) return;

            // ÊîØÊåÅ‰∏§ÁßçÊ†ºÂºèÔºö
            // 1. ÁªèÂ∫¶,Á∫¨Â∫¶,Êó∂Èó¥Êà≥
            // 2. Êó∂Èó¥Êà≥,ÁªèÂ∫¶,Á∫¨Â∫¶
            const parts = line.split(',');
            if (parts.length >= 3) {
                let lng, lat, timestamp;

                // Âà§Êñ≠Ê†ºÂºèÔºöÂ¶ÇÊûúÁ¨¨‰∏ÄÈÉ®ÂàÜÊòØÊï∞Â≠ó‰∏îÈïøÂ∫¶Â§ß‰∫é10ÔºåÂèØËÉΩÊòØÊó∂Èó¥Êà≥
                if (parts[0].trim().length > 10 && !isNaN(parts[0].trim())) {
                    // Ê†ºÂºèÔºöÊó∂Èó¥Êà≥,ÁªèÂ∫¶,Á∫¨Â∫¶
                    timestamp = parts[0].trim();
                    lng = parseFloat(parts[1].trim());
                    lat = parseFloat(parts[2].trim());
                } else {
                    // Ê†ºÂºèÔºöÁªèÂ∫¶,Á∫¨Â∫¶,Êó∂Èó¥Êà≥
                    lng = parseFloat(parts[0].trim());
                    lat = parseFloat(parts[1].trim());
                    timestamp = parts[2].trim();
                }

                if (!isNaN(lng) && !isNaN(lat) && timestamp && lat !== 0 && lng !== 0) {
                    const pointTime = parseTimestamp(timestamp);

                    // Ê£ÄÊü•Êó∂Èó¥ËåÉÂõ¥
                    if (startTime && endTime) {
                        if (pointTime < startTime || pointTime > endTime) {
                            return; // Ë∑≥Ëøá‰∏çÂú®Êó∂Èó¥ËåÉÂõ¥ÂÜÖÁöÑÁÇπ
                        }
                    }

                    points.push({
                        lat: lat,
                        lng: lng,
                        timestamp: timestamp,
                        time: pointTime
                    });
                }
            }
        });

        if (points.length < 2) {
            alert('ËØ•Êó∂Èó¥ËåÉÂõ¥ÂÜÖÁöÑÊúâÊïàËΩ®ËøπÁÇπ‰∏çË∂≥ÔºåËá≥Â∞ëÈúÄË¶Å‰∏§ÁÇπ');
            return;
        }

        // ÊåâÊó∂Èó¥ÊéíÂ∫è
        points.sort((a, b) => a.time - b.time);

        // ÁªòÂà∂ËΩ®ËøπÁ∫ø
        const latlngs = points.map(p => [p.lat, p.lng]);

        currentTrack = L.polyline(latlngs, {
            color: currentTrackLineColor,
            weight: 1,
            opacity: 0.9
        });

        trackLayerGroup.addLayer(currentTrack);

        // Ëá™ÈÄÇÂ∫îËßÜÈáé
        const group = new L.featureGroup([currentTrack]);
        map.fitBounds(group.getBounds().pad(0.1));

        // ‰øùÂ≠òËΩ®ËøπÁÇπÁî®‰∫éÂõûÊîæ
        playbackState.points = points;

        // ÂêØÁî®Êí≠ÊîæÂô®ÊéßÂà∂ÊåâÈíÆÔºàÂ¶ÇÊûúÊí≠ÊîæÂô®ÂÖÉÁ¥†Â≠òÂú®Ôºâ
        if (playbackPlayer) {
            updatePlayerControls();
        }

        updateStatus('ËΩ®ËøπÁªòÂà∂ÂÆåÊàê');
    }

    // CanvasËΩ®ËøπÁÇπÊ∏≤ÊüìÂô® - È´òÊÄßËÉΩÊ∏≤ÊüìÂ§ßÈáèËΩ®ËøπÁÇπ
    let trackCanvasLayer = null;
    
    // ËΩ®ËøπÁÇπÊ∏≤ÊüìÈÖçÁΩÆ
    const trackPointConfig = {
        maxPointsForFullRender: 100000,    // ÂÖ®ÈáèÊ∏≤ÊüìÁöÑÊúÄÂ§ßÁÇπÊï∞
        maxPointsForBatchRender: 10000,   // ÂàÜÊâπÊ∏≤ÊüìÁöÑÊúÄÂ§ßÁÇπÊï∞
        batchSize: 1000,                  // ÊØèÊâπÂ§ÑÁêÜÁöÑÁÇπÊï∞
        pointRadius: 0.5,                // ÁÇπÁöÑÂçäÂæÑÔºàÂÉèÁ¥†Ôºâ
        pointOpacity: 1,                 // ÁÇπÁöÑÈÄèÊòéÂ∫¶
        useSimplification: true,           // ÊòØÂê¶‰ΩøÁî®Êï∞ÊçÆÁÆÄÂåñ
        simplificationTolerance: 0.00001  // ÁÆÄÂåñÂÆπÂ∑ÆÔºàÂ∫¶Ôºâ
    };
    
    // ÂàõÂª∫CanvasÂõæÂ±ÇÁî®‰∫éËΩ®ËøπÁÇπÊ∏≤Êüì
    function createTrackCanvasLayer() {
        if (trackCanvasLayer) {
            map.removeLayer(trackCanvasLayer);
        }
        
        trackCanvasLayer = L.canvas();
        trackCanvasLayer.addTo(map);
        return trackCanvasLayer;
    }
    
    // Êï∞ÊçÆÁÆÄÂåñÂáΩÊï∞ - ÂáèÂ∞ëÁÇπÊï∞‰ΩÜ‰øùÊåÅËΩ®ËøπÂΩ¢Áä∂
    function simplifyPoints(points, tolerance) {
        if (points.length <= trackPointConfig.maxPointsForFullRender) {
            return points;
        }
        
        // ‰ΩøÁî®ÁÆÄÂçïÁöÑË∑ùÁ¶ªËøáÊª§ÁÆóÊ≥ï
        const simplified = [points[0]];
        let lastPoint = points[0];
        
        for (let i = 1; i < points.length; i++) {
            const currentPoint = points[i];
            const distance = Math.sqrt(
                Math.pow(currentPoint.lat - lastPoint.lat, 2) + 
                Math.pow(currentPoint.lng - lastPoint.lng, 2)
            );
            
            if (distance > tolerance) {
                simplified.push(currentPoint);
                lastPoint = currentPoint;
            }
        }
        
        // Á°Æ‰øùÂåÖÂê´ÊúÄÂêé‰∏Ä‰∏™ÁÇπ
        if (simplified[simplified.length - 1] !== points[points.length - 1]) {
            simplified.push(points[points.length - 1]);
        }
        
        console.log(`Êï∞ÊçÆÁÆÄÂåñ: ${points.length} -> ${simplified.length} ÁÇπ`);
        return simplified;
    }

    // ‰ΩøÁî®CanvasÁªòÂà∂ËΩ®ËøπÁÇπ - È´òÊÄßËÉΩÊñπÊ°à
    function showTrackPoints() {
        const trackText = document.getElementById('trackTextarea').value.trim();
        const timeRangeText = document.getElementById('timeRangeInput').value.trim();

        if (!trackText) {
            alert('ËØ∑Á≤òË¥¥ËΩ®ËøπÊñáÊú¨ÔºàÊó∂Èó¥Êà≥,ÁªèÂ∫¶,Á∫¨Â∫¶Ôºâ');
            return;
        }

        // Ê∏ÖÈô§ËΩ®ËøπÊòæÁ§∫Ôºå‰ΩÜ‰øùÁïôËΩ®ËøπÁÇπÊï∞ÊçÆÁî®‰∫éÂõûÊîæ
        trackLayerGroup.clearLayers();
        currentTrack = null;
        
        // ÂÅúÊ≠¢ÂõûÊîæ‰ΩÜ‰∏çÈáçÁΩÆpointsÊï∞ÊçÆÂíåcurrentIndex
        playbackState.isPlaying = false;
        if (playbackState.timer) {
            clearTimeout(playbackState.timer);
            playbackState.timer = null;
        }
        
        // Ê∏ÖÈô§ÂõûÊîæÂÖÉÁ¥†
        if (playbackState.marker) {
            map.removeLayer(playbackState.marker);
            playbackState.marker = null;
        }
        if (playbackState.polyline) {
            map.removeLayer(playbackState.polyline);
            playbackState.polyline = null;
        }

        // Ëß£ÊûêÊó∂Èó¥ËåÉÂõ¥
        let startTime, endTime;
        if (timeRangeText) {
            const timeParts = timeRangeText.split(' - ');
            if (timeParts.length === 2) {
                startTime = new Date(timeParts[0].trim());
                endTime = new Date(timeParts[1].trim());

                if (isNaN(startTime.getTime()) || isNaN(endTime.getTime())) {
                    alert('Êó∂Èó¥ËåÉÂõ¥Ê†ºÂºè‰∏çÊ≠£Á°ÆÔºåËØ∑‰ΩøÁî®Ê†ºÂºèÔºö2025-10-23T13:56:49 - 2025-10-23T15:51:31');
                    return;
                }
            }
        }

        // Ëß£ÊûêËΩ®ËøπÊï∞ÊçÆ
        const points = [];
        const lines = trackText.split('\n');

        lines.forEach(line => {
            line = line.trim();
            if (!line) return;

            // ÊîØÊåÅ‰∏§ÁßçÊ†ºÂºèÔºö
            // 1. ÁªèÂ∫¶,Á∫¨Â∫¶,Êó∂Èó¥Êà≥
            // 2. Êó∂Èó¥Êà≥,ÁªèÂ∫¶,Á∫¨Â∫¶
            const parts = line.split(',');
            if (parts.length >= 3) {
                let lng, lat, timestamp;

                // Âà§Êñ≠Ê†ºÂºèÔºöÂ¶ÇÊûúÁ¨¨‰∏ÄÈÉ®ÂàÜÊòØÊï∞Â≠ó‰∏îÈïøÂ∫¶Â§ß‰∫é10ÔºåÂèØËÉΩÊòØÊó∂Èó¥Êà≥
                if (parts[0].trim().length > 10 && !isNaN(parts[0].trim())) {
                    // Ê†ºÂºèÔºöÊó∂Èó¥Êà≥,ÁªèÂ∫¶,Á∫¨Â∫¶
                    timestamp = parts[0].trim();
                    lng = parseFloat(parts[1].trim());
                    lat = parseFloat(parts[2].trim());
                } else {
                    // Ê†ºÂºèÔºöÁªèÂ∫¶,Á∫¨Â∫¶,Êó∂Èó¥Êà≥
                    lng = parseFloat(parts[0].trim());
                    lat = parseFloat(parts[1].trim());
                    timestamp = parts[2].trim();
                }

                if (!isNaN(lng) && !isNaN(lat) && timestamp && lat !== 0 && lng !== 0) {
                    const pointTime = parseTimestamp(timestamp);

                    // Ê£ÄÊü•Êó∂Èó¥ËåÉÂõ¥
                    if (startTime && endTime) {
                        if (pointTime < startTime || pointTime > endTime) {
                            return; // Ë∑≥Ëøá‰∏çÂú®Êó∂Èó¥ËåÉÂõ¥ÂÜÖÁöÑÁÇπ
                        }
                    }

                    points.push({
                        lat: lat,
                        lng: lng,
                        timestamp: timestamp,
                        time: pointTime
                    });
                }
            }
        });

        if (points.length === 0) {
            alert('ËØ•Êó∂Èó¥ËåÉÂõ¥ÂÜÖÊ≤°ÊúâÊâæÂà∞ËΩ®ËøπÁÇπ');
            return;
        }

        // ÊåâÊó∂Èó¥ÊéíÂ∫è
        points.sort((a, b) => a.time - b.time);

        // ‰øùÂ≠òËΩ®ËøπÁÇπÁî®‰∫éÂõûÊîæ
        playbackState.points = points;

        // ‰ΩøÁî®CanvasÊ∏≤ÊüìËΩ®ËøπÁÇπ
        renderTrackPointsWithCanvas(points);
    }

    // CanvasÊ∏≤ÊüìËΩ®ËøπÁÇπ - Ë∂ÖÈ´òÊÄßËÉΩÊñπÊ°àÔºàÊîØÊåÅÊµ∑ÈáèÊï∞ÊçÆÔºâ
    function renderTrackPointsWithCanvas(points) {
        const totalPoints = points.length;
        updateStatus(`ÂºÄÂßãCanvasÊ∏≤ÊüìËΩ®ËøπÁÇπÔºåÂÖ±${totalPoints}‰∏™ÁÇπ...`);

        // Êï∞ÊçÆÁÆÄÂåñÂ§ÑÁêÜÔºàÈíàÂØπÊµ∑ÈáèÊï∞ÊçÆÔºâ
        let renderPoints = points;
        if (trackPointConfig.useSimplification && totalPoints > trackPointConfig.maxPointsForFullRender) {
            renderPoints = simplifyPoints(points, trackPointConfig.simplificationTolerance);
            updateStatus(`Êï∞ÊçÆÁÆÄÂåñÂêéÔºåÂÖ±${renderPoints.length}‰∏™ÁÇπ...`);
        }

        // ÂàõÂª∫CanvasÂõæÂ±Ç
        createTrackCanvasLayer();
        const canvasLayer = trackCanvasLayer;
        
        // Ê†πÊçÆÁÇπÊï∞ÈÄâÊã©‰∏çÂêåÁöÑÊ∏≤ÊüìÁ≠ñÁï•
        if (renderPoints.length <= trackPointConfig.maxPointsForFullRender) {
            // Â∞èÊï∞ÊçÆÈáè - ‰∏ÄÊ¨°ÊÄßÊ∏≤Êüì
            renderAllPointsAtOnce(renderPoints, canvasLayer);
        } else if (renderPoints.length <= trackPointConfig.maxPointsForBatchRender) {
            // ‰∏≠Á≠âÊï∞ÊçÆÈáè - ÂàÜÊâπÊ∏≤Êüì
            renderPointsInBatches(renderPoints, canvasLayer);
        } else {
            // Â§ßÊï∞ÊçÆÈáè - Ë∂ÖÂ§ßÊâπÈáèÊ∏≤Êüì
            renderPointsInLargeBatches(renderPoints, canvasLayer);
        }
    }
    
    // ‰∏ÄÊ¨°ÊÄßÊ∏≤ÊüìÊâÄÊúâÁÇπÔºàÈÄÇÂêàÂ∞èÊï∞ÊçÆÈáèÔºâ
    function renderAllPointsAtOnce(points, canvasLayer) {
        requestAnimationFrame(() => {
            try {
                const circleMarkers = [];
                const pointColor = currentTrackPointColor;
                const radius = trackPointConfig.pointRadius;
                
                // È´òÊïàÂàõÂª∫ÊâÄÊúâÁÇπ
                for (let i = 0; i < points.length; i++) {
                    const point = points[i];
                    const circleMarker = L.circleMarker([point.lat, point.lng], {
                        radius: radius,
                        fillColor: pointColor,
                        color: pointColor,
                        weight: 0,
                        opacity: trackPointConfig.pointOpacity,
                        fillOpacity: trackPointConfig.pointOpacity,
                        renderer: canvasLayer,
                        interactive: true,
                        className: 'tiny-point'
                    });

                    circleMarker.on('click', function() {
                        this.bindPopup(`ËΩ®ËøπÁÇπ ${i + 1}<br>Êó∂Èó¥: ${point.timestamp}<br>ÁªèÂ∫¶: ${point.lng.toFixed(6)}<br>Á∫¨Â∫¶: ${point.lat.toFixed(6)}`).openPopup();
                    });

                    circleMarkers.push(circleMarker);
                }

                // ÊâπÈáèÊ∑ªÂä†Âà∞Âú∞Âõæ
                const canvasPoints = L.layerGroup(circleMarkers);
                canvasPoints.addTo(map);
                trackLayerGroup.addLayer(canvasPoints);

                // Ëá™ÈÄÇÂ∫îËßÜÈáé
                adjustMapView(points);
                
                updateStatus(`CanvasÊ∏≤ÊüìÂÆåÊàêÔºåÂÖ±${points.length}‰∏™ÁÇπ`);
                updatePlayerControls();
                
            } catch (error) {
                console.error('CanvasÊ∏≤ÊüìÈîôËØØ:', error);
                updateStatus('CanvasÊ∏≤ÊüìÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞ÂàÜÊâπÊ∏≤Êüì');
                renderPointsInBatches(points, canvasLayer);
            }
        });
    }
    
    // ÂàÜÊâπÊ∏≤ÊüìÔºàÈÄÇÂêà‰∏≠Á≠âÊï∞ÊçÆÈáèÔºâ
    function renderPointsInBatches(points, canvasLayer) {
        const totalPoints = points.length;
        const batchSize = trackPointConfig.batchSize;
        let currentBatch = 0;
        let processedCount = 0;
        const pointColor = currentTrackPointColor;
        const radius = trackPointConfig.pointRadius;
        
        function drawBatch() {
            const startIdx = currentBatch * batchSize;
            const endIdx = Math.min(startIdx + batchSize, totalPoints);
            
            const batchMarkers = [];
            for (let i = startIdx; i < endIdx; i++) {
                const point = points[i];
                const circleMarker = L.circleMarker([point.lat, point.lng], {
                    radius: radius,
                    fillColor: pointColor,
                    color: pointColor,
                    weight: 0,
                    opacity: trackPointConfig.pointOpacity,
                    fillOpacity: trackPointConfig.pointOpacity,
                    renderer: canvasLayer,
                    interactive: true,
                    className: 'tiny-point'
                });

                circleMarker.on('click', function() {
                    this.bindPopup(`ËΩ®ËøπÁÇπ ${i + 1}<br>Êó∂Èó¥: ${point.timestamp}<br>ÁªèÂ∫¶: ${point.lng.toFixed(6)}<br>Á∫¨Â∫¶: ${point.lat.toFixed(6)}`).openPopup();
                });

                batchMarkers.push(circleMarker);
            }

            const batchLayer = L.layerGroup(batchMarkers);
            batchLayer.addTo(map);
            trackLayerGroup.addLayer(batchLayer);

            processedCount += batchMarkers.length;
            currentBatch++;

            const progress = Math.round((processedCount / totalPoints) * 100);
            updateStatus(`ËΩ®ËøπÁÇπÊ∏≤Êüì‰∏≠... ${progress}% (${processedCount}/${totalPoints})`);

            if (processedCount < totalPoints) {
                setTimeout(drawBatch, 16); // 60fpsÁöÑÂ∏ßÈó¥Èöî
            } else {
                adjustMapView(points);
                updateStatus(`CanvasÊ∏≤ÊüìÂÆåÊàêÔºåÂÖ±${totalPoints}‰∏™ÁÇπ`);
                updatePlayerControls();
            }
        }

        drawBatch();
    }
    
    // Ë∂ÖÂ§ßÊâπÈáèÊ∏≤ÊüìÔºàÈÄÇÂêàÂ§ßÊï∞ÊçÆÈáèÔºâ
    function renderPointsInLargeBatches(points, canvasLayer) {
        const totalPoints = points.length;
        const batchSize = trackPointConfig.batchSize * 2; // Êõ¥Â§ßÁöÑÊâπÊ¨°
        let currentBatch = 0;
        let processedCount = 0;
        const pointColor = currentTrackPointColor;
        const radius = trackPointConfig.pointRadius;
        
        function drawLargeBatch() {
            const startIdx = currentBatch * batchSize;
            const endIdx = Math.min(startIdx + batchSize, totalPoints);
            
            const batchMarkers = [];
            for (let i = startIdx; i < endIdx; i++) {
                const point = points[i];
                const circleMarker = L.circleMarker([point.lat, point.lng], {
                    radius: radius,
                    fillColor: pointColor,
                    color: pointColor,
                    weight: 0,
                    opacity: trackPointConfig.pointOpacity,
                    fillOpacity: trackPointConfig.pointOpacity,
                    renderer: canvasLayer,
                    interactive: false,
                    className: 'tiny-point'
                });

                circleMarker.on('click', function() {
                    this.bindPopup(`ËΩ®ËøπÁÇπ ${i + 1}<br>Êó∂Èó¥: ${point.timestamp}<br>ÁªèÂ∫¶: ${point.lng.toFixed(6)}<br>Á∫¨Â∫¶: ${point.lat.toFixed(6)}`).openPopup();
                });

                batchMarkers.push(circleMarker);
            }

            const batchLayer = L.layerGroup(batchMarkers);
            batchLayer.addTo(map);
            trackLayerGroup.addLayer(batchLayer);

            processedCount += batchMarkers.length;
            currentBatch++;

            const progress = Math.round((processedCount / totalPoints) * 100);
            updateStatus(`ËΩ®ËøπÁÇπÊ∏≤Êüì‰∏≠... ${progress}% (${processedCount}/${totalPoints})`);

            if (processedCount < totalPoints) {
                setTimeout(drawLargeBatch, 32); // Êõ¥ÈïøÁöÑÈó¥ÈöîÔºåÈÅøÂÖçÈòªÂ°û
            } else {
                adjustMapView(points);
                updateStatus(`CanvasÊ∏≤ÊüìÂÆåÊàêÔºåÂÖ±${totalPoints}‰∏™ÁÇπ`);
                updatePlayerControls();
            }
        }

        drawLargeBatch();
    }
    
    // Ë∞ÉÊï¥Âú∞ÂõæËßÜÈáé
    function adjustMapView(points) {
        if (points.length === 1) {
            map.setView([points[0].lat, points[0].lng], map.getZoom());
        } else {
            const bounds = L.latLngBounds(points.map(p => [p.lat, p.lng]));
            map.fitBounds(bounds.pad(0.1));
        }
    }

    // ÂõûÈÄÄÊñπÊ°àÔºöÂàÜÊâπDOMÊ∏≤ÊüìÔºàÁî®‰∫éCanvasÂ§±Ë¥•ÁöÑÊÉÖÂÜµÔºâ
    function renderTrackPointsWithBatch(points) {
        const totalPoints = points.length;
        const batchSize = 500; // Â¢ûÂ§ßÊâπÊ¨°Â§ßÂ∞è
        let currentBatch = 0;
        let processedCount = 0;

        function drawBatch() {
            const startIdx = currentBatch * batchSize;
            const endIdx = Math.min(startIdx + batchSize, totalPoints);
            const batchPoints = points.slice(startIdx, endIdx);

            // ÊâπÈáèÂàõÂª∫CircleMarkerÔºà‰ΩøÁî®CanvasÊ∏≤ÊüìÔºâ
            const batchLayer = L.layerGroup();
            batchPoints.forEach((point, index) => {
                const actualIndex = startIdx + index;
                
                const circleMarker = L.circleMarker([point.lat, point.lng], {
                    radius: 0.5,
                    fillColor: currentTrackPointColor,
                    color: currentTrackPointColor,
                    weight: 0,
                    opacity: trackPointConfig.pointOpacity,
                    fillOpacity: trackPointConfig.pointOpacity,
                    interactive: true
                });

                circleMarker.on('click', function() {
                    this.bindPopup(`ËΩ®ËøπÁÇπ ${actualIndex + 1}<br>Êó∂Èó¥: ${point.timestamp}<br>ÁªèÂ∫¶: ${point.lng.toFixed(6)}<br>Á∫¨Â∫¶: ${point.lat.toFixed(6)}`).openPopup();
                });

                batchLayer.addLayer(circleMarker);
            });

            batchLayer.addTo(map);
            trackLayerGroup.addLayer(batchLayer);

            processedCount += batchPoints.length;
            currentBatch++;

            const progress = Math.round((processedCount / totalPoints) * 100);
            updateStatus(`ËΩ®ËøπÁÇπÁªòÂà∂‰∏≠... ${progress}% (${processedCount}/${totalPoints})`);

            if (processedCount < totalPoints) {
                setTimeout(drawBatch, 50); // Â¢ûÂä†Èó¥ÈöîÊó∂Èó¥
            } else {
                if (totalPoints === 1) {
                    map.setView([points[0].lat, points[0].lng], map.getZoom());
                } else {
                    const bounds = L.latLngBounds(points.map(p => [p.lat, p.lng]));
                    map.fitBounds(bounds.pad(0.1));
                }
                updateStatus(`ËΩ®ËøπÁÇπÁªòÂà∂ÂÆåÊàêÔºåÂÖ±${totalPoints}‰∏™ÁÇπ`);
                updatePlayerControls();
            }
        }

        drawBatch();
    }

    // Ëß£ÊûêËΩ®ËøπÁÇπ - ÂàÜÊâπÂ§ÑÁêÜÈÅøÂÖçÈ°µÈù¢Âç°Ê≠ª
    function parseTrackPoints(text) {
        try {
            const lines = text.trim().split('\n');
            const points = [];

            lines.forEach(line => {
                const parts = line.split(',');
                if (parts.length >= 3) {
                    const lng = parseFloat(parts[0].trim());
                    const lat = parseFloat(parts[1].trim());
                    const timestamp = parts[2].trim();

                    if (!isNaN(lng) && !isNaN(lat) && lat !== 0 && lng !== 0) {
                        points.push({
                            lat: lat,
                            lng: lng,
                            timestamp: timestamp,
                            time: parseTimestamp(timestamp)
                        });
                    }
                }
            });

            if (points.length > 0) {
                // ÊåâÊó∂Èó¥ÊéíÂ∫è
                points.sort((a, b) => a.time - b.time);

                // ‰øùÂ≠òËΩ®ËøπÁÇπÁî®‰∫éÂõûÊîæ
                playbackState.points = points;

                // ÂàÜÊâπÁªòÂà∂ËΩ®ËøπÁÇπÔºåÈÅøÂÖçÈ°µÈù¢Âç°Ê≠ª
                const batchSize = 100; // ÊØèÊâπÂ§ÑÁêÜ100‰∏™ÁÇπ
                let currentBatch = 0;
                let processedCount = 0;
                const totalPoints = points.length;

                updateStatus(`ÂºÄÂßãÁªòÂà∂ËΩ®ËøπÁÇπÔºåÂÖ±${totalPoints}‰∏™ÁÇπÔºåÂàÜÊâπÂ§ÑÁêÜ‰∏≠...`);

                function drawBatch() {
                    const startIdx = currentBatch * batchSize;
                    const endIdx = Math.min(startIdx + batchSize, totalPoints);
                    const batchPoints = points.slice(startIdx, endIdx);

                    // ÁªòÂà∂ÂΩìÂâçÊâπÊ¨°ÁöÑÁÇπ
                    batchPoints.forEach((point, index) => {
                        const actualIndex = startIdx + index;
                        
                        // ÂàõÂª∫ÊûÅÂ∞èÁöÑDivIcon
                        const tinyIcon = L.divIcon({
                            className: 'tiny-track-point',
                            html: `<div style="width: 1px; height: 1px; background-color: ${currentTrackPointColor}; border-radius: 50%;"></div>`,
                            iconSize: [1, 1],
                            iconAnchor: [0.5, 0.5]
                        });

                        const marker = L.marker([point.lat, point.lng], {
                            icon: tinyIcon,
                            opacity: 0.8
                        });

                        marker.bindPopup(`ËΩ®ËøπÁÇπ ${actualIndex + 1}<br>Êó∂Èó¥: ${point.timestamp}<br>ÁªèÂ∫¶: ${point.lng.toFixed(6)}<br>Á∫¨Â∫¶: ${point.lat.toFixed(6)}`);
                        trackLayerGroup.addLayer(marker);
                    });

                    processedCount += batchPoints.length;
                    currentBatch++;

                    // Êõ¥Êñ∞ËøõÂ∫¶Áä∂ÊÄÅ
                    const progress = Math.round((processedCount / totalPoints) * 100);
                    updateStatus(`ËΩ®ËøπÁÇπÁªòÂà∂‰∏≠... ${progress}% (${processedCount}/${totalPoints})`);

                    // Â¶ÇÊûúËøòÊúâÊú™Â§ÑÁêÜÁöÑÁÇπÔºåÁªßÁª≠‰∏ã‰∏ÄÊâπ
                    if (processedCount < totalPoints) {
                        // ‰ΩøÁî®setTimeoutËÆ©ÊµèËßàÂô®ÊúâÊó∂Èó¥Â§ÑÁêÜÂÖ∂‰ªñ‰ªªÂä°ÔºåÈÅøÂÖçÂç°Ê≠ª
                        setTimeout(drawBatch, 10);
                    } else {
                          // ÊâÄÊúâÁÇπÁªòÂà∂ÂÆåÊàê
                          updateStatus(`ËΩ®ËøπÁÇπÁªòÂà∂ÂÆåÊàêÔºåÂÖ±${totalPoints}‰∏™ÁÇπ`);
                          
                          // Êõ¥Êñ∞Êí≠ÊîæÂô®ÊéßÂà∂Áä∂ÊÄÅ
                          updatePlayerControls();
                      }
                }

                // ÂºÄÂßãÁ¨¨‰∏ÄÊâπÁªòÂà∂
                drawBatch();
            }
        } catch (error) {
            console.error('ËΩ®ËøπÁÇπËß£ÊûêÈîôËØØ:', error);
            updateStatus('ËΩ®ËøπÁÇπËß£ÊûêÂ§±Ë¥•');
        }
    }

    // Êó∂Èó¥Êà≥Ëß£Êûê
    function parseTimestamp(timestamp) {
        const tstr = (timestamp || '').replace(/\D/g, '');
        const m = tstr && tstr.match(/^\d{14}$/);
        if (!m) return null;

        const y = parseInt(tstr.slice(0, 4), 10);
        const M = parseInt(tstr.slice(4, 6), 10) - 1;
        const d = parseInt(tstr.slice(6, 8), 10);
        const h = parseInt(tstr.slice(8, 10), 10);
        const m2 = parseInt(tstr.slice(10, 12), 10);
        const s = parseInt(tstr.slice(12, 14), 10);
        const dt = new Date(y, M, d, h, m2, s);
        return isNaN(dt.getTime()) ? null : dt;
    }

    // Ê∏ÖÈô§ËΩ®Ëøπ
    function clearTrack() {
        trackLayerGroup.clearLayers();
        currentTrack = null;
        
        // Âè™ÊöÇÂÅúÂõûÊîæÔºå‰∏çÈáçÁΩÆcurrentIndexÂíåpointsÔºåËøôÊ†∑Áî®Êà∑ÂèØ‰ª•ÈáçÊñ∞ÁªòÂà∂ËΩ®ËøπÂêéÁªßÁª≠ÂõûÊîæ
        playbackState.isPlaying = false;
        if (playbackState.timer) {
            clearTimeout(playbackState.timer);
            playbackState.timer = null;
        }
        
        // Ê∏ÖÈô§ÂõûÊîæÂÖÉÁ¥†Ôºå‰ΩÜ‰øùÁïôpointsÊï∞ÊçÆ
        if (playbackState.marker) {
            map.removeLayer(playbackState.marker);
            playbackState.marker = null;
        }
        if (playbackState.polyline) {
            map.removeLayer(playbackState.polyline);
            playbackState.polyline = null;
        }

        // ÈáçÁΩÆÊí≠ÊîæÂô®Áä∂ÊÄÅÔºàÂ¶ÇÊûúÊí≠ÊîæÂô®ÂÖÉÁ¥†Â≠òÂú®Ôºâ
        if (playbackPlayer) {
            updatePlayerControls();
        }
        
        // Ê∏ÖÈô§ËΩ®ËøπÊó∂ÈáçÁΩÆËøõÂ∫¶Êù°ÂíåÊó∂Èó¥ÊòæÁ§∫
        if (playerProgressSlider) {
            playerProgressSlider.value = 0;
            playerProgressSlider.disabled = true;
        }
        // Âè™ÈáçÁΩÆÂΩìÂâçÊó∂Èó¥Ôºå‰øùÊåÅÁªìÊùüÊó∂Èó¥‰∏çÂèò
        const currentTimeElement = document.getElementById('currentTime');
        if (currentTimeElement) currentTimeElement.textContent = '00:00:00';
        // ‰∏çÈáçÁΩÆtotalTimeElementÔºå‰øùÊåÅÁªìÊùüÊó∂Èó¥ÊòæÁ§∫

        updateStatus('ËΩ®ËøπÂ∑≤Ê∏ÖÈô§');
    }

    // ËΩ®ËøπÂõûÊîæÊéßÂà∂ÂáΩÊï∞ - ‰ΩøÁî®Êñ∞ÁöÑÊí≠ÊîæÂô®ÊéßÂà∂Èù¢Êùø
    function startPlayback() {
        // Ê£ÄÊü•ÊòØÂê¶ÊúâËΩ®ËøπÁÇπ
        if (!playbackState.points || playbackState.points.length === 0) {
            updateStatus('ÊöÇÊó†ËΩ®ËøπÊï∞ÊçÆÔºåÊó†Ê≥ïÂºÄÂßãÂõûÊîæ');
            return;
        }

        if (playbackState.isPlaying) {
            return;
        }

        // ÂÅúÊ≠¢‰πãÂâçÁöÑÂõûÊîæÔºà‰ΩÜ‰∏çÈáçÁΩÆcurrentIndexÔºâ
        if (playbackState.timer) {
            clearTimeout(playbackState.timer);
            playbackState.timer = null;
        }

        playbackState.isPlaying = true;
        // ‰∏çÈáçÁΩÆcurrentIndexÔºå‰øùÊåÅÂΩìÂâçÊí≠Êîæ‰ΩçÁΩÆ

        // Â¶ÇÊûúÊí≠ÊîæÂÖÉÁ¥†‰∏çÂ≠òÂú®ÔºåÂàõÂª∫ÂÆÉ‰ª¨
        if (!playbackState.marker || !playbackState.polyline) {
            // Ê∏ÖÈô§‰πãÂâçÁöÑÂõûÊîæÂÖÉÁ¥†
            if (playbackState.marker) {
                map.removeLayer(playbackState.marker);
            }
            if (playbackState.polyline) {
                map.removeLayer(playbackState.polyline);
            }

            // ÂàõÂª∫ÂõûÊîæËΩ®ËøπÁ∫øÔºà‰ΩøÁî®ËøáÊª§ÂêéÁöÑÁÇπÔºâ
            const latlngs = playbackState.filteredPoints.map(p => [p.lat, p.lng]);
            playbackState.polyline = L.polyline(latlngs, {
                color: currentTrackLineColor,
                weight: 1,
                opacity: 1
            }).addTo(map);

            // ÂàõÂª∫ÂõûÊîæÊ†áËÆ∞Ôºà‰ΩøÁî®ËøáÊª§ÂêéÁöÑÁ¨¨‰∏Ä‰∏™ÁÇπÔºâ
            const firstPoint = playbackState.filteredPoints[0];
            playbackState.marker = L.circleMarker([firstPoint.lat, firstPoint.lng], {
                radius: 0.5,
                fillColor: currentTrackLineColor,
                color: '#FFFFFF',
                weight: 0.5,
                opacity: 1,
                fillOpacity: 1
            }).addTo(map);

            // Ëá™ÈÄÇÂ∫îËßÜÈáéÂà∞ËΩ®ËøπËåÉÂõ¥
            const bounds = playbackState.polyline.getBounds();
            if (bounds && bounds.isValid()) {
                map.fitBounds(bounds, { padding: [20, 20] });
            }
        }

        // Êõ¥Êñ∞Êí≠ÊîæÂô®ÊéßÂà∂Áä∂ÊÄÅ
        updatePlayerControls();
        
        // ËÆæÁΩÆËøõÂ∫¶Êù°ÂíåÊó∂Èó¥ÊòæÁ§∫Ôºà‰∏çÈáçÁΩÆËøõÂ∫¶Ôºâ
        if (playerProgressSlider) {
            playerProgressSlider.disabled = false;
            playerProgressSlider.max = 100;
            
            // Ê†πÊçÆËøáÊª§ÂêéÁöÑÁÇπËÆæÁΩÆÂàùÂßãËøõÂ∫¶
            if (playbackState.filteredPoints.length > 0) {
                const initialProgress = Math.round((playbackState.currentIndex / (playbackState.filteredPoints.length - 1)) * 100);
                playerProgressSlider.value = initialProgress;
            }
        }
        
        if (playerSpeedValue) {
            // ÊòæÁ§∫ÊåáÊï∞ÂÄçÊï∞
            const displaySpeed = playbackState.speed || 1;
            playerSpeedValue.textContent = displaySpeed + 'x';
        }

        // ÂàùÂßãÂåñÊó∂Èó¥ÊòæÁ§∫Ôºà‰ΩøÁî®ËøáÊª§ÂêéÁöÑÁÇπÔºâ
        if (playbackState.filteredPoints.length > 0) {
            const currentPoint = playbackState.filteredPoints[playbackState.currentIndex];
            const lastPoint = playbackState.filteredPoints[playbackState.filteredPoints.length - 1];
            
            if (currentPoint && lastPoint) {
                const currentTime = formatTime(currentPoint.timestamp);
                const totalTime = formatTime(lastPoint.timestamp);
                
                const currentTimeElement = document.getElementById('currentTime');
                const totalTimeElement = document.getElementById('totalTime');
                if (currentTimeElement) currentTimeElement.textContent = currentTime;
                if (totalTimeElement) totalTimeElement.textContent = totalTime;
            }
        }

        // ÂºÄÂßãÊí≠Êîæ
        playbackNextPoint();
        updateStatus('ËΩ®ËøπÂõûÊîæÂºÄÂßã');
    }

    function playbackNextPoint() {
        if (!playbackState.isPlaying || !playbackState.filteredPoints || playbackState.currentIndex >= playbackState.filteredPoints.length) {
            // Âè™ÊúâÂú®Êí≠ÊîæÂÆåÊàêÊó∂ÊâçÂÅúÊ≠¢Âπ∂ÈáçÁΩÆÔºåÊöÇÂÅúÊó∂‰∏çÂÅúÊ≠¢
            if (playbackState.currentIndex >= playbackState.filteredPoints.length) {
                // Êí≠ÊîæÂÆåÊàêÔºåÂè™ÈáçÁΩÆÁä∂ÊÄÅ‰ΩÜ‰∏çÊ∏ÖÈô§ËΩ®ËøπÁ∫ø
                playbackState.isPlaying = false;
                playbackState.currentIndex = 0;
                
                // Ê∏ÖÈô§ÂÆöÊó∂Âô®
                if (playbackState.timer) {
                    clearTimeout(playbackState.timer);
                    playbackState.timer = null;
                }
                
                // Ê∏ÖÈô§Ê†áËÆ∞Ôºà‰øùÁïôËΩ®ËøπÁ∫øÔºâ
                if (playbackState.marker) {
                    map.removeLayer(playbackState.marker);
                    playbackState.marker = null;
                }
                
                // Êí≠ÊîæÂÆåÊàêÊó∂‰∏çÈúÄË¶ÅÈáçÁΩÆÊó∂Èó¥ÊòæÁ§∫Ôºå‰øùÊåÅÂΩìÂâçÊó∂Èó¥
                // ‰πü‰∏çÈúÄË¶ÅÈáçÁΩÆËøõÂ∫¶Êù°‰ΩçÁΩÆ
                // const currentTimeElement = document.getElementById('currentTime');
                // const totalTimeElement = document.getElementById('totalTime');
                // if (currentTimeElement) currentTimeElement.textContent = '00:00:00';
                // if (totalTimeElement) totalTimeElement.textContent = '00:00:00';
                
                // Êõ¥Êñ∞Êí≠ÊîæÂô®ÊéßÂà∂Áä∂ÊÄÅÔºàÂ¶ÇÊûúÊí≠ÊîæÂô®ÂÖÉÁ¥†Â≠òÂú®Ôºâ
                if (playbackPlayer) {
                    updatePlayerControls();
                }
                
                updateStatus('ËΩ®ËøπÂõûÊîæÂÆåÊàê');
            }
            return;
        }

        const point = playbackState.filteredPoints[playbackState.currentIndex];

        // Êõ¥Êñ∞Ê†áËÆ∞‰ΩçÁΩÆ
        playbackState.marker.setLatLng([point.lat, point.lng]);
        playbackState.marker.bindPopup(`ÂõûÊîæÁÇπ ${playbackState.currentIndex + 1}<br>Êó∂Èó¥: ${point.timestamp}<br>ÁªèÂ∫¶: ${point.lng.toFixed(6)}<br>Á∫¨Â∫¶: ${point.lat.toFixed(6)}`);

        // Êõ¥Êñ∞ËΩ®ËøπÁ∫ø
        const currentLatlngs = playbackState.filteredPoints.slice(0, playbackState.currentIndex + 1).map(p => [p.lat, p.lng]);
        playbackState.polyline.setLatLngs(currentLatlngs);

        // Ê£ÄÊü•ÁÇπÊòØÂê¶Âú®Â±èÂπïÂèØËßÅËåÉÂõ¥ÂÜÖÔºåÂè™Êúâ‰∏çÂú®ÂèØËßÅËåÉÂõ¥ÂÜÖÊó∂ÊâçÂ±Ö‰∏≠
        const pointLatLng = L.latLng(point.lat, point.lng);
        const bounds = map.getBounds();
        
        // Â¶ÇÊûúÁÇπ‰∏çÂú®ÂΩìÂâçÂú∞ÂõæËæπÁïåÂÜÖÔºåÊàñËÄÖË∑ùÁ¶ªËæπÁïåÂ§™ËøëÔºàÂ∞è‰∫éÂú∞ÂõæÂÆΩÈ´òÁöÑ10%ÔºâÔºåÂàôÂ±Ö‰∏≠
        if (!bounds.contains(pointLatLng)) {
            // ÁÇπÂÆåÂÖ®‰∏çÂú®Â±èÂπïÂÜÖÔºåÈúÄË¶ÅÂ±Ö‰∏≠
            map.setView([point.lat, point.lng], map.getZoom(), {
                animate: true,
                duration: 0.3
            });
        } else {
            // ÁÇπÂú®Â±èÂπïÂÜÖÔºåÊ£ÄÊü•ÊòØÂê¶Èù†ËøëËæπÁïåÔºàË∑ùÁ¶ªËæπÁïåÂ∞è‰∫éÂú∞ÂõæÂÆΩÈ´òÁöÑ10%Ôºâ
            const boundsPad = bounds.pad(-0.1); // ÂÜÖÁº©10%ÁöÑËæπÁïå
            if (!boundsPad.contains(pointLatLng)) {
                // ÁÇπÈù†ËøëËæπÁïåÔºåÂ±Ö‰∏≠ÊòæÁ§∫
                map.setView([point.lat, point.lng], map.getZoom(), {
                    animate: true,
                    duration: 0.3
                });
            }
            // ÁÇπÂú®Â±èÂπï‰∏≠Â§ÆÂå∫ÂüüÔºå‰∏çÈúÄË¶ÅÂ±Ö‰∏≠
        }

        // Ê†ºÂºèÂåñÊó∂Èó¥ÊòæÁ§∫ÂáΩÊï∞
        function formatTime(timestamp) {
            const date = parseTimestamp(timestamp);
            if (!date) return '00:00:00';
            
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const seconds = date.getSeconds().toString().padStart(2, '0');
            return hours + ':' + minutes + ':' + seconds;
        }

        // Êõ¥Êñ∞ËøõÂ∫¶Êù°ÂíåÊó∂Èó¥ÊòæÁ§∫
        if (playerProgressSlider && playbackState.filteredPoints.length > 0) {
            const percentage = Math.round((playbackState.currentIndex / (playbackState.filteredPoints.length - 1)) * 100);
            playerProgressSlider.value = percentage;
        }
        
        // Êõ¥Êñ∞Êó∂Èó¥ÊòæÁ§∫ÔºàÂ¶ÇÊûúÊí≠ÊîæÂô®ÂÖÉÁ¥†Â≠òÂú®Ôºâ
        if (playbackState.filteredPoints.length > 0) {
            const currentPoint = playbackState.filteredPoints[playbackState.currentIndex];
            const lastPoint = playbackState.filteredPoints[playbackState.filteredPoints.length - 1];
            
            if (currentPoint && lastPoint) {
                const currentTime = formatTime(currentPoint.timestamp);
                const totalTime = formatTime(lastPoint.timestamp);
                
                // Êõ¥Êñ∞‰∏§Ë°åÊó∂Èó¥ÊòæÁ§∫
                const currentTimeElement = document.getElementById('currentTime');
                const totalTimeElement = document.getElementById('totalTime');
                if (currentTimeElement) currentTimeElement.textContent = currentTime;
                if (totalTimeElement) totalTimeElement.textContent = totalTime;
            }
        }

        // Êõ¥Êñ∞Áä∂ÊÄÅ
        const progress = Math.round((playbackState.currentIndex / (playbackState.filteredPoints.length - 1)) * 100);
        updateStatus(`ËΩ®ËøπÂõûÊîæ‰∏≠... ${progress}%`);

        playbackState.currentIndex++;

        // ËÆæÁΩÆ‰∏ã‰∏Ä‰∏™ÁÇπÁöÑÊí≠ÊîæÂª∂Ëøü
        const speed = playbackState.speed || 1;
        const delay = 1000 / speed; // ÈÄüÂ∫¶Ë∂äÂø´ÔºåÂª∂ËøüË∂äÁü≠

        playbackState.timer = setTimeout(playbackNextPoint, delay);
    }

    function pausePlayback() {
        playbackState.isPlaying = false;
        
        // Ê∏ÖÈô§ÂÆöÊó∂Âô®
        if (playbackState.timer) {
            clearTimeout(playbackState.timer);
            playbackState.timer = null;
        }
        
        // Êõ¥Êñ∞Êí≠ÊîæÂô®ÊéßÂà∂Áä∂ÊÄÅ
        if (playbackPlayer) {
            updatePlayerControls();
        }
        
        updateStatus('ËΩ®ËøπÂõûÊîæÂ∑≤ÊöÇÂÅú');
    }

    function stopPlayback() {
        playbackState.isPlaying = false;
        playbackState.currentIndex = 0;

        // Ê∏ÖÈô§ÂÆöÊó∂Âô®
        if (playbackState.timer) {
            clearTimeout(playbackState.timer);
            playbackState.timer = null;
        }

        // Ê∏ÖÈô§ÂõûÊîæÂÖÉÁ¥†
        if (playbackState.marker) {
            map.removeLayer(playbackState.marker);
            playbackState.marker = null;
        }
        if (playbackState.polyline) {
            map.removeLayer(playbackState.polyline);
            playbackState.polyline = null;
        }

        // ÈáçÁΩÆËøõÂ∫¶Êù°ÂíåÊó∂Èó¥ÊòæÁ§∫
        if (playerProgressSlider) {
            playerProgressSlider.value = 0;
        }
        // ÈáçÁΩÆÂΩìÂâçÊó∂Èó¥‰∏∫ËøáÊª§ÂêéËΩ®ËøπÁÇπÁöÑÁ¨¨‰∏Ä‰∏™ÁÇπÊó∂Èó¥
        const currentTimeElement = document.getElementById('currentTime');
        if (currentTimeElement && playbackState.filteredPoints && playbackState.filteredPoints.length > 0) {
            const firstPoint = playbackState.filteredPoints[0];
            if (firstPoint && firstPoint.timestamp) {
                currentTimeElement.textContent = formatTime(firstPoint.timestamp);
            } else {
                currentTimeElement.textContent = '00:00:00';
            }
        } else if (currentTimeElement) {
            currentTimeElement.textContent = '00:00:00';
        }
        // ‰∏çÈáçÁΩÆtotalTimeElementÔºå‰øùÊåÅÁªìÊùüÊó∂Èó¥ÊòæÁ§∫
        
        // Êõ¥Êñ∞Êí≠ÊîæÂô®ÊéßÂà∂Áä∂ÊÄÅÔºàÂ¶ÇÊûúÊí≠ÊîæÂô®ÂÖÉÁ¥†Â≠òÂú®Ôºâ
        if (playbackPlayer) {
            updatePlayerControls();
        }
        
        updateStatus('ËΩ®ËøπÂõûÊîæÂ∑≤ÂÅúÊ≠¢');

        // ÈáçÁΩÆÊªëÂùó
        const playbackTimeSlider = document.getElementById('playbackTimeSlider');
        if (playbackTimeSlider) {
            playbackTimeSlider.value = 0;
            playbackTimeSlider.disabled = true;
        }

        // ÂêåÊ≠•Êõ¥Êñ∞Â∫ïÈÉ®Âõ∫ÂÆöÊí≠ÊîæÊéßÂà∂Èù¢Êùø
        const playbackTimeSliderFixed = document.getElementById('playbackTimeSliderFixed');
        if (playbackTimeSliderFixed) {
            playbackTimeSliderFixed.value = 0;
            playbackTimeSliderFixed.disabled = true;
        }

        updateStatus('ËΩ®ËøπÂõûÊîæÂ∑≤ÂÅúÊ≠¢');
    }

    function jumpToPoint(index) {
        if (!playbackState.filteredPoints || index < 0 || index >= playbackState.filteredPoints.length) {
            return;
        }

        playbackState.currentIndex = index;

        // Â¶ÇÊûúÊ≠£Âú®Êí≠ÊîæÔºåÊöÇÂÅú
        if (playbackState.isPlaying) {
            pausePlayback();
        }

        // ÂàõÂª∫ÂõûÊîæÂÖÉÁ¥†ÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®Ôºâ
        if (!playbackState.marker) {
            const point = playbackState.filteredPoints[0];
            playbackState.marker = L.circleMarker([point.lat, point.lng], {
                radius: 0.5,
                fillColor: currentTrackLineColor,
                color: '#FFFFFF',
                weight: 0.5,
                opacity: 1,
                fillOpacity: 1
            }).addTo(map);
        }

        if (!playbackState.polyline) {
            const latlngs = playbackState.filteredPoints.map(p => [p.lat, p.lng]);
            playbackState.polyline = L.polyline(latlngs, {
                color: currentTrackLineColor,
                weight: 1,
                opacity: 1
            }).addTo(map);
        }

        // Ë∑≥ËΩ¨Âà∞ÊåáÂÆöÁÇπ
        const point = playbackState.filteredPoints[index];
        playbackState.marker.setLatLng([point.lat, point.lng]);
        playbackState.marker.bindPopup(`ÂõûÊîæÁÇπ ${index + 1}<br>Êó∂Èó¥: ${point.timestamp}<br>ÁªèÂ∫¶: ${point.lng.toFixed(6)}<br>Á∫¨Â∫¶: ${point.lat.toFixed(6)}`);

        // Êõ¥Êñ∞ËΩ®ËøπÁ∫ø
        const currentLatlngs = playbackState.filteredPoints.slice(0, index + 1).map(p => [p.lat, p.lng]);
        playbackState.polyline.setLatLngs(currentLatlngs);

        // Êõ¥Êñ∞Áä∂ÊÄÅ
        const progress = Math.round((index / (playbackState.filteredPoints.length - 1)) * 100);
        updateStatus(`ËΩ®ËøπÂõûÊîæÂ∑≤Ë∑≥ËΩ¨Âà∞ ${progress}%`);
    }

    // ÂàÜÂâ≤Âô®ÁªòÂà∂


    // ËΩ®ËøπÂõûÊîæÊéßÂà∂ - ‰ΩøÁî®Êñ∞ÁöÑÊí≠ÊîæÂô®ÊéßÂà∂Èù¢Êùø
    function startPlayback() {
        // Ê£ÄÊü•ÊòØÂê¶ÊúâËΩ®ËøπÁÇπ
        if (!playbackState.points || playbackState.points.length === 0) {
            updateStatus('ÊöÇÊó†ËΩ®ËøπÊï∞ÊçÆÔºåÊó†Ê≥ïÂºÄÂßãÂõûÊîæ');
            return;
        }

        if (playbackState.isPlaying) {
            return;
        }

        // Â∫îÁî®Êó∂Èó¥ËåÉÂõ¥ËøáÊª§
        applyTimeRangeFilter();
        
        // Ê£ÄÊü•ËøáÊª§ÂêéÁöÑËΩ®ËøπÁÇπ
        if (!playbackState.filteredPoints || playbackState.filteredPoints.length < 2) {
            updateStatus('ÊúâÊïàËΩ®ËøπÁÇπ‰∏çË∂≥ÔºåËá≥Â∞ëÈúÄË¶Å‰∏§ÁÇπ');
            return;
        }

        // ÂÅúÊ≠¢‰πãÂâçÁöÑÂõûÊîæÔºà‰ΩÜ‰∏çÈáçÁΩÆcurrentIndexÔºâ
        if (playbackState.timer) {
            clearTimeout(playbackState.timer);
            playbackState.timer = null;
        }

        playbackState.isPlaying = true;
        // ‰∏çÈáçÁΩÆcurrentIndexÔºå‰øùÊåÅÂΩìÂâçÊí≠Êîæ‰ΩçÁΩÆ

        // Â¶ÇÊûúÊí≠ÊîæÂÖÉÁ¥†‰∏çÂ≠òÂú®ÔºåÂàõÂª∫ÂÆÉ‰ª¨
        if (!playbackState.marker || !playbackState.polyline) {
            // Ê∏ÖÈô§‰πãÂâçÁöÑÂõûÊîæÂÖÉÁ¥†
            if (playbackState.marker) {
                map.removeLayer(playbackState.marker);
            }
            if (playbackState.polyline) {
                map.removeLayer(playbackState.polyline);
            }

            // ÂàõÂª∫ÂõûÊîæËΩ®ËøπÁ∫øÔºà‰ΩøÁî®ËøáÊª§ÂêéÁöÑÁÇπÔºâ
            const latlngs = playbackState.filteredPoints.map(p => [p.lat, p.lng]);
            playbackState.polyline = L.polyline(latlngs, {
                color: currentTrackLineColor,
                weight: 1,
                opacity: 1
            }).addTo(map);

            // ÂàõÂª∫ÂõûÊîæÊ†áËÆ∞Ôºà‰ΩøÁî®ËøáÊª§ÂêéÁöÑÁ¨¨‰∏Ä‰∏™ÁÇπÔºâ
            const firstPoint = playbackState.filteredPoints[0];
            playbackState.marker = L.circleMarker([firstPoint.lat, firstPoint.lng], {
                radius: 0.5,
                fillColor: currentTrackLineColor,
                color: '#FFFFFF',
                weight: 0.5,
                opacity: 1,
                fillOpacity: 1
            }).addTo(map);

            // Ëá™ÈÄÇÂ∫îËßÜÈáéÂà∞ËΩ®ËøπËåÉÂõ¥
            const bounds = playbackState.polyline.getBounds();
            if (bounds && bounds.isValid()) {
                map.fitBounds(bounds, { padding: [20, 20] });
            }
        }

        // Êõ¥Êñ∞Êí≠ÊîæÂô®ÊéßÂà∂Áä∂ÊÄÅ
        updatePlayerControls();
        
        // ËÆæÁΩÆËøõÂ∫¶Êù°ÂíåÊó∂Èó¥ÊòæÁ§∫Ôºà‰∏çÈáçÁΩÆËøõÂ∫¶Ôºâ
        if (playerProgressSlider) {
            playerProgressSlider.disabled = false;
            playerProgressSlider.max = 100;
        }
        
        if (playerSpeedValue) {
            // ÊòæÁ§∫ÊåáÊï∞ÂÄçÊï∞
            const displaySpeed = playbackState.speed || 1;
            playerSpeedValue.textContent = displaySpeed + 'x';
        }

        // ÂºÄÂßãÊí≠Êîæ
        playbackNextPoint();
        updateStatus('ËΩ®ËøπÂõûÊîæÂºÄÂßã');
    }

    function stopPlayback() {
        playbackState.isPlaying = false;
        playbackState.currentIndex = 0;

        // Ê∏ÖÈô§ÂÆöÊó∂Âô®
        if (playbackState.timer) {
            clearTimeout(playbackState.timer);
            playbackState.timer = null;
        }

        // Ê∏ÖÈô§ÂõûÊîæÂÖÉÁ¥†
        if (playbackState.marker) {
            map.removeLayer(playbackState.marker);
            playbackState.marker = null;
        }
        if (playbackState.polyline) {
            map.removeLayer(playbackState.polyline);
            playbackState.polyline = null;
        }

        // ÈáçÁΩÆËøõÂ∫¶Êù°ÂíåÊó∂Èó¥ÊòæÁ§∫
        if (playerProgressSlider) {
            playerProgressSlider.value = 0;
        }
        // ÈáçÁΩÆÂΩìÂâçÊó∂Èó¥‰∏∫ËøáÊª§ÂêéËΩ®ËøπÁÇπÁöÑÁ¨¨‰∏Ä‰∏™ÁÇπÊó∂Èó¥
        const currentTimeElement = document.getElementById('currentTime');
        if (currentTimeElement && playbackState.filteredPoints && playbackState.filteredPoints.length > 0) {
            const firstPoint = playbackState.filteredPoints[0];
            if (firstPoint && firstPoint.timestamp) {
                currentTimeElement.textContent = formatTime(firstPoint.timestamp);
            } else {
                currentTimeElement.textContent = '00:00:00';
            }
        } else if (currentTimeElement) {
            currentTimeElement.textContent = '00:00:00';
        }
        
        // Êõ¥Êñ∞Êí≠ÊîæÂô®ÊéßÂà∂Áä∂ÊÄÅÔºàÂ¶ÇÊûúÊí≠ÊîæÂô®ÂÖÉÁ¥†Â≠òÂú®Ôºâ
        if (playbackPlayer) {
            updatePlayerControls();
        }
        
        updateStatus('ËΩ®ËøπÂõûÊîæÂ∑≤ÂÅúÊ≠¢');
    }

    function scheduleNextPlayback() {
        if (!playbackState.isPlaying || !playbackState.filteredPoints || playbackState.currentIndex >= playbackState.filteredPoints.length - 1) {
            if (playbackState.currentIndex >= playbackState.filteredPoints.length - 1) {
                updateStatus('ËΩ®ËøπÂõûÊîæÂÆåÊàê');
                // Êí≠ÊîæÂÆåÊàêÊó∂‰∏çÊ∏ÖÈô§ËΩ®ËøπÁ∫øÔºåÂè™ÂÅúÊ≠¢Êí≠ÊîæÂπ∂ÈáçÁΩÆÁä∂ÊÄÅ
                playbackState.isPlaying = false;
                playbackState.currentIndex = 0;
                
                // Ê∏ÖÈô§ÂÆöÊó∂Âô®
                if (playbackState.timer) {
                    clearTimeout(playbackState.timer);
                    playbackState.timer = null;
                }
                
                // Âè™Ê∏ÖÈô§Ê†áËÆ∞Ôºå‰øùÁïôËΩ®ËøπÁ∫ø
                if (playbackState.marker) {
                    map.removeLayer(playbackState.marker);
                    playbackState.marker = null;
                }
                
                // ÈáçÁΩÆÂΩìÂâçÊó∂Èó¥Ôºå‰øùÊåÅÁªìÊùüÊó∂Èó¥‰∏çÂèòÔºà‰øùÁïôËøõÂ∫¶Êù°‰ΩçÁΩÆÔºâ
                const currentTimeElement = document.getElementById('currentTime');
                if (currentTimeElement) currentTimeElement.textContent = '00:00:00';
                // ‰∏çÈáçÁΩÆtotalTimeElementÔºå‰øùÊåÅÁªìÊùüÊó∂Èó¥ÊòæÁ§∫
                
                // Êõ¥Êñ∞Êí≠ÊîæÂô®ÊéßÂà∂Áä∂ÊÄÅ
                if (playbackPlayer) {
                    updatePlayerControls();
                }
                
                // Êí≠ÊîæÂÆåÊàêÊó∂‰∏çÈúÄË¶ÅÈáçÁΩÆÊó∂Èó¥ÊªëÂùóÔºå‰øùÊåÅÂΩìÂâç‰ΩçÁΩÆ
                // const playbackTimeSlider = document.getElementById('playbackTimeSlider');
                // if (playbackTimeSlider) {
                //     playbackTimeSlider.value = 0;
                //     playbackTimeSlider.disabled = true;
                // }
                
                // ÂêåÊ≠•Êõ¥Êñ∞Â∫ïÈÉ®Âõ∫ÂÆöÊí≠ÊîæÊéßÂà∂Èù¢Êùø
                // const playbackTimeSliderFixed = document.getElementById('playbackTimeSliderFixed');
                // if (playbackTimeSliderFixed) {
                //     playbackTimeSliderFixed.value = 0;
                //     playbackTimeSliderFixed.disabled = true;
                // }
            }
            return; // Â¶ÇÊûúÊòØÊöÇÂÅúÔºåÁõ¥Êé•ËøîÂõûÔºå‰∏çÂÅúÊ≠¢Êí≠Êîæ
        }

        const next = playbackState.filteredPoints[playbackState.currentIndex + 1];
        const speed = playbackState.speed || 1;
        const delay = Math.max(100, Math.round(1000 / speed));

        playbackState.timer = setTimeout(() => {
            playbackState.currentIndex++;

            // Êõ¥Êñ∞Ê†áËÆ∞‰ΩçÁΩÆ
            if (playbackState.marker) {
                playbackState.marker.setLatLng([next.lat, next.lng]);
                playbackState.marker.bindPopup(`ÂõûÊîæÁÇπ ${playbackState.currentIndex + 1}<br>Êó∂Èó¥: ${next.timestamp}<br>ÁªèÂ∫¶: ${next.lng.toFixed(6)}<br>Á∫¨Â∫¶: ${next.lat.toFixed(6)}`);
            }

            // Êõ¥Êñ∞ËΩ®ËøπÁ∫ø
            if (playbackState.polyline) {
                const currentLatlngs = playbackState.filteredPoints.slice(0, playbackState.currentIndex + 1).map(p => [p.lat, p.lng]);
                playbackState.polyline.setLatLngs(currentLatlngs);
            }

            // Ê£ÄÊü•ÁÇπÊòØÂê¶Âú®Â±èÂπïÂèØËßÅËåÉÂõ¥ÂÜÖÔºåÂè™Êúâ‰∏çÂú®ÂèØËßÅËåÉÂõ¥ÂÜÖÊó∂ÊâçÂ±Ö‰∏≠
            const pointLatLng = L.latLng(next.lat, next.lng);
            const bounds = map.getBounds();
            
            // Â¶ÇÊûúÁÇπ‰∏çÂú®ÂΩìÂâçÂú∞ÂõæËæπÁïåÂÜÖÔºåÊàñËÄÖË∑ùÁ¶ªËæπÁïåÂ§™ËøëÔºàÂ∞è‰∫éÂú∞ÂõæÂÆΩÈ´òÁöÑ10%ÔºâÔºåÂàôÂ±Ö‰∏≠
            if (!bounds.contains(pointLatLng)) {
                // ÁÇπÂÆåÂÖ®‰∏çÂú®Â±èÂπïÂÜÖÔºåÈúÄË¶ÅÂ±Ö‰∏≠
                map.setView([next.lat, next.lng], map.getZoom(), {
                    animate: true,
                    duration: 0.3
                });
            } else {
                // ÁÇπÂú®Â±èÂπïÂÜÖÔºåÊ£ÄÊü•ÊòØÂê¶Èù†ËøëËæπÁïåÔºàË∑ùÁ¶ªËæπÁïåÂ∞è‰∫éÂú∞ÂõæÂÆΩÈ´òÁöÑ10%Ôºâ
                const boundsPad = bounds.pad(-0.1); // ÂÜÖÁº©10%ÁöÑËæπÁïå
                if (!boundsPad.contains(pointLatLng)) {
                    // ÁÇπÈù†ËøëËæπÁïåÔºåÂ±Ö‰∏≠ÊòæÁ§∫
                    map.setView([next.lat, next.lng], map.getZoom(), {
                        animate: true,
                        duration: 0.3
                    });
                }
                // ÁÇπÂú®Â±èÂπï‰∏≠Â§ÆÂå∫ÂüüÔºå‰∏çÈúÄË¶ÅÂ±Ö‰∏≠
            }

            // Êõ¥Êñ∞ËøõÂ∫¶Êù°ÂíåÊó∂Èó¥ÊòæÁ§∫
            if (playerProgressSlider && playbackState.filteredPoints.length > 0) {
                const percentage = Math.round((playbackState.currentIndex / (playbackState.filteredPoints.length - 1)) * 100);
                playerProgressSlider.value = percentage;
            }
            
            if (playbackState.filteredPoints.length > 0) {
                const currentPoint = playbackState.filteredPoints[playbackState.currentIndex];
                const lastPoint = playbackState.filteredPoints[playbackState.filteredPoints.length - 1];
                
                if (currentPoint && lastPoint) {
                    const currentTime = formatTime(currentPoint.timestamp);
                    const totalTime = formatTime(lastPoint.timestamp);
                    
                    // Êõ¥Êñ∞‰∏§Ë°åÊó∂Èó¥ÊòæÁ§∫
                    const currentTimeElement = document.getElementById('currentTime');
                    const totalTimeElement = document.getElementById('totalTime');
                    if (currentTimeElement) currentTimeElement.textContent = currentTime;
                    if (totalTimeElement) totalTimeElement.textContent = totalTime;
                }
            }

            // ÁªßÁª≠‰∏ã‰∏Ä‰∏™ÁÇπ
            scheduleNextPlayback();
        }, delay);
    }

    // Ê†ºÂºèÂåñÊó∂Èó¥ÊòæÁ§∫ÂáΩÊï∞
    function formatTime(timestamp) {
        const date = parseTimestamp(timestamp);
        if (!date) return '00:00';
        
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        return hours + ':' + minutes;
    }

    // ÊóßÁâàÊó∂Èó¥ÊªëÂùóÈÖçÁΩÆÂáΩÊï∞ - Â∑≤Â∫üÂºÉÔºå‰øùÁïôÂÖºÂÆπÊÄß
    function configureTimeSlider() {
        const slider = document.getElementById('playbackTimeSlider');
        if (!slider) return;

        // Á©∫ËΩ®ËøπÊó∂ËÆæÁΩÆÊªëÂùó‰∏∫Á¶ÅÁî®Áä∂ÊÄÅ
        if (playbackState.filteredPoints.length === 0) {
            slider.disabled = true;
            slider.min = 0;
            slider.max = 0;
            slider.value = 0;
            
            // ÂêåÊ≠•Êõ¥Êñ∞Â∫ïÈÉ®Âõ∫ÂÆöÊí≠ÊîæÊéßÂà∂Èù¢Êùø
            const sliderFixed = document.getElementById('playbackTimeSliderFixed');
            if (sliderFixed) {
                sliderFixed.disabled = true;
                sliderFixed.min = 0;
                sliderFixed.max = 0;
                sliderFixed.value = 0;
            }
            return;
        }

        slider.disabled = false;
        slider.min = 0;
        slider.max = playbackState.filteredPoints.length - 1;
        // ‰∏çÈáçÁΩÆÊªëÂùóÂÄºÔºå‰øùÊåÅÂΩìÂâçÊí≠Êîæ‰ΩçÁΩÆ
        if (playbackState.currentIndex >= 0 && playbackState.currentIndex < playbackState.filteredPoints.length) {
            slider.value = playbackState.currentIndex;
        }

        // ÂêåÊ≠•Êõ¥Êñ∞Â∫ïÈÉ®Âõ∫ÂÆöÊí≠ÊîæÊéßÂà∂Èù¢Êùø
        const sliderFixed = document.getElementById('playbackTimeSliderFixed');
        if (sliderFixed) {
            sliderFixed.disabled = false;
            sliderFixed.min = 0;
            sliderFixed.max = playbackState.filteredPoints.length - 1;
            // ‰∏çÈáçÁΩÆÊªëÂùóÂÄºÔºå‰øùÊåÅÂΩìÂâçÊí≠Êîæ‰ΩçÁΩÆ
            if (playbackState.currentIndex >= 0 && playbackState.currentIndex < playbackState.filteredPoints.length) {
                sliderFixed.value = playbackState.currentIndex;
            }
        }
    }

    function updateTimeSlider() {
        const slider = document.getElementById('playbackTimeSlider');
        if (slider) {
            slider.value = playbackState.currentIndex;
        }

        // ÂêåÊ≠•Êõ¥Êñ∞Â∫ïÈÉ®Âõ∫ÂÆöÊí≠ÊîæÊéßÂà∂Èù¢Êùø
        const sliderFixed = document.getElementById('playbackTimeSliderFixed');
        if (sliderFixed) {
            sliderFixed.value = playbackState.currentIndex;
        }
    }

    function updatePlaybackTimeLabel(timestamp) {
        const label = document.getElementById('playbackTimeLabel');
        if (label) {
            if (timestamp) {
                label.textContent = `Êó∂Èó¥: ${timestamp}`;
            } else {
                label.textContent = 'Êó∂Èó¥: --';
            }
        }

        // ÂêåÊ≠•Êõ¥Êñ∞Â∫ïÈÉ®Âõ∫ÂÆöÊí≠ÊîæÊéßÂà∂Èù¢Êùø
        const labelFixed = document.getElementById('playbackTimeLabelFixed');
        if (labelFixed) {
            if (timestamp) {
                labelFixed.textContent = `Êó∂Èó¥: ${timestamp}`;
            } else {
                labelFixed.textContent = 'Êó∂Èó¥: --';
            }
        }
    }

    // ÊµãÈáèÂäüËÉΩ


    function startMeasureDistance() {
        if (!map) return;

        clearMeasureResult();

        measureState.isActive = true;
        measureState.mode = 'distance';

        // Á¶ÅÁî®ÊµãÈáèÊåâÈíÆ
        document.getElementById('measureDistanceBtn').classList.add('active');
        document.getElementById('measureAreaBtn').disabled = true;

        // Á¶ÅÁî®Âú∞ÂõæÂèåÂáªÁº©ÊîæÂäüËÉΩ
        map.doubleClickZoom.disable();

        // ËÆæÁΩÆÊõ¥ÁÅµÊïèÁöÑÂèåÂáªÊ£ÄÊµãÂèÇÊï∞
        if (map.options) {
            map.options.doubleClickZoom = false;
            map.options.tap = false; // Á¶ÅÁî®Ëß¶Êë∏Âª∂Ëøü
        }

        // ËÆæÁΩÆÊõ¥ÁÅµÊïèÁöÑÂèåÂáªÊ£ÄÊµãÂèÇÊï∞
        if (map.options) {
            map.options.doubleClickZoom = false;
            map.options.tap = false; // Á¶ÅÁî®Ëß¶Êë∏Âª∂Ëøü
        }

        // ÁªëÂÆöÂú∞Âõæ‰∫ã‰ª∂
        map.on('click', handleMeasureClick);
        map.on('mousemove', handleMeasureMouseMove);
        map.on('contextmenu', handleDistanceMeasureRightClick); // Âè≥ÈîÆÁªìÊùüÊµãÈáè

        updateStatus('ÊµãË∑ùÊ®°ÂºèÂ∑≤ÊøÄÊ¥ªÔºåÁÇπÂáªÂú∞ÂõæÂºÄÂßãÊµãÈáèÔºåÂè≥ÈîÆÁªìÊùüÊµãÈáè');
    }

    // Âè≥ÈîÆÁªìÊùüÊµãË∑ù
    function handleDistanceMeasureRightClick(e) {
        // ÈòªÊ≠¢Âè≥ÈîÆËèúÂçïÁöÑÈªòËÆ§Ë°å‰∏∫
        if (e && e.originalEvent) {
            e.originalEvent.preventDefault();
            e.originalEvent.stopPropagation();
        }

        // Á°Æ‰øùËá≥Â∞ëÊúâ2‰∏™ÁÇπÊâçËÉΩÂΩ¢ÊàêÁ∫øÊÆµ
        if (measureState.points.length >= 2) {
            finishMeasureDistance();
        } else {
            alert('ËØ∑Ëá≥Â∞ëÁÇπÂáª2‰∏™ÁÇπÂΩ¢ÊàêÁ∫øÊÆµÂêéÂÜçÂè≥ÈîÆÁªìÊùüÊµãÈáè');
        }

        return false;
    }

    // Âè≥ÈîÆÁªìÊùüÊµãÈù¢
    function handleAreaMeasureRightClick(e) {
        // ÈòªÊ≠¢Âè≥ÈîÆËèúÂçïÁöÑÈªòËÆ§Ë°å‰∏∫
        if (e && e.originalEvent) {
            e.originalEvent.preventDefault();
            e.originalEvent.stopPropagation();
        }

        // Á°Æ‰øùËá≥Â∞ëÊúâ3‰∏™ÁÇπÊâçËÉΩÂΩ¢ÊàêÂ§öËæπÂΩ¢
        if (measureState.points.length >= 3) {
            finishMeasureArea();
        } else {
            alert('ËØ∑Ëá≥Â∞ëÁÇπÂáª3‰∏™ÁÇπÂΩ¢ÊàêÂ§öËæπÂΩ¢ÂêéÂÜçÂè≥ÈîÆÁªìÊùüÊµãÈáè');
        }

        return false;
    }

    function startMeasureArea() {
        if (!map) return;

        clearMeasureResult();

        measureState.isActive = true;
        measureState.mode = 'area';

        // Á¶ÅÁî®ÊµãÈáèÊåâÈíÆ
        document.getElementById('measureAreaBtn').classList.add('active');
        document.getElementById('measureDistanceBtn').disabled = true;

        // Á¶ÅÁî®Âú∞ÂõæÂèåÂáªÁº©ÊîæÂäüËÉΩ
        map.doubleClickZoom.disable();

        // ÁªëÂÆöÂú∞Âõæ‰∫ã‰ª∂
        map.on('click', handleMeasureClick);
        map.on('mousemove', handleMeasureMouseMove);
        map.on('contextmenu', handleAreaMeasureRightClick); // Âè≥ÈîÆÁªìÊùüÊµãÈáè

        updateStatus('ÊµãÈù¢Ê®°ÂºèÂ∑≤ÊøÄÊ¥ªÔºåÁÇπÂáªÂú∞ÂõæÂºÄÂßãÊµãÈáèÔºåÂè≥ÈîÆÁªìÊùüÊµãÈáè');
    }

    function handleMeasureClick(e) {
    if (!measureState.isActive) return;

    // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°ÔºåÈÅøÂÖçÂπ≤Êâ∞ÂèåÂáªÊ£ÄÊµã
    if (e && e.originalEvent) {
        e.originalEvent.stopPropagation();
    }

    const point = e.latlng;
    measureState.points.push(point);

    // ÂàõÂª∫ÁÇπÊ†áËÆ∞
    const marker = L.circleMarker(point, {
        color: currentOutlineColor,
        fillColor: currentFillColor,
        fillOpacity: 1,
        radius: 0.5
    });

    measureLayerGroup.addLayer(marker);
    measureState.markers.push(marker);

    if (measureState.mode === 'distance') {
        // ÊµãË∑ùÈÄªËæë
        if (measureState.points.length > 1) {
            const lastPoint = measureState.points[measureState.points.length - 2];
            const newLine = L.polyline([lastPoint, point], {
                color: currentOutlineColor,
                weight: 1,
                opacity: 1
            });

            measureLayerGroup.addLayer(newLine);
            measureState.lines.push(newLine);

            // Êõ¥Êñ∞Ë∑ùÁ¶ªÊ†áÁ≠æ
            const distance = calculateDistance(lastPoint, point);
            const center = L.latLng(
                (lastPoint.lat + point.lat) / 2,
                (lastPoint.lng + point.lng) / 2
            );
            showDistanceLabel(center, distance);
        }
    } else if (measureState.mode === 'area') {
        // ÊµãÈù¢ÈÄªËæë
        if (measureState.points.length > 1) {
            // ÂàõÂª∫Á∫øÊÆµ
            const lastPoint = measureState.points[measureState.points.length - 2];
            const newLine = L.polyline([lastPoint, point], {
                color: currentOutlineColor,
                weight: 1,
                opacity: 1
            });

            measureLayerGroup.addLayer(newLine);
            measureState.lines.push(newLine);
        }

        // ÂΩìÊúâ3‰∏™ÊàñÊõ¥Â§öÁÇπÊó∂ÔºåÊõ¥Êñ∞Â§öËæπÂΩ¢Ôºà‰ΩÜ‰∏çÊòæÁ§∫Ê†áÁ≠æÔºâ
        if (measureState.points.length >= 3) {
            // ÁßªÈô§‰πãÂâçÁöÑÂ§öËæπÂΩ¢
            if (measureState.polygon) {
                measureLayerGroup.removeLayer(measureState.polygon);
            }

            // ÂàõÂª∫Êñ∞ÁöÑÂ§öËæπÂΩ¢
            measureState.polygon = L.polygon(measureState.points, {
                color: currentOutlineColor,
                weight: 1,
                opacity: 1,
                fillColor: currentFillColor,
                fillOpacity: 0.5
            });

            measureLayerGroup.addLayer(measureState.polygon);

            // Ê≥®ÊÑèÔºöËøôÈáå‰∏çÂÜçÊòæÁ§∫Èù¢ÁßØÊ†áÁ≠æÔºåÂè™Âú®ÂèåÂáªÁªìÊùüÊó∂ÊòæÁ§∫
        }
    }
}

    function handleMeasureMouseMove(e) {
        if (!measureState.isActive || measureState.points.length === 0) return;

        const lastPoint = measureState.points[measureState.points.length - 1];
        const currentPoint = e.latlng;

        // ÁßªÈô§‰πãÂâçÁöÑ‰∏¥Êó∂Á∫ø
        if (measureState.tempLine) {
            measureLayerGroup.removeLayer(measureState.tempLine);
        }

        // ÂàõÂª∫Êñ∞ÁöÑ‰∏¥Êó∂Á∫ø
        let tempCoords = [lastPoint, currentPoint];

        // Â¶ÇÊûúÊòØÈù¢ÁßØÊµãÈáèÔºåÊ∑ªÂä†Èó≠ÂêàÁ∫ø
        if (measureState.mode === 'area' && measureState.points.length >= 2) {
            tempCoords.push(measureState.points[0]);
        }

        measureState.tempLine = L.polyline(tempCoords, {
            color: '#FFFF00',
            weight: 1,
            opacity: 1,
            dashArray: '5, 5'
        });

        measureLayerGroup.addLayer(measureState.tempLine);
    }

    function updateMeasurePolygon() {
        // ÁßªÈô§‰πãÂâçÁöÑÂ§öËæπÂΩ¢
        if (measureState.polygon) {
            measureLayerGroup.removeLayer(measureState.polygon);
        }

        // ÂàõÂª∫Êñ∞ÁöÑÂ§öËæπÂΩ¢
        measureState.polygon = L.polygon(measureState.points, {
            color: currentOutlineColor,
            weight: 1,
            opacity: 1,
            fillColor: currentFillColor,
            fillOpacity: 0.5
        });

        measureLayerGroup.addLayer(measureState.polygon);

        // ËÆ°ÁÆóÂπ∂ÊòæÁ§∫Èù¢ÁßØ
        const area = calculatePolygonArea(measureState.points);
        const center = getPolygonCenter(measureState.points);
        showAreaLabel(center, area);
    }

    function finishMeasureDistance() {
        if (!measureState.isActive || measureState.mode !== 'distance') return;

        // ÁßªÈô§‰∫ã‰ª∂ÁõëÂê¨
        map.off('click', handleMeasureClick);
        map.off('mousemove', handleMeasureMouseMove);
        map.off('contextmenu', handleDistanceMeasureRightClick);

        // ÈáçÊñ∞ÂêØÁî®Âú∞ÂõæÂèåÂáªÁº©ÊîæÂäüËÉΩ
        map.doubleClickZoom.enable();

        // ÊÅ¢Â§çÂú∞ÂõæÈÄâÈ°πËÆæÁΩÆ
        if (map.options) {
            map.options.doubleClickZoom = true;
            map.options.tap = true;
        }

        // ÊÅ¢Â§çÂú∞ÂõæÈÄâÈ°πËÆæÁΩÆ
        if (map.options) {
            map.options.doubleClickZoom = true;
            map.options.tap = true;
        }

        // ÁßªÈô§‰∏¥Êó∂Á∫ø
        if (measureState.tempLine) {
            measureLayerGroup.removeLayer(measureState.tempLine);
            measureState.tempLine = null;
        }

        // ÊòæÁ§∫ÊÄªË∑ùÁ¶ª
        if (measureState.points.length > 1) {
            const totalDistance = calculateTotalDistance();
            showTotalDistanceLabel(totalDistance);

            // ÈáçÊñ∞ÂàõÂª∫ÊúÄÁªàÁöÑÁ∫øÊÆµ‰ª•Á°Æ‰øùÊòæÁ§∫Ê≠£Á°Æ
            if (measureState.line) {
                measureLayerGroup.removeLayer(measureState.line);
            }

            measureState.line = L.polyline(measureState.points, {
                color: currentOutlineColor,
                weight: 1,
                opacity: 1
            });

            measureLayerGroup.addLayer(measureState.line);
        }

        // ÈáçÁΩÆÁä∂ÊÄÅ
        measureState.isActive = false;
        measureState.mode = '';

        // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
        document.getElementById('measureDistanceBtn').classList.remove('active');
        document.getElementById('measureAreaBtn').disabled = false;

        updateStatus('ÊµãË∑ùÂÆåÊàêÔºåÊÄªË∑ùÁ¶ªÂ∑≤ÊòæÁ§∫');
    }

    function finishMeasureArea() {
        if (!measureState.isActive || measureState.mode !== 'area') return;

        // ÁßªÈô§‰∫ã‰ª∂ÁõëÂê¨
        map.off('click', handleMeasureClick);
        map.off('mousemove', handleMeasureMouseMove);
        map.off('contextmenu', handleAreaMeasureRightClick);

        // ÈáçÊñ∞ÂêØÁî®Âú∞ÂõæÂèåÂáªÁº©ÊîæÂäüËÉΩ
        map.doubleClickZoom.enable();

        // ÁßªÈô§‰∏¥Êó∂Á∫ø
        if (measureState.tempLine) {
            measureLayerGroup.removeLayer(measureState.tempLine);
            measureState.tempLine = null;
        }

        // Â¶ÇÊûúÁÇπÊï∞>=3ÔºåÊòæÁ§∫ÊÄªÈù¢ÁßØ
        if (measureState.points.length >= 3) {
            // Á°Æ‰øùÂ§öËæπÂΩ¢ÊòØÈó≠ÂêàÁöÑ
            const lastPoint = measureState.points[measureState.points.length - 1];
            const firstPoint = measureState.points[0];

            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÈó≠ÂêàÔºàÈ¶ñÂ∞æÁÇπÊòØÂê¶Áõ∏ÂêåÔºâ
            if (lastPoint.lat !== firstPoint.lat || lastPoint.lng !== firstPoint.lng) {
                // Â¶ÇÊûúÊú™Èó≠ÂêàÔºåÂ∞ÜÈ¶ñÁÇπÊ∑ªÂä†Âà∞Êú´Â∞æ‰ª•ÂΩ¢ÊàêÈó≠ÂêàÂ§öËæπÂΩ¢
                measureState.points.push(L.latLng(firstPoint.lat, firstPoint.lng));
            }

            const area = calculatePolygonArea(measureState.points);
            const center = getPolygonCenter(measureState.points);

            // Ê∏ÖÈô§‰πãÂâçÁöÑÈù¢ÁßØÊ†áÁ≠æÔºàÂ¶ÇÊûúÊúâÔºâ
            if (measureState.areaLabel) {
                measureLayerGroup.removeLayer(measureState.areaLabel);
                measureState.areaLabel = null;
            }

            // ÊòæÁ§∫ÊÄªÈù¢ÁßØÊ†áÁ≠æÔºàÂπ≥ÊñπÁ±≥+‰∫©Êï∞Ôºâ
            showTotalAreaLabel(center, area);

            // ÈáçÊñ∞ÂàõÂª∫ÊúÄÁªàÁöÑÂ§öËæπÂΩ¢‰ª•Á°Æ‰øùÈó≠Âêà
            if (measureState.polygon) {
                measureLayerGroup.removeLayer(measureState.polygon);
            }

            measureState.polygon = L.polygon(measureState.points, {
                color: currentOutlineColor,
                weight: 1,
                opacity: 1,
                fillColor: currentFillColor,
                fillOpacity: 0.5
            });

            measureLayerGroup.addLayer(measureState.polygon);
        } else {
            // ÁÇπÊï∞‰∏çË∂≥ÔºåÊ∏ÖÈô§ÊâÄÊúâÊµãÈáèÁªìÊûú
            clearMeasureResult();
        }

        // ÈáçÁΩÆÁä∂ÊÄÅ
        measureState.isActive = false;
        measureState.mode = '';

        // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
        document.getElementById('measureAreaBtn').classList.remove('active');
        document.getElementById('measureDistanceBtn').disabled = false;

        updateStatus('ÊµãÈù¢ÂÆåÊàêÔºåÊÄªÈù¢ÁßØÂ∑≤ÊòæÁ§∫');
    }

    // Ë∑ùÁ¶ªËÆ°ÁÆó
    function calculateDistance(point1, point2) {
        return point1.distanceTo(point2);
    }

    // Â§öËæπÂΩ¢Èù¢ÁßØËÆ°ÁÆó
    function calculatePolygonArea(points) {
        if (points.length < 3) return 0;

        // ‰ΩøÁî®Turf.jsËÆ°ÁÆóÈù¢ÁßØ
        try {
            // Â∞ÜLeafletÂùêÊ†áËΩ¨Êç¢‰∏∫GeoJSONÊ†ºÂºè
            let coords = points.map(p => {
                if (p.lng !== undefined && p.lat !== undefined) {
                    return [p.lng, p.lat];
                } else if (Array.isArray(p) && p.length >= 2) {
                    // Â¶ÇÊûúÂ∑≤ÁªèÊòØÊï∞ÁªÑÊ†ºÂºè [lat, lng] Êàñ [lng, lat]
                    return [p[1], p[0]]; // ÂÅáËÆæÊòØ [lat, lng] Ê†ºÂºè
                }
                return null;
            }).filter(coord => coord !== null);

            // Á°Æ‰øùÁéØÊòØÈó≠ÂêàÁöÑÔºàËá≥Â∞ëÊúâ4‰∏™ÁÇπÔºåÈ¶ñÂ∞æÁõ∏ÂêåÔºâ
            if (coords.length >= 3) {
                // Â¶ÇÊûúÈ¶ñÂ∞æ‰∏çÁõ∏ÂêåÔºåÈó≠ÂêàÁéØ
                if (coords[0][0] !== coords[coords.length - 1][0] ||
                    coords[0][1] !== coords[coords.length - 1][1]) {
                    coords.push(coords[0]);
                }

                // Á°Æ‰øùËá≥Â∞ëÊúâ4‰∏™ÁÇπÔºàÈó≠ÂêàÂêéÔºâ
                if (coords.length < 4) {
                    // Â¶ÇÊûúÁÇπÊï∞‰∏çË∂≥4‰∏™ÔºåÂ§çÂà∂ÁÇπÁõ¥Âà∞ËææÂà∞4‰∏™
                    while (coords.length < 4) {
                        coords.push(coords[coords.length - 1]);
                    }
                }
            } else if (coords.length === 2) {
                // Â¶ÇÊûúÂè™Êúâ2‰∏™ÁÇπÔºåÂ§çÂà∂ÂÆÉ‰ª¨ÂΩ¢ÊàêËá≥Â∞ë4‰∏™ÁÇπÁöÑÁéØ
                coords.push(coords[1]);
                coords.push(coords[0]);
            } else if (coords.length === 1) {
                // Â¶ÇÊûúÂè™Êúâ1‰∏™ÁÇπÔºåÂ§çÂà∂3Ê¨°ÂΩ¢Êàê4‰∏™ÁÇπÁöÑÁéØ
                for (let k = 0; k < 3; k++) {
                    coords.push(coords[0]);
                }
            }

            const polygon = turf.polygon([coords]);
            const area = turf.area(polygon); // Âπ≥ÊñπÁ±≥

            return area;
        } catch (e) {
            console.error('ËÆ°ÁÆóÂ§öËæπÂΩ¢Èù¢ÁßØÊó∂Âá∫Èîô:', e);
            return 0;
        }
    }

    // Ëé∑ÂèñÂ§öËæπÂΩ¢‰∏≠ÂøÉÁÇπ
    function getPolygonCenter(points) {
        if (points.length === 0) return null;

        let latSum = 0, lngSum = 0;
        points.forEach(p => {
            latSum += p.lat;
            lngSum += p.lng;
        });

        return L.latLng(latSum / points.length, lngSum / points.length);
    }

    // ËÆ°ÁÆóÊÄªË∑ùÁ¶ª
    function calculateTotalDistance() {
        let total = 0;
        for (let i = 1; i < measureState.points.length; i++) {
            total += calculateDistance(measureState.points[i-1], measureState.points[i]);
        }
        return total;
    }

    // ÊòæÁ§∫Ë∑ùÁ¶ªÊ†áÁ≠æ
    function showDistanceLabel(latlng, distance) {
        const label = L.divIcon({
            className: 'measure-label',
            html: `<div style="background: rgba(255,255,255,0.9); color: #333; padding: 2px 6px; border-radius: 3px; font-size: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.3);">${distance.toFixed(2)} Á±≥</div>`,
            iconSize: null,
            iconAnchor: [0, -10]
        });

        const marker = L.marker(latlng, { icon: label });
        measureLayerGroup.addLayer(marker);
        measureState.labels.push(marker);
    }

    // ÊòæÁ§∫Èù¢ÁßØÊ†áÁ≠æ
    function showAreaLabel(latlng, area) {
        const label = L.divIcon({
            className: 'measure-label',
            html: `<div style="background: rgba(255,255,255,0.9); color: #333; padding: 2px 6px; border-radius: 3px; font-size: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.3);">${area.toFixed(2)} Âπ≥ÊñπÁ±≥</div>`,
            iconSize: null,
            iconAnchor: [0, -10]
        });

        const marker = L.marker(latlng, { icon: label });
        measureLayerGroup.addLayer(marker);
        measureState.areaLabel = marker;
    }

    // ÊòæÁ§∫ÊÄªË∑ùÁ¶ªÊ†áÁ≠æ
    function showTotalDistanceLabel(totalDistance) {
        if (measureState.points.length === 0) return;

        const lastPoint = measureState.points[measureState.points.length - 1];
        const label = L.divIcon({
            className: 'measure-total-label',
            html: `<div style="background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px; font-size: 14px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">ÊÄªË∑ùÁ¶ª: ${totalDistance.toFixed(2)} Á±≥</div>`,
            iconSize: null,
            iconAnchor: [0, -20]
        });

        const marker = L.marker(lastPoint, { icon: label });
        measureLayerGroup.addLayer(marker);
        measureState.labels.push(marker);
    }

    // ÊòæÁ§∫ÊÄªÈù¢ÁßØÊ†áÁ≠æ
    function showTotalAreaLabel(latlng, area) {
        const areaInMu = area / 666.6667;
        const label = L.divIcon({
            className: 'measure-total-label',
            html: `<div style="background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px; font-size: 14px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.3); line-height: 1.4;">ÊÄªÈù¢ÁßØ: ${area.toFixed(2)} Âπ≥ÊñπÁ±≥<br>${areaInMu.toFixed(2)} ‰∫©</div>`,
            iconSize: null,
            iconAnchor: [0, -40]
        });

        const marker = L.marker(latlng, { icon: label });
        measureLayerGroup.addLayer(marker);
        measureState.labels.push(marker);
    }

    // Ê∏ÖÈô§ÊµãÈáèÁªìÊûú
    function clearMeasureResult() {
        measureLayerGroup.clearLayers();
        measureState = {
            isActive: false,
            mode: '',
            points: [],
            tempLine: null,
            lines: [],
            markers: [],
            labels: [],
            polygon: null,
            areaLabel: null
        };

        // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
        document.getElementById('measureDistanceBtn').classList.remove('active');
        document.getElementById('measureAreaBtn').classList.remove('active');
        document.getElementById('measureDistanceBtn').disabled = false;
        document.getElementById('measureAreaBtn').disabled = false;

        // Á°Æ‰øùÈáçÊñ∞ÂêØÁî®Âú∞ÂõæÂèåÂáªÁº©ÊîæÂäüËÉΩ
        if (map && map.doubleClickZoom) {
            map.doubleClickZoom.enable();

            // ÊÅ¢Â§çÂú∞ÂõæÈÄâÈ°πËÆæÁΩÆ
            if (map.options) {
                map.options.doubleClickZoom = true;
                map.options.tap = true;
            }
        }
    }

    // Âú∞ÂõæÁ±ªÂûãÂàáÊç¢
    function toggleMapType() {
        console.log('toggleMapType called, currentMapType:', currentMapType);
        console.log('map:', map);
        console.log('currentBaseLayer:', currentBaseLayer);
        console.log('currentSatelliteLayer:', currentSatelliteLayer);

        if (!map) {
            console.error('Map not initialized');
            return;
        }

        if (!currentBaseLayer || !currentSatelliteLayer) {
            console.error('Layers not properly initialized');
            updateStatus('ÂõæÂ±ÇÊú™Ê≠£Á°ÆÂàùÂßãÂåñ');
            return;
        }

        const mapTypeBtn = document.getElementById('mapTypeBtn');

        try {
            if (currentMapType === 'street') {
                console.log('Switching to satellite map');
                // ÂàáÊç¢Âà∞Âç´ÊòüÂõæ
                map.removeLayer(currentBaseLayer);
                map.addLayer(currentSatelliteLayer);
                currentMapType = 'satellite';
                mapTypeBtn.innerHTML = 'üõ∞Ô∏è Âç´ÊòüÂõæ';
                mapTypeBtn.title = 'ÂΩìÂâçÔºöÂç´ÊòüÂõæÔºåÁÇπÂáªÂàáÊç¢Ë°óÈÅìÂõæ';
            } else {
                console.log('Switching to street map');
                // ÂàáÊç¢Âà∞Ë°óÈÅìÂõæ
                map.removeLayer(currentSatelliteLayer);
                map.addLayer(currentBaseLayer);
                currentMapType = 'street';
                mapTypeBtn.innerHTML = 'üó∫Ô∏è Ë°óÈÅìÂõæ';
                mapTypeBtn.title = 'ÂΩìÂâçÔºöË°óÈÅìÂõæÔºåÁÇπÂáªÂàáÊç¢Âç´ÊòüÂõæ';
            }

            updateStatus(`Â∑≤ÂàáÊç¢Âà∞${currentMapType === 'street' ? 'Ë°óÈÅìÂõæ' : 'Âç´ÊòüÂõæ'}`);
            console.log('Map type switched successfully to:', currentMapType);
        } catch (error) {
            console.error('Error switching map type:', error);
            updateStatus('Âú∞ÂõæÂàáÊç¢Â§±Ë¥•: ' + error.message);
        }
    }

    // Ê∏ÖÁ©∫ÊâÄÊúâ
    function clearAll() {
        clearMeasureResult();

        updateStatus('ÊµãË∑ùÊµãÈù¢Â∑≤Ê∏ÖÁ©∫');
    }

    // ÂàáÊç¢Â∑¶‰æßÈù¢Êùø
    function toggleLeftPanel() {
        const panel = document.querySelector('.left-panel');
        const fixedToggle = document.getElementById('panelToggleFixed');

        if (panel.classList.contains('collapsed')) {
            // Â±ïÂºÄÈù¢Êùø - Èù¢ÊùøÂΩìÂâçÊòØÊî∂Ëµ∑ÁöÑÔºåÁÇπÂáªÂêéË¶ÅÂ±ïÂºÄÔºåÊâÄ‰ª•ÊåâÈíÆÂ∫îÊòæÁ§∫‰∏∫Â±ïÂºÄÂõæÊ†á
            panel.classList.remove('collapsed');
            if(fixedToggle) {
                fixedToggle.innerHTML = '‚ñ∂‚óÄ'; // Â±ïÂºÄÂõæÊ†á
                fixedToggle.title = 'Êî∂Áº©Â∑•ÂÖ∑Ê†è';
            }
        } else {
            // Êî∂Ëµ∑Èù¢Êùø - Èù¢ÊùøÂΩìÂâçÊòØÂ±ïÂºÄÁöÑÔºåÁÇπÂáªÂêéË¶ÅÊî∂Ëµ∑ÔºåÊâÄ‰ª•ÊåâÈíÆÂ∫îÊòæÁ§∫‰∏∫Êî∂Áº©ÂõæÊ†á
            panel.classList.add('collapsed');
            if(fixedToggle) {
                fixedToggle.innerHTML = '‚óÄ‚ñ∂'; // Êî∂Áº©ÂõæÊ†á
                fixedToggle.title = 'Â±ïÂºÄÂ∑•ÂÖ∑Ê†è';
            }
        }
    }

    // ÂàáÊç¢Ê†áÈ¢òÊ†è
    function toggleHeader() {
        const header = document.querySelector('.header');
        const toggle = document.getElementById('headerToggle');

        if (header.classList.contains('show')) {
            // ÈöêËóèÊ†áÈ¢ò
            header.classList.remove('show');
            header.style.display = 'none';
            toggle.innerHTML = '‚ò∞';
            toggle.title = 'ÊòæÁ§∫Â∑•ÂÖ∑Ê†è';
            toggle.style.display = 'block';
        } else {
            // ÊòæÁ§∫Ê†áÈ¢ò
            header.classList.add('show');
            header.style.display = 'flex';
            toggle.innerHTML = '‚úï';
            toggle.title = 'ÈöêËóèÂ∑•ÂÖ∑Ê†è';
        }
    }

    // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
    document.addEventListener('DOMContentLoaded', function() {
        initMap();
        bindTabEvents();
        bindColorPickerEvents();
        bindToolEvents();

        // ÁªëÂÆöÈù¢ÊùøÂàáÊç¢‰∫ã‰ª∂
        const headerToggle = document.getElementById('headerToggle');
        const panelToggleFixed = document.getElementById('panelToggleFixed');

        if (headerToggle) {
            headerToggle.addEventListener('click', toggleHeader);
            headerToggle.style.display = 'block';
        }

        if (panelToggleFixed) {
            panelToggleFixed.addEventListener('click', toggleLeftPanel);
        }

        // ÂàùÂßãÂåñÈù¢ÊùøÁä∂ÊÄÅ
        const savedPanelState = localStorage.getItem('leftPanelCollapsed');
        const panel = document.querySelector('.left-panel');
        const fixedToggle = document.getElementById('panelToggleFixed');

        if (savedPanelState === 'true') {
            panel.classList.add('collapsed');
            if(fixedToggle) {
                fixedToggle.innerHTML = '‚óÄ‚ñ∂'; // Êî∂Áº©ÂõæÊ†á
                fixedToggle.title = 'Â±ïÂºÄÂ∑•ÂÖ∑Ê†è';
            }
        } else {
            if(fixedToggle) {
                fixedToggle.innerHTML = '‚ñ∂‚óÄ'; // Â±ïÂºÄÂõæÊ†á
                fixedToggle.title = 'Êî∂Áº©Â∑•ÂÖ∑Ê†è';
            }
        }

        // Ê∑ªÂä†ÊòæÁ§∫‰∫©Êï∞Â§çÈÄâÊ°ÜÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
        const toggleLabelsCheckbox = document.getElementById('toggleLabelsCheckbox');
        if (toggleLabelsCheckbox) {
            toggleLabelsCheckbox.addEventListener('change', function() {
                const isChecked = this.checked;
                labelsEnabled = isChecked;
                console.log('Ê†áÁ≠æÊòæÁ§∫Áä∂ÊÄÅÂ∑≤Êõ¥Êîπ:', isChecked);

                // Ëé∑ÂèñÂÆπÂô®ÂÖÉÁ¥†Âπ∂ÂàáÊç¢labels-hiddenÁ±ª
                const container = document.querySelector('.container') || document.body;

                if (isChecked) {
                    // ÂêØÁî®Ê†áÁ≠æÔºöÊòæÁ§∫ÊâÄÊúâÊ†áÁ≠æ
                    console.log('ÂêØÁî®Ê†áÁ≠æÊòæÁ§∫');
                    container.classList.remove('labels-hidden');

                    console.log('Ê£ÄÊü•ÊòØÂê¶ÊúâËΩÆÂªìÂõæÂ±ÇÁªÑ:', outlineLayerGroup);
                    if (outlineLayerGroup && outlineLayerGroup.getLayers) {
                        console.log('ËΩÆÂªìÂõæÂ±ÇÁªÑÂ≠òÂú®ÔºåËé∑ÂèñÂõæÂ±ÇÊï∞Èáè:', outlineLayerGroup.getLayers().length);
                        if (outlineLayerGroup.getLayers().length > 0) {
                            // Ê∏ÖÈô§Áé∞ÊúâÊ†áÁ≠æ
                            labelLayerGroup.clearLayers();
                            console.log('Â∑≤Ê∏ÖÈô§Áé∞ÊúâÊ†áÁ≠æÔºåÂáÜÂ§áÊ∑ªÂä†Êñ∞Ê†áÁ≠æ');

                            // ‰∏∫ÊØè‰∏™ËΩÆÂªìÊ∑ªÂä†Ê†áÁ≠æ
                            // Á°Æ‰øùL.GeometryUtilÂ∑≤Âä†ËΩΩ
                            if (typeof L.GeometryUtil === 'undefined' || typeof L.GeometryUtil.geodesicArea !== 'function') {
                                console.log('‰ΩøÁî®Turf.jsËÆ°ÁÆóÈù¢ÁßØ');
                                // Â∞ùËØï‰ΩøÁî®Turf.js‰Ωú‰∏∫Â§áÈÄâÊñπÊ°à
                                if (typeof turf !== 'undefined') {
                                    console.log('‰ΩøÁî®Turf.jsËÆ°ÁÆóÈù¢ÁßØ');
                                    outlineLayerGroup.eachLayer(function(layer) {
                                        // Ëé∑ÂèñÂõæÂ±Ç‰∏≠ÁöÑÂÆûÈôÖÂá†‰ΩïË¶ÅÁ¥†ËøõË°åÈù¢ÁßØËÆ°ÁÆó
                                        let layers = [];

                                        // Â¶ÇÊûúlayerÊòØLayerGroupÊàñFeatureGroupÔºåËé∑ÂèñÂÖ∂ÊâÄÊúâÂ≠êÂõæÂ±Ç
                                        if (layer instanceof L.LayerGroup || layer instanceof L.FeatureGroup) {
                                            layers = layer.getLayers();
                                        } else {
                                            layers = layer.getLayers ? layer.getLayers() : [layer];
                                        }

                                        console.log('ÂõæÂ±ÇÊï∞ÁªÑÈïøÂ∫¶:', layers && Array.isArray(layers) ? layers.length : 0);
                                        if (layers && Array.isArray(layers) && layers.length > 0) {
                                            for (let j = 0; j < layers.length; j++) {
                                                const subLayer = layers[j];
                                                console.log('Â§ÑÁêÜÂ≠êÂõæÂ±Ç:', subLayer);
                                                let latLngs;

                                                // Ê†πÊçÆÂõæÂ±ÇÁ±ªÂûãËé∑ÂèñÂùêÊ†á
                                                if (subLayer instanceof L.Polygon) {
                                                    latLngs = subLayer.getLatLngs();
                                                    console.log('Â§öËæπÂΩ¢latLngs:', latLngs);
                                                } else if (subLayer instanceof L.MultiPolygon) {
                                                    // ÂØπ‰∫éMultiPolygonÔºåÂèñÁ¨¨‰∏Ä‰∏™Â§öËæπÂΩ¢
                                                    const multiLatLngs = subLayer.getLatLngs();
                                                    console.log('MultiPolygon latLngs:', multiLatLngs);
                                                    if (multiLatLngs && multiLatLngs.length > 0) {
                                                        latLngs = multiLatLngs[0];
                                                    }
                                                } else if (subLayer instanceof L.Rectangle) {
                                                    // ÂØπ‰∫éRectangleÔºåËé∑ÂèñÂÖ∂ËæπÁïåÂùêÊ†á
                                                    latLngs = subLayer.getLatLngs();
                                                    console.log('Áü©ÂΩ¢latLngs:', latLngs);
                                                }

                                                if (latLngs) {
                                                    // ‰ΩøÁî®Turf.jsËÆ°ÁÆóÈù¢ÁßØ
                                                    try {
                                                        // Â§ÑÁêÜÂ§öËæπÂΩ¢ÂùêÊ†áÔºåÊîØÊåÅÂ§ñÈÉ®ËæπÁïåÂíåÂÜÖÈÉ®Â≠îÊ¥û
                                                        const processPolygon = (polyCoords) => {
                                                            if (!Array.isArray(polyCoords) || polyCoords.length === 0) {
                                                                return null;
                                                            }

                                                            // Â¶ÇÊûúÊòØÂ§öËæπÂΩ¢Êï∞ÁªÑÔºàÂ§ñÈÉ®ËæπÁïå+Â≠îÊ¥ûÔºâÔºåÂàÜÂà´Â§ÑÁêÜ
                                                            let processedCoords = [];

                                                            // Â§ÑÁêÜÂ§öËæπÂΩ¢ÁöÑÊØè‰∏™ÁéØÔºàÁ¨¨‰∏Ä‰∏™ÊòØÂ§ñÈÉ®ËæπÁïåÔºåÂÖ∂‰ΩôÊòØÂ≠îÊ¥ûÔºâ
                                                            for (let i = 0; i < polyCoords.length; i++) {
                                                                let ring = polyCoords[i];
                                                                if (!Array.isArray(ring)) {
                                                                    ring = [ring]; // Â¶ÇÊûú‰∏çÊòØÊï∞ÁªÑÔºåËΩ¨Êç¢‰∏∫Êï∞ÁªÑ
                                                                }

                                                                // Â∞ÜLeafletÂùêÊ†áËΩ¨Êç¢‰∏∫GeoJSONÊ†ºÂºè [lng, lat]
                                                                let geoJsonRing = ring.map(latLng => {
                                                                    if (latLng.lat !== undefined && latLng.lng !== undefined) {
                                                                        return [latLng.lng, latLng.lat];
                                                                    } else if (Array.isArray(latLng) && latLng.length >= 2) {
                                                                        // Â¶ÇÊûúÂ∑≤ÁªèÊòØÊï∞ÁªÑÊ†ºÂºè [lat, lng] Êàñ [lng, lat]
                                                                        return [latLng[1], latLng[0]]; // ÂÅáËÆæÊòØ [lat, lng] Ê†ºÂºè
                                                                    }
                                                                    return null;
                                                                }).filter(coord => coord !== null);

                                                                // Á°Æ‰øùÁéØÊòØÈó≠ÂêàÁöÑÔºàËá≥Â∞ëÊúâ4‰∏™ÁÇπÔºåÈ¶ñÂ∞æÁõ∏ÂêåÔºâ
                                                                if (geoJsonRing.length >= 3) {
                                                                    // Â¶ÇÊûúÈ¶ñÂ∞æ‰∏çÁõ∏ÂêåÔºåÈó≠ÂêàÁéØ
                                                                    if (geoJsonRing[0][0] !== geoJsonRing[geoJsonRing.length - 1][0] ||
                                                                        geoJsonRing[0][1] !== geoJsonRing[geoJsonRing.length - 1][1]) {
                                                                        geoJsonRing.push(geoJsonRing[0]);
                                                                    }

                                                                    // Á°Æ‰øùËá≥Â∞ëÊúâ4‰∏™ÁÇπÔºàÈó≠ÂêàÂêéÔºâ
                                                                    if (geoJsonRing.length < 4) {
                                                                        // Â¶ÇÊûúÁÇπÊï∞‰∏çË∂≥4‰∏™ÔºåÂ§çÂà∂ÁÇπÁõ¥Âà∞ËææÂà∞4‰∏™
                                                                        while (geoJsonRing.length < 4) {
                                                                            geoJsonRing.push(geoJsonRing[geoJsonRing.length - 1]);
                                                                        }
                                                                    }
                                                                } else if (geoJsonRing.length === 2) {
                                                                    // Â¶ÇÊûúÂè™Êúâ2‰∏™ÁÇπÔºåÂ§çÂà∂ÂÆÉ‰ª¨ÂΩ¢ÊàêËá≥Â∞ë4‰∏™ÁÇπÁöÑÁéØ
                                                                    geoJsonRing.push(geoJsonRing[1]);
                                                                    geoJsonRing.push(geoJsonRing[0]);
                                                                } else if (geoJsonRing.length === 1) {
                                                                    // Â¶ÇÊûúÂè™Êúâ1‰∏™ÁÇπÔºåÂ§çÂà∂3Ê¨°ÂΩ¢Êàê4‰∏™ÁÇπÁöÑÁéØ
                                                                    for (let k = 0; k < 3; k++) {
                                                                        geoJsonRing.push(geoJsonRing[0]);
                                                                    }
                                                                }

                                                                processedCoords.push(geoJsonRing);
                                                            }

                                                            return processedCoords;
                                                        };

                                                        // Ê†πÊçÆlatLngsÁöÑÁªìÊûÑÂ§ÑÁêÜÂùêÊ†á
                                                        let coordinates;
                                                        if (Array.isArray(latLngs) && latLngs.length > 0) {
                                                            if (Array.isArray(latLngs[0])) {
                                                                // Â¶ÇÊûúÊòØÂ§öËæπÂΩ¢Êï∞ÁªÑÔºàÂåÖÂê´Â§ñÈÉ®ËæπÁïåÂíåÂ≠îÊ¥ûÔºâ
                                                                coordinates = processPolygon(latLngs);
                                                            } else {
                                                                // Â¶ÇÊûúÊòØÂçï‰∏™Â§öËæπÂΩ¢ËæπÁïå
                                                                coordinates = processPolygon([latLngs]);
                                                            }
                                                        } else {
                                                            // Âçï‰∏™Â§öËæπÂΩ¢ËæπÁïå
                                                            coordinates = processPolygon([latLngs]);
                                                        }

                                                        if (coordinates && coordinates.length > 0) {
                                                            const polygon = turf.polygon(coordinates);
                                                            const areaSqM = turf.area(polygon);
                                                            const areaMu = (areaSqM / 666.6667).toFixed(4); // ËΩ¨Êç¢‰∏∫‰∫©
                                                            console.log('‰ΩøÁî®Turf.jsËÆ°ÁÆóÂæóÂà∞ÁöÑÈù¢ÁßØ:', areaSqM, 'Âπ≥ÊñπÁ±≥ (', areaMu, '‰∫©)');
                                                            console.log('‰∏∫ÂõæÂ±ÇÊ∑ªÂä†Èù¢ÁßØÊ†áÁ≠æ:', areaMu, '‰∫©');
                                                            addAreaLabelToLayer(subLayer, `Èù¢ÁßØ: ${areaMu}‰∫©`); // ‰ΩøÁî®subLayerËÄå‰∏çÊòØlayer
                                                        } else {
                                                            console.log('Êó†Ê≥ïÂ§ÑÁêÜÂùêÊ†áÊï∞ÊçÆÔºåË∑≥ËøáÊ≠§ÂõæÂ±Ç');
                                                        }
                                                    } catch (e) {
                                                        console.error('‰ΩøÁî®Turf.jsËÆ°ÁÆóÈù¢ÁßØÊó∂Âá∫Èîô:', e);
                                                    }
                                                } else {
                                                    console.log('Êó†Ê≥ïËé∑ÂèñÂùêÊ†áÔºåË∑≥ËøáÊ≠§ÂõæÂ±Ç');
                                                }
                                            }
                                        } else {
                                            console.log('ÂõæÂ±ÇÊï∞ÁªÑ‰∏∫Á©∫Êàñ‰∏çÊòØÊï∞ÁªÑ');
                                        }
                                    });
                                } else {
                                    console.error('Turf.js‰πüÊú™ÂÆö‰πâÔºåÊó†Ê≥ïËÆ°ÁÆóÈù¢ÁßØ');
                                }
                            } else {
                                console.log('ÂºÄÂßã‰∏∫', outlineLayerGroup.getLayers().length, '‰∏™ËΩÆÂªìÊ∑ªÂä†Ê†áÁ≠æ');
                                let labelCount = 0;
                                outlineLayerGroup.eachLayer(function(layer) {
                                    console.log('Â§ÑÁêÜÂõæÂ±Ç:', layer);
                                    // Ëé∑ÂèñÂõæÂ±Ç‰∏≠ÁöÑÂÆûÈôÖÂá†‰ΩïË¶ÅÁ¥†ËøõË°åÈù¢ÁßØËÆ°ÁÆó
                                    let layers = [];

                                    // Â¶ÇÊûúlayerÊòØLayerGroupÊàñFeatureGroupÔºåËé∑ÂèñÂÖ∂ÊâÄÊúâÂ≠êÂõæÂ±Ç
                                    if (layer instanceof L.LayerGroup || layer instanceof L.FeatureGroup) {
                                        layers = layer.getLayers();
                                    } else {
                                        layers = layer.getLayers ? layer.getLayers() : [layer];
                                    }

                                    console.log('ÂõæÂ±ÇÊï∞ÁªÑÈïøÂ∫¶:', layers && Array.isArray(layers) ? layers.length : 0);
                                    if (layers && Array.isArray(layers) && layers.length > 0) {
                                        for (let j = 0; j < layers.length; j++) {
                                            const subLayer = layers[j];
                                            console.log('Â§ÑÁêÜÂ≠êÂõæÂ±Ç:', subLayer);
                                            let latLngs;

                                            // Ê†πÊçÆÂõæÂ±ÇÁ±ªÂûãËé∑ÂèñÂùêÊ†á
                                            if (subLayer instanceof L.Polygon) {
                                                latLngs = subLayer.getLatLngs();
                                                console.log('Â§öËæπÂΩ¢latLngs:', latLngs);
                                            } else if (subLayer instanceof L.MultiPolygon) {
                                                // ÂØπ‰∫éMultiPolygonÔºåÂèñÁ¨¨‰∏Ä‰∏™Â§öËæπÂΩ¢
                                                const multiLatLngs = subLayer.getLatLngs();
                                                console.log('MultiPolygon latLngs:', multiLatLngs);
                                                if (multiLatLngs && multiLatLngs.length > 0) {
                                                    latLngs = multiLatLngs[0];
                                                }
                                            } else if (subLayer instanceof L.Rectangle) {
                                                // ÂØπ‰∫éRectangleÔºåËé∑ÂèñÂÖ∂ËæπÁïåÂùêÊ†á
                                                latLngs = subLayer.getLatLngs();
                                                console.log('Áü©ÂΩ¢latLngs:', latLngs);
                                            }

                                            if (latLngs) {
                                                // Ê£ÄÊü•L.GeometryUtilÊòØÂê¶ÂèØÁî®ÔºåÂ¶ÇÊûú‰∏çÂèØÁî®Âàô‰ΩøÁî®Turf.js
                                                if (typeof L.GeometryUtil !== 'undefined' && typeof L.GeometryUtil.geodesicArea === 'function') {
                                                    const areaSqM = L.GeometryUtil.geodesicArea(latLngs[0] || latLngs);
                                                    const areaMu = (areaSqM / 666.6667).toFixed(4); // ËΩ¨Êç¢‰∏∫‰∫©
                                                    console.log('‰ΩøÁî®L.GeometryUtilËÆ°ÁÆóÂæóÂà∞ÁöÑÈù¢ÁßØ:', areaSqM, 'Âπ≥ÊñπÁ±≥ (', areaMu, '‰∫©)');
                                                    console.log('‰∏∫ÂõæÂ±ÇÊ∑ªÂä†Èù¢ÁßØÊ†áÁ≠æ:', areaMu, '‰∫©');
                                                    addAreaLabelToLayer(subLayer, `Èù¢ÁßØ: ${areaMu}‰∫©`); // ‰ΩøÁî®subLayerËÄå‰∏çÊòØlayer
                                                    labelCount++;
                                                } else {
                                                    console.log('L.GeometryUtilÊú™ÂÆö‰πâÊàñgeodesicAreaÊñπÊ≥ï‰∏çÂ≠òÂú®ÔºåÂ∞ùËØï‰ΩøÁî®Turf.js');
                                                    // ‰ΩøÁî®Turf.jsËÆ°ÁÆóÈù¢ÁßØ
                                                    try {
                                                        // Â§ÑÁêÜÂ§öËæπÂΩ¢ÂùêÊ†áÔºåÊîØÊåÅÂ§ñÈÉ®ËæπÁïåÂíåÂÜÖÈÉ®Â≠îÊ¥û
                                                        const processPolygon = (polyCoords) => {
                                                            if (!Array.isArray(polyCoords) || polyCoords.length === 0) {
                                                                return null;
                                                            }

                                                            // Â¶ÇÊûúÊòØÂ§öËæπÂΩ¢Êï∞ÁªÑÔºàÂ§ñÈÉ®ËæπÁïå+Â≠îÊ¥ûÔºâÔºåÂàÜÂà´Â§ÑÁêÜ
                                                            let processedCoords = [];

                                                            // Â§ÑÁêÜÂ§öËæπÂΩ¢ÁöÑÊØè‰∏™ÁéØÔºàÁ¨¨‰∏Ä‰∏™ÊòØÂ§ñÈÉ®ËæπÁïåÔºåÂÖ∂‰ΩôÊòØÂ≠îÊ¥ûÔºâ
                                                            for (let i = 0; i < polyCoords.length; i++) {
                                                                let ring = polyCoords[i];
                                                                if (!Array.isArray(ring)) {
                                                                    ring = [ring]; // Â¶ÇÊûú‰∏çÊòØÊï∞ÁªÑÔºåËΩ¨Êç¢‰∏∫Êï∞ÁªÑ
                                                                }

                                                                // Â∞ÜLeafletÂùêÊ†áËΩ¨Êç¢‰∏∫GeoJSONÊ†ºÂºè [lng, lat]
                                                                let geoJsonRing = ring.map(latLng => {
                                                                    if (latLng.lat !== undefined && latLng.lng !== undefined) {
                                                                        return [latLng.lng, latLng.lat];
                                                                    } else if (Array.isArray(latLng) && latLng.length >= 2) {
                                                                        // Â¶ÇÊûúÂ∑≤ÁªèÊòØÊï∞ÁªÑÊ†ºÂºè [lat, lng] Êàñ [lng, lat]
                                                                        return [latLng[1], latLng[0]]; // ÂÅáËÆæÊòØ [lat, lng] Ê†ºÂºè
                                                                    }
                                                                    return null;
                                                                }).filter(coord => coord !== null);

                                                                // Á°Æ‰øùÁéØÊòØÈó≠ÂêàÁöÑÔºàËá≥Â∞ëÊúâ4‰∏™ÁÇπÔºåÈ¶ñÂ∞æÁõ∏ÂêåÔºâ
                                                                if (geoJsonRing.length >= 3) {
                                                                    // Â¶ÇÊûúÈ¶ñÂ∞æ‰∏çÁõ∏ÂêåÔºåÈó≠ÂêàÁéØ
                                                                    if (geoJsonRing[0][0] !== geoJsonRing[geoJsonRing.length - 1][0] ||
                                                                        geoJsonRing[0][1] !== geoJsonRing[geoJsonRing.length - 1][1]) {
                                                                        geoJsonRing.push(geoJsonRing[0]);
                                                                    }

                                                                    // Á°Æ‰øùËá≥Â∞ëÊúâ4‰∏™ÁÇπÔºàÈó≠ÂêàÂêéÔºâ
                                                                    if (geoJsonRing.length < 4) {
                                                                        // Â¶ÇÊûúÁÇπÊï∞‰∏çË∂≥4‰∏™ÔºåÂ§çÂà∂ÁÇπÁõ¥Âà∞ËææÂà∞4‰∏™
                                                                        while (geoJsonRing.length < 4) {
                                                                            geoJsonRing.push(geoJsonRing[geoJsonRing.length - 1]);
                                                                        }
                                                                    }
                                                                } else if (geoJsonRing.length === 2) {
                                                                    // Â¶ÇÊûúÂè™Êúâ2‰∏™ÁÇπÔºåÂ§çÂà∂ÂÆÉ‰ª¨ÂΩ¢ÊàêËá≥Â∞ë4‰∏™ÁÇπÁöÑÁéØ
                                                                    geoJsonRing.push(geoJsonRing[1]);
                                                                    geoJsonRing.push(geoJsonRing[0]);
                                                                } else if (geoJsonRing.length === 1) {
                                                                    // Â¶ÇÊûúÂè™Êúâ1‰∏™ÁÇπÔºåÂ§çÂà∂3Ê¨°ÂΩ¢Êàê4‰∏™ÁÇπÁöÑÁéØ
                                                                    for (let k = 0; k < 3; k++) {
                                                                        geoJsonRing.push(geoJsonRing[0]);
                                                                    }
                                                                }

                                                                processedCoords.push(geoJsonRing);
                                                            }

                                                            return processedCoords;
                                                        };

                                                        // Ê†πÊçÆlatLngsÁöÑÁªìÊûÑÂ§ÑÁêÜÂùêÊ†á
                                                        let coordinates;
                                                        if (Array.isArray(latLngs) && latLngs.length > 0) {
                                                            if (Array.isArray(latLngs[0])) {
                                                                // Â¶ÇÊûúÊòØÂ§öËæπÂΩ¢Êï∞ÁªÑÔºàÂåÖÂê´Â§ñÈÉ®ËæπÁïåÂíåÂ≠îÊ¥ûÔºâ
                                                                coordinates = processPolygon(latLngs);
                                                            } else {
                                                                // Â¶ÇÊûúÊòØÂçï‰∏™Â§öËæπÂΩ¢ËæπÁïå
                                                                coordinates = processPolygon([latLngs]);
                                                            }
                                                        } else {
                                                            // Âçï‰∏™Â§öËæπÂΩ¢ËæπÁïå
                                                            coordinates = processPolygon([latLngs]);
                                                        }

                                                        if (coordinates && coordinates.length > 0) {
                                                            const polygon = turf.polygon(coordinates);
                                                            const areaSqM = turf.area(polygon);
                                                            const areaMu = (areaSqM / 666.6667).toFixed(4); // ËΩ¨Êç¢‰∏∫‰∫©
                                                            console.log('‰ΩøÁî®Turf.jsËÆ°ÁÆóÂæóÂà∞ÁöÑÈù¢ÁßØ:', areaSqM, 'Âπ≥ÊñπÁ±≥ (', areaMu, '‰∫©)');
                                                            console.log('‰∏∫ÂõæÂ±ÇÊ∑ªÂä†Èù¢ÁßØÊ†áÁ≠æ:', areaMu, '‰∫©');
                                                            addAreaLabelToLayer(subLayer, `Èù¢ÁßØ: ${areaMu}‰∫©`); // ‰ΩøÁî®subLayerËÄå‰∏çÊòØlayer
                                                            labelCount++;
                                                        } else {
                                                            console.log('Êó†Ê≥ïÂ§ÑÁêÜÂùêÊ†áÊï∞ÊçÆÔºåË∑≥ËøáÊ≠§ÂõæÂ±Ç');
                                                        }
                                                    } catch (e) {
                                                        console.error('‰ΩøÁî®Turf.jsËÆ°ÁÆóÈù¢ÁßØÊó∂Âá∫Èîô:', e);
                                                    }
                                                }
                                            } else {
                                                console.log('Êó†Ê≥ïËé∑ÂèñÂùêÊ†áÔºåË∑≥ËøáÊ≠§ÂõæÂ±Ç');
                                            }
                                        }
                                    } else {
                                        console.log('ÂõæÂ±ÇÊï∞ÁªÑ‰∏∫Á©∫Êàñ‰∏çÊòØÊï∞ÁªÑ');
                                    }
                                });
                                console.log('ÊÄªÂÖ±Â§ÑÁêÜ‰∫Ü', labelCount, '‰∏™Ê†áÁ≠æ');
                            }
                        } else {
                            console.log('ËΩÆÂªìÂõæÂ±ÇÁªÑ‰∏≠Ê≤°ÊúâÂõæÂ±Ç');
                        }
                    } else {
                        console.log('ËΩÆÂªìÂõæÂ±ÇÁªÑ‰∏çÂ≠òÂú®ÊàñÊ≤°ÊúâgetLayersÊñπÊ≥ï');
                    }
                } else {
                    // Á¶ÅÁî®Ê†áÁ≠æÔºöÈöêËóèÊâÄÊúâÊ†áÁ≠æ
                    console.log('Á¶ÅÁî®Ê†áÁ≠æÊòæÁ§∫ÔºåÊ∏ÖÈô§ÊâÄÊúâÊ†áÁ≠æ');
                    if (labelLayerGroup) {
                        labelLayerGroup.clearLayers();
                        console.log('Ê†áÁ≠æÂõæÂ±ÇÂ∑≤Ê∏ÖÁ©∫ÔºåÂΩìÂâçÂõæÂ±ÇÊï∞Èáè:', labelLayerGroup.getLayers().length);
                    } else {
                        console.log('Ê†áÁ≠æÂõæÂ±ÇÁªÑ‰∏çÂ≠òÂú®');
                    }
                    container.classList.add('labels-hidden');
                }

                // Á°Æ‰øùÊ†áÁ≠æÂõæÂ±ÇÂßãÁªàÂú®ÊúÄ‰∏äÂ±Ç
                if (labelLayerGroup) {
                    map.removeLayer(labelLayerGroup);
                    map.addLayer(labelLayerGroup);
                }
            });
        }

        updateStatus('È°µÈù¢Âä†ËΩΩÂÆåÊàê');

        // Ê∑ªÂä†ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÈöêËóèÂè≥ÈîÆËèúÂçïÁöÑ‰∫ã‰ª∂ÁõëÂê¨
        document.addEventListener('click', function(e) {
            // Â¶ÇÊûúÁÇπÂáªÁöÑ‰∏çÊòØÂè≥ÈîÆËèúÂçïÊú¨Ë∫´Ôºå‰πü‰∏çÊòØËé∑ÂèñÂú∞ÂùÄËèúÂçïÈ°πÔºåÂàôÈöêËóèËèúÂçï
            if (contextMenu && !contextMenu.contains(e.target) && 
                (!getAddressMenuItem || !getAddressMenuItem.contains(e.target))) {
                hideContextMenu();
            }
        });

        // ÈòªÊ≠¢Âè≥ÈîÆËèúÂçïÂÜÖÈÉ®ÁöÑÁÇπÂáª‰∫ã‰ª∂ÂÜíÊ≥°
        if (contextMenu) {
            contextMenu.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }
    });

    // ÂÖ®Â±ÄÂáΩÊï∞‰æõHTMLË∞ÉÁî®
    window.drawOutline = drawOutline;
    window.clearOutline = clearOutline;
    window.drawTrack = drawTrack;
    window.startPlayback = startPlayback;
    window.stopPlayback = stopPlayback;

    // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéËá™Âä®Ë∞ÉÁî®ËΩ®ËøπÂíåËΩÆÂªìÁªòÂà∂ÂäüËÉΩ
    document.addEventListener('DOMContentLoaded', function() {
        // ÂÖàË∞ÉÁî®ËΩ®ËøπTAB‰∏≠ÁöÑËΩ®ËøπÊåâÈíÆÊñπÊ≥ï
        // drawTrack();
        // ÂÖàË∞ÉÁî®ËΩ®ËøπTAB‰∏≠ÁöÑÊâìÁÇπÊåâÈíÆÊñπÊ≥ï
        showTrackPoints();
        setTimeout(() => {
            // ÂÜçË∞ÉÁî®ËΩÆÂªìTAB‰∏≠ÁöÑÂõûÊâßËΩÆÂªìÊñπÊ≥ï
            drawOutline();
        },1000);
    });
</script>
</body>
</html>