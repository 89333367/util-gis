<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>展示轮廓</title>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #mapContainer {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        #mapLoading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
            transition: opacity 0.3s;
        }

        .loading-text {
            font-size: 16px;
            color: #333;
            padding: 10px 20px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .wkt-input-container {
            position: absolute;
            top: 20px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            width: min(320px, 90vw);
            box-sizing: border-box;
            transition: all 0.3s;
        }

        .minimize-btn {
            position: absolute;
            top: -5px;
            right: -4px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #f0f0f0;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #666;
            z-index: 1001;
            transition: background 0.2s;
        }

        .minimize-btn:hover {
            background: #e0e0e0;
        }

        .content-wrapper {
            transition: all 0.3s;
        }

        .wkt-input-container.minimized {
            width: 40px;
            height: 40px;
            padding: 0;
        }

        .wkt-input-container.minimized .content-wrapper {
            display: none;
        }

        .wkt-input-container.minimized .min-icon {
            display: none;
        }

        .wkt-input-container.minimized .restore-icon {
            display: inline;
        }

        #wktTextarea {
            width: 100%;
            height: 120px;
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
            box-sizing: border-box;
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        /* 页签样式 */
        .tabs-header {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .tab-btn {
            flex: 1;
            padding: 6px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            background: #f5f5f5;
            color: #333;
            transition: background 0.2s;
        }
        .tab-btn.active { background: #337AFF; color: #fff; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        /* Multi → Polygons 分割器样式 */
        .split-section {
            margin-top: 10px;
            padding: 10px;
            background: #fafafa;
            border: 1px solid #eee;
            border-radius: 6px;
        }
        .split-section .title {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
        }
        .split-section .desc {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        #multiInput, #polyOutput {
            width: 100%;
            height: 90px;
            margin-bottom: 8px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
            box-sizing: border-box;
        }
        .split-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .split-actions button {
            flex: 1;
            padding: 6px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }
        #splitMultiBtn { background: #337AFF; color: #fff; }
        #splitMultiBtn:hover { background: #2860E0; }
        #copyPolysBtn { background: #f5f5f5; color: #333; }
        #copyPolysBtn:hover { background: #e0e0e0; }
        #drawButton,
        #clearButton,
        #drawTrackButton,
        #clearTrackButton {
            width: 50%;
            padding: 8px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        #drawButton,
        #drawTrackButton {
            background: #337AFF;
            color: white;
        }

        #drawButton:hover,
        #drawTrackButton:hover {
            background: #2860E0;
        }

        #clearButton,
        #clearTrackButton {
            background: #f5f5f5;
            color: #333;
        }

        #clearButton:hover,
        #clearTrackButton:hover {
            background: #e0e0e0;
        }

        #drawButton:disabled,
        #clearButton:disabled,
        #drawTrackButton:disabled,
        #clearTrackButton:disabled {
            background: #e0e0e0;
            color: #999;
            cursor: not-allowed;
        }

        .tip {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .area-label {
             position: absolute;
             background: rgba(255, 0, 0, 0.85);
             border: 1px solid #000;
             border-radius: 3px;
             padding: 4px 6px;
             font-size: 12px;
             color: #fff;
             font-weight: 600;
             box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
             white-space: nowrap;
             z-index: 9999;
             pointer-events: none;
         }
         /* 默认隐藏标签容器下的标签 */
          .labels-hidden .area-label { display: none; }

          /* Batch → Generator 样式 */
          .batch-section { margin-top: 10px; padding: 10px; background: #fafafa; border: 1px solid #eee; border-radius: 6px; }
          .batch-section .title { font-size: 13px; font-weight: 600; color: #333; margin-bottom: 6px; }
          .batch-section .desc { font-size: 12px; color: #666; margin-bottom: 8px; }
          #batchInput, #multiOutput { width: 100%; height: 90px; margin-bottom: 8px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; resize: vertical; box-sizing: border-box; }
          .batch-actions { display: flex; gap: 8px; margin-bottom: 8px; }
          .batch-actions button { flex: 1; padding: 6px 0; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; transition: background 0.2s; }
          #generateMultiBtn { background: #337AFF; color: #fff; }
          #generateMultiBtn:hover { background: #2860E0; }
          #copyMultiBtn { background: #f5f5f5; color: #333; }
          #copyMultiBtn:hover { background: #e0e0e0; }
      </style>
    <script src="https://api.tianditu.gov.cn/api?v=4.0&tk=648f621977051d0199ff0f965d3fd322"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
    <script src="https://lib.baomitu.com/terraformer/1.0.12/terraformer.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://unpkg.com/terraformer-wkt-parser@1.2.1/terraformer-wkt-parser.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- 已移除动态备用加载器 ensureTerraformer：改为仅使用静态脚本标签加载 Terraformer 核心库与 WKT 解析器 -->
    <script>
        // 检查Turf.js是否加载成功
        window.addEventListener('load', function () {
            if (typeof turf === 'undefined') {
                console.warn('Turf.js加载失败，已启用备用面积算法');
            } else {
                console.log('Turf.js加载成功');
            }
        });
    </script>
</head>

<body>
<div id="mapContainer">
    <div id="mapLoading">
        <div class="loading-text">地图正在加载中...</div>
    </div>
</div>

<div class="wkt-input-container">
    <div class="minimize-btn" id="minimizeBtn">
        <span class="min-icon">−</span>
        <span class="restore-icon" style="display:none;">+</span>
    </div>

    <div class="content-wrapper">
        <div class="tabs-header">
            <button class="tab-btn active" id="tabDrawBtn">轮廓</button>
            <button class="tab-btn" id="tabTrackBtn">轨迹</button>
            <button class="tab-btn" id="tabSplitBtn">分割器</button>
            <button class="tab-btn" id="tabBatchBtn">合并器</button>
        </div>
        <div class="tab-pane active" id="tabDraw">
            <div class="tip">请输入WKT字符串（支持POLYGON/MULTIPOLYGON）：</div>
            <textarea id="wktTextarea">POLYGON ((107.79293647153817 22.540703767839645, 107.79293647338143 22.54070386423564, 107.79293657954238 22.540704686976017, 107.79293658588261 22.540704763661374, 107.7929365987669 22.54070511543583, 107.79293661101254 22.540705201802382, 107.79293667143666 22.540705443813085, 107.79293668964552 22.540705540268668, 107.7929367735034 22.54070619016185, 107.79293679347082 22.540706274805792, 107.79293708466203 22.54070711302518, 107.79293710648136 22.540707186253222, 107.79293718437447 22.540707498230336, 107.79293721430467 22.540707580786503, 107.7929373094726 22.54070777779916, 107.7929373476552 22.540707870073835, 107.79293756247853 22.540708488461437, 107.79293766904128 22.540708693298946, 107.79293808553982 22.540709392121098, 107.79293812194727 22.54070945974982, 107.7929382532487 22.54070973156448, 107.79293829974222 22.540709807217315, 107.79293841905431 22.540709963890844, 107.79293847614609 22.540710048416575, 107.79293881548219 22.540710618610245, 107.79293901914635 22.54071086719618, 107.7929395371432 22.54071143773246, 107.79293958759474 22.540711498348234, 107.7929397653337 22.54071173174438, 107.7929398266475 22.54071179765782, 107.79293996446427 22.5407119196354, 107.79294003866279 22.5407119930717, 107.79294050401228 22.540712508512655, 107.79294056106659 22.540712561276713, 107.79294138246519 22.540713178739427, 107.79294144145905 22.540713226879912, 107.79294166396305 22.54071342381169, 107.79294173780038 22.540713477516505, 107.79294189287857 22.54071356931201, 107.79294198169816 22.540713628677032, 107.79294253424378 22.540714043801813, 107.7929425988958 22.540714084162342, 107.79294354153802 22.540714548596714, 107.79294360837825 22.54071458476798, 107.79294387798588 22.540714744356873, 107.792943961579 22.540714783839903, 107.79294413566593 22.540714847205614, 107.79294423602025 22.54071488999656, 107.79294484367541 22.540715189059423, 107.79294491308771 22.54071521633782, 107.7929459318441 22.540715503969547, 107.7929460037362 22.54071552716241, 107.79294632443093 22.540715643891737, 107.79294641464746 22.54071566767345, 107.7929466105075 22.540715700698872, 107.79294671881595 22.540715724996108, 107.79294734160784 22.54071590038553, 107.79294743307 22.540715917425107, 107.79294783470982 22.540715955425647, 107.79294793796564 22.54071597044619, 107.79294797631984 22.540715978009278, 107.79294819129272 22.540715989953753, 107.79294844971596 22.54071601361352, 107.79294851659789 22.540716022132276, 107.79294898783847 22.54071609773855, 107.79294973328652 22.540716136307946, 107.79295014297341 22.540716152038204, 107.79296123711558 22.540716159605353, 107.79298483272372 22.540716204372227, 107.79298501567439 22.540716220878103, 107.79298519199992 22.540716269110085, 107.79298535538364 22.540716347340304, 107.79298549997246 22.540716452766244, 107.79298562058659 22.540716581611104, 107.79298571290522 22.540716729259124, 107.79298577362106 22.540716890420946, 107.792985800559 22.540717059323093, 107.79298579275402 22.54071722991479, 107.79298575048574 22.54071739608473, 107.79298567526844 22.540717551880032, 107.79298556979656 22.540717691719458, 107.79298543784871 22.54071781059339, 107.79298528415164 22.540717904243255, 107.79298469652159 22.54071819243362, 107.79298461729671 22.540718241064802, 107.79298262244946 22.540719746036146, 107.7929825549609 22.5407198080897, 107.79298091451648 22.540721645655342, 107.79298086135708 22.540721718747186, 107.79297963835708 22.540723818290402, 107.79297960156974 22.54072389961154, 107.79297884301357 22.540726180447674, 107.79297882401195 22.540726266873367, 107.79297855905023 22.540728641351826, 107.79297855856487 22.540728729559714, 107.79297879737997 22.540731106430144, 107.79297881542932 22.540731193031718, 107.79297954884393 22.540733480952767, 107.79297958473421 22.540733562618726, 107.79298078456358 22.54073567366664, 107.79298083691587 22.54073574725953, 107.7929824570509 22.540737600307555, 107.79298252385327 22.540737662999156, 107.79298450203343 22.540739186836102, 107.79298458071871 22.540739236216904, 107.79298481710968 22.540739355036074, 107.7929849801943 22.540739458175196, 107.79298511747356 22.540739589803103, 107.79298522328176 22.540739744487272, 107.79298529325189 22.540739915843584, 107.79298532449626 22.540740096799848, 107.79298531572535 22.540740279887668, 107.79298526730105 22.54074045755066, 107.79298518122198 22.540740622456333, 107.79298506104087 22.540740767798734, 107.79298491171771 22.540740887579293, 107.79298473941535 22.54074097685445, 107.79298455124507 22.540741031939653, 107.79298435497297 22.54074105056144, 107.79297801118928 22.540741050748345, 107.79296771140861 22.54074108075611, 107.79295294234453 22.540741178784295, 107.79295233246847 22.54074116188021, 107.79295210966572 22.540741174014826, 107.79295198696666 22.540741173484726, 107.79295194711196 22.540741170968346, 107.79295074253179 22.540741170982617, 107.7929505910477 22.54074117352957, 107.79294803012812 22.540741407456355, 107.79294793739939 22.54074142453654, 107.79294751457785 22.54074154323424, 107.79294737925686 22.54074157160753, 107.79294710133023 22.540741610761962, 107.79294629297706 22.540741885926103, 107.79294624019504 22.540741902315553, 107.79294548227432 22.5407421154354, 107.79294539503958 22.54074214888742, 107.79294509254518 22.540742298430185, 107.79294497973147 22.540742345892003, 107.79294461748671 22.540742473111127, 107.79294453242336 22.540742512219087, 107.79294379826612 22.54074293760838, 107.79294374105987 22.540742968295362, 107.79294313238016 22.540743269643755, 107.79294305336813 22.540743318556927, 107.79294282301036 22.54074349373267, 107.79294272146116 22.54074356131092, 107.79294235227515 22.54074377502466, 107.79294227701827 22.540743828769624, 107.7929415921239 22.54074442571401, 107.79294154279616 22.54074446588515, 107.79294106835006 22.540744826678093, 107.79294100122848 22.540744888855052, 107.79294083560711 22.540745075722253, 107.79294075048355 22.540745160104176, 107.7929404031627 22.540745462922757, 107.79294034053746 22.540745529420125, 107.79293974709665 22.540746300940153, 107.79293970607047 22.540746350546705, 107.79293937113643 22.540746727704747, 107.79293931843202 22.540746800489178, 107.79293921599933 22.54074697696037, 107.79293915146681 22.540747073137872, 107.7929388455885 22.540747470956806, 107.79293879821458 22.540747547463187, 107.79293835155637 22.540748467268276, 107.79293832135295 22.540748524058056, 107.79293810397692 22.5407488990221, 107.79293806724549 22.54074898077405, 107.79293801331832 22.54074914457546, 107.7929379697454 22.54074925196496, 107.79293774063187 22.54074972335571, 107.79293771023629 22.540749806888673, 107.79293745179616 22.540750842377413, 107.79293743428326 22.54075090290578, 107.79293732442359 22.540751235980796, 107.79293727741926 22.540751528155642, 107.79293726288617 22.54075159899204, 107.79293712958732 22.54075213190591, 107.79293711726076 22.540752219508516, 107.79293707956192 22.5407533259387, 107.79293707496791 22.54075338955122, 107.79293704139131 22.540753693289524, 107.7929370545324 22.540753968661683, 107.7929370549733 22.540754037898132, 107.79293703513632 22.54075460522043, 107.79293704145412 22.540754693702727, 107.79293724137861 22.540755809494687, 107.79293725018502 22.540755872102512, 107.79293727902156 22.540756153447653, 107.79293734665448 22.540756411836874, 107.79293736094223 22.540756476708623, 107.7929374634626 22.540757048286952, 107.79293748803497 22.540757133113292, 107.7929379213367 22.54075820042517, 107.79293794288178 22.540758259630074, 107.79293802827948 22.540758524172492, 107.79293814700141 22.540758762165453, 107.79293817443735 22.540758822879862, 107.79293839562445 22.540759367218207, 107.79293843778329 22.540759446410675, 107.79293908217767 22.540760406325614, 107.79293911655017 22.540760461822163, 107.7929392587967 22.54076071159568, 107.79293943090497 22.54076093021686, 107.79293947121083 22.540760985613073, 107.79293979709361 22.540761471385366, 107.79293985515868 22.54076154149825, 107.7929406653743 22.54076234262175, 107.79294071181731 22.540762392025997, 107.79294092335044 22.540762634286494, 107.79294115414565 22.54076283025632, 107.79294120727427 22.54076287897986, 107.79294161428341 22.54076328209437, 107.792941685762 22.540763340236847, 107.79294261112834 22.540763955179393, 107.79294266596973 22.54076399444287, 107.79294297942818 22.54076423588659, 107.7929430581973 22.540764285305418, 107.79294321084879 22.540764361991098, 107.79294331399704 22.54076442185115, 107.79294377585406 22.540764728831174, 107.79294385839299 22.54076477299463, 107.79294484667837 22.54076518749819, 107.79294490941504 22.54076521638374, 107.79294531339144 22.54076541955465, 107.79294540124991 22.540765453839196, 107.79294560004006 22.540765510794294, 107.79294571395332 22.54076555085684, 107.79294620070345 22.54076575531869, 107.79294629060036 22.54076578360077, 107.79294677939298 22.54076588916092, 107.7929469588017 22.54076594551798, 107.79294712302367 22.54076603314907, 107.79294726581342 22.54076614872145, 107.79294738174025 22.54076628783977, 107.79294746639557 22.540766445213183, 107.79294751655962 22.540766614856583, 107.79294753032474 22.5407667903182, 107.79294750716734 22.540766964925037, 107.79294744796822 22.540767132036553, 107.79294735497871 22.54076728529729, 107.79294723173531 22.54076741887856, 107.79294708292521 22.54076752770009, 107.79294691420773 22.540767607623273, 107.79294669952678 22.540767685872044, 107.79294447109419 22.540768832745282, 107.7929443931018 22.54076888272522, 107.79294243496379 22.540770420568663, 107.79294236893766 22.540770483695006, 107.7929407705269 22.540772346201145, 107.79294071899221 22.54077242005949, 107.7929395414632 22.540774535969806, 107.79293950639216 22.540774617733902, 107.79293879479675 22.540776906094028, 107.79293877753075 22.540776992636548, 107.79293855909414 22.54077936589536, 107.79293856029419 22.540779453904214, 107.7929388433735 22.54078182126226, 107.79293886299351 22.540781907370125, 107.79293963675866 22.540784178253976, 107.79293967404783 22.5407842591663, 107.79294090889455 22.54078634669197, 107.79294096242651 22.540786419313932, 107.79294261111079 22.540788243614315, 107.79294267883664 22.540788305166508, 107.79294467828046 22.54078979644447, 107.79294475760986 22.540789844572842, 107.79294703131485 22.540790945772393, 107.7929471192127 22.54079097863538, 107.7929473826168 22.540791050238994, 107.79294755719796 22.54079111533188, 107.79294771499362 22.540791210469802, 107.79294785008283 22.540791332082918, 107.79294795739656 22.54079147560792, 107.79294803290817 22.54079163565935, 107.79294807378423 22.54079180623157, 107.79294807849091 22.54079198092423, 107.79294804685156 22.540792153182313, 107.79294798005351 22.540792316542205, 107.79294788060312 22.540792464874148, 107.79294775223212 22.540792592612277, 107.79294759975731 22.5407926949635, 107.79294667723923 22.540793195621493, 107.79294556680824 22.54079379751813, 107.79294550085498 22.540793842459834, 107.79294357336455 22.54079542607362, 107.79294350874386 22.540795490708202, 107.79294195291412 22.54079739071265, 107.79294190354169 22.540797465164463, 107.79294074575282 22.540799678932956, 107.79294072682063 22.54079973132532, 107.79294005616629 22.54080212490076, 107.79294004121428 22.540802214678564, 107.79293990268968 22.540804670210495, 107.79293990745825 22.540804760948177, 107.79294030280181 22.54080719227055, 107.79294032709655 22.540807280268933, 107.79294124018895 22.540809588249473, 107.79294128301927 22.540809669920066, 107.79294267663104 22.54081176045529, 107.79294273625042 22.540811832468016, 107.7929445536055 22.54081362036554, 107.79294462747536 22.540813679714297, 107.792945557699 22.540814286336754, 107.79294679479001 22.54081509224784, 107.79294687960541 22.540815136350396, 107.79294764757498 22.540815446020485, 107.79294770458684 22.540815471083704, 107.7929479206031 22.540815574152045, 107.79294805385672 22.540815617702954, 107.79294819128665 22.54081567406063, 107.79294831344903 22.540815735049403, 107.79294859337375 22.540815829279204, 107.79294864920197 22.540815849908782, 107.79294930792554 22.54081611552734, 107.79294940110854 22.540816143102937, 107.79294998585915 22.540816257332434, 107.79295010831999 22.540816289157654, 107.79295031243981 22.540816355869563, 107.79295062457787 22.54081641147011, 107.79295068165844 22.540816423303436, 107.79295099067824 22.540816496505634, 107.79295108753949 22.540816505650138, 107.79295126823078 22.540816539024643, 107.79295143888582 22.54081660349601, 107.79295159336337 22.54081669674411, 107.79295172610414 22.54081681541324, 107.7929518323313 22.54081695523288, 107.79295190822201 22.540817111171357, 107.79295195104524 22.540817277616934, 107.79295195925994 22.540817448579755, 107.7929519325704 22.540817617907422, 107.79295187193723 22.54081777950635, 107.79295177954226 22.540817927561108, 107.79295165871069 22.54081805674367, 107.79295151379065 22.540818162405174, 107.79295134999752 22.540818240743167, 107.7929502749569 22.540818640163327, 107.79294809291282 22.54081999602482, 107.7929480203923 22.5408200516311, 107.79294620857816 22.540821744726188, 107.79294614858567 22.54082181303779, 107.79294472666001 22.540823802170614, 107.79294468213769 22.54082388008213, 107.79294370575644 22.54082608761317, 107.79294367845293 22.540826172093414, 107.79294318429714 22.54082851480193, 107.79294317526 22.54082860263641, 107.79294317797283 22.540829466050425, 107.79294314951196 22.54082968549561, 107.79294311911777 22.540829799527188, 107.79294311910245 22.540829825216, 107.79294317644539 22.54083035718791, 107.79294318127302 22.540830444313595, 107.79294318306832 22.54083099051186, 107.79294319269597 22.54083107841374, 107.79294330517459 22.540831594558703, 107.79294331968582 22.540831684006395, 107.79294337937229 22.540832239861835, 107.7929433984591 22.540832327702798, 107.79294357476967 22.540832859188768, 107.79294359848241 22.540832945655485, 107.79294370149103 22.54083341777092, 107.79294372918741 22.540833501650617, 107.79294393910963 22.54083396903987, 107.79294397072462 22.54083405013916, 107.7929441691024 22.540834646684832, 107.7929442066867 22.54083472937212, 107.79294450016108 22.54083522906544, 107.7929445438856 22.54083531371643, 107.79294471959174 22.540835704871313, 107.79294476451926 22.540835782481878, 107.79294505775822 22.54083618803515, 107.79294510403248 22.540836258855467, 107.79294545776216 22.54083686091834, 107.79294551205263 22.540836934771328, 107.79294591355318 22.540837378758514, 107.79294597575809 22.540837455497538, 107.79294619905266 22.540837763858814, 107.79294625933031 22.54083783169629, 107.79294661655037 22.540838161846228, 107.79294667507577 22.540838220981456, 107.79294719215206 22.540838792560233, 107.79294726145423 22.540838855225278, 107.79294774900097 22.54083921545182, 107.79294782968707 22.540839282200867, 107.79294808101388 22.540839514656348, 107.7929481549461 22.540839570713604, 107.79294856677687 22.540839824590552, 107.79294863475334 22.540839870552837, 107.79294930629898 22.540840367313923, 107.79294938754565 22.54084041596084, 107.79294993824881 22.540840677491275, 107.79295003381948 22.540840729465607, 107.79295029586798 22.54084089128824, 107.79295038017699 22.540840932861204, 107.7929508257467 22.54084110266817, 107.79295089961937 22.540841134239294, 107.79295171354337 22.54084152122933, 107.79295180362988 22.540841553980613, 107.79295239164364 22.540841706926127, 107.7929524985662 22.540841741086854, 107.79295275729253 22.540841839740846, 107.79295284838676 22.540841865102262, 107.79295331692268 22.540841950104006, 107.7929533928018 22.5408419668337, 107.79295431913269 22.540842207947307, 107.79295441420209 22.54084222341608, 107.79295500129444 22.540842263629525, 107.7929551164575 22.540842277992482, 107.7929553702202 22.540842324140055, 107.79295546491544 22.5408423325199, 107.79295594982754 22.540842331002654, 107.7929560204457 22.540842333169337, 107.79295711546875 22.54084240387913, 107.792958499038 22.540842369725297, 107.79295859016985 22.540842371450665, 107.79295887703768 22.54084238941839, 107.79298551090953 22.54084228983502, 107.79299665663555 22.540842329086978, 107.79302452916265 22.540842240004782, 107.79304106671779 22.5408422296838, 107.79305213407685 22.54084217997064, 107.79306317375445 22.540842189433455, 107.79310207858306 22.5408421793841, 107.7931408666016 22.54084205949702, 107.79315758326581 22.540842089398062, 107.79317427637457 22.540842089864366, 107.79318540512841 22.540842009399018, 107.79321866825629 22.540841909650137, 107.79324087743403 22.540841779210563, 107.79329630335083 22.54084178976353, 107.7933129129152 22.54084170954398, 107.79332403430368 22.54084170945207, 107.79334609811043 22.5408416598623, 107.79336271722097 22.54084175902629, 107.79337403906392 22.540841708577776, 107.79338513065842 22.540841609810595, 107.79340166046413 22.540841609460433, 107.79342355727636 22.540841579816735, 107.79342374865833 22.540841576474264, 107.79342404404504 22.540841549298197, 107.7934241724455 22.54084154541699, 107.79342430589737 22.540841549591473, 107.7934245179653 22.54084153794313, 107.79342510806907 22.54084145444784, 107.79342516126347 22.54084144831126, 107.79342627438162 22.54084134878814, 107.79342636688598 22.54084133524324, 107.79342641759943 22.540841324649215, 107.79342671302163 22.54084125102488, 107.79342705142786 22.540841182045977, 107.79342725105779 22.540841140036065, 107.7934279309106 22.54084090714892, 107.79342802405247 22.540840880097186, 107.79342845846271 22.540840775868904, 107.7934286681299 22.540840697290918, 107.79342872378871 22.540840678245804, 107.7934291065824 22.540840559463902, 107.79342922307742 22.54084050865428, 107.79342935380478 22.54084045676972, 107.79342948937642 22.54084038664168, 107.79342956968084 22.540840349507043, 107.79342982859009 22.54084024334428, 107.79343030735471 22.540839967624457, 107.79343039718513 22.540839921801346, 107.79343086796577 22.540839710879887, 107.79343102611526 22.540839616684693, 107.79343107273353 22.54083959060109, 107.79343138115213 22.540839428798666, 107.79343147070001 22.540839365806132, 107.79343151612986 22.540839335716097, 107.7934317897902 22.5408391652581, 107.7934319581355 22.540839028138578, 107.79343201421851 22.540838985781402, 107.79343214557538 22.54083889389898, 107.7934323901667 22.540838679196668, 107.79343246269363 22.54083862152964, 107.79343301425308 22.54083822489927, 107.79343311595528 22.54083813607331, 107.79343317319397 22.54083808985713, 107.79343333850429 22.54083796656885, 107.79343340543272 22.540837905901803, 107.793433540451 22.54083775729084, 107.79343362586862 22.540837674565353, 107.79343383847949 22.54083749326169, 107.79343445276734 22.54083675563582, 107.79343502847527 22.540836120188104, 107.79343520485348 22.540835848681528, 107.79343525825108 22.54083577495471, 107.79343544799274 22.540835538963588, 107.7934359430353 22.54083461783612, 107.79343630971817 22.540834002701395, 107.79343642001449 22.540833730403566, 107.79343645215323 22.540833660216066, 107.79343661618802 22.54083334025737, 107.7934369355039 22.540832259760627, 107.79343713336046 22.5408316909406, 107.79343718210443 22.54083143024969, 107.79343719929075 22.540831356686663, 107.79343729938105 22.540831000656798, 107.7934373985851 22.540829781279935, 107.79343746420703 22.540829270953594, 107.7934374602275 22.540829033334425, 107.79343746195453 22.54082896372771, 107.79343749013314 22.54082853963571, 107.79343748562827 22.540828466534187, 107.79343732476035 22.540827293481037, 107.79343731948866 22.54082724434486, 107.79343728802256 22.540826838863552, 107.79343724014063 22.54082662522165, 107.79343722791315 22.540826558040596, 107.79343716690981 22.540826123631376, 107.79343714154636 22.540826028998495, 107.79343672458842 22.540824863974564, 107.79343670910409 22.540824816363674, 107.79343661037056 22.540824479502334, 107.79343653128048 22.540824302466177, 107.79343650771644 22.540824244101643, 107.79343634796376 22.540823802591234, 107.79343629790414 22.540823703951023, 107.7934356286134 22.54082260610552, 107.79343560346287 22.540822562054263, 107.79343545159806 22.540822277319062, 107.79343535702809 22.540822146689017, 107.79343531877802 22.540822089332654, 107.79343506585398 22.54082167632966, 107.79343498442141 22.540821572806774, 107.79343411364383 22.54082063019981, 107.79343408097054 22.540820592860666, 107.79343384847286 22.540820312187705, 107.79343382847375 22.540820292557477, 107.79343377406111 22.540820246035924, 107.7934336958566 22.54082017095063, 107.79343336675761 22.540819815963975, 107.79343325276163 22.540819718434538, 107.79343225196314 22.540818987623393, 107.79343221171598 22.5408189565685, 107.79343186561303 22.540818674536954, 107.79343172778081 22.540818591338233, 107.7934316570768 22.540818544348873, 107.7934313176464 22.540818296700625, 107.79343117321477 22.540818212921405, 107.79343018087211 22.540817744912673, 107.79343013786232 22.54081772334711, 107.79342956538225 22.540817418775276, 107.793429409814 22.540817362769022, 107.79342931984057 22.540817325395132, 107.79342899303737 22.540817170706024, 107.7934288044962 22.54081710433258, 107.79342851581157 22.540817028613734, 107.79342844298004 22.540817006595525, 107.79342829249092 22.540816954919627, 107.7934277894079 22.540816837087593, 107.79342770698682 22.540816814131095, 107.79342758259047 22.540816773823177, 107.79342741082702 22.54081670002654, 107.79342725773226 22.540816596686984, 107.79342712911975 22.540816467728728, 107.79342702987329 22.540816318048755, 107.79342696376179 22.540816153330983, 107.79342693329563 22.540815979830345, 107.79342693963169 22.540815804135303, 107.79342698252951 22.540815632917624, 107.79342706036 22.540815472679096, 107.79342717016765 22.540815329504547, 107.79342730778266 22.540815208830843, 107.79342746797933 22.54081511524042, 107.79342961126456 22.54081411931908, 107.7934296901586 22.54081407336315, 107.79343168651599 22.540812644924618, 107.79343175448652 22.540812585795603, 107.79343191778537 22.54081241351247, 107.79343197418875 22.540812358817398, 107.7934320958892 22.54081225031218, 107.79343249703531 22.540811802399226, 107.79343346086254 22.54081077951363, 107.79343360289272 22.540810575807722, 107.79343363626519 22.54081053097273, 107.79343378439425 22.540810344285678, 107.79343451532166 22.54080909677164, 107.79343490809414 22.540808460557738, 107.79343497167767 22.540808325159265, 107.7934350329095 22.54080819421103, 107.79343580913431 22.54080588200315, 107.79343581148288 22.540805868813617, 107.79343609438614 22.54080341192872, 107.79343609134028 22.540803240326703, 107.79343600965733 22.540802531884, 107.79343587219361 22.540801059444018, 107.79343582087444 22.54080084637346, 107.7934357718531 22.540800597847024, 107.79343550742635 22.540799845544125, 107.79343514453645 22.540798679770113, 107.7934351096485 22.540798598387855, 107.79343502998586 22.54079845500967, 107.7934349699948 22.540798321858347, 107.7934349250108 22.540798194176084, 107.79343488366756 22.540798108395315, 107.79343445282373 22.54079741622436, 107.79343393922747 22.54079649184574, 107.79343388802718 22.54079641828493, 107.79343371113613 22.54079621149088, 107.79343363141298 22.54079610289849, 107.79343350940972 22.54079590750916, 107.79343344978008 22.540795831581065, 107.79343294406247 22.540795311823594, 107.7934329041988 22.54079526814263, 107.79343230042255 22.540794562299393, 107.79343223484929 22.54079449934652, 107.79343193294622 22.540794261022988, 107.79343184841727 22.5407941856824, 107.79343155391268 22.54079388948827, 107.79343149104568 22.54079383983739, 107.79343084777842 22.54079340137522, 107.7934308030333 22.540793368966455, 107.79343017486114 22.54079288592233, 107.79343003637398 22.540792755233745, 107.79342992919918 22.540792601230354, 107.79342985776539 22.540792430275918, 107.79342982502449 22.540792249434677, 107.79342983232938 22.540792066179407, 107.79342987937818 22.540791888082627, 107.7934299642267 22.540791722503712, 107.79343008336897 22.540791576284757, 107.79343023188156 22.540791455467872, 107.79343040362768 22.540791365045486, 107.79343059151044 22.540791308754056, 107.79343078776597 22.540791288919678, 107.79343638548869 22.540791254827774, 107.79343894187564 22.54079100710739, 107.79343903490177 22.540790989399994, 107.79344148977562 22.540790283269686, 107.79344157729547 22.540790249044022, 107.7934438366984 22.540789111603125, 107.79344391534876 22.540789062174404, 107.79344589245355 22.540787537133976, 107.79344595921148 22.540787474401963, 107.79344757803906 22.54078562036849, 107.79344763033947 22.54078554674365, 107.79344882867902 22.540783434966798, 107.7934488645119 22.54078335327855, 107.79344959631214 22.540781064912355, 107.79344961430033 22.540780978300596, 107.79344985143852 22.540778601285645, 107.7934498508909 22.540778513077935, 107.79344958425395 22.540776138762336, 107.79344956519134 22.54077605234801, 107.79344880502617 22.54077377197495, 107.79344876818176 22.54077369067665, 107.79344754370045 22.540771591878688, 107.79344749048968 22.5407715188196, 107.79344584874912 22.540769682253536, 107.79344578121669 22.540769620240955, 107.793443785308 22.54076811648479, 107.79344370604933 22.540768067902157, 107.79344143267392 22.540766954744196, 107.79344134473449 22.540766921458385, 107.79343888125727 22.54076624167674, 107.79343878882682 22.540766225112236, 107.79343613471754 22.540766000846904, 107.7934306545129 22.540766030139935, 107.79342039821425 22.540765970564127, 107.79342024369524 22.54076597365581, 107.79341971456975 22.540766021304083, 107.79341961150976 22.54076602547151, 107.79341345533261 22.540765970385515, 107.79340258858305 22.540765970384584, 107.79338412541136 22.540765947087795, 107.79338392906442 22.540765928204536, 107.79338374088398 22.540765872830487, 107.79338356864491 22.540765783253445, 107.79338341946323 22.540765663174298, 107.79338329950237 22.54076551755411, 107.79338321371854 22.540765352409228, 107.79338316565588 22.540765174562612, 107.7933831573002 22.540764991362014, 107.79338318899656 22.540764810376402, 107.79338325943557 22.540764639083207, 107.79338336570696 22.540764484559432, 107.79338350342017 22.54076435318925, 107.79338366688546 22.540764250400223, 107.79338490236654 22.540763633425577, 107.79338498132753 22.54076358414255, 107.7933869632877 22.540762064722706, 107.79338703026269 22.54076200216288, 107.79338865539306 22.54076015218937, 107.79338870791427 22.54076007873532, 107.79338991292494 22.54075797077114, 107.79338994904697 22.540757889116477, 107.7933906878435 22.540755603031215, 107.79339070608725 22.540755516595198, 107.79339095137716 22.540753139847148, 107.79339095112978 22.540753051633562, 107.7933906925944 22.540750676815062, 107.79339067379472 22.540750590251612, 107.79338992074364 22.540748307494976, 107.79338988418105 22.54074822613856, 107.79338866647248 22.540746123674506, 107.79338861349247 22.540746050454548, 107.79338697771601 22.540744209280117, 107.79338691045741 22.540744147132983, 107.79338493524047 22.54074264917279, 107.79338471561172 22.540742525291407, 107.79338456083532 22.540742416979118, 107.79338443229052 22.54074228227759, 107.7933843350955 22.5407421265501, 107.79338427312005 22.540741955997085, 107.79338424883193 22.540741777409263, 107.79338426319808 22.540741597897277, 107.79338431564649 22.540741424608562, 107.79338440408888 22.540741264442772, 107.79338452500397 22.540741123777053, 107.7933846735773 22.540741008212134, 107.79338484389325 22.540740922349354, 107.79338502917058 22.540740869607408, 107.79338522203237 22.540740852086266, 107.79340171342075 22.540740889553867, 107.79341729523188 22.540740889599224, 107.79342117693129 22.540740854119452, 107.7934216121161 22.540740809309664, 107.79342168008566 22.540740804546694, 107.79342274710307 22.54074076468651, 107.7934228389512 22.54074075300939, 107.7934231451481 22.540740685858164, 107.79342326970458 22.540740666381854, 107.79342351547382 22.54074064308562, 107.79342366512643 22.540740616404275, 107.79342382674038 22.540740585315476, 107.79342445207504 22.540740401788266, 107.79342451597533 22.540740385241545, 107.7934253440363 22.54074019888017, 107.79342569746368 22.540740061668764, 107.79342577076635 22.540740036379795, 107.79342613590347 22.540739925731753, 107.79342619496074 22.540739904490838, 107.7934262710118 22.540739870196404, 107.79342636189702 22.540739834393754, 107.7934264371518 22.540739808857236, 107.79342652959886 22.540739768274356, 107.79342704787297 22.540739494436316, 107.79342712581553 22.540739457468167, 107.79342775200446 22.540739192797478, 107.79342783199806 22.54073915001232, 107.79342803687491 22.54073901476694, 107.79342814174777 22.540738954462878, 107.7934284421668 22.54073880534631, 107.7934285357113 22.540738748142537, 107.79342866129406 22.540738656959213, 107.79342876002758 22.540738593978514, 107.79342885686393 22.540738540053287, 107.79342932264798 22.54073817038858, 107.79342939092379 22.540738120918597, 107.79342986798787 22.54073780599421, 107.79342993779359 22.54073774989231, 107.79343013988732 22.540737553222783, 107.79343022725485 22.54073747802623, 107.7934305208796 22.54073725477187, 107.79343061231495 22.54073717086699, 107.79343075322164 22.54073701645124, 107.79343083909107 22.540736933676214, 107.79343096804969 22.540736824261504, 107.79343129794702 22.540736432549057, 107.79343136034701 22.54073636552032, 107.79343166241054 22.54073607156421, 107.79343171949401 22.540736004182666, 107.79343189193368 22.54073575500212, 107.7934319631382 22.540735664912418, 107.79343219492097 22.540735406834827, 107.79343229916212 22.540735267345074, 107.79343241305932 22.540735086454614, 107.79343246928144 22.540735007074897, 107.7934325784425 22.54073486933934, 107.79343282331794 22.540734418192805, 107.79343287355994 22.540734336522394, 107.79343307013062 22.54073405247186, 107.7934331124207 22.540733976255325, 107.79343323669896 22.540733687641573, 107.79343329140868 22.540733581314782, 107.79343342319736 22.540733363086492, 107.79343350722122 22.540733203455183, 107.79343359476555 22.54073300910093, 107.79343362511139 22.540732925855444, 107.79343366644335 22.540732830675132, 107.79343374073714 22.54073268420938, 107.79343389797889 22.540732166076978, 107.79343393075597 22.54073207639507, 107.79343404111994 22.54073181957863, 107.79343406580787 22.540731740694078, 107.79343413164386 22.540731422157197, 107.79343415908014 22.540731321251524, 107.7934342623145 22.540731016769374, 107.7934343114671 22.540730843677387, 107.79343437197528 22.540730567132425, 107.7934344352169 22.54073031433654, 107.79343444432482 22.540730254964146, 107.79343447747972 22.540729818734263, 107.79343449317668 22.54072970887053, 107.79343452363459 22.5407295644177, 107.79343454563165 22.540729370859687, 107.79343454518457 22.540729005627416, 107.79343455189795 22.54072889870695, 107.7934346012052 22.54072851121547, 107.7934346066314 22.540728218562688, 107.79343461975009 22.54072790231756, 107.79343458333916 22.540727560468618, 107.79343456525251 22.540727291108958, 107.79343456015695 22.540727159978164, 107.79343453640136 22.540726982216597, 107.79343445765784 22.540726605852623, 107.79343444231199 22.54072649832438, 107.79343441045724 22.540726086020058, 107.79343435007186 22.5407257915356, 107.79343430092023 22.54072547635414, 107.79343418459061 22.540725116201262, 107.79343416027953 22.54072502330948, 107.79343412812888 22.54072486413873, 107.79343411390316 22.540724819713848, 107.7934338602927 22.540724197647958, 107.79343383292795 22.54072412010558, 107.7934336964448 22.540723664725835, 107.79343360271609 22.54072346301483, 107.79343357517541 22.540723396674856, 107.79343348609301 22.540723154012017, 107.79343331779054 22.540722852666647, 107.79343327798561 22.54072277189925, 107.79343319611188 22.5407225815235, 107.79343313483973 22.540722473652593, 107.7934327687792 22.540721938509535, 107.79343272323028 22.540721864394722, 107.79343247602273 22.54072141391065, 107.79343234711045 22.540721240718916, 107.7934323064484 22.540721181253446, 107.7934322071035 22.540721022602387, 107.79343199511031 22.54072076824799, 107.79343174752078 22.540720447625226, 107.79343163711663 22.54072031132697, 107.79343118513152 22.540719878119187, 107.79343112208029 22.540719811411567, 107.79343079781886 22.54071943223364, 107.79343064798825 22.54071929702949, 107.79343059149423 22.540719241543425, 107.79343054605982 22.540719192955002, 107.79343043212683 22.540719087860253, 107.79343034340188 22.540719018838043, 107.79343028230264 22.54071896703825, 107.79343006998336 22.54071877100006, 107.7934299891608 22.540718715086882, 107.79342991168902 22.540718655455397, 107.79342970868846 22.54071848196399, 107.79342918418676 22.540718149636096, 107.79342911582698 22.540718102101604, 107.79342863349511 22.54071773489507, 107.79342848001723 22.540717645138376, 107.7934283390006 22.540717560579314, 107.79342800611408 22.540717357121927, 107.79342795660504 22.54071733486376, 107.79342788827988 22.540717300958043, 107.79342760920373 22.540717148879015, 107.79342744052647 22.540717058699496, 107.79342685398323 22.540716830800328, 107.79342677466708 22.540716795993106, 107.7934262542918 22.540716540316065, 107.79342607304838 22.54071647842818, 107.79342557811961 22.54071629335282, 107.79342530217316 22.540716191347176, 107.79342515894487 22.54071615950917, 107.79342507541826 22.540716137228372, 107.79342490830156 22.54071608502586, 107.79342414461527 22.540715933052816, 107.79342407657839 22.540715917105285, 107.79342366024873 22.540715804511596, 107.79342356146351 22.54071578901882, 107.79342313731578 22.540715709529685, 107.79342287435514 22.54071565167104, 107.79342278213986 22.54071563971883, 107.79342244443062 22.540715626413366, 107.7934223816763 22.540715622045177, 107.79342220951864 22.540715604835764, 107.79342197492052 22.540715606736057, 107.79342192529913 22.54071560596001, 107.793421508529 22.54071558953961, 107.79342145277711 22.540715585847586, 107.79342114847384 22.540715557499826, 107.79342091509176 22.540715562958404, 107.79342085141246 22.540715562507714, 107.7934202591567 22.54071554026298, 107.7934201740635 22.540715544886435, 107.79341982999081 22.540715593225613, 107.79341968791022 22.540715603364713, 107.79341073481 22.5407156302778, 107.79339178015043 22.540715551261513, 107.79339158451758 22.540715531934755, 107.79339139709215 22.540715476379468, 107.79339122556604 22.54071538687562, 107.79339107697847 22.540715267096346, 107.7933909574273 22.54071512195731, 107.7933908718189 22.540714957414885, 107.79339082366653 22.540714780221762, 107.7933908149463 22.540714597649806, 107.7933908460162 22.54071441719161, 107.79339091560101 22.54071424625303, 107.79339102084502 22.540714091849257, 107.79339115742923 22.540713960316875, 107.79339131974822 22.540713857053884, 107.79339296356402 22.540713024800844, 107.79339304208696 22.54071297519841, 107.79339501527285 22.54071144578517, 107.79339508186949 22.54071138290572, 107.79339669593517 22.540709525293547, 107.7933967480464 22.54070945155327, 107.79339794096423 22.540707337129387, 107.79339797658723 22.540707255362346, 107.79339870251424 22.54070496538262, 107.79339872028025 22.540704878730327, 107.79339895131925 22.540702501198176, 107.79339895054538 22.540702412990967, 107.79339867781803 22.540700039272515, 107.79339865853396 22.540699952901345, 107.79339789252096 22.54069767421735, 107.79339785546756 22.54069759299979, 107.79339662560649 22.540695496919422, 107.79339657220822 22.540695423977933, 107.7933949257615 22.540693591051554, 107.79339485806995 22.540693529188395, 107.79339285831038 22.540692029855194, 107.79339277892693 22.540691981447857, 107.79339050270345 22.540690873325765, 107.79339041467937 22.54069084023487, 107.79338794946597 22.540690165908522, 107.79338785695035 22.540690149541096, 107.79338520358769 22.540689931035597, 107.7933772990207 22.540689971063962, 107.79336158033554 22.540690120009046, 107.7933458661492 22.540690050534156, 107.79332995353973 22.540690020701945, 107.7932982472159 22.540690220426526, 107.79327450521399 22.54069027069094, 107.79325090672134 22.540690419985292, 107.79323524540595 22.540690300838136, 107.79322717457252 22.54069030042996, 107.7932191873606 22.540690320517676, 107.79319550837097 22.540690420424244, 107.79317165393567 22.54069045058048, 107.79310054405973 22.5406908001988, 107.7930854021935 22.540690730559586, 107.79307669638096 22.54069077082331, 107.79305588242353 22.540690930084118, 107.79303488041387 22.540690830546612, 107.79300335202169 22.540690970140723, 107.79298236072036 22.54069083072752, 107.79297166726799 22.54069083044307, 107.79295026786487 22.540690880266556, 107.79295019907185 22.54069087816091, 107.7929500939322 22.540690871471696, 107.79294908720664 22.54069096070505, 107.7929490242457 22.540690964373773, 107.79294833168105 22.540690983783623, 107.79294823130172 22.540690996443953, 107.79294797151857 22.54069105543184, 107.7929478375182 22.540691076758748, 107.7929474168411 22.540691115822288, 107.79294732238937 22.54069113354068, 107.79294617873887 22.54069146088631, 107.79294613029151 22.54069147348664, 107.79294550778512 22.540691619348195, 107.79294529327447 22.540691707712007, 107.79294518556178 22.5406917451621, 107.79294483010126 22.540691846905105, 107.79294474129445 22.540691881640598, 107.7929437292144 22.54069239300503, 107.7929436801295 22.540692416155867, 107.79294317321249 22.5406926386874, 107.79294290515504 22.540692805118404, 107.79294282952671 22.540692847582054, 107.79294244859625 22.540693040051295, 107.79294237523183 22.540693086049295, 107.79294150596918 22.540693762528203, 107.79294145865397 22.540693797089457, 107.79294102778192 22.540694092214032, 107.79294095804495 22.5406941504564, 107.79294083755882 22.54069427265141, 107.79294074513135 22.54069435480274, 107.7929403668568 22.540694649232485, 107.79294031633948 22.540694696025557, 107.79293962082247 22.540695503663876, 107.79293957861803 22.540695549448266, 107.792939243962 22.540695888850827, 107.79293918761225 22.5406959584836, 107.79293908242704 22.540696118691464, 107.79293901204218 22.54069621206401, 107.79293868968965 22.540696586857557, 107.7929384953577 22.54069689403106, 107.79293815140174 22.540697530828833, 107.79293811250045 22.540697595989084, 107.79293786622509 22.540697971091788, 107.79293782537447 22.540698049505195, 107.79293774514971 22.540698251296007, 107.79293769785136 22.5406983512076, 107.79293743952576 22.54069881801025, 107.79293733979524 22.540699079127663, 107.79293713102862 22.540699786352675, 107.79293710546204 22.540699860315186, 107.79293694620232 22.54070026090436, 107.79293692238173 22.54070034515957, 107.79293687971436 22.54070059094709, 107.7929368590021 22.540700680839453, 107.79293667103124 22.540701332421172, 107.79293659477528 22.54070221434981, 107.79293658550726 22.540702285740938, 107.79293651747767 22.540702677628556, 107.79293651132514 22.5407027542215, 107.7929365161071 22.54070316098399, 107.79293651355128 22.54070323697581, 107.79293647153817 22.540703767839645))</textarea>
            <div class="coord-settings" style="margin-bottom:8px;font-size:12px;color:#333;">
                <label>WKT坐标系：
                    <select id="coordSysSelect" style="margin-left:6px;">
                        <option value="wgs84" selected>WGS84</option>
                        <option value="gcj02">GCJ-02（国测局）</option>
                        <option value="bd09">BD-09（百度）</option>
                        <option value="cgcs2000">CGCS2000</option>
                    </select>
                </label>
                <!-- 已移除“不进行绘制坐标转换”选项，统一使用WGS84绘制 -->
            </div>

            <div class="button-group">
                <button id="drawButton" disabled>绘制轮廓</button>
                <button id="clearButton" disabled>清空轮廓</button>
            </div>
            <!-- 显示开关：仅保留显示亩数 -->
            <div class="display-toggles" style="margin-top:8px;font-size:12px;color:#333;">
                <label><input type="checkbox" id="toggleLabelsCheckbox"> 显示亩数</label>
            </div>
        </div>

        <div class="tab-pane" id="tabSplit">
            <!-- MultiPolygon → 多个 Polygon 分割器 -->
            <div class="split-section">
                <div class="title">MultiPolygon → 多个 Polygon 分割器</div>
                <div class="desc">输入一个 MULTIPOLYGON WKT，分割为多行 POLYGON WKT。</div>
                <textarea id="multiInput"></textarea>
                <div class="split-actions">
                    <button id="splitMultiBtn">分割为多个 POLYGON</button>
                    <button id="copyPolysBtn">复制结果</button>
                </div>
                <textarea id="polyOutput" readonly></textarea>
            </div>
        </div>

        <div class="tab-pane" id="tabBatch">
            <!-- 批量POLYGON → MULTIPOLYGON 生成器 -->
            <div class="batch-section">
                <div class="title">批量POLYGON → MULTIPOLYGON 合并器</div>
                <div class="desc">每行一个 POLYGON WKT（或用分号分隔）。生成后可一键填充到上方并绘制。</div>
                <textarea id="batchInput"></textarea>
                <div class="batch-actions">
                    <button id="generateMultiBtn">生成 MULTIPOLYGON</button>
                    <button id="copyMultiBtn">复制结果</button>
                </div>
                <textarea id="multiOutput" readonly></textarea>
            </div>
        </div>
        <div class="tab-pane" id="tabTrack">
            <div class="tip">请粘贴轨迹文本（支持两种格式：1）每行一条：定位时间yyyyMMddHHmmss, 经度, 纬度；2）单行#分隔：经度,纬度,定位时间yyyyMMddHHmmss#经度,纬度,定位时间yyyyMMddHHmmss#…）。</div>
            <div class="coord-settings" style="margin-bottom:8px;font-size:12px;color:#333;">
                <label>轨迹坐标系：
                    <select id="trackCoordSysSelect" style="margin-left:6px;">
                        <option value="wgs84" selected>WGS84</option>
                        <option value="gcj02">GCJ-02（国测局）</option>
                        <option value="bd09">BD-09（百度）</option>
                        <option value="cgcs2000">CGCS2000</option>
                    </select>
                </label>
            </div>
            <textarea id="trackTextarea" style="width:100%;height:120px;margin-bottom:10px;padding:8px;border:1px solid #ddd;border-radius:4px;font-family:monospace;resize:vertical;box-sizing:border-box;">20251104090718,107.79342385,22.54082890,0,26
20251104090719,107.79342386,22.54082888,0,23
20251104090720,107.79342388,22.54082890,0,75
20251104090721,107.79342385,22.54082890,0,350
20251104090722,107.79342388,22.54082890,0,87
20251104090723,107.79342390,22.54082888,0,101
20251104090724,107.79342388,22.54082890,0,76
20251104090725,107.79342386,22.54082888,0,275
20251104090726,107.79342385,22.54082890,0,290
20251104090727,107.79342383,22.54082890,0,17
20251104090728,107.79342385,22.54082890,0,181
20251104090729,107.79342381,22.54082890,0,33
20251104090730,107.79342383,22.54082890,0,30
20251104090731,107.79342383,22.54082888,0,109
20251104090732,107.79342381,22.54082891,0,353
20251104090733,107.79342381,22.54082891,0,319
20251104090734,107.79342381,22.54082891,0,32
20251104090735,107.79342381,22.54082890,0,75
20251104090736,107.79342380,22.54082891,0,272
20251104090737,107.79342380,22.54082893,0,70
20251104090738,107.79342380,22.54082891,0,71
20251104090739,107.79342380,22.54082893,0,324
20251104090740,107.79342380,22.54082893,0,313
20251104090741,107.79342381,22.54082893,0,19
20251104090742,107.79342380,22.54082891,0,113
20251104090743,107.79342380,22.54082893,0,20
20251104090744,107.79342380,22.54082891,0,140
20251104090745,107.79342378,22.54082893,0,307
20251104090746,107.79342378,22.54082893,0,45
20251104090747,107.79342380,22.54082891,0,71
20251104090748,107.79342378,22.54082893,0,310
20251104090749,107.79342380,22.54082891,0,44
20251104090750,107.79342380,22.54082891,0,140
20251104090751,107.79342376,22.54082893,0,352
20251104090752,107.79342378,22.54082893,0,66
20251104090753,107.79342380,22.54082891,0,99
20251104090754,107.79342378,22.54082890,0,60
20251104090755,107.79342380,22.54082890,0,358
20251104090756,107.79342376,22.54082893,0,340
20251104090757,107.79342378,22.54082893,0,352
20251104090758,107.79342371,22.54082893,0,26
20251104090759,107.79342370,22.54082893,0,30
20251104090800,107.79342373,22.54082891,0,36
20251104090801,107.79342371,22.54082893,0,1
20251104090802,107.79342370,22.54082895,0,51
20251104090803,107.79342371,22.54082895,0,4
20251104090804,107.79342360,22.54082891,0,267
20251104090805,107.79342356,22.54082895,0,273
20251104090806,107.79341820,22.54082895,1.9,269
20251104090807,107.79341276,22.54082896,1.9,269
20251104090808,107.79340720,22.54082896,2,270
20251104090809,107.79340166,22.54082898,1.9,269
20251104090810,107.79339613,22.54082893,2,268
20251104090811,107.79339058,22.54082890,2,269
20251104090812,107.79338506,22.54082898,1.9,271
20251104090813,107.79337946,22.54082896,2,269
20251104090814,107.79337391,22.54082908,2,271
20251104090815,107.79336838,22.54082910,2,270
20251104090816,107.79336281,22.54082913,2,271
20251104090817,107.79335726,22.54082905,2,269
20251104090818,107.79335170,22.54082905,1.9,269
20251104090819,107.79334613,22.54082903,2,271
20251104090820,107.79334061,22.54082898,2,270
20251104090821,107.79333508,22.54082903,2,270
20251104090822,107.79332958,22.54082906,2,270
20251104090823,107.79332400,22.54082908,2,271
20251104090824,107.79331845,22.54082906,2,270
20251104090825,107.79331288,22.54082908,1.9,269
20251104090826,107.79330730,22.54082908,2,271
20251104090827,107.79330181,22.54082911,2,270
20251104090828,107.79329623,22.54082916,2,270
20251104090829,107.79329073,22.54082910,2,269
20251104090830,107.79328518,22.54082916,2,272
20251104090831,107.79327966,22.54082915,2,271
20251104090832,107.79327413,22.54082916,2,269
20251104090833,107.79326855,22.54082915,2,272
20251104090834,107.79326303,22.54082913,2.1,269
20251104090835,107.79325746,22.54082913,2,271
20251104090836,107.79325193,22.54082915,2,270
20251104090837,107.79324631,22.54082915,2,269
20251104090838,107.79324083,22.54082915,2,270
20251104090839,107.79323530,22.54082913,2,270
20251104090840,107.79322976,22.54082916,2,268
20251104090841,107.79322420,22.54082925,1.9,272
20251104090842,107.79321863,22.54082928,2.1,271
20251104090843,107.79321308,22.54082928,2,270
20251104090844,107.79320746,22.54082931,2,271
20251104090845,107.79320191,22.54082928,2,271
20251104090846,107.79319633,22.54082935,2,273
20251104090847,107.79319076,22.54082933,2,271
20251104090848,107.79318533,22.54082938,2,271
20251104090849,107.79317981,22.54082936,2,271
20251104090850,107.79317428,22.54082946,2,271
20251104090851,107.79316876,22.54082941,2,272
20251104090852,107.79316319,22.54082945,2,271
20251104090853,107.79315761,22.54082946,2,269
20251104090854,107.79315198,22.54082941,2.1,269
20251104090855,107.79314641,22.54082941,2,269
20251104090856,107.79314086,22.54082943,1.9,268
20251104090857,107.79313535,22.54082940,2,269
20251104090858,107.79312980,22.54082940,2,266
20251104090859,107.79312430,22.54082948,2,271
20251104090900,107.79311878,22.54082943,1.9,268
20251104090901,107.79311318,22.54082941,2,270
20251104090903,107.79310208,22.54082955,2,268
20251104090905,107.79309091,22.54082946,2.1,270
20251104090906,107.79309091,22.54082946,2.1,267
20251104090907,107.79307986,22.54082955,2.1,270
20251104090908,107.79307430,22.54082955,1.9,270
20251104090909,107.79306873,22.54082953,2,269
20251104090910,107.79306316,22.54082956,2.1,268
20251104090911,107.79305764,22.54082953,2,269
20251104090912,107.79305211,22.54082955,2,273
20251104090913,107.79304653,22.54082956,1.9,269
20251104090914,107.79304106,22.54082960,1.9,268
20251104090915,107.79303556,22.54082958,2,274
20251104090917,107.79302450,22.54082961,2,269
20251104090918,107.79301890,22.54082963,1.9,270
20251104090919,107.79301333,22.54082965,2,272
20251104090920,107.79300775,22.54082966,2,276
20251104090921,107.79300215,22.54082968,2,274
20251104090922,107.79299661,22.54082970,2.1,273
20251104090923,107.79299110,22.54082968,1.9,270
20251104090924,107.79298551,22.54082966,1.9,266
20251104090925,107.79298000,22.54082965,2,270
20251104090926,107.79297450,22.54082968,2.1,269
20251104090927,107.79296890,22.54082973,2,270
20251104090928,107.79296351,22.54082971,1.9,271
20251104090930,107.79295880,22.54082976,0.2,291
20251104090931,107.79295870,22.54082973,0,49
20251104090932,107.79295875,22.54082973,0,51
20251104090933,107.79295810,22.54082973,0.1,260
20251104090934,107.79295671,22.54082978,0.2,265
20251104090935,107.79295676,22.54082976,0,355
20251104090936,107.79295673,22.54082975,0,253
20251104090937,107.79295671,22.54082976,0,309
20251104091048,107.79295350,22.54080405,0,274
20251104091049,107.79295348,22.54080410,0,31
20251104091050,107.79295355,22.54080406,0,76
20251104091051,107.79295355,22.54080406,0,350
20251104091052,107.79295356,22.54080405,0,214
20251104091053,107.79295355,22.54080408,0,36
20251104091054,107.79295359,22.54080405,0,95
20251104091055,107.79295356,22.54080405,0,299
20251104091056,107.79295361,22.54080403,0,19
20251104091057,107.79295361,22.54080403,0,341
20251104091058,107.79295359,22.54080405,0,11
20251104091059,107.79295359,22.54080408,0,43
20251104091100,107.79295361,22.54080408,0,26
20251104091101,107.79295363,22.54080406,0,24
20251104091102,107.79295365,22.54080408,0,83
20251104091103,107.79295361,22.54080405,0,130
20251104091104,107.79295365,22.54080408,0,55
20251104091105,107.79295361,22.54080406,0,338
20251104091106,107.79295368,22.54080405,0,355
20251104091107,107.79295361,22.54080411,0,57
20251104091108,107.79295366,22.54080406,0,340
20251104091109,107.79295365,22.54080406,0,73
20251104091110,107.79295476,22.54080405,0.2,85
20251104091111,107.79296010,22.54080413,2.1,88
20251104091112,107.79296790,22.54080411,2.8,88
20251104091113,107.79297583,22.54080408,2.8,90
20251104091114,107.79298378,22.54080410,2.9,89
20251104091115,107.79299164,22.54080406,3,90
20251104091116,107.79299956,22.54080410,3,89
20251104091117,107.79300748,22.54080411,2.9,87
20251104091118,107.79301543,22.54080410,3,89
20251104091119,107.79302335,22.54080415,2.9,91
20251104091120,107.79303118,22.54080403,2.9,93
20251104091121,107.79303903,22.54080391,2.9,89
20251104091122,107.79304693,22.54080398,2.9,89
20251104091123,107.79305480,22.54080398,2.9,89
20251104091124,107.79306281,22.54080398,3,90
20251104091125,107.79307078,22.54080393,2.9,93
20251104091126,107.79307868,22.54080390,2.9,91
20251104091127,107.79308653,22.54080373,3,91
20251104091128,107.79309445,22.54080378,2.9,88
20251104091129,107.79310235,22.54080370,2.9,89
20251104091130,107.79311025,22.54080388,2.8,90
20251104091131,107.79311816,22.54080388,2.9,89
20251104091132,107.79312603,22.54080390,2.9,90
20251104091134,107.79314191,22.54080380,3,87
20251104091135,107.79314988,22.54080380,2.8,90
20251104091136,107.79315780,22.54080385,3.1,88
20251104091137,107.79316570,22.54080380,2.9,88
20251104091138,107.79317360,22.54080380,2.8,88
20251104091140,107.79318943,22.54080358,3,90
20251104091141,107.79319741,22.54080356,3,90
20251104091142,107.79320528,22.54080365,2.9,90
20251104091143,107.79321318,22.54080365,2.9,89
20251104091144,107.79322106,22.54080363,2.9,89
20251104091145,107.79322896,22.54080355,2.9,87
20251104091146,107.79323686,22.54080351,2.9,91
20251104091147,107.79324478,22.54080356,3,90
20251104091148,107.79325271,22.54080360,2.9,91
20251104091149,107.79326060,22.54080365,2.9,93
20251104091150,107.79326851,22.54080360,2.9,92
20251104091151,107.79327643,22.54080360,3,89
20251104091152,107.79328433,22.54080353,2.9,91
20251104091153,107.79329230,22.54080345,2.9,90
20251104091154,107.79330013,22.54080353,2.9,90
20251104091155,107.79330805,22.54080353,2.8,89
20251104091156,107.79331595,22.54080355,3,90
20251104091157,107.79332386,22.54080353,2.9,89
20251104091158,107.79333173,22.54080343,3,89
20251104091159,107.79333963,22.54080341,3,89
20251104091200,107.79334755,22.54080345,2.9,89
20251104091201,107.79335548,22.54080348,2.9,88
20251104091202,107.79336346,22.54080350,2.8,91
20251104091204,107.79337931,22.54080340,3,88
20251104091205,107.79338715,22.54080331,2.8,90
20251104091206,107.79339501,22.54080326,2.9,90
20251104091207,107.79340298,22.54080325,3,89
20251104091208,107.79341090,22.54080340,2.9,90
20251104091209,107.79341773,22.54080333,2.2,90
20251104091210,107.79341955,22.54080331,0.1,44
20251104091211,107.79341935,22.54080335,0,36
20251104091212,107.79341960,22.54080331,0,101
20251104091213,107.79342201,22.54080330,0.7,87
20251104091214,107.79342243,22.54080340,0,343
20251104091215,107.79342246,22.54080331,0,179
20251104091216,107.79342250,22.54080331,0,1
20251104091217,107.79342246,22.54080331,0,46
20251104091218,107.79342244,22.54080326,0,178
20251104091329,107.79343626,22.54077863,2.1,272
20251104091330,107.79343066,22.54077866,2,272
20251104091331,107.79342506,22.54077863,2,272
20251104091332,107.79342300,22.54077866,0.2,282
20251104091333,107.79342291,22.54077861,0,42
20251104091334,107.79342294,22.54077865,0,323
20251104091335,107.79342114,22.54077865,1,269
20251104091336,107.79342033,22.54077860,0.1,115
20251104091337,107.79342028,22.54077860,0,89
20251104091338,107.79342031,22.54077863,0,14
20251104091339,107.79342033,22.54077861,0,197
20251104091340,107.79342031,22.54077861,0,65
20251104091341,107.79342033,22.54077861,0,74
20251104091342,107.79342028,22.54077861,0,94
20251104091343,107.79342031,22.54077865,0,30
20251104091344,107.79342033,22.54077863,0,79
20251104091345,107.79342035,22.54077861,0,62
20251104091346,107.79342031,22.54077863,0,248
20251104091347,107.79342036,22.54077865,0,107
20251104091348,107.79342008,22.54077866,0,274
20251104091349,107.79341886,22.54077865,0.1,266
20251104091350,107.79341681,22.54077863,0.3,266
20251104091351,107.79341346,22.54077860,1,266
20251104091352,107.79340880,22.54077861,1.7,267
20251104091353,107.79340258,22.54077860,2.6,268
20251104091354,107.79339195,22.54077870,3.8,270
20251104091355,107.79338136,22.54077865,3.8,268
20251104091356,107.79337088,22.54077856,3.9,269
20251104091357,107.79336041,22.54077856,3.8,269
20251104091358,107.79334975,22.54077865,3.9,270
20251104091359,107.79333931,22.54077861,3.9,270
20251104091400,107.79332873,22.54077868,3.7,268
20251104091401,107.79331823,22.54077861,3.9,270
20251104091402,107.79330775,22.54077850,3.8,269
20251104091403,107.79329728,22.54077865,3.7,269
20251104091405,107.79327624,22.54077866,3.8,271
20251104091406,107.79326568,22.54077850,3.8,267
20251104091407,107.79325518,22.54077861,3.9,273
20251104091408,107.79324465,22.54077876,3.9,270
20251104091409,107.79323421,22.54077881,3.9,272
20251104091410,107.79322371,22.54077883,3.7,272
20251104091412,107.79320265,22.54077875,3.8,270
20251104091413,107.79319216,22.54077885,3.8,269
20251104091414,107.79318168,22.54077891,3.8,271
20251104091415,107.79317115,22.54077885,3.8,269
20251104091416,107.79316061,22.54077888,3.7,270
20251104091417,107.79314998,22.54077891,3.9,269
20251104091418,107.79313950,22.54077901,3.9,270
20251104091419,107.79312895,22.54077903,3.8,270
20251104091420,107.79311841,22.54077893,3.9,269
20251104091421,107.79310795,22.54077893,3.8,267
20251104091422,107.79309748,22.54077906,3.7,270
20251104091423,107.79308700,22.54077910,3.8,269
20251104091424,107.79307643,22.54077906,3.8,269
20251104091425,107.79306590,22.54077896,3.8,270
20251104091426,107.79305543,22.54077896,3.7,269
20251104091427,107.79304500,22.54077910,3.9,270
20251104091429,107.79302388,22.54077911,3.7,269
20251104091430,107.79301338,22.54077905,4,269
20251104091431,107.79300291,22.54077911,3.7,270
20251104091432,107.79299236,22.54077920,3.8,270
20251104091433,107.79298176,22.54077921,3.8,270
20251104091434,107.79297220,22.54077921,3.4,269
20251104091435,107.79296520,22.54077916,2.4,269
20251104091436,107.79296036,22.54077918,1.6,270
20251104091437,107.79295526,22.54077915,1.7,273
20251104091438,107.79295215,22.54077925,0.9,276
20251104091439,107.79295225,22.54077923,0,84
20251104091550,107.79295060,22.54075381,0,99
20251104091551,107.79295064,22.54075380,0,22
20251104091552,107.79295063,22.54075380,0,71
20251104091553,107.79295228,22.54075381,0.1,76
20251104091554,107.79295193,22.54075381,0,137
20251104091555,107.79295191,22.54075383,0,1
20251104091556,107.79295190,22.54075383,0,358
20251104091557,107.79295195,22.54075380,0,23
20251104091558,107.79295193,22.54075380,0,325
20251104091559,107.79295190,22.54075380,0,348
20251104091600,107.79295191,22.54075380,0,68
20251104091601,107.79295190,22.54075380,0,49
20251104091602,107.79295190,22.54075381,0,210
20251104091603,107.79295191,22.54075380,0,118
20251104091604,107.79295186,22.54075381,0,2
20251104091605,107.79295185,22.54075380,0,15
20251104091606,107.79295186,22.54075378,0,150
20251104091607,107.79295186,22.54075383,0,101
20251104091608,107.79295271,22.54075381,0.1,81
20251104091609,107.79295573,22.54075383,0.5,78
20251104091610,107.79296078,22.54075385,1.9,85
20251104091611,107.79296781,22.54075371,2.7,90
20251104091612,107.79297801,22.54075368,3.8,88
20251104091613,107.79298841,22.54075375,3.9,89
20251104091614,107.79299891,22.54075368,3.7,92
20251104091615,107.79300948,22.54075373,3.8,88
20251104091616,107.79302005,22.54075370,3.8,90
20251104091617,107.79303048,22.54075375,4,89
20251104091618,107.79304090,22.54075376,3.9,88
20251104091619,107.79305148,22.54075375,3.8,90
20251104091620,107.79306203,22.54075378,3.9,89
20251104091621,107.79307241,22.54075380,3.8,89
20251104091622,107.79308291,22.54075378,3.9,90
20251104091623,107.79309348,22.54075380,3.8,88
20251104091624,107.79310396,22.54075373,3.8,90
20251104091625,107.79311448,22.54075368,3.9,91
20251104091626,107.79312499,22.54075370,3.8,88
20251104091627,107.79313558,22.54075358,3.9,89
20251104091628,107.79314608,22.54075355,3.8,90
20251104091629,107.79315668,22.54075358,3.9,89
20251104091630,107.79316723,22.54075358,3.8,88
20251104091631,107.79317770,22.54075356,3.8,90
20251104091633,107.79319860,22.54075351,3.9,90
20251104091634,107.79320918,22.54075350,3.9,88
20251104091636,107.79323015,22.54075348,3.9,89
20251104091637,107.79324068,22.54075341,3.8,90
20251104091638,107.79325110,22.54075341,3.9,88
20251104091639,107.79326170,22.54075336,3.9,89
20251104091640,107.79327216,22.54075335,3.9,89
20251104091641,107.79328269,22.54075343,3.8,90
20251104091643,107.79330376,22.54075346,3.9,90
20251104091644,107.79331421,22.54075328,3.9,90
20251104091645,107.79332478,22.54075323,3.9,90
20251104091646,107.79333523,22.54075316,3.9,90
20251104091647,107.79334571,22.54075321,3.9,89
20251104091649,107.79336683,22.54075315,3.9,90
20251104091650,107.79337736,22.54075313,3.8,89
20251104091811,107.79342079,22.54072818,0.4,268
20251104091812,107.79342093,22.54072821,0,320
20251104091813,107.79342095,22.54072815,0,171
20251104091814,107.79342091,22.54072821,0,151
20251104091815,107.79342095,22.54072825,0,352
20251104091816,107.79342098,22.54072819,0,52
20251104091817,107.79342098,22.54072821,0,50
20251104091818,107.79342100,22.54072819,0,29
20251104091819,107.79342100,22.54072821,0,56
20251104091820,107.79342101,22.54072818,0,28
20251104091821,107.79342100,22.54072819,0,149
20251104091822,107.79342098,22.54072819,0,35
20251104091823,107.79342098,22.54072819,0,42
20251104091824,107.79342098,22.54072819,0,67
20251104091825,107.79342096,22.54072819,0,154
20251104091826,107.79342095,22.54072821,0,261
20251104091827,107.79342100,22.54072819,0,21
20251104091828,107.79342096,22.54072819,0,119
20251104091829,107.79342098,22.54072819,0,138
20251104091830,107.79342098,22.54072821,0,335
20251104091831,107.79342095,22.54072821,0,51
20251104091832,107.79342096,22.54072821,0,320
20251104091833,107.79342101,22.54072823,0,90
20251104091834,107.79342096,22.54072821,0,137
20251104091835,107.79342098,22.54072819,0,123
20251104091836,107.79342098,22.54072819,0,337
20251104091837,107.79342101,22.54072819,0,107
20251104091838,107.79342100,22.54072823,0,190
20251104091839,107.79342098,22.54072823,0,357
20251104091840,107.79342098,22.54072821,0,57
20251104091841,107.79342098,22.54072821,0,208
20251104091842,107.79342096,22.54072819,0,341
20251104091843,107.79342098,22.54072821,0,62
20251104091844,107.79342101,22.54072823,0,355
20251104091845,107.79342098,22.54072821,0,115
20251104091846,107.79342103,22.54072821,0,35
20251104091847,107.79342098,22.54072823,0,57
20251104091848,107.79342101,22.54072823,0,71
20251104091849,107.79342070,22.54072823,0,272
20251104091850,107.79341730,22.54072826,1.1,261
20251104091851,107.79341073,22.54072826,2.6,268
20251104091852,107.79340175,22.54072826,3.5,269
20251104091853,107.79339158,22.54072818,3.9,269
20251104091854,107.79338108,22.54072821,3.8,271
20251104091855,107.79337054,22.54072819,3.8,270
20251104091856,107.79336009,22.54072825,3.8,268
20251104091857,107.79334956,22.54072823,3.9,270
20251104091859,107.79332851,22.54072823,3.8,270
20251104091901,107.79330749,22.54072826,3.8,268
20251104091903,107.79328645,22.54072830,3.9,270
20251104091904,107.79327591,22.54072833,3.8,269
20251104091905,107.79326546,22.54072843,3.8,270
20251104091907,107.79324450,22.54072830,3.9,271
20251104091908,107.79323391,22.54072841,3.9,270
20251104091909,107.79322338,22.54072855,3.8,270
20251104091910,107.79321296,22.54072860,3.9,271
20251104091911,107.79320243,22.54072851,3.8,269
20251104091912,107.79319190,22.54072850,3.8,269
20251104091913,107.79318139,22.54072846,3.9,270
20251104091914,107.79317086,22.54072848,3.8,269
20251104091915,107.79316038,22.54072845,3.8,270
20251104091916,107.79314969,22.54072855,3.9,268
20251104091917,107.79313920,22.54072845,3.8,270
20251104091919,107.79311828,22.54072850,3.8,270
20251104091920,107.79310770,22.54072853,3.8,270
20251104091922,107.79308673,22.54072861,3.8,271
20251104091923,107.79307618,22.54072860,3.8,270
20251104091924,107.79306565,22.54072873,3.8,271
20251104091925,107.79305523,22.54072875,3.7,268
20251104091926,107.79304474,22.54072871,3.9,269
20251104091927,107.79303425,22.54072875,3.9,269
20251104091928,107.79302365,22.54072876,3.8,270
20251104091929,107.79301313,22.54072891,4,271
20251104091930,107.79300268,22.54072880,3.9,269
20251104091931,107.79299215,22.54072875,3.7,268
20251104092102,107.79295010,22.54070351,0,17
20251104092103,107.79295013,22.54070351,0,75
20251104092104,107.79295006,22.54070350,0,146
20251104092105,107.79295010,22.54070350,0,261
20251104092106,107.79295008,22.54070350,0,83
20251104092107,107.79295011,22.54070350,0,55
20251104092108,107.79295006,22.54070353,0,43
20251104092109,107.79295008,22.54070351,0,86
20251104092110,107.79295034,22.54070353,0,71
20251104092111,107.79295408,22.54070351,1.2,80
20251104092112,107.79296125,22.54070353,2.7,88
20251104092113,107.79297171,22.54070346,3.7,89
20251104092114,107.79298226,22.54070346,3.9,87
20251104092115,107.79299281,22.54070356,3.9,88
20251104092116,107.79300333,22.54070360,3.7,89
20251104092117,107.79301396,22.54070363,3.9,89
20251104092118,107.79302443,22.54070356,3.7,88
20251104092119,107.79303495,22.54070346,3.9,88
20251104092120,107.79304545,22.54070354,3.9,88
20251104092121,107.79305591,22.54070356,3.9,88
20251104092122,107.79306641,22.54070353,3.9,90
20251104092123,107.79307681,22.54070340,3.8,88
20251104092124,107.79308533,22.54070336,2.8,88
20251104092125,107.79309276,22.54070341,2.9,87
20251104092126,107.79310054,22.54070343,2.9,88
20251104092128,107.79311633,22.54070340,2.9,91
20251104092129,107.79312423,22.54070335,2.9,88
20251104092130,107.79313226,22.54070328,2.9,90
20251104092132,107.79314808,22.54070321,2.9,88
20251104092133,107.79314808,22.54070321,2.8,89
20251104092134,107.79316386,22.54070313,2.9,90
20251104092135,107.79317173,22.54070308,2.9,89
20251104092136,107.79317965,22.54070308,3,90
20251104092138,107.79319555,22.54070305,2.8,88
20251104092139,107.79320348,22.54070310,2.9,89
20251104092140,107.79321140,22.54070306,2.9,90
20251104092141,107.79321925,22.54070295,2.9,89
20251104092142,107.79322721,22.54070293,2.8,88
20251104092143,107.79323513,22.54070293,3,88
20251104092144,107.79324306,22.54070303,3,88
20251104092145,107.79325089,22.54070305,2.8,90
20251104092146,107.79325881,22.54070313,2.9,90
20251104092147,107.79326670,22.54070300,2.8,89
20251104092148,107.79327460,22.54070290,2.8,90
20251104092149,107.79328249,22.54070288,2.9,90
20251104092150,107.79329045,22.54070286,2.9,87
20251104092151,107.79329830,22.54070285,3,88
20251104092152,107.79330631,22.54070288,2.9,89
20251104092153,107.79331424,22.54070281,2.9,90
20251104092154,107.79332213,22.54070270,2.9,90
20251104092155,107.79333005,22.54070265,2.9,91
20251104092156,107.79333790,22.54070266,2.8,88
20251104092157,107.79334580,22.54070268,2.9,90
20251104092158,107.79335371,22.54070273,3,89
20251104092159,107.79336161,22.54070275,2.8,90
20251104092200,107.79336951,22.54070268,3,89
20251104092201,107.79337744,22.54070260,3,90
20251104092202,107.79338536,22.54070256,3,90</textarea>
            <div class="button-group">
                <button id="drawTrackButton" disabled style="flex: 1;">绘制轨迹</button>
                <button id="showTrackPointsButton" disabled style="flex: 1;" class="btn-warning">打点</button>
                <button id="clearTrackButton" disabled style="flex: 1;">清空轨迹</button>
            </div>
            <!-- 回放控制 -->
            <div class="split-section" style="margin-top:8px;">
                <div class="title">轨迹回放</div>
                <div class="playback-actions" style="display:flex;gap:8px;margin-bottom:8px;">
                    <button id="playbackStartBtn" disabled>开始</button>
                    <button id="playbackPauseBtn" disabled>继续</button>
                    <button id="playbackStopBtn" disabled>结束</button>
                </div>
                <div class="playback-speed" style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                    <label>速度：
                        <select id="playbackSpeedSelect" disabled>
                            <option value="1" selected>1×</option>
                            <option value="2">2×</option>
                            <option value="4">4×</option>
                            <option value="8">8×</option>
                            <option value="16">16×</option>
                            <option value="32">32×</option>
                            <option value="64">64×</option>
                            <option value="128">128×</option>
                            <option value="256">256×</option>
                            <option value="512">512×</option>
                            <option value="1024">1024×</option>
                        </select>
                    </label>
                    <span id="playbackTimeLabel" style="font-size:12px;color:#666;">时间：—</span>
                </div>
                <div class="playback-time" style="display:flex;flex-direction:column;gap:4px;margin-bottom:8px;">
                    <label class="playback-time-label" style="display:flex;align-items:center;gap:8px;flex:1 1 auto;min-width:0;">
                        <span class="playback-time-text" style="white-space:nowrap;">起始时间：</span>
                        <input type="range" id="playbackTimeSlider" disabled min="0" max="0" step="1000" value="0" style="flex:1 1 auto;min-width:0;max-width:100%;vertical-align:middle;">
                    </label>
                    <span id="playbackTimeCursor" style="font-size:12px;color:#666;align-self:flex-end;">—</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let map;
    let currentPolygons = []; // 存储多边形和其标签
    let currentTracks = []; // 存储轨迹折线及相关覆盖物
    let mapLoaded = false;
    let mapLabelHandlers = []; // 存储地图事件处理器
    let labelsEnabled = false; // 标签显示开关（默认关闭）
    let isDrawing = false; // 绘制进行中防止重复点击

    window.onload = function () {
        if (typeof T === 'undefined') {
            alert("天地图API加载失败，请检查网络或密钥！");
            return;
        }
        initMap();
        bindDrawEvent();
        bindMinimizeEvent();
        bindTabs();
        bindBatchGenerator();
        bindMultiSplitter();
        bindLabelsToggle(); // 绑定标签显示开关
        bindTrackEvents();  // 绑定轨迹绘制与清空
        bindPlaybackControls(); // 绑定轨迹回放
    };

    function initMap() {
        showLoading();
        disableButtons(true);

        try {
            map = new T.Map("mapContainer", {
                zoom: 12,
                center: new T.LngLat(116.40769, 39.90403)
            });

            // 已移除测试标签
            map.enableScrollWheelZoom();

            // 添加地图类型控件
            const mapTypeCtrl = new T.Control.MapType({
                mapTypes: [TMAP_NORMAL_MAP, TMAP_SATELLITE_MAP, TMAP_TERRAIN_MAP],
                position: T_ANCHOR_TOP_LEFT
            });
            map.addControl(mapTypeCtrl);

            // 加载影像底图（卫星）
            const tk = "648f621977051d0199ff0f965d3fd322";

            // 方案1：使用默认地图类型（作为备选）
            map.setMapType(TMAP_SATELLITE_MAP);

            // 方案2：手动添加影像图层（底图 + 标注）
            const vecLayer = new T.TileLayer(`https://t0.tianditu.gov.cn/img_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=img&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`);
            const cvaLayer = new T.TileLayer(`https://t0.tianditu.gov.cn/cia_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cia&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`);

            // 添加图层并监听加载状态
            vecLayer.addEventListener("load", function () {
                console.log("影像底图加载完成");
            });

            vecLayer.addEventListener("error", function (e) {
                console.error("影像底图加载错误:", e);
                alert("影像底图加载错误，将使用默认地图类型");
            });

            map.addLayer(vecLayer);
            map.addLayer(cvaLayer);

            // 监听地图加载事件
            map.addEventListener("loaded", function () {
                console.log("地图加载完成");
                markMapLoaded();
            });
            map.addEventListener("load", function () {
                console.log("地图load事件触发");
                markMapLoaded();
            });
            map.addEventListener("tilesloaded", function () {
                console.log("地图瓦片加载完成");
                markMapLoaded();
            });
            // 监听地图加载失败事件
            map.addEventListener("error", function (e) {
                console.error("地图加载错误:", e);
                alert("地图加载错误: " + e.message);
                hideLoading();
            });

            // 监听地图移动事件，用于更新标签位置
            const moveHandler = function () {
                updateAllLabelsPosition();
            };
            map.addEventListener("move", moveHandler);
            map.addEventListener("zoom", moveHandler);

            // 存储事件处理器，用于清理
            mapLabelHandlers.push({ event: "move", handler: moveHandler });
            mapLabelHandlers.push({ event: "zoom", handler: moveHandler });

            // 超时容错
            setTimeout(() => {
                if (!mapLoaded) markMapLoaded();
            }, 8000);

        } catch (error) {
            alert("地图初始化失败：" + error.message);
            console.error(error);
            hideLoading();
        }
    }

    function markMapLoaded() {
        if (!mapLoaded) {
            mapLoaded = true;
            hideLoading();
            disableButtons(false);
            disableTrackButtons(false);
            // 仅开启速度选择，回放按钮按状态控制
            const speedSel = document.getElementById('playbackSpeedSelect');
            if (speedSel) speedSel.disabled = false;
            updatePlaybackButtonsState('idle');
        }
    }

    function showLoading() {
        const loading = document.getElementById("mapLoading");
        loading.style.display = "flex";
        loading.style.opacity = "1";
    }

    function hideLoading() {
        const loading = document.getElementById("mapLoading");
        loading.style.opacity = "0";
        setTimeout(() => loading.style.display = "none", 300);
    }

    function disableButtons(disabled) {
        document.getElementById("drawButton").disabled = disabled;
        document.getElementById("clearButton").disabled = disabled;
    }

    function disableTrackButtons(disabled) {
        const drawTrackBtn = document.getElementById("drawTrackButton");
        const showTrackPointsBtn = document.getElementById("showTrackPointsButton");
        const clearTrackBtn = document.getElementById("clearTrackButton");
        if (drawTrackBtn) drawTrackBtn.disabled = disabled;
        if (showTrackPointsBtn) showTrackPointsBtn.disabled = disabled;
        if (clearTrackBtn) clearTrackBtn.disabled = disabled;
    }
    // 回放控件的禁用/启用
    function disablePlaybackButtons(disabled) {
        ["playbackStartBtn","playbackPauseBtn","playbackStopBtn","playbackSpeedSelect","playbackTimeSlider"].forEach(id=>{
            const el = document.getElementById(id);
            if (el) el.disabled = disabled;
        });
    }

    // 回放按钮状态管理：空闲/播放/暂停
    function updatePlaybackButtonsState(state){
        try {
            const startBtn = document.getElementById('playbackStartBtn');
            const pauseBtn = document.getElementById('playbackPauseBtn');
            const stopBtn = document.getElementById('playbackStopBtn');
            if (!startBtn || !pauseBtn || !stopBtn) return;
            if (state === 'idle') {
                startBtn.disabled = false;
                pauseBtn.disabled = true;
                stopBtn.disabled = true;
                pauseBtn.textContent = '继续';
            } else if (state === 'playing') {
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
                pauseBtn.textContent = '暂停';
            } else if (state === 'paused') {
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
                pauseBtn.textContent = '继续';
            }
        } catch(e) { console.warn('更新按钮状态失败:', e); }
    }

    function bindDrawEvent() {
        document.getElementById("drawButton").addEventListener("click", function () {
            if (isDrawing) { console.log('绘制进行中，忽略重复点击'); return; }
            isDrawing = true;
            disableButtons(true);
            showLoading();
            try {
                const wktStr = document.getElementById("wktTextarea").value.trim();
                if (!wktStr) { alert("请输入WKT字符串！"); return; }
                clearOverlays();
                const geojson = parseWkt(wktStr);
    
                const polygonData = [];
                if (geojson.type === "Polygon") {
                    polygonData.push({ index: 1, coordinates: geojson.coordinates });
                } else if (geojson.type === "MultiPolygon") {
                    geojson.coordinates.forEach((polygon, index) => {
                        polygonData.push({ index: index + 1, coordinates: polygon });
                    });
                }
    
                // 重置并绘制
                polygonInfoList = [];
                polygonData.forEach(pd => processPolygon(pd.index, pd.coordinates));
    
                // 视图居中到所有已绘制轮廓
                try { fitViewportToPolygons(); } catch (e) { console.warn('视图居中失败', e); }
    
                // 在视图稳定后再创建/更新标签
                setTimeout(() => {
                    if (labelsEnabled) {
                        try {
                            createAllLabels();
                            updateAllLabelsPosition();
                        } catch (e) {
                            console.warn('创建或更新标签失败:', e);
                        }
                    }
                }, 150);
            } catch (e) {
                alert('绘制失败：' + (e && e.message ? e.message : e));
                console.error('绘制异常:', e);
            } finally {
                hideLoading();
                isDrawing = false;
                disableButtons(false);
            }
        });

        document.getElementById("clearButton").addEventListener("click", function () {
            if (isDrawing) { console.log('绘制进行中，暂不清空'); return; }
            clearOverlays();
            console.log("已清空所有轮廓");
        });
    }

    // 存储多边形数据，用于后续标签创建
    let polygonInfoList = [];

    // 处理单个多边形的绘制和面积计算
    function processPolygon(actualPolygonIndex, polygonCoords) {
        console.log('开始处理多边形', actualPolygonIndex);

        // 坐标系选择（绘制始终使用WGS84坐标）
        const coordSys = (document.getElementById('coordSysSelect') && document.getElementById('coordSysSelect').value) || 'wgs84';

        // 统一转换为WGS84用于绘制与面积计算
        function toWgs(point){
            const lng = point[0], lat = point[1];
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                return [lng, lat];
            } else if (coordSys === 'gcj02') {
                const w = gcj02ToWgs84(lng, lat);
                return [w.lng, w.lat];
            } else if (coordSys === 'bd09') {
                const gcj = bd09ToGcj02(lng, lat);
                const w = gcj02ToWgs84(gcj.lng, gcj.lat);
                return [w.lng, w.lat];
            }
            return [lng, lat];
        }
        const coordsWGS84 = polygonCoords.map(ring => ring.map(toWgs));
        let outerRingWGS = coordsWGS84[0] || [];

        // 生成用于绘制的坐标（直接使用WGS84坐标）
        const rings = coordsWGS84.map(ring => ring.map(([lng, lat]) => new T.LngLat(lng, lat)));


         // 创建半透明填充的多边形（无边框）
          const polygon = new T.Polygon(rings, {
              color: "#FFD700",
              weight: 1,
              opacity: 1,
              fillColor: "#FFFF00",
              fillOpacity: 0.35
          });
 
          // 使用WGS84坐标计算面积（更准确的面积计算）
         let areaSqm;
         let areaMu;



         try {
             // 检查Turf.js是否可用
             if (typeof turf !== 'undefined' && turf.area) {
                 // 使用Turf.js计算多边形面积
                // 构造GeoJSON格式的多边形
                const geoJsonPolygon = {
                    type: "Polygon",
                    coordinates: coordsWGS84
                };


                 // 使用Turf.js计算面积（平方米）
                 areaSqm = turf.area(geoJsonPolygon);
                 areaMu = (areaSqm / 666.6667).toFixed(4); // 转换为亩
                 console.log(`多边形${actualPolygonIndex}面积计算结果(Turf.js): ${areaSqm}平方米 = ${areaMu}亩`);
             } else {
                 // 如果Turf.js不可用，回退到之前的计算方法
                 console.warn('Turf.js不可用，使用备用计算方法');
                 // 计算带孔洞的多边形面积
                 areaSqm = 0;
                 // 计算外环面积
                 outerRingWGS = coordsWGS84[0] || [];
                 areaSqm += calculatePolygonArea(outerRingWGS);

                 // 减去内环（孔洞）面积
                 for (let i = 1; i < coordsWGS84.length; i++) {
                     const innerRingArea = calculatePolygonArea(coordsWGS84[i]);
                     areaSqm -= innerRingArea;
                 }

                  areaMu = (areaSqm / 666.6667).toFixed(4); // 使用更精确的转换系数
                  console.log(`多边形${actualPolygonIndex}面积计算结果(备用): ${areaSqm}平方米 = ${areaMu}亩`);
              }
          } catch (error) {
              console.error(`面积计算失败:`, error);
              areaSqm = 0;
              areaMu = '0.0000';
          }

          // 计算多边形的中心点和底部中心点（WGS84）
          const centerPoint = calculatePolygonCenter(outerRingWGS);
          const bottomCenterPoint = calculatePolygonBottomCenter(outerRingWGS);

          // 添加多边形到地图
          if (map) {
              map.addOverLay(polygon);
              console.log(`多边形${actualPolygonIndex}已添加到地图`);
          } else {
              console.error('地图对象不存在');
          }

          // 存储多边形信息，用于后续标签创建
          polygonInfoList.push({
              index: actualPolygonIndex,
              polygon: polygon,
              area: areaMu,
              bottomCenter: { lng: bottomCenterPoint.lng, lat: bottomCenterPoint.lat },
              ringPoints: rings
          });
      }

    // 视图居中：根据已绘制的GCJ-02点
    function fitViewportToPolygons() {
        const points = [];
        try {
            if (!map || !map.setViewport) return;
            polygonInfoList.forEach(info => {
                if (!info || !info.ringPoints) return;
                info.ringPoints.forEach(ring => {
                    ring.forEach(ll => points.push(ll));
                });
            });
            if (!points.length) return;
            map.setViewport(points);
        } catch (e) {
            try {
                const lngs = points.map(p => p.lng);
                const lats = points.map(p => p.lat);
                const center = new T.LngLat(
                    (Math.min(...lngs) + Math.max(...lngs)) / 2,
                    (Math.min(...lats) + Math.max(...lats)) / 2
                );
                if (map && map.panTo) map.panTo(center);
            } catch (e2) {
                console.warn('视图居中失败:', e2);
            }
        }
    }

    // 统一创建所有多边形的标签
    function createAllLabels() {
        const mapContainer = document.getElementById('mapContainer');
        if (!mapContainer || !map) return;

        polygonInfoList.forEach(info => {
            if (!info) return;
            // 防止重复创建
            if (info.labelRef) return;
            // 创建标签元素
            const labelDiv = document.createElement('div');
            labelDiv.className = 'area-label';
            labelDiv.innerHTML = `多边形${info.index}：${info.area}亩`;

            // 添加到地图容器并根据屏幕边界定位到轮廓下方
            mapContainer.appendChild(labelDiv);
            positionLabelForPolygon(labelDiv, info);

            // 记录引用，避免重复创建
            info.labelRef = labelDiv;

            // 存储到 currentPolygons 以复用现有定位/清理逻辑
            const labelObj = {
                domElement: labelDiv,
                isDomLabel: true,
                polygonInfo: info
            };
            currentPolygons.push({ polygon: info.polygon, label: labelObj });
        });

        // 不清空 polygonInfoList，便于开关随时创建/隐藏标签
    }

    // 根据多边形屏幕边界定位标签，保证始终在轮廓下方
    function positionLabelForPolygon(labelDiv, info) {
        if (!map || !info || !info.ringPoints) return;
        const points = [];
        info.ringPoints.forEach(ring => {
            ring.forEach(ll => {
                const p = map.lngLatToContainerPoint(ll);
                points.push(p);
            });
        });
        if (!points.length) return;
        const minX = Math.min(...points.map(p => p.x));
        const maxX = Math.max(...points.map(p => p.x));
        const maxY = Math.max(...points.map(p => p.y));
        const container = document.getElementById('mapContainer');
        const labelWidth = labelDiv.offsetWidth;
        const labelHeight = labelDiv.offsetHeight;
        const targetLeft = Math.round((minX + maxX) / 2 - labelWidth / 2);
        const targetTop = Math.round(maxY + 6);
        const clampedLeft = Math.max(0, Math.min(targetLeft, container.clientWidth - labelWidth));
        const clampedTop = Math.max(0, Math.min(targetTop, container.clientHeight - labelHeight));
        labelDiv.style.left = clampedLeft + 'px';
        labelDiv.style.top = clampedTop + 'px';
    }

    // 更新所有标签位置（地图move/zoom时调用）
    function updateAllLabelsPosition() {
        try {
            if (!map) return;
            const container = document.getElementById('mapContainer');
            if (!container) return;
            currentPolygons.forEach(item => {
                if (!item || !item.label) return;
                const labelObj = item.label;
                if (labelObj.isDomLabel && labelObj.domElement && labelObj.polygonInfo) {
                    // 确保标签在容器中
                    if (!labelObj.domElement.parentNode) {
                        container.appendChild(labelObj.domElement);
                    }
                    positionLabelForPolygon(labelObj.domElement, labelObj.polygonInfo);
                }
            });
        } catch (e) {
            console.warn('更新标签位置时出错:', e);
        }
    }
    // 确保在全局可用（处理第三方库事件回调作用域差异）
    window.updateAllLabelsPosition = updateAllLabelsPosition;

    // 绑定“显示亩数标签”开关（默认隐藏）
    function bindLabelsToggle() {
        const cb = document.getElementById('toggleLabelsCheckbox');
        const container = document.getElementById('mapContainer');
        if (!cb || !container) return;
        // 默认隐藏标签
        container.classList.add('labels-hidden');
        cb.addEventListener('change', () => {
            labelsEnabled = cb.checked;
            if (labelsEnabled) {
                container.classList.remove('labels-hidden');
                const hasAnyLabel = currentPolygons.some(item => item && item.label && item.label.domElement);
                if (!hasAnyLabel) {
                    try { createAllLabels(); } catch (e) { console.warn('创建标签失败:', e); }
                }
                updateAllLabelsPosition();
            } else {
                container.classList.add('labels-hidden');
            }
        });
    }

    /**
     * 计算多边形中心点（比底部中心更适合显示标签）
     */
    function calculatePolygonCenter(outerRing) {
        let sumLng = 0, sumLat = 0;
        const len = outerRing.length;

        for (let i = 0; i < len; i++) {
            sumLng += outerRing[i][0];
            sumLat += outerRing[i][1];
        }

        return {
            lng: sumLng / len,
            lat: sumLat / len
        };
    }

    /**
     * 计算多边形面积（球面多边形面积计算）
     * 使用更准确的球面坐标面积计算方法，确保面积与视觉大小一致
     */
    function calculatePolygonArea(coordinates) {
        // 地球半径（米）- 使用更精确的值
        const R = 6371000.8;
        const n = coordinates.length;

        // 将所有坐标转换为弧度
        const coordsRad = coordinates.map(point => [
            point[0] * Math.PI / 180,
            point[1] * Math.PI / 180
        ]);

        let areaRad = 0;

        // 使用更准确的球面多边形面积公式（Girard定理）
        for (let i = 0; i < n; i++) {
            const j = (i + 1) % n;
            const lon1 = coordsRad[i][0];
            const lat1 = coordsRad[i][1];
            const lon2 = coordsRad[j][0];
            const lat2 = coordsRad[j][1];

            // 计算球面多边形面积增量
            const dlon = lon2 - lon1;
            const sinLat1 = Math.sin(lat1);
            const sinLat2 = Math.sin(lat2);
            const cosLat1 = Math.cos(lat1);
            const cosLat2 = Math.cos(lat2);

            // 使用更精确的公式
            areaRad += dlon * (sinLat1 * cosLat2 * Math.cos(dlon / 2) + sinLat2 * cosLat1);
        }

        // 计算总面积（平方米）
        const areaSqm = Math.abs(areaRad) * R * R * 0.5;

        return areaSqm;
    }

    /**
     * 清空所有多边形和标签（同时处理 polygonInfoList 与 currentPolygons）
     */
    function clearOverlays() {
        try {
            // 先移除 polygonInfoList 中记录的多边形与其DOM标签
            polygonInfoList.forEach(info => {
                if (info && info.polygon && map && map.removeOverLay) {
                    try { map.removeOverLay(info.polygon); } catch (e) { console.warn('移除多边形失败:', e); }
                }
                if (info && info.labelRef && info.labelRef.parentNode) {
                    try { info.labelRef.parentNode.removeChild(info.labelRef); } catch (e) { console.warn('移除DOM标签失败:', e); }
                    info.labelRef = null;
                }
            });

            // 再处理 currentPolygons（兼容旧路径与标签对象）
            currentPolygons.forEach(item => {
                if (item.polygon && map && map.removeOverLay) {
                    try { map.removeOverLay(item.polygon); } catch (e) { console.warn('移除多边形失败:', e); }
                }
                if (item.label) {
                    if (item.label.domElement && item.label.domElement.parentNode) {
                        try { item.label.domElement.parentNode.removeChild(item.label.domElement); } catch (e) { console.warn('移除DOM标签失败:', e); }
                    } else if (map && map.removeOverLay && !item.label.isDomLabel) {
                        try { map.removeOverLay(item.label); } catch (e) { console.warn('移除地图覆盖物标签失败:', e); }
                    }
                }
            });

            // 清空记录数组
            currentPolygons = [];
            polygonInfoList = [];

            console.log('已清空所有多边形和标签（保留事件监听器）');
        } catch (error) {
            console.error('清空覆盖物时出错:', error);
        }
    }

    // 其他辅助函数（保持不变）
    function bindMinimizeEvent() {
        const container = document.querySelector(".wkt-input-container");
        const btn = document.getElementById("minimizeBtn");
        const minIcon = btn?.querySelector(".min-icon");
        const restoreIcon = btn?.querySelector(".restore-icon");

        btn?.addEventListener("click", () => {
            const minimized = container.classList.toggle("minimized");
            if (minIcon && restoreIcon) {
                if (minimized) {
                    minIcon.style.display = "none";
                    restoreIcon.style.display = "";
                } else {
                    minIcon.style.display = "";
                    restoreIcon.style.display = "none";
                }
            }
        });
    }

    // 在脚本内部补充：页签切换（3个页签）
     function bindTabs() {
         const tabs = [
             { btn: document.getElementById('tabDrawBtn'), pane: document.getElementById('tabDraw'), key: 'draw' },
             { btn: document.getElementById('tabTrackBtn'), pane: document.getElementById('tabTrack'), key: 'track' },
             { btn: document.getElementById('tabSplitBtn'), pane: document.getElementById('tabSplit'), key: 'split' },
             { btn: document.getElementById('tabBatchBtn'), pane: document.getElementById('tabBatch'), key: 'batch' },
         ];
         if (tabs.some(t => !t.btn || !t.pane)) return;
         function activate(key) {
             tabs.forEach(t => {
                 const active = t.key === key;
                 t.btn.classList.toggle('active', active);
                 t.pane.classList.toggle('active', active);
             });
         }
         tabs.forEach(t => t.btn.addEventListener('click', () => activate(t.key)));
         activate('draw');
     }
    function updateParserStatus() {
        const el = document.getElementById('parserStatus');
        if (!el) return;
        const ok = (typeof Terraformer !== 'undefined' && Terraformer.WKT && typeof Terraformer.WKT.parse === 'function');
        if (ok) {
            el.textContent = 'Terraformer WKT Parser';
            el.style.color = '#2f8f2f';
        } else {
            el.textContent = '本地回退解析（仅支持POLYGON/MULTIPOLYGON）';
            el.style.color = '#c77d1e';
        }
    }
     function parseWkt(wkt) {
         wkt = wkt.trim();
         // 优先使用成熟库（Terraformer WKT Parser）
         if (typeof Terraformer !== 'undefined' && Terraformer.WKT && Terraformer.WKT.parse) {
             try {
                 return Terraformer.WKT.parse(wkt);
             } catch (e) {
                 console.warn('Terraformer解析失败，尝试本地回退解析:', e);
             }
         } else {
             // 不再提示“未加载”，由状态栏展示回退信息
         }
         // 回退解析：仅支持 POLYGON / MULTIPOLYGON
         const typeMatch = wkt.match(/^\s*(POLYGON|MULTIPOLYGON)\s*\(/i);
         if (!typeMatch) throw new Error('仅支持POLYGON/MULTIPOLYGON');
         const type = typeMatch[1].toUpperCase();
         const inner = wkt.substring(wkt.indexOf('('));
         if (type === 'POLYGON') {
             const coords = parsePolygonCoords(inner.replace(/^\(/, '').replace(/\)$/, ''));
             return { type: 'Polygon', coordinates: coords };
         } else {
             const trimmed = inner.replace(/^\(\(/, '').replace(/\)\)$/, '');
             const coords = parseMultiPolygonCoords(trimmed);
             return { type: 'MultiPolygon', coordinates: coords };
         }
     }

     function bindMultiSplitter() {
         const input = document.getElementById('multiInput');
         const output = document.getElementById('polyOutput');
         const splitBtn = document.getElementById('splitMultiBtn');
         const copyBtn = document.getElementById('copyPolysBtn');
         if (!input || !output || !splitBtn || !copyBtn) return;

         // 本地WKT序列化辅助
         function ringToText(ring) {
             if (!ring || !ring.length) return '()';
             const first = ring[0];
             const last = ring[ring.length - 1];
             const closed = (first[0] === last[0] && first[1] === last[1]) ? ring : ring.concat([[first[0], first[1]]]);
             return '(' + closed.map(pt => pt[0] + ' ' + pt[1]).join(', ') + ')';
         }
         function toWktPolygonCoords(coords) {
             return 'POLYGON(' + coords.map(ringToText).join(', ') + ')';
         }
         function toWktMulti(coords) {
             return 'MULTIPOLYGON(' + coords.map(poly => '(' + poly.map(ringToText).join(', ') + ')').join(', ') + ')';
         }

         function polygonsFromMulti(text) {
             const geo = parseWkt(text.trim());
             if (geo.type !== 'MultiPolygon') throw new Error('请输入有效的 MULTIPOLYGON WKT');
             const polys = geo.coordinates.map(rings => toWktPolygonCoords(rings));
             return polys;
         }
         splitBtn.addEventListener('click', () => {
             try {
                 const list = polygonsFromMulti(input.value.trim());
                 output.value = list.join('\n');
             } catch (e) {
                 alert('分割失败：' + e.message);
             }
         });
         copyBtn.addEventListener('click', async () => {
             const val = output.value.trim();
             if (!val) { alert('没有可复制的结果'); return; }
             try { await navigator.clipboard.writeText(val); alert('已复制到剪贴板'); } catch (e) { console.warn('复制失败', e); }
         });
     }

     function bindBatchGenerator() {
         const batchInput = document.getElementById('batchInput');
         const output = document.getElementById('multiOutput');
         const genBtn = document.getElementById('generateMultiBtn');
         const copyBtn = document.getElementById('copyMultiBtn');

         // 本地WKT序列化辅助（与分割器保持一致）
         function ringToText(ring) {
             if (!ring || !ring.length) return '()';
             const first = ring[0];
             const last = ring[ring.length - 1];
             const closed = (first[0] === last[0] && first[1] === last[1]) ? ring : ring.concat([[first[0], first[1]]]);
             return '(' + closed.map(pt => pt[0] + ' ' + pt[1]).join(', ') + ')';
         }
         function toWktMulti(coords) {
             return 'MULTIPOLYGON(' + coords.map(poly => '(' + poly.map(ringToText).join(', ') + ')').join(', ') + ')';
         }

         genBtn.addEventListener('click', () => {
             try {
                 const lines = batchInput.value.trim().split(/\n|;/).map(s => s.trim()).filter(Boolean);
                 if (lines.length === 0) throw new Error('请按每行或分号输入至少一个POLYGON');
                 const polygons = lines.map((line, idx) => {
                     const g = parseWkt(line);
                     if (g.type !== 'Polygon') throw new Error(`第${idx + 1}行不是有效的POLYGON WKT`);
                     return g;
                 });
                 const multiGeo = { type: 'MultiPolygon', coordinates: polygons.map(p => p.coordinates) };
                 output.value = toWktMulti(multiGeo.coordinates);
             } catch (e) {
                 alert('生成失败：' + e.message);
             }
         });

         copyBtn.addEventListener('click', async () => {
             const val = output.value.trim();
             if (!val) { alert('没有可复制的结果'); return; }
             try { await navigator.clipboard.writeText(val); alert('已复制到剪贴板'); } catch (e) { console.warn('复制失败', e); }
         });

     }

     function setExampleWkt() {
         const exampleWkt = "MULTIPOLYGON(" +
             "(" +
             "(116.35 39.93, 116.39 39.93, 116.39 39.90, 116.35 39.90, 116.35 39.93)," + // 外环
             "(116.36 39.92, 116.38 39.92, 116.38 39.91, 116.36 39.91, 116.36 39.92)" +  // 内环
             ")," +
             "(" +
             "(116.40 39.95, 116.43 39.97, 116.46 39.96, 116.49 39.98, 116.52 39.95, 116.55 39.93, 116.58 39.94, 116.61 39.92, 116.64 39.95, 116.40 39.95)" +
             ")" +
             ")";
         document.getElementById("wktTextarea").value = exampleWkt;
     }

     function parsePolygonCoords(coordStr) {
         const ringStrs = coordStr.split(/\)\s*,\s*\(/).map(s => s.replace(/[()]/g, '').trim());
         const rings = [];
         ringStrs.forEach(ringStr => {
             const pts = ringStr.split(/,\s*/).map(pointStr => {
                 const [lng, lat] = pointStr.split(/\s+/).map(Number);
                 if (isNaN(lng) || isNaN(lat)) throw new Error("坐标格式错误：" + pointStr);
                 return [lng, lat];
             });
             // 自动拆分：如果一个ring中包含多次回到起点（闭合），则拆分为多个环
             // 兼容用户将外环与内环错误地写在同一对括号中的情况
             let start = 0;
             while (start < pts.length) {
                 const startPt = pts[start];
                 let closeIdx = -1;
                 for (let i = start + 1; i < pts.length; i++) {
                     if (pts[i][0] === startPt[0] && pts[i][1] === startPt[1]) {
                         closeIdx = i;
                         break;
                     }
                 }
                 if (closeIdx === -1) {
                     // 未找到闭合：将剩余点视为一个环，并强制闭合
                     const ring = pts.slice(start);
                     if (ring.length && (ring[0][0] !== ring[ring.length - 1][0] || ring[0][1] !== ring[ring.length - 1][1])) {
                         ring.push([ring[0][0], ring[0][1]]);
                     }
                     rings.push(ring);
                     break;
                 } else {
                     const ring = pts.slice(start, closeIdx + 1);
                     rings.push(ring);
                     start = closeIdx + 1;
                 }
             }
         });
         return rings;
     }

     function parseMultiPolygonCoords(coordStr) {
         const polygonStrs = coordStr.split(/\)\s*\)\s*,\s*\(\s*\(/).map(s => s.replace(/[()]/g, '').trim());
         return polygonStrs.map(polygonStr => parsePolygonCoords(polygonStr));
     }

     function wgs84ToGcj02(lng, lat) {
         const x_PI = 3.14159265358979324 * 3000.0 / 180.0;
         const PI = 3.1415926535897932384626;
         const a = 6378245.0;
         const ee = 0.00669342162296594323;

         if (outOfChina(lng, lat)) return { lng, lat };

         let dlat = transformLat(lng - 105.0, lat - 35.0);
         let dlng = transformLng(lng - 105.0, lat - 35.0);
         const radlat = lat / 180.0 * PI;
         let magic = Math.sin(radlat);
         magic = 1 - ee * magic * magic;
         const sqrtmagic = Math.sqrt(magic);
         dlat = (dlat * 180.0) / ((a * (1 - ee)) / (magic * sqrtmagic) * PI);
         dlng = (dlng * 180.0) / (a / sqrtmagic * Math.cos(radlat) * PI);

         return { lng: lng + dlng, lat: lat + dlat };

         function outOfChina(lng, lat) {
             return (lng < 72.004 || lng > 137.8347) || (lat < 0.8293 || lat > 55.8271);
         }

         function transformLat(x, y) {
             let ret = -100.0 + 2.0 * x + 3.0 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * Math.sqrt(Math.abs(x));
             ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
             ret += (20.0 * Math.sin(y * PI) + 40.0 * Math.sin(y / 3.0 * PI)) * 2.0 / 3.0;
             ret += (160.0 * Math.sin(y / 12.0 * PI) + 320 * Math.sin(y * PI / 30.0)) * 2.0 / 3.0;
             return ret;
         }

         function transformLng(x, y) {
             let ret = 300.0 + x + 2.0 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * Math.sqrt(Math.abs(x));
             ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
             ret += (20.0 * Math.sin(x * PI) + 40.0 * Math.sin(x / 3.0 * PI)) * 2.0 / 3.0;
             ret += (150.0 * Math.sin(x / 12.0 * PI) + 300.0 * Math.sin(x / 30.0 * PI)) * 2.0 / 3.0;
             return ret;
         }
     }

     function gcj02ToWgs84(lng, lat) {
         const g = wgs84ToGcj02(lng, lat);
         return { lng: lng * 2 - g.lng, lat: lat * 2 - g.lat };
     }

     function bd09ToGcj02(bdLng, bdLat) {
         const x_PI = 3.14159265358979324 * 3000.0 / 180.0;
         const x = bdLng - 0.0065;
         const y = bdLat - 0.006;
         const z = Math.sqrt(x * x + y * y) - 0.00002 * Math.sin(y * x_PI);
         const theta = Math.atan2(y, x) - 0.000003 * Math.cos(x * x_PI);
         const ggLng = z * Math.cos(theta);
         const ggLat = z * Math.sin(theta);
         return { lng: ggLng, lat: ggLat };
     }

     function calculatePolygonBottomCenter(outerRing) {
         let minLat = Infinity;
         let bottomPoints = [];
         outerRing.forEach(point => {
             const lat = point[1];
             if (lat < minLat) {
                 minLat = lat;
                 bottomPoints = [point];
             } else if (lat === minLat) {
                 bottomPoints.push(point);
             }
         });

         const sumLng = bottomPoints.reduce((sum, point) => sum + point[0], 0);
         const centerLng = sumLng / bottomPoints.length;

         return { lng: centerLng, lat: minLat };
     }

     function fitBounds(geojson) {
         try {
             const allPoints = [];
             function collectPoints(coords) {
                 if (typeof coords[0] === 'number') {
                     allPoints.push(coords);
                 } else {
                     coords.forEach(coord => collectPoints(coord));
                 }
             }
             collectPoints(geojson.coordinates);

             if (allPoints.length === 0) return;

             const lats = allPoints.map(p => p[1]);
             const lngs = allPoints.map(p => p[0]);
             const minLng = Math.min(...lngs);
             const maxLng = Math.max(...lngs);
             const minLat = Math.min(...lats);
             const maxLat = Math.max(...lats);

             const sw = wgs84ToGcj02(minLng, minLat);
             const ne = wgs84ToGcj02(maxLng, maxLat);

             // 修复setViewport方法的使用，确保参数格式正确
             if (map && map.setViewport) {
                 map.setViewport([
                     new T.LngLat(sw.lng, sw.lat),
                     new T.LngLat(ne.lng, ne.lat)
                 ], { padding: [50, 50] });
             } else {
                 console.warn('地图对象或setViewport方法不可用');
             }
         } catch (error) {
             console.error('调整视图范围时出错:', error);
         }
     }
// 轨迹绘制与解析
    function bindTrackEvents() {
        const drawBtn = document.getElementById('drawTrackButton');
        const showPointsBtn = document.getElementById('showTrackPointsButton');
        const clearBtn = document.getElementById('clearTrackButton');
        const ta = document.getElementById('trackTextarea');
        if (!drawBtn || !showPointsBtn || !clearBtn || !ta) return;

        drawBtn.addEventListener('click', function(){
            try {
                const text = ta.value.trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const points = parseTrackText(text);
                if (points.length < 2) { alert('有效轨迹点不足，至少需要两点'); return; }
                drawTrackFromPoints(points);
                fitViewportToTrack(points);
            } catch (e) {
                alert('绘制轨迹失败：' + (e && e.message ? e.message : e));
                console.error('绘制轨迹异常:', e);
            }
        });

        showPointsBtn.addEventListener('click', function(){
            try {
                const text = ta.value.trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const points = parseTrackText(text);
                if (points.length === 0) { alert('未找到有效轨迹点'); return; }
                showTrackPoints(points);
                fitViewportToTrack(points);
            } catch (e) {
                alert('显示轨迹点失败：' + (e && e.message ? e.message : e));
                console.error('显示轨迹点异常:', e);
            }
        });

        clearBtn.addEventListener('click', function(){
            clearTrackOverlays();
            console.log('已清空轨迹');
        });
    }

    function showTrackPoints(points) {
        // 先移除旧轨迹（不影响轮廓）
        clearTrackOverlays(false);
        
        if (!map || !points || points.length === 0) {
            console.log('无轨迹点可显示');
            return;
        }
        
        console.log(`准备显示${points.length}个轨迹点`);
        
        // 使用批量处理和更小的图标来提高性能
        // 创建一个更小的红点SVG图标
        const smallRedDotIcon = new T.Icon({
            iconUrl: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1" height="1"><circle cx="0.5" cy="0.5" r="0.3" fill="%23FF0000"/></svg>',
            iconSize: new T.Point(1, 1),
            iconAnchor: new T.Point(0.5, 0.5)
        });
        
        // 优化批量添加点的速度
        const batchSize = 2000; // 增加每批处理的点数
        const concurrentBatches = 4; // 并发批次数量
        
        // 预创建点击事件处理函数，避免重复创建
        function createClickHandler(point, index) {
            return function() {
                const infoWindow = new T.InfoWindow({
                    content: `点${index + 1}<br/>经度: ${point.lng.toFixed(6)}<br/>纬度: ${point.lat.toFixed(6)}`,
                    offset: new T.Point(0, -20)
                });
                infoWindow.open(map, point);
            };
        }
        
        // 使用setTimeout实现更高效的批量添加，避免阻塞UI
        let currentIndex = 0;
        
        function addBatch() {
            if (currentIndex >= points.length) {
                console.log(`已显示${points.length}个轨迹点`);
                return;
            }
            
            // 添加当前批次的点
            const endIndex = Math.min(currentIndex + batchSize, points.length);
            const markersToAdd = [];
            
            // 先创建所有标记
            for (let i = currentIndex; i < endIndex; i++) {
                const point = points[i];
                const index = i;
                
                const marker = new T.Marker(point, {
                    icon: smallRedDotIcon
                });
                
                // 添加点击事件
                marker.addEventListener('click', createClickHandler(point, index));
                
                markersToAdd.push(marker);
            }
            
            // 批量添加到地图和数组
            markersToAdd.forEach(marker => {
                map.addOverLay(marker);
                currentTracks.push(marker);
            });
            
            currentIndex = endIndex;
            
            // 使用setTimeout而不是requestAnimationFrame，减少对渲染周期的依赖
            // 设置为0，将任务放入微任务队列，但允许UI有短暂的呼吸空间
            setTimeout(addBatch, 0);
        }
        
        // 启动批量添加
        addBatch();
    }
    
    // 恢复原始的clearTrackOverlays函数
    function clearTrackOverlays(resetArray = true){        
        try {
            currentTracks.forEach(pl => {
                if (pl && map && map.removeOverLay) {
                    try { map.removeOverLay(pl); } catch (e) { console.warn('移除轨迹失败:', e); }
                }
            });
            if (resetArray) currentTracks = [];
        } catch (e) {
            console.warn('清空轨迹时出错:', e);
        }
    }

    function parseTrackText(text){
        // 选择输入坐标系（优先使用轨迹页签专属选择器，若未设置则回退到绘制页签选择器）
        const coordSysEl = document.getElementById('trackCoordSysSelect') || document.getElementById('coordSysSelect');
        const coordSys = (coordSysEl && coordSysEl.value) || 'wgs84';
        const isHash = text.indexOf('#') !== -1;
        const items = isHash ? text.split('#') : text.split(/\r?\n/);
        const pts = [];
        for (let i=0;i<items.length;i++){
            const raw = items[i];
            if (!raw) continue;
            const line = raw.trim();
            if (!line) continue;
            const parts = line.split(',');
            if (parts.length < 3) continue;
            let lng = parseFloat((parts[isHash ? 0 : 1] || '').trim());
            let lat = parseFloat((parts[isHash ? 1 : 2] || '').trim());
            // 初步过滤：数值合法性与正常范围
            if (!isFinite(lng) || !isFinite(lat)) continue;
            if (lng === 0 || lat === 0) continue; // 丢弃0.0异常点
            if (lng < -180 || lng > 180 || lat < -90 || lat > 90) continue; // 超出经纬度范围丢弃

            // 将输入坐标转换为WGS84
            let w;
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                w = { lng, lat };
            } else if (coordSys === 'gcj02') {
                w = gcj02ToWgs84(lng, lat);
            } else if (coordSys === 'bd09') {
                const g = bd09ToGcj02(lng, lat);
                w = gcj02ToWgs84(g.lng, g.lat);
            } else {
                w = { lng, lat };
            }
            // 转换结果兜底检查
            if (!isFinite(w.lng) || !isFinite(w.lat)) continue;
            if (w.lng < -180 || w.lng > 180 || w.lat < -90 || w.lat > 90) continue;

            // 使用WGS84坐标绘制到地图
            pts.push(new T.LngLat(w.lng, w.lat));
        }
        return pts;
    }

    function drawTrackFromPoints(points){
        // 先移除旧轨迹（不影响轮廓）
        clearTrackOverlays(false);
        const polyline = new T.Polyline(points, {
            color: '#FF3B30',
            weight: 1,
            opacity: 0.9
        });
        if (map) {
            map.addOverLay(polyline);
        }
        currentTracks.push(polyline);
    }

    function clearTrackOverlays(resetArray = true){
        try {
            currentTracks.forEach(pl => {
                if (pl && map && map.removeOverLay) {
                    try { map.removeOverLay(pl); } catch (e) { console.warn('移除轨迹失败:', e); }
                }
            });
            if (resetArray) currentTracks = [];
        } catch (e) {
            console.warn('清空轨迹时出错:', e);
        }
    }


    function fitViewportToTrack(points){
        try {
            if (!map || !map.setViewport || !points || !points.length) return;
            map.setViewport(points);
        } catch (e) {
            console.warn('轨迹视图居中失败:', e);
        }
    }

    // ========= 轨迹回放功能 =========
    let playbackState = { points: [], idx: 0, speed: 1, timer: null, running: false, marker: null, line: null, path: [] };

    function bindPlaybackControls(){
        const startBtn = document.getElementById('playbackStartBtn');
        const pauseBtn = document.getElementById('playbackPauseBtn');
        const stopBtn = document.getElementById('playbackStopBtn');
        const speedSel = document.getElementById('playbackSpeedSelect');
        const timeSlider = document.getElementById('playbackTimeSlider');
        const timeCursor = document.getElementById('playbackTimeCursor');
        const ta = document.getElementById('trackTextarea');
        if (!startBtn || !pauseBtn || !stopBtn || !speedSel) return;

        // 初始按钮状态
        updatePlaybackButtonsState('idle');

        startBtn.addEventListener('click', function(){
            try {
                const text = (ta && ta.value || '').trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const pts = parseTrackTextWithTime(text);
                if (pts.length < 2) { alert('有效轨迹点不足，至少需要两点'); return; }
                startPlayback(pts);
                // 状态在startPlayback中已设置为playing
            } catch (e) {
                alert('开始回放失败：' + (e && e.message ? e.message : e));
                console.error('开始回放异常:', e);
            }
        });

        pauseBtn.addEventListener('click', function(){
            if (!playbackState.running) {
                // 继续
                playbackState.running = true;
                scheduleNext();
                updatePlaybackButtonsState('playing');
            } else {
                // 暂停
                if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
                playbackState.running = false;
                updatePlaybackButtonsState('paused');
            }
        });

        stopBtn.addEventListener('click', function(){ 
            stopPlayback(); 
            updatePlaybackButtonsState('idle');
        });

        speedSel.addEventListener('change', function(){
            const v = parseFloat(speedSel.value);
            playbackState.speed = (isFinite(v) && v > 0) ? v : 1;
        });

        if (timeSlider) {
            timeSlider.addEventListener('input', function(){
                const ms = parseInt(timeSlider.value, 10);
                const txt = formatTimeForLabel(ms);
                if (timeCursor) timeCursor.textContent = txt;
            });
            timeSlider.addEventListener('change', function(){
                jumpToSliderTime();
            });
        }
    }

    function parseTrackTextWithTime(text){
        const coordSysEl = document.getElementById('trackCoordSysSelect') || document.getElementById('coordSysSelect');
        const coordSys = (coordSysEl && coordSysEl.value) || 'wgs84';
        const isHash = text.indexOf('#') !== -1;
        const items = isHash ? text.split('#') : text.split(/\r?\n/);
        const out = [];
        for (let i=0;i<items.length;i++){
            const raw = items[i];
            if (!raw) continue;
            const line = raw.trim();
            if (!line) continue;
            const parts = line.split(',');
            if (parts.length < 3) continue;
            const tsRaw = (parts[isHash ? 2 : 0] || '').trim();
            const ts = (tsRaw || '').replace(/\D/g,'');
            let lng = parseFloat((parts[isHash ? 0 : 1] || '').trim());
            let lat = parseFloat((parts[isHash ? 1 : 2] || '').trim());
            if (!isFinite(lng) || !isFinite(lat)) continue;
            if (lng === 0 || lat === 0) continue;
            if (lng < -180 || lng > 180 || lat < -90 || lat > 90) continue;
            const t = parseTimestamp(ts);
            if (!t) continue;
            let w;
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                w = { lng, lat };
            } else if (coordSys === 'gcj02') {
                w = gcj02ToWgs84(lng, lat);
            } else if (coordSys === 'bd09') {
                const g = bd09ToGcj02(lng, lat);
                w = gcj02ToWgs84(g.lng, g.lat);
            } else { w = { lng, lat }; }
            if (!isFinite(w.lng) || !isFinite(w.lat)) continue;
            if (w.lng < -180 || w.lng > 180 || w.lat < -90 || w.lat > 90) continue;
            out.push({ ll: new T.LngLat(w.lng, w.lat), time: t, ts });
        }
        out.sort((a,b)=>a.time - b.time);
        return out;
    }

    function parseTimestamp(ts){
        const tstr = (ts || '').replace(/\D/g,'');
        const m = tstr && tstr.match(/^\d{14}$/);
        if (!m) return null;
        const y = parseInt(tstr.slice(0,4),10);
        const M = parseInt(tstr.slice(4,6),10) - 1;
        const d = parseInt(tstr.slice(6,8),10);
        const h = parseInt(tstr.slice(8,10),10);
        const m2 = parseInt(tstr.slice(10,12),10);
        const s = parseInt(tstr.slice(12,14),10);
        const dt = new Date(y,M,d,h,m2,s);
        return isNaN(dt.getTime()) ? null : dt;
    }

    function startPlayback(points){
        console.log('[Playback] startPlayback: 点数=', points && points.length);
        stopPlayback();
        playbackState.points = points;
        playbackState.idx = 0;
        playbackState.speed = playbackState.speed || 1;
        playbackState.running = true;
        // 配置时间滑动条，并尊重现有滑块位置作为起始
        configureTimeSlider(points);
        // 启用滑块
        const slider = document.getElementById('playbackTimeSlider');
        if (slider) slider.disabled = false;
        let initIdx = 0;
        if (slider && slider.min && slider.max) {
            const ms = parseInt(slider.value, 10);
            if (isFinite(ms)) initIdx = findIndexByTime(points, ms);
        }
        playbackState.idx = initIdx;
        const first = points[initIdx];
        console.log('[Playback] 首点:', first && first.ts, first && first.ll, 'initIdx=', initIdx);
        playbackState.path = points.slice(0, initIdx+1).map(p=>p.ll);
        playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 1, opacity: 0.9 });
        if (map) {
            map.addOverLay(playbackState.line);
        }
        currentTracks.push(playbackState.line);
        // 创建并定位DOM标记以保证可见移动
        ensurePlaybackDom(first.ll);
        updatePlaybackDom(first.ll);
        updatePlaybackTimeLabel(first.ts);
        try { fitViewportToTrack(points.map(p=>p.ll)); } catch(e){}
        // 更新按钮状态
        updatePlaybackButtonsState('playing');
        scheduleNext();
    }

    function scheduleNext(){
        if (!playbackState.running) return;
        if (!playbackState.points || playbackState.idx >= playbackState.points.length - 1) {
            playbackState.running = false;
            console.log('[Playback] 回放结束：idx=', playbackState.idx, '点数=', playbackState.points ? playbackState.points.length : 0);
            updatePlaybackButtonsState('idle'); // 播放结束后按钮回到初始状态：开始可点，继续/结束灰化
            return;
        }
        const next = playbackState.points[playbackState.idx+1];
        const speed = playbackState.speed || 1;
        const delay = Math.max(4, Math.round(1000 / speed)); // 1x=1000ms/点，2x=500ms/点...
        console.log('[Playback] scheduleNext: idx=', playbackState.idx, '->', playbackState.idx+1, 'delay=', delay, 'speed=', speed);
        playbackState.timer = setTimeout(()=>{
            playbackState.idx++;
            const nextLL = next.ll;
            console.log('[Playback] 下一点:', next && next.ts, nextLL);
            try {
                // 维护路径数组
                playbackState.path = playbackState.path || [];
                playbackState.path.push(nextLL);
                console.log('[Playback] 路径长度=', playbackState.path.length);
                // 使用DOM标记进行移动（容器/图层坐标）
                if (!playbackDom.el) console.log('[Playback] DOM标记不存在，将尝试创建');
                updatePlaybackDom(nextLL);
                // 折线更新：优先setLngLats，兜底重建
                if (playbackState.line && typeof playbackState.line.setLngLats === 'function') {
                    try { playbackState.line.setLngLats(playbackState.path); }
                    catch(e){
                        console.warn('[Playback] setLngLats失败，重建折线', e);
                        if (map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                        playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 1, opacity: 0.9 });
                        if (map) map.addOverLay(playbackState.line);
                    }
                } else {
                    console.log('[Playback] 折线不支持setLngLats，重建');
                    if (playbackState.line && map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                    playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 1, opacity: 0.9 });
                    if (map) map.addOverLay(playbackState.line);
                }
            } catch(e) { console.warn('更新回放覆盖物失败:', e); }
            updatePlaybackTimeLabel(next.ts);
            scheduleNext();
        }, delay);
    }

    function stopPlayback(){
        if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
        playbackState.running = false;
        playbackState.idx = 0;
        try {
            // 移除DOM标记
            removePlaybackDom();
            if (playbackState.marker && map) map.removeOverLay(playbackState.marker);
            if (playbackState.line && map) map.removeOverLay(playbackState.line);
        } catch(e){}
        playbackState.marker = null;
        playbackState.line = null;
        updatePlaybackTimeLabel('—');
        // 按钮回到初始状态
        updatePlaybackButtonsState('idle');
    }

    function updatePlaybackTimeLabel(text){
        const el = document.getElementById('playbackTimeLabel');
        if (el) el.textContent = '时间：' + (text || '—');
    }

    // 时间滑动条：配置与跳转
    function configureTimeSlider(points){
        try {
            const slider = document.getElementById('playbackTimeSlider');
            const cursor = document.getElementById('playbackTimeCursor');
            if (!slider || !points || !points.length) return;
            const minMs = points[0].time.getTime();
            const maxMs = points[points.length - 1].time.getTime();
            const prev = parseInt(slider.value, 10);
            slider.min = String(minMs);
            slider.max = String(maxMs);
            slider.step = '1000'; // 以秒为步进
            let val = (isFinite(prev) && prev >= minMs && prev <= maxMs) ? prev : minMs;
            slider.value = String(val);
            if (cursor) cursor.textContent = formatTimeForLabel(val);
        } catch(e) { console.warn('配置时间滑动条失败:', e); }
    }
    function formatTimeForLabel(ms){
        if (!isFinite(ms)) return '—';
        const d = new Date(ms);
        const pad = n => String(n).padStart(2,'0');
        const y = d.getFullYear();
        const M = pad(d.getMonth()+1);
        const da = pad(d.getDate());
        const h = pad(d.getHours());
        const m = pad(d.getMinutes());
        const s = pad(d.getSeconds());
        return `${y}-${M}-${da} ${h}:${m}:${s}`;
    }
    function findIndexByTime(points, ms){
        try {
            if (!points || !points.length) return 0;
            const n = points.length;
            const minMs = points[0].time.getTime();
            const maxMs = points[n-1].time.getTime();
            if (!isFinite(ms)) return 0;
            if (ms <= minMs) return 0;
            if (ms >= maxMs) return n-1;
            let lo = 0, hi = n - 1, ans = 0;
            while (lo <= hi) {
                const mid = (lo + hi) >> 1;
                const t = points[mid].time.getTime();
                if (t < ms) { lo = mid + 1; ans = lo; }
                else { hi = mid - 1; ans = mid; }
            }
            return Math.max(0, Math.min(n-1, ans));
        } catch(e){ console.warn('findIndexByTime失败:', e); return 0; }
    }
    function jumpToSliderTime(){
        try {
            const slider = document.getElementById('playbackTimeSlider');
            if (!slider || !playbackState.points || !playbackState.points.length) return;
            const ms = parseInt(slider.value, 10);
            if (!isFinite(ms)) return;
            const idx = findIndexByTime(playbackState.points, ms);
            playbackState.idx = idx;
            const pts = playbackState.points;
            const ll = pts[idx].ll;
            playbackState.path = pts.slice(0, idx+1).map(p=>p.ll);
            // 更新折线
            try {
                if (playbackState.line && typeof playbackState.line.setLngLats === 'function') {
                    playbackState.line.setLngLats(playbackState.path);
                } else {
                    if (playbackState.line && map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                    playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 1, opacity: 0.9 });
                    if (map) map.addOverLay(playbackState.line);
                }
            } catch(e){ console.warn('滑块更新折线失败:', e); }
            // 更新标记与时间
            ensurePlaybackDom(ll);
            updatePlaybackDom(ll);
            updatePlaybackTimeLabel(pts[idx].ts);
            // 若正在播放，立即按新位置继续
            if (playbackState.running) {
                if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
                scheduleNext();
            }
        } catch(e) { console.warn('滑块跳转失败:', e); }
    }

    // DOM标记：使用容器坐标实现可见移动
    let playbackDom = { el: null, lastLL: null, bound: false };

    function ensurePlaybackDom(ll){
        try {
            playbackDom.lastLL = ll;
            const pane = (map && map.getPanes && map.getPanes().overlayPane) || document.getElementById('mapContainer');
            if (!pane) { console.warn('未找到overlayPane或mapContainer'); return; }
            if (!playbackDom.el) {
                const el = document.createElement('div');
                el.id = 'playbackDomMarker';
                el.style.position = 'absolute';
                el.style.width = '16px';
                el.style.height = '16px';
                el.style.borderRadius = '50%';
                el.style.background = '#2C64A7';
                el.style.border = '2px solid #fff';
                el.style.boxShadow = '0 0 0 1px rgba(0,0,0,.25)';
                el.style.zIndex = '9999';
                pane.appendChild(el);
                playbackDom.el = el;
                console.log('[Playback] 创建DOM标记，父节点=', pane === document.getElementById('mapContainer') ? '#mapContainer' : 'overlayPane');
                bindPlaybackDomEvents();
            }
            updatePlaybackDom(ll);
        } catch(e) { console.warn('创建DOM标记失败:', e); }
    }

    function updatePlaybackDom(ll){
        try {
            playbackDom.lastLL = ll;
            if (!map || !playbackDom.el || !ll) { console.log('[Playback] update取消：map/el/ll缺失'); return; }
            let p;
            if (typeof map.lngLatToLayerPoint === 'function') {
                p = map.lngLatToLayerPoint(ll);
                console.log('[Playback] 使用layerPoint定位:', ll && ll.lng, ll && ll.lat, '=>', p && p.x, p && p.y);
            } else if (typeof map.lngLatToContainerPoint === 'function') {
                p = map.lngLatToContainerPoint(ll);
                console.log('[Playback] 使用containerPoint定位:', ll && ll.lng, ll && ll.lat, '=>', p && p.x, p && p.y);
            } else {
                console.warn('地图对象不支持lngLat到像素坐标转换');
                return;
            }
            playbackDom.el.style.left = p.x + 'px';
            playbackDom.el.style.top = p.y + 'px';
        } catch(e) { console.warn('更新DOM标记位置失败:', e); }
    }

    function bindPlaybackDomEvents(){
        if (playbackDom.bound) return;
        const updater = function(){
            try {
                if (!map || !playbackDom.el || !playbackDom.lastLL) return;
                let p;
                if (typeof map.lngLatToLayerPoint === 'function') {
                    p = map.lngLatToLayerPoint(playbackDom.lastLL);
                } else if (typeof map.lngLatToContainerPoint === 'function') {
                    p = map.lngLatToContainerPoint(playbackDom.lastLL);
                }
                if (!p) return;
                playbackDom.el.style.left = p.x + 'px';
                playbackDom.el.style.top = p.y + 'px';
            } catch(e){}
        };
        try {
            map.addEventListener('move', updater);
            map.addEventListener('zoom', updater);
            playbackDom.bound = true;
        } catch(e){}
    }

    function removePlaybackDom(){
        try {
            const el = playbackDom.el;
            playbackDom.lastLL = null;
            if (el && el.parentNode) el.parentNode.removeChild(el);
        } catch(e){}
        playbackDom.el = null;
        playbackDom.bound = false;
    }

</script>
</body>

</html>
