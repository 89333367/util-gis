<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>展示轮廓</title>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #mapContainer {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        #mapLoading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
            transition: opacity 0.3s;
        }

        .loading-text {
            font-size: 16px;
            color: #333;
            padding: 10px 20px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .wkt-input-container {
            position: absolute;
            top: 20px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            width: min(400px, 90vw);
            box-sizing: border-box;
            transition: all 0.3s;
        }

        .minimize-btn {
            position: absolute;
            top: -5px;
            right: -4px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #f0f0f0;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #666;
            z-index: 1001;
            transition: background 0.2s;
        }

        .minimize-btn:hover {
            background: #e0e0e0;
        }

        .content-wrapper {
            transition: all 0.3s;
        }

        .wkt-input-container.minimized {
            width: 60px;
            height: 40px;
            padding: 0;
        }

        .wkt-input-container.minimized .content-wrapper {
            display: none;
        }

        .wkt-input-container.minimized .min-icon {
            display: none;
        }

        .wkt-input-container.minimized .restore-icon {
            display: inline;
        }

        #wktTextarea {
            width: 100%;
            height: 120px;
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
            box-sizing: border-box;
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        /* 页签样式 */
        .tabs-header {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .tab-btn {
            flex: 1;
            padding: 6px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            background: #f5f5f5;
            color: #333;
            transition: background 0.2s;
        }
        .tab-btn.active { background: #337AFF; color: #fff; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        /* Multi → Polygons 分割器样式 */
        .split-section {
            margin-top: 10px;
            padding: 10px;
            background: #fafafa;
            border: 1px solid #eee;
            border-radius: 6px;
        }
        .split-section .title {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
        }
        .split-section .desc {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        #multiInput, #polyOutput {
            width: 100%;
            height: 90px;
            margin-bottom: 8px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
            box-sizing: border-box;
        }
        .split-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .split-actions button {
            flex: 1;
            padding: 6px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }
        #splitMultiBtn { background: #337AFF; color: #fff; }
        #splitMultiBtn:hover { background: #2860E0; }
        #copyPolysBtn { background: #f5f5f5; color: #333; }
        #copyPolysBtn:hover { background: #e0e0e0; }
        #drawButton,
        #clearButton,
        #drawTrackButton,
        #clearTrackButton {
            width: 50%;
            padding: 8px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        #drawButton,
        #drawTrackButton {
            background: #337AFF;
            color: white;
        }

        #drawButton:hover,
        #drawTrackButton:hover {
            background: #2860E0;
        }

        #clearButton,
        #clearTrackButton {
            background: #f5f5f5;
            color: #333;
        }

        #clearButton:hover,
        #clearTrackButton:hover {
            background: #e0e0e0;
        }

        #drawButton:disabled,
        #clearButton:disabled,
        #drawTrackButton:disabled,
        #clearTrackButton:disabled {
            background: #e0e0e0;
            color: #999;
            cursor: not-allowed;
        }

        .tip {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .area-label {
             position: absolute;
             background: rgba(255, 0, 0, 0.85);
             border: 1px solid #000;
             border-radius: 3px;
             padding: 4px 6px;
             font-size: 12px;
             color: #fff;
             font-weight: 600;
             box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
             white-space: nowrap;
             z-index: 9999;
             pointer-events: none;
         }
         /* 默认隐藏标签容器下的标签 */
          .labels-hidden .area-label { display: none; }

          /* Batch → Generator 样式 */
          .batch-section { margin-top: 10px; padding: 10px; background: #fafafa; border: 1px solid #eee; border-radius: 6px; }
          .batch-section .title { font-size: 13px; font-weight: 600; color: #333; margin-bottom: 6px; }
          .batch-section .desc { font-size: 12px; color: #666; margin-bottom: 8px; }
          #batchInput, #multiOutput { width: 100%; height: 90px; margin-bottom: 8px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; resize: vertical; box-sizing: border-box; }
          .batch-actions { display: flex; gap: 8px; margin-bottom: 8px; }
          .batch-actions button { flex: 1; padding: 6px 0; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; transition: background 0.2s; }
          #generateMultiBtn { background: #337AFF; color: #fff; }
          #generateMultiBtn:hover { background: #2860E0; }
          #copyMultiBtn { background: #f5f5f5; color: #333; }
          #copyMultiBtn:hover { background: #e0e0e0; }
          
          /* 左侧工具条样式 */
          #leftToolbar {
              position: absolute;
              bottom: 20px;
              left: 20px;
              z-index: 1000;
              background: white;
              border-radius: 4px;
              box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
              padding: 6px 0;
              display: flex;
              flex-direction: column;
              gap: 2px;
              width: 40px;
          }
          
          .toolbar-btn {
              width: 100%;
              padding: 6px 0;
              border: none;
              background: transparent;
              cursor: pointer;
              font-size: 12px;
              color: #333;
              transition: background 0.2s;
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
          }
          
          .toolbar-btn:hover {
              background: #f5f5f5;
          }
          
          .toolbar-btn span {
              font-size: 12px;
              margin-top: 4px;
          }
          
          .toolbar-divider {
            height: 1px;
            background-color: #e0e0e0;
            margin: 2px 4px;
        }
        
        /* 颜色选择器样式 */
        .color-picker-container {
            margin-top: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }
        
        .color-picker-title {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        
        .color-picker-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .color-picker-label {
            font-size: 12px;
            color: #555;
            width: 60px;
            flex-shrink: 0;
        }
        
        .color-picker {
            width: 30px;
            height: 30px;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 8px;
            flex-shrink: 0;
        }
        
        .color-input {
            flex: 1;
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            font-family: monospace;
        }
        
        .opacity-slider-container {
            display: flex;
            align-items: center;
            margin-top: 8px;
        }
        
        .opacity-slider {
            flex: 1;
            margin-right: 8px;
        }
        
        .opacity-value {
            font-size: 12px;
            color: #555;
            width: 40px;
            text-align: right;
        }
    </style>
    <script src="https://api.tianditu.gov.cn/api?v=4.0&tk=9ed3674d01dd7c129ab38e3c38bf651a"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
    <script src="https://lib.baomitu.com/terraformer/1.0.12/terraformer.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://unpkg.com/terraformer-wkt-parser@1.2.1/terraformer-wkt-parser.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- 已移除动态备用加载器 ensureTerraformer：改为仅使用静态脚本标签加载 Terraformer 核心库与 WKT 解析器 -->
    <script>
        // 检查Turf.js是否加载成功
        window.addEventListener('load', function () {
            if (typeof turf === 'undefined') {
                console.warn('Turf.js加载失败，已启用备用面积算法');
            } else {
                console.log('Turf.js加载成功');
            }
        });
    </script>
</head>

<body>
<!-- 左侧工具条 -->
<div id="leftToolbar">
    <button class="toolbar-btn" id="measureDistanceBtn" title="测距">
        <span>测距</span>
    </button>
    <div class="toolbar-divider"></div>
    <button class="toolbar-btn" id="measureAreaBtn" title="测面">
        <span>测面</span>
    </button>
    <div class="toolbar-divider"></div>
    <button class="toolbar-btn" id="mapTypeBtn" title="切换地图类型">
        <span>地图</span>
    </button>
</div>

<div id="mapContainer">
    <div id="mapLoading">
        <div class="loading-text">地图正在加载中...</div>
    </div>
</div>

<div class="wkt-input-container">
    <div class="minimize-btn" id="minimizeBtn">
        <span class="min-icon">−</span>
        <span class="restore-icon" style="display:none;">+</span>
    </div>

    <div class="content-wrapper">
        <div class="tabs-header">
            <button class="tab-btn active" id="tabDrawBtn">轮廓</button>
            <button class="tab-btn" id="tabTrackBtn">轨迹</button>
            <button class="tab-btn" id="tabSplitBtn">分割器</button>
            <button class="tab-btn" id="tabBatchBtn">合并器</button>
        </div>
        <div class="tab-pane active" id="tabDraw">
            <div class="tip">请输入WKT字符串（支持POLYGON/MULTIPOLYGON，支持多行输入，每行一个多边形）：</div>
            <textarea id="wktTextarea">POLYGON ((107.79296373408772 22.54069094138887, 107.79296005345041 22.54069127639061, 107.79295650788939 22.540692253365812, 107.79295322594834 22.54069383689442, 107.79295032661344 22.540695969565885, 107.79294791499973 22.540698574060553, 107.79294607853974 22.54070155595294, 107.79294488381414 22.54070480713501, 107.79294437413756 22.5407082097357, 107.79294456798834 22.54071164039428, 107.79294545833834 22.54071497473275, 107.79294701290829 22.540718091865205, 107.79294885745792 22.540721021731155, 107.79294957708858 22.54072256641754, 107.79295017508247 22.54072432679921, 107.79295057551701 22.54072613487703, 107.79295077416725 22.540727971574995, 107.79295076893715 22.540729817512144, 107.79295055988162 22.54073165321344, 107.79295014920689 22.540733459308356, 107.7929495412459 22.540735216741112, 107.79294874241302 22.540736906969464, 107.79294776113697 22.54073851215922, 107.79294687795502 22.540739663235403, 107.79294272415464 22.54074364469204, 107.79294024076384 22.54074658006944, 107.79293846090714 22.540749927386567, 107.79293746079318 22.54075354332062, 107.79293728324396 22.54075727304733, 107.79293866422998 22.540778823627907, 107.79293970192694 22.540783662707994, 107.79294111248063 22.54078744128153, 107.79294190650363 22.540791254049836, 107.79294189932509 22.540794677154857, 107.79294055525509 22.54080062172714, 107.79294016050126 22.540803512325702, 107.79294027179755 22.540806424255592, 107.79294278936332 22.54082643755368, 107.79294367119242 22.540830094405315, 107.79294534724725 22.540833503155664, 107.79294774522069 22.540836516746705, 107.79295076166106 22.540839005168113, 107.79295426643496 22.540840861066066, 107.79295810834196 22.540842004374664, 107.79296212163688 22.540842385770038, 107.79306315836328 22.54084218962392, 107.79341565178507 22.540841587743287, 107.79341942593656 22.54084123727016, 107.79342305479736 22.540840212115487, 107.79342639997958 22.540838551373845, 107.79342933391395 22.5408363183781, 107.79343174471383 22.54083359828421, 107.79343354044285 22.54083049482375, 107.79343465262042 22.54082712634808, 107.79343503883332 22.540823621314974, 107.7934346843532 22.540820113389877, 107.7934341050283 22.540817336051177, 107.7934339795 22.540813799098718, 107.79343451606901 22.54081053465164, 107.79343584871286 22.540806989886885, 107.79344533712579 22.540789665122862, 107.79344669893506 22.540786448436336, 107.79344737540464 22.540783049546846, 107.79344734170691 22.540779593199595, 107.79344659907882 22.540776206248562, 107.79344517477604 22.540773013000788, 107.79344312107307 22.540770130654032, 107.79344051334435 22.54076766499545, 107.79343744729819 22.54076570651901, 107.79343538145984 22.540764642043687, 107.79343196283568 22.540762208796643, 107.79342945267184 22.540759544797986, 107.7934275556963 22.54075647416921, 107.79342634603834 22.540753116903353, 107.79342587096833 22.540749604193977, 107.7934261490509 22.540746073309393, 107.79342729909997 22.540742228706133, 107.79342826115641 22.540740225029076, 107.7934294401259 22.540736964888442, 107.79342993172907 22.54073355616929, 107.79342971810364 22.54073012272717, 107.7934288070117 22.54072678931591, 107.79342723155773 22.540723677054736, 107.79342504898574 22.540720899027363, 107.79342233859937 22.540718556173175, 107.79341919888023 22.54071673361956, 107.79341574390975 22.540715497588845, 107.79341108483888 22.540714289697334, 107.79340787863002 22.540712844687086, 107.7934050371993 22.540710900677556, 107.79340262430696 22.54070850858304, 107.79340071783692 22.540705744341157, 107.79339874043997 22.540701240103516, 107.79339694951696 22.540698091366515, 107.79339452768782 22.540695330729275, 107.7933915693052 22.540693065744023, 107.79338818962516 22.540691384652742, 107.79338452031752 22.540690352949426, 107.79338070433538 22.54069001082839, 107.79327451851074 22.54069027060841, 107.79296373408772 22.54069094138887))</textarea>
            <div class="coord-settings" style="margin-bottom:8px;font-size:12px;color:#333;">
                <label>WKT坐标系：
                    <select id="coordSysSelect" style="margin-left:6px;">
                        <option value="wgs84" selected>WGS84</option>
                        <option value="gcj02">GCJ-02（国测局）</option>
                        <option value="bd09">BD-09（百度）</option>
                        <option value="cgcs2000">CGCS2000</option>
                    </select>
                </label>
                <!-- 已移除“不进行绘制坐标转换”选项，统一使用WGS84绘制 -->
            </div>

            <div class="button-group">
                <button id="drawButton">绘制轮廓</button>
                <button id="clearButton">清空轮廓</button>
            </div>
            <!-- 显示开关：仅保留显示亩数 -->
            <div class="display-toggles" style="margin-top:8px;font-size:12px;color:#333;">
                <label><input type="checkbox" id="toggleLabelsCheckbox"> 显示亩数</label>
            </div>
        </div>

        <div class="tab-pane" id="tabSplit">
            <!-- MultiPolygon → 多个 Polygon 分割器 -->
            <div class="split-section">
                <div class="title">MultiPolygon → 多个 Polygon 分割器</div>
                <div class="desc">输入一个 MULTIPOLYGON WKT，分割为多行 POLYGON WKT。</div>
                <textarea id="multiInput"></textarea>
                <div class="split-actions">
                    <button id="splitMultiBtn">分割为多个 POLYGON</button>
                    <button id="copyPolysBtn">复制结果</button>
                </div>
                <textarea id="polyOutput" readonly></textarea>
            </div>
        </div>

        <div class="tab-pane" id="tabBatch">
            <!-- 批量POLYGON → MULTIPOLYGON 生成器 -->
            <div class="batch-section">
                <div class="title">批量POLYGON → MULTIPOLYGON 合并器</div>
                <div class="desc">每行一个 POLYGON WKT（或用分号分隔）。生成后可一键填充到上方并绘制。</div>
                <textarea id="batchInput"></textarea>
                <div class="batch-actions">
                    <button id="generateMultiBtn">生成 MULTIPOLYGON</button>
                    <button id="copyMultiBtn">复制结果</button>
                </div>
                <textarea id="multiOutput" readonly></textarea>
            </div>
        </div>
        <div class="tab-pane" id="tabTrack">
            <div class="tip">请粘贴轨迹文本（支持两种格式：1）每行一条：定位时间yyyyMMddHHmmss, 经度, 纬度；2）单行#分隔：经度,纬度,定位时间yyyyMMddHHmmss#经度,纬度,定位时间yyyyMMddHHmmss#…）。</div>
            <div class="coord-settings" style="margin-bottom:8px;font-size:12px;color:#333;">
                <label>轨迹坐标系：
                    <select id="trackCoordSysSelect" style="margin-left:6px;">
                        <option value="wgs84" selected>WGS84</option>
                        <option value="gcj02">GCJ-02（国测局）</option>
                        <option value="bd09">BD-09（百度）</option>
                        <option value="cgcs2000">CGCS2000</option>
                    </select>
                </label>
            </div>
            <div class="time-range-settings" style="margin-bottom:8px;font-size:12px;color:#333;">
                <label>时间范围选取(留空则显示所有轨迹)</label>
                <input type="text" id="timeRangeInput" style="width:100%;margin-top:4px;padding:4px;border:1px solid #ddd;border-radius:4px;font-size:12px;" placeholder="格式：yyyy-MM-ddTHH:mm:ss - yyyy-MM-ddTHH:mm:ss">
            </div>
            <textarea id="trackTextarea" style="width:100%;height:120px;margin-bottom:10px;padding:8px;border:1px solid #ddd;border-radius:4px;font-family:monospace;resize:vertical;box-sizing:border-box;">20251104090717,107.79342390,22.54082890
20251104090718,107.79342385,22.54082890
20251104090719,107.79342386,22.54082888
20251104090720,107.79342388,22.54082890
20251104090721,107.79342385,22.54082890
20251104090722,107.79342388,22.54082890
20251104090723,107.79342390,22.54082888
20251104090724,107.79342388,22.54082890
20251104090725,107.79342386,22.54082888
20251104090726,107.79342385,22.54082890
20251104090727,107.79342383,22.54082890
20251104090728,107.79342385,22.54082890
20251104090729,107.79342381,22.54082890
20251104090730,107.79342383,22.54082890
20251104090731,107.79342383,22.54082888
20251104090732,107.79342381,22.54082891
20251104090733,107.79342381,22.54082891
20251104090734,107.79342381,22.54082891
20251104090735,107.79342381,22.54082890
20251104090736,107.79342380,22.54082891
20251104090737,107.79342380,22.54082893
20251104090738,107.79342380,22.54082891
20251104090739,107.79342380,22.54082893
20251104090740,107.79342380,22.54082893
20251104090741,107.79342381,22.54082893
20251104090742,107.79342380,22.54082891
20251104090743,107.79342380,22.54082893
20251104090744,107.79342380,22.54082891
20251104090745,107.79342378,22.54082893
20251104090746,107.79342378,22.54082893
20251104090747,107.79342380,22.54082891
20251104090748,107.79342378,22.54082893
20251104090749,107.79342380,22.54082891
20251104090750,107.79342380,22.54082891
20251104090751,107.79342376,22.54082893
20251104090752,107.79342378,22.54082893
20251104090753,107.79342380,22.54082891
20251104090754,107.79342378,22.54082890
20251104090755,107.79342380,22.54082890
20251104090756,107.79342376,22.54082893
20251104090757,107.79342378,22.54082893
20251104090758,107.79342371,22.54082893
20251104090759,107.79342370,22.54082893
20251104090800,107.79342373,22.54082891
20251104090801,107.79342371,22.54082893
20251104090802,107.79342370,22.54082895
20251104090803,107.79342371,22.54082895
20251104090804,107.79342360,22.54082891
20251104090805,107.79342356,22.54082895
20251104090806,107.79341820,22.54082895
20251104090807,107.79341276,22.54082896
20251104090808,107.79340720,22.54082896
20251104090809,107.79340166,22.54082898
20251104090810,107.79339613,22.54082893
20251104090811,107.79339058,22.54082890
20251104090812,107.79338506,22.54082898
20251104090813,107.79337946,22.54082896
20251104090814,107.79337391,22.54082908
20251104090815,107.79336838,22.54082910
20251104090816,107.79336281,22.54082913
20251104090817,107.79335726,22.54082905
20251104090818,107.79335170,22.54082905
20251104090819,107.79334613,22.54082903
20251104090820,107.79334061,22.54082898
20251104090821,107.79333508,22.54082903
20251104090822,107.79332958,22.54082906
20251104090823,107.79332400,22.54082908
20251104090824,107.79331845,22.54082906
20251104090825,107.79331288,22.54082908
20251104090826,107.79330730,22.54082908
20251104090827,107.79330181,22.54082911
20251104090828,107.79329623,22.54082916
20251104090829,107.79329073,22.54082910
20251104090830,107.79328518,22.54082916
20251104090831,107.79327966,22.54082915
20251104090832,107.79327413,22.54082916
20251104090833,107.79326855,22.54082915
20251104090834,107.79326303,22.54082913
20251104090835,107.79325746,22.54082913
20251104090836,107.79325193,22.54082915
20251104090837,107.79324631,22.54082915
20251104090838,107.79324083,22.54082915
20251104090839,107.79323530,22.54082913
20251104090840,107.79322976,22.54082916
20251104090841,107.79322420,22.54082925
20251104090842,107.79321863,22.54082928
20251104090843,107.79321308,22.54082928
20251104090844,107.79320746,22.54082931
20251104090845,107.79320191,22.54082928
20251104090846,107.79319633,22.54082935
20251104090847,107.79319076,22.54082933
20251104090848,107.79318533,22.54082938
20251104090849,107.79317981,22.54082936
20251104090850,107.79317428,22.54082946
20251104090851,107.79316876,22.54082941
20251104090852,107.79316319,22.54082945
20251104090853,107.79315761,22.54082946
20251104090854,107.79315198,22.54082941
20251104090855,107.79314641,22.54082941
20251104090856,107.79314086,22.54082943
20251104090857,107.79313535,22.54082940
20251104090858,107.79312980,22.54082940
20251104090859,107.79312430,22.54082948
20251104090900,107.79311878,22.54082943
20251104090901,107.79311318,22.54082941
20251104090903,107.79310208,22.54082955
20251104090905,107.79309091,22.54082946
20251104090906,107.79309091,22.54082946
20251104090907,107.79307986,22.54082955
20251104090908,107.79307430,22.54082955
20251104090909,107.79306873,22.54082953
20251104090910,107.79306316,22.54082956
20251104090911,107.79305764,22.54082953
20251104090912,107.79305211,22.54082955
20251104090913,107.79304653,22.54082956
20251104090914,107.79304106,22.54082960
20251104090915,107.79303556,22.54082958
20251104090917,107.79302450,22.54082961
20251104090918,107.79301890,22.54082963
20251104090919,107.79301333,22.54082965
20251104090920,107.79300775,22.54082966
20251104090921,107.79300215,22.54082968
20251104090922,107.79299661,22.54082970
20251104090923,107.79299110,22.54082968
20251104090924,107.79298551,22.54082966
20251104090925,107.79298000,22.54082965
20251104090926,107.79297450,22.54082968
20251104090927,107.79296890,22.54082973
20251104090928,107.79296351,22.54082971
20251104090930,107.79295880,22.54082976
20251104090931,107.79295870,22.54082973
20251104090932,107.79295875,22.54082973
20251104090933,107.79295810,22.54082973
20251104090934,107.79295671,22.54082978
20251104090935,107.79295676,22.54082976
20251104090936,107.79295673,22.54082975
20251104090937,107.79295671,22.54082976
20251104090938,107.79295568,22.54082970
20251104090939,107.79295576,22.54082970
20251104090941,107.79295581,22.54082970
20251104090942,107.79295580,22.54082970
20251104090943,107.79295585,22.54082971
20251104090944,107.79295583,22.54082971
20251104090946,107.79295583,22.54082968
20251104090947,107.79295585,22.54082970
20251104090948,107.79295585,22.54082968
20251104090949,107.79295583,22.54082971
20251104090950,107.79295586,22.54082970
20251104090951,107.79295581,22.54082971
20251104090952,107.79295576,22.54082970
20251104090953,107.79295578,22.54082970
20251104090954,107.79295576,22.54082973
20251104090955,107.79295576,22.54082970
20251104090956,107.79295581,22.54082970
20251104090957,107.79295576,22.54082971
20251104090958,107.79295574,22.54082971
20251104090959,107.79295566,22.54082971
20251104091000,107.79295006,22.54082968
20251104091001,107.79294460,22.54082968
20251104091002,107.79293988,22.54082973
20251104091003,107.79293751,22.54082976
20251104091004,107.79293059,22.54082961
20251104091005,107.79292018,22.54082971
20251104091006,107.79290976,22.54083080
20251104091007,107.79289960,22.54083353
20251104091008,107.79289006,22.54083768
20251104091009,107.79288120,22.54084298
20251104091010,107.79287258,22.54084870
20251104091011,107.79286398,22.54085431
20251104091012,107.79285499,22.54085943
20251104091013,107.79284559,22.54086340
20251104091014,107.79283540,22.54086528
20251104091015,107.79282498,22.54086421
20251104091016,107.79281556,22.54086001
20251104091017,107.79280793,22.54085318
20251104091018,107.79280283,22.54084455
20251104091019,107.79280091,22.54083495
20251104091020,107.79280220,22.54082531
20251104091021,107.79280663,22.54081646
20251104091022,107.79281373,22.54080940
20251104091023,107.79282291,22.54080451
20251104091024,107.79283295,22.54080196
20251104091025,107.79284308,22.54080101
20251104091026,107.79285325,22.54080146
20251104091027,107.79286358,22.54080268
20251104091028,107.79287406,22.54080331
20251104091029,107.79288435,22.54080358
20251104091030,107.79289476,22.54080378
20251104091031,107.79290513,22.54080393
20251104091032,107.79291524,22.54080401
20251104091033,107.79292336,22.54080403
20251104091034,107.79292896,22.54080403
20251104091035,107.79293383,22.54080400
20251104091036,107.79293835,22.54080395
20251104091037,107.79294083,22.54080390
20251104091038,107.79294496,22.54080400
20251104091039,107.79295088,22.54080406
20251104091040,107.79295203,22.54080408
20251104091041,107.79295213,22.54080405
20251104091042,107.79295209,22.54080403
20251104091043,107.79295209,22.54080406
20251104091044,107.79295209,22.54080405
20251104091045,107.79295375,22.54080401
20251104091046,107.79295353,22.54080406
20251104091047,107.79295355,22.54080406
20251104091048,107.79295350,22.54080405
20251104091049,107.79295348,22.54080410
20251104091050,107.79295355,22.54080406
20251104091051,107.79295355,22.54080406
20251104091052,107.79295356,22.54080405
20251104091053,107.79295355,22.54080408
20251104091054,107.79295359,22.54080405
20251104091055,107.79295356,22.54080405
20251104091056,107.79295361,22.54080403
20251104091057,107.79295361,22.54080403
20251104091058,107.79295359,22.54080405
20251104091059,107.79295359,22.54080408
20251104091100,107.79295361,22.54080408
20251104091101,107.79295363,22.54080406
20251104091102,107.79295365,22.54080408
20251104091103,107.79295361,22.54080405
20251104091104,107.79295365,22.54080408
20251104091105,107.79295361,22.54080406
20251104091106,107.79295368,22.54080405
20251104091107,107.79295361,22.54080411
20251104091108,107.79295366,22.54080406
20251104091109,107.79295365,22.54080406
20251104091110,107.79295476,22.54080405
20251104091111,107.79296010,22.54080413
20251104091112,107.79296790,22.54080411
20251104091113,107.79297583,22.54080408
20251104091114,107.79298378,22.54080410
20251104091115,107.79299164,22.54080406
20251104091116,107.79299956,22.54080410
20251104091117,107.79300748,22.54080411
20251104091118,107.79301543,22.54080410
20251104091119,107.79302335,22.54080415
20251104091120,107.79303118,22.54080403
20251104091121,107.79303903,22.54080391
20251104091122,107.79304693,22.54080398
20251104091123,107.79305480,22.54080398
20251104091124,107.79306281,22.54080398
20251104091125,107.79307078,22.54080393
20251104091126,107.79307868,22.54080390
20251104091127,107.79308653,22.54080373
20251104091128,107.79309445,22.54080378
20251104091129,107.79310235,22.54080370
20251104091130,107.79311025,22.54080388
20251104091131,107.79311816,22.54080388
20251104091132,107.79312603,22.54080390
20251104091134,107.79314191,22.54080380
20251104091135,107.79314988,22.54080380
20251104091136,107.79315780,22.54080385
20251104091137,107.79316570,22.54080380
20251104091138,107.79317360,22.54080380
20251104091140,107.79318943,22.54080358
20251104091141,107.79319741,22.54080356
20251104091142,107.79320528,22.54080365
20251104091143,107.79321318,22.54080365
20251104091144,107.79322106,22.54080363
20251104091145,107.79322896,22.54080355
20251104091146,107.79323686,22.54080351
20251104091147,107.79324478,22.54080356
20251104091148,107.79325271,22.54080360
20251104091149,107.79326060,22.54080365
20251104091150,107.79326851,22.54080360
20251104091151,107.79327643,22.54080360
20251104091152,107.79328433,22.54080353
20251104091153,107.79329230,22.54080345
20251104091154,107.79330013,22.54080353
20251104091155,107.79330805,22.54080353
20251104091156,107.79331595,22.54080355
20251104091157,107.79332386,22.54080353
20251104091158,107.79333173,22.54080343
20251104091159,107.79333963,22.54080341
20251104091200,107.79334755,22.54080345
20251104091201,107.79335548,22.54080348
20251104091202,107.79336346,22.54080350
20251104091204,107.79337931,22.54080340
20251104091205,107.79338715,22.54080331
20251104091206,107.79339501,22.54080326
20251104091207,107.79340298,22.54080325
20251104091208,107.79341090,22.54080340
20251104091209,107.79341773,22.54080333
20251104091210,107.79341955,22.54080331
20251104091211,107.79341935,22.54080335
20251104091212,107.79341960,22.54080331
20251104091213,107.79342201,22.54080330
20251104091214,107.79342243,22.54080340
20251104091215,107.79342246,22.54080331
20251104091216,107.79342250,22.54080331
20251104091217,107.79342246,22.54080331
20251104091218,107.79342244,22.54080326
20251104091219,107.79342250,22.54080330
20251104091220,107.79342248,22.54080328
20251104091221,107.79342251,22.54080331
20251104091222,107.79342255,22.54080328
20251104091223,107.79342253,22.54080326
20251104091224,107.79342250,22.54080330
20251104091225,107.79342253,22.54080328
20251104091226,107.79342248,22.54080331
20251104091227,107.79342251,22.54080328
20251104091228,107.79342250,22.54080325
20251104091229,107.79342250,22.54080330
20251104091230,107.79342251,22.54080330
20251104091231,107.79342250,22.54080328
20251104091232,107.79342246,22.54080330
20251104091233,107.79342251,22.54080328
20251104091234,107.79342253,22.54080328
20251104091235,107.79342250,22.54080330
20251104091236,107.79342375,22.54080325
20251104091237,107.79342733,22.54080326
20251104091238,107.79343670,22.54080330
20251104091239,107.79344709,22.54080316
20251104091240,107.79345743,22.54080191
20251104091241,107.79346744,22.54079900
20251104091242,107.79347673,22.54079455
20251104091243,107.79348534,22.54078875
20251104091244,107.79349308,22.54078220
20251104091245,107.79350016,22.54077495
20251104091246,107.79350715,22.54076763
20251104091247,107.79351496,22.54076126
20251104091248,107.79352425,22.54075711
20251104091249,107.79353461,22.54075598
20251104091250,107.79354486,22.54075773
20251104091251,107.79355413,22.54076223
20251104091252,107.79356151,22.54076925
20251104091253,107.79356626,22.54077795
20251104091254,107.79356753,22.54078776
20251104091255,107.79356593,22.54079721
20251104091256,107.79356083,22.54080575
20251104091257,107.79355330,22.54081245
20251104091258,107.79354409,22.54081700
20251104091259,107.79353373,22.54081875
20251104091300,107.79352335,22.54081790
20251104091301,107.79351331,22.54081481
20251104091302,107.79350376,22.54081048
20251104091303,107.79349471,22.54080566
20251104091304,107.79348588,22.54080031
20251104091305,107.79347721,22.54079473
20251104091306,107.79346851,22.54078918
20251104091307,107.79345968,22.54078408
20251104091308,107.79345035,22.54077995
20251104091309,107.79344021,22.54077738
20251104091310,107.79342968,22.54077683
20251104091311,107.79341921,22.54077761
20251104091312,107.79341111,22.54077843
20251104091313,107.79341075,22.54077845
20251104091314,107.79341066,22.54077841
20251104091315,107.79341075,22.54077843
20251104091316,107.79341483,22.54077823
20251104091317,107.79342451,22.54077775
20251104091318,107.79343533,22.54077815
20251104091319,107.79344586,22.54077846
20251104091320,107.79345640,22.54077840
20251104091321,107.79346456,22.54077836
20251104091322,107.79346551,22.54077841
20251104091323,107.79346528,22.54077836
20251104091324,107.79346401,22.54077836
20251104091325,107.79345846,22.54077840
20251104091326,107.79345286,22.54077848
20251104091327,107.79344738,22.54077853
20251104091328,107.79344183,22.54077858
20251104091329,107.79343626,22.54077863
20251104091330,107.79343066,22.54077866
20251104091331,107.79342506,22.54077863
20251104091332,107.79342300,22.54077866
20251104091333,107.79342291,22.54077861
20251104091334,107.79342294,22.54077865
20251104091335,107.79342114,22.54077865
20251104091336,107.79342033,22.54077860
20251104091337,107.79342028,22.54077860
20251104091338,107.79342031,22.54077863
20251104091339,107.79342033,22.54077861
20251104091340,107.79342031,22.54077861
20251104091341,107.79342033,22.54077861
20251104091342,107.79342028,22.54077861
20251104091343,107.79342031,22.54077865
20251104091344,107.79342033,22.54077863
20251104091345,107.79342035,22.54077861
20251104091346,107.79342031,22.54077863
20251104091347,107.79342036,22.54077865
20251104091348,107.79342008,22.54077866
20251104091349,107.79341886,22.54077865
20251104091350,107.79341681,22.54077863
20251104091351,107.79341346,22.54077860
20251104091352,107.79340880,22.54077861
20251104091353,107.79340258,22.54077860
20251104091354,107.79339195,22.54077870
20251104091355,107.79338136,22.54077865
20251104091356,107.79337088,22.54077856
20251104091357,107.79336041,22.54077856
20251104091358,107.79334975,22.54077865
20251104091359,107.79333931,22.54077861
20251104091400,107.79332873,22.54077868
20251104091401,107.79331823,22.54077861
20251104091402,107.79330775,22.54077850
20251104091403,107.79329728,22.54077865
20251104091405,107.79327624,22.54077866
20251104091406,107.79326568,22.54077850
20251104091407,107.79325518,22.54077861
20251104091408,107.79324465,22.54077876
20251104091409,107.79323421,22.54077881
20251104091410,107.79322371,22.54077883
20251104091412,107.79320265,22.54077875
20251104091413,107.79319216,22.54077885
20251104091414,107.79318168,22.54077891
20251104091415,107.79317115,22.54077885
20251104091416,107.79316061,22.54077888
20251104091417,107.79314998,22.54077891
20251104091418,107.79313950,22.54077901
20251104091419,107.79312895,22.54077903
20251104091420,107.79311841,22.54077893
20251104091421,107.79310795,22.54077893
20251104091422,107.79309748,22.54077906
20251104091423,107.79308700,22.54077910
20251104091424,107.79307643,22.54077906
20251104091425,107.79306590,22.54077896
20251104091426,107.79305543,22.54077896
20251104091427,107.79304500,22.54077910
20251104091429,107.79302388,22.54077911
20251104091430,107.79301338,22.54077905
20251104091431,107.79300291,22.54077911
20251104091432,107.79299236,22.54077920
20251104091433,107.79298176,22.54077921
20251104091434,107.79297220,22.54077921
20251104091435,107.79296520,22.54077916
20251104091436,107.79296036,22.54077918
20251104091437,107.79295526,22.54077915
20251104091438,107.79295215,22.54077925
20251104091439,107.79295225,22.54077923
20251104091440,107.79295218,22.54077923
20251104091441,107.79295221,22.54077920
20251104091442,107.79295221,22.54077925
20251104091443,107.79295216,22.54077928
20251104091444,107.79295220,22.54077921
20251104091445,107.79295225,22.54077925
20251104091446,107.79295218,22.54077921
20251104091447,107.79295218,22.54077921
20251104091448,107.79295216,22.54077926
20251104091449,107.79295215,22.54077925
20251104091450,107.79295213,22.54077925
20251104091451,107.79295211,22.54077925
20251104091452,107.79295215,22.54077926
20251104091453,107.79295215,22.54077923
20251104091454,107.79295213,22.54077923
20251104091455,107.79295211,22.54077923
20251104091456,107.79295116,22.54077921
20251104091457,107.79294653,22.54077928
20251104091458,107.79293691,22.54077943
20251104091459,107.79292655,22.54078023
20251104091500,107.79291631,22.54078223
20251104091501,107.79290673,22.54078635
20251104091502,107.79289825,22.54079210
20251104091503,107.79288986,22.54079808
20251104091504,107.79288079,22.54080296
20251104091505,107.79287091,22.54080598
20251104091506,107.79286058,22.54080611
20251104091507,107.79285055,22.54080328
20251104091508,107.79284206,22.54079746
20251104091509,107.79283596,22.54078965
20251104091510,107.79283243,22.54078051
20251104091511,107.79283248,22.54077073
20251104091512,107.79283571,22.54076143
20251104091513,107.79284158,22.54075325
20251104091514,107.79284935,22.54074678
20251104091515,107.79285866,22.54074241
20251104091516,107.79286913,22.54074065
20251104091517,107.79287961,22.54074143
20251104091518,107.79288993,22.54074338
20251104091519,107.79289998,22.54074606
20251104091520,107.79291013,22.54074863
20251104091521,107.79292028,22.54075113
20251104091522,107.79293070,22.54075255
20251104091523,107.79294110,22.54075316
20251104091524,107.79294943,22.54075333
20251104091525,107.79295143,22.54075333
20251104091526,107.79295126,22.54075333
20251104091527,107.79295120,22.54075333
20251104091528,107.79294828,22.54075330
20251104091529,107.79293743,22.54075318
20251104091530,107.79292678,22.54075370
20251104091531,107.79291611,22.54075358
20251104091532,107.79290575,22.54075368
20251104091533,107.79290041,22.54075378
20251104091534,107.79290073,22.54075380
20251104091535,107.79290190,22.54075371
20251104091536,107.79290756,22.54075373
20251104091537,107.79291315,22.54075380
20251104091538,107.79291868,22.54075383
20251104091539,107.79292426,22.54075391
20251104091540,107.79292980,22.54075395
20251104091541,107.79293531,22.54075395
20251104091542,107.79294088,22.54075395
20251104091543,107.79294638,22.54075383
20251104091544,107.79295086,22.54075381
20251104091545,107.79295056,22.54075381
20251104091546,107.79295061,22.54075383
20251104091547,107.79295063,22.54075380
20251104091548,107.79295060,22.54075383
20251104091549,107.79295058,22.54075383
20251104091550,107.79295060,22.54075381
20251104091551,107.79295064,22.54075380
20251104091552,107.79295063,22.54075380
20251104091553,107.79295228,22.54075381
20251104091554,107.79295193,22.54075381
20251104091555,107.79295191,22.54075383
20251104091556,107.79295190,22.54075383
20251104091557,107.79295195,22.54075380
20251104091558,107.79295193,22.54075380
20251104091559,107.79295190,22.54075380
20251104091600,107.79295191,22.54075380
20251104091601,107.79295190,22.54075380
20251104091602,107.79295190,22.54075381
20251104091603,107.79295191,22.54075380
20251104091604,107.79295186,22.54075381
20251104091605,107.79295185,22.54075380
20251104091606,107.79295186,22.54075378
20251104091607,107.79295186,22.54075383
20251104091608,107.79295271,22.54075381
20251104091609,107.79295573,22.54075383
20251104091610,107.79296078,22.54075385
20251104091611,107.79296781,22.54075371
20251104091612,107.79297801,22.54075368
20251104091613,107.79298841,22.54075375
20251104091614,107.79299891,22.54075368
20251104091615,107.79300948,22.54075373
20251104091616,107.79302005,22.54075370
20251104091617,107.79303048,22.54075375
20251104091618,107.79304090,22.54075376
20251104091619,107.79305148,22.54075375
20251104091620,107.79306203,22.54075378
20251104091621,107.79307241,22.54075380
20251104091622,107.79308291,22.54075378
20251104091623,107.79309348,22.54075380
20251104091624,107.79310396,22.54075373
20251104091625,107.79311448,22.54075368
20251104091626,107.79312499,22.54075370
20251104091627,107.79313558,22.54075358
20251104091628,107.79314608,22.54075355
20251104091629,107.79315668,22.54075358
20251104091630,107.79316723,22.54075358
20251104091631,107.79317770,22.54075356
20251104091633,107.79319860,22.54075351
20251104091634,107.79320918,22.54075350
20251104091636,107.79323015,22.54075348
20251104091637,107.79324068,22.54075341
20251104091638,107.79325110,22.54075341
20251104091639,107.79326170,22.54075336
20251104091640,107.79327216,22.54075335
20251104091641,107.79328269,22.54075343
20251104091643,107.79330376,22.54075346
20251104091644,107.79331421,22.54075328
20251104091645,107.79332478,22.54075323
20251104091646,107.79333523,22.54075316
20251104091647,107.79334571,22.54075321
20251104091649,107.79336683,22.54075315
20251104091650,107.79337736,22.54075313
20251104091651,107.79338778,22.54075316
20251104091652,107.79339721,22.54075316
20251104091653,107.79340424,22.54075315
20251104091654,107.79340886,22.54075310
20251104091655,107.79341271,22.54075306
20251104091656,107.79341780,22.54075300
20251104091657,107.79342173,22.54075296
20251104091658,107.79342300,22.54075295
20251104091659,107.79342286,22.54075298
20251104091700,107.79342285,22.54075296
20251104091701,107.79342281,22.54075296
20251104091702,107.79342286,22.54075298
20251104091703,107.79342286,22.54075298
20251104091704,107.79342281,22.54075298
20251104091705,107.79342290,22.54075295
20251104091706,107.79342285,22.54075295
20251104091707,107.79342373,22.54075296
20251104091708,107.79343026,22.54075290
20251104091709,107.79344125,22.54075266
20251104091710,107.79345181,22.54075205
20251104091711,107.79346225,22.54075146
20251104091712,107.79347266,22.54075213
20251104091713,107.79348296,22.54075411
20251104091714,107.79349279,22.54075735
20251104091715,107.79350238,22.54076146
20251104091716,107.79351205,22.54076518
20251104091717,107.79352213,22.54076696
20251104091718,107.79353250,22.54076611
20251104091719,107.79354210,22.54076240
20251104091720,107.79355028,22.54075630
20251104091721,107.79355580,22.54074821
20251104091722,107.79355901,22.54073903
20251104091723,107.79355883,22.54072938
20251104091724,107.79355576,22.54072013
20251104091725,107.79354980,22.54071213
20251104091726,107.79354148,22.54070613
20251104091727,107.79353178,22.54070260
20251104091728,107.79352126,22.54070181
20251104091729,107.79351116,22.54070330
20251104091730,107.79350115,22.54070558
20251104091731,107.79349181,22.54070783
20251104091732,107.79348543,22.54070898
20251104091733,107.79348184,22.54070955
20251104091734,107.79348048,22.54070973
20251104091735,107.79347901,22.54070998
20251104091736,107.79347306,22.54071098
20251104091737,107.79346531,22.54071335
20251104091738,107.79345695,22.54071716
20251104091739,107.79344833,22.54072176
20251104091740,107.79343970,22.54072611
20251104091741,107.79343128,22.54072925
20251104091742,107.79342263,22.54073046
20251104091743,107.79341531,22.54073025
20251104091744,107.79341111,22.54072983
20251104091745,107.79341141,22.54072978
20251104091746,107.79341150,22.54072975
20251104091747,107.79341156,22.54072980
20251104091748,107.79341203,22.54072990
20251104091749,107.79341656,22.54073040
20251104091750,107.79342313,22.54073106
20251104091751,107.79343081,22.54073056
20251104091752,107.79344033,22.54072861
20251104091753,107.79345040,22.54072643
20251104091754,107.79346045,22.54072573
20251104091755,107.79347050,22.54072656
20251104091756,107.79347840,22.54072775
20251104091757,107.79348336,22.54072853
20251104091758,107.79348708,22.54072861
20251104091759,107.79348718,22.54072868
20251104091800,107.79348720,22.54072866
20251104091801,107.79348714,22.54072870
20251104091802,107.79348551,22.54072868
20251104091803,107.79347926,22.54072850
20251104091804,107.79347021,22.54072821
20251104091805,107.79345978,22.54072806
20251104091806,107.79344945,22.54072806
20251104091807,107.79343921,22.54072803
20251104091808,107.79343130,22.54072808
20251104091809,107.79342623,22.54072813
20251104091810,107.79342375,22.54072815
20251104091811,107.79342079,22.54072818
20251104091812,107.79342093,22.54072821
20251104091813,107.79342095,22.54072815
20251104091814,107.79342091,22.54072821
20251104091815,107.79342095,22.54072825
20251104091816,107.79342098,22.54072819
20251104091817,107.79342098,22.54072821
20251104091818,107.79342100,22.54072819
20251104091819,107.79342100,22.54072821
20251104091820,107.79342101,22.54072818
20251104091821,107.79342100,22.54072819
20251104091822,107.79342098,22.54072819
20251104091823,107.79342098,22.54072819
20251104091824,107.79342098,22.54072819
20251104091825,107.79342096,22.54072819
20251104091826,107.79342095,22.54072821
20251104091827,107.79342100,22.54072819
20251104091828,107.79342096,22.54072819
20251104091829,107.79342098,22.54072819
20251104091830,107.79342098,22.54072821
20251104091831,107.79342095,22.54072821
20251104091832,107.79342096,22.54072821
20251104091833,107.79342101,22.54072823
20251104091834,107.79342096,22.54072821
20251104091835,107.79342098,22.54072819
20251104091836,107.79342098,22.54072819
20251104091837,107.79342101,22.54072819
20251104091838,107.79342100,22.54072823
20251104091839,107.79342098,22.54072823
20251104091840,107.79342098,22.54072821
20251104091841,107.79342098,22.54072821
20251104091842,107.79342096,22.54072819
20251104091843,107.79342098,22.54072821
20251104091844,107.79342101,22.54072823
20251104091845,107.79342098,22.54072821
20251104091846,107.79342103,22.54072821
20251104091847,107.79342098,22.54072823
20251104091848,107.79342101,22.54072823
20251104091849,107.79342070,22.54072823
20251104091850,107.79341730,22.54072826
20251104091851,107.79341073,22.54072826
20251104091852,107.79340175,22.54072826
20251104091853,107.79339158,22.54072818
20251104091854,107.79338108,22.54072821
20251104091855,107.79337054,22.54072819
20251104091856,107.79336009,22.54072825
20251104091857,107.79334956,22.54072823
20251104091859,107.79332851,22.54072823
20251104091901,107.79330749,22.54072826
20251104091903,107.79328645,22.54072830
20251104091904,107.79327591,22.54072833
20251104091905,107.79326546,22.54072843
20251104091907,107.79324450,22.54072830
20251104091908,107.79323391,22.54072841
20251104091909,107.79322338,22.54072855
20251104091910,107.79321296,22.54072860
20251104091911,107.79320243,22.54072851
20251104091912,107.79319190,22.54072850
20251104091913,107.79318139,22.54072846
20251104091914,107.79317086,22.54072848
20251104091915,107.79316038,22.54072845
20251104091916,107.79314969,22.54072855
20251104091917,107.79313920,22.54072845
20251104091919,107.79311828,22.54072850
20251104091920,107.79310770,22.54072853
20251104091922,107.79308673,22.54072861
20251104091923,107.79307618,22.54072860
20251104091924,107.79306565,22.54072873
20251104091925,107.79305523,22.54072875
20251104091926,107.79304474,22.54072871
20251104091927,107.79303425,22.54072875
20251104091928,107.79302365,22.54072876
20251104091929,107.79301313,22.54072891
20251104091930,107.79300268,22.54072880
20251104091931,107.79299215,22.54072875
20251104091932,107.79298163,22.54072876
20251104091933,107.79297113,22.54072888
20251104091934,107.79296068,22.54072888
20251104091935,107.79295060,22.54072883
20251104091936,107.79294811,22.54072893
20251104091937,107.79294796,22.54072888
20251104091938,107.79294798,22.54072890
20251104091939,107.79294803,22.54072888
20251104091940,107.79294798,22.54072886
20251104091941,107.79294800,22.54072890
20251104091942,107.79294801,22.54072885
20251104091943,107.79294801,22.54072893
20251104091944,107.79294800,22.54072890
20251104091945,107.79294796,22.54072893
20251104091946,107.79294805,22.54072890
20251104091947,107.79294743,22.54072893
20251104091948,107.79294051,22.54072891
20251104091949,107.79293410,22.54072925
20251104091950,107.79292349,22.54073038
20251104091951,107.79291339,22.54073245
20251104091952,107.79290356,22.54073568
20251104091953,107.79289435,22.54074043
20251104091954,107.79288548,22.54074561
20251104091955,107.79287610,22.54074981
20251104091956,107.79286603,22.54075173
20251104091957,107.79285553,22.54075063
20251104091958,107.79284620,22.54074628
20251104091959,107.79283846,22.54073965
20251104092000,107.79283335,22.54073113
20251104092001,107.79283151,22.54072163
20251104092002,107.79283293,22.54071195
20251104092003,107.79283746,22.54070321
20251104092004,107.79284475,22.54069628
20251104092005,107.79285401,22.54069181
20251104092006,107.79286435,22.54069001
20251104092007,107.79287436,22.54069053
20251104092008,107.79288168,22.54069150
20251104092009,107.79288641,22.54069225
20251104092010,107.79288943,22.54069278
20251104092011,107.79289480,22.54069421
20251104092012,107.79290199,22.54069663
20251104092013,107.79291035,22.54069998
20251104092014,107.79291945,22.54070256
20251104092015,107.79292913,22.54070361
20251104092016,107.79293891,22.54070363
20251104092017,107.79294626,22.54070358
20251104092018,107.79294863,22.54070350
20251104092019,107.79294856,22.54070345
20251104092020,107.79294853,22.54070348
20251104092021,107.79294851,22.54070345
20251104092022,107.79294841,22.54070350
20251104092023,107.79294873,22.54070350
20251104092024,107.79295011,22.54070354
20251104092025,107.79295010,22.54070356
20251104092026,107.79295013,22.54070353
20251104092027,107.79295011,22.54070354
20251104092028,107.79295016,22.54070351
20251104092029,107.79295018,22.54070351
20251104092030,107.79295011,22.54070351
20251104092031,107.79295015,22.54070354
20251104092032,107.79295018,22.54070348
20251104092033,107.79295015,22.54070353
20251104092034,107.79295011,22.54070353
20251104092035,107.79295016,22.54070353
20251104092036,107.79295020,22.54070353
20251104092037,107.79295016,22.54070351
20251104092038,107.79295015,22.54070353
20251104092039,107.79295015,22.54070354
20251104092040,107.79295015,22.54070354
20251104092041,107.79295015,22.54070351
20251104092042,107.79295016,22.54070353
20251104092043,107.79295016,22.54070351
20251104092044,107.79295013,22.54070353
20251104092045,107.79295013,22.54070350
20251104092046,107.79295016,22.54070353
20251104092047,107.79295013,22.54070351
20251104092048,107.79295015,22.54070353
20251104092049,107.79295016,22.54070353
20251104092050,107.79295016,22.54070354
20251104092051,107.79295015,22.54070353
20251104092052,107.79295016,22.54070351
20251104092053,107.79295018,22.54070351
20251104092054,107.79295011,22.54070353
20251104092055,107.79295010,22.54070351
20251104092056,107.79295015,22.54070354
20251104092057,107.79295013,22.54070353
20251104092058,107.79295013,22.54070350
20251104092059,107.79295011,22.54070351
20251104092100,107.79295015,22.54070351
20251104092101,107.79295018,22.54070354
20251104092102,107.79295010,22.54070351
20251104092103,107.79295013,22.54070351
20251104092104,107.79295006,22.54070350
20251104092105,107.79295010,22.54070350
20251104092106,107.79295008,22.54070350
20251104092107,107.79295011,22.54070350
20251104092108,107.79295006,22.54070353
20251104092109,107.79295008,22.54070351
20251104092110,107.79295034,22.54070353
20251104092111,107.79295408,22.54070351
20251104092112,107.79296125,22.54070353
20251104092113,107.79297171,22.54070346
20251104092114,107.79298226,22.54070346
20251104092115,107.79299281,22.54070356
20251104092116,107.79300333,22.54070360
20251104092117,107.79301396,22.54070363
20251104092118,107.79302443,22.54070356
20251104092119,107.79303495,22.54070346
20251104092120,107.79304545,22.54070354
20251104092121,107.79305591,22.54070356
20251104092122,107.79306641,22.54070353
20251104092123,107.79307681,22.54070340
20251104092124,107.79308533,22.54070336
20251104092125,107.79309276,22.54070341
20251104092126,107.79310054,22.54070343
20251104092128,107.79311633,22.54070340
20251104092129,107.79312423,22.54070335
20251104092130,107.79313226,22.54070328
20251104092132,107.79314808,22.54070321
20251104092133,107.79314808,22.54070321
20251104092134,107.79316386,22.54070313
20251104092135,107.79317173,22.54070308
20251104092136,107.79317965,22.54070308
20251104092138,107.79319555,22.54070305
20251104092139,107.79320348,22.54070310
20251104092140,107.79321140,22.54070306
20251104092141,107.79321925,22.54070295
20251104092142,107.79322721,22.54070293
20251104092143,107.79323513,22.54070293
20251104092144,107.79324306,22.54070303
20251104092145,107.79325089,22.54070305
20251104092146,107.79325881,22.54070313
20251104092147,107.79326670,22.54070300
20251104092148,107.79327460,22.54070290
20251104092149,107.79328249,22.54070288
20251104092150,107.79329045,22.54070286
20251104092151,107.79329830,22.54070285
20251104092152,107.79330631,22.54070288
20251104092153,107.79331424,22.54070281
20251104092154,107.79332213,22.54070270
20251104092155,107.79333005,22.54070265
20251104092156,107.79333790,22.54070266
20251104092157,107.79334580,22.54070268
20251104092158,107.79335371,22.54070273
20251104092159,107.79336161,22.54070275
20251104092200,107.79336951,22.54070268
20251104092201,107.79337744,22.54070260
20251104092202,107.79338536,22.54070256
20251104092203,107.79339330,22.54070255
20251104092204,107.79340125,22.54070258
20251104092205,107.79340911,22.54070260
20251104092206,107.79341700,22.54070251
20251104092207,107.79342178,22.54070245
20251104092208,107.79342156,22.54070248
20251104092209,107.79342153,22.54070250
20251104092210,107.79342153,22.54070250
20251104092211,107.79342150,22.54070251
20251104092212,107.79342150,22.54070250
20251104092213,107.79342151,22.54070246
20251104092214,107.79342151,22.54070248
20251104092215,107.79342148,22.54070248
20251104092216,107.79342153,22.54070250
20251104092217,107.79342148,22.54070250
20251104092218,107.79342151,22.54070250
20251104092219,107.79342153,22.54070246
20251104092220,107.79342148,22.54070248
20251104092221,107.79342153,22.54070245
20251104092222,107.79342153,22.54070250
20251104092223,107.79342151,22.54070248
20251104092224,107.79342148,22.54070248
20251104092225,107.79342150,22.54070246
20251104092226,107.79342146,22.54070250
20251104092227,107.79342150,22.54070246
20251104092228,107.79342150,22.54070241
20251104092229,107.79342150,22.54070250
20251104092230,107.79342150,22.54070245
20251104092231,107.79342146,22.54070250
20251104092232,107.79342148,22.54070246
20251104092233,107.79342148,22.54070248
20251104092234,107.79342146,22.54070250
20251104092235,107.79342150,22.54070246
20251104092236,107.79342145,22.54070245
20251104092237,107.79342148,22.54070246
20251104092238,107.79342145,22.54070243
20251104092239,107.79342150,22.54070245
20251104092240,107.79342146,22.54070246
20251104092241,107.79342143,22.54070246
20251104092242,107.79342146,22.54070245
20251104092243,107.79342145,22.54070246
20251104092244,107.79342148,22.54070246
20251104092245,107.79342143,22.54070245
20251104092246,107.79342141,22.54070243
20251104092247,107.79342148,22.54070246
20251104092248,107.79342145,22.54070248
20251104092249,107.79342140,22.54070250
20251104092250,107.79342145,22.54070246
20251104092251,107.79342145,22.54070250
20251104092252,107.79342143,22.54070248</textarea>
            <div class="button-group">
                <button id="drawTrackButton" disabled style="flex: 1;">绘制轨迹</button>
                <button id="showTrackPointsButton" disabled style="flex: 1;" class="btn-warning">打点</button>
                <button id="clearTrackButton" disabled style="flex: 1;">清空轨迹</button>
            </div>
            <!-- 轨迹颜色选择器 -->
            <div class="color-picker-container" style="margin-top:8px;">
                <div style="margin-bottom:6px;font-size:12px;color:#333;">轨迹颜色设置：</div>
                <div style="display:flex;align-items:center;gap:8px;">
                    <div style="display:flex;align-items:center;gap:4px;">
                        <label style="font-size:12px;">轨迹线颜色:</label>
                        <div id="trackLineColorPicker" class="color-picker" style="width:24px;height:24px;border:1px solid #ccc;cursor:pointer;background-color:#FF0000;"></div>
                        <input type="color" id="trackLineColorInput" value="#FF0000" style="display:none;">
                    </div>
                    <div style="display:flex;align-items:center;gap:4px;">
                        <label style="font-size:12px;">轨迹点颜色:</label>
                        <div id="trackPointColorPicker" class="color-picker" style="width:24px;height:24px;border:1px solid #ccc;cursor:pointer;background-color:#68EAF3;"></div>
                        <input type="color" id="trackPointColorInput" value="#68EAF3" style="display:none;">
                    </div>
                </div>
            </div>
            <!-- 回放控制 -->
            <div class="split-section" style="margin-top:8px;">
                <div class="title">轨迹回放</div>
                <div class="playback-actions" style="display:flex;gap:8px;margin-bottom:8px;">
                    <button id="playbackStartBtn" disabled>开始</button>
                    <button id="playbackPauseBtn" disabled>继续</button>
                    <button id="playbackStopBtn" disabled>结束</button>
                </div>
                <div class="playback-speed" style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                    <label>速度：
                        <select id="playbackSpeedSelect" disabled>
                            <option value="1" selected>1×</option>
                            <option value="2">2×</option>
                            <option value="4">4×</option>
                            <option value="8">8×</option>
                            <option value="16">16×</option>
                            <option value="32">32×</option>
                            <option value="64">64×</option>
                            <option value="128">128×</option>
                            <option value="256">256×</option>
                            <option value="512">512×</option>
                            <option value="1024">1024×</option>
                        </select>
                    </label>
                    <span id="playbackTimeLabel" style="font-size:12px;color:#666;">时间：—</span>
                </div>
                <div class="playback-time" style="display:flex;flex-direction:column;gap:4px;margin-bottom:8px;">
                    <label class="playback-time-label" style="display:flex;align-items:center;gap:8px;flex:1 1 auto;min-width:0;">
                        <span class="playback-time-text" style="white-space:nowrap;">起始时间：</span>
                        <input type="range" id="playbackTimeSlider" disabled min="0" max="0" step="1000" value="0" style="flex:1 1 auto;min-width:0;max-width:100%;vertical-align:middle;">
                    </label>
                    <span id="playbackTimeCursor" style="font-size:12px;color:#666;align-self:flex-end;">—</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let map;
    let currentPolygons = []; // 存储多边形和其标签
    let currentTracks = []; // 存储轨迹折线及相关覆盖物
    let mapLoaded = false;
    let mapLabelHandlers = []; // 存储地图事件处理器
    let labelsEnabled = false; // 标签显示开关（默认关闭）
    let isDrawing = false; // 绘制进行中防止重复点击
    let currentMapType = 'satellite'; // 当前地图类型：'satellite'（卫星图）或'street'（街道图）

    window.onload = function () {
        if (typeof T === 'undefined') {
            alert("天地图API加载失败，请检查网络或密钥！");
            return;
        }
        initMap();
        bindDrawEvent();
        bindMinimizeEvent();
        bindTabs();
        bindBatchGenerator();
        bindMultiSplitter();
        bindLabelsToggle(); // 绑定标签显示开关
        bindTrackEvents();  // 绑定轨迹绘制与清空
        bindPlaybackControls(); // 绑定轨迹回放
        bindMeasureEvents(); // 绑定测量功能
        bindMapTypeEvent(); // 绑定地图类型切换功能
        initColorPickers(); // 初始化颜色选择器
    };

    function initMap() {
        showLoading();
        disableButtons(true);

        try {
            map = new T.Map("mapContainer", {
                zoom: 12,
                center: new T.LngLat(116.40769, 39.90403)
            });

            // 已移除测试标签
            map.enableScrollWheelZoom();

            // 不再添加地图类型控件到地图，改为使用左侧工具条按钮切换
            // const mapTypeCtrl = new T.Control.MapType({
            //     mapTypes: [TMAP_NORMAL_MAP, TMAP_SATELLITE_MAP, TMAP_TERRAIN_MAP],
            //     position: T_ANCHOR_TOP_LEFT
            // });
            // map.addControl(mapTypeCtrl);

            // 加载影像底图（卫星）
            const tk = "9ed3674d01dd7c129ab38e3c38bf651a";

            // 方案1：使用默认地图类型（作为备选）
            map.setMapType(TMAP_SATELLITE_MAP);
            currentMapType = 'satellite';
            updateMapTypeButton('卫星图');

            // 方案2：手动添加影像图层（底图 + 标注）
            const vecLayer = new T.TileLayer(`https://t0.tianditu.gov.cn/img_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=img&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`);
            const cvaLayer = new T.TileLayer(`https://t0.tianditu.gov.cn/cia_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cia&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`);

            // 添加图层并监听加载状态
            vecLayer.addEventListener("load", function () {
                console.log("影像底图加载完成");
            });

            vecLayer.addEventListener("error", function (e) {
                console.error("影像底图加载错误:", e);
                alert("影像底图加载错误，将使用默认地图类型");
            });

            map.addLayer(vecLayer);
            map.addLayer(cvaLayer);

            // 监听地图加载事件
            map.addEventListener("loaded", function () {
                console.log("地图加载完成");
                markMapLoaded();
            });
            map.addEventListener("load", function () {
                console.log("地图load事件触发");
                markMapLoaded();
            });
            map.addEventListener("tilesloaded", function () {
                console.log("地图瓦片加载完成");
                markMapLoaded();
            });
            // 监听地图加载失败事件
            map.addEventListener("error", function (e) {
                console.error("地图加载错误:", e);
                alert("地图加载错误: " + e.message);
                hideLoading();
            });

            // 监听地图移动事件，用于更新标签位置
            const moveHandler = function () {
                updateAllLabelsPosition();
            };
            map.addEventListener("move", moveHandler);
            map.addEventListener("zoom", moveHandler);

            // 存储事件处理器，用于清理
            mapLabelHandlers.push({ event: "move", handler: moveHandler });
            mapLabelHandlers.push({ event: "zoom", handler: moveHandler });

            // 超时容错
            setTimeout(() => {
                if (!mapLoaded) markMapLoaded();
            }, 8000);

        } catch (error) {
            alert("地图初始化失败：" + error.message);
            console.error(error);
            hideLoading();
        }
    }

    function markMapLoaded() {
        if (!mapLoaded) {
            mapLoaded = true;
            hideLoading();
            // 不再禁用按钮，保持按钮始终可用
            // disableButtons(false);
            disableTrackButtons(false);
            // 仅开启速度选择，回放按钮按状态控制
            const speedSel = document.getElementById('playbackSpeedSelect');
            if (speedSel) speedSel.disabled = false;
            updatePlaybackButtonsState('idle');
        }
    }

    function showLoading() {
        const loading = document.getElementById("mapLoading");
        loading.style.display = "flex";
        loading.style.opacity = "1";
    }

    function hideLoading() {
        const loading = document.getElementById("mapLoading");
        loading.style.opacity = "0";
        setTimeout(() => loading.style.display = "none", 300);
    }

    function disableButtons(disabled) {
        // 不再禁用按钮，保持按钮始终可用
        // document.getElementById("drawButton").disabled = disabled;
        // document.getElementById("clearButton").disabled = disabled;
    }

    function disableTrackButtons(disabled) {
        const drawTrackBtn = document.getElementById("drawTrackButton");
        const showTrackPointsBtn = document.getElementById("showTrackPointsButton");
        const clearTrackBtn = document.getElementById("clearTrackButton");
        if (drawTrackBtn) drawTrackBtn.disabled = disabled;
        if (showTrackPointsBtn) showTrackPointsBtn.disabled = disabled;
        if (clearTrackBtn) clearTrackBtn.disabled = disabled;
    }
    // 回放控件的禁用/启用
    function disablePlaybackButtons(disabled) {
        ["playbackStartBtn","playbackPauseBtn","playbackStopBtn","playbackSpeedSelect","playbackTimeSlider"].forEach(id=>{
            const el = document.getElementById(id);
            if (el) el.disabled = disabled;
        });
    }

    // 回放按钮状态管理：空闲/播放/暂停
    function updatePlaybackButtonsState(state){
        try {
            const startBtn = document.getElementById('playbackStartBtn');
            const pauseBtn = document.getElementById('playbackPauseBtn');
            const stopBtn = document.getElementById('playbackStopBtn');
            if (!startBtn || !pauseBtn || !stopBtn) return;
            if (state === 'idle') {
                startBtn.disabled = false;
                pauseBtn.disabled = true;
                stopBtn.disabled = true;
                pauseBtn.textContent = '继续';
            } else if (state === 'playing') {
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
                pauseBtn.textContent = '暂停';
            } else if (state === 'paused') {
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
                pauseBtn.textContent = '继续';
            }
        } catch(e) { console.warn('更新按钮状态失败:', e); }
    }

    function bindDrawEvent() {
        document.getElementById("drawButton").addEventListener("click", function () {
            if (isDrawing) { console.log('绘制进行中，忽略重复点击'); return; }
            isDrawing = true;
            showLoading();
            try {
                const wktText = document.getElementById("wktTextarea").value.trim();
                if (!wktText) { alert("请输入WKT字符串！"); return; }

                clearOverlays();

                // 检查是否为多行WKT
                const wktLines = wktText.split('\n').filter(line => line.trim());
                let polygonData = [];

                if (wktLines.length === 1) {
                    // 单行WKT - 使用原始逻辑
                    const geojson = parseWkt(wktLines[0].trim());
                    if (geojson.type === "Polygon") {
                        polygonData.push({ index: 1, coordinates: geojson.coordinates, colorIndex: 0 });
                    } else if (geojson.type === "MultiPolygon") {
                        geojson.coordinates.forEach((polygon, index) => {
                            polygonData.push({ index: index + 1, coordinates: polygon, colorIndex: index });
                        });
                    }
                } else {
                    // 多行WKT - 每行一个多边形
                    wktLines.forEach((line, index) => {
                        if (line.trim()) {
                            try {
                                const geojson = parseWkt(line.trim());
                                if (geojson.type === "Polygon") {
                                    polygonData.push({ index: index + 1, coordinates: geojson.coordinates, colorIndex: index });
                                } else if (geojson.type === "MultiPolygon") {
                                    // 如果一行是MultiPolygon，拆分成多个Polygon
                                    geojson.coordinates.forEach((polygon, subIndex) => {
                                        polygonData.push({
                                            index: index + 1 + subIndex * 0.1,
                                            coordinates: polygon,
                                            colorIndex: index
                                        });
                                    });
                                }
                            } catch (e) {
                                console.warn(`第${index + 1}行WKT解析失败:`, e);
                            }
                        }
                    });
                }

                // 重置并绘制
                polygonInfoList = [];
                polygonData.forEach(pd => processPolygon(pd.index, pd.coordinates, pd.colorIndex));

                // 视图居中到所有已绘制轮廓
                try { fitViewportToPolygons(); } catch (e) { console.warn('视图居中失败', e); }

                // 在视图稳定后再创建/更新标签
                setTimeout(() => {
                    if (labelsEnabled) {
                        try {
                            createAllLabels();
                            updateAllLabelsPosition();
                        } catch (e) {
                            console.warn('创建或更新标签失败:', e);
                        }
                    }
                }, 150);
            } catch (e) {
                alert('绘制失败：' + (e && e.message ? e.message : e));
                console.error('绘制异常:', e);
            } finally {
                hideLoading();
                isDrawing = false;
                // 不再禁用按钮，保持按钮始终可用
                // disableButtons(false);
            }
        });

        document.getElementById("clearButton").addEventListener("click", function () {
            if (isDrawing) { console.log('绘制进行中，暂不清空'); return; }
            clearOverlays();
            console.log("已清空所有轮廓");
        });
    }

    // 存储多边形数据，用于后续标签创建
    let polygonInfoList = [];

    // 处理单个多边形的绘制和面积计算
    function processPolygon(actualPolygonIndex, polygonCoords, colorIndex = 0) {
        console.log('开始处理多边形', actualPolygonIndex);

        // 根据颜色索引获取颜色方案
        const colorScheme = polygonColors[colorIndex % polygonColors.length];

        // 坐标系选择（绘制始终使用WGS84坐标）
        const coordSys = (document.getElementById('coordSysSelect') && document.getElementById('coordSysSelect').value) || 'wgs84';

        // 统一转换为WGS84用于绘制与面积计算
        function toWgs(point){
            const lng = point[0], lat = point[1];
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                return [lng, lat];
            } else if (coordSys === 'gcj02') {
                const w = gcj02ToWgs84(lng, lat);
                return [w.lng, w.lat];
            } else if (coordSys === 'bd09') {
                const gcj = bd09ToGcj02(lng, lat);
                const w = gcj02ToWgs84(gcj.lng, gcj.lat);
                return [w.lng, w.lat];
            }
            return [lng, lat];
        }
        const coordsWGS84 = polygonCoords.map(ring => ring.map(toWgs));
        let outerRingWGS = coordsWGS84[0] || [];

        // 生成用于绘制的坐标（直接使用WGS84坐标）
        const rings = coordsWGS84.map(ring => ring.map(([lng, lat]) => new T.LngLat(lng, lat)));


         // 创建半透明填充的多边形（无边框）
          const polygon = new T.Polygon(rings, {
              color: colorScheme.outline,
              weight: 1,
              opacity: 1,
              fillColor: colorScheme.fill,
              fillOpacity: colorScheme.opacity
          });

          // 使用WGS84坐标计算面积（更准确的面积计算）
         let areaSqm;
         let areaMu;



         try {
             // 检查Turf.js是否可用
             if (typeof turf !== 'undefined' && turf.area) {
                 // 使用Turf.js计算多边形面积
                // 构造GeoJSON格式的多边形
                const geoJsonPolygon = {
                    type: "Polygon",
                    coordinates: coordsWGS84
                };


                 // 使用Turf.js计算面积（平方米）
                 areaSqm = turf.area(geoJsonPolygon);
                 areaMu = (areaSqm / 666.6667).toFixed(4); // 转换为亩
                 console.log(`多边形${actualPolygonIndex}面积计算结果(Turf.js): ${areaSqm}平方米 = ${areaMu}亩`);
             } else {
                 // 如果Turf.js不可用，回退到之前的计算方法
                 console.warn('Turf.js不可用，使用备用计算方法');
                 // 计算带孔洞的多边形面积
                 areaSqm = 0;
                 // 计算外环面积
                 outerRingWGS = coordsWGS84[0] || [];
                 areaSqm += calculatePolygonArea(outerRingWGS);

                 // 减去内环（孔洞）面积
                 for (let i = 1; i < coordsWGS84.length; i++) {
                     const innerRingArea = calculatePolygonArea(coordsWGS84[i]);
                     areaSqm -= innerRingArea;
                 }

                  areaMu = (areaSqm / 666.6667).toFixed(4); // 使用更精确的转换系数
                  console.log(`多边形${actualPolygonIndex}面积计算结果(备用): ${areaSqm}平方米 = ${areaMu}亩`);
              }
          } catch (error) {
              console.error(`面积计算失败:`, error);
              areaSqm = 0;
              areaMu = '0.0000';
          }

          // 计算多边形的中心点和底部中心点（WGS84）
          const centerPoint = calculatePolygonCenter(outerRingWGS);
          const bottomCenterPoint = calculatePolygonBottomCenter(outerRingWGS);

          // 添加多边形到地图
          if (map) {
              map.addOverLay(polygon);
              console.log(`多边形${actualPolygonIndex}已添加到地图`);
          } else {
              console.error('地图对象不存在');
          }

          // 存储多边形信息，用于后续标签创建
          polygonInfoList.push({
              index: actualPolygonIndex,
              polygon: polygon,
              area: areaMu,
              bottomCenter: { lng: bottomCenterPoint.lng, lat: bottomCenterPoint.lat },
              ringPoints: rings
          });
      }

    // 视图居中：根据已绘制的GCJ-02点
    function fitViewportToPolygons() {
        const points = [];
        try {
            if (!map || !map.setViewport) return;
            polygonInfoList.forEach(info => {
                if (!info || !info.ringPoints) return;
                info.ringPoints.forEach(ring => {
                    ring.forEach(ll => points.push(ll));
                });
            });
            if (!points.length) return;
            map.setViewport(points);
        } catch (e) {
            try {
                const lngs = points.map(p => p.lng);
                const lats = points.map(p => p.lat);
                const center = new T.LngLat(
                    (Math.min(...lngs) + Math.max(...lngs)) / 2,
                    (Math.min(...lats) + Math.max(...lats)) / 2
                );
                if (map && map.panTo) map.panTo(center);
            } catch (e2) {
                console.warn('视图居中失败:', e2);
            }
        }
    }

    // 统一创建所有多边形的标签
    function createAllLabels() {
        const mapContainer = document.getElementById('mapContainer');
        if (!mapContainer || !map) return;

        polygonInfoList.forEach(info => {
            if (!info) return;
            // 防止重复创建
            if (info.labelRef) return;
            // 创建标签元素
            const labelDiv = document.createElement('div');
            labelDiv.className = 'area-label';
            labelDiv.innerHTML = `地块${info.index}：${info.area}亩`;

            // 添加到地图容器并根据屏幕边界定位到轮廓下方
            mapContainer.appendChild(labelDiv);
            positionLabelForPolygon(labelDiv, info);

            // 记录引用，避免重复创建
            info.labelRef = labelDiv;

            // 存储到 currentPolygons 以复用现有定位/清理逻辑
            const labelObj = {
                domElement: labelDiv,
                isDomLabel: true,
                polygonInfo: info
            };
            currentPolygons.push({ polygon: info.polygon, label: labelObj });
        });

        // 不清空 polygonInfoList，便于开关随时创建/隐藏标签
    }

    // 根据多边形屏幕边界定位标签，保证始终在轮廓下方
    function positionLabelForPolygon(labelDiv, info) {
        if (!map || !info || !info.ringPoints) return;
        const points = [];
        info.ringPoints.forEach(ring => {
            ring.forEach(ll => {
                const p = map.lngLatToContainerPoint(ll);
                points.push(p);
            });
        });
        if (!points.length) return;
        const minX = Math.min(...points.map(p => p.x));
        const maxX = Math.max(...points.map(p => p.x));
        const maxY = Math.max(...points.map(p => p.y));
        const container = document.getElementById('mapContainer');
        const labelWidth = labelDiv.offsetWidth;
        const labelHeight = labelDiv.offsetHeight;
        const targetLeft = Math.round((minX + maxX) / 2 - labelWidth / 2);
        const targetTop = Math.round(maxY + 6);
        const clampedLeft = Math.max(0, Math.min(targetLeft, container.clientWidth - labelWidth));
        const clampedTop = Math.max(0, Math.min(targetTop, container.clientHeight - labelHeight));
        labelDiv.style.left = clampedLeft + 'px';
        labelDiv.style.top = clampedTop + 'px';
    }

    // 更新所有标签位置（地图move/zoom时调用）
    function updateAllLabelsPosition() {
        try {
            if (!map) return;
            const container = document.getElementById('mapContainer');
            if (!container) return;
            currentPolygons.forEach(item => {
                if (!item || !item.label) return;
                const labelObj = item.label;
                if (labelObj.isDomLabel && labelObj.domElement && labelObj.polygonInfo) {
                    // 确保标签在容器中
                    if (!labelObj.domElement.parentNode) {
                        container.appendChild(labelObj.domElement);
                    }
                    positionLabelForPolygon(labelObj.domElement, labelObj.polygonInfo);
                }
            });
        } catch (e) {
            console.warn('更新标签位置时出错:', e);
        }
    }
    // 确保在全局可用（处理第三方库事件回调作用域差异）
    window.updateAllLabelsPosition = updateAllLabelsPosition;

    // 绑定“显示亩数标签”开关（默认隐藏）
    function bindLabelsToggle() {
        const cb = document.getElementById('toggleLabelsCheckbox');
        const container = document.getElementById('mapContainer');
        if (!cb || !container) return;
        // 默认隐藏标签
        container.classList.add('labels-hidden');
        cb.addEventListener('change', () => {
            labelsEnabled = cb.checked;
            if (labelsEnabled) {
                container.classList.remove('labels-hidden');
                const hasAnyLabel = currentPolygons.some(item => item && item.label && item.label.domElement);
                if (!hasAnyLabel) {
                    try { createAllLabels(); } catch (e) { console.warn('创建标签失败:', e); }
                }
                updateAllLabelsPosition();
            } else {
                container.classList.add('labels-hidden');
            }
        });
    }

    /**
     * 计算多边形中心点（比底部中心更适合显示标签）
     */
    function calculatePolygonCenter(outerRing) {
        let sumLng = 0, sumLat = 0;
        const len = outerRing.length;

        for (let i = 0; i < len; i++) {
            sumLng += outerRing[i][0];
            sumLat += outerRing[i][1];
        }

        return {
            lng: sumLng / len,
            lat: sumLat / len
        };
    }

    /**
     * 计算多边形面积（球面多边形面积计算）
     * 使用更准确的球面坐标面积计算方法，确保面积与视觉大小一致
     */
    function calculatePolygonArea(coordinates) {
        // 地球半径（米）- 使用更精确的值
        const R = 6371000.8;
        const n = coordinates.length;

        // 将所有坐标转换为弧度
        const coordsRad = coordinates.map(point => [
            point[0] * Math.PI / 180,
            point[1] * Math.PI / 180
        ]);

        let areaRad = 0;

        // 使用更准确的球面多边形面积公式（Girard定理）
        for (let i = 0; i < n; i++) {
            const j = (i + 1) % n;
            const lon1 = coordsRad[i][0];
            const lat1 = coordsRad[i][1];
            const lon2 = coordsRad[j][0];
            const lat2 = coordsRad[j][1];

            // 计算球面多边形面积增量
            const dlon = lon2 - lon1;
            const sinLat1 = Math.sin(lat1);
            const sinLat2 = Math.sin(lat2);
            const cosLat1 = Math.cos(lat1);
            const cosLat2 = Math.cos(lat2);

            // 使用更精确的公式
            areaRad += dlon * (sinLat1 * cosLat2 * Math.cos(dlon / 2) + sinLat2 * cosLat1);
        }

        // 计算总面积（平方米）
        const areaSqm = Math.abs(areaRad) * R * R * 0.5;

        return areaSqm;
    }

    /**
     * 清空所有多边形和标签（同时处理 polygonInfoList 与 currentPolygons）
     */
    function clearOverlays() {
        try {
            // 先移除 polygonInfoList 中记录的多边形与其DOM标签
            polygonInfoList.forEach(info => {
                if (info && info.polygon && map && map.removeOverLay) {
                    try { map.removeOverLay(info.polygon); } catch (e) { console.warn('移除多边形失败:', e); }
                }
                if (info && info.labelRef && info.labelRef.parentNode) {
                    try { info.labelRef.parentNode.removeChild(info.labelRef); } catch (e) { console.warn('移除DOM标签失败:', e); }
                    info.labelRef = null;
                }
            });

            // 再处理 currentPolygons（兼容旧路径与标签对象）
            currentPolygons.forEach(item => {
                if (item.polygon && map && map.removeOverLay) {
                    try { map.removeOverLay(item.polygon); } catch (e) { console.warn('移除多边形失败:', e); }
                }
                if (item.label) {
                    if (item.label.domElement && item.label.domElement.parentNode) {
                        try { item.label.domElement.parentNode.removeChild(item.label.domElement); } catch (e) { console.warn('移除DOM标签失败:', e); }
                    } else if (map && map.removeOverLay && !item.label.isDomLabel) {
                        try { map.removeOverLay(item.label); } catch (e) { console.warn('移除地图覆盖物标签失败:', e); }
                    }
                }
            });

            // 清空记录数组
            currentPolygons = [];
            polygonInfoList = [];

            console.log('已清空所有多边形和标签（保留事件监听器）');
        } catch (error) {
            console.error('清空覆盖物时出错:', error);
        }
    }

    // 其他辅助函数（保持不变）
    function bindMinimizeEvent() {
        const container = document.querySelector(".wkt-input-container");
        const btn = document.getElementById("minimizeBtn");
        const minIcon = btn?.querySelector(".min-icon");
        const restoreIcon = btn?.querySelector(".restore-icon");

        btn?.addEventListener("click", () => {
            const minimized = container.classList.toggle("minimized");
            if (minIcon && restoreIcon) {
                if (minimized) {
                    minIcon.style.display = "none";
                    restoreIcon.style.display = "";
                } else {
                    minIcon.style.display = "";
                    restoreIcon.style.display = "none";
                }
            }
        });
    }

    // 在脚本内部补充：页签切换（3个页签）
     function bindTabs() {
         const tabs = [
             { btn: document.getElementById('tabDrawBtn'), pane: document.getElementById('tabDraw'), key: 'draw' },
             { btn: document.getElementById('tabTrackBtn'), pane: document.getElementById('tabTrack'), key: 'track' },
             { btn: document.getElementById('tabSplitBtn'), pane: document.getElementById('tabSplit'), key: 'split' },
             { btn: document.getElementById('tabBatchBtn'), pane: document.getElementById('tabBatch'), key: 'batch' },
         ];
         if (tabs.some(t => !t.btn || !t.pane)) return;
         function activate(key) {
             tabs.forEach(t => {
                 const active = t.key === key;
                 t.btn.classList.toggle('active', active);
                 t.pane.classList.toggle('active', active);
             });
         }
         tabs.forEach(t => t.btn.addEventListener('click', () => activate(t.key)));
         activate('draw');
     }
    function updateParserStatus() {
        const el = document.getElementById('parserStatus');
        if (!el) return;
        const ok = (typeof Terraformer !== 'undefined' && Terraformer.WKT && typeof Terraformer.WKT.parse === 'function');
        if (ok) {
            el.textContent = 'Terraformer WKT Parser';
            el.style.color = '#2f8f2f';
        } else {
            el.textContent = '本地回退解析（仅支持POLYGON/MULTIPOLYGON）';
            el.style.color = '#c77d1e';
        }
    }
     function parseWkt(wkt) {
         wkt = wkt.trim();
         // 优先使用成熟库（Terraformer WKT Parser）
         if (typeof Terraformer !== 'undefined' && Terraformer.WKT && Terraformer.WKT.parse) {
             try {
                 return Terraformer.WKT.parse(wkt);
             } catch (e) {
                 console.warn('Terraformer解析失败，尝试本地回退解析:', e);
             }
         } else {
             // 不再提示“未加载”，由状态栏展示回退信息
         }
         // 回退解析：仅支持 POLYGON / MULTIPOLYGON
         const typeMatch = wkt.match(/^\s*(POLYGON|MULTIPOLYGON)\s*\(/i);
         if (!typeMatch) throw new Error('仅支持POLYGON/MULTIPOLYGON');
         const type = typeMatch[1].toUpperCase();
         const inner = wkt.substring(wkt.indexOf('('));
         if (type === 'POLYGON') {
             const coords = parsePolygonCoords(inner.replace(/^\(/, '').replace(/\)$/, ''));
             return { type: 'Polygon', coordinates: coords };
         } else {
             const trimmed = inner.replace(/^\(\(/, '').replace(/\)\)$/, '');
             const coords = parseMultiPolygonCoords(trimmed);
             return { type: 'MultiPolygon', coordinates: coords };
         }
     }

     function bindMultiSplitter() {
         const input = document.getElementById('multiInput');
         const output = document.getElementById('polyOutput');
         const splitBtn = document.getElementById('splitMultiBtn');
         const copyBtn = document.getElementById('copyPolysBtn');
         if (!input || !output || !splitBtn || !copyBtn) return;

         // 本地WKT序列化辅助
         function ringToText(ring) {
             if (!ring || !ring.length) return '()';
             const first = ring[0];
             const last = ring[ring.length - 1];
             const closed = (first[0] === last[0] && first[1] === last[1]) ? ring : ring.concat([[first[0], first[1]]]);
             return '(' + closed.map(pt => pt[0] + ' ' + pt[1]).join(', ') + ')';
         }
         function toWktPolygonCoords(coords) {
             return 'POLYGON(' + coords.map(ringToText).join(', ') + ')';
         }
         function toWktMulti(coords) {
             return 'MULTIPOLYGON(' + coords.map(poly => '(' + poly.map(ringToText).join(', ') + ')').join(', ') + ')';
         }

         function polygonsFromMulti(text) {
             const geo = parseWkt(text.trim());
             if (geo.type !== 'MultiPolygon') throw new Error('请输入有效的 MULTIPOLYGON WKT');
             const polys = geo.coordinates.map(rings => toWktPolygonCoords(rings));
             return polys;
         }
         splitBtn.addEventListener('click', () => {
             try {
                 const list = polygonsFromMulti(input.value.trim());
                 output.value = list.join('\n');
             } catch (e) {
                 alert('分割失败：' + e.message);
             }
         });
         copyBtn.addEventListener('click', async () => {
             const val = output.value.trim();
             if (!val) { alert('没有可复制的结果'); return; }
             try { await navigator.clipboard.writeText(val); alert('已复制到剪贴板'); } catch (e) { console.warn('复制失败', e); }
         });
     }

     function bindBatchGenerator() {
         const batchInput = document.getElementById('batchInput');
         const output = document.getElementById('multiOutput');
         const genBtn = document.getElementById('generateMultiBtn');
         const copyBtn = document.getElementById('copyMultiBtn');

         // 本地WKT序列化辅助（与分割器保持一致）
         function ringToText(ring) {
             if (!ring || !ring.length) return '()';
             const first = ring[0];
             const last = ring[ring.length - 1];
             const closed = (first[0] === last[0] && first[1] === last[1]) ? ring : ring.concat([[first[0], first[1]]]);
             return '(' + closed.map(pt => pt[0] + ' ' + pt[1]).join(', ') + ')';
         }
         function toWktMulti(coords) {
             return 'MULTIPOLYGON(' + coords.map(poly => '(' + poly.map(ringToText).join(', ') + ')').join(', ') + ')';
         }

         genBtn.addEventListener('click', () => {
             try {
                 const lines = batchInput.value.trim().split(/\n|;/).map(s => s.trim()).filter(Boolean);
                 if (lines.length === 0) throw new Error('请按每行或分号输入至少一个POLYGON');
                 const polygons = lines.map((line, idx) => {
                     const g = parseWkt(line);
                     if (g.type !== 'Polygon') throw new Error(`第${idx + 1}行不是有效的POLYGON WKT`);
                     return g;
                 });
                 const multiGeo = { type: 'MultiPolygon', coordinates: polygons.map(p => p.coordinates) };
                 output.value = toWktMulti(multiGeo.coordinates);
             } catch (e) {
                 alert('生成失败：' + e.message);
             }
         });

         copyBtn.addEventListener('click', async () => {
             const val = output.value.trim();
             if (!val) { alert('没有可复制的结果'); return; }
             try { await navigator.clipboard.writeText(val); alert('已复制到剪贴板'); } catch (e) { console.warn('复制失败', e); }
         });

     }

     function setExampleWkt() {
         const exampleWkt = "MULTIPOLYGON(" +
             "(" +
             "(116.35 39.93, 116.39 39.93, 116.39 39.90, 116.35 39.90, 116.35 39.93)," + // 外环
             "(116.36 39.92, 116.38 39.92, 116.38 39.91, 116.36 39.91, 116.36 39.92)" +  // 内环
             ")," +
             "(" +
             "(116.40 39.95, 116.43 39.97, 116.46 39.96, 116.49 39.98, 116.52 39.95, 116.55 39.93, 116.58 39.94, 116.61 39.92, 116.64 39.95, 116.40 39.95)" +
             ")" +
             ")";
         document.getElementById("wktTextarea").value = exampleWkt;
     }

     function parsePolygonCoords(coordStr) {
         const ringStrs = coordStr.split(/\)\s*,\s*\(/).map(s => s.replace(/[()]/g, '').trim());
         const rings = [];
         ringStrs.forEach(ringStr => {
             const pts = ringStr.split(/,\s*/).map(pointStr => {
                 const [lng, lat] = pointStr.split(/\s+/).map(Number);
                 if (isNaN(lng) || isNaN(lat)) throw new Error("坐标格式错误：" + pointStr);
                 return [lng, lat];
             });
             // 自动拆分：如果一个ring中包含多次回到起点（闭合），则拆分为多个环
             // 兼容用户将外环与内环错误地写在同一对括号中的情况
             let start = 0;
             while (start < pts.length) {
                 const startPt = pts[start];
                 let closeIdx = -1;
                 for (let i = start + 1; i < pts.length; i++) {
                     if (pts[i][0] === startPt[0] && pts[i][1] === startPt[1]) {
                         closeIdx = i;
                         break;
                     }
                 }
                 if (closeIdx === -1) {
                     // 未找到闭合：将剩余点视为一个环，并强制闭合
                     const ring = pts.slice(start);
                     if (ring.length && (ring[0][0] !== ring[ring.length - 1][0] || ring[0][1] !== ring[ring.length - 1][1])) {
                         ring.push([ring[0][0], ring[0][1]]);
                     }
                     rings.push(ring);
                     break;
                 } else {
                     const ring = pts.slice(start, closeIdx + 1);
                     rings.push(ring);
                     start = closeIdx + 1;
                 }
             }
         });
         return rings;
     }

     function parseMultiPolygonCoords(coordStr) {
         const polygonStrs = coordStr.split(/\)\s*\)\s*,\s*\(\s*\(/).map(s => s.replace(/[()]/g, '').trim());
         return polygonStrs.map(polygonStr => parsePolygonCoords(polygonStr));
     }

     function wgs84ToGcj02(lng, lat) {
         const x_PI = 3.14159265358979324 * 3000.0 / 180.0;
         const PI = 3.1415926535897932384626;
         const a = 6378245.0;
         const ee = 0.00669342162296594323;

         if (outOfChina(lng, lat)) return { lng, lat };

         let dlat = transformLat(lng - 105.0, lat - 35.0);
         let dlng = transformLng(lng - 105.0, lat - 35.0);
         const radlat = lat / 180.0 * PI;
         let magic = Math.sin(radlat);
         magic = 1 - ee * magic * magic;
         const sqrtmagic = Math.sqrt(magic);
         dlat = (dlat * 180.0) / ((a * (1 - ee)) / (magic * sqrtmagic) * PI);
         dlng = (dlng * 180.0) / (a / sqrtmagic * Math.cos(radlat) * PI);

         return { lng: lng + dlng, lat: lat + dlat };

         function outOfChina(lng, lat) {
             return (lng < 72.004 || lng > 137.8347) || (lat < 0.8293 || lat > 55.8271);
         }

         function transformLat(x, y) {
             let ret = -100.0 + 2.0 * x + 3.0 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * Math.sqrt(Math.abs(x));
             ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
             ret += (20.0 * Math.sin(y * PI) + 40.0 * Math.sin(y / 3.0 * PI)) * 2.0 / 3.0;
             ret += (160.0 * Math.sin(y / 12.0 * PI) + 320 * Math.sin(y * PI / 30.0)) * 2.0 / 3.0;
             return ret;
         }

         function transformLng(x, y) {
             let ret = 300.0 + x + 2.0 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * Math.sqrt(Math.abs(x));
             ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
             ret += (20.0 * Math.sin(x * PI) + 40.0 * Math.sin(x / 3.0 * PI)) * 2.0 / 3.0;
             ret += (150.0 * Math.sin(x / 12.0 * PI) + 300.0 * Math.sin(x / 30.0 * PI)) * 2.0 / 3.0;
             return ret;
         }
     }

     function gcj02ToWgs84(lng, lat) {
         const g = wgs84ToGcj02(lng, lat);
         return { lng: lng * 2 - g.lng, lat: lat * 2 - g.lat };
     }

     function bd09ToGcj02(bdLng, bdLat) {
         const x_PI = 3.14159265358979324 * 3000.0 / 180.0;
         const x = bdLng - 0.0065;
         const y = bdLat - 0.006;
         const z = Math.sqrt(x * x + y * y) - 0.00002 * Math.sin(y * x_PI);
         const theta = Math.atan2(y, x) - 0.000003 * Math.cos(x * x_PI);
         const ggLng = z * Math.cos(theta);
         const ggLat = z * Math.sin(theta);
         return { lng: ggLng, lat: ggLat };
     }

     function calculatePolygonBottomCenter(outerRing) {
         let minLat = Infinity;
         let bottomPoints = [];
         outerRing.forEach(point => {
             const lat = point[1];
             if (lat < minLat) {
                 minLat = lat;
                 bottomPoints = [point];
             } else if (lat === minLat) {
                 bottomPoints.push(point);
             }
         });

         const sumLng = bottomPoints.reduce((sum, point) => sum + point[0], 0);
         const centerLng = sumLng / bottomPoints.length;

         return { lng: centerLng, lat: minLat };
     }

     function fitBounds(geojson) {
         try {
             const allPoints = [];
             function collectPoints(coords) {
                 if (typeof coords[0] === 'number') {
                     allPoints.push(coords);
                 } else {
                     coords.forEach(coord => collectPoints(coord));
                 }
             }
             collectPoints(geojson.coordinates);

             if (allPoints.length === 0) return;

             const lats = allPoints.map(p => p[1]);
             const lngs = allPoints.map(p => p[0]);
             const minLng = Math.min(...lngs);
             const maxLng = Math.max(...lngs);
             const minLat = Math.min(...lats);
             const maxLat = Math.max(...lats);

             const sw = wgs84ToGcj02(minLng, minLat);
             const ne = wgs84ToGcj02(maxLng, maxLat);

             // 修复setViewport方法的使用，确保参数格式正确
             if (map && map.setViewport) {
                 map.setViewport([
                     new T.LngLat(sw.lng, sw.lat),
                     new T.LngLat(ne.lng, ne.lat)
                 ], { padding: [50, 50] });
             } else {
                 console.warn('地图对象或setViewport方法不可用');
             }
         } catch (error) {
             console.error('调整视图范围时出错:', error);
         }
     }
// 轨迹绘制与解析
    function bindTrackEvents() {
        const drawBtn = document.getElementById('drawTrackButton');
        const showPointsBtn = document.getElementById('showTrackPointsButton');
        const clearBtn = document.getElementById('clearTrackButton');
        const ta = document.getElementById('trackTextarea');
        if (!drawBtn || !showPointsBtn || !clearBtn || !ta) return;

        drawBtn.addEventListener('click', function(){
            try {
                const text = ta.value.trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const pointsWithTime = parseTrackTextWithTime(text);

                // 解析时间范围
                const timeRangeInput = document.getElementById('timeRangeInput');
                const timeRangeText = timeRangeInput ? timeRangeInput.value.trim() : '';
                let filteredPoints = pointsWithTime;

                if (timeRangeText) {
                    // 解析时间范围：格式如 "2025-10-23T13:56:49 - 2025-10-23T15:51:31"
                    const timeRangeMatch = timeRangeText.match(/^([\d-]+T[\d:]+)\s*-\s*([\d-]+T[\d:]+)$/);
                    if (timeRangeMatch) {
                        const startTimeStr = timeRangeMatch[1];
                        const endTimeStr = timeRangeMatch[2];

                        const startTime = new Date(startTimeStr);
                        const endTime = new Date(endTimeStr);

                        if (!isNaN(startTime.getTime()) && !isNaN(endTime.getTime())) {
                            filteredPoints = pointsWithTime.filter(point =>
                                point.time >= startTime && point.time <= endTime
                            );

                            if (filteredPoints.length < 2) {
                                alert('该时间范围内的有效轨迹点不足，至少需要两点');
                                return;
                            }
                        } else {
                            alert('时间范围格式不正确，请使用格式：2025-10-23T13:56:49 - 2025-10-23T15:51:31');
                            return;
                        }
                    } else {
                        alert('时间范围格式不正确，请使用格式：2025-10-23T13:56:49 - 2025-10-23T15:51:31');
                        return;
                    }
                }

                // 提取坐标点
                const points = filteredPoints.map(point => point.ll);

                if (points.length < 2) { alert('有效轨迹点不足，至少需要两点'); return; }
                drawTrackFromPoints(points);
                fitViewportToTrack(points);
            } catch (e) {
                alert('绘制轨迹失败：' + (e && e.message ? e.message : e));
                console.error('绘制轨迹异常:', e);
            }
        });

        showPointsBtn.addEventListener('click', function(){
            try {
                const text = ta.value.trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const pointsWithTime = parseTrackTextWithTime(text);
                if (pointsWithTime.length === 0) { alert('未找到有效轨迹点'); return; }

                // 解析时间范围
                const timeRangeInput = document.getElementById('timeRangeInput');
                const timeRangeText = timeRangeInput ? timeRangeInput.value.trim() : '';
                let filteredPointsWithTime = pointsWithTime;

                if (timeRangeText) {
                    // 解析时间范围：格式如 "2025-10-23T13:56:49 - 2025-10-23T15:51:31"
                    const timeRangeMatch = timeRangeText.match(/^([\d-]+T[\d:]+)\s*-\s*([\d-]+T[\d:]+)$/);
                    if (timeRangeMatch) {
                        const startTimeStr = timeRangeMatch[1];
                        const endTimeStr = timeRangeMatch[2];

                        const startTime = new Date(startTimeStr);
                        const endTime = new Date(endTimeStr);

                        if (!isNaN(startTime.getTime()) && !isNaN(endTime.getTime())) {
                            filteredPointsWithTime = pointsWithTime.filter(point =>
                                point.time >= startTime && point.time <= endTime
                            );

                            if (filteredPointsWithTime.length === 0) {
                                alert('该时间范围内没有找到轨迹点');
                                return;
                            }
                        } else {
                            alert('时间范围格式不正确，请使用格式：2025-10-23T13:56:49 - 2025-10-23T15:51:31');
                            return;
                        }
                    } else {
                        alert('时间范围格式不正确，请使用格式：2025-10-23T13:56:49 - 2025-10-23T15:51:31');
                        return;
                    }
                }

                // 传递包含时间信息的点对象
                showTrackPoints(filteredPointsWithTime);

                // 提取坐标点用于地图适配
                const points = filteredPointsWithTime.map(point => point.ll);
                fitViewportToTrack(points);
            } catch (e) {
                alert('显示轨迹点失败：' + (e && e.message ? e.message : e));
                console.error('显示轨迹点异常:', e);
            }
        });

        clearBtn.addEventListener('click', function(){
            clearTrackOverlays();
            console.log('已清空轨迹');
        });
    }

    function showTrackPoints(pointsWithTime) {
        // 先移除旧轨迹（不影响轮廓）
        clearTrackOverlays(false);

        if (!map || !pointsWithTime || pointsWithTime.length === 0) {
            console.log('无轨迹点可显示');
            return;
        }

        console.log(`准备显示${pointsWithTime.length}个轨迹点`);

        // 使用批量处理和更小的图标来提高性能
        // 创建一个更小的自定义颜色点SVG图标
        const smallColoredDotIcon = new T.Icon({
            iconUrl: `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1" height="1"><circle cx="0.5" cy="0.5" r="0.3" fill="%23${currentTrackPointColor.substring(1)}"/></svg>`,
            iconSize: new T.Point(1, 1),
            iconAnchor: new T.Point(0.5, 0.5)
        });

        // 优化批量添加点的速度
        const batchSize = 2000; // 增加每批处理的点数
        const concurrentBatches = 4; // 并发批次数量

        // 预创建点击事件处理函数，避免重复创建
        function createClickHandler(pointWithTime, index) {
            return function() {
                // 格式化时间显示
                const formattedTime = pointWithTime.time.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });

                const infoWindow = new T.InfoWindow({
                    content: `点${index + 1}<br/>经度: ${pointWithTime.ll.lng.toFixed(6)}<br/>纬度: ${pointWithTime.ll.lat.toFixed(6)}<br/>时间: ${formattedTime}`,
                    offset: new T.Point(0, -20)
                });
                infoWindow.open(map, pointWithTime.ll);
            };
        }

        // 使用setTimeout实现更高效的批量添加，避免阻塞UI
        let currentIndex = 0;

        function addBatch() {
            if (currentIndex >= pointsWithTime.length) {
                console.log(`已显示${pointsWithTime.length}个轨迹点`);
                return;
            }

            // 添加当前批次的点
            const endIndex = Math.min(currentIndex + batchSize, pointsWithTime.length);
            const markersToAdd = [];

            // 先创建所有标记
            for (let i = currentIndex; i < endIndex; i++) {
                const pointWithTime = pointsWithTime[i];
                const index = i;

                const marker = new T.Marker(pointWithTime.ll, {
                    icon: smallColoredDotIcon
                });

                // 添加点击事件
                marker.addEventListener('click', createClickHandler(pointWithTime, index));

                markersToAdd.push(marker);
            }

            // 批量添加到地图和数组
            markersToAdd.forEach(marker => {
                map.addOverLay(marker);
                currentTracks.push(marker);
            });

            currentIndex = endIndex;

            // 使用setTimeout而不是requestAnimationFrame，减少对渲染周期的依赖
            // 设置为0，将任务放入微任务队列，但允许UI有短暂的呼吸空间
            setTimeout(addBatch, 0);
        }

        // 启动批量添加
        addBatch();
    }

    // 恢复原始的clearTrackOverlays函数
    function clearTrackOverlays(resetArray = true){
        try {
            currentTracks.forEach(pl => {
                if (pl && map && map.removeOverLay) {
                    try { map.removeOverLay(pl); } catch (e) { console.warn('移除轨迹失败:', e); }
                }
            });
            if (resetArray) currentTracks = [];
        } catch (e) {
            console.warn('清空轨迹时出错:', e);
        }
    }

    function parseTrackText(text){
        // 选择输入坐标系（优先使用轨迹页签专属选择器，若未设置则回退到绘制页签选择器）
        const coordSysEl = document.getElementById('trackCoordSysSelect') || document.getElementById('coordSysSelect');
        const coordSys = (coordSysEl && coordSysEl.value) || 'wgs84';
        const isHash = text.indexOf('#') !== -1;
        const items = isHash ? text.split('#') : text.split(/\r?\n/);
        const pts = [];
        for (let i=0;i<items.length;i++){
            const raw = items[i];
            if (!raw) continue;
            const line = raw.trim();
            if (!line) continue;
            const splitParts = line.split(',');
            if (splitParts.length < 3) continue;
            let lng = parseFloat((splitParts[isHash ? 0 : 1] || '').trim());
            let lat = parseFloat((splitParts[isHash ? 1 : 2] || '').trim());
            // 初步过滤：数值合法性与正常范围
            if (!isFinite(lng) || !isFinite(lat)) continue;
            if (lng === 0 || lat === 0) continue; // 丢弃0.0异常点
            if (lng < -180 || lng > 180 || lat < -90 || lat > 90) continue; // 超出经纬度范围丢弃

            // 将输入坐标转换为WGS84
            let w;
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                w = { lng, lat };
            } else if (coordSys === 'gcj02') {
                w = gcj02ToWgs84(lng, lat);
            } else if (coordSys === 'bd09') {
                const g = bd09ToGcj02(lng, lat);
                w = gcj02ToWgs84(g.lng, g.lat);
            } else {
                w = { lng, lat };
            }
            // 转换结果兜底检查
            if (!isFinite(w.lng) || !isFinite(w.lat)) continue;
            if (w.lng < -180 || w.lng > 180 || w.lat < -90 || w.lat > 90) continue;

            // 使用WGS84坐标绘制到地图
            pts.push(new T.LngLat(w.lng, w.lat));
        }
        return pts;
    }

    function drawTrackFromPoints(points){
        // 先移除旧轨迹（不影响轮廓）
        clearTrackOverlays(false);
        const polyline = new T.Polyline(points, {
            color: currentTrackLineColor,
            weight: 1,
            opacity: 0.9
        });
        if (map) {
            map.addOverLay(polyline);
        }
        currentTracks.push(polyline);
    }

    function clearTrackOverlays(resetArray = true){
        try {
            currentTracks.forEach(pl => {
                if (pl && map && map.removeOverLay) {
                    try { map.removeOverLay(pl); } catch (e) { console.warn('移除轨迹失败:', e); }
                }
            });
            if (resetArray) currentTracks = [];
        } catch (e) {
            console.warn('清空轨迹时出错:', e);
        }
    }


    function fitViewportToTrack(points){
        try {
            if (!map || !map.setViewport || !points || !points.length) return;
            map.setViewport(points);
        } catch (e) {
            console.warn('轨迹视图居中失败:', e);
        }
    }

    // ========= 轨迹回放功能 =========
    let playbackState = { points: [], idx: 0, speed: 1, timer: null, running: false, marker: null, line: null, path: [] };

    function bindPlaybackControls(){
        const startBtn = document.getElementById('playbackStartBtn');
        const pauseBtn = document.getElementById('playbackPauseBtn');
        const stopBtn = document.getElementById('playbackStopBtn');
        const speedSel = document.getElementById('playbackSpeedSelect');
        const timeSlider = document.getElementById('playbackTimeSlider');
        const timeCursor = document.getElementById('playbackTimeCursor');
        const ta = document.getElementById('trackTextarea');
        if (!startBtn || !pauseBtn || !stopBtn || !speedSel) return;

        // 初始按钮状态
        updatePlaybackButtonsState('idle');

        startBtn.addEventListener('click', function(){
            try {
                const text = (ta && ta.value || '').trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const pts = parseTrackTextWithTime(text);
                if (pts.length < 2) { alert('有效轨迹点不足，至少需要两点'); return; }

                // 解析时间范围
                const timeRangeInput = document.getElementById('timeRangeInput');
                const timeRangeText = timeRangeInput ? timeRangeInput.value.trim() : '';
                let filteredPoints = pts;

                if (timeRangeText) {
                    // 解析时间范围：格式如 "2025-10-23T13:56:49 - 2025-10-23T15:51:31"
                    const timeRangeMatch = timeRangeText.match(/^([\d-]+T[\d:]+)\s*-\s*([\d-]+T[\d:]+)$/);
                    if (timeRangeMatch) {
                        const startTimeStr = timeRangeMatch[1];
                        const endTimeStr = timeRangeMatch[2];

                        const startTime = new Date(startTimeStr);
                        const endTime = new Date(endTimeStr);

                        if (!isNaN(startTime.getTime()) && !isNaN(endTime.getTime())) {
                            filteredPoints = pts.filter(point =>
                                point.time >= startTime && point.time <= endTime
                            );

                            if (filteredPoints.length < 2) {
                                alert('该时间范围内的有效轨迹点不足，至少需要两点');
                                return;
                            }
                        } else {
                            alert('时间范围格式不正确，请使用格式：2025-10-23T13:56:49 - 2025-10-23T15:51:31');
                            return;
                        }
                    } else {
                        alert('时间范围格式不正确，请使用格式：2025-10-23T13:56:49 - 2025-10-23T15:51:31');
                        return;
                    }
                }

                startPlayback(filteredPoints);
                // 状态在startPlayback中已设置为playing
            } catch (e) {
                alert('开始回放失败：' + (e && e.message ? e.message : e));
                console.error('开始回放异常:', e);
            }
        });

        pauseBtn.addEventListener('click', function(){
            if (!playbackState.running) {
                // 继续
                playbackState.running = true;
                scheduleNext();
                updatePlaybackButtonsState('playing');
            } else {
                // 暂停
                if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
                playbackState.running = false;
                updatePlaybackButtonsState('paused');
            }
        });

        stopBtn.addEventListener('click', function(){
            stopPlayback();
            updatePlaybackButtonsState('idle');
        });

        speedSel.addEventListener('change', function(){
            const v = parseFloat(speedSel.value);
            playbackState.speed = (isFinite(v) && v > 0) ? v : 1;
        });

        if (timeSlider) {
            timeSlider.addEventListener('input', function(){
                const ms = parseInt(timeSlider.value, 10);
                const txt = formatTimeForLabel(ms);
                if (timeCursor) timeCursor.textContent = txt;
            });
            timeSlider.addEventListener('change', function(){
                jumpToSliderTime();
            });
        }
    }

    function parseTrackTextWithTime(text){
        const coordSysEl = document.getElementById('trackCoordSysSelect') || document.getElementById('coordSysSelect');
        const coordSys = (coordSysEl && coordSysEl.value) || 'wgs84';
        const isHash = text.indexOf('#') !== -1;
        const items = isHash ? text.split('#') : text.split(/\r?\n/);
        const out = [];
        for (let i=0;i<items.length;i++){
            const raw = items[i];
            if (!raw) continue;
            const line = raw.trim();
            if (!line) continue;
            const splitParts = line.split(',');
            if (splitParts.length < 3) continue;
            const tsRaw = (splitParts[isHash ? 2 : 0] || '').trim();
            const ts = (tsRaw || '').replace(/\D/g,'');
            let lng = parseFloat((splitParts[isHash ? 0 : 1] || '').trim());
            let lat = parseFloat((splitParts[isHash ? 1 : 2] || '').trim());
            if (!isFinite(lng) || !isFinite(lat)) continue;
            if (lng === 0 || lat === 0) continue;
            if (lng < -180 || lng > 180 || lat < -90 || lat > 90) continue;
            const t = parseTimestamp(ts);
            if (!t) continue;
            let w;
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                w = { lng, lat };
            } else if (coordSys === 'gcj02') {
                w = gcj02ToWgs84(lng, lat);
            } else if (coordSys === 'bd09') {
                const g = bd09ToGcj02(lng, lat);
                w = gcj02ToWgs84(g.lng, g.lat);
            } else { w = { lng, lat }; }
            if (!isFinite(w.lng) || !isFinite(w.lat)) continue;
            if (w.lng < -180 || w.lng > 180 || w.lat < -90 || w.lat > 90) continue;
            out.push({ ll: new T.LngLat(w.lng, w.lat), time: t, ts });
        }
        out.sort((a,b)=>a.time - b.time);
        return out;
    }

    function parseTimestamp(ts){
        const tstr = (ts || '').replace(/\D/g,'');
        const m = tstr && tstr.match(/^\d{14}$/);
        if (!m) return null;
        const y = parseInt(tstr.slice(0,4),10);
        const M = parseInt(tstr.slice(4,6),10) - 1;
        const d = parseInt(tstr.slice(6,8),10);
        const h = parseInt(tstr.slice(8,10),10);
        const m2 = parseInt(tstr.slice(10,12),10);
        const s = parseInt(tstr.slice(12,14),10);
        const dt = new Date(y,M,d,h,m2,s);
        return isNaN(dt.getTime()) ? null : dt;
    }

    function startPlayback(points){
        console.log('[Playback] startPlayback: 点数=', points && points.length);
        stopPlayback();
        playbackState.points = points;
        playbackState.idx = 0;
        playbackState.speed = playbackState.speed || 1;
        playbackState.running = true;
        // 配置时间滑动条，并尊重现有滑块位置作为起始
        configureTimeSlider(points);
        // 启用滑块
        const slider = document.getElementById('playbackTimeSlider');
        if (slider) slider.disabled = false;
        let initIdx = 0;
        if (slider && slider.min && slider.max) {
            const ms = parseInt(slider.value, 10);
            if (isFinite(ms)) initIdx = findIndexByTime(points, ms);
        }
        playbackState.idx = initIdx;
        const first = points[initIdx];
        console.log('[Playback] 首点:', first && first.ts, first && first.ll, 'initIdx=', initIdx);
        playbackState.path = points.slice(0, initIdx+1).map(p=>p.ll);
        playbackState.line = new T.Polyline(playbackState.path, { color: currentTrackLineColor, weight: 1, opacity: 0.9 });
        if (map) {
            map.addOverLay(playbackState.line);
        }
        currentTracks.push(playbackState.line);
        // 创建并定位DOM标记以保证可见移动
        ensurePlaybackDom(first.ll);
        updatePlaybackDom(first.ll);
        updatePlaybackTimeLabel(first.ts);
        try { fitViewportToTrack(points.map(p=>p.ll)); } catch(e){}
        // 更新按钮状态
        updatePlaybackButtonsState('playing');
        scheduleNext();
    }

    function scheduleNext(){
        if (!playbackState.running) return;
        if (!playbackState.points || playbackState.idx >= playbackState.points.length - 1) {
            playbackState.running = false;
            console.log('[Playback] 回放结束：idx=', playbackState.idx, '点数=', playbackState.points ? playbackState.points.length : 0);
            updatePlaybackButtonsState('idle'); // 播放结束后按钮回到初始状态：开始可点，继续/结束灰化
            return;
        }
        const next = playbackState.points[playbackState.idx+1];
        const speed = playbackState.speed || 1;
        const delay = Math.max(4, Math.round(1000 / speed)); // 1x=1000ms/点，2x=500ms/点...
        console.log('[Playback] scheduleNext: idx=', playbackState.idx, '->', playbackState.idx+1, 'delay=', delay, 'speed=', speed);
        playbackState.timer = setTimeout(()=>{
            playbackState.idx++;
            const nextLL = next.ll;
            console.log('[Playback] 下一点:', next && next.ts, nextLL);
            try {
                // 维护路径数组
                playbackState.path = playbackState.path || [];
                playbackState.path.push(nextLL);
                console.log('[Playback] 路径长度=', playbackState.path.length);
                // 使用DOM标记进行移动（容器/图层坐标）
                if (!playbackDom.el) console.log('[Playback] DOM标记不存在，将尝试创建');
                updatePlaybackDom(nextLL);
                // 折线更新：优先setLngLats，兜底重建
                if (playbackState.line && typeof playbackState.line.setLngLats === 'function') {
                    try { playbackState.line.setLngLats(playbackState.path); }
                    catch(e){
                        console.warn('[Playback] setLngLats失败，重建折线', e);
                        if (map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                        playbackState.line = new T.Polyline(playbackState.path, { color: currentTrackLineColor, weight: 1, opacity: 0.9 });
                        if (map) map.addOverLay(playbackState.line);
                    }
                } else {
                    console.log('[Playback] 折线不支持setLngLats，重建');
                    if (playbackState.line && map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                    playbackState.line = new T.Polyline(playbackState.path, { color: currentTrackLineColor, weight: 1, opacity: 0.9 });
                    if (map) map.addOverLay(playbackState.line);
                }
            } catch(e) { console.warn('更新回放覆盖物失败:', e); }
            updatePlaybackTimeLabel(next.ts);
            scheduleNext();
        }, delay);
    }

    function stopPlayback(){
        if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
        playbackState.running = false;
        playbackState.idx = 0;
        try {
            // 移除DOM标记
            removePlaybackDom();
            if (playbackState.marker && map) map.removeOverLay(playbackState.marker);
            if (playbackState.line && map) map.removeOverLay(playbackState.line);
        } catch(e){}
        playbackState.marker = null;
        playbackState.line = null;
        updatePlaybackTimeLabel('—');
        // 按钮回到初始状态
        updatePlaybackButtonsState('idle');
    }

    function updatePlaybackTimeLabel(text){
        const el = document.getElementById('playbackTimeLabel');
        if (el) el.textContent = '时间：' + (text || '—');
    }

    // 时间滑动条：配置与跳转
    function configureTimeSlider(points){
        try {
            const slider = document.getElementById('playbackTimeSlider');
            const cursor = document.getElementById('playbackTimeCursor');
            if (!slider || !points || !points.length) return;
            const minMs = points[0].time.getTime();
            const maxMs = points[points.length - 1].time.getTime();
            const prev = parseInt(slider.value, 10);
            slider.min = String(minMs);
            slider.max = String(maxMs);
            slider.step = '1000'; // 以秒为步进
            let val = (isFinite(prev) && prev >= minMs && prev <= maxMs) ? prev : minMs;
            slider.value = String(val);
            if (cursor) cursor.textContent = formatTimeForLabel(val);
        } catch(e) { console.warn('配置时间滑动条失败:', e); }
    }
    function formatTimeForLabel(ms){
        if (!isFinite(ms)) return '—';
        const d = new Date(ms);
        const pad = n => String(n).padStart(2,'0');
        const y = d.getFullYear();
        const M = pad(d.getMonth()+1);
        const da = pad(d.getDate());
        const h = pad(d.getHours());
        const m = pad(d.getMinutes());
        const s = pad(d.getSeconds());
        return `${y}-${M}-${da} ${h}:${m}:${s}`;
    }
    function findIndexByTime(points, ms){
        try {
            if (!points || !points.length) return 0;
            const n = points.length;
            const minMs = points[0].time.getTime();
            const maxMs = points[n-1].time.getTime();
            if (!isFinite(ms)) return 0;
            if (ms <= minMs) return 0;
            if (ms >= maxMs) return n-1;
            let lo = 0, hi = n - 1, ans = 0;
            while (lo <= hi) {
                const mid = (lo + hi) >> 1;
                const t = points[mid].time.getTime();
                if (t < ms) { lo = mid + 1; ans = lo; }
                else { hi = mid - 1; ans = mid; }
            }
            return Math.max(0, Math.min(n-1, ans));
        } catch(e){ console.warn('findIndexByTime失败:', e); return 0; }
    }
    function jumpToSliderTime(){
        try {
            const slider = document.getElementById('playbackTimeSlider');
            if (!slider || !playbackState.points || !playbackState.points.length) return;
            const ms = parseInt(slider.value, 10);
            if (!isFinite(ms)) return;
            const idx = findIndexByTime(playbackState.points, ms);
            playbackState.idx = idx;
            const pts = playbackState.points;
            const ll = pts[idx].ll;
            playbackState.path = pts.slice(0, idx+1).map(p=>p.ll);
            // 更新折线
            try {
                if (playbackState.line && typeof playbackState.line.setLngLats === 'function') {
                    playbackState.line.setLngLats(playbackState.path);
                } else {
                    if (playbackState.line && map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                    playbackState.line = new T.Polyline(playbackState.path, { color: currentTrackLineColor, weight: 1, opacity: 0.9 });
                    if (map) map.addOverLay(playbackState.line);
                }
            } catch(e){ console.warn('滑块更新折线失败:', e); }
            // 更新标记与时间
            ensurePlaybackDom(ll);
            updatePlaybackDom(ll);
            updatePlaybackTimeLabel(pts[idx].ts);
            // 若正在播放，立即按新位置继续
            if (playbackState.running) {
                if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
                scheduleNext();
            }
        } catch(e) { console.warn('滑块跳转失败:', e); }
    }

    // DOM标记：使用容器坐标实现可见移动
    let playbackDom = { el: null, lastLL: null, bound: false };

    function ensurePlaybackDom(ll){
        try {
            playbackDom.lastLL = ll;
            const pane = (map && map.getPanes && map.getPanes().overlayPane) || document.getElementById('mapContainer');
            if (!pane) { console.warn('未找到overlayPane或mapContainer'); return; }
            if (!playbackDom.el) {
                const el = document.createElement('div');
                el.id = 'playbackDomMarker';
                el.style.position = 'absolute';
                el.style.width = '0';
                el.style.height = '0';
                el.style.borderLeft = '3px solid transparent';
                el.style.borderRight = '3px solid transparent';
                el.style.borderBottom = '4px solid #2C64A7';
                el.style.borderTop = '0';
                el.style.transform = 'translate(-50%, -50%)';
                el.style.zIndex = '9999';
                // 添加伪元素来增强箭头效果
                el.style.clipPath = 'polygon(50% 0, 100% 100%, 0 100%)';
                pane.appendChild(el);
                playbackDom.el = el;
                console.log('[Playback] 创建DOM标记，父节点=', pane === document.getElementById('mapContainer') ? '#mapContainer' : 'overlayPane');
                bindPlaybackDomEvents();
            }
            updatePlaybackDom(ll);
        } catch(e) { console.warn('创建DOM标记失败:', e); }
    }

    function updatePlaybackDom(ll){
        try {
            playbackDom.lastLL = ll;
            if (!map || !playbackDom.el || !ll) { console.log('[Playback] update取消：map/el/ll缺失'); return; }
            let p;
            if (typeof map.lngLatToLayerPoint === 'function') {
                p = map.lngLatToLayerPoint(ll);
                console.log('[Playback] 使用layerPoint定位:', ll && ll.lng, ll && ll.lat, '=>', p && p.x, p && p.y);
            } else if (typeof map.lngLatToContainerPoint === 'function') {
                p = map.lngLatToContainerPoint(ll);
                console.log('[Playback] 使用containerPoint定位:', ll && ll.lng, ll && ll.lat, '=>', p && p.x, p && p.y);
            } else {
                console.warn('地图对象不支持lngLat到像素坐标转换');
                return;
            }
            playbackDom.el.style.left = p.x + 'px';
            playbackDom.el.style.top = p.y + 'px';
        } catch(e) { console.warn('更新DOM标记位置失败:', e); }
    }

    function bindPlaybackDomEvents(){
        if (playbackDom.bound) return;
        const updater = function(){
            try {
                if (!map || !playbackDom.el || !playbackDom.lastLL) return;
                let p;
                if (typeof map.lngLatToLayerPoint === 'function') {
                    p = map.lngLatToLayerPoint(playbackDom.lastLL);
                } else if (typeof map.lngLatToContainerPoint === 'function') {
                    p = map.lngLatToContainerPoint(playbackDom.lastLL);
                }
                if (!p) return;
                playbackDom.el.style.left = p.x + 'px';
                playbackDom.el.style.top = p.y + 'px';
            } catch(e){}
        };
        try {
            map.addEventListener('move', updater);
            map.addEventListener('zoom', updater);
            playbackDom.bound = true;
        } catch(e){}
    }

    function removePlaybackDom(){
        try {
            const el = playbackDom.el;
            playbackDom.lastLL = null;
            if (el && el.parentNode) el.parentNode.removeChild(el);
        } catch(e){}
        playbackDom.el = null;
        playbackDom.bound = false;
    }

    // 测量功能相关变量
    let measureState = {
        isActive: false,
        mode: '', // 'distance' or 'area'
        points: [],
        tempLine: null,
        lines: [],
        markers: [],
        labels: [],
        polygon: null,
        areaLabel: null
    };

    // 绑定测量按钮事件
    function bindMeasureEvents() {
        const distanceBtn = document.getElementById('measureDistanceBtn');
        const areaBtn = document.getElementById('measureAreaBtn');

        if (distanceBtn) {
            distanceBtn.addEventListener('click', function() {
                startMeasureDistance();
            });
        }

        if (areaBtn) {
            areaBtn.addEventListener('click', function() {
                startMeasureArea();
            });
        }
    }

    // 绑定地图类型切换按钮事件
    function bindMapTypeEvent() {
        const mapTypeBtn = document.getElementById('mapTypeBtn');

        if (mapTypeBtn) {
            mapTypeBtn.addEventListener('click', function() {
                toggleMapType();
            });
        }
    }

    // 切换地图类型
    function toggleMapType() {
        if (!map) {
            alert('地图未初始化');
            return;
        }

        // 切换地图类型
        if (currentMapType === 'satellite') {
            // 切换到街道地图
            map.setMapType(TMAP_NORMAL_MAP);
            currentMapType = 'street';
            updateMapTypeButton('街道图');
        } else {
            // 切换到卫星地图
            map.setMapType(TMAP_SATELLITE_MAP);
            currentMapType = 'satellite';
            updateMapTypeButton('卫星图');
        }
    }

    // 更新地图类型按钮显示
    function updateMapTypeButton(typeName) {
        const mapTypeBtn = document.getElementById('mapTypeBtn');
        if (mapTypeBtn) {
            mapTypeBtn.innerHTML = `<span>${typeName}</span>`;
            mapTypeBtn.title = `当前：${typeName}，点击切换`;
        }
    }

    // 开始测距
    function startMeasureDistance() {
        if (!map) {
            alert('地图未初始化');
            return;
        }

        // 先移除所有可能存在的事件监听器
        try {
            map.removeEventListener('click', handleMapClick);
            map.removeEventListener('click', handleAreaMapClick);
            map.removeEventListener('mousemove', handleMouseMove);
            map.removeEventListener('mousemove', handleAreaMouseMove);
            map.removeEventListener('dblclick', finishMeasure);
            map.removeEventListener('dblclick', finishAreaMeasure);
        } catch(e) {
            console.log('移除事件监听器时出错:', e);
        }

        // 重置测量状态
        clearMeasureResult();

        // 设置测量状态为激活
        measureState.isActive = true;
        measureState.mode = 'distance'; // 设置为距离测量模式

        // 禁用其他按钮
        disableButtons(true);

        // 添加地图点击事件监听器
        map.addEventListener('click', handleMapClick);

        // 添加鼠标移动事件监听器
        map.addEventListener('mousemove', handleMouseMove);

        // 添加双击事件监听器结束测量
        map.addEventListener('dblclick', finishMeasure);

        console.log('测距功能已启动');
    }

    // 开始测面
    function startMeasureArea() {
        if (!map) {
            alert('地图未初始化');
            return;
        }

        // 先移除所有可能存在的事件监听器
        try {
            map.removeEventListener('click', handleMapClick);
            map.removeEventListener('click', handleAreaMapClick);
            map.removeEventListener('mousemove', handleMouseMove);
            map.removeEventListener('mousemove', handleAreaMouseMove);
            map.removeEventListener('dblclick', finishMeasure);
            map.removeEventListener('dblclick', finishAreaMeasure);
        } catch(e) {
            console.log('移除事件监听器时出错:', e);
        }

        // 重置测量状态
        clearMeasureResult();

        // 设置测量状态为激活
        measureState.isActive = true;
        measureState.mode = 'area'; // 设置为面积测量模式

        // 禁用其他按钮
        disableButtons(true);

        // 添加地图点击事件监听器
        map.addEventListener('click', handleAreaMapClick);

        // 添加鼠标移动事件监听器
        map.addEventListener('mousemove', handleAreaMouseMove);

        // 添加双击事件监听器结束测量
        map.addEventListener('dblclick', finishAreaMeasure);

        console.log('测面功能已启动');
    }

    // 处理地图点击事件
    function handleMapClick(event) {
        if (!measureState.isActive || measureState.mode !== 'distance') return;

        const point = event.lnglat;
        measureState.points.push(point);

        // 创建小圆点图标
        const smallDotIcon = new T.Icon({
            iconUrl: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8"><circle cx="4" cy="4" r="3" fill="%23FF0000" stroke="%23FFFFFF" stroke-width="1"/></svg>',
            iconSize: new T.Point(8, 8),
            iconAnchor: new T.Point(4, 4)
        });

        // 创建点标记
        const marker = new T.Marker(point, {icon: smallDotIcon});
        map.addOverLay(marker);
        measureState.markers.push(marker);

        // 如果不是第一个点，创建线段
        if (measureState.points.length > 1) {
            const prevPoint = measureState.points[measureState.points.length - 2];
            const line = new T.Polyline([prevPoint, point], {
                color: '#FF0000',
                weight: 3,
                opacity: 0.8
            });
            map.addOverLay(line);
            measureState.lines.push(line);

            // 计算距离并显示标签
            const distance = calculateDistance(prevPoint, point);
            showDistanceLabel(point, distance);
        }

        // 移除临时线
        if (measureState.tempLine) {
            map.removeOverLay(measureState.tempLine);
            measureState.tempLine = null;
        }
    }

    // 处理测面地图点击事件
    function handleAreaMapClick(event) {
        if (!measureState.isActive || measureState.mode !== 'area') return;

        const point = event.lnglat;
        measureState.points.push(point);

        // 创建小圆点图标（与测距功能一致）
        const smallDotIcon = new T.Icon({
            iconUrl: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8"><circle cx="4" cy="4" r="3" fill="%23FF0000" stroke="%23FFFFFF" stroke-width="1"/></svg>',
            iconSize: new T.Point(8, 8),
            iconAnchor: new T.Point(4, 4)
        });

        // 创建点标记
        const marker = new T.Marker(point, {icon: smallDotIcon});
        map.addOverLay(marker);
        measureState.markers.push(marker);

        // 移除之前的多边形
        if (measureState.polygon) {
            map.removeOverLay(measureState.polygon);
        }

        // 如果点数大于2，创建多边形
        if (measureState.points.length >= 3) {
            const polygon = new T.Polygon(measureState.points, {
                color: currentOutlineColor,
                weight: 3,
                opacity: 0.8,
                fillColor: currentFillColor,
                fillOpacity: currentFillOpacity
            });
            map.addOverLay(polygon);
            measureState.polygon = polygon;

            // 计算面积并显示标签
            const area = calculatePolygonArea(measureState.points);
            showAreaLabel(getPolygonCenter(measureState.points), area);
        }

        // 移除临时线
        if (measureState.tempLine) {
            map.removeOverLay(measureState.tempLine);
            measureState.tempLine = null;
        }
    }

    // 处理鼠标移动事件
    function handleMouseMove(event) {
        if (!measureState.isActive || measureState.mode !== 'distance' || measureState.points.length === 0) return;

        const lastPoint = measureState.points[measureState.points.length - 1];
        const currentPoint = event.lnglat;

        // 移除之前的临时线
        if (measureState.tempLine) {
            map.removeOverLay(measureState.tempLine);
        }

        // 创建新的临时线
        measureState.tempLine = new T.Polyline([lastPoint, currentPoint], {
            color: '#0000FF',
            weight: 2,
            opacity: 0.6,
            dashArray: [5, 5]
        });
        map.addOverLay(measureState.tempLine);
    }

    // 处理测面鼠标移动事件
    function handleAreaMouseMove(event) {
        if (!measureState.isActive || measureState.mode !== 'area' || measureState.points.length === 0) return;

        const firstPoint = measureState.points[0];
        const lastPoint = measureState.points[measureState.points.length - 1];
        const currentPoint = event.lnglat;

        // 移除之前的临时线
        if (measureState.tempLine) {
            map.removeOverLay(measureState.tempLine);
        }

        // 创建新的临时线（从最后一个点到当前点，再到第一个点形成闭合效果）
        const tempPoints = [lastPoint, currentPoint];
        if (measureState.points.length >= 2) {
            tempPoints.push(firstPoint);
        }

        measureState.tempLine = new T.Polyline(tempPoints, {
            color: '#0000FF',
            weight: 2,
            opacity: 0.6,
            dashArray: [5, 5]
        });
        map.addOverLay(measureState.tempLine);
    }

    // 结束测量
    function finishMeasure() {
        if (!measureState.isActive || measureState.mode !== 'distance') return;

        // 移除事件监听器
        map.removeEventListener('click', handleMapClick);
        map.removeEventListener('mousemove', handleMouseMove);
        map.removeEventListener('dblclick', finishMeasure);

        // 移除临时线
        if (measureState.tempLine) {
            map.removeOverLay(measureState.tempLine);
            measureState.tempLine = null;
        }

        // 显示总距离
        if (measureState.points.length > 1) {
            const totalDistance = calculateTotalDistance();
            showTotalDistanceLabel(totalDistance);
        }

        // 重置测量状态
        measureState.isActive = false;
        measureState.mode = '';

        // 恢复其他按钮
        disableButtons(false);

        console.log('测距功能已完成');
    }

    // 结束测面测量
    function finishAreaMeasure() {
        if (!measureState.isActive || measureState.mode !== 'area') return;

        // 移除事件监听器
        map.removeEventListener('click', handleAreaMapClick);
        map.removeEventListener('mousemove', handleAreaMouseMove);
        map.removeEventListener('dblclick', finishAreaMeasure);

        // 移除临时线
        if (measureState.tempLine) {
            map.removeOverLay(measureState.tempLine);
            measureState.tempLine = null;
        }

        // 如果点数大于等于3，创建最终多边形
        if (measureState.points.length >= 3) {
            // 移除之前的多边形
            if (measureState.polygon) {
                map.removeOverLay(measureState.polygon);
            }

            const polygon = new T.Polygon(measureState.points, {
                color: currentOutlineColor,
                weight: 3,
                opacity: 0.8,
                fillColor: currentFillColor,
                fillOpacity: currentFillOpacity
            });
            map.addOverLay(polygon);
            measureState.polygon = polygon;

            // 计算并显示总面积
            const area = calculatePolygonArea(measureState.points);
            showTotalAreaLabel(getPolygonCenter(measureState.points), area);
        } else {
            // 点数不足3个，移除所有标记
            clearMeasureResult();
        }

        // 重置测量状态
        measureState.isActive = false;
        measureState.mode = '';

        // 恢复其他按钮
        disableButtons(false);

        console.log('测面功能已完成');
    }

    // 计算两点间距离（米）
    function calculateDistance(point1, point2) {
        // 使用天地图提供的距离计算方法
        if (T.CRS && T.CRS.EPSG4326 && T.CRS.EPSG4326.distance) {
            return T.CRS.EPSG4326.distance(point1, point2);
        }

        // 如果没有提供，则使用球面距离公式
        const R = 6371000; // 地球半径（米）
        const dLat = (point2.lat - point1.lat) * Math.PI / 180;
        const dLon = (point2.lng - point1.lng) * Math.PI / 180;
        const a =
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(point1.lat * Math.PI / 180) * Math.cos(point2.lat * Math.PI / 180) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    // 计算多边形面积（平方米）
    function calculatePolygonArea(points) {
        // 使用天地图提供的面积计算方法（如果可用）
        if (T.GeometryUtils && T.GeometryUtils.computeArea) {
            return T.GeometryUtils.computeArea(points);
        }

        // 如果没有提供，则使用球面多边形面积计算公式
        // 这里使用简单的平面近似计算，对于小面积比较准确
        if (points.length < 3) return 0;

        let area = 0;
        const n = points.length;

        for (let i = 0; i < n; i++) {
            const j = (i + 1) % n;
            area += points[i].lng * points[j].lat;
            area -= points[j].lng * points[i].lat;
        }

        area = Math.abs(area) / 2.0;

        // 转换为平方米（这是一个简化的近似值）
        // 更精确的计算需要考虑地球曲率
        const earthRadius = 6371000; // 地球半径（米）
        const degreeToMeter = (2 * Math.PI * earthRadius) / 360; // 每度对应的米数

        // 这个转换只是一个粗略的近似
        return area * degreeToMeter * degreeToMeter;
    }

    // 获取多边形中心点
    function getPolygonCenter(points) {
        if (points.length === 0) return null;

        let x = 0, y = 0;
        for (let i = 0; i < points.length; i++) {
            x += points[i].lng;
            y += points[i].lat;
        }

        return new T.LngLat(x / points.length, y / points.length);
    }

    // 计算总距离
    function calculateTotalDistance() {
        let total = 0;
        for (let i = 1; i < measureState.points.length; i++) {
            const distance = calculateDistance(measureState.points[i-1], measureState.points[i]);
            total += distance;
        }
        return total;
    }

    // 显示两点间距离标签
    function showDistanceLabel(point, distance) {
        const label = document.createElement('div');
        label.className = 'distance-label';
        label.innerHTML = distance.toFixed(2) + ' 米';
        label.style.position = 'absolute';
        label.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
        label.style.padding = '2px 6px';
        label.style.borderRadius = '3px';
        label.style.fontSize = '12px';
        label.style.boxShadow = '0 1px 2px rgba(0,0,0,0.3)';
        label.style.zIndex = '1000';
        label.style.transform = 'translate(-50%, -50%)';

        // 添加删除按钮
        const closeBtn = document.createElement('span');
        closeBtn.innerHTML = '×';
        closeBtn.style.marginLeft = '5px';
        closeBtn.style.cursor = 'pointer';
        closeBtn.style.fontWeight = 'bold';
        closeBtn.onclick = function() {
            if (label.parentNode) {
                label.parentNode.removeChild(label);
            }
        };
        label.appendChild(closeBtn);

        document.getElementById('mapContainer').appendChild(label);

        // 定位标签（向上偏移20像素）
        const pixel = map.lngLatToContainerPoint(point);
        label.style.left = pixel.x + 'px';
        label.style.top = (pixel.y - 20) + 'px';

        measureState.labels.push(label);
    }

    // 显示面积标签
    function showAreaLabel(point, area) {
        // 如果已存在面积标签，先移除它
        if (measureState.areaLabel) {
            if (measureState.areaLabel.parentNode) {
                measureState.areaLabel.parentNode.removeChild(measureState.areaLabel);
            }
        }

        const label = document.createElement('div');
        label.className = 'area-label';
        label.innerHTML = area.toFixed(2) + ' 平方米';
        label.style.position = 'absolute';
        label.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
        label.style.padding = '2px 6px';
        label.style.borderRadius = '3px';
        label.style.fontSize = '12px';
        label.style.boxShadow = '0 1px 2px rgba(0,0,0,0.3)';
        label.style.zIndex = '1000';
        label.style.transform = 'translate(-50%, -50%)';

        // 添加删除按钮
        const closeBtn = document.createElement('span');
        closeBtn.innerHTML = '×';
        closeBtn.style.marginLeft = '5px';
        closeBtn.style.cursor = 'pointer';
        closeBtn.style.fontWeight = 'bold';
        closeBtn.onclick = function() {
            if (label.parentNode) {
                label.parentNode.removeChild(label);
            }
        };
        label.appendChild(closeBtn);

        document.getElementById('mapContainer').appendChild(label);

        // 定位标签
        const pixel = map.lngLatToContainerPoint(point);
        label.style.left = pixel.x + 'px';
        label.style.top = (pixel.y - 20) + 'px';

        measureState.areaLabel = label;
        measureState.labels.push(label);
    }

    // 显示总面积标签
    function showTotalAreaLabel(point, area) {
        // 如果已存在面积标签，先移除它
        if (measureState.areaLabel) {
            if (measureState.areaLabel.parentNode) {
                measureState.areaLabel.parentNode.removeChild(measureState.areaLabel);
            }
        }

        // 计算亩数（1亩 ≈ 666.6667平方米）
        const areaInMu = area / 666.6667;

        const label = document.createElement('div');
        label.className = 'total-area-label';
        label.innerHTML = '总面积: ' + area.toFixed(2) + ' 平方米<br>' + areaInMu.toFixed(2) + ' 亩';
        label.style.position = 'absolute';
        label.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
        label.style.color = 'white';
        label.style.padding = '4px 8px';
        label.style.borderRadius = '4px';
        label.style.fontSize = '14px';
        label.style.fontWeight = 'bold';
        label.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
        label.style.zIndex = '1000';
        label.style.transform = 'translate(-50%, -50%)';
        label.style.lineHeight = '1.4';

        // 添加删除按钮
        const closeBtn = document.createElement('span');
        closeBtn.innerHTML = ' ×';
        closeBtn.style.cursor = 'pointer';
        closeBtn.style.fontWeight = 'bold';
        closeBtn.onclick = function() {
            if (label.parentNode) {
                label.parentNode.removeChild(label);
            }
        };
        label.appendChild(closeBtn);

        document.getElementById('mapContainer').appendChild(label);

        // 定位标签
        const pixel = map.lngLatToContainerPoint(point);
        label.style.left = pixel.x + 'px';
        label.style.top = (pixel.y - 40) + 'px';

        measureState.areaLabel = label;
        measureState.labels.push(label);
    }

    // 显示总距离标签
    function showTotalDistanceLabel(totalDistance) {
        const lastPoint = measureState.points[measureState.points.length - 1];
        const label = document.createElement('div');
        label.className = 'total-distance-label';
        label.innerHTML = '总距离: ' + totalDistance.toFixed(2) + ' 米';
        label.style.position = 'absolute';
        label.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
        label.style.color = 'white';
        label.style.padding = '4px 8px';
        label.style.borderRadius = '4px';
        label.style.fontSize = '14px';
        label.style.fontWeight = 'bold';
        label.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
        label.style.zIndex = '1000';
        label.style.transform = 'translate(-50%, -50%)';

        // 添加删除按钮
        const closeBtn = document.createElement('span');
        closeBtn.innerHTML = ' ×';
        closeBtn.style.cursor = 'pointer';
        closeBtn.style.fontWeight = 'bold';
        closeBtn.onclick = function() {
            if (label.parentNode) {
                label.parentNode.removeChild(label);
            }
        };
        label.appendChild(closeBtn);

        document.getElementById('mapContainer').appendChild(label);

        // 定位标签（向上偏移40像素，比段距离标签更高）
        const pixel = map.lngLatToContainerPoint(lastPoint);
        label.style.left = pixel.x + 'px';
        label.style.top = (pixel.y - 60) + 'px';  // 从-40改为-60，增加间距

        measureState.labels.push(label);
    }

    // 清除测量结果
    function clearMeasureResult() {
        // 移除所有线条
        measureState.lines.forEach(line => {
            if (map && map.removeOverLay) {
                try { map.removeOverLay(line); } catch(e) {}
            }
        });

        // 移除所有标记
        measureState.markers.forEach(marker => {
            if (map && map.removeOverLay) {
                try { map.removeOverLay(marker); } catch(e) {}
            }
        });

        // 移除所有标签
        measureState.labels.forEach(label => {
            if (label.parentNode) {
                try { label.parentNode.removeChild(label); } catch(e) {}
            }
        });

        // 移除临时线
        if (measureState.tempLine) {
            if (map && map.removeOverLay) {
                try { map.removeOverLay(measureState.tempLine); } catch(e) {}
            }
            measureState.tempLine = null;
        }

        // 移除多边形
        if (measureState.polygon) {
            if (map && map.removeOverLay) {
                try { map.removeOverLay(measureState.polygon); } catch(e) {}
            }
            measureState.polygon = null;
        }

        // 移除面积标签
        if (measureState.areaLabel) {
            if (measureState.areaLabel.parentNode) {
                try { measureState.areaLabel.parentNode.removeChild(measureState.areaLabel); } catch(e) {}
            }
            measureState.areaLabel = null;
        }

        // 重置状态
        measureState.points = [];
        measureState.lines = [];
        measureState.markers = [];
        measureState.labels = [];
        measureState.isActive = false;
        measureState.mode = '';
    }

    // 添加CSS样式用于距离标签
    const style = document.createElement('style');
    style.innerHTML = `
        .distance-label, .total-distance-label {
            font-family: Arial, sans-serif;
            pointer-events: auto;
        }
    `;
    document.head.appendChild(style);

    // 颜色选择器相关变量和函数 - 轮廓颜色设置已移除，使用固定颜色
    let currentOutlineColor = "#FFD700"; // 默认边框颜色（固定）
    let currentFillColor = "#FFFF00";   // 默认填充颜色（固定）
    let currentFillOpacity = 0.35;       // 默认透明度（固定）

    // 多行WKT颜色方案 - 用于为每个多边形分配不同颜色
    const polygonColors = [
        { outline: "#FFD700", fill: "#FFFF00", opacity: 0.35 }, // 黄色
        { outline: "#FF0000", fill: "#FF6666", opacity: 0.35 }, // 红色
        { outline: "#00FF00", fill: "#66FF66", opacity: 0.35 }, // 绿色
        { outline: "#0000FF", fill: "#6666FF", opacity: 0.35 }, // 蓝色
        { outline: "#FF00FF", fill: "#FF66FF", opacity: 0.35 }, // 紫色
        { outline: "#00FFFF", fill: "#66FFFF", opacity: 0.35 }, // 青色
        { outline: "#FFA500", fill: "#FFCC66", opacity: 0.35 }, // 橙色
        { outline: "#800080", fill: "#CC66CC", opacity: 0.35 }, // 深紫色
        { outline: "#008000", fill: "#66CC66", opacity: 0.35 }, // 深绿色
        { outline: "#800000", fill: "#CC6666", opacity: 0.35 }  // 深红色
    ];
    
    // 轨迹颜色相关变量
    let currentTrackLineColor = "#FF0000"; // 默认轨迹线颜色
    let currentTrackPointColor = "#68EAF3"; // 默认轨迹点颜色

    // 初始化颜色选择器
    function initColorPickers() {
        // 边框颜色选择器 - 已移除
        // const outlineColorPicker = document.getElementById('outlineColorPicker');
        // const outlineColorInput = document.getElementById('outlineColorInput');
        // 
        // outlineColorPicker.addEventListener('click', function() {
        //     outlineColorInput.click();
        // });
        // 
        // outlineColorInput.addEventListener('change', function() {
        //     currentOutlineColor = this.value;
        //     outlineColorPicker.style.backgroundColor = currentOutlineColor;
        // });
        
        // 填充颜色选择器 - 已移除
        // const fillColorPicker = document.getElementById('fillColorPicker');
        // const fillColorInput = document.getElementById('fillColorInput');
        // 
        // fillColorPicker.addEventListener('click', function() {
        //     fillColorInput.click();
        // });
        // 
        // fillColorInput.addEventListener('change', function() {
        //     currentFillColor = this.value;
        //     fillColorPicker.style.backgroundColor = currentFillColor;
        // });
        
        // 透明度滑块 - 已移除
        // const fillOpacitySlider = document.getElementById('fillOpacitySlider');
        // const fillOpacityValue = document.getElementById('fillOpacityValue');
        // 
        // fillOpacitySlider.addEventListener('input', function() {
        //     currentFillOpacity = this.value / 100;
        //     fillOpacityValue.textContent = this.value + '%';
        // });
        
        // 轨迹线颜色选择器
        const trackLineColorPicker = document.getElementById('trackLineColorPicker');
        const trackLineColorInput = document.getElementById('trackLineColorInput');
        
        if (trackLineColorPicker && trackLineColorInput) {
            trackLineColorPicker.addEventListener('click', function() {
                trackLineColorInput.click();
            });
            
            trackLineColorInput.addEventListener('change', function() {
                currentTrackLineColor = this.value;
                trackLineColorPicker.style.backgroundColor = currentTrackLineColor;
            });
        }
        
        // 轨迹点颜色选择器
        const trackPointColorPicker = document.getElementById('trackPointColorPicker');
        const trackPointColorInput = document.getElementById('trackPointColorInput');
        
        if (trackPointColorPicker && trackPointColorInput) {
            // 设置初始背景色
            trackPointColorPicker.style.backgroundColor = currentTrackPointColor;
            
            trackPointColorPicker.addEventListener('click', function() {
                trackPointColorInput.click();
            });
            
            trackPointColorInput.addEventListener('change', function() {
                currentTrackPointColor = this.value;
                trackPointColorPicker.style.backgroundColor = currentTrackPointColor;
            });
        }
    }

</script>
</body>

</html>