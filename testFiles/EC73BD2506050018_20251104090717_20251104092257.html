<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>展示轮廓</title>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #mapContainer {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        #mapLoading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
            transition: opacity 0.3s;
        }

        .loading-text {
            font-size: 16px;
            color: #333;
            padding: 10px 20px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .wkt-input-container {
            position: absolute;
            top: 20px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            width: min(320px, 90vw);
            box-sizing: border-box;
            transition: all 0.3s;
        }

        .minimize-btn {
            position: absolute;
            top: -5px;
            right: -4px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #f0f0f0;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #666;
            z-index: 1001;
            transition: background 0.2s;
        }

        .minimize-btn:hover {
            background: #e0e0e0;
        }

        .content-wrapper {
            transition: all 0.3s;
        }

        .wkt-input-container.minimized {
            width: 40px;
            height: 40px;
            padding: 0;
        }

        .wkt-input-container.minimized .content-wrapper {
            display: none;
        }

        .wkt-input-container.minimized .min-icon {
            display: none;
        }

        .wkt-input-container.minimized .restore-icon {
            display: inline;
        }

        #wktTextarea {
            width: 100%;
            height: 120px;
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
            box-sizing: border-box;
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        /* 页签样式 */
        .tabs-header {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .tab-btn {
            flex: 1;
            padding: 6px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            background: #f5f5f5;
            color: #333;
            transition: background 0.2s;
        }
        .tab-btn.active { background: #337AFF; color: #fff; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        /* Multi → Polygons 分割器样式 */
        .split-section {
            margin-top: 10px;
            padding: 10px;
            background: #fafafa;
            border: 1px solid #eee;
            border-radius: 6px;
        }
        .split-section .title {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
        }
        .split-section .desc {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        #multiInput, #polyOutput {
            width: 100%;
            height: 90px;
            margin-bottom: 8px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
            box-sizing: border-box;
        }
        .split-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .split-actions button {
            flex: 1;
            padding: 6px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }
        #splitMultiBtn { background: #337AFF; color: #fff; }
        #splitMultiBtn:hover { background: #2860E0; }
        #copyPolysBtn { background: #f5f5f5; color: #333; }
        #copyPolysBtn:hover { background: #e0e0e0; }
        #drawButton,
        #clearButton,
        #drawTrackButton,
        #clearTrackButton {
            width: 50%;
            padding: 8px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        #drawButton,
        #drawTrackButton {
            background: #337AFF;
            color: white;
        }

        #drawButton:hover,
        #drawTrackButton:hover {
            background: #2860E0;
        }

        #clearButton,
        #clearTrackButton {
            background: #f5f5f5;
            color: #333;
        }

        #clearButton:hover,
        #clearTrackButton:hover {
            background: #e0e0e0;
        }

        #drawButton:disabled,
        #clearButton:disabled,
        #drawTrackButton:disabled,
        #clearTrackButton:disabled {
            background: #e0e0e0;
            color: #999;
            cursor: not-allowed;
        }

        .tip {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .area-label {
             position: absolute;
             background: rgba(255, 0, 0, 0.85);
             border: 1px solid #000;
             border-radius: 3px;
             padding: 4px 6px;
             font-size: 12px;
             color: #fff;
             font-weight: 600;
             box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
             white-space: nowrap;
             z-index: 9999;
             pointer-events: none;
         }
         /* 默认隐藏标签容器下的标签 */
          .labels-hidden .area-label { display: none; }

          /* Batch → Generator 样式 */
          .batch-section { margin-top: 10px; padding: 10px; background: #fafafa; border: 1px solid #eee; border-radius: 6px; }
          .batch-section .title { font-size: 13px; font-weight: 600; color: #333; margin-bottom: 6px; }
          .batch-section .desc { font-size: 12px; color: #666; margin-bottom: 8px; }
          #batchInput, #multiOutput { width: 100%; height: 90px; margin-bottom: 8px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; resize: vertical; box-sizing: border-box; }
          .batch-actions { display: flex; gap: 8px; margin-bottom: 8px; }
          .batch-actions button { flex: 1; padding: 6px 0; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; transition: background 0.2s; }
          #generateMultiBtn { background: #337AFF; color: #fff; }
          #generateMultiBtn:hover { background: #2860E0; }
          #copyMultiBtn { background: #f5f5f5; color: #333; }
          #copyMultiBtn:hover { background: #e0e0e0; }
      </style>
    <script src="https://api.tianditu.gov.cn/api?v=4.0&tk=648f621977051d0199ff0f965d3fd322"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
    <script src="https://lib.baomitu.com/terraformer/1.0.12/terraformer.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://unpkg.com/terraformer-wkt-parser@1.2.1/terraformer-wkt-parser.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- 已移除动态备用加载器 ensureTerraformer：改为仅使用静态脚本标签加载 Terraformer 核心库与 WKT 解析器 -->
    <script>
        // 检查Turf.js是否加载成功
        window.addEventListener('load', function () {
            if (typeof turf === 'undefined') {
                console.warn('Turf.js加载失败，已启用备用面积算法');
            } else {
                console.log('Turf.js加载成功');
            }
        });
    </script>
</head>

<body>
<div id="mapContainer">
    <div id="mapLoading">
        <div class="loading-text">地图正在加载中...</div>
    </div>
</div>

<div class="wkt-input-container">
    <div class="minimize-btn" id="minimizeBtn">
        <span class="min-icon">−</span>
        <span class="restore-icon" style="display:none;">+</span>
    </div>

    <div class="content-wrapper">
        <div class="tabs-header">
            <button class="tab-btn active" id="tabDrawBtn">轮廓</button>
            <button class="tab-btn" id="tabTrackBtn">轨迹</button>
            <button class="tab-btn" id="tabSplitBtn">分割器</button>
            <button class="tab-btn" id="tabBatchBtn">合并器</button>
        </div>
        <div class="tab-pane active" id="tabDraw">
            <div class="tip">请输入WKT字符串（支持POLYGON/MULTIPOLYGON）：</div>
            <textarea id="wktTextarea">MULTIPOLYGON (((107.79296122223998 22.54071615957713, 107.79299111516816 22.540716216291045, 107.79298956574911 22.540716350623082, 107.79298701130124 22.54071705720037, 107.79298465433098 22.54071821312507, 107.79298258541544 22.54071977397566, 107.79298088406185 22.540721679769515, 107.79297961565227 22.54072385726809, 107.79297882893097 22.540726222791335, 107.79297855413128 22.54072868543351, 107.79297880181356 22.540731150556674, 107.79297956245962 22.540733523427512, 107.79298080683823 22.54073571285792, 107.7929824871286 22.540737634709302, 107.7929845387582 22.540739215125978, 107.79298688288404 22.54074039337342, 107.79298917230537 22.54074105038541, 107.79297801001118 22.54074105038147, 107.79296766462271 22.540741081103477, 107.79295570577902 22.540741199899834, 107.79295280693816 22.54074118070218, 107.79295015268376 22.54074140580487, 107.792947596706 22.540742107593488, 107.79294523722952 22.5407432590987, 107.79294316492778 22.54074481606882, 107.7929414594381 22.540746718670377, 107.7929401863016 22.54074889378747, 107.7929393944441 22.54075125783157, 107.79293911429636 22.54075371995381, 107.79293935662425 22.540756185536193, 107.79294011211532 22.540758559827783, 107.79294135173649 22.540760751585857, 107.79294302784977 22.54076267658239, 107.79294507604315 22.540764260840824, 107.79294741760567 22.540765443478975, 107.79294996255236 22.54076617904873, 107.79295261308238 22.540766439282535, 107.79295567204433 22.54076645948868, 107.79296083298166 22.540766479507564, 107.79298844344376 22.54076637957802, 107.7930094799688 22.5407663596096, 107.79303180130458 22.54076638092257, 107.79301334868562 22.540766420415352, 107.79300283347133 22.54076648058002, 107.792981747505 22.540766580277072, 107.79296524420303 22.54076653044811, 107.79295527473546 22.540766520388708, 107.79295167966615 22.540766627940805, 107.79294903783149 22.540766955706953, 107.79294651559601 22.540767755935573, 107.79294420988795 22.540768997874316, 107.79294220931419 22.540770633796196, 107.79294059075579 22.540772600833655, 107.79293941641292 22.540774823394568, 107.79293873141503 22.54077721606717, 107.79293856208628 22.540779686902397, 107.79293891493376 22.54078214094744, 107.79293977639787 22.540784483894715, 107.79294111337298 22.540786625706062, 107.79294287448005 22.54078848407286, 107.79294499204047 22.540789987579103, 107.7929473846778 22.540791078445874, 107.79294996044418 22.540791714751784, 107.79295161591928 22.540791812647274, 107.79294976025443 22.540792305332925, 107.79294738971976 22.540793437072267, 107.79294530242109 22.540794976660163, 107.79294357857222 22.540796864931114, 107.79294228441975 22.540799029319956, 107.79294146969713 22.540801386650433, 107.79294116571376 22.540803846331674, 107.79294138415162 22.540806313839497, 107.7929421166162 22.540808694348975, 107.79294333495939 22.540810896378424, 107.79294499236094 22.540812835305097, 107.79294702512787 22.54081443661711, 107.79294935514204 22.540815638776927, 107.79295189286233 22.540816395586223, 107.7929545407655 22.54081667796122, 107.79296013753911 22.54081675955524, 107.7929679233834 22.54081673959146, 107.79298378153189 22.540816729605073, 107.79300745847608 22.540816739595126, 107.79302331312013 22.540816779556284, 107.79303907717475 22.54081654059511, 107.79304693000957 22.54081660960255, 107.793062810011 22.540816609602405, 107.79307875379166 22.540816529416293, 107.79309456138174 22.540816409178387, 107.793102257391 22.540816331290415, 107.79311023145887 22.540816509590204, 107.79312605304386 22.540816529583697, 107.79315782304671 22.540816479583402, 107.79317374753319 22.5408164288579, 107.79319740008758 22.54081619044472, 107.79320528000987 22.54081627960109, 107.79321318001057 22.540816279601014, 107.79322110320255 22.54081625953721, 107.79324475997375 22.540816189723596, 107.79326064623939 22.540816279527572, 107.79327647624089 22.540816229527415, 107.79328439485357 22.54081615960036, 107.79330012075756 22.540816159600208, 107.79331593150718 22.540816179588376, 107.79332388405759 22.540816159585972, 107.79336347110032 22.540816129595424, 107.7933794023525 22.540816029308182, 107.79339501079063 22.54081589017429, 107.79341077106108 22.540816029031145, 107.79341788000916 22.54081595883048, 107.79341971083937 22.540815938715465, 107.7934223600234 22.54081566691217, 107.79342490122013 22.54081492023934, 107.79342723677277 22.540813727391203, 107.79342927692743 22.540812134208256, 107.79343094328199 22.540810201915637, 107.79343217179947 22.540808004770277, 107.79343291526867 22.540805627207252, 107.79343314511839 22.54080316059498, 107.79343285251576 22.540800699723988, 107.79343204870536 22.540798339164162, 107.79343076457717 22.540796169630482, 107.79342904947949 22.5407942744969, 107.79342696932265 22.54079272659232, 107.79342460404584 22.54079158540184, 107.7934220445453 22.540790894780752, 107.79342200200227 22.540790891359972, 107.7934239307917 22.540790368341966, 107.79342629443595 22.540789224236462, 107.7934283723793 22.540787673768666, 107.79343008476756 22.540785776522203, 107.7934313657946 22.54078360540721, 107.79343216623138 22.54078124385841, 107.79343245531744 22.54077878262882, 107.79343222194348 22.5407763163021, 107.79343147507802 22.54077393965781, 107.79343024342252 22.540771744029044, 107.793428574309 22.540769813792565, 107.7934265318805 22.540768223126275, 107.79342419462641 22.54076703315857, 107.79342165236602 22.54076628961923, 107.793419002797 22.540766021082057, 107.79341694107684 22.540766000972397, 107.79341346000975 22.540765970385515, 107.79340258924371 22.54076597038541, 107.79337089848039 22.540765930396777, 107.7933603753259 22.540765930426122, 107.79333931817494 22.540765980324394, 107.79331996855214 22.54076591288329, 107.79332486707584 22.54076585952354, 107.79334574700445 22.540765839553103, 107.79337739700726 22.540765759552805, 107.79338004874553 22.540765510174584, 107.79338259715718 22.54076478503286, 107.7933849443082 22.540763611994443, 107.79338699999877 22.540762036138545, 107.7933886852299 22.54076011802444, 107.79338993523916 22.540757931364187, 107.79339070198934 22.540755560189933, 107.79339095601473 22.540753095624563, 107.79339068755337 22.540750632379943, 107.79338990692193 22.54074826511719, 107.79338864411983 22.540746084808873, 107.79338694767573 22.540744175242995, 107.79338488278313 22.5407426098031, 107.79338252879467 22.54074144864814, 107.79338035109492 22.540740841013644, 107.79338107625392 22.540740839633305, 107.79340171460628 22.54074088955656, 107.79341073001062 22.54074088959929, 107.79341730001055 22.540740889599228, 107.79341995246895 22.540740646924778, 107.79342250299479 22.540739928227424, 107.7934248535729 22.540738761126303, 107.79342691387167 22.54073719047248, 107.79342860471512 22.540735276625313, 107.793429861125 22.540733093132886, 107.79343063481822 22.540730723905597, 107.79343089606229 22.540728259991518, 107.79343063481762 22.540725796077496, 107.79342986112387 22.54072342685036, 107.79342860471363 22.540721243358163, 107.79342691387005 22.540719329511276, 107.79342485357122 22.540717758857753, 107.79342250299341 22.540716591756915, 107.7934199524679 22.540715873059792, 107.79341730000988 22.540715630385485, 107.79341076058238 22.54071563038542, 107.79339157305286 22.540715550386896, 107.79337052607876 22.540715560391686, 107.79332849608257 22.54071560039129, 107.79330746218342 22.54071563041092, 107.79328642218533 22.540715670410723, 107.79327589616945 22.540715700364288, 107.79326377787946 22.540715688790605, 107.7932747250697 22.54071552933158, 107.79329045925068 22.540715489623725, 107.7933062915539 22.540715509588654, 107.79331438812419 22.540715438850775, 107.79333009932554 22.54071527985049, 107.79335366052243 22.540715359516195, 107.79336173969403 22.540715379025247, 107.79336963025445 22.54071530910882, 107.79338547081956 22.540715189180105, 107.79338812106029 22.54071492643259, 107.79339066519536 22.54071418844968, 107.79339300545514 22.54071300359164, 107.79339505190467 22.54071141739193, 107.7933967259 22.540709490807313, 107.79339796311056 22.54070729787538, 107.79339871599102 22.54070492286927, 107.79339895560854 22.540702457059147, 107.79339867275488 22.54069999520471, 107.79339787829997 22.540697631913645, 107.79339660277422 22.540695458005885, 107.79339489519543 22.540693557023474, 107.7933928211849 22.54069200202009, 107.79339046044569 22.54069085275363, 107.79338790369964 22.54069015338975, 107.793385249201 22.54068993080461, 107.79337730132643 22.54068997104212, 107.79336157306835 22.540690120077908, 107.79334586481423 22.540690050528248, 107.79333793706478 22.540690030431623, 107.79332995781277 22.54069002067503, 107.79329824458979 22.540690220443068, 107.79329041323498 22.540690230430478, 107.79328245323573 22.5406902504304, 107.79327450741467 22.540690270677022, 107.79325089943431 22.540690420031396, 107.7932352414523 22.54069030080803, 107.79322717323501 22.540690300429894, 107.79321918825269 22.540690320513914, 107.79319550991572 22.54069042042229, 107.79317165584457 22.540690450571095, 107.79313218832326 22.54069065055817, 107.79310053908407 22.540690800223263, 107.79308539737046 22.540690730537396, 107.79307669796373 22.5406907708112, 107.79305588890152 22.54069093011483, 107.79303488520557 22.540690830525392, 107.7930033462343 22.54069097016635, 107.79298235726083 22.54069083070453, 107.79297171001066 22.54069083038134, 107.79296122144953 22.540690900244627, 107.79295412083732 22.54069088043812, 107.79295146760637 22.540691115712633, 107.79294891476863 22.540691827292317, 107.7929465604282 22.540692987831587, 107.79294449506104 22.540694552731583, 107.79294279803797 22.540696461854075, 107.79294153457471 22.54069864183258, 107.7929407532255 22.54070100889175, 107.79294048401708 22.54070347206684, 107.79294073729501 22.54070593669941, 107.79294150332619 22.540708308075, 107.79294275267223 22.54071049506297, 107.79294443732162 22.5407124136186, 107.7929464925342 22.54071399001284, 107.7929488393292 22.540715163665745, 107.79295138752077 22.540715889474473, 107.79295403918319 22.540716139546607, 107.79296122223998 22.54071615957713), (107.7930106298685 22.540716253312016, 107.79301393224478 22.540716259576655, 107.79301499001687 22.54071625255873, 107.79301310269929 22.540716279283423, 107.7930106298685 22.540716253312016), (107.79315295182738 22.540715820383358, 107.79316392380987 22.540715759472963, 107.79317966704167 22.540715709620915, 107.79320346772728 22.540715729596094, 107.79321152035516 22.540715689106406, 107.79322722401334 22.540715559980672, 107.79324296731612 22.540715659307352, 107.79324481648445 22.540715670679518, 107.79324451399107 22.540715670390572, 107.79323381074985 22.540715780625256, 107.79320242415506 22.54071588032827, 107.79318142479359 22.54071583042463, 107.79316038000928 22.54071582038311, 107.79315295182738 22.540715820383358), (107.79308089689162 22.54076642956594, 107.79309198730417 22.54076642953311, 107.7930869891834 22.540766469988505, 107.79308089689162 22.54076642956594), (107.79314213600595 22.540766284114767, 107.79317773061102 22.540766189571762, 107.79318374665523 22.540766180396535, 107.79317110603449 22.540766220449132, 107.79314995578511 22.540766280392962, 107.79314213600595 22.540766284114767), (107.79321175779363 22.54076613767302, 107.79323017233706 22.540766109583895, 107.7932477031639 22.540766051028555, 107.79323415412705 22.540766180251175, 107.79321175779363 22.54076613767302)), ((107.79341274655725 22.540816330385574, 107.79340722643022 22.540816330385525, 107.79339063284988 22.540816270480754, 107.79337938103829 22.54081633059832, 107.79336832045041 22.54081646996941, 107.79335732154362 22.540816420514414, 107.79334067154511 22.540816350514266, 107.79332952693265 22.54081643038481, 107.79331842375609 22.540816430408256, 107.79330727375708 22.540816450408144, 107.79330177662526 22.54081648034846, 107.79329074322051 22.540816470390418, 107.79327963575727 22.5408165203446, 107.7932630476135 22.540816500394783, 107.79325743375601 22.5408165004077, 107.79324631017653 22.540816520360195, 107.79323532659828 22.5408165004081, 107.7932296547143 22.540816530762655, 107.79321302736211 22.54081665038374, 107.7932019100107 22.54081665038364, 107.79319070714537 22.540816700473435, 107.79317974378213 22.540816730533265, 107.79316872689563 22.540816780383338, 107.793151980011 22.540816780383174, 107.79314641662604 22.54081678038312, 107.79313536324443 22.54081677038901, 107.79312979120294 22.54081677038563, 107.79311314714793 22.54081678041971, 107.79309087714994 22.540816830419498, 107.79306870691396 22.540816900382403, 107.7930576004874 22.54081690043567, 107.79304649690675 22.54081693041823, 107.79303552030879 22.540816950435946, 107.79302446030987 22.540816980435842, 107.7930188541832 22.540817000452275, 107.79300771063029 22.540817030434823, 107.79300213378534 22.540817050346405, 107.79298001983486 22.540817020395014, 107.79297444011571 22.540817050490514, 107.79296347005692 22.540817080435968, 107.79295864464397 22.540817131206037, 107.79295599534171 22.540817402020465, 107.79295345382117 22.54081814774478, 107.79295111775171 22.540819339721235, 107.79294907690701 22.540820932142847, 107.79294740971568 22.540822863813755, 107.79294618024691 22.54082506050096, 107.79294543574842 22.540827437786998, 107.79294520483114 22.540829904314112, 107.79294549636887 22.540832365295035, 107.79294629915817 22.54083472615566, 107.79294758234828 22.54083689616942, 107.79294929662686 22.54083879194389, 107.79295137611521 22.54084034062551, 107.79295374089979 22.5408414826993, 107.79295630010319 22.540842174275998, 107.79295895537655 22.540842388778696, 107.79296896169177 22.54084235947327, 107.79298551447953 22.540842289714224, 107.7929966537786 22.540842329537536, 107.79301337378014 22.540842279537376, 107.79302453063583 22.5408422395869, 107.79304106884939 22.540842229599903, 107.79305213650075 22.54084217963244, 107.7930631731484 22.540842189596464, 107.79307430657593 22.540842179602265, 107.7931020800115 22.54084217960201, 107.79312434515676 22.5408421095322, 107.79314086899889 22.540842059641225, 107.7931575837964 22.540842089578017, 107.79317428001102 22.54084208960134, 107.7931854029499 22.540842009456743, 107.79319638261123 22.540841979506613, 107.79320750596422 22.540841939530402, 107.79321866932074 22.54084190954815, 107.79322428802014 22.540841879336273, 107.79324087401581 22.540841779600722, 107.79325193001073 22.540841779600623, 107.79326853689578 22.540841779600473, 107.79327413000972 22.540841789600414, 107.79328518001073 22.540841789600314, 107.79329630033396 22.540841789431273, 107.79331291517242 22.54084170960005, 107.79332403307848 22.540841709562596, 107.7933461026705 22.540841659698884, 107.79336272226418 22.54084175933658, 107.79337404127243 22.540841709010888, 107.79338512564263 22.540841609599397, 107.79340166001099 22.540841609599244, 107.79341278638272 22.540841589575372, 107.79341822691573 22.54084157957435, 107.79342087885395 22.540841332024552, 107.79342342784561 22.540840608640156, 107.79342577593451 22.540839437220438, 107.79342783288475 22.540837862782407, 107.79342951964895 22.54083594583085, 107.79343077140574 22.54083376003315, 107.79343154005083 22.540831389388302, 107.79343179604562 22.54082892499885, 107.79343152955235 22.54082646156991, 107.79343075081236 22.540824093769665, 107.7934294897521 22.540821912591337, 107.79342779483345 22.540820001856385, 107.79342573119119 22.54081843499326, 107.79342337812994 22.54081727221562, 107.79342082607648 22.540816558208356, 107.79341817310483 22.54081632041036, 107.79341274655725 22.540816330385574)))</textarea>
            <div class="coord-settings" style="margin-bottom:8px;font-size:12px;color:#333;">
                <label>WKT坐标系：
                    <select id="coordSysSelect" style="margin-left:6px;">
                        <option value="wgs84" selected>WGS84</option>
                        <option value="gcj02">GCJ-02（国测局）</option>
                        <option value="bd09">BD-09（百度）</option>
                        <option value="cgcs2000">CGCS2000</option>
                    </select>
                </label>
                <!-- 已移除“不进行绘制坐标转换”选项，统一使用WGS84绘制 -->
            </div>

            <div class="button-group">
                <button id="drawButton" disabled>绘制轮廓</button>
                <button id="clearButton" disabled>清空轮廓</button>
            </div>
            <!-- 显示开关：仅保留显示亩数 -->
            <div class="display-toggles" style="margin-top:8px;font-size:12px;color:#333;">
                <label><input type="checkbox" id="toggleLabelsCheckbox"> 显示亩数</label>
            </div>
        </div>

        <div class="tab-pane" id="tabSplit">
            <!-- MultiPolygon → 多个 Polygon 分割器 -->
            <div class="split-section">
                <div class="title">MultiPolygon → 多个 Polygon 分割器</div>
                <div class="desc">输入一个 MULTIPOLYGON WKT，分割为多行 POLYGON WKT。</div>
                <textarea id="multiInput"></textarea>
                <div class="split-actions">
                    <button id="splitMultiBtn">分割为多个 POLYGON</button>
                    <button id="copyPolysBtn">复制结果</button>
                </div>
                <textarea id="polyOutput" readonly></textarea>
            </div>
        </div>

        <div class="tab-pane" id="tabBatch">
            <!-- 批量POLYGON → MULTIPOLYGON 生成器 -->
            <div class="batch-section">
                <div class="title">批量POLYGON → MULTIPOLYGON 合并器</div>
                <div class="desc">每行一个 POLYGON WKT（或用分号分隔）。生成后可一键填充到上方并绘制。</div>
                <textarea id="batchInput"></textarea>
                <div class="batch-actions">
                    <button id="generateMultiBtn">生成 MULTIPOLYGON</button>
                    <button id="copyMultiBtn">复制结果</button>
                </div>
                <textarea id="multiOutput" readonly></textarea>
            </div>
        </div>
        <div class="tab-pane" id="tabTrack">
            <div class="tip">请粘贴轨迹文本（支持两种格式：1）每行一条：定位时间yyyyMMddHHmmss, 经度, 纬度；2）单行#分隔：经度,纬度,定位时间yyyyMMddHHmmss#经度,纬度,定位时间yyyyMMddHHmmss#…）。</div>
            <div class="coord-settings" style="margin-bottom:8px;font-size:12px;color:#333;">
                <label>轨迹坐标系：
                    <select id="trackCoordSysSelect" style="margin-left:6px;">
                        <option value="wgs84" selected>WGS84</option>
                        <option value="gcj02">GCJ-02（国测局）</option>
                        <option value="bd09">BD-09（百度）</option>
                        <option value="cgcs2000">CGCS2000</option>
                    </select>
                </label>
            </div>
            <textarea id="trackTextarea" style="width:100%;height:120px;margin-bottom:10px;padding:8px;border:1px solid #ddd;border-radius:4px;font-family:monospace;resize:vertical;box-sizing:border-box;">20251104090718,107.79342385,22.54082890,0,26
20251104090719,107.79342386,22.54082888,0,23
20251104090720,107.79342388,22.54082890,0,75
20251104090721,107.79342385,22.54082890,0,350
20251104090722,107.79342388,22.54082890,0,87
20251104090723,107.79342390,22.54082888,0,101
20251104090724,107.79342388,22.54082890,0,76
20251104090725,107.79342386,22.54082888,0,275
20251104090726,107.79342385,22.54082890,0,290
20251104090727,107.79342383,22.54082890,0,17
20251104090728,107.79342385,22.54082890,0,181
20251104090729,107.79342381,22.54082890,0,33
20251104090730,107.79342383,22.54082890,0,30
20251104090731,107.79342383,22.54082888,0,109
20251104090732,107.79342381,22.54082891,0,353
20251104090733,107.79342381,22.54082891,0,319
20251104090734,107.79342381,22.54082891,0,32
20251104090735,107.79342381,22.54082890,0,75
20251104090736,107.79342380,22.54082891,0,272
20251104090737,107.79342380,22.54082893,0,70
20251104090738,107.79342380,22.54082891,0,71
20251104090739,107.79342380,22.54082893,0,324
20251104090740,107.79342380,22.54082893,0,313
20251104090741,107.79342381,22.54082893,0,19
20251104090742,107.79342380,22.54082891,0,113
20251104090743,107.79342380,22.54082893,0,20
20251104090744,107.79342380,22.54082891,0,140
20251104090745,107.79342378,22.54082893,0,307
20251104090746,107.79342378,22.54082893,0,45
20251104090747,107.79342380,22.54082891,0,71
20251104090748,107.79342378,22.54082893,0,310
20251104090749,107.79342380,22.54082891,0,44
20251104090750,107.79342380,22.54082891,0,140
20251104090751,107.79342376,22.54082893,0,352
20251104090752,107.79342378,22.54082893,0,66
20251104090753,107.79342380,22.54082891,0,99
20251104090754,107.79342378,22.54082890,0,60
20251104090755,107.79342380,22.54082890,0,358
20251104090756,107.79342376,22.54082893,0,340
20251104090757,107.79342378,22.54082893,0,352
20251104090758,107.79342371,22.54082893,0,26
20251104090759,107.79342370,22.54082893,0,30
20251104090800,107.79342373,22.54082891,0,36
20251104090801,107.79342371,22.54082893,0,1
20251104090802,107.79342370,22.54082895,0,51
20251104090803,107.79342371,22.54082895,0,4
20251104090804,107.79342360,22.54082891,0,267
20251104090805,107.79342356,22.54082895,0,273
20251104090806,107.79341820,22.54082895,1.9,269
20251104090807,107.79341276,22.54082896,1.9,269
20251104090808,107.79340720,22.54082896,2,270
20251104090809,107.79340166,22.54082898,1.9,269
20251104090810,107.79339613,22.54082893,2,268
20251104090811,107.79339058,22.54082890,2,269
20251104090812,107.79338506,22.54082898,1.9,271
20251104090813,107.79337946,22.54082896,2,269
20251104090814,107.79337391,22.54082908,2,271
20251104090815,107.79336838,22.54082910,2,270
20251104090816,107.79336281,22.54082913,2,271
20251104090817,107.79335726,22.54082905,2,269
20251104090818,107.79335170,22.54082905,1.9,269
20251104090819,107.79334613,22.54082903,2,271
20251104090820,107.79334061,22.54082898,2,270
20251104090821,107.79333508,22.54082903,2,270
20251104090822,107.79332958,22.54082906,2,270
20251104090823,107.79332400,22.54082908,2,271
20251104090824,107.79331845,22.54082906,2,270
20251104090825,107.79331288,22.54082908,1.9,269
20251104090826,107.79330730,22.54082908,2,271
20251104090827,107.79330181,22.54082911,2,270
20251104090828,107.79329623,22.54082916,2,270
20251104090829,107.79329073,22.54082910,2,269
20251104090830,107.79328518,22.54082916,2,272
20251104090831,107.79327966,22.54082915,2,271
20251104090832,107.79327413,22.54082916,2,269
20251104090833,107.79326855,22.54082915,2,272
20251104090834,107.79326303,22.54082913,2.1,269
20251104090835,107.79325746,22.54082913,2,271
20251104090836,107.79325193,22.54082915,2,270
20251104090837,107.79324631,22.54082915,2,269
20251104090838,107.79324083,22.54082915,2,270
20251104090839,107.79323530,22.54082913,2,270
20251104090840,107.79322976,22.54082916,2,268
20251104090841,107.79322420,22.54082925,1.9,272
20251104090842,107.79321863,22.54082928,2.1,271
20251104090843,107.79321308,22.54082928,2,270
20251104090844,107.79320746,22.54082931,2,271
20251104090845,107.79320191,22.54082928,2,271
20251104090846,107.79319633,22.54082935,2,273
20251104090847,107.79319076,22.54082933,2,271
20251104090848,107.79318533,22.54082938,2,271
20251104090849,107.79317981,22.54082936,2,271
20251104090850,107.79317428,22.54082946,2,271
20251104090851,107.79316876,22.54082941,2,272
20251104090852,107.79316319,22.54082945,2,271
20251104090853,107.79315761,22.54082946,2,269
20251104090854,107.79315198,22.54082941,2.1,269
20251104090855,107.79314641,22.54082941,2,269
20251104090856,107.79314086,22.54082943,1.9,268
20251104090857,107.79313535,22.54082940,2,269
20251104090858,107.79312980,22.54082940,2,266
20251104090859,107.79312430,22.54082948,2,271
20251104090900,107.79311878,22.54082943,1.9,268
20251104090901,107.79311318,22.54082941,2,270
20251104090903,107.79310208,22.54082955,2,268
20251104090905,107.79309091,22.54082946,2.1,270
20251104090906,107.79309091,22.54082946,2.1,267
20251104090907,107.79307986,22.54082955,2.1,270
20251104090908,107.79307430,22.54082955,1.9,270
20251104090909,107.79306873,22.54082953,2,269
20251104090910,107.79306316,22.54082956,2.1,268
20251104090911,107.79305764,22.54082953,2,269
20251104090912,107.79305211,22.54082955,2,273
20251104090913,107.79304653,22.54082956,1.9,269
20251104090914,107.79304106,22.54082960,1.9,268
20251104090915,107.79303556,22.54082958,2,274
20251104090917,107.79302450,22.54082961,2,269
20251104090918,107.79301890,22.54082963,1.9,270
20251104090919,107.79301333,22.54082965,2,272
20251104090920,107.79300775,22.54082966,2,276
20251104090921,107.79300215,22.54082968,2,274
20251104090922,107.79299661,22.54082970,2.1,273
20251104090923,107.79299110,22.54082968,1.9,270
20251104090924,107.79298551,22.54082966,1.9,266
20251104090925,107.79298000,22.54082965,2,270
20251104090926,107.79297450,22.54082968,2.1,269
20251104090927,107.79296890,22.54082973,2,270
20251104090928,107.79296351,22.54082971,1.9,271
20251104090930,107.79295880,22.54082976,0.2,291
20251104090931,107.79295870,22.54082973,0,49
20251104090932,107.79295875,22.54082973,0,51
20251104090933,107.79295810,22.54082973,0.1,260
20251104090934,107.79295671,22.54082978,0.2,265
20251104090935,107.79295676,22.54082976,0,355
20251104090936,107.79295673,22.54082975,0,253
20251104090937,107.79295671,22.54082976,0,309
20251104091048,107.79295350,22.54080405,0,274
20251104091049,107.79295348,22.54080410,0,31
20251104091050,107.79295355,22.54080406,0,76
20251104091051,107.79295355,22.54080406,0,350
20251104091052,107.79295356,22.54080405,0,214
20251104091053,107.79295355,22.54080408,0,36
20251104091054,107.79295359,22.54080405,0,95
20251104091055,107.79295356,22.54080405,0,299
20251104091056,107.79295361,22.54080403,0,19
20251104091057,107.79295361,22.54080403,0,341
20251104091058,107.79295359,22.54080405,0,11
20251104091059,107.79295359,22.54080408,0,43
20251104091100,107.79295361,22.54080408,0,26
20251104091101,107.79295363,22.54080406,0,24
20251104091102,107.79295365,22.54080408,0,83
20251104091103,107.79295361,22.54080405,0,130
20251104091104,107.79295365,22.54080408,0,55
20251104091105,107.79295361,22.54080406,0,338
20251104091106,107.79295368,22.54080405,0,355
20251104091107,107.79295361,22.54080411,0,57
20251104091108,107.79295366,22.54080406,0,340
20251104091109,107.79295365,22.54080406,0,73
20251104091110,107.79295476,22.54080405,0.2,85
20251104091111,107.79296010,22.54080413,2.1,88
20251104091112,107.79296790,22.54080411,2.8,88
20251104091113,107.79297583,22.54080408,2.8,90
20251104091114,107.79298378,22.54080410,2.9,89
20251104091115,107.79299164,22.54080406,3,90
20251104091116,107.79299956,22.54080410,3,89
20251104091117,107.79300748,22.54080411,2.9,87
20251104091118,107.79301543,22.54080410,3,89
20251104091119,107.79302335,22.54080415,2.9,91
20251104091120,107.79303118,22.54080403,2.9,93
20251104091121,107.79303903,22.54080391,2.9,89
20251104091122,107.79304693,22.54080398,2.9,89
20251104091123,107.79305480,22.54080398,2.9,89
20251104091124,107.79306281,22.54080398,3,90
20251104091125,107.79307078,22.54080393,2.9,93
20251104091126,107.79307868,22.54080390,2.9,91
20251104091127,107.79308653,22.54080373,3,91
20251104091128,107.79309445,22.54080378,2.9,88
20251104091129,107.79310235,22.54080370,2.9,89
20251104091130,107.79311025,22.54080388,2.8,90
20251104091131,107.79311816,22.54080388,2.9,89
20251104091132,107.79312603,22.54080390,2.9,90
20251104091134,107.79314191,22.54080380,3,87
20251104091135,107.79314988,22.54080380,2.8,90
20251104091136,107.79315780,22.54080385,3.1,88
20251104091137,107.79316570,22.54080380,2.9,88
20251104091138,107.79317360,22.54080380,2.8,88
20251104091140,107.79318943,22.54080358,3,90
20251104091141,107.79319741,22.54080356,3,90
20251104091142,107.79320528,22.54080365,2.9,90
20251104091143,107.79321318,22.54080365,2.9,89
20251104091144,107.79322106,22.54080363,2.9,89
20251104091145,107.79322896,22.54080355,2.9,87
20251104091146,107.79323686,22.54080351,2.9,91
20251104091147,107.79324478,22.54080356,3,90
20251104091148,107.79325271,22.54080360,2.9,91
20251104091149,107.79326060,22.54080365,2.9,93
20251104091150,107.79326851,22.54080360,2.9,92
20251104091151,107.79327643,22.54080360,3,89
20251104091152,107.79328433,22.54080353,2.9,91
20251104091153,107.79329230,22.54080345,2.9,90
20251104091154,107.79330013,22.54080353,2.9,90
20251104091155,107.79330805,22.54080353,2.8,89
20251104091156,107.79331595,22.54080355,3,90
20251104091157,107.79332386,22.54080353,2.9,89
20251104091158,107.79333173,22.54080343,3,89
20251104091159,107.79333963,22.54080341,3,89
20251104091200,107.79334755,22.54080345,2.9,89
20251104091201,107.79335548,22.54080348,2.9,88
20251104091202,107.79336346,22.54080350,2.8,91
20251104091204,107.79337931,22.54080340,3,88
20251104091205,107.79338715,22.54080331,2.8,90
20251104091206,107.79339501,22.54080326,2.9,90
20251104091207,107.79340298,22.54080325,3,89
20251104091208,107.79341090,22.54080340,2.9,90
20251104091209,107.79341773,22.54080333,2.2,90
20251104091210,107.79341955,22.54080331,0.1,44
20251104091211,107.79341935,22.54080335,0,36
20251104091212,107.79341960,22.54080331,0,101
20251104091213,107.79342201,22.54080330,0.7,87
20251104091214,107.79342243,22.54080340,0,343
20251104091215,107.79342246,22.54080331,0,179
20251104091216,107.79342250,22.54080331,0,1
20251104091217,107.79342246,22.54080331,0,46
20251104091218,107.79342244,22.54080326,0,178
20251104091329,107.79343626,22.54077863,2.1,272
20251104091330,107.79343066,22.54077866,2,272
20251104091331,107.79342506,22.54077863,2,272
20251104091332,107.79342300,22.54077866,0.2,282
20251104091333,107.79342291,22.54077861,0,42
20251104091334,107.79342294,22.54077865,0,323
20251104091335,107.79342114,22.54077865,1,269
20251104091336,107.79342033,22.54077860,0.1,115
20251104091337,107.79342028,22.54077860,0,89
20251104091338,107.79342031,22.54077863,0,14
20251104091339,107.79342033,22.54077861,0,197
20251104091340,107.79342031,22.54077861,0,65
20251104091341,107.79342033,22.54077861,0,74
20251104091342,107.79342028,22.54077861,0,94
20251104091343,107.79342031,22.54077865,0,30
20251104091344,107.79342033,22.54077863,0,79
20251104091345,107.79342035,22.54077861,0,62
20251104091346,107.79342031,22.54077863,0,248
20251104091347,107.79342036,22.54077865,0,107
20251104091348,107.79342008,22.54077866,0,274
20251104091349,107.79341886,22.54077865,0.1,266
20251104091350,107.79341681,22.54077863,0.3,266
20251104091351,107.79341346,22.54077860,1,266
20251104091352,107.79340880,22.54077861,1.7,267
20251104091353,107.79340258,22.54077860,2.6,268
20251104091354,107.79339195,22.54077870,3.8,270
20251104091355,107.79338136,22.54077865,3.8,268
20251104091356,107.79337088,22.54077856,3.9,269
20251104091357,107.79336041,22.54077856,3.8,269
20251104091358,107.79334975,22.54077865,3.9,270
20251104091359,107.79333931,22.54077861,3.9,270
20251104091400,107.79332873,22.54077868,3.7,268
20251104091401,107.79331823,22.54077861,3.9,270
20251104091402,107.79330775,22.54077850,3.8,269
20251104091403,107.79329728,22.54077865,3.7,269
20251104091405,107.79327624,22.54077866,3.8,271
20251104091406,107.79326568,22.54077850,3.8,267
20251104091407,107.79325518,22.54077861,3.9,273
20251104091408,107.79324465,22.54077876,3.9,270
20251104091409,107.79323421,22.54077881,3.9,272
20251104091410,107.79322371,22.54077883,3.7,272
20251104091412,107.79320265,22.54077875,3.8,270
20251104091413,107.79319216,22.54077885,3.8,269
20251104091414,107.79318168,22.54077891,3.8,271
20251104091415,107.79317115,22.54077885,3.8,269
20251104091416,107.79316061,22.54077888,3.7,270
20251104091417,107.79314998,22.54077891,3.9,269
20251104091418,107.79313950,22.54077901,3.9,270
20251104091419,107.79312895,22.54077903,3.8,270
20251104091420,107.79311841,22.54077893,3.9,269
20251104091421,107.79310795,22.54077893,3.8,267
20251104091422,107.79309748,22.54077906,3.7,270
20251104091423,107.79308700,22.54077910,3.8,269
20251104091424,107.79307643,22.54077906,3.8,269
20251104091425,107.79306590,22.54077896,3.8,270
20251104091426,107.79305543,22.54077896,3.7,269
20251104091427,107.79304500,22.54077910,3.9,270
20251104091429,107.79302388,22.54077911,3.7,269
20251104091430,107.79301338,22.54077905,4,269
20251104091431,107.79300291,22.54077911,3.7,270
20251104091432,107.79299236,22.54077920,3.8,270
20251104091433,107.79298176,22.54077921,3.8,270
20251104091434,107.79297220,22.54077921,3.4,269
20251104091435,107.79296520,22.54077916,2.4,269
20251104091436,107.79296036,22.54077918,1.6,270
20251104091437,107.79295526,22.54077915,1.7,273
20251104091438,107.79295215,22.54077925,0.9,276
20251104091439,107.79295225,22.54077923,0,84
20251104091550,107.79295060,22.54075381,0,99
20251104091551,107.79295064,22.54075380,0,22
20251104091552,107.79295063,22.54075380,0,71
20251104091553,107.79295228,22.54075381,0.1,76
20251104091554,107.79295193,22.54075381,0,137
20251104091555,107.79295191,22.54075383,0,1
20251104091556,107.79295190,22.54075383,0,358
20251104091557,107.79295195,22.54075380,0,23
20251104091558,107.79295193,22.54075380,0,325
20251104091559,107.79295190,22.54075380,0,348
20251104091600,107.79295191,22.54075380,0,68
20251104091601,107.79295190,22.54075380,0,49
20251104091602,107.79295190,22.54075381,0,210
20251104091603,107.79295191,22.54075380,0,118
20251104091604,107.79295186,22.54075381,0,2
20251104091605,107.79295185,22.54075380,0,15
20251104091606,107.79295186,22.54075378,0,150
20251104091607,107.79295186,22.54075383,0,101
20251104091608,107.79295271,22.54075381,0.1,81
20251104091609,107.79295573,22.54075383,0.5,78
20251104091610,107.79296078,22.54075385,1.9,85
20251104091611,107.79296781,22.54075371,2.7,90
20251104091612,107.79297801,22.54075368,3.8,88
20251104091613,107.79298841,22.54075375,3.9,89
20251104091614,107.79299891,22.54075368,3.7,92
20251104091615,107.79300948,22.54075373,3.8,88
20251104091616,107.79302005,22.54075370,3.8,90
20251104091617,107.79303048,22.54075375,4,89
20251104091618,107.79304090,22.54075376,3.9,88
20251104091619,107.79305148,22.54075375,3.8,90
20251104091620,107.79306203,22.54075378,3.9,89
20251104091621,107.79307241,22.54075380,3.8,89
20251104091622,107.79308291,22.54075378,3.9,90
20251104091623,107.79309348,22.54075380,3.8,88
20251104091624,107.79310396,22.54075373,3.8,90
20251104091625,107.79311448,22.54075368,3.9,91
20251104091626,107.79312499,22.54075370,3.8,88
20251104091627,107.79313558,22.54075358,3.9,89
20251104091628,107.79314608,22.54075355,3.8,90
20251104091629,107.79315668,22.54075358,3.9,89
20251104091630,107.79316723,22.54075358,3.8,88
20251104091631,107.79317770,22.54075356,3.8,90
20251104091633,107.79319860,22.54075351,3.9,90
20251104091634,107.79320918,22.54075350,3.9,88
20251104091636,107.79323015,22.54075348,3.9,89
20251104091637,107.79324068,22.54075341,3.8,90
20251104091638,107.79325110,22.54075341,3.9,88
20251104091639,107.79326170,22.54075336,3.9,89
20251104091640,107.79327216,22.54075335,3.9,89
20251104091641,107.79328269,22.54075343,3.8,90
20251104091643,107.79330376,22.54075346,3.9,90
20251104091644,107.79331421,22.54075328,3.9,90
20251104091645,107.79332478,22.54075323,3.9,90
20251104091646,107.79333523,22.54075316,3.9,90
20251104091647,107.79334571,22.54075321,3.9,89
20251104091649,107.79336683,22.54075315,3.9,90
20251104091650,107.79337736,22.54075313,3.8,89
20251104091811,107.79342079,22.54072818,0.4,268
20251104091812,107.79342093,22.54072821,0,320
20251104091813,107.79342095,22.54072815,0,171
20251104091814,107.79342091,22.54072821,0,151
20251104091815,107.79342095,22.54072825,0,352
20251104091816,107.79342098,22.54072819,0,52
20251104091817,107.79342098,22.54072821,0,50
20251104091818,107.79342100,22.54072819,0,29
20251104091819,107.79342100,22.54072821,0,56
20251104091820,107.79342101,22.54072818,0,28
20251104091821,107.79342100,22.54072819,0,149
20251104091822,107.79342098,22.54072819,0,35
20251104091823,107.79342098,22.54072819,0,42
20251104091824,107.79342098,22.54072819,0,67
20251104091825,107.79342096,22.54072819,0,154
20251104091826,107.79342095,22.54072821,0,261
20251104091827,107.79342100,22.54072819,0,21
20251104091828,107.79342096,22.54072819,0,119
20251104091829,107.79342098,22.54072819,0,138
20251104091830,107.79342098,22.54072821,0,335
20251104091831,107.79342095,22.54072821,0,51
20251104091832,107.79342096,22.54072821,0,320
20251104091833,107.79342101,22.54072823,0,90
20251104091834,107.79342096,22.54072821,0,137
20251104091835,107.79342098,22.54072819,0,123
20251104091836,107.79342098,22.54072819,0,337
20251104091837,107.79342101,22.54072819,0,107
20251104091838,107.79342100,22.54072823,0,190
20251104091839,107.79342098,22.54072823,0,357
20251104091840,107.79342098,22.54072821,0,57
20251104091841,107.79342098,22.54072821,0,208
20251104091842,107.79342096,22.54072819,0,341
20251104091843,107.79342098,22.54072821,0,62
20251104091844,107.79342101,22.54072823,0,355
20251104091845,107.79342098,22.54072821,0,115
20251104091846,107.79342103,22.54072821,0,35
20251104091847,107.79342098,22.54072823,0,57
20251104091848,107.79342101,22.54072823,0,71
20251104091849,107.79342070,22.54072823,0,272
20251104091850,107.79341730,22.54072826,1.1,261
20251104091851,107.79341073,22.54072826,2.6,268
20251104091852,107.79340175,22.54072826,3.5,269
20251104091853,107.79339158,22.54072818,3.9,269
20251104091854,107.79338108,22.54072821,3.8,271
20251104091855,107.79337054,22.54072819,3.8,270
20251104091856,107.79336009,22.54072825,3.8,268
20251104091857,107.79334956,22.54072823,3.9,270
20251104091859,107.79332851,22.54072823,3.8,270
20251104091901,107.79330749,22.54072826,3.8,268
20251104091903,107.79328645,22.54072830,3.9,270
20251104091904,107.79327591,22.54072833,3.8,269
20251104091905,107.79326546,22.54072843,3.8,270
20251104091907,107.79324450,22.54072830,3.9,271
20251104091908,107.79323391,22.54072841,3.9,270
20251104091909,107.79322338,22.54072855,3.8,270
20251104091910,107.79321296,22.54072860,3.9,271
20251104091911,107.79320243,22.54072851,3.8,269
20251104091912,107.79319190,22.54072850,3.8,269
20251104091913,107.79318139,22.54072846,3.9,270
20251104091914,107.79317086,22.54072848,3.8,269
20251104091915,107.79316038,22.54072845,3.8,270
20251104091916,107.79314969,22.54072855,3.9,268
20251104091917,107.79313920,22.54072845,3.8,270
20251104091919,107.79311828,22.54072850,3.8,270
20251104091920,107.79310770,22.54072853,3.8,270
20251104091922,107.79308673,22.54072861,3.8,271
20251104091923,107.79307618,22.54072860,3.8,270
20251104091924,107.79306565,22.54072873,3.8,271
20251104091925,107.79305523,22.54072875,3.7,268
20251104091926,107.79304474,22.54072871,3.9,269
20251104091927,107.79303425,22.54072875,3.9,269
20251104091928,107.79302365,22.54072876,3.8,270
20251104091929,107.79301313,22.54072891,4,271
20251104091930,107.79300268,22.54072880,3.9,269
20251104091931,107.79299215,22.54072875,3.7,268
20251104092102,107.79295010,22.54070351,0,17
20251104092103,107.79295013,22.54070351,0,75
20251104092104,107.79295006,22.54070350,0,146
20251104092105,107.79295010,22.54070350,0,261
20251104092106,107.79295008,22.54070350,0,83
20251104092107,107.79295011,22.54070350,0,55
20251104092108,107.79295006,22.54070353,0,43
20251104092109,107.79295008,22.54070351,0,86
20251104092110,107.79295034,22.54070353,0,71
20251104092111,107.79295408,22.54070351,1.2,80
20251104092112,107.79296125,22.54070353,2.7,88
20251104092113,107.79297171,22.54070346,3.7,89
20251104092114,107.79298226,22.54070346,3.9,87
20251104092115,107.79299281,22.54070356,3.9,88
20251104092116,107.79300333,22.54070360,3.7,89
20251104092117,107.79301396,22.54070363,3.9,89
20251104092118,107.79302443,22.54070356,3.7,88
20251104092119,107.79303495,22.54070346,3.9,88
20251104092120,107.79304545,22.54070354,3.9,88
20251104092121,107.79305591,22.54070356,3.9,88
20251104092122,107.79306641,22.54070353,3.9,90
20251104092123,107.79307681,22.54070340,3.8,88
20251104092124,107.79308533,22.54070336,2.8,88
20251104092125,107.79309276,22.54070341,2.9,87
20251104092126,107.79310054,22.54070343,2.9,88
20251104092128,107.79311633,22.54070340,2.9,91
20251104092129,107.79312423,22.54070335,2.9,88
20251104092130,107.79313226,22.54070328,2.9,90
20251104092132,107.79314808,22.54070321,2.9,88
20251104092133,107.79314808,22.54070321,2.8,89
20251104092134,107.79316386,22.54070313,2.9,90
20251104092135,107.79317173,22.54070308,2.9,89
20251104092136,107.79317965,22.54070308,3,90
20251104092138,107.79319555,22.54070305,2.8,88
20251104092139,107.79320348,22.54070310,2.9,89
20251104092140,107.79321140,22.54070306,2.9,90
20251104092141,107.79321925,22.54070295,2.9,89
20251104092142,107.79322721,22.54070293,2.8,88
20251104092143,107.79323513,22.54070293,3,88
20251104092144,107.79324306,22.54070303,3,88
20251104092145,107.79325089,22.54070305,2.8,90
20251104092146,107.79325881,22.54070313,2.9,90
20251104092147,107.79326670,22.54070300,2.8,89
20251104092148,107.79327460,22.54070290,2.8,90
20251104092149,107.79328249,22.54070288,2.9,90
20251104092150,107.79329045,22.54070286,2.9,87
20251104092151,107.79329830,22.54070285,3,88
20251104092152,107.79330631,22.54070288,2.9,89
20251104092153,107.79331424,22.54070281,2.9,90
20251104092154,107.79332213,22.54070270,2.9,90
20251104092155,107.79333005,22.54070265,2.9,91
20251104092156,107.79333790,22.54070266,2.8,88
20251104092157,107.79334580,22.54070268,2.9,90
20251104092158,107.79335371,22.54070273,3,89
20251104092159,107.79336161,22.54070275,2.8,90
20251104092200,107.79336951,22.54070268,3,89
20251104092201,107.79337744,22.54070260,3,90
20251104092202,107.79338536,22.54070256,3,90</textarea>
            <div class="button-group">
                <button id="drawTrackButton" disabled style="flex: 1;">绘制轨迹</button>
                <button id="showTrackPointsButton" disabled style="flex: 1;" class="btn-warning">打点</button>
                <button id="clearTrackButton" disabled style="flex: 1;">清空轨迹</button>
            </div>
            <!-- 回放控制 -->
            <div class="split-section" style="margin-top:8px;">
                <div class="title">轨迹回放</div>
                <div class="playback-actions" style="display:flex;gap:8px;margin-bottom:8px;">
                    <button id="playbackStartBtn" disabled>开始</button>
                    <button id="playbackPauseBtn" disabled>继续</button>
                    <button id="playbackStopBtn" disabled>结束</button>
                </div>
                <div class="playback-speed" style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                    <label>速度：
                        <select id="playbackSpeedSelect" disabled>
                            <option value="1" selected>1×</option>
                            <option value="2">2×</option>
                            <option value="4">4×</option>
                            <option value="8">8×</option>
                            <option value="16">16×</option>
                            <option value="32">32×</option>
                            <option value="64">64×</option>
                            <option value="128">128×</option>
                            <option value="256">256×</option>
                            <option value="512">512×</option>
                            <option value="1024">1024×</option>
                        </select>
                    </label>
                    <span id="playbackTimeLabel" style="font-size:12px;color:#666;">时间：—</span>
                </div>
                <div class="playback-time" style="display:flex;flex-direction:column;gap:4px;margin-bottom:8px;">
                    <label class="playback-time-label" style="display:flex;align-items:center;gap:8px;flex:1 1 auto;min-width:0;">
                        <span class="playback-time-text" style="white-space:nowrap;">起始时间：</span>
                        <input type="range" id="playbackTimeSlider" disabled min="0" max="0" step="1000" value="0" style="flex:1 1 auto;min-width:0;max-width:100%;vertical-align:middle;">
                    </label>
                    <span id="playbackTimeCursor" style="font-size:12px;color:#666;align-self:flex-end;">—</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let map;
    let currentPolygons = []; // 存储多边形和其标签
    let currentTracks = []; // 存储轨迹折线及相关覆盖物
    let mapLoaded = false;
    let mapLabelHandlers = []; // 存储地图事件处理器
    let labelsEnabled = false; // 标签显示开关（默认关闭）
    let isDrawing = false; // 绘制进行中防止重复点击

    window.onload = function () {
        if (typeof T === 'undefined') {
            alert("天地图API加载失败，请检查网络或密钥！");
            return;
        }
        initMap();
        bindDrawEvent();
        bindMinimizeEvent();
        bindTabs();
        bindBatchGenerator();
        bindMultiSplitter();
        bindLabelsToggle(); // 绑定标签显示开关
        bindTrackEvents();  // 绑定轨迹绘制与清空
        bindPlaybackControls(); // 绑定轨迹回放
    };

    function initMap() {
        showLoading();
        disableButtons(true);

        try {
            map = new T.Map("mapContainer", {
                zoom: 12,
                center: new T.LngLat(116.40769, 39.90403)
            });

            // 已移除测试标签
            map.enableScrollWheelZoom();

            // 添加地图类型控件
            const mapTypeCtrl = new T.Control.MapType({
                mapTypes: [TMAP_NORMAL_MAP, TMAP_SATELLITE_MAP, TMAP_TERRAIN_MAP],
                position: T_ANCHOR_TOP_LEFT
            });
            map.addControl(mapTypeCtrl);

            // 加载影像底图（卫星）
            const tk = "648f621977051d0199ff0f965d3fd322";

            // 方案1：使用默认地图类型（作为备选）
            map.setMapType(TMAP_SATELLITE_MAP);

            // 方案2：手动添加影像图层（底图 + 标注）
            const vecLayer = new T.TileLayer(`https://t0.tianditu.gov.cn/img_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=img&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`);
            const cvaLayer = new T.TileLayer(`https://t0.tianditu.gov.cn/cia_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cia&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`);

            // 添加图层并监听加载状态
            vecLayer.addEventListener("load", function () {
                console.log("影像底图加载完成");
            });

            vecLayer.addEventListener("error", function (e) {
                console.error("影像底图加载错误:", e);
                alert("影像底图加载错误，将使用默认地图类型");
            });

            map.addLayer(vecLayer);
            map.addLayer(cvaLayer);

            // 监听地图加载事件
            map.addEventListener("loaded", function () {
                console.log("地图加载完成");
                markMapLoaded();
            });
            map.addEventListener("load", function () {
                console.log("地图load事件触发");
                markMapLoaded();
            });
            map.addEventListener("tilesloaded", function () {
                console.log("地图瓦片加载完成");
                markMapLoaded();
            });
            // 监听地图加载失败事件
            map.addEventListener("error", function (e) {
                console.error("地图加载错误:", e);
                alert("地图加载错误: " + e.message);
                hideLoading();
            });

            // 监听地图移动事件，用于更新标签位置
            const moveHandler = function () {
                updateAllLabelsPosition();
            };
            map.addEventListener("move", moveHandler);
            map.addEventListener("zoom", moveHandler);

            // 存储事件处理器，用于清理
            mapLabelHandlers.push({ event: "move", handler: moveHandler });
            mapLabelHandlers.push({ event: "zoom", handler: moveHandler });

            // 超时容错
            setTimeout(() => {
                if (!mapLoaded) markMapLoaded();
            }, 8000);

        } catch (error) {
            alert("地图初始化失败：" + error.message);
            console.error(error);
            hideLoading();
        }
    }

    function markMapLoaded() {
        if (!mapLoaded) {
            mapLoaded = true;
            hideLoading();
            disableButtons(false);
            disableTrackButtons(false);
            // 仅开启速度选择，回放按钮按状态控制
            const speedSel = document.getElementById('playbackSpeedSelect');
            if (speedSel) speedSel.disabled = false;
            updatePlaybackButtonsState('idle');
        }
    }

    function showLoading() {
        const loading = document.getElementById("mapLoading");
        loading.style.display = "flex";
        loading.style.opacity = "1";
    }

    function hideLoading() {
        const loading = document.getElementById("mapLoading");
        loading.style.opacity = "0";
        setTimeout(() => loading.style.display = "none", 300);
    }

    function disableButtons(disabled) {
        document.getElementById("drawButton").disabled = disabled;
        document.getElementById("clearButton").disabled = disabled;
    }

    function disableTrackButtons(disabled) {
        const drawTrackBtn = document.getElementById("drawTrackButton");
        const showTrackPointsBtn = document.getElementById("showTrackPointsButton");
        const clearTrackBtn = document.getElementById("clearTrackButton");
        if (drawTrackBtn) drawTrackBtn.disabled = disabled;
        if (showTrackPointsBtn) showTrackPointsBtn.disabled = disabled;
        if (clearTrackBtn) clearTrackBtn.disabled = disabled;
    }
    // 回放控件的禁用/启用
    function disablePlaybackButtons(disabled) {
        ["playbackStartBtn","playbackPauseBtn","playbackStopBtn","playbackSpeedSelect","playbackTimeSlider"].forEach(id=>{
            const el = document.getElementById(id);
            if (el) el.disabled = disabled;
        });
    }

    // 回放按钮状态管理：空闲/播放/暂停
    function updatePlaybackButtonsState(state){
        try {
            const startBtn = document.getElementById('playbackStartBtn');
            const pauseBtn = document.getElementById('playbackPauseBtn');
            const stopBtn = document.getElementById('playbackStopBtn');
            if (!startBtn || !pauseBtn || !stopBtn) return;
            if (state === 'idle') {
                startBtn.disabled = false;
                pauseBtn.disabled = true;
                stopBtn.disabled = true;
                pauseBtn.textContent = '继续';
            } else if (state === 'playing') {
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
                pauseBtn.textContent = '暂停';
            } else if (state === 'paused') {
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
                pauseBtn.textContent = '继续';
            }
        } catch(e) { console.warn('更新按钮状态失败:', e); }
    }

    function bindDrawEvent() {
        document.getElementById("drawButton").addEventListener("click", function () {
            if (isDrawing) { console.log('绘制进行中，忽略重复点击'); return; }
            isDrawing = true;
            disableButtons(true);
            showLoading();
            try {
                const wktStr = document.getElementById("wktTextarea").value.trim();
                if (!wktStr) { alert("请输入WKT字符串！"); return; }
                clearOverlays();
                const geojson = parseWkt(wktStr);
    
                const polygonData = [];
                if (geojson.type === "Polygon") {
                    polygonData.push({ index: 1, coordinates: geojson.coordinates });
                } else if (geojson.type === "MultiPolygon") {
                    geojson.coordinates.forEach((polygon, index) => {
                        polygonData.push({ index: index + 1, coordinates: polygon });
                    });
                }
    
                // 重置并绘制
                polygonInfoList = [];
                polygonData.forEach(pd => processPolygon(pd.index, pd.coordinates));
    
                // 视图居中到所有已绘制轮廓
                try { fitViewportToPolygons(); } catch (e) { console.warn('视图居中失败', e); }
    
                // 在视图稳定后再创建/更新标签
                setTimeout(() => {
                    if (labelsEnabled) {
                        try {
                            createAllLabels();
                            updateAllLabelsPosition();
                        } catch (e) {
                            console.warn('创建或更新标签失败:', e);
                        }
                    }
                }, 150);
            } catch (e) {
                alert('绘制失败：' + (e && e.message ? e.message : e));
                console.error('绘制异常:', e);
            } finally {
                hideLoading();
                isDrawing = false;
                disableButtons(false);
            }
        });

        document.getElementById("clearButton").addEventListener("click", function () {
            if (isDrawing) { console.log('绘制进行中，暂不清空'); return; }
            clearOverlays();
            console.log("已清空所有轮廓");
        });
    }

    // 存储多边形数据，用于后续标签创建
    let polygonInfoList = [];

    // 处理单个多边形的绘制和面积计算
    function processPolygon(actualPolygonIndex, polygonCoords) {
        console.log('开始处理多边形', actualPolygonIndex);

        // 坐标系选择（绘制始终使用WGS84坐标）
        const coordSys = (document.getElementById('coordSysSelect') && document.getElementById('coordSysSelect').value) || 'wgs84';

        // 统一转换为WGS84用于绘制与面积计算
        function toWgs(point){
            const lng = point[0], lat = point[1];
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                return [lng, lat];
            } else if (coordSys === 'gcj02') {
                const w = gcj02ToWgs84(lng, lat);
                return [w.lng, w.lat];
            } else if (coordSys === 'bd09') {
                const gcj = bd09ToGcj02(lng, lat);
                const w = gcj02ToWgs84(gcj.lng, gcj.lat);
                return [w.lng, w.lat];
            }
            return [lng, lat];
        }
        const coordsWGS84 = polygonCoords.map(ring => ring.map(toWgs));
        let outerRingWGS = coordsWGS84[0] || [];

        // 生成用于绘制的坐标（直接使用WGS84坐标）
        const rings = coordsWGS84.map(ring => ring.map(([lng, lat]) => new T.LngLat(lng, lat)));


         // 创建半透明填充的多边形（无边框）
          const polygon = new T.Polygon(rings, {
              color: "#FFD700",
              weight: 1,
              opacity: 1,
              fillColor: "#FFFF00",
              fillOpacity: 0.35
          });
 
          // 使用WGS84坐标计算面积（更准确的面积计算）
         let areaSqm;
         let areaMu;



         try {
             // 检查Turf.js是否可用
             if (typeof turf !== 'undefined' && turf.area) {
                 // 使用Turf.js计算多边形面积
                // 构造GeoJSON格式的多边形
                const geoJsonPolygon = {
                    type: "Polygon",
                    coordinates: coordsWGS84
                };


                 // 使用Turf.js计算面积（平方米）
                 areaSqm = turf.area(geoJsonPolygon);
                 areaMu = (areaSqm / 666.6667).toFixed(4); // 转换为亩
                 console.log(`多边形${actualPolygonIndex}面积计算结果(Turf.js): ${areaSqm}平方米 = ${areaMu}亩`);
             } else {
                 // 如果Turf.js不可用，回退到之前的计算方法
                 console.warn('Turf.js不可用，使用备用计算方法');
                 // 计算带孔洞的多边形面积
                 areaSqm = 0;
                 // 计算外环面积
                 outerRingWGS = coordsWGS84[0] || [];
                 areaSqm += calculatePolygonArea(outerRingWGS);

                 // 减去内环（孔洞）面积
                 for (let i = 1; i < coordsWGS84.length; i++) {
                     const innerRingArea = calculatePolygonArea(coordsWGS84[i]);
                     areaSqm -= innerRingArea;
                 }

                  areaMu = (areaSqm / 666.6667).toFixed(4); // 使用更精确的转换系数
                  console.log(`多边形${actualPolygonIndex}面积计算结果(备用): ${areaSqm}平方米 = ${areaMu}亩`);
              }
          } catch (error) {
              console.error(`面积计算失败:`, error);
              areaSqm = 0;
              areaMu = '0.0000';
          }

          // 计算多边形的中心点和底部中心点（WGS84）
          const centerPoint = calculatePolygonCenter(outerRingWGS);
          const bottomCenterPoint = calculatePolygonBottomCenter(outerRingWGS);

          // 添加多边形到地图
          if (map) {
              map.addOverLay(polygon);
              console.log(`多边形${actualPolygonIndex}已添加到地图`);
          } else {
              console.error('地图对象不存在');
          }

          // 存储多边形信息，用于后续标签创建
          polygonInfoList.push({
              index: actualPolygonIndex,
              polygon: polygon,
              area: areaMu,
              bottomCenter: { lng: bottomCenterPoint.lng, lat: bottomCenterPoint.lat },
              ringPoints: rings
          });
      }

    // 视图居中：根据已绘制的GCJ-02点
    function fitViewportToPolygons() {
        const points = [];
        try {
            if (!map || !map.setViewport) return;
            polygonInfoList.forEach(info => {
                if (!info || !info.ringPoints) return;
                info.ringPoints.forEach(ring => {
                    ring.forEach(ll => points.push(ll));
                });
            });
            if (!points.length) return;
            map.setViewport(points);
        } catch (e) {
            try {
                const lngs = points.map(p => p.lng);
                const lats = points.map(p => p.lat);
                const center = new T.LngLat(
                    (Math.min(...lngs) + Math.max(...lngs)) / 2,
                    (Math.min(...lats) + Math.max(...lats)) / 2
                );
                if (map && map.panTo) map.panTo(center);
            } catch (e2) {
                console.warn('视图居中失败:', e2);
            }
        }
    }

    // 统一创建所有多边形的标签
    function createAllLabels() {
        const mapContainer = document.getElementById('mapContainer');
        if (!mapContainer || !map) return;

        polygonInfoList.forEach(info => {
            if (!info) return;
            // 防止重复创建
            if (info.labelRef) return;
            // 创建标签元素
            const labelDiv = document.createElement('div');
            labelDiv.className = 'area-label';
            labelDiv.innerHTML = `多边形${info.index}：${info.area}亩`;

            // 添加到地图容器并根据屏幕边界定位到轮廓下方
            mapContainer.appendChild(labelDiv);
            positionLabelForPolygon(labelDiv, info);

            // 记录引用，避免重复创建
            info.labelRef = labelDiv;

            // 存储到 currentPolygons 以复用现有定位/清理逻辑
            const labelObj = {
                domElement: labelDiv,
                isDomLabel: true,
                polygonInfo: info
            };
            currentPolygons.push({ polygon: info.polygon, label: labelObj });
        });

        // 不清空 polygonInfoList，便于开关随时创建/隐藏标签
    }

    // 根据多边形屏幕边界定位标签，保证始终在轮廓下方
    function positionLabelForPolygon(labelDiv, info) {
        if (!map || !info || !info.ringPoints) return;
        const points = [];
        info.ringPoints.forEach(ring => {
            ring.forEach(ll => {
                const p = map.lngLatToContainerPoint(ll);
                points.push(p);
            });
        });
        if (!points.length) return;
        const minX = Math.min(...points.map(p => p.x));
        const maxX = Math.max(...points.map(p => p.x));
        const maxY = Math.max(...points.map(p => p.y));
        const container = document.getElementById('mapContainer');
        const labelWidth = labelDiv.offsetWidth;
        const labelHeight = labelDiv.offsetHeight;
        const targetLeft = Math.round((minX + maxX) / 2 - labelWidth / 2);
        const targetTop = Math.round(maxY + 6);
        const clampedLeft = Math.max(0, Math.min(targetLeft, container.clientWidth - labelWidth));
        const clampedTop = Math.max(0, Math.min(targetTop, container.clientHeight - labelHeight));
        labelDiv.style.left = clampedLeft + 'px';
        labelDiv.style.top = clampedTop + 'px';
    }

    // 更新所有标签位置（地图move/zoom时调用）
    function updateAllLabelsPosition() {
        try {
            if (!map) return;
            const container = document.getElementById('mapContainer');
            if (!container) return;
            currentPolygons.forEach(item => {
                if (!item || !item.label) return;
                const labelObj = item.label;
                if (labelObj.isDomLabel && labelObj.domElement && labelObj.polygonInfo) {
                    // 确保标签在容器中
                    if (!labelObj.domElement.parentNode) {
                        container.appendChild(labelObj.domElement);
                    }
                    positionLabelForPolygon(labelObj.domElement, labelObj.polygonInfo);
                }
            });
        } catch (e) {
            console.warn('更新标签位置时出错:', e);
        }
    }
    // 确保在全局可用（处理第三方库事件回调作用域差异）
    window.updateAllLabelsPosition = updateAllLabelsPosition;

    // 绑定“显示亩数标签”开关（默认隐藏）
    function bindLabelsToggle() {
        const cb = document.getElementById('toggleLabelsCheckbox');
        const container = document.getElementById('mapContainer');
        if (!cb || !container) return;
        // 默认隐藏标签
        container.classList.add('labels-hidden');
        cb.addEventListener('change', () => {
            labelsEnabled = cb.checked;
            if (labelsEnabled) {
                container.classList.remove('labels-hidden');
                const hasAnyLabel = currentPolygons.some(item => item && item.label && item.label.domElement);
                if (!hasAnyLabel) {
                    try { createAllLabels(); } catch (e) { console.warn('创建标签失败:', e); }
                }
                updateAllLabelsPosition();
            } else {
                container.classList.add('labels-hidden');
            }
        });
    }

    /**
     * 计算多边形中心点（比底部中心更适合显示标签）
     */
    function calculatePolygonCenter(outerRing) {
        let sumLng = 0, sumLat = 0;
        const len = outerRing.length;

        for (let i = 0; i < len; i++) {
            sumLng += outerRing[i][0];
            sumLat += outerRing[i][1];
        }

        return {
            lng: sumLng / len,
            lat: sumLat / len
        };
    }

    /**
     * 计算多边形面积（球面多边形面积计算）
     * 使用更准确的球面坐标面积计算方法，确保面积与视觉大小一致
     */
    function calculatePolygonArea(coordinates) {
        // 地球半径（米）- 使用更精确的值
        const R = 6371000.8;
        const n = coordinates.length;

        // 将所有坐标转换为弧度
        const coordsRad = coordinates.map(point => [
            point[0] * Math.PI / 180,
            point[1] * Math.PI / 180
        ]);

        let areaRad = 0;

        // 使用更准确的球面多边形面积公式（Girard定理）
        for (let i = 0; i < n; i++) {
            const j = (i + 1) % n;
            const lon1 = coordsRad[i][0];
            const lat1 = coordsRad[i][1];
            const lon2 = coordsRad[j][0];
            const lat2 = coordsRad[j][1];

            // 计算球面多边形面积增量
            const dlon = lon2 - lon1;
            const sinLat1 = Math.sin(lat1);
            const sinLat2 = Math.sin(lat2);
            const cosLat1 = Math.cos(lat1);
            const cosLat2 = Math.cos(lat2);

            // 使用更精确的公式
            areaRad += dlon * (sinLat1 * cosLat2 * Math.cos(dlon / 2) + sinLat2 * cosLat1);
        }

        // 计算总面积（平方米）
        const areaSqm = Math.abs(areaRad) * R * R * 0.5;

        return areaSqm;
    }

    /**
     * 清空所有多边形和标签（同时处理 polygonInfoList 与 currentPolygons）
     */
    function clearOverlays() {
        try {
            // 先移除 polygonInfoList 中记录的多边形与其DOM标签
            polygonInfoList.forEach(info => {
                if (info && info.polygon && map && map.removeOverLay) {
                    try { map.removeOverLay(info.polygon); } catch (e) { console.warn('移除多边形失败:', e); }
                }
                if (info && info.labelRef && info.labelRef.parentNode) {
                    try { info.labelRef.parentNode.removeChild(info.labelRef); } catch (e) { console.warn('移除DOM标签失败:', e); }
                    info.labelRef = null;
                }
            });

            // 再处理 currentPolygons（兼容旧路径与标签对象）
            currentPolygons.forEach(item => {
                if (item.polygon && map && map.removeOverLay) {
                    try { map.removeOverLay(item.polygon); } catch (e) { console.warn('移除多边形失败:', e); }
                }
                if (item.label) {
                    if (item.label.domElement && item.label.domElement.parentNode) {
                        try { item.label.domElement.parentNode.removeChild(item.label.domElement); } catch (e) { console.warn('移除DOM标签失败:', e); }
                    } else if (map && map.removeOverLay && !item.label.isDomLabel) {
                        try { map.removeOverLay(item.label); } catch (e) { console.warn('移除地图覆盖物标签失败:', e); }
                    }
                }
            });

            // 清空记录数组
            currentPolygons = [];
            polygonInfoList = [];

            console.log('已清空所有多边形和标签（保留事件监听器）');
        } catch (error) {
            console.error('清空覆盖物时出错:', error);
        }
    }

    // 其他辅助函数（保持不变）
    function bindMinimizeEvent() {
        const container = document.querySelector(".wkt-input-container");
        const btn = document.getElementById("minimizeBtn");
        const minIcon = btn?.querySelector(".min-icon");
        const restoreIcon = btn?.querySelector(".restore-icon");

        btn?.addEventListener("click", () => {
            const minimized = container.classList.toggle("minimized");
            if (minIcon && restoreIcon) {
                if (minimized) {
                    minIcon.style.display = "none";
                    restoreIcon.style.display = "";
                } else {
                    minIcon.style.display = "";
                    restoreIcon.style.display = "none";
                }
            }
        });
    }

    // 在脚本内部补充：页签切换（3个页签）
     function bindTabs() {
         const tabs = [
             { btn: document.getElementById('tabDrawBtn'), pane: document.getElementById('tabDraw'), key: 'draw' },
             { btn: document.getElementById('tabTrackBtn'), pane: document.getElementById('tabTrack'), key: 'track' },
             { btn: document.getElementById('tabSplitBtn'), pane: document.getElementById('tabSplit'), key: 'split' },
             { btn: document.getElementById('tabBatchBtn'), pane: document.getElementById('tabBatch'), key: 'batch' },
         ];
         if (tabs.some(t => !t.btn || !t.pane)) return;
         function activate(key) {
             tabs.forEach(t => {
                 const active = t.key === key;
                 t.btn.classList.toggle('active', active);
                 t.pane.classList.toggle('active', active);
             });
         }
         tabs.forEach(t => t.btn.addEventListener('click', () => activate(t.key)));
         activate('draw');
     }
    function updateParserStatus() {
        const el = document.getElementById('parserStatus');
        if (!el) return;
        const ok = (typeof Terraformer !== 'undefined' && Terraformer.WKT && typeof Terraformer.WKT.parse === 'function');
        if (ok) {
            el.textContent = 'Terraformer WKT Parser';
            el.style.color = '#2f8f2f';
        } else {
            el.textContent = '本地回退解析（仅支持POLYGON/MULTIPOLYGON）';
            el.style.color = '#c77d1e';
        }
    }
     function parseWkt(wkt) {
         wkt = wkt.trim();
         // 优先使用成熟库（Terraformer WKT Parser）
         if (typeof Terraformer !== 'undefined' && Terraformer.WKT && Terraformer.WKT.parse) {
             try {
                 return Terraformer.WKT.parse(wkt);
             } catch (e) {
                 console.warn('Terraformer解析失败，尝试本地回退解析:', e);
             }
         } else {
             // 不再提示“未加载”，由状态栏展示回退信息
         }
         // 回退解析：仅支持 POLYGON / MULTIPOLYGON
         const typeMatch = wkt.match(/^\s*(POLYGON|MULTIPOLYGON)\s*\(/i);
         if (!typeMatch) throw new Error('仅支持POLYGON/MULTIPOLYGON');
         const type = typeMatch[1].toUpperCase();
         const inner = wkt.substring(wkt.indexOf('('));
         if (type === 'POLYGON') {
             const coords = parsePolygonCoords(inner.replace(/^\(/, '').replace(/\)$/, ''));
             return { type: 'Polygon', coordinates: coords };
         } else {
             const trimmed = inner.replace(/^\(\(/, '').replace(/\)\)$/, '');
             const coords = parseMultiPolygonCoords(trimmed);
             return { type: 'MultiPolygon', coordinates: coords };
         }
     }

     function bindMultiSplitter() {
         const input = document.getElementById('multiInput');
         const output = document.getElementById('polyOutput');
         const splitBtn = document.getElementById('splitMultiBtn');
         const copyBtn = document.getElementById('copyPolysBtn');
         if (!input || !output || !splitBtn || !copyBtn) return;

         // 本地WKT序列化辅助
         function ringToText(ring) {
             if (!ring || !ring.length) return '()';
             const first = ring[0];
             const last = ring[ring.length - 1];
             const closed = (first[0] === last[0] && first[1] === last[1]) ? ring : ring.concat([[first[0], first[1]]]);
             return '(' + closed.map(pt => pt[0] + ' ' + pt[1]).join(', ') + ')';
         }
         function toWktPolygonCoords(coords) {
             return 'POLYGON(' + coords.map(ringToText).join(', ') + ')';
         }
         function toWktMulti(coords) {
             return 'MULTIPOLYGON(' + coords.map(poly => '(' + poly.map(ringToText).join(', ') + ')').join(', ') + ')';
         }

         function polygonsFromMulti(text) {
             const geo = parseWkt(text.trim());
             if (geo.type !== 'MultiPolygon') throw new Error('请输入有效的 MULTIPOLYGON WKT');
             const polys = geo.coordinates.map(rings => toWktPolygonCoords(rings));
             return polys;
         }
         splitBtn.addEventListener('click', () => {
             try {
                 const list = polygonsFromMulti(input.value.trim());
                 output.value = list.join('\n');
             } catch (e) {
                 alert('分割失败：' + e.message);
             }
         });
         copyBtn.addEventListener('click', async () => {
             const val = output.value.trim();
             if (!val) { alert('没有可复制的结果'); return; }
             try { await navigator.clipboard.writeText(val); alert('已复制到剪贴板'); } catch (e) { console.warn('复制失败', e); }
         });
     }

     function bindBatchGenerator() {
         const batchInput = document.getElementById('batchInput');
         const output = document.getElementById('multiOutput');
         const genBtn = document.getElementById('generateMultiBtn');
         const copyBtn = document.getElementById('copyMultiBtn');

         // 本地WKT序列化辅助（与分割器保持一致）
         function ringToText(ring) {
             if (!ring || !ring.length) return '()';
             const first = ring[0];
             const last = ring[ring.length - 1];
             const closed = (first[0] === last[0] && first[1] === last[1]) ? ring : ring.concat([[first[0], first[1]]]);
             return '(' + closed.map(pt => pt[0] + ' ' + pt[1]).join(', ') + ')';
         }
         function toWktMulti(coords) {
             return 'MULTIPOLYGON(' + coords.map(poly => '(' + poly.map(ringToText).join(', ') + ')').join(', ') + ')';
         }

         genBtn.addEventListener('click', () => {
             try {
                 const lines = batchInput.value.trim().split(/\n|;/).map(s => s.trim()).filter(Boolean);
                 if (lines.length === 0) throw new Error('请按每行或分号输入至少一个POLYGON');
                 const polygons = lines.map((line, idx) => {
                     const g = parseWkt(line);
                     if (g.type !== 'Polygon') throw new Error(`第${idx + 1}行不是有效的POLYGON WKT`);
                     return g;
                 });
                 const multiGeo = { type: 'MultiPolygon', coordinates: polygons.map(p => p.coordinates) };
                 output.value = toWktMulti(multiGeo.coordinates);
             } catch (e) {
                 alert('生成失败：' + e.message);
             }
         });

         copyBtn.addEventListener('click', async () => {
             const val = output.value.trim();
             if (!val) { alert('没有可复制的结果'); return; }
             try { await navigator.clipboard.writeText(val); alert('已复制到剪贴板'); } catch (e) { console.warn('复制失败', e); }
         });

     }

     function setExampleWkt() {
         const exampleWkt = "MULTIPOLYGON(" +
             "(" +
             "(116.35 39.93, 116.39 39.93, 116.39 39.90, 116.35 39.90, 116.35 39.93)," + // 外环
             "(116.36 39.92, 116.38 39.92, 116.38 39.91, 116.36 39.91, 116.36 39.92)" +  // 内环
             ")," +
             "(" +
             "(116.40 39.95, 116.43 39.97, 116.46 39.96, 116.49 39.98, 116.52 39.95, 116.55 39.93, 116.58 39.94, 116.61 39.92, 116.64 39.95, 116.40 39.95)" +
             ")" +
             ")";
         document.getElementById("wktTextarea").value = exampleWkt;
     }

     function parsePolygonCoords(coordStr) {
         const ringStrs = coordStr.split(/\)\s*,\s*\(/).map(s => s.replace(/[()]/g, '').trim());
         const rings = [];
         ringStrs.forEach(ringStr => {
             const pts = ringStr.split(/,\s*/).map(pointStr => {
                 const [lng, lat] = pointStr.split(/\s+/).map(Number);
                 if (isNaN(lng) || isNaN(lat)) throw new Error("坐标格式错误：" + pointStr);
                 return [lng, lat];
             });
             // 自动拆分：如果一个ring中包含多次回到起点（闭合），则拆分为多个环
             // 兼容用户将外环与内环错误地写在同一对括号中的情况
             let start = 0;
             while (start < pts.length) {
                 const startPt = pts[start];
                 let closeIdx = -1;
                 for (let i = start + 1; i < pts.length; i++) {
                     if (pts[i][0] === startPt[0] && pts[i][1] === startPt[1]) {
                         closeIdx = i;
                         break;
                     }
                 }
                 if (closeIdx === -1) {
                     // 未找到闭合：将剩余点视为一个环，并强制闭合
                     const ring = pts.slice(start);
                     if (ring.length && (ring[0][0] !== ring[ring.length - 1][0] || ring[0][1] !== ring[ring.length - 1][1])) {
                         ring.push([ring[0][0], ring[0][1]]);
                     }
                     rings.push(ring);
                     break;
                 } else {
                     const ring = pts.slice(start, closeIdx + 1);
                     rings.push(ring);
                     start = closeIdx + 1;
                 }
             }
         });
         return rings;
     }

     function parseMultiPolygonCoords(coordStr) {
         const polygonStrs = coordStr.split(/\)\s*\)\s*,\s*\(\s*\(/).map(s => s.replace(/[()]/g, '').trim());
         return polygonStrs.map(polygonStr => parsePolygonCoords(polygonStr));
     }

     function wgs84ToGcj02(lng, lat) {
         const x_PI = 3.14159265358979324 * 3000.0 / 180.0;
         const PI = 3.1415926535897932384626;
         const a = 6378245.0;
         const ee = 0.00669342162296594323;

         if (outOfChina(lng, lat)) return { lng, lat };

         let dlat = transformLat(lng - 105.0, lat - 35.0);
         let dlng = transformLng(lng - 105.0, lat - 35.0);
         const radlat = lat / 180.0 * PI;
         let magic = Math.sin(radlat);
         magic = 1 - ee * magic * magic;
         const sqrtmagic = Math.sqrt(magic);
         dlat = (dlat * 180.0) / ((a * (1 - ee)) / (magic * sqrtmagic) * PI);
         dlng = (dlng * 180.0) / (a / sqrtmagic * Math.cos(radlat) * PI);

         return { lng: lng + dlng, lat: lat + dlat };

         function outOfChina(lng, lat) {
             return (lng < 72.004 || lng > 137.8347) || (lat < 0.8293 || lat > 55.8271);
         }

         function transformLat(x, y) {
             let ret = -100.0 + 2.0 * x + 3.0 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * Math.sqrt(Math.abs(x));
             ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
             ret += (20.0 * Math.sin(y * PI) + 40.0 * Math.sin(y / 3.0 * PI)) * 2.0 / 3.0;
             ret += (160.0 * Math.sin(y / 12.0 * PI) + 320 * Math.sin(y * PI / 30.0)) * 2.0 / 3.0;
             return ret;
         }

         function transformLng(x, y) {
             let ret = 300.0 + x + 2.0 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * Math.sqrt(Math.abs(x));
             ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
             ret += (20.0 * Math.sin(x * PI) + 40.0 * Math.sin(x / 3.0 * PI)) * 2.0 / 3.0;
             ret += (150.0 * Math.sin(x / 12.0 * PI) + 300.0 * Math.sin(x / 30.0 * PI)) * 2.0 / 3.0;
             return ret;
         }
     }

     function gcj02ToWgs84(lng, lat) {
         const g = wgs84ToGcj02(lng, lat);
         return { lng: lng * 2 - g.lng, lat: lat * 2 - g.lat };
     }

     function bd09ToGcj02(bdLng, bdLat) {
         const x_PI = 3.14159265358979324 * 3000.0 / 180.0;
         const x = bdLng - 0.0065;
         const y = bdLat - 0.006;
         const z = Math.sqrt(x * x + y * y) - 0.00002 * Math.sin(y * x_PI);
         const theta = Math.atan2(y, x) - 0.000003 * Math.cos(x * x_PI);
         const ggLng = z * Math.cos(theta);
         const ggLat = z * Math.sin(theta);
         return { lng: ggLng, lat: ggLat };
     }

     function calculatePolygonBottomCenter(outerRing) {
         let minLat = Infinity;
         let bottomPoints = [];
         outerRing.forEach(point => {
             const lat = point[1];
             if (lat < minLat) {
                 minLat = lat;
                 bottomPoints = [point];
             } else if (lat === minLat) {
                 bottomPoints.push(point);
             }
         });

         const sumLng = bottomPoints.reduce((sum, point) => sum + point[0], 0);
         const centerLng = sumLng / bottomPoints.length;

         return { lng: centerLng, lat: minLat };
     }

     function fitBounds(geojson) {
         try {
             const allPoints = [];
             function collectPoints(coords) {
                 if (typeof coords[0] === 'number') {
                     allPoints.push(coords);
                 } else {
                     coords.forEach(coord => collectPoints(coord));
                 }
             }
             collectPoints(geojson.coordinates);

             if (allPoints.length === 0) return;

             const lats = allPoints.map(p => p[1]);
             const lngs = allPoints.map(p => p[0]);
             const minLng = Math.min(...lngs);
             const maxLng = Math.max(...lngs);
             const minLat = Math.min(...lats);
             const maxLat = Math.max(...lats);

             const sw = wgs84ToGcj02(minLng, minLat);
             const ne = wgs84ToGcj02(maxLng, maxLat);

             // 修复setViewport方法的使用，确保参数格式正确
             if (map && map.setViewport) {
                 map.setViewport([
                     new T.LngLat(sw.lng, sw.lat),
                     new T.LngLat(ne.lng, ne.lat)
                 ], { padding: [50, 50] });
             } else {
                 console.warn('地图对象或setViewport方法不可用');
             }
         } catch (error) {
             console.error('调整视图范围时出错:', error);
         }
     }
// 轨迹绘制与解析
    function bindTrackEvents() {
        const drawBtn = document.getElementById('drawTrackButton');
        const showPointsBtn = document.getElementById('showTrackPointsButton');
        const clearBtn = document.getElementById('clearTrackButton');
        const ta = document.getElementById('trackTextarea');
        if (!drawBtn || !showPointsBtn || !clearBtn || !ta) return;

        drawBtn.addEventListener('click', function(){
            try {
                const text = ta.value.trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const points = parseTrackText(text);
                if (points.length < 2) { alert('有效轨迹点不足，至少需要两点'); return; }
                drawTrackFromPoints(points);
                fitViewportToTrack(points);
            } catch (e) {
                alert('绘制轨迹失败：' + (e && e.message ? e.message : e));
                console.error('绘制轨迹异常:', e);
            }
        });

        showPointsBtn.addEventListener('click', function(){
            try {
                const text = ta.value.trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const points = parseTrackText(text);
                if (points.length === 0) { alert('未找到有效轨迹点'); return; }
                showTrackPoints(points);
                fitViewportToTrack(points);
            } catch (e) {
                alert('显示轨迹点失败：' + (e && e.message ? e.message : e));
                console.error('显示轨迹点异常:', e);
            }
        });

        clearBtn.addEventListener('click', function(){
            clearTrackOverlays();
            console.log('已清空轨迹');
        });
    }

    function showTrackPoints(points) {
        // 先移除旧轨迹（不影响轮廓）
        clearTrackOverlays(false);
        
        if (!map || !points || points.length === 0) {
            console.log('无轨迹点可显示');
            return;
        }
        
        console.log(`准备显示${points.length}个轨迹点`);
        
        // 使用批量处理和更小的图标来提高性能
        // 创建一个更小的红点SVG图标
        const smallRedDotIcon = new T.Icon({
            iconUrl: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1" height="1"><circle cx="0.5" cy="0.5" r="0.3" fill="%23FF0000"/></svg>',
            iconSize: new T.Point(1, 1),
            iconAnchor: new T.Point(0.5, 0.5)
        });
        
        // 优化批量添加点的速度
        const batchSize = 2000; // 增加每批处理的点数
        const concurrentBatches = 4; // 并发批次数量
        
        // 预创建点击事件处理函数，避免重复创建
        function createClickHandler(point, index) {
            return function() {
                const infoWindow = new T.InfoWindow({
                    content: `点${index + 1}<br/>经度: ${point.lng.toFixed(6)}<br/>纬度: ${point.lat.toFixed(6)}`,
                    offset: new T.Point(0, -20)
                });
                infoWindow.open(map, point);
            };
        }
        
        // 使用setTimeout实现更高效的批量添加，避免阻塞UI
        let currentIndex = 0;
        
        function addBatch() {
            if (currentIndex >= points.length) {
                console.log(`已显示${points.length}个轨迹点`);
                return;
            }
            
            // 添加当前批次的点
            const endIndex = Math.min(currentIndex + batchSize, points.length);
            const markersToAdd = [];
            
            // 先创建所有标记
            for (let i = currentIndex; i < endIndex; i++) {
                const point = points[i];
                const index = i;
                
                const marker = new T.Marker(point, {
                    icon: smallRedDotIcon
                });
                
                // 添加点击事件
                marker.addEventListener('click', createClickHandler(point, index));
                
                markersToAdd.push(marker);
            }
            
            // 批量添加到地图和数组
            markersToAdd.forEach(marker => {
                map.addOverLay(marker);
                currentTracks.push(marker);
            });
            
            currentIndex = endIndex;
            
            // 使用setTimeout而不是requestAnimationFrame，减少对渲染周期的依赖
            // 设置为0，将任务放入微任务队列，但允许UI有短暂的呼吸空间
            setTimeout(addBatch, 0);
        }
        
        // 启动批量添加
        addBatch();
    }
    
    // 恢复原始的clearTrackOverlays函数
    function clearTrackOverlays(resetArray = true){        
        try {
            currentTracks.forEach(pl => {
                if (pl && map && map.removeOverLay) {
                    try { map.removeOverLay(pl); } catch (e) { console.warn('移除轨迹失败:', e); }
                }
            });
            if (resetArray) currentTracks = [];
        } catch (e) {
            console.warn('清空轨迹时出错:', e);
        }
    }

    function parseTrackText(text){
        // 选择输入坐标系（优先使用轨迹页签专属选择器，若未设置则回退到绘制页签选择器）
        const coordSysEl = document.getElementById('trackCoordSysSelect') || document.getElementById('coordSysSelect');
        const coordSys = (coordSysEl && coordSysEl.value) || 'wgs84';
        const isHash = text.indexOf('#') !== -1;
        const items = isHash ? text.split('#') : text.split(/\r?\n/);
        const pts = [];
        for (let i=0;i<items.length;i++){
            const raw = items[i];
            if (!raw) continue;
            const line = raw.trim();
            if (!line) continue;
            const parts = line.split(',');
            if (parts.length < 3) continue;
            let lng = parseFloat((parts[isHash ? 0 : 1] || '').trim());
            let lat = parseFloat((parts[isHash ? 1 : 2] || '').trim());
            // 初步过滤：数值合法性与正常范围
            if (!isFinite(lng) || !isFinite(lat)) continue;
            if (lng === 0 || lat === 0) continue; // 丢弃0.0异常点
            if (lng < -180 || lng > 180 || lat < -90 || lat > 90) continue; // 超出经纬度范围丢弃

            // 将输入坐标转换为WGS84
            let w;
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                w = { lng, lat };
            } else if (coordSys === 'gcj02') {
                w = gcj02ToWgs84(lng, lat);
            } else if (coordSys === 'bd09') {
                const g = bd09ToGcj02(lng, lat);
                w = gcj02ToWgs84(g.lng, g.lat);
            } else {
                w = { lng, lat };
            }
            // 转换结果兜底检查
            if (!isFinite(w.lng) || !isFinite(w.lat)) continue;
            if (w.lng < -180 || w.lng > 180 || w.lat < -90 || w.lat > 90) continue;

            // 使用WGS84坐标绘制到地图
            pts.push(new T.LngLat(w.lng, w.lat));
        }
        return pts;
    }

    function drawTrackFromPoints(points){
        // 先移除旧轨迹（不影响轮廓）
        clearTrackOverlays(false);
        const polyline = new T.Polyline(points, {
            color: '#FF3B30',
            weight: 1,
            opacity: 0.9
        });
        if (map) {
            map.addOverLay(polyline);
        }
        currentTracks.push(polyline);
    }

    function clearTrackOverlays(resetArray = true){
        try {
            currentTracks.forEach(pl => {
                if (pl && map && map.removeOverLay) {
                    try { map.removeOverLay(pl); } catch (e) { console.warn('移除轨迹失败:', e); }
                }
            });
            if (resetArray) currentTracks = [];
        } catch (e) {
            console.warn('清空轨迹时出错:', e);
        }
    }


    function fitViewportToTrack(points){
        try {
            if (!map || !map.setViewport || !points || !points.length) return;
            map.setViewport(points);
        } catch (e) {
            console.warn('轨迹视图居中失败:', e);
        }
    }

    // ========= 轨迹回放功能 =========
    let playbackState = { points: [], idx: 0, speed: 1, timer: null, running: false, marker: null, line: null, path: [] };

    function bindPlaybackControls(){
        const startBtn = document.getElementById('playbackStartBtn');
        const pauseBtn = document.getElementById('playbackPauseBtn');
        const stopBtn = document.getElementById('playbackStopBtn');
        const speedSel = document.getElementById('playbackSpeedSelect');
        const timeSlider = document.getElementById('playbackTimeSlider');
        const timeCursor = document.getElementById('playbackTimeCursor');
        const ta = document.getElementById('trackTextarea');
        if (!startBtn || !pauseBtn || !stopBtn || !speedSel) return;

        // 初始按钮状态
        updatePlaybackButtonsState('idle');

        startBtn.addEventListener('click', function(){
            try {
                const text = (ta && ta.value || '').trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const pts = parseTrackTextWithTime(text);
                if (pts.length < 2) { alert('有效轨迹点不足，至少需要两点'); return; }
                startPlayback(pts);
                // 状态在startPlayback中已设置为playing
            } catch (e) {
                alert('开始回放失败：' + (e && e.message ? e.message : e));
                console.error('开始回放异常:', e);
            }
        });

        pauseBtn.addEventListener('click', function(){
            if (!playbackState.running) {
                // 继续
                playbackState.running = true;
                scheduleNext();
                updatePlaybackButtonsState('playing');
            } else {
                // 暂停
                if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
                playbackState.running = false;
                updatePlaybackButtonsState('paused');
            }
        });

        stopBtn.addEventListener('click', function(){ 
            stopPlayback(); 
            updatePlaybackButtonsState('idle');
        });

        speedSel.addEventListener('change', function(){
            const v = parseFloat(speedSel.value);
            playbackState.speed = (isFinite(v) && v > 0) ? v : 1;
        });

        if (timeSlider) {
            timeSlider.addEventListener('input', function(){
                const ms = parseInt(timeSlider.value, 10);
                const txt = formatTimeForLabel(ms);
                if (timeCursor) timeCursor.textContent = txt;
            });
            timeSlider.addEventListener('change', function(){
                jumpToSliderTime();
            });
        }
    }

    function parseTrackTextWithTime(text){
        const coordSysEl = document.getElementById('trackCoordSysSelect') || document.getElementById('coordSysSelect');
        const coordSys = (coordSysEl && coordSysEl.value) || 'wgs84';
        const isHash = text.indexOf('#') !== -1;
        const items = isHash ? text.split('#') : text.split(/\r?\n/);
        const out = [];
        for (let i=0;i<items.length;i++){
            const raw = items[i];
            if (!raw) continue;
            const line = raw.trim();
            if (!line) continue;
            const parts = line.split(',');
            if (parts.length < 3) continue;
            const tsRaw = (parts[isHash ? 2 : 0] || '').trim();
            const ts = (tsRaw || '').replace(/\D/g,'');
            let lng = parseFloat((parts[isHash ? 0 : 1] || '').trim());
            let lat = parseFloat((parts[isHash ? 1 : 2] || '').trim());
            if (!isFinite(lng) || !isFinite(lat)) continue;
            if (lng === 0 || lat === 0) continue;
            if (lng < -180 || lng > 180 || lat < -90 || lat > 90) continue;
            const t = parseTimestamp(ts);
            if (!t) continue;
            let w;
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                w = { lng, lat };
            } else if (coordSys === 'gcj02') {
                w = gcj02ToWgs84(lng, lat);
            } else if (coordSys === 'bd09') {
                const g = bd09ToGcj02(lng, lat);
                w = gcj02ToWgs84(g.lng, g.lat);
            } else { w = { lng, lat }; }
            if (!isFinite(w.lng) || !isFinite(w.lat)) continue;
            if (w.lng < -180 || w.lng > 180 || w.lat < -90 || w.lat > 90) continue;
            out.push({ ll: new T.LngLat(w.lng, w.lat), time: t, ts });
        }
        out.sort((a,b)=>a.time - b.time);
        return out;
    }

    function parseTimestamp(ts){
        const tstr = (ts || '').replace(/\D/g,'');
        const m = tstr && tstr.match(/^\d{14}$/);
        if (!m) return null;
        const y = parseInt(tstr.slice(0,4),10);
        const M = parseInt(tstr.slice(4,6),10) - 1;
        const d = parseInt(tstr.slice(6,8),10);
        const h = parseInt(tstr.slice(8,10),10);
        const m2 = parseInt(tstr.slice(10,12),10);
        const s = parseInt(tstr.slice(12,14),10);
        const dt = new Date(y,M,d,h,m2,s);
        return isNaN(dt.getTime()) ? null : dt;
    }

    function startPlayback(points){
        console.log('[Playback] startPlayback: 点数=', points && points.length);
        stopPlayback();
        playbackState.points = points;
        playbackState.idx = 0;
        playbackState.speed = playbackState.speed || 1;
        playbackState.running = true;
        // 配置时间滑动条，并尊重现有滑块位置作为起始
        configureTimeSlider(points);
        // 启用滑块
        const slider = document.getElementById('playbackTimeSlider');
        if (slider) slider.disabled = false;
        let initIdx = 0;
        if (slider && slider.min && slider.max) {
            const ms = parseInt(slider.value, 10);
            if (isFinite(ms)) initIdx = findIndexByTime(points, ms);
        }
        playbackState.idx = initIdx;
        const first = points[initIdx];
        console.log('[Playback] 首点:', first && first.ts, first && first.ll, 'initIdx=', initIdx);
        playbackState.path = points.slice(0, initIdx+1).map(p=>p.ll);
        playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 1, opacity: 0.9 });
        if (map) {
            map.addOverLay(playbackState.line);
        }
        currentTracks.push(playbackState.line);
        // 创建并定位DOM标记以保证可见移动
        ensurePlaybackDom(first.ll);
        updatePlaybackDom(first.ll);
        updatePlaybackTimeLabel(first.ts);
        try { fitViewportToTrack(points.map(p=>p.ll)); } catch(e){}
        // 更新按钮状态
        updatePlaybackButtonsState('playing');
        scheduleNext();
    }

    function scheduleNext(){
        if (!playbackState.running) return;
        if (!playbackState.points || playbackState.idx >= playbackState.points.length - 1) {
            playbackState.running = false;
            console.log('[Playback] 回放结束：idx=', playbackState.idx, '点数=', playbackState.points ? playbackState.points.length : 0);
            updatePlaybackButtonsState('idle'); // 播放结束后按钮回到初始状态：开始可点，继续/结束灰化
            return;
        }
        const next = playbackState.points[playbackState.idx+1];
        const speed = playbackState.speed || 1;
        const delay = Math.max(4, Math.round(1000 / speed)); // 1x=1000ms/点，2x=500ms/点...
        console.log('[Playback] scheduleNext: idx=', playbackState.idx, '->', playbackState.idx+1, 'delay=', delay, 'speed=', speed);
        playbackState.timer = setTimeout(()=>{
            playbackState.idx++;
            const nextLL = next.ll;
            console.log('[Playback] 下一点:', next && next.ts, nextLL);
            try {
                // 维护路径数组
                playbackState.path = playbackState.path || [];
                playbackState.path.push(nextLL);
                console.log('[Playback] 路径长度=', playbackState.path.length);
                // 使用DOM标记进行移动（容器/图层坐标）
                if (!playbackDom.el) console.log('[Playback] DOM标记不存在，将尝试创建');
                updatePlaybackDom(nextLL);
                // 折线更新：优先setLngLats，兜底重建
                if (playbackState.line && typeof playbackState.line.setLngLats === 'function') {
                    try { playbackState.line.setLngLats(playbackState.path); }
                    catch(e){
                        console.warn('[Playback] setLngLats失败，重建折线', e);
                        if (map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                        playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 1, opacity: 0.9 });
                        if (map) map.addOverLay(playbackState.line);
                    }
                } else {
                    console.log('[Playback] 折线不支持setLngLats，重建');
                    if (playbackState.line && map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                    playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 1, opacity: 0.9 });
                    if (map) map.addOverLay(playbackState.line);
                }
            } catch(e) { console.warn('更新回放覆盖物失败:', e); }
            updatePlaybackTimeLabel(next.ts);
            scheduleNext();
        }, delay);
    }

    function stopPlayback(){
        if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
        playbackState.running = false;
        playbackState.idx = 0;
        try {
            // 移除DOM标记
            removePlaybackDom();
            if (playbackState.marker && map) map.removeOverLay(playbackState.marker);
            if (playbackState.line && map) map.removeOverLay(playbackState.line);
        } catch(e){}
        playbackState.marker = null;
        playbackState.line = null;
        updatePlaybackTimeLabel('—');
        // 按钮回到初始状态
        updatePlaybackButtonsState('idle');
    }

    function updatePlaybackTimeLabel(text){
        const el = document.getElementById('playbackTimeLabel');
        if (el) el.textContent = '时间：' + (text || '—');
    }

    // 时间滑动条：配置与跳转
    function configureTimeSlider(points){
        try {
            const slider = document.getElementById('playbackTimeSlider');
            const cursor = document.getElementById('playbackTimeCursor');
            if (!slider || !points || !points.length) return;
            const minMs = points[0].time.getTime();
            const maxMs = points[points.length - 1].time.getTime();
            const prev = parseInt(slider.value, 10);
            slider.min = String(minMs);
            slider.max = String(maxMs);
            slider.step = '1000'; // 以秒为步进
            let val = (isFinite(prev) && prev >= minMs && prev <= maxMs) ? prev : minMs;
            slider.value = String(val);
            if (cursor) cursor.textContent = formatTimeForLabel(val);
        } catch(e) { console.warn('配置时间滑动条失败:', e); }
    }
    function formatTimeForLabel(ms){
        if (!isFinite(ms)) return '—';
        const d = new Date(ms);
        const pad = n => String(n).padStart(2,'0');
        const y = d.getFullYear();
        const M = pad(d.getMonth()+1);
        const da = pad(d.getDate());
        const h = pad(d.getHours());
        const m = pad(d.getMinutes());
        const s = pad(d.getSeconds());
        return `${y}-${M}-${da} ${h}:${m}:${s}`;
    }
    function findIndexByTime(points, ms){
        try {
            if (!points || !points.length) return 0;
            const n = points.length;
            const minMs = points[0].time.getTime();
            const maxMs = points[n-1].time.getTime();
            if (!isFinite(ms)) return 0;
            if (ms <= minMs) return 0;
            if (ms >= maxMs) return n-1;
            let lo = 0, hi = n - 1, ans = 0;
            while (lo <= hi) {
                const mid = (lo + hi) >> 1;
                const t = points[mid].time.getTime();
                if (t < ms) { lo = mid + 1; ans = lo; }
                else { hi = mid - 1; ans = mid; }
            }
            return Math.max(0, Math.min(n-1, ans));
        } catch(e){ console.warn('findIndexByTime失败:', e); return 0; }
    }
    function jumpToSliderTime(){
        try {
            const slider = document.getElementById('playbackTimeSlider');
            if (!slider || !playbackState.points || !playbackState.points.length) return;
            const ms = parseInt(slider.value, 10);
            if (!isFinite(ms)) return;
            const idx = findIndexByTime(playbackState.points, ms);
            playbackState.idx = idx;
            const pts = playbackState.points;
            const ll = pts[idx].ll;
            playbackState.path = pts.slice(0, idx+1).map(p=>p.ll);
            // 更新折线
            try {
                if (playbackState.line && typeof playbackState.line.setLngLats === 'function') {
                    playbackState.line.setLngLats(playbackState.path);
                } else {
                    if (playbackState.line && map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                    playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 1, opacity: 0.9 });
                    if (map) map.addOverLay(playbackState.line);
                }
            } catch(e){ console.warn('滑块更新折线失败:', e); }
            // 更新标记与时间
            ensurePlaybackDom(ll);
            updatePlaybackDom(ll);
            updatePlaybackTimeLabel(pts[idx].ts);
            // 若正在播放，立即按新位置继续
            if (playbackState.running) {
                if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
                scheduleNext();
            }
        } catch(e) { console.warn('滑块跳转失败:', e); }
    }

    // DOM标记：使用容器坐标实现可见移动
    let playbackDom = { el: null, lastLL: null, bound: false };

    function ensurePlaybackDom(ll){
        try {
            playbackDom.lastLL = ll;
            const pane = (map && map.getPanes && map.getPanes().overlayPane) || document.getElementById('mapContainer');
            if (!pane) { console.warn('未找到overlayPane或mapContainer'); return; }
            if (!playbackDom.el) {
                const el = document.createElement('div');
                el.id = 'playbackDomMarker';
                el.style.position = 'absolute';
                el.style.width = '16px';
                el.style.height = '16px';
                el.style.borderRadius = '50%';
                el.style.background = '#2C64A7';
                el.style.border = '2px solid #fff';
                el.style.boxShadow = '0 0 0 1px rgba(0,0,0,.25)';
                el.style.zIndex = '9999';
                pane.appendChild(el);
                playbackDom.el = el;
                console.log('[Playback] 创建DOM标记，父节点=', pane === document.getElementById('mapContainer') ? '#mapContainer' : 'overlayPane');
                bindPlaybackDomEvents();
            }
            updatePlaybackDom(ll);
        } catch(e) { console.warn('创建DOM标记失败:', e); }
    }

    function updatePlaybackDom(ll){
        try {
            playbackDom.lastLL = ll;
            if (!map || !playbackDom.el || !ll) { console.log('[Playback] update取消：map/el/ll缺失'); return; }
            let p;
            if (typeof map.lngLatToLayerPoint === 'function') {
                p = map.lngLatToLayerPoint(ll);
                console.log('[Playback] 使用layerPoint定位:', ll && ll.lng, ll && ll.lat, '=>', p && p.x, p && p.y);
            } else if (typeof map.lngLatToContainerPoint === 'function') {
                p = map.lngLatToContainerPoint(ll);
                console.log('[Playback] 使用containerPoint定位:', ll && ll.lng, ll && ll.lat, '=>', p && p.x, p && p.y);
            } else {
                console.warn('地图对象不支持lngLat到像素坐标转换');
                return;
            }
            playbackDom.el.style.left = p.x + 'px';
            playbackDom.el.style.top = p.y + 'px';
        } catch(e) { console.warn('更新DOM标记位置失败:', e); }
    }

    function bindPlaybackDomEvents(){
        if (playbackDom.bound) return;
        const updater = function(){
            try {
                if (!map || !playbackDom.el || !playbackDom.lastLL) return;
                let p;
                if (typeof map.lngLatToLayerPoint === 'function') {
                    p = map.lngLatToLayerPoint(playbackDom.lastLL);
                } else if (typeof map.lngLatToContainerPoint === 'function') {
                    p = map.lngLatToContainerPoint(playbackDom.lastLL);
                }
                if (!p) return;
                playbackDom.el.style.left = p.x + 'px';
                playbackDom.el.style.top = p.y + 'px';
            } catch(e){}
        };
        try {
            map.addEventListener('move', updater);
            map.addEventListener('zoom', updater);
            playbackDom.bound = true;
        } catch(e){}
    }

    function removePlaybackDom(){
        try {
            const el = playbackDom.el;
            playbackDom.lastLL = null;
            if (el && el.parentNode) el.parentNode.removeChild(el);
        } catch(e){}
        playbackDom.el = null;
        playbackDom.bound = false;
    }

</script>
</body>

</html>
