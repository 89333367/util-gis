<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>展示轮廓</title>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #mapContainer {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        #mapLoading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
            transition: opacity 0.3s;
        }

        .loading-text {
            font-size: 16px;
            color: #333;
            padding: 10px 20px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .wkt-input-container {
            position: absolute;
            top: 20px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            width: min(320px, 90vw);
            box-sizing: border-box;
            transition: all 0.3s;
        }

        .minimize-btn {
            position: absolute;
            top: -5px;
            right: -4px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #f0f0f0;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #666;
            z-index: 1001;
            transition: background 0.2s;
        }

        .minimize-btn:hover {
            background: #e0e0e0;
        }

        .content-wrapper {
            transition: all 0.3s;
        }

        .wkt-input-container.minimized {
            width: 40px;
            height: 40px;
            padding: 0;
        }

        .wkt-input-container.minimized .content-wrapper {
            display: none;
        }

        .wkt-input-container.minimized .min-icon {
            display: none;
        }

        .wkt-input-container.minimized .restore-icon {
            display: inline;
        }

        #wktTextarea {
            width: 100%;
            height: 120px;
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
            box-sizing: border-box;
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        /* 页签样式 */
        .tabs-header {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .tab-btn {
            flex: 1;
            padding: 6px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            background: #f5f5f5;
            color: #333;
            transition: background 0.2s;
        }
        .tab-btn.active { background: #337AFF; color: #fff; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        /* Multi → Polygons 分割器样式 */
        .split-section {
            margin-top: 10px;
            padding: 10px;
            background: #fafafa;
            border: 1px solid #eee;
            border-radius: 6px;
        }
        .split-section .title {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
        }
        .split-section .desc {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        #multiInput, #polyOutput {
            width: 100%;
            height: 90px;
            margin-bottom: 8px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
            box-sizing: border-box;
        }
        .split-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .split-actions button {
            flex: 1;
            padding: 6px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }
        #splitMultiBtn { background: #337AFF; color: #fff; }
        #splitMultiBtn:hover { background: #2860E0; }
        #copyPolysBtn { background: #f5f5f5; color: #333; }
        #copyPolysBtn:hover { background: #e0e0e0; }
        #drawButton,
        #clearButton,
        #drawTrackButton,
        #clearTrackButton {
            width: 50%;
            padding: 8px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        #drawButton,
        #drawTrackButton {
            background: #337AFF;
            color: white;
        }

        #drawButton:hover,
        #drawTrackButton:hover {
            background: #2860E0;
        }

        #clearButton,
        #clearTrackButton {
            background: #f5f5f5;
            color: #333;
        }

        #clearButton:hover,
        #clearTrackButton:hover {
            background: #e0e0e0;
        }

        #drawButton:disabled,
        #clearButton:disabled,
        #drawTrackButton:disabled,
        #clearTrackButton:disabled {
            background: #e0e0e0;
            color: #999;
            cursor: not-allowed;
        }

        .tip {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .area-label {
             position: absolute;
             background: rgba(255, 0, 0, 0.85);
             border: 1px solid #000;
             border-radius: 3px;
             padding: 4px 6px;
             font-size: 12px;
             color: #fff;
             font-weight: 600;
             box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
             white-space: nowrap;
             z-index: 9999;
             pointer-events: none;
         }
         /* 默认隐藏标签容器下的标签 */
          .labels-hidden .area-label { display: none; }

          /* Batch → Generator 样式 */
          .batch-section { margin-top: 10px; padding: 10px; background: #fafafa; border: 1px solid #eee; border-radius: 6px; }
          .batch-section .title { font-size: 13px; font-weight: 600; color: #333; margin-bottom: 6px; }
          .batch-section .desc { font-size: 12px; color: #666; margin-bottom: 8px; }
          #batchInput, #multiOutput { width: 100%; height: 90px; margin-bottom: 8px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; resize: vertical; box-sizing: border-box; }
          .batch-actions { display: flex; gap: 8px; margin-bottom: 8px; }
          .batch-actions button { flex: 1; padding: 6px 0; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; transition: background 0.2s; }
          #generateMultiBtn { background: #337AFF; color: #fff; }
          #generateMultiBtn:hover { background: #2860E0; }
          #copyMultiBtn { background: #f5f5f5; color: #333; }
          #copyMultiBtn:hover { background: #e0e0e0; }
          
          /* 左侧工具条样式 */
          #leftToolbar {
              position: absolute;
              bottom: 20px;
              left: 20px;
              z-index: 1000;
              background: white;
              border-radius: 4px;
              box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
              padding: 6px 0;
              display: flex;
              flex-direction: column;
              gap: 2px;
              width: 40px;
          }
          
          .toolbar-btn {
              width: 100%;
              padding: 6px 0;
              border: none;
              background: transparent;
              cursor: pointer;
              font-size: 12px;
              color: #333;
              transition: background 0.2s;
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
          }
          
          .toolbar-btn:hover {
              background: #f5f5f5;
          }
          
          .toolbar-btn span {
              font-size: 12px;
              margin-top: 4px;
          }
          
          .toolbar-divider {
            height: 1px;
            background-color: #e0e0e0;
            margin: 2px 4px;
        }
        
        /* 颜色选择器样式 */
        .color-picker-container {
            margin-top: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }
        
        .color-picker-title {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        
        .color-picker-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .color-picker-label {
            font-size: 12px;
            color: #555;
            width: 60px;
            flex-shrink: 0;
        }
        
        .color-picker {
            width: 30px;
            height: 30px;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 8px;
            flex-shrink: 0;
        }
        
        .color-input {
            flex: 1;
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            font-family: monospace;
        }
        
        .opacity-slider-container {
            display: flex;
            align-items: center;
            margin-top: 8px;
        }
        
        .opacity-slider {
            flex: 1;
            margin-right: 8px;
        }
        
        .opacity-value {
            font-size: 12px;
            color: #555;
            width: 40px;
            text-align: right;
        }
      </style>
    <script src="https://api.tianditu.gov.cn/api?v=4.0&tk=648f621977051d0199ff0f965d3fd322"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
    <script src="https://lib.baomitu.com/terraformer/1.0.12/terraformer.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://unpkg.com/terraformer-wkt-parser@1.2.1/terraformer-wkt-parser.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- 已移除动态备用加载器 ensureTerraformer：改为仅使用静态脚本标签加载 Terraformer 核心库与 WKT 解析器 -->
    <script>
        // 检查Turf.js是否加载成功
        window.addEventListener('load', function () {
            if (typeof turf === 'undefined') {
                console.warn('Turf.js加载失败，已启用备用面积算法');
            } else {
                console.log('Turf.js加载成功');
            }
        });
    </script>
</head>

<body>
<!-- 左侧工具条 -->
<div id="leftToolbar">
    <button class="toolbar-btn" id="measureDistanceBtn" title="测距">
        <span>测距</span>
    </button>
    <div class="toolbar-divider"></div>
    <button class="toolbar-btn" id="measureAreaBtn" title="测面">
        <span>测面</span>
    </button>
    <div class="toolbar-divider"></div>
    <button class="toolbar-btn" id="mapTypeBtn" title="切换地图类型">
        <span>地图</span>
    </button>
</div>

<div id="mapContainer">
    <div id="mapLoading">
        <div class="loading-text">地图正在加载中...</div>
    </div>
</div>

<div class="wkt-input-container">
    <div class="minimize-btn" id="minimizeBtn">
        <span class="min-icon">−</span>
        <span class="restore-icon" style="display:none;">+</span>
    </div>

    <div class="content-wrapper">
        <div class="tabs-header">
            <button class="tab-btn active" id="tabDrawBtn">轮廓</button>
            <button class="tab-btn" id="tabTrackBtn">轨迹</button>
            <button class="tab-btn" id="tabSplitBtn">分割器</button>
            <button class="tab-btn" id="tabBatchBtn">合并器</button>
        </div>
        <div class="tab-pane active" id="tabDraw">
            <div class="tip">请输入WKT字符串（支持POLYGON/MULTIPOLYGON）：</div>
            <textarea id="wktTextarea">POLYGON ((124.4989642289771 45.345918476378046, 124.49896429694688 45.345918506989804, 124.49896435431084 45.34591854696561, 124.49896439852188 45.345918594530374, 124.49896442761677 45.34591864757204, 124.49896444030367 45.34591870373533, 124.49896443601912 45.3459187605264, 124.49896408509818 45.34592030661851, 124.49896408283429 45.34592033295902, 124.49896419906808 45.345922509366765, 124.49896420413526 45.34592253551359, 124.49896492025886 45.3459246541107, 124.49896493246273 45.345924679058804, 124.4989662209559 45.34592665843028, 124.498966239827 45.34592668121949, 124.49896805117409 45.34592844529905, 124.49896807598691 45.345928465053944, 124.49897034057935 45.345929946049324, 124.49897037038039 45.345929962010814, 124.49897300119032 45.34593110300739, 124.4989730348355 45.34593111456275, 124.4989759307622 45.34593187171264, 124.49897596695787 45.345931878417396, 124.4989790167125 45.34593222262398, 124.49897905406777 45.34593222422044, 124.49898214045041 45.34593214225608, 124.4989821775293 45.34593213868291, 124.49898518193196 45.345931633697376, 124.49898521720415 45.345931625117586, 124.49898805749824 45.345930704315705, 124.49910706205522 45.345881699456136, 124.49911051312162 45.345879781064816, 124.49929050675975 45.34574778374039, 124.49929246053811 45.34574602743578, 124.49929248099683 45.345746004656135, 124.49929391295177 45.34574398353804, 124.49935345027689 45.34563355135782, 124.49935348147118 45.345633506507056, 124.49935352385307 45.34563346647867, 124.49935357597067 45.345633432644014, 124.49935363603844 45.3456334061623, 124.49935370199832 45.34563338794075, 124.4993537715907 45.345633378603644, 124.49935384243122 45.34563337847089, 124.4994295846745 45.34563819965678, 124.49943265491099 45.34563818331478, 124.49943269190899 45.34563818056151, 124.49943569934705 45.345637744623374, 124.49943573488511 45.34563773686229, 124.49943856531617 45.34563689788354, 124.49943859804459 45.3456368854095, 124.49944114397752 45.34563567525187, 124.49944117265332 45.34563565853867, 124.49944333740032 45.34563412316079, 124.49944336093576 45.345634102842254, 124.4994450622868 45.34563230055305, 124.4994450797865 45.34563227740195, 124.49944625312986 45.34563027664638, 124.49944626392967 45.34563025154189, 124.49944686470486 45.345628128302906, 124.49944686839493 45.345628102197544, 124.49944687378665 45.34562593710942, 124.49944687022679 45.345625910995956, 124.49944628003001 45.345623786281685, 124.49944626935526 45.34562376115048, 124.49944510598436 45.34562175750131, 124.49944508860008 45.34562173430711, 124.49944339623627 45.34561992781503, 124.49944337280283 45.345619907438845, 124.49944121571662 45.345618366708706, 124.49944118712409 45.34561834992449, 124.49943864723588 45.34561713346891, 124.49943861456897 45.34561712091357, 124.49943578833583 45.345616274929725, 124.49943575294246 45.34561626710408, 124.4994327108248 45.34561581957625, 124.49942559258935 45.345615272026095, 124.4994255180022 45.34561526090263, 124.49942544802134 45.34561523957507, 124.49942538542344 45.345615208889626, 124.49942533269218 45.34561517006387, 124.49942529191989 45.34561512463829, 124.4994252647243 45.34561507441534, 124.49942525218455 45.34561502138772, 124.49942525479813 45.345614967659486, 124.49942527246141 45.345614915362454, 124.49942530447346 45.34561486657168, 124.49942534956416 45.34561482322308, 124.49942540594441 45.34561478703664, 124.49942547137704 45.34561475944818, 124.49942554326594 45.345614741552325, 124.49942561875866 45.34561473405916, 124.49947865747691 45.34561323438539, 124.4994818029387 45.34561291946794, 124.49948184030661 45.345612912962764, 124.49948483221704 45.34561215945626, 124.49948486697438 45.345612147796864, 124.49948758368315 45.34561098633978, 124.49948761441665 45.34561097000034, 124.49948994545642 45.34560944781992, 124.49948997091639 45.34560942746478, 124.49949182150243 45.34560760645607, 124.49949184065382 45.3456075829129, 124.49949313553712 45.3456055371221, 124.49949314760113 45.34560551134812, 124.49949383412928 45.34560332396109, 124.4994938386152 45.34560329700459, 124.49949388887266 45.34560105696559, 124.49949388559827 45.345601029922186, 124.49949329754138 45.34559882831533, 124.4994932866397 45.345598802285124, 124.49949208418042 45.34559672863256, 124.4994920660948 45.345596704673945, 124.4994902981275 45.34559484329473, 124.49949027359273 45.34559482238132, 124.4994880120071 45.34559324896312, 124.49948798202196 45.34559323194616, 124.4994853187779 45.34559201046694, 124.4994852845611 45.345591998038046, 124.49948232795218 45.345591178165925, 124.49948229100563 45.34559117085233, 124.49947912290831 45.34559078258842, 124.49940058211958 45.34558680583958, 124.4994005615595 45.3455868044043, 124.49936639473263 45.34558376056453, 124.4993663204504 45.34558374855383, 124.49936625101542 45.345583726402694, 124.49936618918098 45.345583694989415, 124.49936613739867 45.34558365555951, 124.49936609772172 45.34558360967641, 124.4993660717232 45.345583559159365, 124.49936606043413 45.345583506011366, 124.49936606430217 45.34558345233976, 124.49936686982723 45.34557970664354, 124.49936688693829 45.345579658051385, 124.4993669164832 45.34557961252419, 124.49936695744535 45.34557957162879, 124.49936700841486 45.345579536772576, 124.49936706763764 45.345579509155186, 124.49936713307542 45.345579489727044, 124.49936720247636 45.34557947915681, 124.49936968552414 45.34557926833086, 124.49936974294295 45.34557926652096, 124.49943704996085 45.3455807139904, 124.49943708148557 45.34558071558903, 124.49948896302617 45.34558487079034, 124.49948898799963 45.34558487338123, 124.4995061703271 45.34558706639437, 124.49950802977112 45.34558722448459, 124.49953103709832 45.345588223544986, 124.49953407332487 45.34558814860628, 124.49953410982145 45.34558814520096, 124.499537069188 45.34558766072211, 124.4995371040793 45.34558765244049, 124.49953987656136 45.345586776435724, 124.49953990855015 45.34558676358565, 124.49954239105726 45.34558552862785, 124.49954241895334 45.345585511687446, 124.49954451917792 45.345583963696406, 124.49954454194439 45.34558394329552, 124.49954618179243 45.34558213983085, 124.49954619858315 45.34558211672752, 124.49954731707918 45.34558012484909, 124.49954732726964 45.3455800999027, 124.49954788282469 45.34557799367413, 124.4995478860358 45.34557796781249, 124.49954785799244 45.345575825551364, 124.4995478541049 45.34557579973599, 124.49954724350586 45.3455737010988, 124.49954723266418 45.3455736762894, 124.49954606221348 45.34557169931017, 124.49954604482083 45.3455716764295, 124.49954435804032 45.34556989461946, 124.4995443347434 45.345569874518254, 124.49954219435305 45.34556835413119, 124.49954216601834 45.34556833755686, 124.4995396516053 45.34556713512586, 124.49953961928583 45.345567122694455, 124.49953682434456 45.34556628293008, 124.4995367893474 45.34556627512748, 124.49953378134379 45.3455658250545, 124.49949363357968 45.34556260963012, 124.49949360860565 45.345562607039156, 124.49946482671848 45.3455589335096, 124.49946247196223 45.34555875960473, 124.49943937121174 45.34555826282142, 124.49943933968703 45.345558261222784, 124.49939921909538 45.34555504794056, 124.49939914340489 45.34555503631465, 124.49939907258465 45.34555501417919, 124.49939900953596 45.345554982440966, 124.49939895684163 45.34555494240023, 124.49939891666054 45.34555489569729, 124.49939889063869 45.34555484424546, 124.49939887984209 45.345554790152555, 124.49939888471314 45.345554735634586, 124.49939890505223 45.345554682925005, 124.49939894002607 45.345554634183166, 124.49939898820206 45.34555459140586, 124.49939904760642 45.34555455634555, 124.49939911580557 45.345554530438584, 124.49939919000563 45.345554514746226, 124.49939926716681 45.3455545099114, 124.49948081561038 45.34555524318885, 124.49948398865803 45.34555504466392, 124.49948402655768 45.345555039530694, 124.49948707811326 45.34555439497782, 124.4994871137736 45.34555438457367, 124.49948991909369 45.34555332034184, 124.49948995105684 45.34555330509227, 124.49949239545815 45.345551864687856, 124.49949242241857 45.345551845215674, 124.49949440597366 45.34555008752275, 124.49949442682782 45.34555006462501, 124.49949586844868 45.34554806149811, 124.49949588234486 45.34554803611035, 124.49949672309707 45.34554586943866, 124.49949672946732 45.34554584259824, 124.49949693498101 45.34554360095557, 124.49949693356466 45.345543573760025, 124.49949649543842 45.345541348786156, 124.49949648629335 45.34554132234701, 124.49949542243822 45.34553920499841, 124.49949540593809 45.34553918039692, 124.49949375984502 45.34553725723225, 124.499493736664 45.34553723547354, 124.49949157562563 45.34553558511163, 124.49949154671248 45.345535567086394, 124.49948895907207 45.345534256994256, 124.49948892560818 45.34553424343869, 124.49948601714955 45.34553332717358, 124.49948598061225 45.34553331866732, 124.49948283203676 45.345532829129795, 124.49937509216069 45.345523949593876, 124.49937501514844 45.34552393747171, 124.4993749432983 45.34552391447032, 124.49937487966434 45.34552388156743, 124.49937482695138 45.34552384016166, 124.49937478740021 45.345523792013, 124.49937476269193 45.34552373916811, 124.499373644573 45.345520132341704, 124.49937363575722 45.345520076997325, 124.4993736432382 45.34552002155532, 124.49937366669738 45.34551996837651, 124.49937370513582 45.34551991972536, 124.49937375691663 45.34551987767354, 124.49937381983491 45.345519844011704, 124.49937389121156 45.345519820173244, 124.49937396800716 45.34551980717325, 124.49937404695162 45.34551980556527, 124.49951483183082 45.34552721381837, 124.49951790659301 45.34552716336394, 124.49951794358749 45.345527160191146, 124.49952094586055 45.34552668945542, 124.49952098127596 45.34552668127484, 124.49952379665301 45.34552580819637, 124.4995238291393 45.34552579531996, 124.4995263503325 45.34552455316976, 124.49952637865282 45.345524536087645, 124.49952850958486 45.34552297220153, 124.49952853265933 45.345522951565066, 124.49953019212575 45.345521125539, 124.49953020907508 45.345521102134484, 124.49953133383765 45.34551908355392, 124.49953134401613 45.34551905827276, 124.49953189121244 45.34551692406201, 124.49953189423186 45.345516897867974, 124.49953184301013 45.34551472935553, 124.49953183875544 45.345514703247645, 124.49953119106759 45.345512583071155, 124.49953117970077 45.34551255804311, 124.49952996022832 45.34551056699704, 124.4995299421834 45.34551054400408, 124.4995281973982 45.34550875796324, 124.49952817336138 45.34550873787968, 124.49952596975284 45.345507224905745, 124.49952594064159 45.34550720849833, 124.49952336218392 45.34550602624696, 124.49952332910708 45.345506014140426, 124.49952047405925 45.34550520766466, 124.49952043838422 45.34550520034232, 124.49951737849689 45.345504796768566, 124.49938873909443 45.34549681913105, 124.49936757998331 45.345494872227654, 124.49936750848485 45.34549486064819, 124.49936744143281 45.34549483966186, 124.4993673812906 45.34549481003969, 124.49936733026796 45.34549477287, 124.49936729023952 45.345494729518414, 124.4993672626758 45.34549468157765, 124.49936724858956 45.34549463080907, 124.4993672484982 45.3454945790779, 124.49936726240534 45.34549452828475, 124.49936728979979 45.34549448029577, 124.49936732967512 45.34549443687406, 124.49936738056645 45.34549439961495, 124.49936744060385 45.345494369887334, 124.49936750758162 45.345494348783404, 124.49936757903902 45.34549433707851, 124.49936765235073 45.345494335202694, 124.49953106660757 45.345501224782204, 124.49953410451155 45.345501145698435, 124.49953414102103 45.34550114224021, 124.49953710083423 45.34550065321003, 124.4995371357221 45.34550064487177, 124.49953990725214 45.34549976410184, 124.49953993921996 45.34549975119387, 124.49954241928279 45.34549851147527, 124.4995424471398 45.34549849447842, 124.49954454340259 45.345496941965735, 124.49954456611187 45.3454969215128, 124.49954620053013 45.34549511400677, 124.49954621724667 45.345495090858584, 124.49954732897133 45.34549309565241, 124.49954733907217 45.34549307067152, 124.49954788671361 45.345490962046654, 124.4995478898229 45.345490936163415, 124.49954785299235 45.34548879262403, 124.49954784899458 45.345488766801545, 124.49954722906332 45.3454866681524, 124.49954721810705 45.34548664335143, 124.49954603815553 45.34548466772595, 124.49954602064807 45.34548464486952, 124.49954432460602 45.3454828658195, 124.49954430120033 45.345482845760216, 124.499542152211 45.34548132951942, 124.49954212377787 45.34548131300332, 124.49953960184874 45.345480116021896, 124.49953956944664 45.34548010366384, 124.4995367684691 45.34547927050536, 124.4995367334096 45.34547926278865, 124.49953372115998 45.34547882036555, 124.49935686221836 45.34546513497822, 124.49935678465947 45.34546512314056, 124.4993567122296 45.34546510027854, 124.49935664804246 45.345465067374995, 124.49935659485743 45.34546502584446, 124.49935655496111 45.345464977472346, 124.49935653006852 45.34546492433813, 124.4993551211229 45.34546037935347, 124.49935511244865 45.34546032940471, 124.49935511707483 45.34546027918868, 124.49935513484037 45.34546023045114, 124.4993551651277 45.345460184886456, 124.49935520688396 45.34546014407876, 124.49935525865739 45.34546010944669, 124.49935531864806 45.34546008219428, 124.49935538477047 45.34546006326897, 124.49935545472567 45.34546005332871, 124.49935552608176 45.345460052719076, 124.49946272419017 45.345466207990846, 124.49946579151786 45.34546617284475, 124.49946582845 45.34546616986924, 124.49946882797003 45.34546571622855, 124.49946886338404 45.345465708262594, 124.49947168137852 45.34546485332609, 124.4994717139318 45.34546484067181, 124.49947424356122 45.34546361685295, 124.49947427202022 45.345463599989856, 124.49947641737829 45.34546205368757, 124.49947644066367 45.34546203325505, 124.49947812041312 45.345460223094605, 124.49947813764197 45.345460199867475, 124.49947928809831 45.34545819447767, 124.49947929861762 45.34545816933622, 124.49947987616358 45.34545604474757, 124.4994798795743 45.345456018645756, 124.49947986231317 45.34545385540834, 124.49947985848618 45.345453829335035, 124.49947924707254 45.34545170946402, 124.49947923615262 45.345451684407664, 124.49947805376733 45.34544968827442, 124.49947803616847 45.345449665184944, 124.49947632763991 45.345447868469165, 124.49947630402899 45.34544784822195, 124.49947413413243 45.34544631904222, 124.49947410540581 45.34544630240579, 124.49947155640821 45.34544509873791, 124.49947152365452 45.34544508634254, 124.49946869219727 45.34544425382173, 124.49946865676411 45.3454442461602, 124.49946561332128 45.345443812371, 124.4993950706233 45.3454386953226, 124.49939499854912 45.34543868508854, 124.49939493057978 45.34543866532516, 124.49939486922334 45.34543863676178, 124.49939481674411 45.345438600452404, 124.4993947750786 45.34543855773691, 124.4993947457642 45.34543851019157, 124.49939472988278 45.34543845957087, 124.49939472802039 45.34543840774278, 124.49939474024568 45.345438356619844, 124.49939476610764 45.34543830808857, 124.49939480465174 45.345438263939805, 124.49939485445574 45.345438225802745, 124.49939491368187 45.345438195084675, 124.49939498014457 45.345438172919124, 124.49939505139116 45.345438160124075, 124.49939512479273 45.34543815717164, 124.49950639292206 45.34544123591944, 124.49950941822313 45.3454411140108, 124.499509454512 45.345441110054324, 124.49951239075773 45.345440581988406, 124.49951242530149 45.34544057320608, 124.49951516387752 45.345439658517, 124.4995151953978 45.34543964523384, 124.49951763499898 45.345438377757695, 124.49951766233025 45.345438360464975, 124.49951971271032 45.345436787088396, 124.49951973484153 45.34543676642569, 124.49952132015305 45.34543494535123, 124.49952133626554 45.34543492208259, 124.49952239786504 45.3454329206751, 124.49952240736212 45.34543289566275, 124.49952290597885 45.34543078795753, 124.4995229085098 45.345430762125886, 124.49952282569869 45.345428626092385, 124.4995228211699 45.34542860039605, 124.49952215999467 45.345426515050825, 124.49952214857333 45.34542649044065, 124.49952093349205 45.34542453292391, 124.49952091560115 45.34542451031134, 124.49951919156189 45.34542275303497, 124.49951916786321 45.34542273325614, 124.49951699864195 45.3454212412261, 124.49951697001187 45.34542122501229, 124.49951443585245 45.34542005342155, 124.49951440335026 45.34542004137271, 124.49951159799609 45.345419233560726, 124.49951156292879 45.34541922614467, 124.49950855370824 45.3454188081763, 124.49950711226884 45.345418707489266, 124.49950703500015 45.345418696333034, 124.49950696261514 45.34541867424474, 124.49950689818785 45.34541864216245, 124.49950684445446 45.34541860144862, 124.49950680369682 45.34541855383231, 124.49950677764592 45.34541850133571, 124.49950676740816 45.34541844618823, 124.49950677341813 45.345418390731936, 124.49950688928392 45.3454179404401, 124.49950689233157 45.34541791447447, 124.49950684860745 45.34541576452863, 124.49950684450516 45.345415738634976, 124.4995062143189 45.345413634892246, 124.49950620321984 45.345413610039884, 124.4995050101752 45.34541163129611, 124.49950499249543 45.345411608416846, 124.49950328127771 45.345409828785286, 124.49950325768022 45.3454098087368, 124.49950109238337 45.345408294874105, 124.49950106375125 45.34540827840634, 124.49949852547708 45.345407087014834, 124.49949849288245 45.34540707474461, 124.49949567670295 45.34540625044819, 124.49949564147249 45.345406242857884, 124.49949261621623 45.345405812579, 124.49920362114996 45.3453848136173, 124.49920136458313 45.34538476360889, 124.49909235980454 45.345387764990996, 124.49908935793427 45.34538805316651, 124.49908932220264 45.34538805910867, 124.49908645405073 45.345388747116054, 124.49908642069236 45.34538875773923, 124.49908376126699 45.345389834109746, 124.49905975984737 45.34540183699577, 124.4990570725703 45.34540353846227, 124.49905704368703 45.34540356148485, 124.49905495341321 45.345405676137354, 124.49904215562425 45.3454224117022, 124.49904211978122 45.345422450273226, 124.4990415449638 45.345422966530386, 124.4990415245258 45.345422989255006, 124.49904009302281 45.34542500551047, 124.49902491724492 45.34545306640536, 124.49902488345536 45.34545311410376, 124.49902483702742 45.345453156187034, 124.49902477977324 45.34545319101271, 124.4990247139274 45.34545321722153, 124.49902464205984 45.345453233790614, 124.49902456697552 45.34545324007326, 124.4990244916049 45.345453235824245, 124.49902441888979 45.345453221209425, 124.49902435166798 45.34545319679923, 124.49902429256336 45.34545316354632, 124.49902424388254 45.34545312274858, 124.49902420752565 45.345453075998336, 124.49902418491173 45.3454530251202, 124.49902417692321 45.345452972099906, 124.49902418387198 45.34545291900686, 124.49903865869305 45.34540012164006, 124.4990389450342 45.345397963067384, 124.49903894486835 45.34539793679878, 124.49903863127905 45.34539578011368, 124.4990386238815 45.345395754366685, 124.49903772230347 45.34539368168996, 124.49903770795622 45.345393657446714, 124.49903625272016 45.34539174770207, 124.49903623196973 45.34539172588559, 124.49903427848992 45.34539005179484, 124.49903425212551 45.34539003323503, 124.49903187478785 45.345388658545254, 124.49903184381427 45.345388643949505, 124.49902913314496 45.34538762100713, 124.49902909874152 45.34538761093109, 124.4990261579593 45.345386978688545, 124.4990261214355 45.34538697351584, 124.49902306252247 45.3453867560482, 124.49902302526976 45.34538675597589, 124.49901996470496 45.34538696156398, 124.49901992814148 45.34538696659478, 124.49901698246747 45.345387587410144, 124.49901694798594 45.34538759735242, 124.49901422937084 45.345388609755105, 124.4990141982837 45.34538862423044, 124.49901181024912 45.34538998966924, 124.49901178374027 45.34539000812636, 124.49900981721916 45.34539167460735, 124.4990097962982 45.34539169634345, 124.4990083261741 45.34539360040834, 124.49900831168053 45.34539362452429, 124.49900738450893 45.345395719180324, 124.49898943241378 45.34545648008934, 124.49898940317469 45.34545654123328, 124.49898935418912 45.34545659573536, 124.49898007887819 45.34546460623034, 124.49898002776581 45.34546464267655, 124.4989799678036 45.345464671650916, 124.49897990115424 45.345464692108294, 124.49897983022218 45.34546470331074, 124.49897975756578 45.34546470485419, 124.498979685806 45.34546469668297, 124.49897961753129 45.345464679091805, 124.49897955520439 45.345464652715236, 124.49897950107356 45.34546461850473, 124.49895170942041 45.34544336793956, 124.49894942569809 45.34544193083716, 124.49894939575758 45.345441915401175, 124.49894676109038 45.34544081680357, 124.49894672748275 45.34544080574134, 124.498943841303 45.34544008710847, 124.49894380529618 45.345440080837335, 124.49894077653576 45.34543976929216, 124.49894073948873 45.34543976804883, 124.49893768246005 45.34543987534976, 124.4989376457714 45.34543987918119, 124.49893467585413 45.34544040127847, 124.49893464090817 45.3454404100401, 124.49893187019406 45.34544132722846, 124.49893183831006 45.345441340589545, 124.4989293713728 45.34544261825201, 124.49892934375372 45.34544263570846, 124.4989272737008 45.345444225623176, 124.49892725138949 45.34544424651603, 124.49892565635047 45.34544608867546, 124.4989256401889 45.34544611221613, 124.49892458036379 45.34544813709325, 124.49892457096215 45.345448162392884, 124.49892408635151 45.34545029356438, 124.49892408406447 45.345450319667705, 124.49892419295892 45.34545247669732, 124.49892419787257 45.34545250262048, 124.49892489616232 45.345454604096176, 124.49892490805603 45.345454628786825, 124.49892618633547 45.345456618761126, 124.49896991720077 45.34551022437892, 124.4989699489117 45.34551027440664, 124.49896996563878 45.34551032791999, 124.49896996669263 45.345510382712874, 124.49896995202973 45.345510436526425, 124.49896685115024 45.34551772358645, 124.49896682329437 45.345517771662294, 124.49896678289608 45.345517815085685, 124.4989667314512 45.3455178522487, 124.49896667086465 45.34551788177529, 124.49896660337998 45.3455179025721, 124.49896653149595 45.345517913869045, 124.49896645787449 45.34551791524785, 124.49896638524143 45.34551790665741, 124.49896631628656 45.34551788841584, 124.49896625356295 45.34551786119861, 124.49896619939322 45.34551782601353, 124.4989648314548 45.34551674829013, 124.49896480482803 45.345516730949754, 124.49896242498721 45.345515453590416, 124.49896239419364 45.34551544011084, 124.49895971492238 45.34551450289885, 124.4989596810715 45.345514493765705, 124.49895679891846 45.34551393047403, 124.49895676322986 45.34551392601632, 124.49895378205473 45.345513756943376, 124.49895374581443 45.34551375732177, 124.49895077304477 45.345513988560114, 124.49895073755846 45.34551399376106, 124.49894788031904 45.3455146169779, 124.49894784686612 45.34551462681389, 124.49894520811846 45.34551561955134, 124.49894517790362 45.345515633668214, 124.49894285273572 45.34551696015279, 124.49894282692654 45.345516977987636, 124.49894087701611 45.34551861078024, 124.49892734378025 45.3455323993688, 124.49892729770146 45.34553243801737, 124.49892724222025 45.34553246993709, 124.49892717927844 45.34553249401069, 124.49892711107934 45.34553250939552, 124.49892704000995 45.345532515553124, 124.4989269685577 45.34553251226794, 124.49892689922387 45.34553249965495, 124.49892683443498 45.34553247815567, 124.49892677645902 45.345532448522604, 124.49892672732514 45.34553241179296, 124.49892652988903 45.34553223334631, 124.49892650322485 45.34553221371024, 124.49892408142206 45.34553075792872, 124.49892404970593 45.34553074247153, 124.49892126245042 45.34552965956947, 124.49892122697639 45.34552964892201, 124.49891818798316 45.34552898307999, 124.49891815019863 45.34552897767654, 124.49891498345218 45.34552875605945, 124.49891494489886 45.345528756120544, 124.49891177959677 45.34552898776999, 124.49891174184681 45.34552899329314, 124.49890870712747 45.3455296687582, 124.4989086717215 45.34552967951803, 124.49890589139501 45.345530771241116, 124.49890585977742 45.345530786798754, 124.49890344727585 45.34553225023967, 124.49890342073712 45.34553226995998, 124.49890147448583 45.34553404541329, 124.4989014541685 45.34553406842371, 124.49890003829852 45.345536108524634, 124.49887904009478 45.345576109116365, 124.49887823858316 45.345578298644604, 124.49887823275178 45.345578325728425, 124.49887807653697 45.3455805843407, 124.49887807860314 45.34558061169673, 124.49887857415476 45.34558284582992, 124.49887858403301 45.34558287232391, 124.49887971082194 45.3455849894236, 124.49887972810343 45.34558501395915, 124.49888143944982 45.345586926320095, 124.4988814634185 45.34558694787992, 124.49888368842616 45.345588576278594, 124.49888371808866 45.34558859396938, 124.49888636458223 45.34558987094598, 124.49888639870966 45.34558988403493, 124.49888935705226 45.34559075668769, 124.49888939423114 45.34559076463272, 124.49888980012939 45.34559082036344, 124.49888986929612 45.345590834740335, 124.49888993341119 45.34559085801063, 124.49888999019842 45.34559088934833, 124.49889003764218 45.34559092764099, 124.49889007405822 45.34559097152934, 124.49889009815405 45.345591019455405, 124.498890109074 45.34559106971796, 124.49889024521525 45.345592732300716, 124.49889025102422 45.3455927583707, 124.49889102719337 45.34559486642591, 124.49889104010326 45.34559489119595, 124.49889238456828 45.3455968519667, 124.49889240408261 45.34559687448434, 124.49889426517652 45.345598612619106, 124.49889429054605 45.345598632019865, 124.49889659674811 45.3456000807233, 124.49889662699702 45.34560009626083, 124.49889928968155 45.34560119986011, 124.49889932364759 45.345601210937666, 124.49890224048845 45.34560192702179, 124.49890227675851 45.34560193319535, 124.49890537306861 45.345602236630455, 124.49896201374217 45.34560385494729, 124.49896208017473 45.34560386098192, 124.49902760200368 45.345613986096595, 124.49903022021644 45.3456142309185, 124.49903025210702 45.34561423199692, 124.49903292353387 45.34561416321613, 124.49906611136988 45.345611343352424, 124.4990662121855 45.345611344218845, 124.4991617019126 45.34562112793726, 124.49916257110547 45.34562120008272, 124.49932006196508 45.3456312276671, 124.49932013880102 45.34563123822762, 124.49932021098272 45.34563125959137, 124.49932027549039 45.34563129086461, 124.4993203296254 45.345631330739, 124.49932037112286 45.34563137754642, 124.49932039824701 45.34563142932865, 124.49932040986276 45.345631483919384, 124.49932040548445 45.345631539034805, 124.49932038529506 45.34563159236916, 124.49926527778773 45.345733807840894, 124.49926524337866 45.345733856334725, 124.49926519591702 45.34573389899929, 124.49908907974294 45.34586305083893, 124.49908899685909 45.34586309683494, 124.49898603170247 45.34590549425875, 124.49898596312968 45.34590551642425, 124.49898588972361 45.34590552867512, 124.49898581433588 45.34590553053542, 124.49898573989503 45.3459055219329, 124.49898566929272 45.345905503201756, 124.49898560527166 45.34590547506959, 124.4989855503187 45.345905438629245, 124.49898550656862 45.3459053952963, 124.498985475721 45.34590534675407, 124.49898456214723 45.3459034194266, 124.4989845468617 45.34590339533875, 124.49898301508205 45.34590150411485, 124.49898299349093 45.34590148265714, 124.49898094199347 45.345899819414505, 124.49897794127449 45.345897820587844, 124.49897558992167 45.34589652692878, 124.49897555945093 45.34589651322384, 124.49897290459484 45.345895555212586, 124.49897287110753 45.34589554583007, 124.49896997255964 45.3458949517648, 124.49891797627588 45.34588795301048, 124.49891567116437 45.34588776537531, 124.49891564312675 45.3458877645599, 124.49891329580109 45.34588781907508, 124.49861189869769 45.34591047311111, 124.49861182852864 45.34591047382269, 124.49861175935496 45.34591046548784, 124.49861169350213 45.345910448386824, 124.49850554328549 45.34587478192228, 124.49850548059396 45.345874755404125, 124.4985054261964 45.345874720964154, 124.4985053820773 45.345874679858916, 124.49850534984651 45.34587463358813, 124.49850533068003 45.345874583839986, 124.49850532527702 45.34587453242957, 124.49850533383464 45.34587448123256, 124.49850535604064 45.34587443211693, 124.49850539108489 45.34587438687462, 124.4985054376887 45.34587434715633, 124.49850549415187 45.34587431441117, 124.49850555841428 45.345874289833844, 124.49850562813124 45.34587427432107, 124.49850570075922 45.34587426843883, 124.49850577364838 45.34587427240174, 124.49856927735937 45.345882079191696, 124.49857199208871 45.34588224431023, 124.49857202512219 45.345882244297655, 124.49857473959273 45.34588207711349, 124.49857477203221 45.34588207309959, 124.49857743667397 45.3458815716424, 124.4988834374428 45.34580357018697, 124.49888610217576 45.345802684420875, 124.49888613290577 45.345802671603956, 124.4988885172142 45.34580145150776, 124.49888854402396 45.34580143488045, 124.49889056454816 45.34579992311106, 124.49889058649951 45.345799903255084, 124.49889217259752 45.34579815266747, 124.4988921889233 45.34579813027671, 124.49889328514183 45.345796202075206, 124.4988932952408 45.345796178004775, 124.49889386852546 45.34579411462731, 124.49889686677732 45.345773113873825, 124.49889687364737 45.34577093592089, 124.49889687006201 45.345770909652096, 124.49889627425324 45.345768772611514, 124.49889626346919 45.34576874734052, 124.49889508787774 45.34576673332782, 124.49889507031041 45.3457667100272, 124.49889336011377 45.345764896440514, 124.49889333643668 45.3457648760036, 124.49889115735758 45.34576333253859, 124.49889112848153 45.34576331575166, 124.49888856425994 45.345762101722144, 124.49888853129471 45.34576208923039, 124.49888568047223 45.345761251291016, 124.4988856446845 45.34576124357431, 124.49888261681683 45.345760813926596, 124.49888257958182 45.34576081128152, 124.49887949102808 45.34576080643656, 124.4988794537768 45.34576080896479, 124.4988764232283 45.345761229108795, 124.49887638739227 45.34576123671312, 124.49887353131112 45.34576206570024, 124.49887349826746 45.345762078088455, 124.49887092641183 45.345763284060936, 124.49887089742987 45.345763300757284, 124.49886870863396 45.34576483737065, 124.49886868482875 45.34576485773274, 124.49886696320644 45.34576666593609, 124.4988669454921 45.34576668918169, 124.49886575720528 45.34576869948638, 124.49886574629487 45.345768724647286, 124.49886513139344 45.34577088598519, 124.49886316345051 45.34578466156035, 124.49886314965227 45.345784711077506, 124.49886312302274 45.34578475791765, 124.49886308449304 45.345784800443184, 124.49886303541011 45.345784837167294, 124.49886297749018 45.345784866806035, 124.49886291275813 45.34578488832319, 124.49857065993957 45.34585938412824, 124.498570595978 45.3458593961403, 124.49857053003792 45.34585940020155, 124.49857046409171 45.34585939619049, 124.49847055227971 45.3458471119574, 124.49847048374603 45.34584709881407, 124.49847041983632 45.3458470769676, 124.49847036275119 45.34584704717031, 124.49847031445653 45.34584701044828, 124.49847027661538 45.3458469680661, 124.49847025053087 45.34584692148323, 124.49847023710119 45.3458468723038, 124.49847023678892 45.345846822221354, 124.49847024960472 45.34584677296054, 124.49855835384719 45.34562603368036, 124.4985588952022 45.34562388944589, 124.49855889811876 45.345623863136794, 124.49855883585249 45.34562168562874, 124.49855883143437 45.34562165942382, 124.49855816794 45.34561953232214, 124.49855815635675 45.34561950722812, 124.49855691713236 45.3456175122766, 124.49855689882894 45.34561748925797, 124.49855513149711 45.34561570312076, 124.49855510717757 45.34561568306286, 124.49855287965521 45.34561417437981, 124.49855285025419 45.34561415805319, 124.49855024814467 45.345612984802926, 124.49855021479081 45.345612972834424, 124.49854733809144 45.345612180103906, 124.49854730206772 45.345612172954034, 124.49854426132804 45.34561179120747, 124.49854422401863 45.3456117891508, 124.49854113609261 45.34561183305852, 124.4985410989312 45.345611836174086, 124.49853808248648 45.345612304048714, 124.4985380469005 45.345612312216915, 124.49853521785704 45.34561318607827, 124.49853518521526 45.345613198984864, 124.49853265229095 45.34561444525125, 124.49853262384686 45.34561446240062, 124.49853048438186 45.34561603317816, 124.49853046122847 45.34561605391133, 124.49852879744043 45.34561788883618, 124.49852878051837 45.345617912286215, 124.49852764438775 45.34561996594944, 124.49844120931974 45.34583651824, 124.49844118069267 45.34583656932804, 124.49844113798925 45.34583661527047, 124.4984410829786 45.34583665416404, 124.49844101793968 45.345836684397504, 124.49844094556678 45.3458367047184, 124.49844086885808 45.34583671428491, 124.49844079099144 45.345836712700695, 124.49844071519253 45.3458367000314, 124.49844064460154 45.34583667680188, 124.49844058214268 45.34583664397446, 124.49843366884211 45.34583217065894, 124.49843361619739 45.34583212870355, 124.49843357697007 45.34583207998786, 124.49843355285037 45.34583202661084, 124.49843354487751 45.345831970872325, 124.49843355339503 45.345831915173896, 124.49845959411923 45.34574634651499, 124.49845994310202 45.345744182510735, 124.49845994366555 45.34574415612431, 124.49845968725296 45.345741985691966, 124.49845968050548 45.34574195973491, 124.49845882855165 45.345739866282486, 124.49845881475248 45.34573984175207, 124.49845739999758 45.34573790572901, 124.4984573796769 45.345737883568134, 124.49845545648958 45.34573617937508, 124.49845543042825 45.345736160435486, 124.49845307271471 45.345734753562986, 124.498453041915 45.34573473857287, 124.49845034028124 45.34573368308644, 124.4984503059257 45.34573367262142, 124.49844736419425 45.34573300908296, 124.49844732760384 45.34573300354537, 124.49844425882326 45.34573275745413, 124.49844422140411 45.34573275705674, 124.49844114350593 45.34573293786994, 124.49844110669589 45.345732942627954, 124.49843813796217 45.345733543397046, 124.49843810317529 45.34573355312779, 124.49843535769313 45.34573455076541, 124.49843532626676 45.34573456509484, 124.49843290954252 45.345735921262644, 124.49843288268481 45.34573593963984, 124.49843088759218 45.345737602221135, 124.49843086633479 45.34573762393994, 124.49842936954443 45.34573952904228, 124.49842935474837 45.345739553196196, 124.49842840408701 45.34574165319346, 124.4984004058487 45.34583365426566, 124.49840005517204 45.34583594714014, 124.49840005503503 45.345835975075694, 124.49840038320914 45.34583826960409, 124.49840039125388 45.34583829695743, 124.49840138413845 45.34584049427607, 124.49840140001785 45.3458405198684, 124.49840301483168 45.34584252529939, 124.49840303779295 45.34584254796076, 124.49840523280871 45.34584429511735, 124.49847322941275 45.34588829191084, 124.49847506941191 45.34588931565596, 124.49847509290723 45.34588932683472, 124.49847715314684 45.34589015608693, 124.49860215687127 45.34593215608087, 124.49860486774632 45.345932860055555, 124.4986049015738 45.345932866427866, 124.49860774915376 45.345933209536696, 124.49860778395885 45.34593321144083, 124.49861070757211 45.34593318067035, 124.4989142791396 45.34591036320207, 124.49891433547712 45.34591036191104, 124.4989143914726 45.34591036646905, 124.49895945440116 45.34591643263288, 124.49895954005771 45.345916451732776, 124.49895961704082 45.34591648438649, 124.49896150085974 45.345917513595474, 124.49896153254754 45.345917527635656, 124.4989642289771 45.345918476378046), (124.49925597669768 45.34551413240087, 124.4992559043427 45.34551412135415, 124.49925583635738 45.345514100691034, 124.49925577528528 45.34551407118462, 124.49925572341145 45.34551403393892, 124.49925568267685 45.34551399034748, 124.49925565460562 45.34551394204134, 124.499255640248 45.345513890827874, 124.4992556401412 45.34551383862327, 124.49925565428914 45.34551378738082, 124.49925568216258 45.34551373901774, 124.49925572271859 45.34551369534359, 124.49925577443972 45.34551365799249, 124.49925583539081 45.3455136283619, 124.49925590329137 45.3455136075605, 124.49925597560079 45.34551359636658, 124.49925604961363 45.34551359519897, 124.49934006183429 45.34551801689328, 124.49934013081861 45.345518025043646, 124.49934019654732 45.34551804191099, 124.49934025682526 45.34551806693196, 124.49934030963914 45.34551809927085, 124.4993403532249 45.345518137847534, 124.49934038612683 45.34551818137358, 124.49934040724591 45.34551822839523, 124.49934120332725 45.34552079639825, 124.49934121203732 45.345520847293955, 124.49934120694266 45.3455208984329, 124.499341188227 45.34552094796995, 124.49934115656563 45.34552099411777, 124.49934111310094 45.34552103521129, 124.49934105940119 45.345521069767855, 124.49934099740386 45.345521096540615, 124.49934092934592 45.345521114563596, 124.49934085768287 45.34552112318651, 124.49934078500043 45.34552112209825, 124.49925597669768 45.34551413240087), (124.49908765001938 45.34545524905676, 124.49908757547233 45.34545524563298, 124.49908750328862 45.34545523206252, 124.4990874362184 45.34545520886241, 124.49908737681697 45.34545517691659, 124.49908732734747 45.345455137442144, 124.49908728969478 45.345455091943045, 124.49908726529345 45.34545504215282, 124.49908725507298 45.34545498996844, 124.49908725942298 45.34545493737811, 124.49908727817761 45.345454886385504, 124.49908731062243 45.345454838933414, 124.49908834256368 45.345453644052924, 124.49908838453733 45.34545360422275, 124.49908843614288 45.34545357048503, 124.49908849563573 45.345453543980355, 124.4990885610046 45.34545352560482, 124.4991159939332 45.345447810412395, 124.49911605512477 45.34544780141736, 124.49911611757655 45.34544779956608, 124.4991670434704 45.345449227615234, 124.49932148950575 45.34545809792301, 124.49932156921739 45.34545810858528, 124.49932164395074 45.345458130856684, 124.49932171034753 45.34545816373638, 124.49932176542373 45.34545820574683, 124.49932180670467 45.345458255000125, 124.49932183233486 45.34545830928293, 124.49932302561609 45.345462158584446, 124.49932303431935 45.345462209289714, 124.49932302931997 45.34546226024324, 124.49932301079706 45.34546230962015, 124.49932297941405 45.34546235565205, 124.49932293629482 45.345462396690344, 124.49932288298366 45.34546243126526, 124.49932282139004 45.34546245813854, 124.49932275371962 45.34546247634772, 124.4993226823961 45.34546248524065, 124.49932260997402 45.34546248449886, 124.49919772600865 45.34545282142396, 124.49919546489228 45.345452761011025, 124.49908765001938 45.34545524905676), (124.49925540202798 45.34556616465969, 124.4992554766978 45.345566176051605, 124.49925554667139 45.345566197674664, 124.4992556091606 45.34556622866731, 124.49925566167549 45.3455662677946, 124.49925570212373 45.34556631349755, 124.49925572889353 45.34556636395504, 124.49925574091826 45.345566417156604, 124.49925573771871 45.34556647098242, 124.49925571942245 45.34556652328776, 124.4992556867586 45.345566571988506, 124.49925564102851 45.34556661514415, 124.49925558405432 45.34556665103517, 124.4992555181063 45.34556667823144, 124.49925544581204 45.34556669564934, 124.49922720284454 45.34557134323201, 124.49922713568304 45.34557134993147, 124.49922706789907 45.34557134816517, 124.49919856491167 45.3455688089586, 124.49901846190016 45.34555624365985, 124.49901838704238 45.34555623303963, 124.49901831666422 45.34555621215172, 124.49901825356685 45.34555618182753, 124.49901820026187 45.34555614327412, 124.49901815887117 45.34555609802603, 124.4990181310421 45.34555604788435, 124.49901811788246 45.3455559948449, 124.49901811991589 45.34555594101888, 124.49901813706167 45.34555588854875, 124.49901816863729 45.34555583952307, 124.49901821338581 45.34555579589322, 124.49901826952609 45.345555759395886, 124.49901833482359 45.34555573148378, 124.49901840667918 45.34555571326794, 124.49901848223263 45.345555705473394, 124.49909442787191 45.34555327519726, 124.49909448841491 45.34555327664398, 124.49925540202798 45.34556616465969), (124.49901591878313 45.34553327372442, 124.49901584650499 45.345533271207906, 124.49901577619052 45.345533259142435, 124.49901571035365 45.34553323795934, 124.49901565134823 45.345533208415965, 124.49901560128362 45.34553317156852, 124.49901556194986 45.345533128734345, 124.49901553475301 45.34553308144481, 124.49901552066557 45.34553303139062, 124.499015520191 45.34553298036128, 124.4990155333465 45.34553293018111, 124.49901555966153 45.34553288264415, 124.49901577955026 45.34553257499442, 124.49901582557163 45.345532525162156, 124.49901588595196 45.3455324836468, 124.49901595775987 45.345532452464035, 124.49902392476726 45.34552979679327, 124.49902401722342 45.34552977560491, 124.49906428019585 45.345524407208565, 124.49906434318113 45.345524402570526, 124.49906440638874 45.345524405319956, 124.49912748246064 45.345530874663254, 124.49912754749211 45.34553088548957, 124.49912760886234 45.34553090412659, 124.49912883230462 45.34553136879864, 124.499128866688 45.345531378935455, 124.49913185199082 45.34553202403874, 124.49914582692162 45.345534020457386, 124.4991469769332 45.345534154458555, 124.49916117177368 45.3455354390728, 124.49916124456638 45.34553545084057, 124.49916131273248 45.345535472352694, 124.49916137367664 45.345535502790106, 124.49916142507834 45.345535540993886, 124.4991614649805 45.345535585509424, 124.49916149186376 45.34553563464179, 124.49916150470465 45.34553568652026, 124.49916150301425 45.34553573916953, 124.49916148685675 45.34553579058501, 124.49916145684755 45.34553583880901, 124.49916141412912 45.34553588200542, 124.49916136032805 45.34553591852953, 124.49916129749283 45.34553594699067, 124.49916122801584 45.34553596630517, 124.4991611545425 45.345535975737654, 124.49916107987028 45.34553597492894, 124.49909678462862 45.345530826168165, 124.49909426200946 45.345530766725325, 124.49901591878313 45.34553327372442), (124.49903344981811 45.34550040591433, 124.49903348214406 45.345500359867025, 124.49903352625938 45.3455003189742, 124.49903358056518 45.34550028471798, 124.49903364309321 45.34550025833997, 124.49903371157711 45.34550024079615, 124.49903378353487 45.34550023272242, 124.49903385635841 45.3455002344114, 124.49903413582179 45.34550025981721, 124.4990342067824 45.34550027118688, 124.49903427340855 45.34550029182207, 124.49903433329192 45.34550032097683, 124.49903438426743 45.345500357597174, 124.49903442449244 45.345500400359256, 124.49903445251277 45.3455004477172, 124.49903446731544 45.345500497958966, 124.49903446836524 45.3455005492683, 124.49903445562427 45.34550059979031, 124.49903442955319 45.34550064769861, 124.49903439109454 45.34550069126125, 124.49903434163842 45.34550072890344, 124.49903428297284 45.34550075926437, 124.49903421721864 45.34550078124645, 124.49903414675276 45.34550079405507, 124.49903407412269 45.345500797227125, 124.4990337846037 45.34550079041481, 124.49903371252569 45.34550078385021, 124.49903364350706 45.34550076779591, 124.49903358003634 45.345500742830815, 124.4990335244024 45.34550070985514, 124.49903347861124 45.34550067005793, 124.49903344431401 45.34550062487424, 124.4990334227474 45.345500575933336, 124.49903341468925 45.34550052499997, 124.49903342042995 45.34550047391073, 124.49903343976253 45.34550042450783, 124.49903344981811 45.34550040591433))</textarea>
            <div class="coord-settings" style="margin-bottom:8px;font-size:12px;color:#333;">
                <label>WKT坐标系：
                    <select id="coordSysSelect" style="margin-left:6px;">
                        <option value="wgs84" selected>WGS84</option>
                        <option value="gcj02">GCJ-02（国测局）</option>
                        <option value="bd09">BD-09（百度）</option>
                        <option value="cgcs2000">CGCS2000</option>
                    </select>
                </label>
                <!-- 已移除“不进行绘制坐标转换”选项，统一使用WGS84绘制 -->
            </div>

            <div class="button-group">
                <button id="drawButton">绘制轮廓</button>
                <button id="clearButton">清空轮廓</button>
            </div>
            <!-- 显示开关：仅保留显示亩数 -->
            <div class="display-toggles" style="margin-top:8px;font-size:12px;color:#333;">
                <label><input type="checkbox" id="toggleLabelsCheckbox"> 显示亩数</label>
            </div>
            <!-- 颜色选择器 -->
            <div class="color-picker-container" style="margin-top:8px;">
                <div style="margin-bottom:6px;font-size:12px;color:#333;">轮廓颜色设置：</div>
                <div style="display:flex;align-items:center;gap:8px;">
                    <div style="display:flex;align-items:center;gap:4px;">
                        <label style="font-size:12px;">边框颜色:</label>
                        <div id="outlineColorPicker" class="color-picker" style="width:24px;height:24px;border:1px solid #ccc;cursor:pointer;background-color:#FFD700;"></div>
                        <input type="color" id="outlineColorInput" value="#FFD700" style="display:none;">
                    </div>
                    <div style="display:flex;align-items:center;gap:4px;">
                        <label style="font-size:12px;">填充颜色:</label>
                        <div id="fillColorPicker" class="color-picker" style="width:24px;height:24px;border:1px solid #ccc;cursor:pointer;background-color:#FFFF00;"></div>
                        <input type="color" id="fillColorInput" value="#FFFF00" style="display:none;">
                    </div>
                    <div style="display:flex;align-items:center;gap:4px;">
                        <label style="font-size:12px;">透明度:</label>
                        <input type="range" id="fillOpacitySlider" min="0" max="100" value="35" style="width:60px;">
                        <span id="fillOpacityValue" style="font-size:12px;">35%</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane" id="tabSplit">
            <!-- MultiPolygon → 多个 Polygon 分割器 -->
            <div class="split-section">
                <div class="title">MultiPolygon → 多个 Polygon 分割器</div>
                <div class="desc">输入一个 MULTIPOLYGON WKT，分割为多行 POLYGON WKT。</div>
                <textarea id="multiInput"></textarea>
                <div class="split-actions">
                    <button id="splitMultiBtn">分割为多个 POLYGON</button>
                    <button id="copyPolysBtn">复制结果</button>
                </div>
                <textarea id="polyOutput" readonly></textarea>
            </div>
        </div>

        <div class="tab-pane" id="tabBatch">
            <!-- 批量POLYGON → MULTIPOLYGON 生成器 -->
            <div class="batch-section">
                <div class="title">批量POLYGON → MULTIPOLYGON 合并器</div>
                <div class="desc">每行一个 POLYGON WKT（或用分号分隔）。生成后可一键填充到上方并绘制。</div>
                <textarea id="batchInput"></textarea>
                <div class="batch-actions">
                    <button id="generateMultiBtn">生成 MULTIPOLYGON</button>
                    <button id="copyMultiBtn">复制结果</button>
                </div>
                <textarea id="multiOutput" readonly></textarea>
            </div>
        </div>
        <div class="tab-pane" id="tabTrack">
            <div class="tip">请粘贴轨迹文本（支持两种格式：1）每行一条：定位时间yyyyMMddHHmmss, 经度, 纬度；2）单行#分隔：经度,纬度,定位时间yyyyMMddHHmmss#经度,纬度,定位时间yyyyMMddHHmmss#…）。</div>
            <div class="coord-settings" style="margin-bottom:8px;font-size:12px;color:#333;">
                <label>轨迹坐标系：
                    <select id="trackCoordSysSelect" style="margin-left:6px;">
                        <option value="wgs84" selected>WGS84</option>
                        <option value="gcj02">GCJ-02（国测局）</option>
                        <option value="bd09">BD-09（百度）</option>
                        <option value="cgcs2000">CGCS2000</option>
                    </select>
                </label>
            </div>
            <textarea id="trackTextarea" style="width:100%;height:120px;margin-bottom:10px;padding:8px;border:1px solid #ddd;border-radius:4px;font-family:monospace;resize:vertical;box-sizing:border-box;">20250930125620,124.504461,45.342159
20250930125630,124.504449,45.342141
20250930125640,124.504459,45.342098
20250930125650,124.504503,45.342061
20250930130711,124.504509,45.342037
20250930130721,124.504532,45.342030
20250930130731,124.504532,45.342030
20250930130741,124.504344,45.342010
20250930130751,124.504155,45.341996
20250930130801,124.504155,45.341996
20250930130811,124.504155,45.341996
20250930130821,124.504155,45.341996
20250930130831,124.504155,45.341996
20250930130841,124.504155,45.341996
20250930130851,124.504155,45.341996
20250930130901,124.504155,45.341996
20250930130911,124.504155,45.341996
20250930130921,124.504155,45.341996
20250930130931,124.504155,45.341996
20250930130941,124.504155,45.341996
20250930130951,124.504075,45.341975
20250930131001,124.503665,45.341870
20250930131011,124.503287,45.341748
20250930131021,124.502906,45.341643
20250930131031,124.502588,45.341997
20250930131041,124.502381,45.342301
20250930131051,124.502120,45.342415
20250930131101,124.501898,45.342589
20250930131111,124.501417,45.342698
20250930131121,124.501102,45.342806
20250930131131,124.500656,45.343304
20250930131141,124.500362,45.343601
20250930131151,124.499969,45.344033
20250930131201,124.499654,45.344349
20250930131211,124.499237,45.344797
20250930131221,124.498825,45.345273
20250930131231,124.498543,45.345623
20250930131241,124.498450,45.345856
20250930131251,124.498572,45.345871
20250930131301,124.498878,45.345793
20250930131311,124.498881,45.345772
20250930131321,124.498881,45.345772
20250930131331,124.498881,45.345772
20250930131341,124.498881,45.345772
20250930131351,124.498881,45.345772
20250930131401,124.498881,45.345772
20250930131411,124.498881,45.345772
20250930131421,124.498881,45.345772
20250930131431,124.498877,45.345744
20250930131441,124.498870,45.345607
20250930131555,124.498870,45.345607
20250930131605,124.498870,45.345607
20250930131615,124.498870,45.345607
20250930131625,124.498906,45.345591
20250930131635,124.499011,45.345594
20250930131645,124.499119,45.345601
20250930131655,124.499223,45.345611
20250930131705,124.499280,45.345615
20250930131715,124.499409,45.345625
20250930131725,124.499431,45.345627
20250930131735,124.499164,45.345610
20250930131745,124.498920,45.345585
20250930131755,124.498959,45.345592
20250930131805,124.498902,45.345575
20250930131815,124.498902,45.345575
20250930131825,124.498894,45.345580
20250930131835,124.498915,45.345540
20250930131845,124.498901,45.345579
20250930131855,124.498954,45.345525
20250930131905,124.498929,45.345579
20250930131915,124.498929,45.345579
20250930131925,124.498982,45.345565
20250930131935,124.499106,45.345573
20250930131945,124.499197,45.345580
20250930131955,124.499292,45.345589
20250930132005,124.499399,45.345598
20250930132015,124.499478,45.345602
20250930132025,124.499301,45.345607
20250930132035,124.499060,45.345574
20250930132045,124.498921,45.345579
20250930132055,124.498957,45.345552
20250930132105,124.498957,45.345552
20250930132115,124.498957,45.345552
20250930132125,124.498970,45.345546
20250930132135,124.499095,45.345542
20250930132146,124.499137,45.345545
20250930132156,124.499137,45.345545
20250930132206,124.499137,45.345545
20250930132216,124.499156,45.345547
20250930132226,124.499168,45.345548
20250930132236,124.499260,45.345556
20250930132246,124.499365,45.345564
20250930132256,124.499476,45.345573
20250930132306,124.499532,45.345577
20250930132316,124.499509,45.345576
20250930132326,124.499509,45.345576
20250930132336,124.499462,45.345570
20250930132346,124.499369,45.345568
20250930132356,124.499263,45.345577
20250930132406,124.499184,45.345590
20250930132416,124.499031,45.345603
20250930132426,124.498921,45.345586
20250930132436,124.498935,45.345563
20250930132446,124.498935,45.345563
20250930143758,124.498991,45.345520
20250930143808,124.499032,45.345512
20250930143818,124.499066,45.345512
20250930143828,124.499064,45.345513
20250930143838,124.499086,45.345513
20250930143848,124.499117,45.345514
20250930143858,124.499212,45.345522
20250930143908,124.499349,45.345533
20250930143918,124.499481,45.345544
20250930143928,124.499370,45.345543
20250930143938,124.499149,45.345523
20250930143948,124.499135,45.345521
20250930143958,124.499142,45.345521
20250930144008,124.499064,45.345513
20250930144018,124.499019,45.345519
20250930144028,124.498977,45.345533
20250930144038,124.498994,45.345493
20250930144048,124.498997,45.345486
20250930144058,124.498997,45.345486
20250930144108,124.499005,45.345460
20250930144118,124.499023,45.345398
20250930144128,124.499006,45.345460
20250930144138,124.498984,45.345479
20250930144148,124.498991,45.345490
20250930144158,124.498940,45.345451
20250930144208,124.499002,45.345527
20250930144218,124.499055,45.345429
20250930144228,124.499039,45.345476
20250930144238,124.499084,45.345486
20250930144248,124.499224,45.345493
20250930144258,124.499387,45.345508
20250930144308,124.499516,45.345516
20250930144318,124.499122,45.345495
20250930144328,124.499079,45.345493
20250930144338,124.499035,45.345489
20250930144349,124.499066,45.345467
20250930144359,124.499196,45.345464
20250930144409,124.499367,45.345478
20250930144419,124.499532,45.345490
20250930144429,124.499200,45.345476
20250930144439,124.499040,45.345488
20250930144449,124.499078,45.345444
20250930144459,124.499126,45.345434
20250930144509,124.499271,45.345441
20250930144519,124.499431,45.345453
20250930144529,124.499464,45.345455
20250930144539,124.499168,45.345438
20250930144549,124.499061,45.345435
20250930144559,124.499111,45.345410
20250930144609,124.499235,45.345411
20250930144619,124.499412,45.345424
20250930144629,124.499507,45.345430
20250930144639,124.499218,45.345422
20250930144649,124.499056,45.345428
20250930144659,124.499069,45.345411
20250930144709,124.499093,45.345399
20250930144719,124.499202,45.345396
20250930144729,124.499402,45.345410
20250930144739,124.499491,45.345417
20250930144749,124.499330,45.345432
20250930144759,124.499361,45.345532
20250930144809,124.499341,45.345625
20250930144819,124.499279,45.345740
20250930144829,124.499099,45.345872
20250930144839,124.498980,45.345921
20250930145119,124.498970,45.345908
20250930145129,124.498967,45.345906
20250930145139,124.498965,45.345906
20250930145149,124.498915,45.345899
20250930145159,124.498609,45.345922
20250930145209,124.498546,45.345900
20250930145219,124.498484,45.345880
20250930145229,124.498416,45.345836
20250930145239,124.498444,45.345744
20250930145249,124.498735,45.345392
20250930145259,124.499128,45.344941
20250930145309,124.499532,45.344476
20250930145319,124.499820,45.344178
20250930145329,124.500166,45.343821
20250930145339,124.500391,45.343557
20250930145349,124.500837,45.343101
20250930145359,124.501129,45.342775
20250930145409,124.501415,45.342702
20250930145419,124.501836,45.342651
20250930145429,124.502118,45.342423
20250930145439,124.502344,45.342354
20250930145449,124.502545,45.342073
20250930145459,124.502815,45.341705
20250930145509,124.503013,45.341655
20250930145519,124.503502,45.341822
20250930145529,124.504184,45.341975
20250930145539,124.504547,45.341988
20250930145549,124.504500,45.342051
20250930145559,124.504448,45.342116
20250930145609,124.504460,45.342167
20250930145619,124.504525,45.342199</textarea>
            <div class="button-group">
                <button id="drawTrackButton" disabled style="flex: 1;">绘制轨迹</button>
                <button id="showTrackPointsButton" disabled style="flex: 1;" class="btn-warning">打点</button>
                <button id="clearTrackButton" disabled style="flex: 1;">清空轨迹</button>
            </div>
            <!-- 轨迹颜色选择器 -->
            <div class="color-picker-container" style="margin-top:8px;">
                <div style="margin-bottom:6px;font-size:12px;color:#333;">轨迹颜色设置：</div>
                <div style="display:flex;align-items:center;gap:8px;">
                    <div style="display:flex;align-items:center;gap:4px;">
                        <label style="font-size:12px;">轨迹线颜色:</label>
                        <div id="trackLineColorPicker" class="color-picker" style="width:24px;height:24px;border:1px solid #ccc;cursor:pointer;background-color:#FF0000;"></div>
                        <input type="color" id="trackLineColorInput" value="#FF0000" style="display:none;">
                    </div>
                    <div style="display:flex;align-items:center;gap:4px;">
                        <label style="font-size:12px;">轨迹点颜色:</label>
                        <div id="trackPointColorPicker" class="color-picker" style="width:24px;height:24px;border:1px solid #ccc;cursor:pointer;background-color:#68EAF3;"></div>
                        <input type="color" id="trackPointColorInput" value="#68EAF3" style="display:none;">
                    </div>
                </div>
            </div>
            <!-- 回放控制 -->
            <div class="split-section" style="margin-top:8px;">
                <div class="title">轨迹回放</div>
                <div class="playback-actions" style="display:flex;gap:8px;margin-bottom:8px;">
                    <button id="playbackStartBtn" disabled>开始</button>
                    <button id="playbackPauseBtn" disabled>继续</button>
                    <button id="playbackStopBtn" disabled>结束</button>
                </div>
                <div class="playback-speed" style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                    <label>速度：
                        <select id="playbackSpeedSelect" disabled>
                            <option value="1" selected>1×</option>
                            <option value="2">2×</option>
                            <option value="4">4×</option>
                            <option value="8">8×</option>
                            <option value="16">16×</option>
                            <option value="32">32×</option>
                            <option value="64">64×</option>
                            <option value="128">128×</option>
                            <option value="256">256×</option>
                            <option value="512">512×</option>
                            <option value="1024">1024×</option>
                        </select>
                    </label>
                    <span id="playbackTimeLabel" style="font-size:12px;color:#666;">时间：—</span>
                </div>
                <div class="playback-time" style="display:flex;flex-direction:column;gap:4px;margin-bottom:8px;">
                    <label class="playback-time-label" style="display:flex;align-items:center;gap:8px;flex:1 1 auto;min-width:0;">
                        <span class="playback-time-text" style="white-space:nowrap;">起始时间：</span>
                        <input type="range" id="playbackTimeSlider" disabled min="0" max="0" step="1000" value="0" style="flex:1 1 auto;min-width:0;max-width:100%;vertical-align:middle;">
                    </label>
                    <span id="playbackTimeCursor" style="font-size:12px;color:#666;align-self:flex-end;">—</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let map;
    let currentPolygons = []; // 存储多边形和其标签
    let currentTracks = []; // 存储轨迹折线及相关覆盖物
    let mapLoaded = false;
    let mapLabelHandlers = []; // 存储地图事件处理器
    let labelsEnabled = false; // 标签显示开关（默认关闭）
    let isDrawing = false; // 绘制进行中防止重复点击
    let currentMapType = 'satellite'; // 当前地图类型：'satellite'（卫星图）或'street'（街道图）

    window.onload = function () {
        if (typeof T === 'undefined') {
            alert("天地图API加载失败，请检查网络或密钥！");
            return;
        }
        initMap();
        bindDrawEvent();
        bindMinimizeEvent();
        bindTabs();
        bindBatchGenerator();
        bindMultiSplitter();
        bindLabelsToggle(); // 绑定标签显示开关
        bindTrackEvents();  // 绑定轨迹绘制与清空
        bindPlaybackControls(); // 绑定轨迹回放
        bindMeasureEvents(); // 绑定测量功能
        bindMapTypeEvent(); // 绑定地图类型切换功能
        initColorPickers(); // 初始化颜色选择器
    };

    function initMap() {
        showLoading();
        disableButtons(true);

        try {
            map = new T.Map("mapContainer", {
                zoom: 12,
                center: new T.LngLat(116.40769, 39.90403)
            });

            // 已移除测试标签
            map.enableScrollWheelZoom();

            // 不再添加地图类型控件到地图，改为使用左侧工具条按钮切换
            // const mapTypeCtrl = new T.Control.MapType({
            //     mapTypes: [TMAP_NORMAL_MAP, TMAP_SATELLITE_MAP, TMAP_TERRAIN_MAP],
            //     position: T_ANCHOR_TOP_LEFT
            // });
            // map.addControl(mapTypeCtrl);

            // 加载影像底图（卫星）
            const tk = "648f621977051d0199ff0f965d3fd322";

            // 方案1：使用默认地图类型（作为备选）
            map.setMapType(TMAP_SATELLITE_MAP);
            currentMapType = 'satellite';
            updateMapTypeButton('卫星图');

            // 方案2：手动添加影像图层（底图 + 标注）
            const vecLayer = new T.TileLayer(`https://t0.tianditu.gov.cn/img_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=img&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`);
            const cvaLayer = new T.TileLayer(`https://t0.tianditu.gov.cn/cia_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cia&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`);

            // 添加图层并监听加载状态
            vecLayer.addEventListener("load", function () {
                console.log("影像底图加载完成");
            });

            vecLayer.addEventListener("error", function (e) {
                console.error("影像底图加载错误:", e);
                alert("影像底图加载错误，将使用默认地图类型");
            });

            map.addLayer(vecLayer);
            map.addLayer(cvaLayer);

            // 监听地图加载事件
            map.addEventListener("loaded", function () {
                console.log("地图加载完成");
                markMapLoaded();
            });
            map.addEventListener("load", function () {
                console.log("地图load事件触发");
                markMapLoaded();
            });
            map.addEventListener("tilesloaded", function () {
                console.log("地图瓦片加载完成");
                markMapLoaded();
            });
            // 监听地图加载失败事件
            map.addEventListener("error", function (e) {
                console.error("地图加载错误:", e);
                alert("地图加载错误: " + e.message);
                hideLoading();
            });

            // 监听地图移动事件，用于更新标签位置
            const moveHandler = function () {
                updateAllLabelsPosition();
            };
            map.addEventListener("move", moveHandler);
            map.addEventListener("zoom", moveHandler);

            // 存储事件处理器，用于清理
            mapLabelHandlers.push({ event: "move", handler: moveHandler });
            mapLabelHandlers.push({ event: "zoom", handler: moveHandler });

            // 超时容错
            setTimeout(() => {
                if (!mapLoaded) markMapLoaded();
            }, 8000);

        } catch (error) {
            alert("地图初始化失败：" + error.message);
            console.error(error);
            hideLoading();
        }
    }

    function markMapLoaded() {
        if (!mapLoaded) {
            mapLoaded = true;
            hideLoading();
            // 不再禁用按钮，保持按钮始终可用
            // disableButtons(false);
            disableTrackButtons(false);
            // 仅开启速度选择，回放按钮按状态控制
            const speedSel = document.getElementById('playbackSpeedSelect');
            if (speedSel) speedSel.disabled = false;
            updatePlaybackButtonsState('idle');
        }
    }

    function showLoading() {
        const loading = document.getElementById("mapLoading");
        loading.style.display = "flex";
        loading.style.opacity = "1";
    }

    function hideLoading() {
        const loading = document.getElementById("mapLoading");
        loading.style.opacity = "0";
        setTimeout(() => loading.style.display = "none", 300);
    }

    function disableButtons(disabled) {
        // 不再禁用按钮，保持按钮始终可用
        // document.getElementById("drawButton").disabled = disabled;
        // document.getElementById("clearButton").disabled = disabled;
    }

    function disableTrackButtons(disabled) {
        const drawTrackBtn = document.getElementById("drawTrackButton");
        const showTrackPointsBtn = document.getElementById("showTrackPointsButton");
        const clearTrackBtn = document.getElementById("clearTrackButton");
        if (drawTrackBtn) drawTrackBtn.disabled = disabled;
        if (showTrackPointsBtn) showTrackPointsBtn.disabled = disabled;
        if (clearTrackBtn) clearTrackBtn.disabled = disabled;
    }
    // 回放控件的禁用/启用
    function disablePlaybackButtons(disabled) {
        ["playbackStartBtn","playbackPauseBtn","playbackStopBtn","playbackSpeedSelect","playbackTimeSlider"].forEach(id=>{
            const el = document.getElementById(id);
            if (el) el.disabled = disabled;
        });
    }

    // 回放按钮状态管理：空闲/播放/暂停
    function updatePlaybackButtonsState(state){
        try {
            const startBtn = document.getElementById('playbackStartBtn');
            const pauseBtn = document.getElementById('playbackPauseBtn');
            const stopBtn = document.getElementById('playbackStopBtn');
            if (!startBtn || !pauseBtn || !stopBtn) return;
            if (state === 'idle') {
                startBtn.disabled = false;
                pauseBtn.disabled = true;
                stopBtn.disabled = true;
                pauseBtn.textContent = '继续';
            } else if (state === 'playing') {
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
                pauseBtn.textContent = '暂停';
            } else if (state === 'paused') {
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
                pauseBtn.textContent = '继续';
            }
        } catch(e) { console.warn('更新按钮状态失败:', e); }
    }

    function bindDrawEvent() {
        document.getElementById("drawButton").addEventListener("click", function () {
            if (isDrawing) { console.log('绘制进行中，忽略重复点击'); return; }
            isDrawing = true;
            showLoading();
            try {
                const wktStr = document.getElementById("wktTextarea").value.trim();
                if (!wktStr) { alert("请输入WKT字符串！"); return; }
                clearOverlays();
                const geojson = parseWkt(wktStr);
    
                const polygonData = [];
                if (geojson.type === "Polygon") {
                    polygonData.push({ index: 1, coordinates: geojson.coordinates });
                } else if (geojson.type === "MultiPolygon") {
                    geojson.coordinates.forEach((polygon, index) => {
                        polygonData.push({ index: index + 1, coordinates: polygon });
                    });
                }
    
                // 重置并绘制
                polygonInfoList = [];
                polygonData.forEach(pd => processPolygon(pd.index, pd.coordinates));
    
                // 视图居中到所有已绘制轮廓
                try { fitViewportToPolygons(); } catch (e) { console.warn('视图居中失败', e); }
    
                // 在视图稳定后再创建/更新标签
                setTimeout(() => {
                    if (labelsEnabled) {
                        try {
                            createAllLabels();
                            updateAllLabelsPosition();
                        } catch (e) {
                            console.warn('创建或更新标签失败:', e);
                        }
                    }
                }, 150);
            } catch (e) {
                alert('绘制失败：' + (e && e.message ? e.message : e));
                console.error('绘制异常:', e);
            } finally {
                hideLoading();
                isDrawing = false;
                // 不再禁用按钮，保持按钮始终可用
                // disableButtons(false);
            }
        });

        document.getElementById("clearButton").addEventListener("click", function () {
            if (isDrawing) { console.log('绘制进行中，暂不清空'); return; }
            clearOverlays();
            console.log("已清空所有轮廓");
        });
    }

    // 存储多边形数据，用于后续标签创建
    let polygonInfoList = [];

    // 处理单个多边形的绘制和面积计算
    function processPolygon(actualPolygonIndex, polygonCoords) {
        console.log('开始处理多边形', actualPolygonIndex);

        // 坐标系选择（绘制始终使用WGS84坐标）
        const coordSys = (document.getElementById('coordSysSelect') && document.getElementById('coordSysSelect').value) || 'wgs84';

        // 统一转换为WGS84用于绘制与面积计算
        function toWgs(point){
            const lng = point[0], lat = point[1];
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                return [lng, lat];
            } else if (coordSys === 'gcj02') {
                const w = gcj02ToWgs84(lng, lat);
                return [w.lng, w.lat];
            } else if (coordSys === 'bd09') {
                const gcj = bd09ToGcj02(lng, lat);
                const w = gcj02ToWgs84(gcj.lng, gcj.lat);
                return [w.lng, w.lat];
            }
            return [lng, lat];
        }
        const coordsWGS84 = polygonCoords.map(ring => ring.map(toWgs));
        let outerRingWGS = coordsWGS84[0] || [];

        // 生成用于绘制的坐标（直接使用WGS84坐标）
        const rings = coordsWGS84.map(ring => ring.map(([lng, lat]) => new T.LngLat(lng, lat)));


         // 创建半透明填充的多边形（无边框）
          const polygon = new T.Polygon(rings, {
              color: currentOutlineColor,
              weight: 1,
              opacity: 1,
              fillColor: currentFillColor,
              fillOpacity: currentFillOpacity
          });
 
          // 使用WGS84坐标计算面积（更准确的面积计算）
         let areaSqm;
         let areaMu;



         try {
             // 检查Turf.js是否可用
             if (typeof turf !== 'undefined' && turf.area) {
                 // 使用Turf.js计算多边形面积
                // 构造GeoJSON格式的多边形
                const geoJsonPolygon = {
                    type: "Polygon",
                    coordinates: coordsWGS84
                };


                 // 使用Turf.js计算面积（平方米）
                 areaSqm = turf.area(geoJsonPolygon);
                 areaMu = (areaSqm / 666.6667).toFixed(4); // 转换为亩
                 console.log(`多边形${actualPolygonIndex}面积计算结果(Turf.js): ${areaSqm}平方米 = ${areaMu}亩`);
             } else {
                 // 如果Turf.js不可用，回退到之前的计算方法
                 console.warn('Turf.js不可用，使用备用计算方法');
                 // 计算带孔洞的多边形面积
                 areaSqm = 0;
                 // 计算外环面积
                 outerRingWGS = coordsWGS84[0] || [];
                 areaSqm += calculatePolygonArea(outerRingWGS);

                 // 减去内环（孔洞）面积
                 for (let i = 1; i < coordsWGS84.length; i++) {
                     const innerRingArea = calculatePolygonArea(coordsWGS84[i]);
                     areaSqm -= innerRingArea;
                 }

                  areaMu = (areaSqm / 666.6667).toFixed(4); // 使用更精确的转换系数
                  console.log(`多边形${actualPolygonIndex}面积计算结果(备用): ${areaSqm}平方米 = ${areaMu}亩`);
              }
          } catch (error) {
              console.error(`面积计算失败:`, error);
              areaSqm = 0;
              areaMu = '0.0000';
          }

          // 计算多边形的中心点和底部中心点（WGS84）
          const centerPoint = calculatePolygonCenter(outerRingWGS);
          const bottomCenterPoint = calculatePolygonBottomCenter(outerRingWGS);

          // 添加多边形到地图
          if (map) {
              map.addOverLay(polygon);
              console.log(`多边形${actualPolygonIndex}已添加到地图`);
          } else {
              console.error('地图对象不存在');
          }

          // 存储多边形信息，用于后续标签创建
          polygonInfoList.push({
              index: actualPolygonIndex,
              polygon: polygon,
              area: areaMu,
              bottomCenter: { lng: bottomCenterPoint.lng, lat: bottomCenterPoint.lat },
              ringPoints: rings
          });
      }

    // 视图居中：根据已绘制的GCJ-02点
    function fitViewportToPolygons() {
        const points = [];
        try {
            if (!map || !map.setViewport) return;
            polygonInfoList.forEach(info => {
                if (!info || !info.ringPoints) return;
                info.ringPoints.forEach(ring => {
                    ring.forEach(ll => points.push(ll));
                });
            });
            if (!points.length) return;
            map.setViewport(points);
        } catch (e) {
            try {
                const lngs = points.map(p => p.lng);
                const lats = points.map(p => p.lat);
                const center = new T.LngLat(
                    (Math.min(...lngs) + Math.max(...lngs)) / 2,
                    (Math.min(...lats) + Math.max(...lats)) / 2
                );
                if (map && map.panTo) map.panTo(center);
            } catch (e2) {
                console.warn('视图居中失败:', e2);
            }
        }
    }

    // 统一创建所有多边形的标签
    function createAllLabels() {
        const mapContainer = document.getElementById('mapContainer');
        if (!mapContainer || !map) return;

        polygonInfoList.forEach(info => {
            if (!info) return;
            // 防止重复创建
            if (info.labelRef) return;
            // 创建标签元素
            const labelDiv = document.createElement('div');
            labelDiv.className = 'area-label';
            labelDiv.innerHTML = `多边形${info.index}：${info.area}亩`;

            // 添加到地图容器并根据屏幕边界定位到轮廓下方
            mapContainer.appendChild(labelDiv);
            positionLabelForPolygon(labelDiv, info);

            // 记录引用，避免重复创建
            info.labelRef = labelDiv;

            // 存储到 currentPolygons 以复用现有定位/清理逻辑
            const labelObj = {
                domElement: labelDiv,
                isDomLabel: true,
                polygonInfo: info
            };
            currentPolygons.push({ polygon: info.polygon, label: labelObj });
        });

        // 不清空 polygonInfoList，便于开关随时创建/隐藏标签
    }

    // 根据多边形屏幕边界定位标签，保证始终在轮廓下方
    function positionLabelForPolygon(labelDiv, info) {
        if (!map || !info || !info.ringPoints) return;
        const points = [];
        info.ringPoints.forEach(ring => {
            ring.forEach(ll => {
                const p = map.lngLatToContainerPoint(ll);
                points.push(p);
            });
        });
        if (!points.length) return;
        const minX = Math.min(...points.map(p => p.x));
        const maxX = Math.max(...points.map(p => p.x));
        const maxY = Math.max(...points.map(p => p.y));
        const container = document.getElementById('mapContainer');
        const labelWidth = labelDiv.offsetWidth;
        const labelHeight = labelDiv.offsetHeight;
        const targetLeft = Math.round((minX + maxX) / 2 - labelWidth / 2);
        const targetTop = Math.round(maxY + 6);
        const clampedLeft = Math.max(0, Math.min(targetLeft, container.clientWidth - labelWidth));
        const clampedTop = Math.max(0, Math.min(targetTop, container.clientHeight - labelHeight));
        labelDiv.style.left = clampedLeft + 'px';
        labelDiv.style.top = clampedTop + 'px';
    }

    // 更新所有标签位置（地图move/zoom时调用）
    function updateAllLabelsPosition() {
        try {
            if (!map) return;
            const container = document.getElementById('mapContainer');
            if (!container) return;
            currentPolygons.forEach(item => {
                if (!item || !item.label) return;
                const labelObj = item.label;
                if (labelObj.isDomLabel && labelObj.domElement && labelObj.polygonInfo) {
                    // 确保标签在容器中
                    if (!labelObj.domElement.parentNode) {
                        container.appendChild(labelObj.domElement);
                    }
                    positionLabelForPolygon(labelObj.domElement, labelObj.polygonInfo);
                }
            });
        } catch (e) {
            console.warn('更新标签位置时出错:', e);
        }
    }
    // 确保在全局可用（处理第三方库事件回调作用域差异）
    window.updateAllLabelsPosition = updateAllLabelsPosition;

    // 绑定“显示亩数标签”开关（默认隐藏）
    function bindLabelsToggle() {
        const cb = document.getElementById('toggleLabelsCheckbox');
        const container = document.getElementById('mapContainer');
        if (!cb || !container) return;
        // 默认隐藏标签
        container.classList.add('labels-hidden');
        cb.addEventListener('change', () => {
            labelsEnabled = cb.checked;
            if (labelsEnabled) {
                container.classList.remove('labels-hidden');
                const hasAnyLabel = currentPolygons.some(item => item && item.label && item.label.domElement);
                if (!hasAnyLabel) {
                    try { createAllLabels(); } catch (e) { console.warn('创建标签失败:', e); }
                }
                updateAllLabelsPosition();
            } else {
                container.classList.add('labels-hidden');
            }
        });
    }

    /**
     * 计算多边形中心点（比底部中心更适合显示标签）
     */
    function calculatePolygonCenter(outerRing) {
        let sumLng = 0, sumLat = 0;
        const len = outerRing.length;

        for (let i = 0; i < len; i++) {
            sumLng += outerRing[i][0];
            sumLat += outerRing[i][1];
        }

        return {
            lng: sumLng / len,
            lat: sumLat / len
        };
    }

    /**
     * 计算多边形面积（球面多边形面积计算）
     * 使用更准确的球面坐标面积计算方法，确保面积与视觉大小一致
     */
    function calculatePolygonArea(coordinates) {
        // 地球半径（米）- 使用更精确的值
        const R = 6371000.8;
        const n = coordinates.length;

        // 将所有坐标转换为弧度
        const coordsRad = coordinates.map(point => [
            point[0] * Math.PI / 180,
            point[1] * Math.PI / 180
        ]);

        let areaRad = 0;

        // 使用更准确的球面多边形面积公式（Girard定理）
        for (let i = 0; i < n; i++) {
            const j = (i + 1) % n;
            const lon1 = coordsRad[i][0];
            const lat1 = coordsRad[i][1];
            const lon2 = coordsRad[j][0];
            const lat2 = coordsRad[j][1];

            // 计算球面多边形面积增量
            const dlon = lon2 - lon1;
            const sinLat1 = Math.sin(lat1);
            const sinLat2 = Math.sin(lat2);
            const cosLat1 = Math.cos(lat1);
            const cosLat2 = Math.cos(lat2);

            // 使用更精确的公式
            areaRad += dlon * (sinLat1 * cosLat2 * Math.cos(dlon / 2) + sinLat2 * cosLat1);
        }

        // 计算总面积（平方米）
        const areaSqm = Math.abs(areaRad) * R * R * 0.5;

        return areaSqm;
    }

    /**
     * 清空所有多边形和标签（同时处理 polygonInfoList 与 currentPolygons）
     */
    function clearOverlays() {
        try {
            // 先移除 polygonInfoList 中记录的多边形与其DOM标签
            polygonInfoList.forEach(info => {
                if (info && info.polygon && map && map.removeOverLay) {
                    try { map.removeOverLay(info.polygon); } catch (e) { console.warn('移除多边形失败:', e); }
                }
                if (info && info.labelRef && info.labelRef.parentNode) {
                    try { info.labelRef.parentNode.removeChild(info.labelRef); } catch (e) { console.warn('移除DOM标签失败:', e); }
                    info.labelRef = null;
                }
            });

            // 再处理 currentPolygons（兼容旧路径与标签对象）
            currentPolygons.forEach(item => {
                if (item.polygon && map && map.removeOverLay) {
                    try { map.removeOverLay(item.polygon); } catch (e) { console.warn('移除多边形失败:', e); }
                }
                if (item.label) {
                    if (item.label.domElement && item.label.domElement.parentNode) {
                        try { item.label.domElement.parentNode.removeChild(item.label.domElement); } catch (e) { console.warn('移除DOM标签失败:', e); }
                    } else if (map && map.removeOverLay && !item.label.isDomLabel) {
                        try { map.removeOverLay(item.label); } catch (e) { console.warn('移除地图覆盖物标签失败:', e); }
                    }
                }
            });

            // 清空记录数组
            currentPolygons = [];
            polygonInfoList = [];

            console.log('已清空所有多边形和标签（保留事件监听器）');
        } catch (error) {
            console.error('清空覆盖物时出错:', error);
        }
    }

    // 其他辅助函数（保持不变）
    function bindMinimizeEvent() {
        const container = document.querySelector(".wkt-input-container");
        const btn = document.getElementById("minimizeBtn");
        const minIcon = btn?.querySelector(".min-icon");
        const restoreIcon = btn?.querySelector(".restore-icon");

        btn?.addEventListener("click", () => {
            const minimized = container.classList.toggle("minimized");
            if (minIcon && restoreIcon) {
                if (minimized) {
                    minIcon.style.display = "none";
                    restoreIcon.style.display = "";
                } else {
                    minIcon.style.display = "";
                    restoreIcon.style.display = "none";
                }
            }
        });
    }

    // 在脚本内部补充：页签切换（3个页签）
     function bindTabs() {
         const tabs = [
             { btn: document.getElementById('tabDrawBtn'), pane: document.getElementById('tabDraw'), key: 'draw' },
             { btn: document.getElementById('tabTrackBtn'), pane: document.getElementById('tabTrack'), key: 'track' },
             { btn: document.getElementById('tabSplitBtn'), pane: document.getElementById('tabSplit'), key: 'split' },
             { btn: document.getElementById('tabBatchBtn'), pane: document.getElementById('tabBatch'), key: 'batch' },
         ];
         if (tabs.some(t => !t.btn || !t.pane)) return;
         function activate(key) {
             tabs.forEach(t => {
                 const active = t.key === key;
                 t.btn.classList.toggle('active', active);
                 t.pane.classList.toggle('active', active);
             });
         }
         tabs.forEach(t => t.btn.addEventListener('click', () => activate(t.key)));
         activate('draw');
     }
    function updateParserStatus() {
        const el = document.getElementById('parserStatus');
        if (!el) return;
        const ok = (typeof Terraformer !== 'undefined' && Terraformer.WKT && typeof Terraformer.WKT.parse === 'function');
        if (ok) {
            el.textContent = 'Terraformer WKT Parser';
            el.style.color = '#2f8f2f';
        } else {
            el.textContent = '本地回退解析（仅支持POLYGON/MULTIPOLYGON）';
            el.style.color = '#c77d1e';
        }
    }
     function parseWkt(wkt) {
         wkt = wkt.trim();
         // 优先使用成熟库（Terraformer WKT Parser）
         if (typeof Terraformer !== 'undefined' && Terraformer.WKT && Terraformer.WKT.parse) {
             try {
                 return Terraformer.WKT.parse(wkt);
             } catch (e) {
                 console.warn('Terraformer解析失败，尝试本地回退解析:', e);
             }
         } else {
             // 不再提示“未加载”，由状态栏展示回退信息
         }
         // 回退解析：仅支持 POLYGON / MULTIPOLYGON
         const typeMatch = wkt.match(/^\s*(POLYGON|MULTIPOLYGON)\s*\(/i);
         if (!typeMatch) throw new Error('仅支持POLYGON/MULTIPOLYGON');
         const type = typeMatch[1].toUpperCase();
         const inner = wkt.substring(wkt.indexOf('('));
         if (type === 'POLYGON') {
             const coords = parsePolygonCoords(inner.replace(/^\(/, '').replace(/\)$/, ''));
             return { type: 'Polygon', coordinates: coords };
         } else {
             const trimmed = inner.replace(/^\(\(/, '').replace(/\)\)$/, '');
             const coords = parseMultiPolygonCoords(trimmed);
             return { type: 'MultiPolygon', coordinates: coords };
         }
     }

     function bindMultiSplitter() {
         const input = document.getElementById('multiInput');
         const output = document.getElementById('polyOutput');
         const splitBtn = document.getElementById('splitMultiBtn');
         const copyBtn = document.getElementById('copyPolysBtn');
         if (!input || !output || !splitBtn || !copyBtn) return;

         // 本地WKT序列化辅助
         function ringToText(ring) {
             if (!ring || !ring.length) return '()';
             const first = ring[0];
             const last = ring[ring.length - 1];
             const closed = (first[0] === last[0] && first[1] === last[1]) ? ring : ring.concat([[first[0], first[1]]]);
             return '(' + closed.map(pt => pt[0] + ' ' + pt[1]).join(', ') + ')';
         }
         function toWktPolygonCoords(coords) {
             return 'POLYGON(' + coords.map(ringToText).join(', ') + ')';
         }
         function toWktMulti(coords) {
             return 'MULTIPOLYGON(' + coords.map(poly => '(' + poly.map(ringToText).join(', ') + ')').join(', ') + ')';
         }

         function polygonsFromMulti(text) {
             const geo = parseWkt(text.trim());
             if (geo.type !== 'MultiPolygon') throw new Error('请输入有效的 MULTIPOLYGON WKT');
             const polys = geo.coordinates.map(rings => toWktPolygonCoords(rings));
             return polys;
         }
         splitBtn.addEventListener('click', () => {
             try {
                 const list = polygonsFromMulti(input.value.trim());
                 output.value = list.join('\n');
             } catch (e) {
                 alert('分割失败：' + e.message);
             }
         });
         copyBtn.addEventListener('click', async () => {
             const val = output.value.trim();
             if (!val) { alert('没有可复制的结果'); return; }
             try { await navigator.clipboard.writeText(val); alert('已复制到剪贴板'); } catch (e) { console.warn('复制失败', e); }
         });
     }

     function bindBatchGenerator() {
         const batchInput = document.getElementById('batchInput');
         const output = document.getElementById('multiOutput');
         const genBtn = document.getElementById('generateMultiBtn');
         const copyBtn = document.getElementById('copyMultiBtn');

         // 本地WKT序列化辅助（与分割器保持一致）
         function ringToText(ring) {
             if (!ring || !ring.length) return '()';
             const first = ring[0];
             const last = ring[ring.length - 1];
             const closed = (first[0] === last[0] && first[1] === last[1]) ? ring : ring.concat([[first[0], first[1]]]);
             return '(' + closed.map(pt => pt[0] + ' ' + pt[1]).join(', ') + ')';
         }
         function toWktMulti(coords) {
             return 'MULTIPOLYGON(' + coords.map(poly => '(' + poly.map(ringToText).join(', ') + ')').join(', ') + ')';
         }

         genBtn.addEventListener('click', () => {
             try {
                 const lines = batchInput.value.trim().split(/\n|;/).map(s => s.trim()).filter(Boolean);
                 if (lines.length === 0) throw new Error('请按每行或分号输入至少一个POLYGON');
                 const polygons = lines.map((line, idx) => {
                     const g = parseWkt(line);
                     if (g.type !== 'Polygon') throw new Error(`第${idx + 1}行不是有效的POLYGON WKT`);
                     return g;
                 });
                 const multiGeo = { type: 'MultiPolygon', coordinates: polygons.map(p => p.coordinates) };
                 output.value = toWktMulti(multiGeo.coordinates);
             } catch (e) {
                 alert('生成失败：' + e.message);
             }
         });

         copyBtn.addEventListener('click', async () => {
             const val = output.value.trim();
             if (!val) { alert('没有可复制的结果'); return; }
             try { await navigator.clipboard.writeText(val); alert('已复制到剪贴板'); } catch (e) { console.warn('复制失败', e); }
         });

     }

     function setExampleWkt() {
         const exampleWkt = "MULTIPOLYGON(" +
             "(" +
             "(116.35 39.93, 116.39 39.93, 116.39 39.90, 116.35 39.90, 116.35 39.93)," + // 外环
             "(116.36 39.92, 116.38 39.92, 116.38 39.91, 116.36 39.91, 116.36 39.92)" +  // 内环
             ")," +
             "(" +
             "(116.40 39.95, 116.43 39.97, 116.46 39.96, 116.49 39.98, 116.52 39.95, 116.55 39.93, 116.58 39.94, 116.61 39.92, 116.64 39.95, 116.40 39.95)" +
             ")" +
             ")";
         document.getElementById("wktTextarea").value = exampleWkt;
     }

     function parsePolygonCoords(coordStr) {
         const ringStrs = coordStr.split(/\)\s*,\s*\(/).map(s => s.replace(/[()]/g, '').trim());
         const rings = [];
         ringStrs.forEach(ringStr => {
             const pts = ringStr.split(/,\s*/).map(pointStr => {
                 const [lng, lat] = pointStr.split(/\s+/).map(Number);
                 if (isNaN(lng) || isNaN(lat)) throw new Error("坐标格式错误：" + pointStr);
                 return [lng, lat];
             });
             // 自动拆分：如果一个ring中包含多次回到起点（闭合），则拆分为多个环
             // 兼容用户将外环与内环错误地写在同一对括号中的情况
             let start = 0;
             while (start < pts.length) {
                 const startPt = pts[start];
                 let closeIdx = -1;
                 for (let i = start + 1; i < pts.length; i++) {
                     if (pts[i][0] === startPt[0] && pts[i][1] === startPt[1]) {
                         closeIdx = i;
                         break;
                     }
                 }
                 if (closeIdx === -1) {
                     // 未找到闭合：将剩余点视为一个环，并强制闭合
                     const ring = pts.slice(start);
                     if (ring.length && (ring[0][0] !== ring[ring.length - 1][0] || ring[0][1] !== ring[ring.length - 1][1])) {
                         ring.push([ring[0][0], ring[0][1]]);
                     }
                     rings.push(ring);
                     break;
                 } else {
                     const ring = pts.slice(start, closeIdx + 1);
                     rings.push(ring);
                     start = closeIdx + 1;
                 }
             }
         });
         return rings;
     }

     function parseMultiPolygonCoords(coordStr) {
         const polygonStrs = coordStr.split(/\)\s*\)\s*,\s*\(\s*\(/).map(s => s.replace(/[()]/g, '').trim());
         return polygonStrs.map(polygonStr => parsePolygonCoords(polygonStr));
     }

     function wgs84ToGcj02(lng, lat) {
         const x_PI = 3.14159265358979324 * 3000.0 / 180.0;
         const PI = 3.1415926535897932384626;
         const a = 6378245.0;
         const ee = 0.00669342162296594323;

         if (outOfChina(lng, lat)) return { lng, lat };

         let dlat = transformLat(lng - 105.0, lat - 35.0);
         let dlng = transformLng(lng - 105.0, lat - 35.0);
         const radlat = lat / 180.0 * PI;
         let magic = Math.sin(radlat);
         magic = 1 - ee * magic * magic;
         const sqrtmagic = Math.sqrt(magic);
         dlat = (dlat * 180.0) / ((a * (1 - ee)) / (magic * sqrtmagic) * PI);
         dlng = (dlng * 180.0) / (a / sqrtmagic * Math.cos(radlat) * PI);

         return { lng: lng + dlng, lat: lat + dlat };

         function outOfChina(lng, lat) {
             return (lng < 72.004 || lng > 137.8347) || (lat < 0.8293 || lat > 55.8271);
         }

         function transformLat(x, y) {
             let ret = -100.0 + 2.0 * x + 3.0 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * Math.sqrt(Math.abs(x));
             ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
             ret += (20.0 * Math.sin(y * PI) + 40.0 * Math.sin(y / 3.0 * PI)) * 2.0 / 3.0;
             ret += (160.0 * Math.sin(y / 12.0 * PI) + 320 * Math.sin(y * PI / 30.0)) * 2.0 / 3.0;
             return ret;
         }

         function transformLng(x, y) {
             let ret = 300.0 + x + 2.0 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * Math.sqrt(Math.abs(x));
             ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
             ret += (20.0 * Math.sin(x * PI) + 40.0 * Math.sin(x / 3.0 * PI)) * 2.0 / 3.0;
             ret += (150.0 * Math.sin(x / 12.0 * PI) + 300.0 * Math.sin(x / 30.0 * PI)) * 2.0 / 3.0;
             return ret;
         }
     }

     function gcj02ToWgs84(lng, lat) {
         const g = wgs84ToGcj02(lng, lat);
         return { lng: lng * 2 - g.lng, lat: lat * 2 - g.lat };
     }

     function bd09ToGcj02(bdLng, bdLat) {
         const x_PI = 3.14159265358979324 * 3000.0 / 180.0;
         const x = bdLng - 0.0065;
         const y = bdLat - 0.006;
         const z = Math.sqrt(x * x + y * y) - 0.00002 * Math.sin(y * x_PI);
         const theta = Math.atan2(y, x) - 0.000003 * Math.cos(x * x_PI);
         const ggLng = z * Math.cos(theta);
         const ggLat = z * Math.sin(theta);
         return { lng: ggLng, lat: ggLat };
     }

     function calculatePolygonBottomCenter(outerRing) {
         let minLat = Infinity;
         let bottomPoints = [];
         outerRing.forEach(point => {
             const lat = point[1];
             if (lat < minLat) {
                 minLat = lat;
                 bottomPoints = [point];
             } else if (lat === minLat) {
                 bottomPoints.push(point);
             }
         });

         const sumLng = bottomPoints.reduce((sum, point) => sum + point[0], 0);
         const centerLng = sumLng / bottomPoints.length;

         return { lng: centerLng, lat: minLat };
     }

     function fitBounds(geojson) {
         try {
             const allPoints = [];
             function collectPoints(coords) {
                 if (typeof coords[0] === 'number') {
                     allPoints.push(coords);
                 } else {
                     coords.forEach(coord => collectPoints(coord));
                 }
             }
             collectPoints(geojson.coordinates);

             if (allPoints.length === 0) return;

             const lats = allPoints.map(p => p[1]);
             const lngs = allPoints.map(p => p[0]);
             const minLng = Math.min(...lngs);
             const maxLng = Math.max(...lngs);
             const minLat = Math.min(...lats);
             const maxLat = Math.max(...lats);

             const sw = wgs84ToGcj02(minLng, minLat);
             const ne = wgs84ToGcj02(maxLng, maxLat);

             // 修复setViewport方法的使用，确保参数格式正确
             if (map && map.setViewport) {
                 map.setViewport([
                     new T.LngLat(sw.lng, sw.lat),
                     new T.LngLat(ne.lng, ne.lat)
                 ], { padding: [50, 50] });
             } else {
                 console.warn('地图对象或setViewport方法不可用');
             }
         } catch (error) {
             console.error('调整视图范围时出错:', error);
         }
     }
// 轨迹绘制与解析
    function bindTrackEvents() {
        const drawBtn = document.getElementById('drawTrackButton');
        const showPointsBtn = document.getElementById('showTrackPointsButton');
        const clearBtn = document.getElementById('clearTrackButton');
        const ta = document.getElementById('trackTextarea');
        if (!drawBtn || !showPointsBtn || !clearBtn || !ta) return;

        drawBtn.addEventListener('click', function(){
            try {
                const text = ta.value.trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const points = parseTrackText(text);
                if (points.length < 2) { alert('有效轨迹点不足，至少需要两点'); return; }
                drawTrackFromPoints(points);
                fitViewportToTrack(points);
            } catch (e) {
                alert('绘制轨迹失败：' + (e && e.message ? e.message : e));
                console.error('绘制轨迹异常:', e);
            }
        });

        showPointsBtn.addEventListener('click', function(){
            try {
                const text = ta.value.trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const points = parseTrackText(text);
                if (points.length === 0) { alert('未找到有效轨迹点'); return; }
                showTrackPoints(points);
                fitViewportToTrack(points);
            } catch (e) {
                alert('显示轨迹点失败：' + (e && e.message ? e.message : e));
                console.error('显示轨迹点异常:', e);
            }
        });

        clearBtn.addEventListener('click', function(){
            clearTrackOverlays();
            console.log('已清空轨迹');
        });
    }

    function showTrackPoints(points) {
        // 先移除旧轨迹（不影响轮廓）
        clearTrackOverlays(false);
        
        if (!map || !points || points.length === 0) {
            console.log('无轨迹点可显示');
            return;
        }
        
        console.log(`准备显示${points.length}个轨迹点`);
        
        // 使用批量处理和更小的图标来提高性能
        // 创建一个更小的自定义颜色点SVG图标
        const smallColoredDotIcon = new T.Icon({
            iconUrl: `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1" height="1"><circle cx="0.5" cy="0.5" r="0.3" fill="%23${currentTrackPointColor.substring(1)}"/></svg>`,
            iconSize: new T.Point(1, 1),
            iconAnchor: new T.Point(0.5, 0.5)
        });
        
        // 优化批量添加点的速度
        const batchSize = 2000; // 增加每批处理的点数
        const concurrentBatches = 4; // 并发批次数量
        
        // 预创建点击事件处理函数，避免重复创建
        function createClickHandler(point, index) {
            return function() {
                const infoWindow = new T.InfoWindow({
                    content: `点${index + 1}<br/>经度: ${point.lng.toFixed(6)}<br/>纬度: ${point.lat.toFixed(6)}`,
                    offset: new T.Point(0, -20)
                });
                infoWindow.open(map, point);
            };
        }
        
        // 使用setTimeout实现更高效的批量添加，避免阻塞UI
        let currentIndex = 0;
        
        function addBatch() {
            if (currentIndex >= points.length) {
                console.log(`已显示${points.length}个轨迹点`);
                return;
            }
            
            // 添加当前批次的点
            const endIndex = Math.min(currentIndex + batchSize, points.length);
            const markersToAdd = [];
            
            // 先创建所有标记
            for (let i = currentIndex; i < endIndex; i++) {
                const point = points[i];
                const index = i;
                
                const marker = new T.Marker(point, {
                    icon: smallColoredDotIcon
                });
                
                // 添加点击事件
                marker.addEventListener('click', createClickHandler(point, index));
                
                markersToAdd.push(marker);
            }
            
            // 批量添加到地图和数组
            markersToAdd.forEach(marker => {
                map.addOverLay(marker);
                currentTracks.push(marker);
            });
            
            currentIndex = endIndex;
            
            // 使用setTimeout而不是requestAnimationFrame，减少对渲染周期的依赖
            // 设置为0，将任务放入微任务队列，但允许UI有短暂的呼吸空间
            setTimeout(addBatch, 0);
        }
        
        // 启动批量添加
        addBatch();
    }
    
    // 恢复原始的clearTrackOverlays函数
    function clearTrackOverlays(resetArray = true){        
        try {
            currentTracks.forEach(pl => {
                if (pl && map && map.removeOverLay) {
                    try { map.removeOverLay(pl); } catch (e) { console.warn('移除轨迹失败:', e); }
                }
            });
            if (resetArray) currentTracks = [];
        } catch (e) {
            console.warn('清空轨迹时出错:', e);
        }
    }

    function parseTrackText(text){
        // 选择输入坐标系（优先使用轨迹页签专属选择器，若未设置则回退到绘制页签选择器）
        const coordSysEl = document.getElementById('trackCoordSysSelect') || document.getElementById('coordSysSelect');
        const coordSys = (coordSysEl && coordSysEl.value) || 'wgs84';
        const isHash = text.indexOf('#') !== -1;
        const items = isHash ? text.split('#') : text.split(/\r?\n/);
        const pts = [];
        for (let i=0;i<items.length;i++){
            const raw = items[i];
            if (!raw) continue;
            const line = raw.trim();
            if (!line) continue;
            const parts = line.split(',');
            if (parts.length < 3) continue;
            let lng = parseFloat((parts[isHash ? 0 : 1] || '').trim());
            let lat = parseFloat((parts[isHash ? 1 : 2] || '').trim());
            // 初步过滤：数值合法性与正常范围
            if (!isFinite(lng) || !isFinite(lat)) continue;
            if (lng === 0 || lat === 0) continue; // 丢弃0.0异常点
            if (lng < -180 || lng > 180 || lat < -90 || lat > 90) continue; // 超出经纬度范围丢弃

            // 将输入坐标转换为WGS84
            let w;
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                w = { lng, lat };
            } else if (coordSys === 'gcj02') {
                w = gcj02ToWgs84(lng, lat);
            } else if (coordSys === 'bd09') {
                const g = bd09ToGcj02(lng, lat);
                w = gcj02ToWgs84(g.lng, g.lat);
            } else {
                w = { lng, lat };
            }
            // 转换结果兜底检查
            if (!isFinite(w.lng) || !isFinite(w.lat)) continue;
            if (w.lng < -180 || w.lng > 180 || w.lat < -90 || w.lat > 90) continue;

            // 使用WGS84坐标绘制到地图
            pts.push(new T.LngLat(w.lng, w.lat));
        }
        return pts;
    }

    function drawTrackFromPoints(points){
        // 先移除旧轨迹（不影响轮廓）
        clearTrackOverlays(false);
        const polyline = new T.Polyline(points, {
            color: currentTrackLineColor,
            weight: 1,
            opacity: 0.9
        });
        if (map) {
            map.addOverLay(polyline);
        }
        currentTracks.push(polyline);
    }

    function clearTrackOverlays(resetArray = true){
        try {
            currentTracks.forEach(pl => {
                if (pl && map && map.removeOverLay) {
                    try { map.removeOverLay(pl); } catch (e) { console.warn('移除轨迹失败:', e); }
                }
            });
            if (resetArray) currentTracks = [];
        } catch (e) {
            console.warn('清空轨迹时出错:', e);
        }
    }


    function fitViewportToTrack(points){
        try {
            if (!map || !map.setViewport || !points || !points.length) return;
            map.setViewport(points);
        } catch (e) {
            console.warn('轨迹视图居中失败:', e);
        }
    }

    // ========= 轨迹回放功能 =========
    let playbackState = { points: [], idx: 0, speed: 1, timer: null, running: false, marker: null, line: null, path: [] };

    function bindPlaybackControls(){
        const startBtn = document.getElementById('playbackStartBtn');
        const pauseBtn = document.getElementById('playbackPauseBtn');
        const stopBtn = document.getElementById('playbackStopBtn');
        const speedSel = document.getElementById('playbackSpeedSelect');
        const timeSlider = document.getElementById('playbackTimeSlider');
        const timeCursor = document.getElementById('playbackTimeCursor');
        const ta = document.getElementById('trackTextarea');
        if (!startBtn || !pauseBtn || !stopBtn || !speedSel) return;

        // 初始按钮状态
        updatePlaybackButtonsState('idle');

        startBtn.addEventListener('click', function(){
            try {
                const text = (ta && ta.value || '').trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const pts = parseTrackTextWithTime(text);
                if (pts.length < 2) { alert('有效轨迹点不足，至少需要两点'); return; }
                startPlayback(pts);
                // 状态在startPlayback中已设置为playing
            } catch (e) {
                alert('开始回放失败：' + (e && e.message ? e.message : e));
                console.error('开始回放异常:', e);
            }
        });

        pauseBtn.addEventListener('click', function(){
            if (!playbackState.running) {
                // 继续
                playbackState.running = true;
                scheduleNext();
                updatePlaybackButtonsState('playing');
            } else {
                // 暂停
                if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
                playbackState.running = false;
                updatePlaybackButtonsState('paused');
            }
        });

        stopBtn.addEventListener('click', function(){ 
            stopPlayback(); 
            updatePlaybackButtonsState('idle');
        });

        speedSel.addEventListener('change', function(){
            const v = parseFloat(speedSel.value);
            playbackState.speed = (isFinite(v) && v > 0) ? v : 1;
        });

        if (timeSlider) {
            timeSlider.addEventListener('input', function(){
                const ms = parseInt(timeSlider.value, 10);
                const txt = formatTimeForLabel(ms);
                if (timeCursor) timeCursor.textContent = txt;
            });
            timeSlider.addEventListener('change', function(){
                jumpToSliderTime();
            });
        }
    }

    function parseTrackTextWithTime(text){
        const coordSysEl = document.getElementById('trackCoordSysSelect') || document.getElementById('coordSysSelect');
        const coordSys = (coordSysEl && coordSysEl.value) || 'wgs84';
        const isHash = text.indexOf('#') !== -1;
        const items = isHash ? text.split('#') : text.split(/\r?\n/);
        const out = [];
        for (let i=0;i<items.length;i++){
            const raw = items[i];
            if (!raw) continue;
            const line = raw.trim();
            if (!line) continue;
            const parts = line.split(',');
            if (parts.length < 3) continue;
            const tsRaw = (parts[isHash ? 2 : 0] || '').trim();
            const ts = (tsRaw || '').replace(/\D/g,'');
            let lng = parseFloat((parts[isHash ? 0 : 1] || '').trim());
            let lat = parseFloat((parts[isHash ? 1 : 2] || '').trim());
            if (!isFinite(lng) || !isFinite(lat)) continue;
            if (lng === 0 || lat === 0) continue;
            if (lng < -180 || lng > 180 || lat < -90 || lat > 90) continue;
            const t = parseTimestamp(ts);
            if (!t) continue;
            let w;
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                w = { lng, lat };
            } else if (coordSys === 'gcj02') {
                w = gcj02ToWgs84(lng, lat);
            } else if (coordSys === 'bd09') {
                const g = bd09ToGcj02(lng, lat);
                w = gcj02ToWgs84(g.lng, g.lat);
            } else { w = { lng, lat }; }
            if (!isFinite(w.lng) || !isFinite(w.lat)) continue;
            if (w.lng < -180 || w.lng > 180 || w.lat < -90 || w.lat > 90) continue;
            out.push({ ll: new T.LngLat(w.lng, w.lat), time: t, ts });
        }
        out.sort((a,b)=>a.time - b.time);
        return out;
    }

    function parseTimestamp(ts){
        const tstr = (ts || '').replace(/\D/g,'');
        const m = tstr && tstr.match(/^\d{14}$/);
        if (!m) return null;
        const y = parseInt(tstr.slice(0,4),10);
        const M = parseInt(tstr.slice(4,6),10) - 1;
        const d = parseInt(tstr.slice(6,8),10);
        const h = parseInt(tstr.slice(8,10),10);
        const m2 = parseInt(tstr.slice(10,12),10);
        const s = parseInt(tstr.slice(12,14),10);
        const dt = new Date(y,M,d,h,m2,s);
        return isNaN(dt.getTime()) ? null : dt;
    }

    function startPlayback(points){
        console.log('[Playback] startPlayback: 点数=', points && points.length);
        stopPlayback();
        playbackState.points = points;
        playbackState.idx = 0;
        playbackState.speed = playbackState.speed || 1;
        playbackState.running = true;
        // 配置时间滑动条，并尊重现有滑块位置作为起始
        configureTimeSlider(points);
        // 启用滑块
        const slider = document.getElementById('playbackTimeSlider');
        if (slider) slider.disabled = false;
        let initIdx = 0;
        if (slider && slider.min && slider.max) {
            const ms = parseInt(slider.value, 10);
            if (isFinite(ms)) initIdx = findIndexByTime(points, ms);
        }
        playbackState.idx = initIdx;
        const first = points[initIdx];
        console.log('[Playback] 首点:', first && first.ts, first && first.ll, 'initIdx=', initIdx);
        playbackState.path = points.slice(0, initIdx+1).map(p=>p.ll);
        playbackState.line = new T.Polyline(playbackState.path, { color: currentTrackLineColor, weight: 1, opacity: 0.9 });
        if (map) {
            map.addOverLay(playbackState.line);
        }
        currentTracks.push(playbackState.line);
        // 创建并定位DOM标记以保证可见移动
        ensurePlaybackDom(first.ll);
        updatePlaybackDom(first.ll);
        updatePlaybackTimeLabel(first.ts);
        try { fitViewportToTrack(points.map(p=>p.ll)); } catch(e){}
        // 更新按钮状态
        updatePlaybackButtonsState('playing');
        scheduleNext();
    }

    function scheduleNext(){
        if (!playbackState.running) return;
        if (!playbackState.points || playbackState.idx >= playbackState.points.length - 1) {
            playbackState.running = false;
            console.log('[Playback] 回放结束：idx=', playbackState.idx, '点数=', playbackState.points ? playbackState.points.length : 0);
            updatePlaybackButtonsState('idle'); // 播放结束后按钮回到初始状态：开始可点，继续/结束灰化
            return;
        }
        const next = playbackState.points[playbackState.idx+1];
        const speed = playbackState.speed || 1;
        const delay = Math.max(4, Math.round(1000 / speed)); // 1x=1000ms/点，2x=500ms/点...
        console.log('[Playback] scheduleNext: idx=', playbackState.idx, '->', playbackState.idx+1, 'delay=', delay, 'speed=', speed);
        playbackState.timer = setTimeout(()=>{
            playbackState.idx++;
            const nextLL = next.ll;
            console.log('[Playback] 下一点:', next && next.ts, nextLL);
            try {
                // 维护路径数组
                playbackState.path = playbackState.path || [];
                playbackState.path.push(nextLL);
                console.log('[Playback] 路径长度=', playbackState.path.length);
                // 使用DOM标记进行移动（容器/图层坐标）
                if (!playbackDom.el) console.log('[Playback] DOM标记不存在，将尝试创建');
                updatePlaybackDom(nextLL);
                // 折线更新：优先setLngLats，兜底重建
                if (playbackState.line && typeof playbackState.line.setLngLats === 'function') {
                    try { playbackState.line.setLngLats(playbackState.path); }
                    catch(e){
                        console.warn('[Playback] setLngLats失败，重建折线', e);
                        if (map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                        playbackState.line = new T.Polyline(playbackState.path, { color: currentTrackLineColor, weight: 1, opacity: 0.9 });
                        if (map) map.addOverLay(playbackState.line);
                    }
                } else {
                    console.log('[Playback] 折线不支持setLngLats，重建');
                    if (playbackState.line && map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                    playbackState.line = new T.Polyline(playbackState.path, { color: currentTrackLineColor, weight: 1, opacity: 0.9 });
                    if (map) map.addOverLay(playbackState.line);
                }
            } catch(e) { console.warn('更新回放覆盖物失败:', e); }
            updatePlaybackTimeLabel(next.ts);
            scheduleNext();
        }, delay);
    }

    function stopPlayback(){
        if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
        playbackState.running = false;
        playbackState.idx = 0;
        try {
            // 移除DOM标记
            removePlaybackDom();
            if (playbackState.marker && map) map.removeOverLay(playbackState.marker);
            if (playbackState.line && map) map.removeOverLay(playbackState.line);
        } catch(e){}
        playbackState.marker = null;
        playbackState.line = null;
        updatePlaybackTimeLabel('—');
        // 按钮回到初始状态
        updatePlaybackButtonsState('idle');
    }

    function updatePlaybackTimeLabel(text){
        const el = document.getElementById('playbackTimeLabel');
        if (el) el.textContent = '时间：' + (text || '—');
    }

    // 时间滑动条：配置与跳转
    function configureTimeSlider(points){
        try {
            const slider = document.getElementById('playbackTimeSlider');
            const cursor = document.getElementById('playbackTimeCursor');
            if (!slider || !points || !points.length) return;
            const minMs = points[0].time.getTime();
            const maxMs = points[points.length - 1].time.getTime();
            const prev = parseInt(slider.value, 10);
            slider.min = String(minMs);
            slider.max = String(maxMs);
            slider.step = '1000'; // 以秒为步进
            let val = (isFinite(prev) && prev >= minMs && prev <= maxMs) ? prev : minMs;
            slider.value = String(val);
            if (cursor) cursor.textContent = formatTimeForLabel(val);
        } catch(e) { console.warn('配置时间滑动条失败:', e); }
    }
    function formatTimeForLabel(ms){
        if (!isFinite(ms)) return '—';
        const d = new Date(ms);
        const pad = n => String(n).padStart(2,'0');
        const y = d.getFullYear();
        const M = pad(d.getMonth()+1);
        const da = pad(d.getDate());
        const h = pad(d.getHours());
        const m = pad(d.getMinutes());
        const s = pad(d.getSeconds());
        return `${y}-${M}-${da} ${h}:${m}:${s}`;
    }
    function findIndexByTime(points, ms){
        try {
            if (!points || !points.length) return 0;
            const n = points.length;
            const minMs = points[0].time.getTime();
            const maxMs = points[n-1].time.getTime();
            if (!isFinite(ms)) return 0;
            if (ms <= minMs) return 0;
            if (ms >= maxMs) return n-1;
            let lo = 0, hi = n - 1, ans = 0;
            while (lo <= hi) {
                const mid = (lo + hi) >> 1;
                const t = points[mid].time.getTime();
                if (t < ms) { lo = mid + 1; ans = lo; }
                else { hi = mid - 1; ans = mid; }
            }
            return Math.max(0, Math.min(n-1, ans));
        } catch(e){ console.warn('findIndexByTime失败:', e); return 0; }
    }
    function jumpToSliderTime(){
        try {
            const slider = document.getElementById('playbackTimeSlider');
            if (!slider || !playbackState.points || !playbackState.points.length) return;
            const ms = parseInt(slider.value, 10);
            if (!isFinite(ms)) return;
            const idx = findIndexByTime(playbackState.points, ms);
            playbackState.idx = idx;
            const pts = playbackState.points;
            const ll = pts[idx].ll;
            playbackState.path = pts.slice(0, idx+1).map(p=>p.ll);
            // 更新折线
            try {
                if (playbackState.line && typeof playbackState.line.setLngLats === 'function') {
                    playbackState.line.setLngLats(playbackState.path);
                } else {
                    if (playbackState.line && map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                    playbackState.line = new T.Polyline(playbackState.path, { color: currentTrackLineColor, weight: 1, opacity: 0.9 });
                    if (map) map.addOverLay(playbackState.line);
                }
            } catch(e){ console.warn('滑块更新折线失败:', e); }
            // 更新标记与时间
            ensurePlaybackDom(ll);
            updatePlaybackDom(ll);
            updatePlaybackTimeLabel(pts[idx].ts);
            // 若正在播放，立即按新位置继续
            if (playbackState.running) {
                if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
                scheduleNext();
            }
        } catch(e) { console.warn('滑块跳转失败:', e); }
    }

    // DOM标记：使用容器坐标实现可见移动
    let playbackDom = { el: null, lastLL: null, bound: false };

    function ensurePlaybackDom(ll){
        try {
            playbackDom.lastLL = ll;
            const pane = (map && map.getPanes && map.getPanes().overlayPane) || document.getElementById('mapContainer');
            if (!pane) { console.warn('未找到overlayPane或mapContainer'); return; }
            if (!playbackDom.el) {
                const el = document.createElement('div');
                el.id = 'playbackDomMarker';
                el.style.position = 'absolute';
                el.style.width = '0';
                el.style.height = '0';
                el.style.borderLeft = '3px solid transparent';
                el.style.borderRight = '3px solid transparent';
                el.style.borderBottom = '4px solid #2C64A7';
                el.style.borderTop = '0';
                el.style.transform = 'translate(-50%, -50%)';
                el.style.zIndex = '9999';
                // 添加伪元素来增强箭头效果
                el.style.clipPath = 'polygon(50% 0, 100% 100%, 0 100%)';
                pane.appendChild(el);
                playbackDom.el = el;
                console.log('[Playback] 创建DOM标记，父节点=', pane === document.getElementById('mapContainer') ? '#mapContainer' : 'overlayPane');
                bindPlaybackDomEvents();
            }
            updatePlaybackDom(ll);
        } catch(e) { console.warn('创建DOM标记失败:', e); }
    }

    function updatePlaybackDom(ll){
        try {
            playbackDom.lastLL = ll;
            if (!map || !playbackDom.el || !ll) { console.log('[Playback] update取消：map/el/ll缺失'); return; }
            let p;
            if (typeof map.lngLatToLayerPoint === 'function') {
                p = map.lngLatToLayerPoint(ll);
                console.log('[Playback] 使用layerPoint定位:', ll && ll.lng, ll && ll.lat, '=>', p && p.x, p && p.y);
            } else if (typeof map.lngLatToContainerPoint === 'function') {
                p = map.lngLatToContainerPoint(ll);
                console.log('[Playback] 使用containerPoint定位:', ll && ll.lng, ll && ll.lat, '=>', p && p.x, p && p.y);
            } else {
                console.warn('地图对象不支持lngLat到像素坐标转换');
                return;
            }
            playbackDom.el.style.left = p.x + 'px';
            playbackDom.el.style.top = p.y + 'px';
        } catch(e) { console.warn('更新DOM标记位置失败:', e); }
    }

    function bindPlaybackDomEvents(){
        if (playbackDom.bound) return;
        const updater = function(){
            try {
                if (!map || !playbackDom.el || !playbackDom.lastLL) return;
                let p;
                if (typeof map.lngLatToLayerPoint === 'function') {
                    p = map.lngLatToLayerPoint(playbackDom.lastLL);
                } else if (typeof map.lngLatToContainerPoint === 'function') {
                    p = map.lngLatToContainerPoint(playbackDom.lastLL);
                }
                if (!p) return;
                playbackDom.el.style.left = p.x + 'px';
                playbackDom.el.style.top = p.y + 'px';
            } catch(e){}
        };
        try {
            map.addEventListener('move', updater);
            map.addEventListener('zoom', updater);
            playbackDom.bound = true;
        } catch(e){}
    }

    function removePlaybackDom(){
        try {
            const el = playbackDom.el;
            playbackDom.lastLL = null;
            if (el && el.parentNode) el.parentNode.removeChild(el);
        } catch(e){}
        playbackDom.el = null;
        playbackDom.bound = false;
    }

    // 测量功能相关变量
    let measureState = {
        isActive: false,
        mode: '', // 'distance' or 'area'
        points: [],
        tempLine: null,
        lines: [],
        markers: [],
        labels: [],
        polygon: null,
        areaLabel: null
    };

    // 绑定测量按钮事件
    function bindMeasureEvents() {
        const distanceBtn = document.getElementById('measureDistanceBtn');
        const areaBtn = document.getElementById('measureAreaBtn');
        
        if (distanceBtn) {
            distanceBtn.addEventListener('click', function() {
                startMeasureDistance();
            });
        }
        
        if (areaBtn) {
            areaBtn.addEventListener('click', function() {
                startMeasureArea();
            });
        }
    }

    // 绑定地图类型切换按钮事件
    function bindMapTypeEvent() {
        const mapTypeBtn = document.getElementById('mapTypeBtn');
        
        if (mapTypeBtn) {
            mapTypeBtn.addEventListener('click', function() {
                toggleMapType();
            });
        }
    }

    // 切换地图类型
    function toggleMapType() {
        if (!map) {
            alert('地图未初始化');
            return;
        }
        
        // 切换地图类型
        if (currentMapType === 'satellite') {
            // 切换到街道地图
            map.setMapType(TMAP_NORMAL_MAP);
            currentMapType = 'street';
            updateMapTypeButton('街道图');
        } else {
            // 切换到卫星地图
            map.setMapType(TMAP_SATELLITE_MAP);
            currentMapType = 'satellite';
            updateMapTypeButton('卫星图');
        }
    }

    // 更新地图类型按钮显示
    function updateMapTypeButton(typeName) {
        const mapTypeBtn = document.getElementById('mapTypeBtn');
        if (mapTypeBtn) {
            mapTypeBtn.innerHTML = `<span>${typeName}</span>`;
            mapTypeBtn.title = `当前：${typeName}，点击切换`;
        }
    }

    // 开始测距
    function startMeasureDistance() {
        if (!map) {
            alert('地图未初始化');
            return;
        }
        
        // 先移除所有可能存在的事件监听器
        try {
            map.removeEventListener('click', handleMapClick);
            map.removeEventListener('click', handleAreaMapClick);
            map.removeEventListener('mousemove', handleMouseMove);
            map.removeEventListener('mousemove', handleAreaMouseMove);
            map.removeEventListener('dblclick', finishMeasure);
            map.removeEventListener('dblclick', finishAreaMeasure);
        } catch(e) {
            console.log('移除事件监听器时出错:', e);
        }
        
        // 重置测量状态
        clearMeasureResult();
        
        // 设置测量状态为激活
        measureState.isActive = true;
        measureState.mode = 'distance'; // 设置为距离测量模式
        
        // 禁用其他按钮
        disableButtons(true);
        
        // 添加地图点击事件监听器
        map.addEventListener('click', handleMapClick);
        
        // 添加鼠标移动事件监听器
        map.addEventListener('mousemove', handleMouseMove);
        
        // 添加双击事件监听器结束测量
        map.addEventListener('dblclick', finishMeasure);
        
        console.log('测距功能已启动');
    }

    // 开始测面
    function startMeasureArea() {
        if (!map) {
            alert('地图未初始化');
            return;
        }
        
        // 先移除所有可能存在的事件监听器
        try {
            map.removeEventListener('click', handleMapClick);
            map.removeEventListener('click', handleAreaMapClick);
            map.removeEventListener('mousemove', handleMouseMove);
            map.removeEventListener('mousemove', handleAreaMouseMove);
            map.removeEventListener('dblclick', finishMeasure);
            map.removeEventListener('dblclick', finishAreaMeasure);
        } catch(e) {
            console.log('移除事件监听器时出错:', e);
        }
        
        // 重置测量状态
        clearMeasureResult();
        
        // 设置测量状态为激活
        measureState.isActive = true;
        measureState.mode = 'area'; // 设置为面积测量模式
        
        // 禁用其他按钮
        disableButtons(true);
        
        // 添加地图点击事件监听器
        map.addEventListener('click', handleAreaMapClick);
        
        // 添加鼠标移动事件监听器
        map.addEventListener('mousemove', handleAreaMouseMove);
        
        // 添加双击事件监听器结束测量
        map.addEventListener('dblclick', finishAreaMeasure);
        
        console.log('测面功能已启动');
    }

    // 处理地图点击事件
    function handleMapClick(event) {
        if (!measureState.isActive || measureState.mode !== 'distance') return;
        
        const point = event.lnglat;
        measureState.points.push(point);
        
        // 创建小圆点图标
        const smallDotIcon = new T.Icon({
            iconUrl: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8"><circle cx="4" cy="4" r="3" fill="%23FF0000" stroke="%23FFFFFF" stroke-width="1"/></svg>',
            iconSize: new T.Point(8, 8),
            iconAnchor: new T.Point(4, 4)
        });
        
        // 创建点标记
        const marker = new T.Marker(point, {icon: smallDotIcon});
        map.addOverLay(marker);
        measureState.markers.push(marker);
        
        // 如果不是第一个点，创建线段
        if (measureState.points.length > 1) {
            const prevPoint = measureState.points[measureState.points.length - 2];
            const line = new T.Polyline([prevPoint, point], {
                color: '#FF0000',
                weight: 3,
                opacity: 0.8
            });
            map.addOverLay(line);
            measureState.lines.push(line);
            
            // 计算距离并显示标签
            const distance = calculateDistance(prevPoint, point);
            showDistanceLabel(point, distance);
        }
        
        // 移除临时线
        if (measureState.tempLine) {
            map.removeOverLay(measureState.tempLine);
            measureState.tempLine = null;
        }
    }

    // 处理测面地图点击事件
    function handleAreaMapClick(event) {
        if (!measureState.isActive || measureState.mode !== 'area') return;
        
        const point = event.lnglat;
        measureState.points.push(point);
        
        // 创建小圆点图标（与测距功能一致）
        const smallDotIcon = new T.Icon({
            iconUrl: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8"><circle cx="4" cy="4" r="3" fill="%23FF0000" stroke="%23FFFFFF" stroke-width="1"/></svg>',
            iconSize: new T.Point(8, 8),
            iconAnchor: new T.Point(4, 4)
        });
        
        // 创建点标记
        const marker = new T.Marker(point, {icon: smallDotIcon});
        map.addOverLay(marker);
        measureState.markers.push(marker);
        
        // 移除之前的多边形
        if (measureState.polygon) {
            map.removeOverLay(measureState.polygon);
        }
        
        // 如果点数大于2，创建多边形
        if (measureState.points.length >= 3) {
            const polygon = new T.Polygon(measureState.points, {
                color: currentOutlineColor,
                weight: 3,
                opacity: 0.8,
                fillColor: currentFillColor,
                fillOpacity: currentFillOpacity
            });
            map.addOverLay(polygon);
            measureState.polygon = polygon;
            
            // 计算面积并显示标签
            const area = calculatePolygonArea(measureState.points);
            showAreaLabel(getPolygonCenter(measureState.points), area);
        }
        
        // 移除临时线
        if (measureState.tempLine) {
            map.removeOverLay(measureState.tempLine);
            measureState.tempLine = null;
        }
    }

    // 处理鼠标移动事件
    function handleMouseMove(event) {
        if (!measureState.isActive || measureState.mode !== 'distance' || measureState.points.length === 0) return;
        
        const lastPoint = measureState.points[measureState.points.length - 1];
        const currentPoint = event.lnglat;
        
        // 移除之前的临时线
        if (measureState.tempLine) {
            map.removeOverLay(measureState.tempLine);
        }
        
        // 创建新的临时线
        measureState.tempLine = new T.Polyline([lastPoint, currentPoint], {
            color: '#0000FF',
            weight: 2,
            opacity: 0.6,
            dashArray: [5, 5]
        });
        map.addOverLay(measureState.tempLine);
    }

    // 处理测面鼠标移动事件
    function handleAreaMouseMove(event) {
        if (!measureState.isActive || measureState.mode !== 'area' || measureState.points.length === 0) return;
        
        const firstPoint = measureState.points[0];
        const lastPoint = measureState.points[measureState.points.length - 1];
        const currentPoint = event.lnglat;
        
        // 移除之前的临时线
        if (measureState.tempLine) {
            map.removeOverLay(measureState.tempLine);
        }
        
        // 创建新的临时线（从最后一个点到当前点，再到第一个点形成闭合效果）
        const tempPoints = [lastPoint, currentPoint];
        if (measureState.points.length >= 2) {
            tempPoints.push(firstPoint);
        }
        
        measureState.tempLine = new T.Polyline(tempPoints, {
            color: '#0000FF',
            weight: 2,
            opacity: 0.6,
            dashArray: [5, 5]
        });
        map.addOverLay(measureState.tempLine);
    }

    // 结束测量
    function finishMeasure() {
        if (!measureState.isActive || measureState.mode !== 'distance') return;
        
        // 移除事件监听器
        map.removeEventListener('click', handleMapClick);
        map.removeEventListener('mousemove', handleMouseMove);
        map.removeEventListener('dblclick', finishMeasure);
        
        // 移除临时线
        if (measureState.tempLine) {
            map.removeOverLay(measureState.tempLine);
            measureState.tempLine = null;
        }
        
        // 显示总距离
        if (measureState.points.length > 1) {
            const totalDistance = calculateTotalDistance();
            showTotalDistanceLabel(totalDistance);
        }
        
        // 重置测量状态
        measureState.isActive = false;
        measureState.mode = '';
        
        // 恢复其他按钮
        disableButtons(false);
        
        console.log('测距功能已完成');
    }

    // 结束测面测量
    function finishAreaMeasure() {
        if (!measureState.isActive || measureState.mode !== 'area') return;
        
        // 移除事件监听器
        map.removeEventListener('click', handleAreaMapClick);
        map.removeEventListener('mousemove', handleAreaMouseMove);
        map.removeEventListener('dblclick', finishAreaMeasure);
        
        // 移除临时线
        if (measureState.tempLine) {
            map.removeOverLay(measureState.tempLine);
            measureState.tempLine = null;
        }
        
        // 如果点数大于等于3，创建最终多边形
        if (measureState.points.length >= 3) {
            // 移除之前的多边形
            if (measureState.polygon) {
                map.removeOverLay(measureState.polygon);
            }
            
            const polygon = new T.Polygon(measureState.points, {
                color: currentOutlineColor,
                weight: 3,
                opacity: 0.8,
                fillColor: currentFillColor,
                fillOpacity: currentFillOpacity
            });
            map.addOverLay(polygon);
            measureState.polygon = polygon;
            
            // 计算并显示总面积
            const area = calculatePolygonArea(measureState.points);
            showTotalAreaLabel(getPolygonCenter(measureState.points), area);
        } else {
            // 点数不足3个，移除所有标记
            clearMeasureResult();
        }
        
        // 重置测量状态
        measureState.isActive = false;
        measureState.mode = '';
        
        // 恢复其他按钮
        disableButtons(false);
        
        console.log('测面功能已完成');
    }

    // 计算两点间距离（米）
    function calculateDistance(point1, point2) {
        // 使用天地图提供的距离计算方法
        if (T.CRS && T.CRS.EPSG4326 && T.CRS.EPSG4326.distance) {
            return T.CRS.EPSG4326.distance(point1, point2);
        }
        
        // 如果没有提供，则使用球面距离公式
        const R = 6371000; // 地球半径（米）
        const dLat = (point2.lat - point1.lat) * Math.PI / 180;
        const dLon = (point2.lng - point1.lng) * Math.PI / 180;
        const a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(point1.lat * Math.PI / 180) * Math.cos(point2.lat * Math.PI / 180) * 
            Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    // 计算多边形面积（平方米）
    function calculatePolygonArea(points) {
        // 使用天地图提供的面积计算方法（如果可用）
        if (T.GeometryUtils && T.GeometryUtils.computeArea) {
            return T.GeometryUtils.computeArea(points);
        }
        
        // 如果没有提供，则使用球面多边形面积计算公式
        // 这里使用简单的平面近似计算，对于小面积比较准确
        if (points.length < 3) return 0;
        
        let area = 0;
        const n = points.length;
        
        for (let i = 0; i < n; i++) {
            const j = (i + 1) % n;
            area += points[i].lng * points[j].lat;
            area -= points[j].lng * points[i].lat;
        }
        
        area = Math.abs(area) / 2.0;
        
        // 转换为平方米（这是一个简化的近似值）
        // 更精确的计算需要考虑地球曲率
        const earthRadius = 6371000; // 地球半径（米）
        const degreeToMeter = (2 * Math.PI * earthRadius) / 360; // 每度对应的米数
        
        // 这个转换只是一个粗略的近似
        return area * degreeToMeter * degreeToMeter;
    }

    // 获取多边形中心点
    function getPolygonCenter(points) {
        if (points.length === 0) return null;
        
        let x = 0, y = 0;
        for (let i = 0; i < points.length; i++) {
            x += points[i].lng;
            y += points[i].lat;
        }
        
        return new T.LngLat(x / points.length, y / points.length);
    }

    // 计算总距离
    function calculateTotalDistance() {
        let total = 0;
        for (let i = 1; i < measureState.points.length; i++) {
            const distance = calculateDistance(measureState.points[i-1], measureState.points[i]);
            total += distance;
        }
        return total;
    }

    // 显示两点间距离标签
    function showDistanceLabel(point, distance) {
        const label = document.createElement('div');
        label.className = 'distance-label';
        label.innerHTML = distance.toFixed(2) + ' 米';
        label.style.position = 'absolute';
        label.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
        label.style.padding = '2px 6px';
        label.style.borderRadius = '3px';
        label.style.fontSize = '12px';
        label.style.boxShadow = '0 1px 2px rgba(0,0,0,0.3)';
        label.style.zIndex = '1000';
        label.style.transform = 'translate(-50%, -50%)';
        
        // 添加删除按钮
        const closeBtn = document.createElement('span');
        closeBtn.innerHTML = '×';
        closeBtn.style.marginLeft = '5px';
        closeBtn.style.cursor = 'pointer';
        closeBtn.style.fontWeight = 'bold';
        closeBtn.onclick = function() {
            if (label.parentNode) {
                label.parentNode.removeChild(label);
            }
        };
        label.appendChild(closeBtn);
        
        document.getElementById('mapContainer').appendChild(label);
        
        // 定位标签（向上偏移20像素）
        const pixel = map.lngLatToContainerPoint(point);
        label.style.left = pixel.x + 'px';
        label.style.top = (pixel.y - 20) + 'px';
        
        measureState.labels.push(label);
    }

    // 显示面积标签
    function showAreaLabel(point, area) {
        // 如果已存在面积标签，先移除它
        if (measureState.areaLabel) {
            if (measureState.areaLabel.parentNode) {
                measureState.areaLabel.parentNode.removeChild(measureState.areaLabel);
            }
        }
        
        const label = document.createElement('div');
        label.className = 'area-label';
        label.innerHTML = area.toFixed(2) + ' 平方米';
        label.style.position = 'absolute';
        label.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
        label.style.padding = '2px 6px';
        label.style.borderRadius = '3px';
        label.style.fontSize = '12px';
        label.style.boxShadow = '0 1px 2px rgba(0,0,0,0.3)';
        label.style.zIndex = '1000';
        label.style.transform = 'translate(-50%, -50%)';
        
        // 添加删除按钮
        const closeBtn = document.createElement('span');
        closeBtn.innerHTML = '×';
        closeBtn.style.marginLeft = '5px';
        closeBtn.style.cursor = 'pointer';
        closeBtn.style.fontWeight = 'bold';
        closeBtn.onclick = function() {
            if (label.parentNode) {
                label.parentNode.removeChild(label);
            }
        };
        label.appendChild(closeBtn);
        
        document.getElementById('mapContainer').appendChild(label);
        
        // 定位标签
        const pixel = map.lngLatToContainerPoint(point);
        label.style.left = pixel.x + 'px';
        label.style.top = (pixel.y - 20) + 'px';
        
        measureState.areaLabel = label;
        measureState.labels.push(label);
    }

    // 显示总面积标签
    function showTotalAreaLabel(point, area) {
        // 如果已存在面积标签，先移除它
        if (measureState.areaLabel) {
            if (measureState.areaLabel.parentNode) {
                measureState.areaLabel.parentNode.removeChild(measureState.areaLabel);
            }
        }
        
        // 计算亩数（1亩 ≈ 666.6667平方米）
        const areaInMu = area / 666.6667;
        
        const label = document.createElement('div');
        label.className = 'total-area-label';
        label.innerHTML = '总面积: ' + area.toFixed(2) + ' 平方米<br>' + areaInMu.toFixed(2) + ' 亩';
        label.style.position = 'absolute';
        label.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
        label.style.color = 'white';
        label.style.padding = '4px 8px';
        label.style.borderRadius = '4px';
        label.style.fontSize = '14px';
        label.style.fontWeight = 'bold';
        label.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
        label.style.zIndex = '1000';
        label.style.transform = 'translate(-50%, -50%)';
        label.style.lineHeight = '1.4';
        
        // 添加删除按钮
        const closeBtn = document.createElement('span');
        closeBtn.innerHTML = ' ×';
        closeBtn.style.cursor = 'pointer';
        closeBtn.style.fontWeight = 'bold';
        closeBtn.onclick = function() {
            if (label.parentNode) {
                label.parentNode.removeChild(label);
            }
        };
        label.appendChild(closeBtn);
        
        document.getElementById('mapContainer').appendChild(label);
        
        // 定位标签
        const pixel = map.lngLatToContainerPoint(point);
        label.style.left = pixel.x + 'px';
        label.style.top = (pixel.y - 40) + 'px';
        
        measureState.areaLabel = label;
        measureState.labels.push(label);
    }

    // 显示总距离标签
    function showTotalDistanceLabel(totalDistance) {
        const lastPoint = measureState.points[measureState.points.length - 1];
        const label = document.createElement('div');
        label.className = 'total-distance-label';
        label.innerHTML = '总距离: ' + totalDistance.toFixed(2) + ' 米';
        label.style.position = 'absolute';
        label.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
        label.style.color = 'white';
        label.style.padding = '4px 8px';
        label.style.borderRadius = '4px';
        label.style.fontSize = '14px';
        label.style.fontWeight = 'bold';
        label.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
        label.style.zIndex = '1000';
        label.style.transform = 'translate(-50%, -50%)';
        
        // 添加删除按钮
        const closeBtn = document.createElement('span');
        closeBtn.innerHTML = ' ×';
        closeBtn.style.cursor = 'pointer';
        closeBtn.style.fontWeight = 'bold';
        closeBtn.onclick = function() {
            if (label.parentNode) {
                label.parentNode.removeChild(label);
            }
        };
        label.appendChild(closeBtn);
        
        document.getElementById('mapContainer').appendChild(label);
        
        // 定位标签（向上偏移40像素，比段距离标签更高）
        const pixel = map.lngLatToContainerPoint(lastPoint);
        label.style.left = pixel.x + 'px';
        label.style.top = (pixel.y - 60) + 'px';  // 从-40改为-60，增加间距
        
        measureState.labels.push(label);
    }

    // 清除测量结果
    function clearMeasureResult() {
        // 移除所有线条
        measureState.lines.forEach(line => {
            if (map && map.removeOverLay) {
                try { map.removeOverLay(line); } catch(e) {}
            }
        });
        
        // 移除所有标记
        measureState.markers.forEach(marker => {
            if (map && map.removeOverLay) {
                try { map.removeOverLay(marker); } catch(e) {}
            }
        });
        
        // 移除所有标签
        measureState.labels.forEach(label => {
            if (label.parentNode) {
                try { label.parentNode.removeChild(label); } catch(e) {}
            }
        });
        
        // 移除临时线
        if (measureState.tempLine) {
            if (map && map.removeOverLay) {
                try { map.removeOverLay(measureState.tempLine); } catch(e) {}
            }
            measureState.tempLine = null;
        }
        
        // 移除多边形
        if (measureState.polygon) {
            if (map && map.removeOverLay) {
                try { map.removeOverLay(measureState.polygon); } catch(e) {}
            }
            measureState.polygon = null;
        }
        
        // 移除面积标签
        if (measureState.areaLabel) {
            if (measureState.areaLabel.parentNode) {
                try { measureState.areaLabel.parentNode.removeChild(measureState.areaLabel); } catch(e) {}
            }
            measureState.areaLabel = null;
        }
        
        // 重置状态
        measureState.points = [];
        measureState.lines = [];
        measureState.markers = [];
        measureState.labels = [];
        measureState.isActive = false;
        measureState.mode = '';
    }

    // 添加CSS样式用于距离标签
    const style = document.createElement('style');
    style.innerHTML = `
        .distance-label, .total-distance-label {
            font-family: Arial, sans-serif;
            pointer-events: auto;
        }
    `;
    document.head.appendChild(style);

    // 颜色选择器相关变量和函数
    let currentOutlineColor = "#FFD700"; // 默认边框颜色
    let currentFillColor = "#FFFF00";   // 默认填充颜色
    let currentFillOpacity = 0.35;       // 默认透明度
    
    // 轨迹颜色相关变量
    let currentTrackLineColor = "#FF0000"; // 默认轨迹线颜色
    let currentTrackPointColor = "#68EAF3"; // 默认轨迹点颜色

    // 初始化颜色选择器
    function initColorPickers() {
        // 边框颜色选择器
        const outlineColorPicker = document.getElementById('outlineColorPicker');
        const outlineColorInput = document.getElementById('outlineColorInput');
        
        outlineColorPicker.addEventListener('click', function() {
            outlineColorInput.click();
        });
        
        outlineColorInput.addEventListener('change', function() {
            currentOutlineColor = this.value;
            outlineColorPicker.style.backgroundColor = currentOutlineColor;
        });
        
        // 填充颜色选择器
        const fillColorPicker = document.getElementById('fillColorPicker');
        const fillColorInput = document.getElementById('fillColorInput');
        
        fillColorPicker.addEventListener('click', function() {
            fillColorInput.click();
        });
        
        fillColorInput.addEventListener('change', function() {
            currentFillColor = this.value;
            fillColorPicker.style.backgroundColor = currentFillColor;
        });
        
        // 透明度滑块
        const fillOpacitySlider = document.getElementById('fillOpacitySlider');
        const fillOpacityValue = document.getElementById('fillOpacityValue');
        
        fillOpacitySlider.addEventListener('input', function() {
            currentFillOpacity = this.value / 100;
            fillOpacityValue.textContent = this.value + '%';
        });
        
        // 轨迹线颜色选择器
        const trackLineColorPicker = document.getElementById('trackLineColorPicker');
        const trackLineColorInput = document.getElementById('trackLineColorInput');
        
        if (trackLineColorPicker && trackLineColorInput) {
            trackLineColorPicker.addEventListener('click', function() {
                trackLineColorInput.click();
            });
            
            trackLineColorInput.addEventListener('change', function() {
                currentTrackLineColor = this.value;
                trackLineColorPicker.style.backgroundColor = currentTrackLineColor;
            });
        }
        
        // 轨迹点颜色选择器
        const trackPointColorPicker = document.getElementById('trackPointColorPicker');
        const trackPointColorInput = document.getElementById('trackPointColorInput');
        
        if (trackPointColorPicker && trackPointColorInput) {
            // 设置初始背景色
            trackPointColorPicker.style.backgroundColor = currentTrackPointColor;
            
            trackPointColorPicker.addEventListener('click', function() {
                trackPointColorInput.click();
            });
            
            trackPointColorInput.addEventListener('change', function() {
                currentTrackPointColor = this.value;
                trackPointColorPicker.style.backgroundColor = currentTrackPointColor;
            });
        }
    }

</script>
</body>

</html>
