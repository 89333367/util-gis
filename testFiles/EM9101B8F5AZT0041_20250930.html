<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>展示轮廓</title>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #mapContainer {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        #mapLoading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
            transition: opacity 0.3s;
        }

        .loading-text {
            font-size: 16px;
            color: #333;
            padding: 10px 20px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .wkt-input-container {
            position: absolute;
            top: 20px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            width: min(320px, 90vw);
            box-sizing: border-box;
            transition: all 0.3s;
        }

        .minimize-btn {
            position: absolute;
            top: -5px;
            right: -4px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #f0f0f0;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #666;
            z-index: 1001;
            transition: background 0.2s;
        }

        .minimize-btn:hover {
            background: #e0e0e0;
        }

        .content-wrapper {
            transition: all 0.3s;
        }

        .wkt-input-container.minimized {
            width: 40px;
            height: 40px;
            padding: 0;
        }

        .wkt-input-container.minimized .content-wrapper {
            display: none;
        }

        .wkt-input-container.minimized .min-icon {
            display: none;
        }

        .wkt-input-container.minimized .restore-icon {
            display: inline;
        }

        #wktTextarea {
            width: 100%;
            height: 120px;
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
            box-sizing: border-box;
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        /* 页签样式 */
        .tabs-header {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .tab-btn {
            flex: 1;
            padding: 6px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            background: #f5f5f5;
            color: #333;
            transition: background 0.2s;
        }
        .tab-btn.active { background: #337AFF; color: #fff; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        /* Multi → Polygons 分割器样式 */
        .split-section {
            margin-top: 10px;
            padding: 10px;
            background: #fafafa;
            border: 1px solid #eee;
            border-radius: 6px;
        }
        .split-section .title {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
        }
        .split-section .desc {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        #multiInput, #polyOutput {
            width: 100%;
            height: 90px;
            margin-bottom: 8px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
            box-sizing: border-box;
        }
        .split-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .split-actions button {
            flex: 1;
            padding: 6px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }
        #splitMultiBtn { background: #337AFF; color: #fff; }
        #splitMultiBtn:hover { background: #2860E0; }
        #copyPolysBtn { background: #f5f5f5; color: #333; }
        #copyPolysBtn:hover { background: #e0e0e0; }
        #drawButton,
        #clearButton,
        #drawTrackButton,
        #clearTrackButton {
            width: 50%;
            padding: 8px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        #drawButton,
        #drawTrackButton {
            background: #337AFF;
            color: white;
        }

        #drawButton:hover,
        #drawTrackButton:hover {
            background: #2860E0;
        }

        #clearButton,
        #clearTrackButton {
            background: #f5f5f5;
            color: #333;
        }

        #clearButton:hover,
        #clearTrackButton:hover {
            background: #e0e0e0;
        }

        #drawButton:disabled,
        #clearButton:disabled,
        #drawTrackButton:disabled,
        #clearTrackButton:disabled {
            background: #e0e0e0;
            color: #999;
            cursor: not-allowed;
        }

        .tip {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .area-label {
             position: absolute;
             background: rgba(255, 0, 0, 0.85);
             border: 1px solid #000;
             border-radius: 3px;
             padding: 4px 6px;
             font-size: 12px;
             color: #fff;
             font-weight: 600;
             box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
             white-space: nowrap;
             z-index: 9999;
             pointer-events: none;
         }
         /* 默认隐藏标签容器下的标签 */
          .labels-hidden .area-label { display: none; }

          /* Batch → Generator 样式 */
          .batch-section { margin-top: 10px; padding: 10px; background: #fafafa; border: 1px solid #eee; border-radius: 6px; }
          .batch-section .title { font-size: 13px; font-weight: 600; color: #333; margin-bottom: 6px; }
          .batch-section .desc { font-size: 12px; color: #666; margin-bottom: 8px; }
          #batchInput, #multiOutput { width: 100%; height: 90px; margin-bottom: 8px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; resize: vertical; box-sizing: border-box; }
          .batch-actions { display: flex; gap: 8px; margin-bottom: 8px; }
          .batch-actions button { flex: 1; padding: 6px 0; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; transition: background 0.2s; }
          #generateMultiBtn { background: #337AFF; color: #fff; }
          #generateMultiBtn:hover { background: #2860E0; }
          #copyMultiBtn { background: #f5f5f5; color: #333; }
          #copyMultiBtn:hover { background: #e0e0e0; }
          
          /* 左侧工具条样式 */
          #leftToolbar {
              position: absolute;
              bottom: 20px;
              left: 20px;
              z-index: 1000;
              background: white;
              border-radius: 4px;
              box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
              padding: 6px 0;
              display: flex;
              flex-direction: column;
              gap: 2px;
              width: 40px;
          }
          
          .toolbar-btn {
              width: 100%;
              padding: 6px 0;
              border: none;
              background: transparent;
              cursor: pointer;
              font-size: 12px;
              color: #333;
              transition: background 0.2s;
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
          }
          
          .toolbar-btn:hover {
              background: #f5f5f5;
          }
          
          .toolbar-btn span {
              font-size: 12px;
              margin-top: 4px;
          }
          
          .toolbar-divider {
            height: 1px;
            background-color: #e0e0e0;
            margin: 2px 4px;
        }
        
        /* 颜色选择器样式 */
        .color-picker-container {
            margin-top: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }
        
        .color-picker-title {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        
        .color-picker-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .color-picker-label {
            font-size: 12px;
            color: #555;
            width: 60px;
            flex-shrink: 0;
        }
        
        .color-picker {
            width: 30px;
            height: 30px;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 8px;
            flex-shrink: 0;
        }
        
        .color-input {
            flex: 1;
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            font-family: monospace;
        }
        
        .opacity-slider-container {
            display: flex;
            align-items: center;
            margin-top: 8px;
        }
        
        .opacity-slider {
            flex: 1;
            margin-right: 8px;
        }
        
        .opacity-value {
            font-size: 12px;
            color: #555;
            width: 40px;
            text-align: right;
        }
      </style>
    <script src="https://api.tianditu.gov.cn/api?v=4.0&tk=648f621977051d0199ff0f965d3fd322"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
    <script src="https://lib.baomitu.com/terraformer/1.0.12/terraformer.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://unpkg.com/terraformer-wkt-parser@1.2.1/terraformer-wkt-parser.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- 已移除动态备用加载器 ensureTerraformer：改为仅使用静态脚本标签加载 Terraformer 核心库与 WKT 解析器 -->
    <script>
        // 检查Turf.js是否加载成功
        window.addEventListener('load', function () {
            if (typeof turf === 'undefined') {
                console.warn('Turf.js加载失败，已启用备用面积算法');
            } else {
                console.log('Turf.js加载成功');
            }
        });
    </script>
</head>

<body>
<!-- 左侧工具条 -->
<div id="leftToolbar">
    <button class="toolbar-btn" id="measureDistanceBtn" title="测距">
        <span>测距</span>
    </button>
    <div class="toolbar-divider"></div>
    <button class="toolbar-btn" id="measureAreaBtn" title="测面">
        <span>测面</span>
    </button>
    <div class="toolbar-divider"></div>
    <button class="toolbar-btn" id="mapTypeBtn" title="切换地图类型">
        <span>地图</span>
    </button>
</div>

<div id="mapContainer">
    <div id="mapLoading">
        <div class="loading-text">地图正在加载中...</div>
    </div>
</div>

<div class="wkt-input-container">
    <div class="minimize-btn" id="minimizeBtn">
        <span class="min-icon">−</span>
        <span class="restore-icon" style="display:none;">+</span>
    </div>

    <div class="content-wrapper">
        <div class="tabs-header">
            <button class="tab-btn active" id="tabDrawBtn">轮廓</button>
            <button class="tab-btn" id="tabTrackBtn">轨迹</button>
            <button class="tab-btn" id="tabSplitBtn">分割器</button>
            <button class="tab-btn" id="tabBatchBtn">合并器</button>
        </div>
        <div class="tab-pane active" id="tabDraw">
            <div class="tip">请输入WKT字符串（支持POLYGON/MULTIPOLYGON）：</div>
            <textarea id="wktTextarea">POLYGON ((124.4985291442067 45.34561743300428, 124.49852765678393 45.3456199409001, 124.49852724765015 45.34562095992877, 124.4985272163107 45.34562101193105, 124.49843021763114 45.345738344468906, 124.49842913534717 45.34573992963522, 124.49842912628043 45.3457399461387, 124.49842840537379 45.34574164896512, 124.49840040620447 45.34583365193941, 124.4984000548161 45.34583594946777, 124.49840005470188 45.34583597274658, 124.4984003835422 45.34583827193253, 124.49840039024635 45.34583829472774, 124.49840138514587 45.34584049650563, 124.49840139837907 45.34584051783321, 124.49840301647046 45.345842527334554, 124.49840303561497 45.345842546229015, 124.49840523038955 45.34584429355203, 124.49847322754887 45.34588829087381, 124.49847507127647 45.345889316693345, 124.49847509086571 45.34588932601367, 124.49847715102645 45.34589015537452, 124.49860215412254 45.34593215536708, 124.49860487049571 45.34593286076954, 124.49860489868564 45.34593286607988, 124.49860775204219 45.34593320988472, 124.49860778106068 45.345933211472286, 124.49861070469005 45.34593318088698, 124.49891428855796 45.34591036249413, 124.49891433550594 45.34591036141829, 124.49891438216883 45.34591036521664, 124.4989594694205 45.34591643465472, 124.49895954080101 45.3459164505713, 124.49895960495358 45.345916477782716, 124.49896150333701 45.345917514948894, 124.49896152974361 45.34591752664908, 124.49896427088618 45.345918491123825, 124.49896432752764 45.34591851663363, 124.49896437533094 45.34591854994681, 124.49896441217349 45.3459185895841, 124.49896443641924 45.345918633785494, 124.49896444699161 45.34591868058824, 124.49896444342122 45.34591872791412, 124.49896408460295 45.34592030880054, 124.49896408271641 45.34592033075072, 124.49896419918598 45.34592251157485, 124.49896420340865 45.34592253336406, 124.49896492098564 45.34592465626091, 124.49896493115509 45.34592467705003, 124.49896622226326 45.34592666043867, 124.49896623798902 45.34592667942948, 124.49896805301198 45.34592844708905, 124.49896807368918 45.345928463551296, 124.49897034287689 45.345929947551845, 124.49897036771141 45.34592996085324, 124.49897300385962 45.345931104165075, 124.4989730318971 45.34593111379447, 124.49897593370069 45.34593187248091, 124.49897596386322 45.34593187806813, 124.49897901980697 45.34593222297324, 124.49897905093621 45.34593222430361, 124.49898214358176 45.34593214217292, 124.49898217448111 45.34593213919525, 124.49898518498001 45.345931633185025, 124.49898521438809 45.34593162603169, 124.49898805482309 45.34593070541737, 124.49910705862797 45.345881701363986, 124.49911051009457 45.3458797832847, 124.49929050477708 45.34574778552265, 124.49929246252086 45.345746025653455, 124.49929247957802 45.34574600666131, 124.4992939118227 45.34574398563222, 124.49935346746518 45.34563351947631, 124.4993534934606 45.345633482100574, 124.49935352877894 45.3456334487435, 124.49935357221047 45.34563342054792, 124.4993536222672 45.3456333984798, 124.49935367723403 45.34563338329524, 124.4993537352279 45.345633375514424, 124.49935379426181 45.34563337540396, 124.49942958156088 45.34563819967335, 124.49943265802601 45.3456381832982, 124.4994326888577 45.34563818100381, 124.49943570239837 45.34563774418107, 124.49943573201344 45.345637737713496, 124.49943856818776 45.345636897032364, 124.4994385954617 45.34563688663724, 124.49944114656032 45.34563567402417, 124.49944117045703 45.34563566009638, 124.49944333959698 45.34563412160276, 124.49944335920934 45.34563410467111, 124.49944506401295 45.345632298724475, 124.49944507859603 45.34563227943192, 124.49944625432022 45.34563027461659, 124.49944626332012 45.34563025369599, 124.49944686531458 45.34562812614813, 124.49944686838943 45.3456281043948, 124.49944687379215 45.345625934912675, 124.49944687082554 45.34562591315154, 124.49944627943131 45.345623784126396, 124.4994462705353 45.34562376318294, 124.49944510480411 45.34562175546863, 124.49944509031714 45.345621736139925, 124.49944339451916 45.345619925982135, 124.49944337499122 45.34561990900192, 124.49944121352851 45.345618365145796, 124.49944118970069 45.345618351158514, 124.49943864465871 45.34561713223458, 124.49943861743684 45.34561712177201, 124.49943578546818 45.345616274071354, 124.49943575595942 45.345616267546795, 124.49943271388813 45.3456158198119, 124.49942474123444 45.34561520653799, 124.49942467907834 45.34561519726839, 124.49942462076083 45.34561517949534, 124.49942456859586 45.345615153924044, 124.49942452465308 45.34561512156911, 124.49942449067623 45.34561508371435, 124.49942446801339 45.34561504186174, 124.49942445756379 45.345614997671944, 124.49942445974197 45.345614952898316, 124.49942447446165 45.34561490931741, 124.49942450113863 45.34561486865842, 124.49942453871456 45.34561483253464, 124.4994245856984 45.345614802379366, 124.49942464022593 45.34561477938914, 124.49942470013355 45.34561476447617, 124.49942476304437 45.34561475823215, 124.49947865428709 45.34561323470476, 124.49948180613056 45.34561291914838, 124.49948183727066 45.345612913727365, 124.49948483525316 45.34561215869162, 124.49948486421746 45.34561214897553, 124.49948758644008 45.345610985161144, 124.49948761205108 45.34561097154502, 124.4994899478222 45.345609446275084, 124.49948996903845 45.34560942931275, 124.4994918233802 45.34560760460832, 124.49949183933985 45.34560758498879, 124.49949313685136 45.345605535045806, 124.49949314690424 45.34560551356822, 124.49949383482608 45.34560332174105, 124.4994938385642 45.34560329927828, 124.49949388892368 45.3456010546923, 124.49949388619497 45.34560103215614, 124.49949329694468 45.34559882608117, 124.49949328785995 45.3455988043895, 124.49949208296029 45.34559672652853, 124.4994920678886 45.34559670656248, 124.49949029633342 45.34559484140583, 124.4994902758882 45.345594823978274, 124.49948800971222 45.34559324736654, 124.49948798472418 45.345593233185554, 124.49948531607538 45.34559200922744, 124.49948528756126 45.34559199886999, 124.49948232495194 45.34559117733397, 124.49948229414805 45.34559117123631, 124.49947912608879 45.345590782749454, 124.49940058040187 45.3455868057526, 124.49940056326844 45.34558680455654, 124.49936632985649 45.34558375478485, 124.49936626795461 45.34558374477593, 124.49936621009209 45.34558372631665, 124.49936615856342 45.345583700138924, 124.4993661154114 45.34558366728068, 124.49936608234728 45.34558362904476, 124.49936606068194 45.345583586947214, 124.49936605127436 45.34558354265722, 124.49936605449768 45.345583497930875, 124.49936687710137 45.345579672818765, 124.49936689136064 45.34557963232532, 124.49936691598145 45.345579594386, 124.49936695011648 45.34557956030649, 124.49936699259106 45.345579531259645, 124.49936704194337 45.34557950824513, 124.49936709647501 45.34557949205504, 124.49936715430906 45.3455794832465, 124.49936969029292 45.345579267925956, 124.49936973814192 45.34557926641771, 124.49943705259592 45.34558071404705, 124.4994370788664 45.345580715379256, 124.49948896511866 45.345584870957936, 124.49948898593186 45.34558487311725, 124.49950616848825 45.345587066238416, 124.49950802792486 45.34558722440451, 124.49953103402248 45.3455882236209, 124.49953407640524 45.34558814853024, 124.49953410681898 45.345588145692496, 124.49953707219058 45.345587660230564, 124.49953710126641 45.345587653329254, 124.49953987937451 45.34558677554689, 124.49953990603106 45.34558676483878, 124.49954239357598 45.34558552737489, 124.49954241682269 45.345585513257845, 124.49954452130866 45.34558396212588, 124.49954454028085 45.34558394512507, 124.49954618345589 45.34558213800134, 124.49954619744828 45.34558211874859, 124.49954731821397 45.34558012282811, 124.49954732670604 45.345580102039335, 124.49954788338839 45.34557799153713, 124.49954788606422 45.34557796998621, 124.49954785796403 45.34557582337799, 124.49954785472433 45.34557580186516, 124.49954724288648 45.34557369896978, 124.49954723385142 45.34557367829463, 124.49954606102627 45.34557169730485, 124.49954604653198 45.34557167823703, 124.499544356329 45.34556989281173, 124.499544336915 45.34556987606083, 124.49954219218178 45.345568352588856, 124.49954216856892 45.34556833877658, 124.49953964905427 45.3455671339059, 124.49953962212156 45.345567123546495, 124.49953682150874 45.34556628207804, 124.4995367923304 45.34556627557274, 124.49953378437318 45.34556582529711, 124.49949363148716 45.345562609462526, 124.4994936106736 45.34556260730315, 124.49946482904893 45.34555893368109, 124.49946247430641 45.34555875965515, 124.49943936857667 45.34555826276476, 124.49943934230619 45.34555826143256, 124.49939795654943 45.34555494682227, 124.49939789347401 45.34555493713399, 124.49939783445707 45.34555491868774, 124.49939778191636 45.34555489223916, 124.49939773800446 45.34555485887179, 124.49939770452023 45.345554819952596, 124.49939768283535 45.34555477707599, 124.49939767383837 45.34555473199848, 124.4993976778977 45.345554686566786, 124.49939769484706 45.34555464264211, 124.49939772399223 45.34555460202391, 124.49939776413899 45.34555456637618, 124.49939781364283 45.34555453715934, 124.4993978704757 45.34555451557029, 124.49939793230915 45.34555450249348, 124.49939799661028 45.345554498464644, 124.49948081239185 45.34555524339022, 124.49948399187807 45.345555044462465, 124.49948402346104 45.34555504018478, 124.49948708120995 45.34555439432374, 124.49948711092688 45.34555438565361, 124.49948992194032 45.34555331926196, 124.49948994857652 45.34555330655382, 124.49949239793875 45.345551863226106, 124.49949242040556 45.34555184699944, 124.49949440798613 45.345550085739454, 124.49949442536524 45.345550066657324, 124.49949586991154 45.34554805946546, 124.49949588149168 45.345548038309055, 124.49949672395023 45.34554586723991, 124.49949672925882 45.34554584487281, 124.4994969351895 45.34554359868094, 124.49949693400933 45.34554357601804, 124.49949649499375 45.34554134652797, 124.49949648737305 45.345541324495876, 124.49949542135855 45.34553920284958, 124.49949540760875 45.34553918234878, 124.4994937581745 45.3455372552805, 124.49949373885713 45.34553723714845, 124.49949157343268 45.34553558343688, 124.49949154933836 45.345535568415855, 124.49948895644619 45.34553425566481, 124.4994889285593 45.345534244368416, 124.49948601419825 45.34553332624378, 124.49948598373538 45.34553331915173, 124.49948283521258 45.34553282939152, 124.49937504696663 45.34552394586912, 124.49937498278977 45.345523935767304, 124.49937492291465 45.3455239165995, 124.49937486988627 45.345523889180434, 124.4993748259589 45.34552385467561, 124.49937479299952 45.34552381455172, 124.49937477240934 45.345523770514305, 124.49937362629716 45.345520073387505, 124.4993736189507 45.345520027267135, 124.49937362518484 45.34551998106541, 124.49937364473423 45.34551993674968, 124.49937367676634 45.34551989620703, 124.49937371991713 45.34551986116384, 124.49937377234919 45.34551983311233, 124.49937383182984 45.34551981324699, 124.49937389582627 45.34551980241372, 124.49937396161336 45.345519801073834, 124.49951482871205 45.34552721386955, 124.49951790971265 45.345527163312745, 124.49951794054138 45.34552716066875, 124.49952094890665 45.34552668897781, 124.49952097841954 45.345526682160646, 124.49952379950915 45.34552580731065, 124.49952382658182 45.34552579657998, 124.49952635289038 45.345524551909506, 124.49952637649068 45.34552453767446, 124.49952851174703 45.34552297061475, 124.49952853097547 45.3455229534179, 124.49953019380963 45.34552112368613, 124.49953020793397 45.34552110418253, 124.49953133497921 45.34551908150528, 124.49953134346072 45.34551906043891, 124.49953189176783 45.34551692189589, 124.49953189428382 45.34551690006889, 124.4995318429582 45.34551472715524, 124.49953183941253 45.345514705398685, 124.49953119041032 45.34551258091969, 124.4995311809383 45.34551256006363, 124.4995299589913 45.34551056497724, 124.49952994395343 45.34551054581591, 124.4995281956278 45.34550875615103, 124.49952817559743 45.34550873941492, 124.49952596751669 45.34550722337043, 124.49952594325788 45.34550720969794, 124.4995233595679 45.34550602504751, 124.49952333200365 45.34550601495865, 124.49952047116251 45.34550520684641, 124.49952044141858 45.34550520074143, 124.49951738157185 45.34550479695927, 124.49938873775824 45.345496819048186, 124.49936598447115 45.34549472540224, 124.4993659211657 45.34549471485951, 124.49936586221021 45.345494695479076, 124.49936581005664 45.345494668067026, 124.49936576687453 45.345494633763586, 124.49936573445991 45.345494593995575, 124.49936571416109 45.34549455041715, 124.49936571087305 45.345494539810545, 124.49936570353174 45.34549449405925, 124.49936570955676 45.34549444821245, 124.49936572869566 45.34549440419161, 124.49936576014636 45.345494363841716, 124.49936580259063 45.345494328853846, 124.49936585424958 45.34549430069441, 124.49936591295824 45.34549428054358, 124.49936597625599 45.345494269245904, 124.49936604149 45.34549426727486, 124.49953106352606 45.34550122486243, 124.49953410759365 45.345501145618194, 124.49953413801822 45.34550114273634, 124.49953710383716 45.34550065271388, 124.4995371329101 45.345500645765384, 124.49953991006403 45.34549976320826, 124.49953993670401 45.345499752451545, 124.49954242179872 45.3454985102176, 124.49954244501308 45.34549849605346, 124.49954454552939 45.34549694039064, 124.49954456445373 45.34549692334652, 124.49954620218837 45.345495112172856, 124.49954621611872 45.345495092882956, 124.49954733009909 45.34549309362831, 124.4995473385166 45.34549307281074, 124.49954788726907 45.34549095990786, 124.49954788986025 45.345490938337385, 124.499547852955 45.3454887904498, 124.4995478496234 45.345488768930316, 124.49954722843432 45.34548666602321, 124.4995472193043 45.345486645356075, 124.49954603695818 45.34548466572123, 124.49954602236893 45.34548464667467, 124.49954432288521 45.34548286401453, 124.49954430338053 45.34548284729852, 124.4995421500307 45.34548132798111, 124.49954212633655 45.345481314217764, 124.49953959929007 45.34548011480746, 124.49953957228837 45.3454801045091, 124.49953676562725 45.34547926966006, 124.49953673639686 45.34547926322635, 124.49953372419253 45.3454788206002, 124.4993568166499 45.34546513145209, 124.49935675201746 45.345465121587374, 124.4993566916593 45.34546510253568, 124.49935663816997 45.34546507511606, 124.49935659384917 45.34546504050728, 124.49935656060218 45.34546500019717, 124.49935653985844 45.34546495591867, 124.4993551027175 45.34546031998106, 124.49935509548894 45.345460278357045, 124.49935509934407 45.34546023651028, 124.49935511414883 45.34546019589562, 124.49935513938834 45.345460157925004, 124.49935517418534 45.345460123918556, 124.49935521732993 45.34546009505853, 124.49935526732239 45.34546007234821, 124.49935532242444 45.345460056577174, 124.49935538072054 45.34546004829372, 124.49935544018406 45.345460047785785, 124.49946272107907 45.3454662080265, 124.49946579463003 45.34546617280909, 124.4994658254066 45.34546617032952, 124.49946883101335 45.34546571576828, 124.49946886052496 45.34546570913001, 124.49947168423729 45.34546485245876, 124.49947171136552 45.34546484191334, 124.49947424612768 45.345463615611315, 124.49947426984356 45.34546360155873, 124.49947641955526 45.34546205211845, 124.49947643895922 45.345462035091906, 124.49947812211747 45.34546022125795, 124.49947813647485 45.34546020190197, 124.49947928926538 45.34545819244331, 124.4994792980317 45.34545817149171, 124.49947987674943 45.345456042592375, 124.49947987959175 45.34545602084019, 124.49947986229569 45.345453853213584, 124.49947985910654 45.34545383148582, 124.4994792464521 45.34545170731284, 124.49947923735246 45.34545168643309, 124.49947805256791 45.345449686249495, 124.49947803790188 45.345449667007735, 124.49947632590623 45.345447866646005, 124.49947630623096 45.345447849773734, 124.49947413193065 45.34544631749055, 124.49947410799216 45.34544630362707, 124.49947155382206 45.34544509751668, 124.49947152652746 45.345445087187244, 124.49946868932437 45.34544425297704, 124.49946865978222 45.34544424658929, 124.49946561638374 45.34544381259314, 124.49939306555783 45.34543854987789, 124.499393005496 45.345438541349495, 124.49939294885472 45.34543852488001, 124.49939289772439 45.34543850107714, 124.49939285399171 45.345438470819275, 124.49939281927035 45.345438435222995, 124.4993927948418 45.34543839560181, 124.49939278160737 45.34543835341784, 124.49939278005539 45.345438310227735, 124.49939279024325 45.345438267625255, 124.49939281179498 45.345438227182505, 124.49939284391526 45.34543819039187, 124.49939288541874 45.34543815861101, 124.49939293477398 45.34543813301268, 124.49939299015962 45.34543811454147, 124.4993930495319 45.345438103879026, 124.49939311069993 45.34543810141878, 124.49950638985396 45.345441236043065, 124.49950942129246 45.34544111388713, 124.49950945153292 45.345441110590066, 124.49951239373672 45.34544058145266, 124.49951242252311 45.34544057413405, 124.49951516665588 45.34543965758901, 124.49951519292294 45.34543964651966, 124.49951763747396 45.345438376471826, 124.49951766025019 45.3454383620611, 124.49951971479055 45.34543678549216, 124.499519733233 45.3454367682734, 124.49952132176158 45.34543494350341, 124.49952133518826 45.34543492411356, 124.49952239894195 45.34543291864472, 124.49952240685643 45.3454328978006, 124.49952290648453 45.34543078581982, 124.49952290859382 45.34543076429256, 124.49952282561468 45.345428623925315, 124.49952282184076 45.34542860251195, 124.49952215932372 45.345426512934765, 124.49952214980615 45.345426492426796, 124.49952093225936 45.34542453093798, 124.49952091735007 45.345424512093885, 124.49951918981328 45.34542275125266, 124.4995191700635 45.345422734769535, 124.49951699644156 45.34542123971259, 124.4995169725826 45.345421226200806, 124.49951443328132 45.3454200522329, 124.49951440619638 45.34542004219225, 124.4995115951502 45.345419232741236, 124.49951156591274 45.345419226558086, 124.49950855673441 45.34541880838769, 124.4995070434464 45.34541870268189, 124.49950697905581 45.345418693385035, 124.49950691873502 45.34541867497812, 124.49950686504555 45.34541864824288, 124.49950682026773 45.34541861431468, 124.49950678630309 45.34541857463444, 124.49950676459393 45.345418530887265, 124.49950675606249 45.345418484931045, 124.49950676107083 45.345418438717466, 124.49950688983608 45.34541793829415, 124.49950689237585 45.345417916655194, 124.49950684856319 45.345415762347564, 124.49950684514447 45.34541574076929, 124.49950621367948 45.345413632757555, 124.49950620443059 45.345413612048, 124.49950500896432 45.345411629287746, 124.4995049942322 45.3454116102231, 124.49950327954143 45.3454098269796, 124.49950325987722 45.34540981027279, 124.49950109018629 45.345408293338025, 124.4995010663265 45.3454082796151, 124.49949852290163 45.34540708580599, 124.49949849574003 45.34540707558102, 124.49949567384567 45.345406249611855, 124.49949564447246 45.34540624328349, 124.49949261925997 45.34540581280015, 124.49920362338506 45.34538481366627, 124.49920136681656 45.34538476354738, 124.49909236284897 45.34538776469875, 124.4990893548889 45.34538805345886, 124.49908932511248 45.345388058410656, 124.49908645114068 45.3453887478141, 124.49908642332872 45.34538875667103, 124.49908376374304 45.34538983287134, 124.4990597625724 45.34540183527044, 124.49905706984146 45.34540354019009, 124.49905704575998 45.34540355938513, 124.49905495513516 45.34540567388556, 124.49904215302821 45.345422415097026, 124.49904212315906 45.345422447239564, 124.49904154298436 45.34542296830824, 124.49904152594388 45.34542298725514, 124.4990400941527 45.34542500342133, 124.49902465565339 45.345453550102974, 124.49902462749533 45.345453589851694, 124.49902458880534 45.34545362492114, 124.49902454109349 45.34545365394254, 124.49902448622181 45.345453675783226, 124.49902442633203 45.345453689590755, 124.49902436376169 45.34545369482623, 124.49902430095281 45.34545369128531, 124.49902424035677 45.34545367910619, 124.49902418433865 45.34545365876422, 124.49902413508475 45.34545363105334, 124.49902409451751 45.3454535970551, 124.4990240642203 45.34545355809643, 124.49902404537545 45.34545351569786, 124.49902403871863 45.34545347151423, 124.4990240445095 45.34545342726999, 124.4990386584028 45.34540012382867, 124.49903894532473 45.3453979608778, 124.4990389451864 45.34539793898658, 124.49903863096088 45.345395777925354, 124.49903862479634 45.34539575646985, 124.49903772138885 45.345393679587296, 124.49903770943233 45.34539365938388, 124.49903625124404 45.34539174576486, 124.49903623395147 45.34539172758392, 124.49903427650759 45.34539005009607, 124.49903425453789 45.34539003462999, 124.49903187237567 45.345388657150394, 124.4990318465647 45.345388644987445, 124.49902913039472 45.345387619969244, 124.49902910172501 45.34538761157255, 124.4990261549756 45.34538697804707, 124.49902612453924 45.3453869737365, 124.49902305941907 45.34538675582756, 124.49902302837498 45.3453867557673, 124.49901996159967 45.34538696177257, 124.49901993113014 45.345386965964906, 124.499016979479 45.34538758803997, 124.49901695074402 45.34538759632532, 124.49901422661267 45.34538861078223, 124.49901420070653 45.34538862284507, 124.49901180782608 45.345389991054645, 124.49901178573533 45.34539000643567, 124.49900981522411 45.34539167629795, 124.49900979778974 45.345391694411624, 124.49900832468218 45.34539360234061, 124.49900831259879 45.34539362244637, 124.49900738513814 45.34539571705061, 124.49898942923463 45.3454564908497, 124.49898940486872 45.34545654180298, 124.49898936404745 45.34545658722138, 124.4989800323969 45.34546464637328, 124.4989799898031 45.345464676745245, 124.49897993983421 45.345464700890616, 124.49897988429286 45.34546471793843, 124.49897982518245 45.345464727273715, 124.49897976463524 45.345464728559776, 124.4989797048352 45.3454647217502, 124.49897964793949 45.34546470709062, 124.49897959600034 45.34546468510984, 124.49897955089146 45.34546465660073, 124.49895171173593 45.34544336939664, 124.49894942338123 45.34544192937918, 124.49894939843047 45.34544191651569, 124.49894675841749 45.345440815689024, 124.49894673041096 45.34544080647045, 124.49894383837469 45.345440086379334, 124.49894380836912 45.345440081153434, 124.49894077346272 45.34543976897606, 124.49894074259038 45.34543976793996, 124.4989376793584 45.34543987545864, 124.49893764878466 45.34543987865148, 124.49893467284076 45.34544040180821, 124.49893464371948 45.345440409109464, 124.49893186738285 45.345441328159055, 124.4989318408132 45.345441339293146, 124.49892936886918 45.34544261954863, 124.49892934585407 45.34544263409525, 124.49892727160085 45.34544422723608, 124.49892725300782 45.34544424464705, 124.49892565473216 45.34544609054458, 124.4989256412642 45.34544611016173, 124.49892457928851 45.34544813914771, 124.49892457145388 45.34544816023048, 124.49892408585993 45.345450295726295, 124.49892408395394 45.3454503174795, 124.49892419306946 45.3454524788856, 124.49892419716411 45.34545250048842, 124.49892489687079 45.3454546062283, 124.4989249067871 45.345454626813954, 124.49892618480371 45.34545661688347, 124.49896993090374 45.34551024117614, 124.49896995732944 45.34551028286592, 124.49896997126872 45.34551032746036, 124.49896997214692 45.345510373121094, 124.49896995992788 45.345510417965734, 124.49896681843616 45.34551780046454, 124.49896679522291 45.34551784052774, 124.4989667615577 45.34551787671389, 124.49896671868689 45.34551790768309, 124.4989666681982 45.34551793228858, 124.49896661196095 45.34551794961926, 124.49896655205757 45.34551795903338, 124.49896649070632 45.34551796018237, 124.49896643017878 45.34551795302367, 124.49896637271638 45.345517937822386, 124.49896632044668 45.345517915141365, 124.4989662753053 45.345517885820456, 124.49896482943161 45.345516746696106, 124.49896480724226 45.34551673224558, 124.49896242257299 45.3455154522946, 124.49896239691151 45.34551544106154, 124.49895971220451 45.345514501948145, 124.49895968399518 45.345514494337095, 124.49895679599459 45.345513929902594, 124.49895676625411 45.34551392618783, 124.49895377903039 45.345513756771865, 124.49895374883015 45.345513757087176, 124.49895077002866 45.34551398879473, 124.4989507404574 45.345513993128755, 124.4989478774203 45.345514617610185, 124.49894784954328 45.34551462580672, 124.49894520544105 45.345515620558636, 124.49894518026267 45.34551563232238, 124.49894285037708 45.34551696149837, 124.49894282885806 45.34551697636857, 124.49894087872445 45.34551860903965, 124.49892729440593 45.34553244967471, 124.49892725600697 45.34553248188185, 124.49892720977262 45.345532508481604, 124.49892715732113 45.34553252854295, 124.49892710048844 45.34553254136364, 124.49892704126393 45.34553254649498, 124.49892698172044 45.345532543757315, 124.49892692394218 45.345532533246505, 124.49892686995148 45.34553251533042, 124.49892682163824 45.34553249063619, 124.4989267806933 45.34553246002815, 124.49892652790264 45.34553223155092, 124.49892650568248 45.345532215187546, 124.49892407896435 45.34553075645135, 124.49892405253448 45.34553074357047, 124.49892125962194 45.345529658470575, 124.49892123006043 45.3455296495977, 124.4989181848992 45.34552898240429, 124.49891815341213 45.34552897790143, 124.49891498023875 45.34552875583457, 124.49891494811088 45.345528755885475, 124.49891177638453 45.34552898800508, 124.4989117449265 45.34552899260765, 124.49890870404784 45.34552966944364, 124.49890867454295 45.345529678410166, 124.49890588857353 45.345530772349, 124.49890586222556 45.345530785313684, 124.49890344482799 45.34553225172455, 124.49890342271196 45.34553226815848, 124.49890147251062 45.34553404721512, 124.49890145557161 45.34553406639947, 124.4989000394066 45.34553610641371, 124.49887904090764 45.34557610689575, 124.49887823776984 45.345578300866464, 124.49887823291031 45.34557832343637, 124.49887807637843 45.34558058663301, 124.49887807810019 45.34558060942927, 124.49887857465762 45.345582848096996, 124.49887858288959 45.34558287017547, 124.49887971196578 45.34558499157267, 124.49887972636637 45.34558501201799, 124.49888144118661 45.345586928260936, 124.49888146116024 45.34558694622722, 124.4988826067816 45.345587784664026, 124.49888264569503 45.345587819428225, 124.49888267419311 45.34558785889576, 124.49888269117056 45.34558790153617, 124.49888269596916 45.34558794569592, 124.49888268840265 45.34558798966254, 124.49888266876462 45.34558803173108, 124.49888263781644 45.34558807027018, 124.49888259675848 45.34558810378533, 124.49888254718266 45.345588130976886, 124.49886148471401 45.34559749335028, 124.49886111842893 45.34559769404117, 124.49886108312022 45.34559771084668, 124.49886068218288 45.34559787532255, 124.49886065689327 45.34559788819083, 124.49885987736808 45.34559837347032, 124.49885986197516 45.34559838246361, 124.49885904087085 45.34559883235407, 124.49885901823886 45.34559884748405, 124.49885871452074 45.3455990947041, 124.49885868453984 45.34559911604417, 124.4988583368101 45.34559933251711, 124.49885831556617 45.34559934861757, 124.49885768527605 45.34559993181263, 124.49885767266699 45.345599942750745, 124.49885699180531 45.34560049695751, 124.49885697379408 45.34560051491019, 124.49885674430685 45.34560079916343, 124.49885672080579 45.345600824218046, 124.49885643964683 45.34560108436889, 124.49885642326547 45.34560110308239, 124.4988559664314 45.345601761781666, 124.49885595709071 45.345601774244244, 124.49885544263726 45.3456024114692, 124.4988554299389 45.34560243155471, 124.4988552835019 45.34560274191702, 124.498855267384 45.34560276972323, 124.4988550636002 45.34560306355477, 124.49885505271072 45.34560308416263, 124.49885478688935 45.3456037930512, 124.49885478117609 45.3456038065593, 124.4988544529002 45.34560450231578, 124.4988544460028 45.34560452376197, 124.49885438824369 45.345604848306635, 124.49885438012828 45.345604877795985, 124.49885426155076 45.345605194016585, 124.498854256572 45.34560521572555, 124.4988541919777 45.34560594756396, 124.4988541901113 45.34560596159851, 124.49885406062978 45.345606689146194, 124.49885405979813 45.34560671113015, 124.49885409293658 45.34560703738395, 124.49885409319371 45.3456070667481, 124.49885406389494 45.34560741561186, 124.4988610631248 45.34574440129231, 124.49886113378852 45.345745130725625, 124.49886496902812 45.345771977455534, 124.49886496902812 45.34577202254061, 124.4988631594263 45.34578468972958, 124.49886314792774 45.345784730993856, 124.49886312573638 45.345784770027336, 124.49886309362829 45.34578480546527, 124.49886305272591 45.3457848360687, 124.49886300445927 45.345784860767644, 124.49886295051589 45.34578487869859, 124.49857064399774 45.345859388191805, 124.49857059069639 45.34585939820189, 124.49857053574637 45.345859401586246, 124.49857048079123 45.345859398243704, 124.4984704826972 45.34584710340214, 124.49847042558561 45.34584709244932, 124.49847037232733 45.34584707424384, 124.49847032475631 45.34584704941262, 124.49847028451069 45.345847018810765, 124.49847025297643 45.3458469834921, 124.49847023123947 45.345846944672864, 124.49847022004833 45.345846903689825, 124.4984702197883 45.34584686195433, 124.4984702304685 45.34584682090354, 124.49855682596741 45.34562986640866, 124.49855685744025 45.34562981407344, 124.49874878336722 45.345397653466506, 124.49875007244488 45.34539566942475, 124.49875008259325 45.34539564863023, 124.49875079800306 45.34539352537034, 124.49875080220346 45.345393503579096, 124.49875091645266 45.34539132269682, 124.49875091454382 45.34539130074694, 124.49875042324209 45.34538914605158, 124.4987504152973 45.345389124786216, 124.49875021516206 45.345388744982785, 124.49875019820652 45.34538869750767, 124.4987501962208 45.34538864857011, 124.49875020929888 45.34538860048898, 124.49875023682118 45.34538855554259, 124.49883887161413 45.34527854506258, 124.49884012933101 45.3452765510368, 124.4988401391508 45.345276530164156, 124.49884082104123 45.34527440142701, 124.49884082489783 45.34527437960451, 124.49884090475764 45.34527219796078, 124.49884090250278 45.345272176027585, 124.49884037726318 45.345270025317134, 124.49884036898341 45.34527000411472, 124.4988392588295 45.34526796698874, 124.49883924484297 45.34526794733265, 124.49883759243704 45.3452661020759, 124.49883757328111 45.345266084721565, 124.49883544212423 45.34526450224622, 124.49883541853592 45.34526448786103, 124.49883289052681 45.34526322898051, 124.49883286341206 45.34526321811688, 124.49883003570126 45.3452623312096, 124.4988300061017 45.34526232428489, 124.49882698735662 45.34526184343418, 124.49882695641 45.3452618407146, 124.49882386263886 45.34526178439918, 124.49882383153466 45.345261785989244, 124.49882078162926 45.34526215637333, 124.49882075156268 45.34526216221191, 124.49881786272957 45.345262945061826, 124.49881783485586 45.345262954924564, 124.49881521811045 45.34526412015603, 124.49881519350153 45.34526413366364, 124.498812949404 45.34526563649755, 124.49881292905557 45.34526565308979, 124.49881112705593 45.34526745439795, 124.4985291442067 45.34561743300428), (124.49925294933277 45.345513882891495, 124.49925288903697 45.3455138736859, 124.49925283238244 45.34551385646663, 124.49925278148906 45.345513831877945, 124.49925273826088 45.34551380083986, 124.49925270431542 45.34551376451367, 124.4992526809227 45.345513724258545, 124.49925266895806 45.345513681580655, 124.49925266886899 45.34551363807682, 124.49925268065896 45.345513595374754, 124.49925270388688 45.3455135550722, 124.49925273768359 45.34551351867709, 124.49925278078453 45.34551348755115, 124.49925283157712 45.34551346285901, 124.49925288816087 45.34551344552452, 124.49925294841869 45.345513436196256, 124.4992530100961 45.34551343522325, 124.49934010924889 45.34551801938876, 124.49934016673578 45.345518026180734, 124.49934022150974 45.345518040236875, 124.4993402717414 45.34551806108767, 124.49934031575282 45.34551808803674, 124.49934035207431 45.34551812018398, 124.49934037949262 45.34551815645569, 124.49934039709188 45.34551819564039, 124.49934122242433 45.34552085800173, 124.49934122968274 45.34552090041482, 124.4993412254372 45.3455209430306, 124.49934120984082 45.34552098431148, 124.49934118345637 45.34552102276799, 124.4993411472358 45.3455210570126, 124.49934110248599 45.34552108580972, 124.49934105082153 45.34552110812036, 124.49934099410657 45.34552112313951, 124.49934093438733 45.34552113032528, 124.4993408738187 45.3455211294184, 124.49925294933277 45.345513882891495), (124.49908753206972 45.345455251778645, 124.49908746994723 45.34545524892548, 124.49908740979414 45.34545523761677, 124.49908735390225 45.34545521828336, 124.499087304401 45.34545519166183, 124.49908726317643 45.34545515876645, 124.49908723179915 45.345455120850545, 124.49908721146475 45.345455079358686, 124.49908720294773 45.345455035871694, 124.49908720657278 45.34545499204641, 124.49908722220158 45.345454949552575, 124.49908724923895 45.345454910009174, 124.49908835536593 45.3454536292292, 124.49908839034387 45.34545359603736, 124.49908843334859 45.3454535679226, 124.49908848292596 45.34545354583536, 124.4990885374 45.34545353052242, 124.49911600402532 45.34544780830986, 124.49911605501826 45.34544780081399, 124.4991161070614 45.34544779927128, 124.49916704215019 45.345449227539405, 124.49932153656138 45.345458100625535, 124.49932160298773 45.34545810951075, 124.49932166526558 45.34545812807024, 124.49932172059621 45.34545815547, 124.49932176649311 45.3454581904787, 124.4993218008938 45.345458231523125, 124.49932182225234 45.3454582767588, 124.49932304457141 45.34546221973079, 124.49932305182409 45.345462261985205, 124.49932304765795 45.3454623044465, 124.49932303222221 45.345462345593944, 124.49932300606963 45.34546238395388, 124.49932297013693 45.345462418152465, 124.49932292571093 45.34546244696489, 124.49932287438281 45.345462469359276, 124.49932281799079 45.34546248453357, 124.49932275855446 45.34546249194431, 124.49932269820265 45.345462491326096, 124.49919772824794 45.34545282148323, 124.49919546713222 45.345452760959326, 124.49908753206972 45.345455251778645), (124.49850512253565 45.34587464055009, 124.4985050702927 45.34587461845161, 124.49850502496126 45.345874589751574, 124.49850498819539 45.34587455549715, 124.49850496133642 45.34587451693808, 124.49850494536439 45.34587447548124, 124.4985049408619 45.345874432639164, 124.49850494799337 45.34587438997496, 124.49850496649846 45.345874349045225, 124.49850499570219 45.34587431134329, 124.4985050345389 45.34587427824474, 124.49850508159169 45.34587425095716, 124.49850513514389 45.345874230476134, 124.49850519324148 45.34587421754894, 124.49850525376492 45.34587421264722, 124.49850531450589 45.34587421594979, 124.49856927460795 45.345882079024356, 124.49857199484154 45.34588224447767, 124.49857202236947 45.34588224446719, 124.49857474234543 45.34588207694395, 124.49857476939144 45.34588207359742, 124.49857743410415 45.34588157229745, 124.49888343473988 45.345803571085426, 124.49888610487871 45.345802683522436, 124.49888613048739 45.345802672841494, 124.49888851963287 45.34580145027009, 124.49888854197437 45.34580143641395, 124.49889056659755 45.34579992157767, 124.49889058489057 45.34579990503085, 124.4988921742069 45.34579815089125, 124.49889218781102 45.34579813223321, 124.49889328625405 45.34579620011897, 124.4988932946739 45.345796180050385, 124.49889386822981 45.34579411669931, 124.49889686672748 45.34577311588652, 124.49889686513653 45.345770861683555, 124.4988929192296 45.345743240390185, 124.49889291783033 45.345743225945895, 124.49888627372407 45.3456131920244, 124.49888627827107 45.34561314523957, 124.49888629647744 45.34561310013664, 124.49888632755155 45.345613058676484, 124.4988863701425 45.34561302266159, 124.49888642239858 45.3456129936577, 124.4989102245386 45.34560241492736, 124.49891028181914 45.34560239481937, 124.49891034363867 45.34560238317869, 124.49891040750931 45.345602380473814, 124.49896201934152 45.34560385510726, 124.49896207470314 45.34560386013629, 124.49902759935026 45.34561398584847, 124.4990302228713 45.345614231166735, 124.49903024945986 45.34561423206586, 124.49903292090393 45.34561416343959, 124.49906611978477 45.345611342637426, 124.49906620379781 45.34561134335945, 124.49916170276872 45.345621128024966, 124.49916257024346 45.34562120002783, 124.4993201457477 45.345631233001555, 124.49932020977762 45.34563124180199, 124.49932026992902 45.34563125960513, 124.49932032368544 45.34563128566616, 124.49932036879794 45.345631318894824, 124.49932040337913 45.345631357901006, 124.49932042598257 45.34563140105286, 124.49932043566241 45.34563144654512, 124.49932043201382 45.34563149247463, 124.49932041518936 45.34563153691994, 124.49926527316296 45.34573381641902, 124.49926524448874 45.34573385683054, 124.49926520493734 45.34573389238435, 124.49908907359227 45.34586305534944, 124.49908900452242 45.345863093679455, 124.4989859639216 45.34590552216848, 124.49898590677758 45.34590554063972, 124.49898584560586 45.34590555084878, 124.49898578278277 45.34590555239904, 124.49898572074873 45.34590554523028, 124.4989856619134 45.345905529621, 124.49898560856255 45.34590550617753, 124.49898556276844 45.345905475810575, 124.49898552631004 45.345905439699784, 124.49898550060368 45.34590539924792, 124.49898456115389 45.34590341733107, 124.49898454841565 45.345903397257395, 124.49898301352808 45.345901502196206, 124.49898299552592 45.34590148430529, 124.49898094423057 45.34589982090361, 124.4989779436408 45.34589782188971, 124.49897558753656 45.34589652561657, 124.49897556214393 45.34589651419561, 124.49897290190157 45.34589555424069, 124.49897287398174 45.34589554641808, 124.4989699754981 45.345894952160265, 124.49891797861119 45.345887953200574, 124.49891566882809 45.34588776518514, 124.49891564545203 45.3458877645053, 124.49891329811427 45.345887818901225, 124.49861188077232 45.34591047445842, 124.49861182229814 45.3459104750514, 124.49861176465339 45.34591046810569, 124.49861170977604 45.34591045385484, 124.49850512253565 45.34587464055009), (124.49925576867159 45.345566194024904, 124.49925583089643 45.34556620351817, 124.49925588920777 45.34556622153739, 124.49925594128213 45.34556624736459, 124.4992559850446 45.34556627997068, 124.49925601875142 45.34556631805645, 124.49925604105955 45.345566360104364, 124.49925605108017 45.34556640443901, 124.49925604841391 45.345566449293855, 124.49925603316704 45.34556649288162, 124.49925600594716 45.34556653346559, 124.49925596783869 45.345566569428634, 124.49925592036023 45.345566599337815, 124.4992558654035 45.345566622001385, 124.49925580515833 45.34556663651629, 124.49922719170345 45.34557134506535, 124.49922713573541 45.34557135064824, 124.49922707924864 45.345571349176296, 124.4991985657704 45.345568809018516, 124.49901758157107 45.345556182240976, 124.49901751918954 45.34555617339078, 124.49901746054101 45.345556155984184, 124.49901740795993 45.34555613071403, 124.49901736353912 45.345556098586194, 124.49901732904685 45.34555606087945, 124.49901730585603 45.345556019094715, 124.49901729488953 45.34555597489518, 124.49901729658419 45.34555593004015, 124.49901731087235 45.34555588631505, 124.4990173371853 45.34555584546031, 124.49901737447573 45.34555580910211, 124.49901742125935 45.34555577868766, 124.49901747567394 45.34555575542758, 124.49901753555353 45.345555740247704, 124.49901759851475 45.34555573375226, 124.49909443293076 45.345553275035385, 124.49909448338327 45.34555327624098, 124.49925576867159 45.345566194024904), (124.49901580985147 45.3455332772102, 124.49901574961962 45.345533275113134, 124.49901569102425 45.34553326505856, 124.49901563616025 45.345533247405996, 124.49901558698905 45.3455332227865, 124.49901554526849 45.34553319208029, 124.49901551249035 45.34553315638515, 124.49901548982638 45.345533116977215, 124.4990154780868 45.34553307526538, 124.4990154776914 45.34553303274091, 124.49901548865427 45.3455329909241, 124.49901551058346 45.34553295130998, 124.49901578942212 45.34553256118261, 124.49901582777322 45.34553251965571, 124.49901587809016 45.345532485059614, 124.49901593793007 45.34553245907398, 124.49902393215132 45.34552979433191, 124.49902400919808 45.345529776674944, 124.49906429067462 45.345524405811396, 124.49906434316239 45.34552440194636, 124.4990643958354 45.345524404237544, 124.49912749360891 45.345530875806666, 124.49912754780178 45.345530884828605, 124.49912759894369 45.34553090035945, 124.49912883506033 45.34553136984526, 124.49912886372746 45.34553137829684, 124.49913184895631 45.345532023605244, 124.4991458280512 45.345534020618764, 124.49914697579003 45.34553415435513, 124.49916987241876 45.345536226468724, 124.49916993307939 45.34553623627522, 124.49916998988456 45.34553625420206, 124.4991700406714 45.34553627956662, 124.49917008350614 45.34553631140319, 124.49917011675794 45.34553634849957, 124.49917013916071 45.34553638944328, 124.49917014986134 45.34553643267542, 124.49917014845246 45.34553647654988, 124.4991701349877 45.345536519396155, 124.49917010997984 45.34553655958284, 124.49917007438101 45.34553659557981, 124.49917002954649 45.345536626016525, 124.49916997718357 45.34553664973402, 124.49916991928589 45.3455366658293, 124.499169858058 45.34553667368953, 124.49916979583105 45.3455366730154, 124.49909678712665 45.34553082622632, 124.49909426450755 45.34553076664539, 124.49901580985147 45.3455332772102), (124.4990582619623 45.34558577056893, 124.49905819946758 45.34558576201938, 124.49905814062564 45.34558574488789, 124.49905808778075 45.34558571985697, 124.49905804303813 45.34558568792382, 124.49905800818034 45.345585650360675, 124.49905798459602 45.345585608664024, 124.49905797322492 45.345585564495025, 124.49905797452003 45.34558551961335, 124.49905798842956 45.345585475807106, 124.49905801439962 45.34558543482146, 124.49905805139535 45.34558539828929, 124.49905809794299 45.34558536766601, 124.49905815218817 45.345585344171646, 124.49905821196958 45.34558532874219, 124.49905827490575 45.34558532199237, 124.49905883087571 45.34558530199312, 124.49905890792077 45.34558530582499, 124.49905968492749 45.34558541222097, 124.49905974673146 45.34558542537736, 124.49905980351228 45.34558544704071, 124.49905985294326 45.345585476323386, 124.49905989299936 45.34558551202564, 124.49905992203927 45.345585552684625, 124.49905993887306 45.34558559663447, 124.49905994281114 45.34558564207445, 124.49905993369214 45.34558568714274, 124.49905991188963 45.34558572999284, 124.49905987829706 45.34558576886902, 124.49905983429058 45.345585802178476, 124.49905978167341 45.3455858285564, 124.49905972260123 45.34558584692205, 124.49905965949459 45.34558585652293, 124.499059594939 45.34558585696568, 124.4990582619623 45.34558577056893), (124.49903346772767 45.3455003727985, 124.49903349466602 45.34550033442584, 124.49903353142888 45.34550030034859, 124.4990335766836 45.345500271801825, 124.49903362879029 45.34550024982021, 124.49903368586014 45.34550023520041, 124.4990337458248 45.34550022847233, 124.499033806511 45.345500229879804, 124.4990354687239 45.345500380990366, 124.49903552785769 45.34550039046509, 124.49903558337955 45.34550040766109, 124.49903563328228 45.3455004319567, 124.49903567576199 45.34550046247365, 124.49903570928282 45.345500498108734, 124.49903573263305 45.345500537573685, 124.49903574496857 45.34550057944181, 124.49903574584349 45.345500622199594, 124.49903573522603 45.34550066430128, 124.49903571350012 45.34550070422486, 124.49903568145122 45.345500740527065, 124.49903564023784 45.345500771895544, 124.49903559134987 45.34550079719633, 124.49903553655459 45.34550081551474, 124.4990354778331 45.34550082618858, 124.49903541730802 45.345500828831966, 124.49903369528536 45.345500788313174, 124.49903363522031 45.34550078284267, 124.49903357770468 45.345500769464074, 124.49903352481248 45.345500748659774, 124.4990334784508 45.345500721179995, 124.49903344029146 45.34550068801559, 124.4990334117105 45.34550065036245, 124.4990333937384 45.34550060957831, 124.49903338702326 45.345500567133776, 124.49903339180725 45.34550052455938, 124.49903340791793 45.34550048339027, 124.49903346772767 45.3455003727985), (124.49849151243538 45.345708856544604, 124.49849154826458 45.34570882145725, 124.49849159295321 45.34570879185297, 124.49849164484937 45.34570876882597, 124.49849170203531 45.345708753227264, 124.49849176239731 45.345708745633374, 124.49849182370467 45.34570874632494, 124.4984918836913 45.34570875527641, 124.49849194014044 45.34570877215697, 124.49849199096562 45.345708796342706, 124.49849203428847 45.34570882693976, 124.49849206850786 45.34570886281732, 124.4984920923591 45.34570890264938, 124.49849210496065 45.345708944963796, 124.49849210584675 45.34570898819671, 124.49849209498467 45.345709030750264, 124.49844118121685 45.34583658864827, 124.4984411573609 45.34583663122163, 124.49844112177476 45.345836669506994, 124.49844107593255 45.345836701918294, 124.49844102173346 45.34583672711285, 124.49844096142273 45.34583674404693, 124.49844089749884 45.34583675201901, 124.49844083260992 45.34583675069885, 124.49844076944417 45.3458367401411, 124.49844071061834 45.345836720783176, 124.49844065856932 45.34583669342698, 124.4984336419396 45.34583215325138, 124.4984335980684 45.34583211828802, 124.49843356537882 45.34583207769092, 124.49843354527918 45.34583203320934, 124.49843353863582 45.34583198675987, 124.49843354573466 45.34583194034391, 124.49845904748626 45.3457481487914, 124.49845906192358 45.3457481147383, 124.4984590837882 45.345748082714245, 124.49849151243538 45.345708856544604))</textarea>
            <div class="coord-settings" style="margin-bottom:8px;font-size:12px;color:#333;">
                <label>WKT坐标系：
                    <select id="coordSysSelect" style="margin-left:6px;">
                        <option value="wgs84" selected>WGS84</option>
                        <option value="gcj02">GCJ-02（国测局）</option>
                        <option value="bd09">BD-09（百度）</option>
                        <option value="cgcs2000">CGCS2000</option>
                    </select>
                </label>
                <!-- 已移除“不进行绘制坐标转换”选项，统一使用WGS84绘制 -->
            </div>

            <div class="button-group">
                <button id="drawButton">绘制轮廓</button>
                <button id="clearButton">清空轮廓</button>
            </div>
            <!-- 显示开关：仅保留显示亩数 -->
            <div class="display-toggles" style="margin-top:8px;font-size:12px;color:#333;">
                <label><input type="checkbox" id="toggleLabelsCheckbox"> 显示亩数</label>
            </div>
            <!-- 颜色选择器 -->
            <div class="color-picker-container" style="margin-top:8px;">
                <div style="margin-bottom:6px;font-size:12px;color:#333;">轮廓颜色设置：</div>
                <div style="display:flex;align-items:center;gap:8px;">
                    <div style="display:flex;align-items:center;gap:4px;">
                        <label style="font-size:12px;">边框颜色:</label>
                        <div id="outlineColorPicker" class="color-picker" style="width:24px;height:24px;border:1px solid #ccc;cursor:pointer;background-color:#FFD700;"></div>
                        <input type="color" id="outlineColorInput" value="#FFD700" style="display:none;">
                    </div>
                    <div style="display:flex;align-items:center;gap:4px;">
                        <label style="font-size:12px;">填充颜色:</label>
                        <div id="fillColorPicker" class="color-picker" style="width:24px;height:24px;border:1px solid #ccc;cursor:pointer;background-color:#FFFF00;"></div>
                        <input type="color" id="fillColorInput" value="#FFFF00" style="display:none;">
                    </div>
                    <div style="display:flex;align-items:center;gap:4px;">
                        <label style="font-size:12px;">透明度:</label>
                        <input type="range" id="fillOpacitySlider" min="0" max="100" value="35" style="width:60px;">
                        <span id="fillOpacityValue" style="font-size:12px;">35%</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane" id="tabSplit">
            <!-- MultiPolygon → 多个 Polygon 分割器 -->
            <div class="split-section">
                <div class="title">MultiPolygon → 多个 Polygon 分割器</div>
                <div class="desc">输入一个 MULTIPOLYGON WKT，分割为多行 POLYGON WKT。</div>
                <textarea id="multiInput"></textarea>
                <div class="split-actions">
                    <button id="splitMultiBtn">分割为多个 POLYGON</button>
                    <button id="copyPolysBtn">复制结果</button>
                </div>
                <textarea id="polyOutput" readonly></textarea>
            </div>
        </div>

        <div class="tab-pane" id="tabBatch">
            <!-- 批量POLYGON → MULTIPOLYGON 生成器 -->
            <div class="batch-section">
                <div class="title">批量POLYGON → MULTIPOLYGON 合并器</div>
                <div class="desc">每行一个 POLYGON WKT（或用分号分隔）。生成后可一键填充到上方并绘制。</div>
                <textarea id="batchInput"></textarea>
                <div class="batch-actions">
                    <button id="generateMultiBtn">生成 MULTIPOLYGON</button>
                    <button id="copyMultiBtn">复制结果</button>
                </div>
                <textarea id="multiOutput" readonly></textarea>
            </div>
        </div>
        <div class="tab-pane" id="tabTrack">
            <div class="tip">请粘贴轨迹文本（支持两种格式：1）每行一条：定位时间yyyyMMddHHmmss, 经度, 纬度；2）单行#分隔：经度,纬度,定位时间yyyyMMddHHmmss#经度,纬度,定位时间yyyyMMddHHmmss#…）。</div>
            <div class="coord-settings" style="margin-bottom:8px;font-size:12px;color:#333;">
                <label>轨迹坐标系：
                    <select id="trackCoordSysSelect" style="margin-left:6px;">
                        <option value="wgs84" selected>WGS84</option>
                        <option value="gcj02">GCJ-02（国测局）</option>
                        <option value="bd09">BD-09（百度）</option>
                        <option value="cgcs2000">CGCS2000</option>
                    </select>
                </label>
            </div>
            <textarea id="trackTextarea" style="width:100%;height:120px;margin-bottom:10px;padding:8px;border:1px solid #ddd;border-radius:4px;font-family:monospace;resize:vertical;box-sizing:border-box;">20250930125620,124.504461,45.342159
20250930125630,124.504449,45.342141
20250930125640,124.504459,45.342098
20250930125650,124.504503,45.342061
20250930130711,124.504509,45.342037
20250930130721,124.504532,45.342030
20250930130731,124.504532,45.342030
20250930130741,124.504344,45.342010
20250930130751,124.504155,45.341996
20250930130801,124.504155,45.341996
20250930130811,124.504155,45.341996
20250930130821,124.504155,45.341996
20250930130831,124.504155,45.341996
20250930130841,124.504155,45.341996
20250930130851,124.504155,45.341996
20250930130901,124.504155,45.341996
20250930130911,124.504155,45.341996
20250930130921,124.504155,45.341996
20250930130931,124.504155,45.341996
20250930130941,124.504155,45.341996
20250930130951,124.504075,45.341975
20250930131001,124.503665,45.341870
20250930131011,124.503287,45.341748
20250930131021,124.502906,45.341643
20250930131031,124.502588,45.341997
20250930131041,124.502381,45.342301
20250930131051,124.502120,45.342415
20250930131101,124.501898,45.342589
20250930131111,124.501417,45.342698
20250930131121,124.501102,45.342806
20250930131131,124.500656,45.343304
20250930131141,124.500362,45.343601
20250930131151,124.499969,45.344033
20250930131201,124.499654,45.344349
20250930131211,124.499237,45.344797
20250930131221,124.498825,45.345273
20250930131231,124.498543,45.345623
20250930131241,124.498450,45.345856
20250930131251,124.498572,45.345871
20250930131301,124.498878,45.345793
20250930131311,124.498881,45.345772
20250930131321,124.498881,45.345772
20250930131331,124.498881,45.345772
20250930131341,124.498881,45.345772
20250930131351,124.498881,45.345772
20250930131401,124.498881,45.345772
20250930131411,124.498881,45.345772
20250930131421,124.498881,45.345772
20250930131431,124.498877,45.345744
20250930131441,124.498870,45.345607
20250930131555,124.498870,45.345607
20250930131605,124.498870,45.345607
20250930131615,124.498870,45.345607
20250930131625,124.498906,45.345591
20250930131635,124.499011,45.345594
20250930131645,124.499119,45.345601
20250930131655,124.499223,45.345611
20250930131705,124.499280,45.345615
20250930131715,124.499409,45.345625
20250930131725,124.499431,45.345627
20250930131735,124.499164,45.345610
20250930131745,124.498920,45.345585
20250930131755,124.498959,45.345592
20250930131805,124.498902,45.345575
20250930131815,124.498902,45.345575
20250930131825,124.498894,45.345580
20250930131835,124.498915,45.345540
20250930131845,124.498901,45.345579
20250930131855,124.498954,45.345525
20250930131905,124.498929,45.345579
20250930131915,124.498929,45.345579
20250930131925,124.498982,45.345565
20250930131935,124.499106,45.345573
20250930131945,124.499197,45.345580
20250930131955,124.499292,45.345589
20250930132005,124.499399,45.345598
20250930132015,124.499478,45.345602
20250930132025,124.499301,45.345607
20250930132035,124.499060,45.345574
20250930132045,124.498921,45.345579
20250930132055,124.498957,45.345552
20250930132105,124.498957,45.345552
20250930132115,124.498957,45.345552
20250930132125,124.498970,45.345546
20250930132135,124.499095,45.345542
20250930132146,124.499137,45.345545
20250930132156,124.499137,45.345545
20250930132206,124.499137,45.345545
20250930132216,124.499156,45.345547
20250930132226,124.499168,45.345548
20250930132236,124.499260,45.345556
20250930132246,124.499365,45.345564
20250930132256,124.499476,45.345573
20250930132306,124.499532,45.345577
20250930132316,124.499509,45.345576
20250930132326,124.499509,45.345576
20250930132336,124.499462,45.345570
20250930132346,124.499369,45.345568
20250930132356,124.499263,45.345577
20250930132406,124.499184,45.345590
20250930132416,124.499031,45.345603
20250930132426,124.498921,45.345586
20250930132436,124.498935,45.345563
20250930132446,124.498935,45.345563
20250930143758,124.498991,45.345520
20250930143808,124.499032,45.345512
20250930143818,124.499066,45.345512
20250930143828,124.499064,45.345513
20250930143838,124.499086,45.345513
20250930143848,124.499117,45.345514
20250930143858,124.499212,45.345522
20250930143908,124.499349,45.345533
20250930143918,124.499481,45.345544
20250930143928,124.499370,45.345543
20250930143938,124.499149,45.345523
20250930143948,124.499135,45.345521
20250930143958,124.499142,45.345521
20250930144008,124.499064,45.345513
20250930144018,124.499019,45.345519
20250930144028,124.498977,45.345533
20250930144038,124.498994,45.345493
20250930144048,124.498997,45.345486
20250930144058,124.498997,45.345486
20250930144108,124.499005,45.345460
20250930144118,124.499023,45.345398
20250930144128,124.499006,45.345460
20250930144138,124.498984,45.345479
20250930144148,124.498991,45.345490
20250930144158,124.498940,45.345451
20250930144208,124.499002,45.345527
20250930144218,124.499055,45.345429
20250930144228,124.499039,45.345476
20250930144238,124.499084,45.345486
20250930144248,124.499224,45.345493
20250930144258,124.499387,45.345508
20250930144308,124.499516,45.345516
20250930144318,124.499122,45.345495
20250930144328,124.499079,45.345493
20250930144338,124.499035,45.345489
20250930144349,124.499066,45.345467
20250930144359,124.499196,45.345464
20250930144409,124.499367,45.345478
20250930144419,124.499532,45.345490
20250930144429,124.499200,45.345476
20250930144439,124.499040,45.345488
20250930144449,124.499078,45.345444
20250930144459,124.499126,45.345434
20250930144509,124.499271,45.345441
20250930144519,124.499431,45.345453
20250930144529,124.499464,45.345455
20250930144539,124.499168,45.345438
20250930144549,124.499061,45.345435
20250930144559,124.499111,45.345410
20250930144609,124.499235,45.345411
20250930144619,124.499412,45.345424
20250930144629,124.499507,45.345430
20250930144639,124.499218,45.345422
20250930144649,124.499056,45.345428
20250930144659,124.499069,45.345411
20250930144709,124.499093,45.345399
20250930144719,124.499202,45.345396
20250930144729,124.499402,45.345410
20250930144739,124.499491,45.345417
20250930144749,124.499330,45.345432
20250930144759,124.499361,45.345532
20250930144809,124.499341,45.345625
20250930144819,124.499279,45.345740
20250930144829,124.499099,45.345872
20250930144839,124.498980,45.345921
20250930145119,124.498970,45.345908
20250930145129,124.498967,45.345906
20250930145139,124.498965,45.345906
20250930145149,124.498915,45.345899
20250930145159,124.498609,45.345922
20250930145209,124.498546,45.345900
20250930145219,124.498484,45.345880
20250930145229,124.498416,45.345836
20250930145239,124.498444,45.345744
20250930145249,124.498735,45.345392
20250930145259,124.499128,45.344941
20250930145309,124.499532,45.344476
20250930145319,124.499820,45.344178
20250930145329,124.500166,45.343821
20250930145339,124.500391,45.343557
20250930145349,124.500837,45.343101
20250930145359,124.501129,45.342775
20250930145409,124.501415,45.342702
20250930145419,124.501836,45.342651
20250930145429,124.502118,45.342423
20250930145439,124.502344,45.342354
20250930145449,124.502545,45.342073
20250930145459,124.502815,45.341705
20250930145509,124.503013,45.341655
20250930145519,124.503502,45.341822
20250930145529,124.504184,45.341975
20250930145539,124.504547,45.341988
20250930145549,124.504500,45.342051
20250930145559,124.504448,45.342116
20250930145609,124.504460,45.342167
20250930145619,124.504525,45.342199</textarea>
            <div class="button-group">
                <button id="drawTrackButton" disabled style="flex: 1;">绘制轨迹</button>
                <button id="showTrackPointsButton" disabled style="flex: 1;" class="btn-warning">打点</button>
                <button id="clearTrackButton" disabled style="flex: 1;">清空轨迹</button>
            </div>
            <!-- 轨迹颜色选择器 -->
            <div class="color-picker-container" style="margin-top:8px;">
                <div style="margin-bottom:6px;font-size:12px;color:#333;">轨迹颜色设置：</div>
                <div style="display:flex;align-items:center;gap:8px;">
                    <div style="display:flex;align-items:center;gap:4px;">
                        <label style="font-size:12px;">轨迹线颜色:</label>
                        <div id="trackLineColorPicker" class="color-picker" style="width:24px;height:24px;border:1px solid #ccc;cursor:pointer;background-color:#FF0000;"></div>
                        <input type="color" id="trackLineColorInput" value="#FF0000" style="display:none;">
                    </div>
                    <div style="display:flex;align-items:center;gap:4px;">
                        <label style="font-size:12px;">轨迹点颜色:</label>
                        <div id="trackPointColorPicker" class="color-picker" style="width:24px;height:24px;border:1px solid #ccc;cursor:pointer;background-color:#68EAF3;"></div>
                        <input type="color" id="trackPointColorInput" value="#68EAF3" style="display:none;">
                    </div>
                </div>
            </div>
            <!-- 回放控制 -->
            <div class="split-section" style="margin-top:8px;">
                <div class="title">轨迹回放</div>
                <div class="playback-actions" style="display:flex;gap:8px;margin-bottom:8px;">
                    <button id="playbackStartBtn" disabled>开始</button>
                    <button id="playbackPauseBtn" disabled>继续</button>
                    <button id="playbackStopBtn" disabled>结束</button>
                </div>
                <div class="playback-speed" style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                    <label>速度：
                        <select id="playbackSpeedSelect" disabled>
                            <option value="1" selected>1×</option>
                            <option value="2">2×</option>
                            <option value="4">4×</option>
                            <option value="8">8×</option>
                            <option value="16">16×</option>
                            <option value="32">32×</option>
                            <option value="64">64×</option>
                            <option value="128">128×</option>
                            <option value="256">256×</option>
                            <option value="512">512×</option>
                            <option value="1024">1024×</option>
                        </select>
                    </label>
                    <span id="playbackTimeLabel" style="font-size:12px;color:#666;">时间：—</span>
                </div>
                <div class="playback-time" style="display:flex;flex-direction:column;gap:4px;margin-bottom:8px;">
                    <label class="playback-time-label" style="display:flex;align-items:center;gap:8px;flex:1 1 auto;min-width:0;">
                        <span class="playback-time-text" style="white-space:nowrap;">起始时间：</span>
                        <input type="range" id="playbackTimeSlider" disabled min="0" max="0" step="1000" value="0" style="flex:1 1 auto;min-width:0;max-width:100%;vertical-align:middle;">
                    </label>
                    <span id="playbackTimeCursor" style="font-size:12px;color:#666;align-self:flex-end;">—</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let map;
    let currentPolygons = []; // 存储多边形和其标签
    let currentTracks = []; // 存储轨迹折线及相关覆盖物
    let mapLoaded = false;
    let mapLabelHandlers = []; // 存储地图事件处理器
    let labelsEnabled = false; // 标签显示开关（默认关闭）
    let isDrawing = false; // 绘制进行中防止重复点击
    let currentMapType = 'satellite'; // 当前地图类型：'satellite'（卫星图）或'street'（街道图）

    window.onload = function () {
        if (typeof T === 'undefined') {
            alert("天地图API加载失败，请检查网络或密钥！");
            return;
        }
        initMap();
        bindDrawEvent();
        bindMinimizeEvent();
        bindTabs();
        bindBatchGenerator();
        bindMultiSplitter();
        bindLabelsToggle(); // 绑定标签显示开关
        bindTrackEvents();  // 绑定轨迹绘制与清空
        bindPlaybackControls(); // 绑定轨迹回放
        bindMeasureEvents(); // 绑定测量功能
        bindMapTypeEvent(); // 绑定地图类型切换功能
        initColorPickers(); // 初始化颜色选择器
    };

    function initMap() {
        showLoading();
        disableButtons(true);

        try {
            map = new T.Map("mapContainer", {
                zoom: 12,
                center: new T.LngLat(116.40769, 39.90403)
            });

            // 已移除测试标签
            map.enableScrollWheelZoom();

            // 不再添加地图类型控件到地图，改为使用左侧工具条按钮切换
            // const mapTypeCtrl = new T.Control.MapType({
            //     mapTypes: [TMAP_NORMAL_MAP, TMAP_SATELLITE_MAP, TMAP_TERRAIN_MAP],
            //     position: T_ANCHOR_TOP_LEFT
            // });
            // map.addControl(mapTypeCtrl);

            // 加载影像底图（卫星）
            const tk = "648f621977051d0199ff0f965d3fd322";

            // 方案1：使用默认地图类型（作为备选）
            map.setMapType(TMAP_SATELLITE_MAP);
            currentMapType = 'satellite';
            updateMapTypeButton('卫星图');

            // 方案2：手动添加影像图层（底图 + 标注）
            const vecLayer = new T.TileLayer(`https://t0.tianditu.gov.cn/img_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=img&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`);
            const cvaLayer = new T.TileLayer(`https://t0.tianditu.gov.cn/cia_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cia&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`);

            // 添加图层并监听加载状态
            vecLayer.addEventListener("load", function () {
                console.log("影像底图加载完成");
            });

            vecLayer.addEventListener("error", function (e) {
                console.error("影像底图加载错误:", e);
                alert("影像底图加载错误，将使用默认地图类型");
            });

            map.addLayer(vecLayer);
            map.addLayer(cvaLayer);

            // 监听地图加载事件
            map.addEventListener("loaded", function () {
                console.log("地图加载完成");
                markMapLoaded();
            });
            map.addEventListener("load", function () {
                console.log("地图load事件触发");
                markMapLoaded();
            });
            map.addEventListener("tilesloaded", function () {
                console.log("地图瓦片加载完成");
                markMapLoaded();
            });
            // 监听地图加载失败事件
            map.addEventListener("error", function (e) {
                console.error("地图加载错误:", e);
                alert("地图加载错误: " + e.message);
                hideLoading();
            });

            // 监听地图移动事件，用于更新标签位置
            const moveHandler = function () {
                updateAllLabelsPosition();
            };
            map.addEventListener("move", moveHandler);
            map.addEventListener("zoom", moveHandler);

            // 存储事件处理器，用于清理
            mapLabelHandlers.push({ event: "move", handler: moveHandler });
            mapLabelHandlers.push({ event: "zoom", handler: moveHandler });

            // 超时容错
            setTimeout(() => {
                if (!mapLoaded) markMapLoaded();
            }, 8000);

        } catch (error) {
            alert("地图初始化失败：" + error.message);
            console.error(error);
            hideLoading();
        }
    }

    function markMapLoaded() {
        if (!mapLoaded) {
            mapLoaded = true;
            hideLoading();
            // 不再禁用按钮，保持按钮始终可用
            // disableButtons(false);
            disableTrackButtons(false);
            // 仅开启速度选择，回放按钮按状态控制
            const speedSel = document.getElementById('playbackSpeedSelect');
            if (speedSel) speedSel.disabled = false;
            updatePlaybackButtonsState('idle');
        }
    }

    function showLoading() {
        const loading = document.getElementById("mapLoading");
        loading.style.display = "flex";
        loading.style.opacity = "1";
    }

    function hideLoading() {
        const loading = document.getElementById("mapLoading");
        loading.style.opacity = "0";
        setTimeout(() => loading.style.display = "none", 300);
    }

    function disableButtons(disabled) {
        // 不再禁用按钮，保持按钮始终可用
        // document.getElementById("drawButton").disabled = disabled;
        // document.getElementById("clearButton").disabled = disabled;
    }

    function disableTrackButtons(disabled) {
        const drawTrackBtn = document.getElementById("drawTrackButton");
        const showTrackPointsBtn = document.getElementById("showTrackPointsButton");
        const clearTrackBtn = document.getElementById("clearTrackButton");
        if (drawTrackBtn) drawTrackBtn.disabled = disabled;
        if (showTrackPointsBtn) showTrackPointsBtn.disabled = disabled;
        if (clearTrackBtn) clearTrackBtn.disabled = disabled;
    }
    // 回放控件的禁用/启用
    function disablePlaybackButtons(disabled) {
        ["playbackStartBtn","playbackPauseBtn","playbackStopBtn","playbackSpeedSelect","playbackTimeSlider"].forEach(id=>{
            const el = document.getElementById(id);
            if (el) el.disabled = disabled;
        });
    }

    // 回放按钮状态管理：空闲/播放/暂停
    function updatePlaybackButtonsState(state){
        try {
            const startBtn = document.getElementById('playbackStartBtn');
            const pauseBtn = document.getElementById('playbackPauseBtn');
            const stopBtn = document.getElementById('playbackStopBtn');
            if (!startBtn || !pauseBtn || !stopBtn) return;
            if (state === 'idle') {
                startBtn.disabled = false;
                pauseBtn.disabled = true;
                stopBtn.disabled = true;
                pauseBtn.textContent = '继续';
            } else if (state === 'playing') {
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
                pauseBtn.textContent = '暂停';
            } else if (state === 'paused') {
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
                pauseBtn.textContent = '继续';
            }
        } catch(e) { console.warn('更新按钮状态失败:', e); }
    }

    function bindDrawEvent() {
        document.getElementById("drawButton").addEventListener("click", function () {
            if (isDrawing) { console.log('绘制进行中，忽略重复点击'); return; }
            isDrawing = true;
            showLoading();
            try {
                const wktStr = document.getElementById("wktTextarea").value.trim();
                if (!wktStr) { alert("请输入WKT字符串！"); return; }
                clearOverlays();
                const geojson = parseWkt(wktStr);
    
                const polygonData = [];
                if (geojson.type === "Polygon") {
                    polygonData.push({ index: 1, coordinates: geojson.coordinates });
                } else if (geojson.type === "MultiPolygon") {
                    geojson.coordinates.forEach((polygon, index) => {
                        polygonData.push({ index: index + 1, coordinates: polygon });
                    });
                }
    
                // 重置并绘制
                polygonInfoList = [];
                polygonData.forEach(pd => processPolygon(pd.index, pd.coordinates));
    
                // 视图居中到所有已绘制轮廓
                try { fitViewportToPolygons(); } catch (e) { console.warn('视图居中失败', e); }
    
                // 在视图稳定后再创建/更新标签
                setTimeout(() => {
                    if (labelsEnabled) {
                        try {
                            createAllLabels();
                            updateAllLabelsPosition();
                        } catch (e) {
                            console.warn('创建或更新标签失败:', e);
                        }
                    }
                }, 150);
            } catch (e) {
                alert('绘制失败：' + (e && e.message ? e.message : e));
                console.error('绘制异常:', e);
            } finally {
                hideLoading();
                isDrawing = false;
                // 不再禁用按钮，保持按钮始终可用
                // disableButtons(false);
            }
        });

        document.getElementById("clearButton").addEventListener("click", function () {
            if (isDrawing) { console.log('绘制进行中，暂不清空'); return; }
            clearOverlays();
            console.log("已清空所有轮廓");
        });
    }

    // 存储多边形数据，用于后续标签创建
    let polygonInfoList = [];

    // 处理单个多边形的绘制和面积计算
    function processPolygon(actualPolygonIndex, polygonCoords) {
        console.log('开始处理多边形', actualPolygonIndex);

        // 坐标系选择（绘制始终使用WGS84坐标）
        const coordSys = (document.getElementById('coordSysSelect') && document.getElementById('coordSysSelect').value) || 'wgs84';

        // 统一转换为WGS84用于绘制与面积计算
        function toWgs(point){
            const lng = point[0], lat = point[1];
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                return [lng, lat];
            } else if (coordSys === 'gcj02') {
                const w = gcj02ToWgs84(lng, lat);
                return [w.lng, w.lat];
            } else if (coordSys === 'bd09') {
                const gcj = bd09ToGcj02(lng, lat);
                const w = gcj02ToWgs84(gcj.lng, gcj.lat);
                return [w.lng, w.lat];
            }
            return [lng, lat];
        }
        const coordsWGS84 = polygonCoords.map(ring => ring.map(toWgs));
        let outerRingWGS = coordsWGS84[0] || [];

        // 生成用于绘制的坐标（直接使用WGS84坐标）
        const rings = coordsWGS84.map(ring => ring.map(([lng, lat]) => new T.LngLat(lng, lat)));


         // 创建半透明填充的多边形（无边框）
          const polygon = new T.Polygon(rings, {
              color: currentOutlineColor,
              weight: 1,
              opacity: 1,
              fillColor: currentFillColor,
              fillOpacity: currentFillOpacity
          });
 
          // 使用WGS84坐标计算面积（更准确的面积计算）
         let areaSqm;
         let areaMu;



         try {
             // 检查Turf.js是否可用
             if (typeof turf !== 'undefined' && turf.area) {
                 // 使用Turf.js计算多边形面积
                // 构造GeoJSON格式的多边形
                const geoJsonPolygon = {
                    type: "Polygon",
                    coordinates: coordsWGS84
                };


                 // 使用Turf.js计算面积（平方米）
                 areaSqm = turf.area(geoJsonPolygon);
                 areaMu = (areaSqm / 666.6667).toFixed(4); // 转换为亩
                 console.log(`多边形${actualPolygonIndex}面积计算结果(Turf.js): ${areaSqm}平方米 = ${areaMu}亩`);
             } else {
                 // 如果Turf.js不可用，回退到之前的计算方法
                 console.warn('Turf.js不可用，使用备用计算方法');
                 // 计算带孔洞的多边形面积
                 areaSqm = 0;
                 // 计算外环面积
                 outerRingWGS = coordsWGS84[0] || [];
                 areaSqm += calculatePolygonArea(outerRingWGS);

                 // 减去内环（孔洞）面积
                 for (let i = 1; i < coordsWGS84.length; i++) {
                     const innerRingArea = calculatePolygonArea(coordsWGS84[i]);
                     areaSqm -= innerRingArea;
                 }

                  areaMu = (areaSqm / 666.6667).toFixed(4); // 使用更精确的转换系数
                  console.log(`多边形${actualPolygonIndex}面积计算结果(备用): ${areaSqm}平方米 = ${areaMu}亩`);
              }
          } catch (error) {
              console.error(`面积计算失败:`, error);
              areaSqm = 0;
              areaMu = '0.0000';
          }

          // 计算多边形的中心点和底部中心点（WGS84）
          const centerPoint = calculatePolygonCenter(outerRingWGS);
          const bottomCenterPoint = calculatePolygonBottomCenter(outerRingWGS);

          // 添加多边形到地图
          if (map) {
              map.addOverLay(polygon);
              console.log(`多边形${actualPolygonIndex}已添加到地图`);
          } else {
              console.error('地图对象不存在');
          }

          // 存储多边形信息，用于后续标签创建
          polygonInfoList.push({
              index: actualPolygonIndex,
              polygon: polygon,
              area: areaMu,
              bottomCenter: { lng: bottomCenterPoint.lng, lat: bottomCenterPoint.lat },
              ringPoints: rings
          });
      }

    // 视图居中：根据已绘制的GCJ-02点
    function fitViewportToPolygons() {
        const points = [];
        try {
            if (!map || !map.setViewport) return;
            polygonInfoList.forEach(info => {
                if (!info || !info.ringPoints) return;
                info.ringPoints.forEach(ring => {
                    ring.forEach(ll => points.push(ll));
                });
            });
            if (!points.length) return;
            map.setViewport(points);
        } catch (e) {
            try {
                const lngs = points.map(p => p.lng);
                const lats = points.map(p => p.lat);
                const center = new T.LngLat(
                    (Math.min(...lngs) + Math.max(...lngs)) / 2,
                    (Math.min(...lats) + Math.max(...lats)) / 2
                );
                if (map && map.panTo) map.panTo(center);
            } catch (e2) {
                console.warn('视图居中失败:', e2);
            }
        }
    }

    // 统一创建所有多边形的标签
    function createAllLabels() {
        const mapContainer = document.getElementById('mapContainer');
        if (!mapContainer || !map) return;

        polygonInfoList.forEach(info => {
            if (!info) return;
            // 防止重复创建
            if (info.labelRef) return;
            // 创建标签元素
            const labelDiv = document.createElement('div');
            labelDiv.className = 'area-label';
            labelDiv.innerHTML = `多边形${info.index}：${info.area}亩`;

            // 添加到地图容器并根据屏幕边界定位到轮廓下方
            mapContainer.appendChild(labelDiv);
            positionLabelForPolygon(labelDiv, info);

            // 记录引用，避免重复创建
            info.labelRef = labelDiv;

            // 存储到 currentPolygons 以复用现有定位/清理逻辑
            const labelObj = {
                domElement: labelDiv,
                isDomLabel: true,
                polygonInfo: info
            };
            currentPolygons.push({ polygon: info.polygon, label: labelObj });
        });

        // 不清空 polygonInfoList，便于开关随时创建/隐藏标签
    }

    // 根据多边形屏幕边界定位标签，保证始终在轮廓下方
    function positionLabelForPolygon(labelDiv, info) {
        if (!map || !info || !info.ringPoints) return;
        const points = [];
        info.ringPoints.forEach(ring => {
            ring.forEach(ll => {
                const p = map.lngLatToContainerPoint(ll);
                points.push(p);
            });
        });
        if (!points.length) return;
        const minX = Math.min(...points.map(p => p.x));
        const maxX = Math.max(...points.map(p => p.x));
        const maxY = Math.max(...points.map(p => p.y));
        const container = document.getElementById('mapContainer');
        const labelWidth = labelDiv.offsetWidth;
        const labelHeight = labelDiv.offsetHeight;
        const targetLeft = Math.round((minX + maxX) / 2 - labelWidth / 2);
        const targetTop = Math.round(maxY + 6);
        const clampedLeft = Math.max(0, Math.min(targetLeft, container.clientWidth - labelWidth));
        const clampedTop = Math.max(0, Math.min(targetTop, container.clientHeight - labelHeight));
        labelDiv.style.left = clampedLeft + 'px';
        labelDiv.style.top = clampedTop + 'px';
    }

    // 更新所有标签位置（地图move/zoom时调用）
    function updateAllLabelsPosition() {
        try {
            if (!map) return;
            const container = document.getElementById('mapContainer');
            if (!container) return;
            currentPolygons.forEach(item => {
                if (!item || !item.label) return;
                const labelObj = item.label;
                if (labelObj.isDomLabel && labelObj.domElement && labelObj.polygonInfo) {
                    // 确保标签在容器中
                    if (!labelObj.domElement.parentNode) {
                        container.appendChild(labelObj.domElement);
                    }
                    positionLabelForPolygon(labelObj.domElement, labelObj.polygonInfo);
                }
            });
        } catch (e) {
            console.warn('更新标签位置时出错:', e);
        }
    }
    // 确保在全局可用（处理第三方库事件回调作用域差异）
    window.updateAllLabelsPosition = updateAllLabelsPosition;

    // 绑定“显示亩数标签”开关（默认隐藏）
    function bindLabelsToggle() {
        const cb = document.getElementById('toggleLabelsCheckbox');
        const container = document.getElementById('mapContainer');
        if (!cb || !container) return;
        // 默认隐藏标签
        container.classList.add('labels-hidden');
        cb.addEventListener('change', () => {
            labelsEnabled = cb.checked;
            if (labelsEnabled) {
                container.classList.remove('labels-hidden');
                const hasAnyLabel = currentPolygons.some(item => item && item.label && item.label.domElement);
                if (!hasAnyLabel) {
                    try { createAllLabels(); } catch (e) { console.warn('创建标签失败:', e); }
                }
                updateAllLabelsPosition();
            } else {
                container.classList.add('labels-hidden');
            }
        });
    }

    /**
     * 计算多边形中心点（比底部中心更适合显示标签）
     */
    function calculatePolygonCenter(outerRing) {
        let sumLng = 0, sumLat = 0;
        const len = outerRing.length;

        for (let i = 0; i < len; i++) {
            sumLng += outerRing[i][0];
            sumLat += outerRing[i][1];
        }

        return {
            lng: sumLng / len,
            lat: sumLat / len
        };
    }

    /**
     * 计算多边形面积（球面多边形面积计算）
     * 使用更准确的球面坐标面积计算方法，确保面积与视觉大小一致
     */
    function calculatePolygonArea(coordinates) {
        // 地球半径（米）- 使用更精确的值
        const R = 6371000.8;
        const n = coordinates.length;

        // 将所有坐标转换为弧度
        const coordsRad = coordinates.map(point => [
            point[0] * Math.PI / 180,
            point[1] * Math.PI / 180
        ]);

        let areaRad = 0;

        // 使用更准确的球面多边形面积公式（Girard定理）
        for (let i = 0; i < n; i++) {
            const j = (i + 1) % n;
            const lon1 = coordsRad[i][0];
            const lat1 = coordsRad[i][1];
            const lon2 = coordsRad[j][0];
            const lat2 = coordsRad[j][1];

            // 计算球面多边形面积增量
            const dlon = lon2 - lon1;
            const sinLat1 = Math.sin(lat1);
            const sinLat2 = Math.sin(lat2);
            const cosLat1 = Math.cos(lat1);
            const cosLat2 = Math.cos(lat2);

            // 使用更精确的公式
            areaRad += dlon * (sinLat1 * cosLat2 * Math.cos(dlon / 2) + sinLat2 * cosLat1);
        }

        // 计算总面积（平方米）
        const areaSqm = Math.abs(areaRad) * R * R * 0.5;

        return areaSqm;
    }

    /**
     * 清空所有多边形和标签（同时处理 polygonInfoList 与 currentPolygons）
     */
    function clearOverlays() {
        try {
            // 先移除 polygonInfoList 中记录的多边形与其DOM标签
            polygonInfoList.forEach(info => {
                if (info && info.polygon && map && map.removeOverLay) {
                    try { map.removeOverLay(info.polygon); } catch (e) { console.warn('移除多边形失败:', e); }
                }
                if (info && info.labelRef && info.labelRef.parentNode) {
                    try { info.labelRef.parentNode.removeChild(info.labelRef); } catch (e) { console.warn('移除DOM标签失败:', e); }
                    info.labelRef = null;
                }
            });

            // 再处理 currentPolygons（兼容旧路径与标签对象）
            currentPolygons.forEach(item => {
                if (item.polygon && map && map.removeOverLay) {
                    try { map.removeOverLay(item.polygon); } catch (e) { console.warn('移除多边形失败:', e); }
                }
                if (item.label) {
                    if (item.label.domElement && item.label.domElement.parentNode) {
                        try { item.label.domElement.parentNode.removeChild(item.label.domElement); } catch (e) { console.warn('移除DOM标签失败:', e); }
                    } else if (map && map.removeOverLay && !item.label.isDomLabel) {
                        try { map.removeOverLay(item.label); } catch (e) { console.warn('移除地图覆盖物标签失败:', e); }
                    }
                }
            });

            // 清空记录数组
            currentPolygons = [];
            polygonInfoList = [];

            console.log('已清空所有多边形和标签（保留事件监听器）');
        } catch (error) {
            console.error('清空覆盖物时出错:', error);
        }
    }

    // 其他辅助函数（保持不变）
    function bindMinimizeEvent() {
        const container = document.querySelector(".wkt-input-container");
        const btn = document.getElementById("minimizeBtn");
        const minIcon = btn?.querySelector(".min-icon");
        const restoreIcon = btn?.querySelector(".restore-icon");

        btn?.addEventListener("click", () => {
            const minimized = container.classList.toggle("minimized");
            if (minIcon && restoreIcon) {
                if (minimized) {
                    minIcon.style.display = "none";
                    restoreIcon.style.display = "";
                } else {
                    minIcon.style.display = "";
                    restoreIcon.style.display = "none";
                }
            }
        });
    }

    // 在脚本内部补充：页签切换（3个页签）
     function bindTabs() {
         const tabs = [
             { btn: document.getElementById('tabDrawBtn'), pane: document.getElementById('tabDraw'), key: 'draw' },
             { btn: document.getElementById('tabTrackBtn'), pane: document.getElementById('tabTrack'), key: 'track' },
             { btn: document.getElementById('tabSplitBtn'), pane: document.getElementById('tabSplit'), key: 'split' },
             { btn: document.getElementById('tabBatchBtn'), pane: document.getElementById('tabBatch'), key: 'batch' },
         ];
         if (tabs.some(t => !t.btn || !t.pane)) return;
         function activate(key) {
             tabs.forEach(t => {
                 const active = t.key === key;
                 t.btn.classList.toggle('active', active);
                 t.pane.classList.toggle('active', active);
             });
         }
         tabs.forEach(t => t.btn.addEventListener('click', () => activate(t.key)));
         activate('draw');
     }
    function updateParserStatus() {
        const el = document.getElementById('parserStatus');
        if (!el) return;
        const ok = (typeof Terraformer !== 'undefined' && Terraformer.WKT && typeof Terraformer.WKT.parse === 'function');
        if (ok) {
            el.textContent = 'Terraformer WKT Parser';
            el.style.color = '#2f8f2f';
        } else {
            el.textContent = '本地回退解析（仅支持POLYGON/MULTIPOLYGON）';
            el.style.color = '#c77d1e';
        }
    }
     function parseWkt(wkt) {
         wkt = wkt.trim();
         // 优先使用成熟库（Terraformer WKT Parser）
         if (typeof Terraformer !== 'undefined' && Terraformer.WKT && Terraformer.WKT.parse) {
             try {
                 return Terraformer.WKT.parse(wkt);
             } catch (e) {
                 console.warn('Terraformer解析失败，尝试本地回退解析:', e);
             }
         } else {
             // 不再提示“未加载”，由状态栏展示回退信息
         }
         // 回退解析：仅支持 POLYGON / MULTIPOLYGON
         const typeMatch = wkt.match(/^\s*(POLYGON|MULTIPOLYGON)\s*\(/i);
         if (!typeMatch) throw new Error('仅支持POLYGON/MULTIPOLYGON');
         const type = typeMatch[1].toUpperCase();
         const inner = wkt.substring(wkt.indexOf('('));
         if (type === 'POLYGON') {
             const coords = parsePolygonCoords(inner.replace(/^\(/, '').replace(/\)$/, ''));
             return { type: 'Polygon', coordinates: coords };
         } else {
             const trimmed = inner.replace(/^\(\(/, '').replace(/\)\)$/, '');
             const coords = parseMultiPolygonCoords(trimmed);
             return { type: 'MultiPolygon', coordinates: coords };
         }
     }

     function bindMultiSplitter() {
         const input = document.getElementById('multiInput');
         const output = document.getElementById('polyOutput');
         const splitBtn = document.getElementById('splitMultiBtn');
         const copyBtn = document.getElementById('copyPolysBtn');
         if (!input || !output || !splitBtn || !copyBtn) return;

         // 本地WKT序列化辅助
         function ringToText(ring) {
             if (!ring || !ring.length) return '()';
             const first = ring[0];
             const last = ring[ring.length - 1];
             const closed = (first[0] === last[0] && first[1] === last[1]) ? ring : ring.concat([[first[0], first[1]]]);
             return '(' + closed.map(pt => pt[0] + ' ' + pt[1]).join(', ') + ')';
         }
         function toWktPolygonCoords(coords) {
             return 'POLYGON(' + coords.map(ringToText).join(', ') + ')';
         }
         function toWktMulti(coords) {
             return 'MULTIPOLYGON(' + coords.map(poly => '(' + poly.map(ringToText).join(', ') + ')').join(', ') + ')';
         }

         function polygonsFromMulti(text) {
             const geo = parseWkt(text.trim());
             if (geo.type !== 'MultiPolygon') throw new Error('请输入有效的 MULTIPOLYGON WKT');
             const polys = geo.coordinates.map(rings => toWktPolygonCoords(rings));
             return polys;
         }
         splitBtn.addEventListener('click', () => {
             try {
                 const list = polygonsFromMulti(input.value.trim());
                 output.value = list.join('\n');
             } catch (e) {
                 alert('分割失败：' + e.message);
             }
         });
         copyBtn.addEventListener('click', async () => {
             const val = output.value.trim();
             if (!val) { alert('没有可复制的结果'); return; }
             try { await navigator.clipboard.writeText(val); alert('已复制到剪贴板'); } catch (e) { console.warn('复制失败', e); }
         });
     }

     function bindBatchGenerator() {
         const batchInput = document.getElementById('batchInput');
         const output = document.getElementById('multiOutput');
         const genBtn = document.getElementById('generateMultiBtn');
         const copyBtn = document.getElementById('copyMultiBtn');

         // 本地WKT序列化辅助（与分割器保持一致）
         function ringToText(ring) {
             if (!ring || !ring.length) return '()';
             const first = ring[0];
             const last = ring[ring.length - 1];
             const closed = (first[0] === last[0] && first[1] === last[1]) ? ring : ring.concat([[first[0], first[1]]]);
             return '(' + closed.map(pt => pt[0] + ' ' + pt[1]).join(', ') + ')';
         }
         function toWktMulti(coords) {
             return 'MULTIPOLYGON(' + coords.map(poly => '(' + poly.map(ringToText).join(', ') + ')').join(', ') + ')';
         }

         genBtn.addEventListener('click', () => {
             try {
                 const lines = batchInput.value.trim().split(/\n|;/).map(s => s.trim()).filter(Boolean);
                 if (lines.length === 0) throw new Error('请按每行或分号输入至少一个POLYGON');
                 const polygons = lines.map((line, idx) => {
                     const g = parseWkt(line);
                     if (g.type !== 'Polygon') throw new Error(`第${idx + 1}行不是有效的POLYGON WKT`);
                     return g;
                 });
                 const multiGeo = { type: 'MultiPolygon', coordinates: polygons.map(p => p.coordinates) };
                 output.value = toWktMulti(multiGeo.coordinates);
             } catch (e) {
                 alert('生成失败：' + e.message);
             }
         });

         copyBtn.addEventListener('click', async () => {
             const val = output.value.trim();
             if (!val) { alert('没有可复制的结果'); return; }
             try { await navigator.clipboard.writeText(val); alert('已复制到剪贴板'); } catch (e) { console.warn('复制失败', e); }
         });

     }

     function setExampleWkt() {
         const exampleWkt = "MULTIPOLYGON(" +
             "(" +
             "(116.35 39.93, 116.39 39.93, 116.39 39.90, 116.35 39.90, 116.35 39.93)," + // 外环
             "(116.36 39.92, 116.38 39.92, 116.38 39.91, 116.36 39.91, 116.36 39.92)" +  // 内环
             ")," +
             "(" +
             "(116.40 39.95, 116.43 39.97, 116.46 39.96, 116.49 39.98, 116.52 39.95, 116.55 39.93, 116.58 39.94, 116.61 39.92, 116.64 39.95, 116.40 39.95)" +
             ")" +
             ")";
         document.getElementById("wktTextarea").value = exampleWkt;
     }

     function parsePolygonCoords(coordStr) {
         const ringStrs = coordStr.split(/\)\s*,\s*\(/).map(s => s.replace(/[()]/g, '').trim());
         const rings = [];
         ringStrs.forEach(ringStr => {
             const pts = ringStr.split(/,\s*/).map(pointStr => {
                 const [lng, lat] = pointStr.split(/\s+/).map(Number);
                 if (isNaN(lng) || isNaN(lat)) throw new Error("坐标格式错误：" + pointStr);
                 return [lng, lat];
             });
             // 自动拆分：如果一个ring中包含多次回到起点（闭合），则拆分为多个环
             // 兼容用户将外环与内环错误地写在同一对括号中的情况
             let start = 0;
             while (start < pts.length) {
                 const startPt = pts[start];
                 let closeIdx = -1;
                 for (let i = start + 1; i < pts.length; i++) {
                     if (pts[i][0] === startPt[0] && pts[i][1] === startPt[1]) {
                         closeIdx = i;
                         break;
                     }
                 }
                 if (closeIdx === -1) {
                     // 未找到闭合：将剩余点视为一个环，并强制闭合
                     const ring = pts.slice(start);
                     if (ring.length && (ring[0][0] !== ring[ring.length - 1][0] || ring[0][1] !== ring[ring.length - 1][1])) {
                         ring.push([ring[0][0], ring[0][1]]);
                     }
                     rings.push(ring);
                     break;
                 } else {
                     const ring = pts.slice(start, closeIdx + 1);
                     rings.push(ring);
                     start = closeIdx + 1;
                 }
             }
         });
         return rings;
     }

     function parseMultiPolygonCoords(coordStr) {
         const polygonStrs = coordStr.split(/\)\s*\)\s*,\s*\(\s*\(/).map(s => s.replace(/[()]/g, '').trim());
         return polygonStrs.map(polygonStr => parsePolygonCoords(polygonStr));
     }

     function wgs84ToGcj02(lng, lat) {
         const x_PI = 3.14159265358979324 * 3000.0 / 180.0;
         const PI = 3.1415926535897932384626;
         const a = 6378245.0;
         const ee = 0.00669342162296594323;

         if (outOfChina(lng, lat)) return { lng, lat };

         let dlat = transformLat(lng - 105.0, lat - 35.0);
         let dlng = transformLng(lng - 105.0, lat - 35.0);
         const radlat = lat / 180.0 * PI;
         let magic = Math.sin(radlat);
         magic = 1 - ee * magic * magic;
         const sqrtmagic = Math.sqrt(magic);
         dlat = (dlat * 180.0) / ((a * (1 - ee)) / (magic * sqrtmagic) * PI);
         dlng = (dlng * 180.0) / (a / sqrtmagic * Math.cos(radlat) * PI);

         return { lng: lng + dlng, lat: lat + dlat };

         function outOfChina(lng, lat) {
             return (lng < 72.004 || lng > 137.8347) || (lat < 0.8293 || lat > 55.8271);
         }

         function transformLat(x, y) {
             let ret = -100.0 + 2.0 * x + 3.0 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * Math.sqrt(Math.abs(x));
             ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
             ret += (20.0 * Math.sin(y * PI) + 40.0 * Math.sin(y / 3.0 * PI)) * 2.0 / 3.0;
             ret += (160.0 * Math.sin(y / 12.0 * PI) + 320 * Math.sin(y * PI / 30.0)) * 2.0 / 3.0;
             return ret;
         }

         function transformLng(x, y) {
             let ret = 300.0 + x + 2.0 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * Math.sqrt(Math.abs(x));
             ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
             ret += (20.0 * Math.sin(x * PI) + 40.0 * Math.sin(x / 3.0 * PI)) * 2.0 / 3.0;
             ret += (150.0 * Math.sin(x / 12.0 * PI) + 300.0 * Math.sin(x / 30.0 * PI)) * 2.0 / 3.0;
             return ret;
         }
     }

     function gcj02ToWgs84(lng, lat) {
         const g = wgs84ToGcj02(lng, lat);
         return { lng: lng * 2 - g.lng, lat: lat * 2 - g.lat };
     }

     function bd09ToGcj02(bdLng, bdLat) {
         const x_PI = 3.14159265358979324 * 3000.0 / 180.0;
         const x = bdLng - 0.0065;
         const y = bdLat - 0.006;
         const z = Math.sqrt(x * x + y * y) - 0.00002 * Math.sin(y * x_PI);
         const theta = Math.atan2(y, x) - 0.000003 * Math.cos(x * x_PI);
         const ggLng = z * Math.cos(theta);
         const ggLat = z * Math.sin(theta);
         return { lng: ggLng, lat: ggLat };
     }

     function calculatePolygonBottomCenter(outerRing) {
         let minLat = Infinity;
         let bottomPoints = [];
         outerRing.forEach(point => {
             const lat = point[1];
             if (lat < minLat) {
                 minLat = lat;
                 bottomPoints = [point];
             } else if (lat === minLat) {
                 bottomPoints.push(point);
             }
         });

         const sumLng = bottomPoints.reduce((sum, point) => sum + point[0], 0);
         const centerLng = sumLng / bottomPoints.length;

         return { lng: centerLng, lat: minLat };
     }

     function fitBounds(geojson) {
         try {
             const allPoints = [];
             function collectPoints(coords) {
                 if (typeof coords[0] === 'number') {
                     allPoints.push(coords);
                 } else {
                     coords.forEach(coord => collectPoints(coord));
                 }
             }
             collectPoints(geojson.coordinates);

             if (allPoints.length === 0) return;

             const lats = allPoints.map(p => p[1]);
             const lngs = allPoints.map(p => p[0]);
             const minLng = Math.min(...lngs);
             const maxLng = Math.max(...lngs);
             const minLat = Math.min(...lats);
             const maxLat = Math.max(...lats);

             const sw = wgs84ToGcj02(minLng, minLat);
             const ne = wgs84ToGcj02(maxLng, maxLat);

             // 修复setViewport方法的使用，确保参数格式正确
             if (map && map.setViewport) {
                 map.setViewport([
                     new T.LngLat(sw.lng, sw.lat),
                     new T.LngLat(ne.lng, ne.lat)
                 ], { padding: [50, 50] });
             } else {
                 console.warn('地图对象或setViewport方法不可用');
             }
         } catch (error) {
             console.error('调整视图范围时出错:', error);
         }
     }
// 轨迹绘制与解析
    function bindTrackEvents() {
        const drawBtn = document.getElementById('drawTrackButton');
        const showPointsBtn = document.getElementById('showTrackPointsButton');
        const clearBtn = document.getElementById('clearTrackButton');
        const ta = document.getElementById('trackTextarea');
        if (!drawBtn || !showPointsBtn || !clearBtn || !ta) return;

        drawBtn.addEventListener('click', function(){
            try {
                const text = ta.value.trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const points = parseTrackText(text);
                if (points.length < 2) { alert('有效轨迹点不足，至少需要两点'); return; }
                drawTrackFromPoints(points);
                fitViewportToTrack(points);
            } catch (e) {
                alert('绘制轨迹失败：' + (e && e.message ? e.message : e));
                console.error('绘制轨迹异常:', e);
            }
        });

        showPointsBtn.addEventListener('click', function(){
            try {
                const text = ta.value.trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const points = parseTrackText(text);
                if (points.length === 0) { alert('未找到有效轨迹点'); return; }
                showTrackPoints(points);
                fitViewportToTrack(points);
            } catch (e) {
                alert('显示轨迹点失败：' + (e && e.message ? e.message : e));
                console.error('显示轨迹点异常:', e);
            }
        });

        clearBtn.addEventListener('click', function(){
            clearTrackOverlays();
            console.log('已清空轨迹');
        });
    }

    function showTrackPoints(points) {
        // 先移除旧轨迹（不影响轮廓）
        clearTrackOverlays(false);
        
        if (!map || !points || points.length === 0) {
            console.log('无轨迹点可显示');
            return;
        }
        
        console.log(`准备显示${points.length}个轨迹点`);
        
        // 使用批量处理和更小的图标来提高性能
        // 创建一个更小的自定义颜色点SVG图标
        const smallColoredDotIcon = new T.Icon({
            iconUrl: `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1" height="1"><circle cx="0.5" cy="0.5" r="0.3" fill="%23${currentTrackPointColor.substring(1)}"/></svg>`,
            iconSize: new T.Point(1, 1),
            iconAnchor: new T.Point(0.5, 0.5)
        });
        
        // 优化批量添加点的速度
        const batchSize = 2000; // 增加每批处理的点数
        const concurrentBatches = 4; // 并发批次数量
        
        // 预创建点击事件处理函数，避免重复创建
        function createClickHandler(point, index) {
            return function() {
                const infoWindow = new T.InfoWindow({
                    content: `点${index + 1}<br/>经度: ${point.lng.toFixed(6)}<br/>纬度: ${point.lat.toFixed(6)}`,
                    offset: new T.Point(0, -20)
                });
                infoWindow.open(map, point);
            };
        }
        
        // 使用setTimeout实现更高效的批量添加，避免阻塞UI
        let currentIndex = 0;
        
        function addBatch() {
            if (currentIndex >= points.length) {
                console.log(`已显示${points.length}个轨迹点`);
                return;
            }
            
            // 添加当前批次的点
            const endIndex = Math.min(currentIndex + batchSize, points.length);
            const markersToAdd = [];
            
            // 先创建所有标记
            for (let i = currentIndex; i < endIndex; i++) {
                const point = points[i];
                const index = i;
                
                const marker = new T.Marker(point, {
                    icon: smallColoredDotIcon
                });
                
                // 添加点击事件
                marker.addEventListener('click', createClickHandler(point, index));
                
                markersToAdd.push(marker);
            }
            
            // 批量添加到地图和数组
            markersToAdd.forEach(marker => {
                map.addOverLay(marker);
                currentTracks.push(marker);
            });
            
            currentIndex = endIndex;
            
            // 使用setTimeout而不是requestAnimationFrame，减少对渲染周期的依赖
            // 设置为0，将任务放入微任务队列，但允许UI有短暂的呼吸空间
            setTimeout(addBatch, 0);
        }
        
        // 启动批量添加
        addBatch();
    }
    
    // 恢复原始的clearTrackOverlays函数
    function clearTrackOverlays(resetArray = true){        
        try {
            currentTracks.forEach(pl => {
                if (pl && map && map.removeOverLay) {
                    try { map.removeOverLay(pl); } catch (e) { console.warn('移除轨迹失败:', e); }
                }
            });
            if (resetArray) currentTracks = [];
        } catch (e) {
            console.warn('清空轨迹时出错:', e);
        }
    }

    function parseTrackText(text){
        // 选择输入坐标系（优先使用轨迹页签专属选择器，若未设置则回退到绘制页签选择器）
        const coordSysEl = document.getElementById('trackCoordSysSelect') || document.getElementById('coordSysSelect');
        const coordSys = (coordSysEl && coordSysEl.value) || 'wgs84';
        const isHash = text.indexOf('#') !== -1;
        const items = isHash ? text.split('#') : text.split(/\r?\n/);
        const pts = [];
        for (let i=0;i<items.length;i++){
            const raw = items[i];
            if (!raw) continue;
            const line = raw.trim();
            if (!line) continue;
            const parts = line.split(',');
            if (parts.length < 3) continue;
            let lng = parseFloat((parts[isHash ? 0 : 1] || '').trim());
            let lat = parseFloat((parts[isHash ? 1 : 2] || '').trim());
            // 初步过滤：数值合法性与正常范围
            if (!isFinite(lng) || !isFinite(lat)) continue;
            if (lng === 0 || lat === 0) continue; // 丢弃0.0异常点
            if (lng < -180 || lng > 180 || lat < -90 || lat > 90) continue; // 超出经纬度范围丢弃

            // 将输入坐标转换为WGS84
            let w;
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                w = { lng, lat };
            } else if (coordSys === 'gcj02') {
                w = gcj02ToWgs84(lng, lat);
            } else if (coordSys === 'bd09') {
                const g = bd09ToGcj02(lng, lat);
                w = gcj02ToWgs84(g.lng, g.lat);
            } else {
                w = { lng, lat };
            }
            // 转换结果兜底检查
            if (!isFinite(w.lng) || !isFinite(w.lat)) continue;
            if (w.lng < -180 || w.lng > 180 || w.lat < -90 || w.lat > 90) continue;

            // 使用WGS84坐标绘制到地图
            pts.push(new T.LngLat(w.lng, w.lat));
        }
        return pts;
    }

    function drawTrackFromPoints(points){
        // 先移除旧轨迹（不影响轮廓）
        clearTrackOverlays(false);
        const polyline = new T.Polyline(points, {
            color: currentTrackLineColor,
            weight: 1,
            opacity: 0.9
        });
        if (map) {
            map.addOverLay(polyline);
        }
        currentTracks.push(polyline);
    }

    function clearTrackOverlays(resetArray = true){
        try {
            currentTracks.forEach(pl => {
                if (pl && map && map.removeOverLay) {
                    try { map.removeOverLay(pl); } catch (e) { console.warn('移除轨迹失败:', e); }
                }
            });
            if (resetArray) currentTracks = [];
        } catch (e) {
            console.warn('清空轨迹时出错:', e);
        }
    }


    function fitViewportToTrack(points){
        try {
            if (!map || !map.setViewport || !points || !points.length) return;
            map.setViewport(points);
        } catch (e) {
            console.warn('轨迹视图居中失败:', e);
        }
    }

    // ========= 轨迹回放功能 =========
    let playbackState = { points: [], idx: 0, speed: 1, timer: null, running: false, marker: null, line: null, path: [] };

    function bindPlaybackControls(){
        const startBtn = document.getElementById('playbackStartBtn');
        const pauseBtn = document.getElementById('playbackPauseBtn');
        const stopBtn = document.getElementById('playbackStopBtn');
        const speedSel = document.getElementById('playbackSpeedSelect');
        const timeSlider = document.getElementById('playbackTimeSlider');
        const timeCursor = document.getElementById('playbackTimeCursor');
        const ta = document.getElementById('trackTextarea');
        if (!startBtn || !pauseBtn || !stopBtn || !speedSel) return;

        // 初始按钮状态
        updatePlaybackButtonsState('idle');

        startBtn.addEventListener('click', function(){
            try {
                const text = (ta && ta.value || '').trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const pts = parseTrackTextWithTime(text);
                if (pts.length < 2) { alert('有效轨迹点不足，至少需要两点'); return; }
                startPlayback(pts);
                // 状态在startPlayback中已设置为playing
            } catch (e) {
                alert('开始回放失败：' + (e && e.message ? e.message : e));
                console.error('开始回放异常:', e);
            }
        });

        pauseBtn.addEventListener('click', function(){
            if (!playbackState.running) {
                // 继续
                playbackState.running = true;
                scheduleNext();
                updatePlaybackButtonsState('playing');
            } else {
                // 暂停
                if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
                playbackState.running = false;
                updatePlaybackButtonsState('paused');
            }
        });

        stopBtn.addEventListener('click', function(){ 
            stopPlayback(); 
            updatePlaybackButtonsState('idle');
        });

        speedSel.addEventListener('change', function(){
            const v = parseFloat(speedSel.value);
            playbackState.speed = (isFinite(v) && v > 0) ? v : 1;
        });

        if (timeSlider) {
            timeSlider.addEventListener('input', function(){
                const ms = parseInt(timeSlider.value, 10);
                const txt = formatTimeForLabel(ms);
                if (timeCursor) timeCursor.textContent = txt;
            });
            timeSlider.addEventListener('change', function(){
                jumpToSliderTime();
            });
        }
    }

    function parseTrackTextWithTime(text){
        const coordSysEl = document.getElementById('trackCoordSysSelect') || document.getElementById('coordSysSelect');
        const coordSys = (coordSysEl && coordSysEl.value) || 'wgs84';
        const isHash = text.indexOf('#') !== -1;
        const items = isHash ? text.split('#') : text.split(/\r?\n/);
        const out = [];
        for (let i=0;i<items.length;i++){
            const raw = items[i];
            if (!raw) continue;
            const line = raw.trim();
            if (!line) continue;
            const parts = line.split(',');
            if (parts.length < 3) continue;
            const tsRaw = (parts[isHash ? 2 : 0] || '').trim();
            const ts = (tsRaw || '').replace(/\D/g,'');
            let lng = parseFloat((parts[isHash ? 0 : 1] || '').trim());
            let lat = parseFloat((parts[isHash ? 1 : 2] || '').trim());
            if (!isFinite(lng) || !isFinite(lat)) continue;
            if (lng === 0 || lat === 0) continue;
            if (lng < -180 || lng > 180 || lat < -90 || lat > 90) continue;
            const t = parseTimestamp(ts);
            if (!t) continue;
            let w;
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                w = { lng, lat };
            } else if (coordSys === 'gcj02') {
                w = gcj02ToWgs84(lng, lat);
            } else if (coordSys === 'bd09') {
                const g = bd09ToGcj02(lng, lat);
                w = gcj02ToWgs84(g.lng, g.lat);
            } else { w = { lng, lat }; }
            if (!isFinite(w.lng) || !isFinite(w.lat)) continue;
            if (w.lng < -180 || w.lng > 180 || w.lat < -90 || w.lat > 90) continue;
            out.push({ ll: new T.LngLat(w.lng, w.lat), time: t, ts });
        }
        out.sort((a,b)=>a.time - b.time);
        return out;
    }

    function parseTimestamp(ts){
        const tstr = (ts || '').replace(/\D/g,'');
        const m = tstr && tstr.match(/^\d{14}$/);
        if (!m) return null;
        const y = parseInt(tstr.slice(0,4),10);
        const M = parseInt(tstr.slice(4,6),10) - 1;
        const d = parseInt(tstr.slice(6,8),10);
        const h = parseInt(tstr.slice(8,10),10);
        const m2 = parseInt(tstr.slice(10,12),10);
        const s = parseInt(tstr.slice(12,14),10);
        const dt = new Date(y,M,d,h,m2,s);
        return isNaN(dt.getTime()) ? null : dt;
    }

    function startPlayback(points){
        console.log('[Playback] startPlayback: 点数=', points && points.length);
        stopPlayback();
        playbackState.points = points;
        playbackState.idx = 0;
        playbackState.speed = playbackState.speed || 1;
        playbackState.running = true;
        // 配置时间滑动条，并尊重现有滑块位置作为起始
        configureTimeSlider(points);
        // 启用滑块
        const slider = document.getElementById('playbackTimeSlider');
        if (slider) slider.disabled = false;
        let initIdx = 0;
        if (slider && slider.min && slider.max) {
            const ms = parseInt(slider.value, 10);
            if (isFinite(ms)) initIdx = findIndexByTime(points, ms);
        }
        playbackState.idx = initIdx;
        const first = points[initIdx];
        console.log('[Playback] 首点:', first && first.ts, first && first.ll, 'initIdx=', initIdx);
        playbackState.path = points.slice(0, initIdx+1).map(p=>p.ll);
        playbackState.line = new T.Polyline(playbackState.path, { color: currentTrackLineColor, weight: 1, opacity: 0.9 });
        if (map) {
            map.addOverLay(playbackState.line);
        }
        currentTracks.push(playbackState.line);
        // 创建并定位DOM标记以保证可见移动
        ensurePlaybackDom(first.ll);
        updatePlaybackDom(first.ll);
        updatePlaybackTimeLabel(first.ts);
        try { fitViewportToTrack(points.map(p=>p.ll)); } catch(e){}
        // 更新按钮状态
        updatePlaybackButtonsState('playing');
        scheduleNext();
    }

    function scheduleNext(){
        if (!playbackState.running) return;
        if (!playbackState.points || playbackState.idx >= playbackState.points.length - 1) {
            playbackState.running = false;
            console.log('[Playback] 回放结束：idx=', playbackState.idx, '点数=', playbackState.points ? playbackState.points.length : 0);
            updatePlaybackButtonsState('idle'); // 播放结束后按钮回到初始状态：开始可点，继续/结束灰化
            return;
        }
        const next = playbackState.points[playbackState.idx+1];
        const speed = playbackState.speed || 1;
        const delay = Math.max(4, Math.round(1000 / speed)); // 1x=1000ms/点，2x=500ms/点...
        console.log('[Playback] scheduleNext: idx=', playbackState.idx, '->', playbackState.idx+1, 'delay=', delay, 'speed=', speed);
        playbackState.timer = setTimeout(()=>{
            playbackState.idx++;
            const nextLL = next.ll;
            console.log('[Playback] 下一点:', next && next.ts, nextLL);
            try {
                // 维护路径数组
                playbackState.path = playbackState.path || [];
                playbackState.path.push(nextLL);
                console.log('[Playback] 路径长度=', playbackState.path.length);
                // 使用DOM标记进行移动（容器/图层坐标）
                if (!playbackDom.el) console.log('[Playback] DOM标记不存在，将尝试创建');
                updatePlaybackDom(nextLL);
                // 折线更新：优先setLngLats，兜底重建
                if (playbackState.line && typeof playbackState.line.setLngLats === 'function') {
                    try { playbackState.line.setLngLats(playbackState.path); }
                    catch(e){
                        console.warn('[Playback] setLngLats失败，重建折线', e);
                        if (map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                        playbackState.line = new T.Polyline(playbackState.path, { color: currentTrackLineColor, weight: 1, opacity: 0.9 });
                        if (map) map.addOverLay(playbackState.line);
                    }
                } else {
                    console.log('[Playback] 折线不支持setLngLats，重建');
                    if (playbackState.line && map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                    playbackState.line = new T.Polyline(playbackState.path, { color: currentTrackLineColor, weight: 1, opacity: 0.9 });
                    if (map) map.addOverLay(playbackState.line);
                }
            } catch(e) { console.warn('更新回放覆盖物失败:', e); }
            updatePlaybackTimeLabel(next.ts);
            scheduleNext();
        }, delay);
    }

    function stopPlayback(){
        if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
        playbackState.running = false;
        playbackState.idx = 0;
        try {
            // 移除DOM标记
            removePlaybackDom();
            if (playbackState.marker && map) map.removeOverLay(playbackState.marker);
            if (playbackState.line && map) map.removeOverLay(playbackState.line);
        } catch(e){}
        playbackState.marker = null;
        playbackState.line = null;
        updatePlaybackTimeLabel('—');
        // 按钮回到初始状态
        updatePlaybackButtonsState('idle');
    }

    function updatePlaybackTimeLabel(text){
        const el = document.getElementById('playbackTimeLabel');
        if (el) el.textContent = '时间：' + (text || '—');
    }

    // 时间滑动条：配置与跳转
    function configureTimeSlider(points){
        try {
            const slider = document.getElementById('playbackTimeSlider');
            const cursor = document.getElementById('playbackTimeCursor');
            if (!slider || !points || !points.length) return;
            const minMs = points[0].time.getTime();
            const maxMs = points[points.length - 1].time.getTime();
            const prev = parseInt(slider.value, 10);
            slider.min = String(minMs);
            slider.max = String(maxMs);
            slider.step = '1000'; // 以秒为步进
            let val = (isFinite(prev) && prev >= minMs && prev <= maxMs) ? prev : minMs;
            slider.value = String(val);
            if (cursor) cursor.textContent = formatTimeForLabel(val);
        } catch(e) { console.warn('配置时间滑动条失败:', e); }
    }
    function formatTimeForLabel(ms){
        if (!isFinite(ms)) return '—';
        const d = new Date(ms);
        const pad = n => String(n).padStart(2,'0');
        const y = d.getFullYear();
        const M = pad(d.getMonth()+1);
        const da = pad(d.getDate());
        const h = pad(d.getHours());
        const m = pad(d.getMinutes());
        const s = pad(d.getSeconds());
        return `${y}-${M}-${da} ${h}:${m}:${s}`;
    }
    function findIndexByTime(points, ms){
        try {
            if (!points || !points.length) return 0;
            const n = points.length;
            const minMs = points[0].time.getTime();
            const maxMs = points[n-1].time.getTime();
            if (!isFinite(ms)) return 0;
            if (ms <= minMs) return 0;
            if (ms >= maxMs) return n-1;
            let lo = 0, hi = n - 1, ans = 0;
            while (lo <= hi) {
                const mid = (lo + hi) >> 1;
                const t = points[mid].time.getTime();
                if (t < ms) { lo = mid + 1; ans = lo; }
                else { hi = mid - 1; ans = mid; }
            }
            return Math.max(0, Math.min(n-1, ans));
        } catch(e){ console.warn('findIndexByTime失败:', e); return 0; }
    }
    function jumpToSliderTime(){
        try {
            const slider = document.getElementById('playbackTimeSlider');
            if (!slider || !playbackState.points || !playbackState.points.length) return;
            const ms = parseInt(slider.value, 10);
            if (!isFinite(ms)) return;
            const idx = findIndexByTime(playbackState.points, ms);
            playbackState.idx = idx;
            const pts = playbackState.points;
            const ll = pts[idx].ll;
            playbackState.path = pts.slice(0, idx+1).map(p=>p.ll);
            // 更新折线
            try {
                if (playbackState.line && typeof playbackState.line.setLngLats === 'function') {
                    playbackState.line.setLngLats(playbackState.path);
                } else {
                    if (playbackState.line && map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                    playbackState.line = new T.Polyline(playbackState.path, { color: currentTrackLineColor, weight: 1, opacity: 0.9 });
                    if (map) map.addOverLay(playbackState.line);
                }
            } catch(e){ console.warn('滑块更新折线失败:', e); }
            // 更新标记与时间
            ensurePlaybackDom(ll);
            updatePlaybackDom(ll);
            updatePlaybackTimeLabel(pts[idx].ts);
            // 若正在播放，立即按新位置继续
            if (playbackState.running) {
                if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
                scheduleNext();
            }
        } catch(e) { console.warn('滑块跳转失败:', e); }
    }

    // DOM标记：使用容器坐标实现可见移动
    let playbackDom = { el: null, lastLL: null, bound: false };

    function ensurePlaybackDom(ll){
        try {
            playbackDom.lastLL = ll;
            const pane = (map && map.getPanes && map.getPanes().overlayPane) || document.getElementById('mapContainer');
            if (!pane) { console.warn('未找到overlayPane或mapContainer'); return; }
            if (!playbackDom.el) {
                const el = document.createElement('div');
                el.id = 'playbackDomMarker';
                el.style.position = 'absolute';
                el.style.width = '0';
                el.style.height = '0';
                el.style.borderLeft = '3px solid transparent';
                el.style.borderRight = '3px solid transparent';
                el.style.borderBottom = '4px solid #2C64A7';
                el.style.borderTop = '0';
                el.style.transform = 'translate(-50%, -50%)';
                el.style.zIndex = '9999';
                // 添加伪元素来增强箭头效果
                el.style.clipPath = 'polygon(50% 0, 100% 100%, 0 100%)';
                pane.appendChild(el);
                playbackDom.el = el;
                console.log('[Playback] 创建DOM标记，父节点=', pane === document.getElementById('mapContainer') ? '#mapContainer' : 'overlayPane');
                bindPlaybackDomEvents();
            }
            updatePlaybackDom(ll);
        } catch(e) { console.warn('创建DOM标记失败:', e); }
    }

    function updatePlaybackDom(ll){
        try {
            playbackDom.lastLL = ll;
            if (!map || !playbackDom.el || !ll) { console.log('[Playback] update取消：map/el/ll缺失'); return; }
            let p;
            if (typeof map.lngLatToLayerPoint === 'function') {
                p = map.lngLatToLayerPoint(ll);
                console.log('[Playback] 使用layerPoint定位:', ll && ll.lng, ll && ll.lat, '=>', p && p.x, p && p.y);
            } else if (typeof map.lngLatToContainerPoint === 'function') {
                p = map.lngLatToContainerPoint(ll);
                console.log('[Playback] 使用containerPoint定位:', ll && ll.lng, ll && ll.lat, '=>', p && p.x, p && p.y);
            } else {
                console.warn('地图对象不支持lngLat到像素坐标转换');
                return;
            }
            playbackDom.el.style.left = p.x + 'px';
            playbackDom.el.style.top = p.y + 'px';
        } catch(e) { console.warn('更新DOM标记位置失败:', e); }
    }

    function bindPlaybackDomEvents(){
        if (playbackDom.bound) return;
        const updater = function(){
            try {
                if (!map || !playbackDom.el || !playbackDom.lastLL) return;
                let p;
                if (typeof map.lngLatToLayerPoint === 'function') {
                    p = map.lngLatToLayerPoint(playbackDom.lastLL);
                } else if (typeof map.lngLatToContainerPoint === 'function') {
                    p = map.lngLatToContainerPoint(playbackDom.lastLL);
                }
                if (!p) return;
                playbackDom.el.style.left = p.x + 'px';
                playbackDom.el.style.top = p.y + 'px';
            } catch(e){}
        };
        try {
            map.addEventListener('move', updater);
            map.addEventListener('zoom', updater);
            playbackDom.bound = true;
        } catch(e){}
    }

    function removePlaybackDom(){
        try {
            const el = playbackDom.el;
            playbackDom.lastLL = null;
            if (el && el.parentNode) el.parentNode.removeChild(el);
        } catch(e){}
        playbackDom.el = null;
        playbackDom.bound = false;
    }

    // 测量功能相关变量
    let measureState = {
        isActive: false,
        mode: '', // 'distance' or 'area'
        points: [],
        tempLine: null,
        lines: [],
        markers: [],
        labels: [],
        polygon: null,
        areaLabel: null
    };

    // 绑定测量按钮事件
    function bindMeasureEvents() {
        const distanceBtn = document.getElementById('measureDistanceBtn');
        const areaBtn = document.getElementById('measureAreaBtn');
        
        if (distanceBtn) {
            distanceBtn.addEventListener('click', function() {
                startMeasureDistance();
            });
        }
        
        if (areaBtn) {
            areaBtn.addEventListener('click', function() {
                startMeasureArea();
            });
        }
    }

    // 绑定地图类型切换按钮事件
    function bindMapTypeEvent() {
        const mapTypeBtn = document.getElementById('mapTypeBtn');
        
        if (mapTypeBtn) {
            mapTypeBtn.addEventListener('click', function() {
                toggleMapType();
            });
        }
    }

    // 切换地图类型
    function toggleMapType() {
        if (!map) {
            alert('地图未初始化');
            return;
        }
        
        // 切换地图类型
        if (currentMapType === 'satellite') {
            // 切换到街道地图
            map.setMapType(TMAP_NORMAL_MAP);
            currentMapType = 'street';
            updateMapTypeButton('街道图');
        } else {
            // 切换到卫星地图
            map.setMapType(TMAP_SATELLITE_MAP);
            currentMapType = 'satellite';
            updateMapTypeButton('卫星图');
        }
    }

    // 更新地图类型按钮显示
    function updateMapTypeButton(typeName) {
        const mapTypeBtn = document.getElementById('mapTypeBtn');
        if (mapTypeBtn) {
            mapTypeBtn.innerHTML = `<span>${typeName}</span>`;
            mapTypeBtn.title = `当前：${typeName}，点击切换`;
        }
    }

    // 开始测距
    function startMeasureDistance() {
        if (!map) {
            alert('地图未初始化');
            return;
        }
        
        // 先移除所有可能存在的事件监听器
        try {
            map.removeEventListener('click', handleMapClick);
            map.removeEventListener('click', handleAreaMapClick);
            map.removeEventListener('mousemove', handleMouseMove);
            map.removeEventListener('mousemove', handleAreaMouseMove);
            map.removeEventListener('dblclick', finishMeasure);
            map.removeEventListener('dblclick', finishAreaMeasure);
        } catch(e) {
            console.log('移除事件监听器时出错:', e);
        }
        
        // 重置测量状态
        clearMeasureResult();
        
        // 设置测量状态为激活
        measureState.isActive = true;
        measureState.mode = 'distance'; // 设置为距离测量模式
        
        // 禁用其他按钮
        disableButtons(true);
        
        // 添加地图点击事件监听器
        map.addEventListener('click', handleMapClick);
        
        // 添加鼠标移动事件监听器
        map.addEventListener('mousemove', handleMouseMove);
        
        // 添加双击事件监听器结束测量
        map.addEventListener('dblclick', finishMeasure);
        
        console.log('测距功能已启动');
    }

    // 开始测面
    function startMeasureArea() {
        if (!map) {
            alert('地图未初始化');
            return;
        }
        
        // 先移除所有可能存在的事件监听器
        try {
            map.removeEventListener('click', handleMapClick);
            map.removeEventListener('click', handleAreaMapClick);
            map.removeEventListener('mousemove', handleMouseMove);
            map.removeEventListener('mousemove', handleAreaMouseMove);
            map.removeEventListener('dblclick', finishMeasure);
            map.removeEventListener('dblclick', finishAreaMeasure);
        } catch(e) {
            console.log('移除事件监听器时出错:', e);
        }
        
        // 重置测量状态
        clearMeasureResult();
        
        // 设置测量状态为激活
        measureState.isActive = true;
        measureState.mode = 'area'; // 设置为面积测量模式
        
        // 禁用其他按钮
        disableButtons(true);
        
        // 添加地图点击事件监听器
        map.addEventListener('click', handleAreaMapClick);
        
        // 添加鼠标移动事件监听器
        map.addEventListener('mousemove', handleAreaMouseMove);
        
        // 添加双击事件监听器结束测量
        map.addEventListener('dblclick', finishAreaMeasure);
        
        console.log('测面功能已启动');
    }

    // 处理地图点击事件
    function handleMapClick(event) {
        if (!measureState.isActive || measureState.mode !== 'distance') return;
        
        const point = event.lnglat;
        measureState.points.push(point);
        
        // 创建小圆点图标
        const smallDotIcon = new T.Icon({
            iconUrl: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8"><circle cx="4" cy="4" r="3" fill="%23FF0000" stroke="%23FFFFFF" stroke-width="1"/></svg>',
            iconSize: new T.Point(8, 8),
            iconAnchor: new T.Point(4, 4)
        });
        
        // 创建点标记
        const marker = new T.Marker(point, {icon: smallDotIcon});
        map.addOverLay(marker);
        measureState.markers.push(marker);
        
        // 如果不是第一个点，创建线段
        if (measureState.points.length > 1) {
            const prevPoint = measureState.points[measureState.points.length - 2];
            const line = new T.Polyline([prevPoint, point], {
                color: '#FF0000',
                weight: 3,
                opacity: 0.8
            });
            map.addOverLay(line);
            measureState.lines.push(line);
            
            // 计算距离并显示标签
            const distance = calculateDistance(prevPoint, point);
            showDistanceLabel(point, distance);
        }
        
        // 移除临时线
        if (measureState.tempLine) {
            map.removeOverLay(measureState.tempLine);
            measureState.tempLine = null;
        }
    }

    // 处理测面地图点击事件
    function handleAreaMapClick(event) {
        if (!measureState.isActive || measureState.mode !== 'area') return;
        
        const point = event.lnglat;
        measureState.points.push(point);
        
        // 创建小圆点图标（与测距功能一致）
        const smallDotIcon = new T.Icon({
            iconUrl: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8"><circle cx="4" cy="4" r="3" fill="%23FF0000" stroke="%23FFFFFF" stroke-width="1"/></svg>',
            iconSize: new T.Point(8, 8),
            iconAnchor: new T.Point(4, 4)
        });
        
        // 创建点标记
        const marker = new T.Marker(point, {icon: smallDotIcon});
        map.addOverLay(marker);
        measureState.markers.push(marker);
        
        // 移除之前的多边形
        if (measureState.polygon) {
            map.removeOverLay(measureState.polygon);
        }
        
        // 如果点数大于2，创建多边形
        if (measureState.points.length >= 3) {
            const polygon = new T.Polygon(measureState.points, {
                color: currentOutlineColor,
                weight: 3,
                opacity: 0.8,
                fillColor: currentFillColor,
                fillOpacity: currentFillOpacity
            });
            map.addOverLay(polygon);
            measureState.polygon = polygon;
            
            // 计算面积并显示标签
            const area = calculatePolygonArea(measureState.points);
            showAreaLabel(getPolygonCenter(measureState.points), area);
        }
        
        // 移除临时线
        if (measureState.tempLine) {
            map.removeOverLay(measureState.tempLine);
            measureState.tempLine = null;
        }
    }

    // 处理鼠标移动事件
    function handleMouseMove(event) {
        if (!measureState.isActive || measureState.mode !== 'distance' || measureState.points.length === 0) return;
        
        const lastPoint = measureState.points[measureState.points.length - 1];
        const currentPoint = event.lnglat;
        
        // 移除之前的临时线
        if (measureState.tempLine) {
            map.removeOverLay(measureState.tempLine);
        }
        
        // 创建新的临时线
        measureState.tempLine = new T.Polyline([lastPoint, currentPoint], {
            color: '#0000FF',
            weight: 2,
            opacity: 0.6,
            dashArray: [5, 5]
        });
        map.addOverLay(measureState.tempLine);
    }

    // 处理测面鼠标移动事件
    function handleAreaMouseMove(event) {
        if (!measureState.isActive || measureState.mode !== 'area' || measureState.points.length === 0) return;
        
        const firstPoint = measureState.points[0];
        const lastPoint = measureState.points[measureState.points.length - 1];
        const currentPoint = event.lnglat;
        
        // 移除之前的临时线
        if (measureState.tempLine) {
            map.removeOverLay(measureState.tempLine);
        }
        
        // 创建新的临时线（从最后一个点到当前点，再到第一个点形成闭合效果）
        const tempPoints = [lastPoint, currentPoint];
        if (measureState.points.length >= 2) {
            tempPoints.push(firstPoint);
        }
        
        measureState.tempLine = new T.Polyline(tempPoints, {
            color: '#0000FF',
            weight: 2,
            opacity: 0.6,
            dashArray: [5, 5]
        });
        map.addOverLay(measureState.tempLine);
    }

    // 结束测量
    function finishMeasure() {
        if (!measureState.isActive || measureState.mode !== 'distance') return;
        
        // 移除事件监听器
        map.removeEventListener('click', handleMapClick);
        map.removeEventListener('mousemove', handleMouseMove);
        map.removeEventListener('dblclick', finishMeasure);
        
        // 移除临时线
        if (measureState.tempLine) {
            map.removeOverLay(measureState.tempLine);
            measureState.tempLine = null;
        }
        
        // 显示总距离
        if (measureState.points.length > 1) {
            const totalDistance = calculateTotalDistance();
            showTotalDistanceLabel(totalDistance);
        }
        
        // 重置测量状态
        measureState.isActive = false;
        measureState.mode = '';
        
        // 恢复其他按钮
        disableButtons(false);
        
        console.log('测距功能已完成');
    }

    // 结束测面测量
    function finishAreaMeasure() {
        if (!measureState.isActive || measureState.mode !== 'area') return;
        
        // 移除事件监听器
        map.removeEventListener('click', handleAreaMapClick);
        map.removeEventListener('mousemove', handleAreaMouseMove);
        map.removeEventListener('dblclick', finishAreaMeasure);
        
        // 移除临时线
        if (measureState.tempLine) {
            map.removeOverLay(measureState.tempLine);
            measureState.tempLine = null;
        }
        
        // 如果点数大于等于3，创建最终多边形
        if (measureState.points.length >= 3) {
            // 移除之前的多边形
            if (measureState.polygon) {
                map.removeOverLay(measureState.polygon);
            }
            
            const polygon = new T.Polygon(measureState.points, {
                color: currentOutlineColor,
                weight: 3,
                opacity: 0.8,
                fillColor: currentFillColor,
                fillOpacity: currentFillOpacity
            });
            map.addOverLay(polygon);
            measureState.polygon = polygon;
            
            // 计算并显示总面积
            const area = calculatePolygonArea(measureState.points);
            showTotalAreaLabel(getPolygonCenter(measureState.points), area);
        } else {
            // 点数不足3个，移除所有标记
            clearMeasureResult();
        }
        
        // 重置测量状态
        measureState.isActive = false;
        measureState.mode = '';
        
        // 恢复其他按钮
        disableButtons(false);
        
        console.log('测面功能已完成');
    }

    // 计算两点间距离（米）
    function calculateDistance(point1, point2) {
        // 使用天地图提供的距离计算方法
        if (T.CRS && T.CRS.EPSG4326 && T.CRS.EPSG4326.distance) {
            return T.CRS.EPSG4326.distance(point1, point2);
        }
        
        // 如果没有提供，则使用球面距离公式
        const R = 6371000; // 地球半径（米）
        const dLat = (point2.lat - point1.lat) * Math.PI / 180;
        const dLon = (point2.lng - point1.lng) * Math.PI / 180;
        const a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(point1.lat * Math.PI / 180) * Math.cos(point2.lat * Math.PI / 180) * 
            Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    // 计算多边形面积（平方米）
    function calculatePolygonArea(points) {
        // 使用天地图提供的面积计算方法（如果可用）
        if (T.GeometryUtils && T.GeometryUtils.computeArea) {
            return T.GeometryUtils.computeArea(points);
        }
        
        // 如果没有提供，则使用球面多边形面积计算公式
        // 这里使用简单的平面近似计算，对于小面积比较准确
        if (points.length < 3) return 0;
        
        let area = 0;
        const n = points.length;
        
        for (let i = 0; i < n; i++) {
            const j = (i + 1) % n;
            area += points[i].lng * points[j].lat;
            area -= points[j].lng * points[i].lat;
        }
        
        area = Math.abs(area) / 2.0;
        
        // 转换为平方米（这是一个简化的近似值）
        // 更精确的计算需要考虑地球曲率
        const earthRadius = 6371000; // 地球半径（米）
        const degreeToMeter = (2 * Math.PI * earthRadius) / 360; // 每度对应的米数
        
        // 这个转换只是一个粗略的近似
        return area * degreeToMeter * degreeToMeter;
    }

    // 获取多边形中心点
    function getPolygonCenter(points) {
        if (points.length === 0) return null;
        
        let x = 0, y = 0;
        for (let i = 0; i < points.length; i++) {
            x += points[i].lng;
            y += points[i].lat;
        }
        
        return new T.LngLat(x / points.length, y / points.length);
    }

    // 计算总距离
    function calculateTotalDistance() {
        let total = 0;
        for (let i = 1; i < measureState.points.length; i++) {
            const distance = calculateDistance(measureState.points[i-1], measureState.points[i]);
            total += distance;
        }
        return total;
    }

    // 显示两点间距离标签
    function showDistanceLabel(point, distance) {
        const label = document.createElement('div');
        label.className = 'distance-label';
        label.innerHTML = distance.toFixed(2) + ' 米';
        label.style.position = 'absolute';
        label.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
        label.style.padding = '2px 6px';
        label.style.borderRadius = '3px';
        label.style.fontSize = '12px';
        label.style.boxShadow = '0 1px 2px rgba(0,0,0,0.3)';
        label.style.zIndex = '1000';
        label.style.transform = 'translate(-50%, -50%)';
        
        // 添加删除按钮
        const closeBtn = document.createElement('span');
        closeBtn.innerHTML = '×';
        closeBtn.style.marginLeft = '5px';
        closeBtn.style.cursor = 'pointer';
        closeBtn.style.fontWeight = 'bold';
        closeBtn.onclick = function() {
            if (label.parentNode) {
                label.parentNode.removeChild(label);
            }
        };
        label.appendChild(closeBtn);
        
        document.getElementById('mapContainer').appendChild(label);
        
        // 定位标签（向上偏移20像素）
        const pixel = map.lngLatToContainerPoint(point);
        label.style.left = pixel.x + 'px';
        label.style.top = (pixel.y - 20) + 'px';
        
        measureState.labels.push(label);
    }

    // 显示面积标签
    function showAreaLabel(point, area) {
        // 如果已存在面积标签，先移除它
        if (measureState.areaLabel) {
            if (measureState.areaLabel.parentNode) {
                measureState.areaLabel.parentNode.removeChild(measureState.areaLabel);
            }
        }
        
        const label = document.createElement('div');
        label.className = 'area-label';
        label.innerHTML = area.toFixed(2) + ' 平方米';
        label.style.position = 'absolute';
        label.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
        label.style.padding = '2px 6px';
        label.style.borderRadius = '3px';
        label.style.fontSize = '12px';
        label.style.boxShadow = '0 1px 2px rgba(0,0,0,0.3)';
        label.style.zIndex = '1000';
        label.style.transform = 'translate(-50%, -50%)';
        
        // 添加删除按钮
        const closeBtn = document.createElement('span');
        closeBtn.innerHTML = '×';
        closeBtn.style.marginLeft = '5px';
        closeBtn.style.cursor = 'pointer';
        closeBtn.style.fontWeight = 'bold';
        closeBtn.onclick = function() {
            if (label.parentNode) {
                label.parentNode.removeChild(label);
            }
        };
        label.appendChild(closeBtn);
        
        document.getElementById('mapContainer').appendChild(label);
        
        // 定位标签
        const pixel = map.lngLatToContainerPoint(point);
        label.style.left = pixel.x + 'px';
        label.style.top = (pixel.y - 20) + 'px';
        
        measureState.areaLabel = label;
        measureState.labels.push(label);
    }

    // 显示总面积标签
    function showTotalAreaLabel(point, area) {
        // 如果已存在面积标签，先移除它
        if (measureState.areaLabel) {
            if (measureState.areaLabel.parentNode) {
                measureState.areaLabel.parentNode.removeChild(measureState.areaLabel);
            }
        }
        
        // 计算亩数（1亩 ≈ 666.6667平方米）
        const areaInMu = area / 666.6667;
        
        const label = document.createElement('div');
        label.className = 'total-area-label';
        label.innerHTML = '总面积: ' + area.toFixed(2) + ' 平方米<br>' + areaInMu.toFixed(2) + ' 亩';
        label.style.position = 'absolute';
        label.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
        label.style.color = 'white';
        label.style.padding = '4px 8px';
        label.style.borderRadius = '4px';
        label.style.fontSize = '14px';
        label.style.fontWeight = 'bold';
        label.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
        label.style.zIndex = '1000';
        label.style.transform = 'translate(-50%, -50%)';
        label.style.lineHeight = '1.4';
        
        // 添加删除按钮
        const closeBtn = document.createElement('span');
        closeBtn.innerHTML = ' ×';
        closeBtn.style.cursor = 'pointer';
        closeBtn.style.fontWeight = 'bold';
        closeBtn.onclick = function() {
            if (label.parentNode) {
                label.parentNode.removeChild(label);
            }
        };
        label.appendChild(closeBtn);
        
        document.getElementById('mapContainer').appendChild(label);
        
        // 定位标签
        const pixel = map.lngLatToContainerPoint(point);
        label.style.left = pixel.x + 'px';
        label.style.top = (pixel.y - 40) + 'px';
        
        measureState.areaLabel = label;
        measureState.labels.push(label);
    }

    // 显示总距离标签
    function showTotalDistanceLabel(totalDistance) {
        const lastPoint = measureState.points[measureState.points.length - 1];
        const label = document.createElement('div');
        label.className = 'total-distance-label';
        label.innerHTML = '总距离: ' + totalDistance.toFixed(2) + ' 米';
        label.style.position = 'absolute';
        label.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
        label.style.color = 'white';
        label.style.padding = '4px 8px';
        label.style.borderRadius = '4px';
        label.style.fontSize = '14px';
        label.style.fontWeight = 'bold';
        label.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
        label.style.zIndex = '1000';
        label.style.transform = 'translate(-50%, -50%)';
        
        // 添加删除按钮
        const closeBtn = document.createElement('span');
        closeBtn.innerHTML = ' ×';
        closeBtn.style.cursor = 'pointer';
        closeBtn.style.fontWeight = 'bold';
        closeBtn.onclick = function() {
            if (label.parentNode) {
                label.parentNode.removeChild(label);
            }
        };
        label.appendChild(closeBtn);
        
        document.getElementById('mapContainer').appendChild(label);
        
        // 定位标签（向上偏移40像素，比段距离标签更高）
        const pixel = map.lngLatToContainerPoint(lastPoint);
        label.style.left = pixel.x + 'px';
        label.style.top = (pixel.y - 60) + 'px';  // 从-40改为-60，增加间距
        
        measureState.labels.push(label);
    }

    // 清除测量结果
    function clearMeasureResult() {
        // 移除所有线条
        measureState.lines.forEach(line => {
            if (map && map.removeOverLay) {
                try { map.removeOverLay(line); } catch(e) {}
            }
        });
        
        // 移除所有标记
        measureState.markers.forEach(marker => {
            if (map && map.removeOverLay) {
                try { map.removeOverLay(marker); } catch(e) {}
            }
        });
        
        // 移除所有标签
        measureState.labels.forEach(label => {
            if (label.parentNode) {
                try { label.parentNode.removeChild(label); } catch(e) {}
            }
        });
        
        // 移除临时线
        if (measureState.tempLine) {
            if (map && map.removeOverLay) {
                try { map.removeOverLay(measureState.tempLine); } catch(e) {}
            }
            measureState.tempLine = null;
        }
        
        // 移除多边形
        if (measureState.polygon) {
            if (map && map.removeOverLay) {
                try { map.removeOverLay(measureState.polygon); } catch(e) {}
            }
            measureState.polygon = null;
        }
        
        // 移除面积标签
        if (measureState.areaLabel) {
            if (measureState.areaLabel.parentNode) {
                try { measureState.areaLabel.parentNode.removeChild(measureState.areaLabel); } catch(e) {}
            }
            measureState.areaLabel = null;
        }
        
        // 重置状态
        measureState.points = [];
        measureState.lines = [];
        measureState.markers = [];
        measureState.labels = [];
        measureState.isActive = false;
        measureState.mode = '';
    }

    // 添加CSS样式用于距离标签
    const style = document.createElement('style');
    style.innerHTML = `
        .distance-label, .total-distance-label {
            font-family: Arial, sans-serif;
            pointer-events: auto;
        }
    `;
    document.head.appendChild(style);

    // 颜色选择器相关变量和函数
    let currentOutlineColor = "#FFD700"; // 默认边框颜色
    let currentFillColor = "#FFFF00";   // 默认填充颜色
    let currentFillOpacity = 0.35;       // 默认透明度
    
    // 轨迹颜色相关变量
    let currentTrackLineColor = "#FF0000"; // 默认轨迹线颜色
    let currentTrackPointColor = "#68EAF3"; // 默认轨迹点颜色

    // 初始化颜色选择器
    function initColorPickers() {
        // 边框颜色选择器
        const outlineColorPicker = document.getElementById('outlineColorPicker');
        const outlineColorInput = document.getElementById('outlineColorInput');
        
        outlineColorPicker.addEventListener('click', function() {
            outlineColorInput.click();
        });
        
        outlineColorInput.addEventListener('change', function() {
            currentOutlineColor = this.value;
            outlineColorPicker.style.backgroundColor = currentOutlineColor;
        });
        
        // 填充颜色选择器
        const fillColorPicker = document.getElementById('fillColorPicker');
        const fillColorInput = document.getElementById('fillColorInput');
        
        fillColorPicker.addEventListener('click', function() {
            fillColorInput.click();
        });
        
        fillColorInput.addEventListener('change', function() {
            currentFillColor = this.value;
            fillColorPicker.style.backgroundColor = currentFillColor;
        });
        
        // 透明度滑块
        const fillOpacitySlider = document.getElementById('fillOpacitySlider');
        const fillOpacityValue = document.getElementById('fillOpacityValue');
        
        fillOpacitySlider.addEventListener('input', function() {
            currentFillOpacity = this.value / 100;
            fillOpacityValue.textContent = this.value + '%';
        });
        
        // 轨迹线颜色选择器
        const trackLineColorPicker = document.getElementById('trackLineColorPicker');
        const trackLineColorInput = document.getElementById('trackLineColorInput');
        
        if (trackLineColorPicker && trackLineColorInput) {
            trackLineColorPicker.addEventListener('click', function() {
                trackLineColorInput.click();
            });
            
            trackLineColorInput.addEventListener('change', function() {
                currentTrackLineColor = this.value;
                trackLineColorPicker.style.backgroundColor = currentTrackLineColor;
            });
        }
        
        // 轨迹点颜色选择器
        const trackPointColorPicker = document.getElementById('trackPointColorPicker');
        const trackPointColorInput = document.getElementById('trackPointColorInput');
        
        if (trackPointColorPicker && trackPointColorInput) {
            // 设置初始背景色
            trackPointColorPicker.style.backgroundColor = currentTrackPointColor;
            
            trackPointColorPicker.addEventListener('click', function() {
                trackPointColorInput.click();
            });
            
            trackPointColorInput.addEventListener('change', function() {
                currentTrackPointColor = this.value;
                trackPointColorPicker.style.backgroundColor = currentTrackPointColor;
            });
        }
    }

</script>
</body>

</html>
