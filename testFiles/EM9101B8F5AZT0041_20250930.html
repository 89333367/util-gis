<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>展示轮廓</title>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #mapContainer {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        #mapLoading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
            transition: opacity 0.3s;
        }

        .loading-text {
            font-size: 16px;
            color: #333;
            padding: 10px 20px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .wkt-input-container {
            position: absolute;
            top: 20px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            width: min(320px, 90vw);
            box-sizing: border-box;
            transition: all 0.3s;
        }

        .minimize-btn {
            position: absolute;
            top: -5px;
            right: -4px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #f0f0f0;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #666;
            z-index: 1001;
            transition: background 0.2s;
        }

        .minimize-btn:hover {
            background: #e0e0e0;
        }

        .content-wrapper {
            transition: all 0.3s;
        }

        .wkt-input-container.minimized {
            width: 40px;
            height: 40px;
            padding: 0;
        }

        .wkt-input-container.minimized .content-wrapper {
            display: none;
        }

        .wkt-input-container.minimized .min-icon {
            display: none;
        }

        .wkt-input-container.minimized .restore-icon {
            display: inline;
        }

        #wktTextarea {
            width: 100%;
            height: 120px;
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
            box-sizing: border-box;
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        /* 页签样式 */
        .tabs-header {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .tab-btn {
            flex: 1;
            padding: 6px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            background: #f5f5f5;
            color: #333;
            transition: background 0.2s;
        }
        .tab-btn.active { background: #337AFF; color: #fff; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        /* Multi → Polygons 分割器样式 */
        .split-section {
            margin-top: 10px;
            padding: 10px;
            background: #fafafa;
            border: 1px solid #eee;
            border-radius: 6px;
        }
        .split-section .title {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
        }
        .split-section .desc {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        #multiInput, #polyOutput {
            width: 100%;
            height: 90px;
            margin-bottom: 8px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
            box-sizing: border-box;
        }
        .split-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .split-actions button {
            flex: 1;
            padding: 6px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }
        #splitMultiBtn { background: #337AFF; color: #fff; }
        #splitMultiBtn:hover { background: #2860E0; }
        #copyPolysBtn { background: #f5f5f5; color: #333; }
        #copyPolysBtn:hover { background: #e0e0e0; }
        #drawButton,
        #clearButton,
        #drawTrackButton,
        #clearTrackButton {
            width: 50%;
            padding: 8px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        #drawButton,
        #drawTrackButton {
            background: #337AFF;
            color: white;
        }

        #drawButton:hover,
        #drawTrackButton:hover {
            background: #2860E0;
        }

        #clearButton,
        #clearTrackButton {
            background: #f5f5f5;
            color: #333;
        }

        #clearButton:hover,
        #clearTrackButton:hover {
            background: #e0e0e0;
        }

        #drawButton:disabled,
        #clearButton:disabled,
        #drawTrackButton:disabled,
        #clearTrackButton:disabled {
            background: #e0e0e0;
            color: #999;
            cursor: not-allowed;
        }

        .tip {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .area-label {
             position: absolute;
             background: rgba(255, 0, 0, 0.85);
             border: 1px solid #000;
             border-radius: 3px;
             padding: 4px 6px;
             font-size: 12px;
             color: #fff;
             font-weight: 600;
             box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
             white-space: nowrap;
             z-index: 9999;
             pointer-events: none;
         }
         /* 默认隐藏标签容器下的标签 */
          .labels-hidden .area-label { display: none; }

          /* Batch → Generator 样式 */
          .batch-section { margin-top: 10px; padding: 10px; background: #fafafa; border: 1px solid #eee; border-radius: 6px; }
          .batch-section .title { font-size: 13px; font-weight: 600; color: #333; margin-bottom: 6px; }
          .batch-section .desc { font-size: 12px; color: #666; margin-bottom: 8px; }
          #batchInput, #multiOutput { width: 100%; height: 90px; margin-bottom: 8px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; resize: vertical; box-sizing: border-box; }
          .batch-actions { display: flex; gap: 8px; margin-bottom: 8px; }
          .batch-actions button { flex: 1; padding: 6px 0; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; transition: background 0.2s; }
          #generateMultiBtn { background: #337AFF; color: #fff; }
          #generateMultiBtn:hover { background: #2860E0; }
          #copyMultiBtn { background: #f5f5f5; color: #333; }
          #copyMultiBtn:hover { background: #e0e0e0; }
      </style>
    <script src="https://api.tianditu.gov.cn/api?v=4.0&tk=648f621977051d0199ff0f965d3fd322"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
    <script src="https://lib.baomitu.com/terraformer/1.0.12/terraformer.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://unpkg.com/terraformer-wkt-parser@1.2.1/terraformer-wkt-parser.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- 已移除动态备用加载器 ensureTerraformer：改为仅使用静态脚本标签加载 Terraformer 核心库与 WKT 解析器 -->
    <script>
        // 检查Turf.js是否加载成功
        window.addEventListener('load', function () {
            if (typeof turf === 'undefined') {
                console.warn('Turf.js加载失败，已启用备用面积算法');
            } else {
                console.log('Turf.js加载成功');
            }
        });
    </script>
</head>

<body>
<div id="mapContainer">
    <div id="mapLoading">
        <div class="loading-text">地图正在加载中...</div>
    </div>
</div>

<div class="wkt-input-container">
    <div class="minimize-btn" id="minimizeBtn">
        <span class="min-icon">−</span>
        <span class="restore-icon" style="display:none;">+</span>
    </div>

    <div class="content-wrapper">
        <div class="tabs-header">
            <button class="tab-btn active" id="tabDrawBtn">轮廓</button>
            <button class="tab-btn" id="tabTrackBtn">轨迹</button>
            <button class="tab-btn" id="tabSplitBtn">分割器</button>
            <button class="tab-btn" id="tabBatchBtn">合并器</button>
        </div>
        <div class="tab-pane active" id="tabDraw">
            <div class="tip">请输入WKT字符串（支持POLYGON/MULTIPOLYGON）：</div>
            <textarea id="wktTextarea">POLYGON ((124.49892794941448 45.345531782307255, 124.49892779732868 45.34553191008486, 124.49892761440164 45.3455320158643, 124.49892740692351 45.345532096008384, 124.49892718202841 45.34553214776129, 124.49892694744945 45.34553216934349, 124.49892671125268 45.34553216001289, 124.49892648155969 45.34553212009032, 124.49892626626868 45.34553205094852, 124.49892607278247 45.345531954964954, 124.49892411582783 45.345530778610524, 124.49892401010801 45.345530727086995, 124.49892130204853 45.34552967495411, 124.49892118380215 45.345529639462534, 124.4989182311573 45.345528992539414, 124.49891810520937 45.34552897452807, 124.49891502844154 45.34552875920793, 124.49891489993007 45.345528759411536, 124.49891182456537 45.34552898447901, 124.4989116987335 45.34552900288926, 124.49890875024104 45.34552965916201, 124.49890863222181 45.345529695027984, 124.4989059308946 45.345530755731204, 124.49890582550364 45.34553080758944, 124.49890348154945 45.345532229449034, 124.49890339308709 45.34553229518354, 124.49890150213578 45.34553402018982, 124.49890143486846 45.34553409637364, 124.49890002302205 45.34553613763544, 124.49887902872324 45.34557614018037, 124.49887824997056 45.345578267537164, 124.4988782305325 45.34557835781722, 124.49887807875636 45.34558055225192, 124.4988780856436 45.345580643437835, 124.4988785671143 45.34558281408858, 124.49887860004173 45.34558290240237, 124.49887969481352 45.34558495934583, 124.49887975241684 45.34558504112835, 124.49888141513634 45.34558689915077, 124.49888149502956 45.34558697101485, 124.4988817911156 45.345587187709, 124.49888194675454 45.34558732674921, 124.49888206074145 45.345587484599385, 124.49888212865709 45.345587655139646, 124.49888214786822 45.34558783175816, 124.49888211763009 45.345588007607375, 124.4988820391151 45.34558817586966, 124.49888191536719 45.34558833002142, 124.49888175118421 45.34558846408621, 124.49888155293142 45.34558857286633, 124.4988614477183 45.34559751362049, 124.49886116899907 45.34559766633329, 124.49886102776406 45.34559773355534, 124.4988607228135 45.3455978586547, 124.49886062165454 45.34559791012806, 124.49885989985847 45.34559835946934, 124.49885983828695 45.345598395442586, 124.49885907798941 45.3455988120165, 124.49885898746042 45.34559887253708, 124.49885875645361 45.34559906057167, 124.49885863652973 45.34559914593206, 124.49885837204822 45.34559931058028, 124.49885828707372 45.34559937498094, 124.49885770345975 45.34559991498753, 124.49885765302372 45.34559995874, 124.4988570225834 45.34560047190487, 124.49885695053807 45.34560054371616, 124.4988567759913 45.34560075991759, 124.49885668198732 45.34560086013599, 124.49885646813917 45.34560105800548, 124.49885640261445 45.34560113285868, 124.49885597961193 45.34560174277707, 124.49885594224938 45.34560179262742, 124.49885546589299 45.345602382663664, 124.49885541509886 45.34560246300679, 124.49885530371976 45.345602699066596, 124.49885523924834 45.345602810291474, 124.49885508425132 45.34560303377846, 124.49885504069427 45.34560311620794, 124.49885479455853 45.34560377259923, 124.49885477170535 45.34560382663179, 124.49885446774022 45.345604470863286, 124.49885444014953 45.3456045566511, 124.49885439621818 45.3456048034983, 124.49885436375662 45.345604921455454, 124.49885427356737 45.345605161970816, 124.49885425365206 45.34560524880861, 124.49885419384131 45.345605926450006, 124.49885418637578 45.34560598258824, 124.49885406648296 45.345606656257466, 124.49885406315636 45.34560674419225, 124.49885408836127 45.3456069923392, 124.49885408997575 45.345607102288135, 124.49885406534318 45.34560744395641, 124.4988610625702 45.34574439043757, 124.49886113533249 45.34574514153294, 124.498864959367 45.34577190982781, 124.49886495939468 45.34577208997393, 124.49886213312189 45.34579191696938, 124.49886212644542 45.34579403313762, 124.49886213839633 45.34579412069916, 124.49886271727772 45.345796197028044, 124.49886275322402 45.34579628126383, 124.49886389541675 45.34579823805929, 124.49886395397638 45.34579831573063, 124.498865615587 45.34580007779426, 124.49886569451039 45.345800145917416, 124.4988678116837 45.34580164553383, 124.49886790793688 45.34580170149011, 124.49887039931195 45.34580288103029, 124.49887050919628 45.345802922669634, 124.49887327903069 45.34580373680409, 124.49887339832304 45.345803762526394, 124.49887634017333 45.34580417996832, 124.49887646429022 45.34580418878522, 124.49887946510246 45.34580419349259, 124.49887958927354 45.345804185065205, 124.49888253372878 45.34580377685705, 124.49888265318216 45.34580375150927, 124.49888542812565 45.345802946072936, 124.4988855382718 45.34580290477864, 124.49888803706405 45.34580173306671, 124.49888813366931 45.34580167741296, 124.498890260284 45.345800184453296, 124.49889033963551 45.34580011657913, 124.49889201234767 45.345798359745466, 124.49889207139631 45.345798282259274, 124.49889322592428 45.34579632906588, 124.49889326204816 45.34579624575909, 124.49889387287539 45.34579408409381, 124.49889686661186 45.345773082888776, 124.49889686043402 45.345770828766206, 124.49889292231805 45.345743262009044, 124.49889291672089 45.34574320423188, 124.49888629355173 45.345613580079494, 124.49888631173978 45.34561339294017, 124.49888638456513 45.345613212528455, 124.4988865088616 45.34561304668784, 124.49888667922536 45.34561290262824, 124.49888688824993 45.345612786612705, 124.4989099728686 45.34560252678076, 124.49891020199054 45.34560244634878, 124.49891044926899 45.34560239978603, 124.49891070475141 45.34560238896657, 124.49896193535152 45.34560385270755, 124.4989621567352 45.34560387281398, 124.49902763913144 45.34561398956831, 124.49903018305008 45.34561422744317, 124.49903028863918 45.34561423101379, 124.4990329598266 45.345614160132456, 124.49906599356105 45.34561135336228, 124.49906632961336 45.345611356250366, 124.49916168992863 45.3456211267094, 124.4991625831664 45.34562120085066, 124.49931888900797 45.34563115298468, 124.4993191451278 45.345631188186395, 124.49931938573341 45.34563125939891, 124.49931960075891 45.34563136364304, 124.49931978120892 45.34563149655772, 124.49931991953409 45.345631652582426, 124.49932000994757 45.34563182518987, 124.49932004866695 45.34563200715898, 124.4993200340725 45.34563219087705, 124.49931996677458 45.34563236865822, 124.49926534253379 45.34573368774773, 124.49926522783693 45.3457338493938, 124.49926506963143 45.345733991609016, 124.49908916585417 45.3458629876909, 124.49908888957474 45.34586314101092, 124.49898698063546 45.345905103522306, 124.49898675205944 45.345905177407346, 124.49898650737263 45.34590521824354, 124.4989862560803 45.34590522444456, 124.498986007944 45.345905195769525, 124.49898577260294 45.345905133332366, 124.4989855591992 45.34590503955851, 124.49898537602276 45.34590491809073, 124.49898523018933 45.345904773647554, 124.49898512736394 45.345904611840076, 124.49898457605532 45.34590344876792, 124.49898452510324 45.34590336847453, 124.4989830368405 45.34590153097914, 124.49898296535297 45.34590145993304, 124.49898091142306 45.345899799106995, 124.49897790855931 45.345897802582435, 124.49897562641651 45.345896546696395, 124.49897552498743 45.34589650105248, 124.49897294919994 45.34589557076382, 124.49897283740127 45.34589553939696, 124.49897005935316 45.34589496758255, 124.49896994232456 45.345894951768315, 124.49896694073325 45.34589475468255, 124.4989666931449 45.34589475468257, 124.49896644480194 45.34589473747311, 124.49891805763382 45.345887965882476, 124.49891576361546 45.34588777009967, 124.49891566849219 45.34588776708599, 124.49891326273261 45.34588782156067, 124.49861229006248 45.34591044369533, 124.4986120497429 45.34591044570431, 124.4986118131534 45.34591041589476, 124.49861158869034 45.34591035532463, 124.49855309448905 45.34588992877712, 124.49851283321107 45.345876936889994, 124.49851262125618 45.34587685025241, 124.49851243669384 45.34587673664299, 124.49851228633005 45.34587660025129, 124.4985121757099 45.34587644610698, 124.49851210891269 45.345876279894405, 124.49851208840157 45.34587610774296, 124.49851211493292 45.34587593600102, 124.49851218752852 45.34587577100187, 124.498512303511 45.34587561883017, 124.49851245860363 45.34587548509749, 124.49851264708681 45.34587537473548, 124.49851286201012 45.345875291813904, 124.49851309544765 45.345875239390686, 124.49851333879126 45.345875219398984, 124.49851358306691 45.34587523257604, 124.49856932327785 45.34588208147087, 124.49857231585922 45.345882238863766, 124.49857244056926 45.345882236776696, 124.49857541912436 45.34588197945917, 124.49857554086074 45.34588196025574, 124.49857839099411 45.34588129812006, 124.49857850507898 45.34588126253811, 124.49858111726193 45.34588022102977, 124.4985812193103 45.345880170436885, 124.49858349315812 45.345878789580404, 124.49858357924846 45.34587872592096, 124.49858542737874 45.34587705878164, 124.49858549420257 45.345876984502134, 124.49858684559238 45.34587509514743, 124.49858689058217 45.34587501310211, 124.49858769329815 45.34587297413886, 124.4985877147249 45.34587288748079, 124.49858793791915 45.34587077726592, 124.4985879349594 45.34587068932434, 124.49858757005494 45.3458685889515, 124.49858754282258 45.345868503107724, 124.49858660384245 45.34586649329284, 124.49858655338372 45.345866412844686, 124.49858507641262 45.34586457082436, 124.49858500466696 45.34586449886383, 124.49858304646386 45.34586289542546, 124.49858295618802 45.34586283471764, 124.49858059200555 45.345861531480594, 124.49858048666921 45.34586148435871, 124.49857780736217 45.345860531405805, 124.49857769213949 45.345860499987694, 124.4985746786017 45.34585991436563, 124.49845389245512 45.34584506361028, 124.49845365910731 45.34584501849589, 124.49845344203538 45.345844943125506, 124.49845324904747 45.3458448402102, 124.49843404547863 45.345832414365134, 124.49843387000125 45.34583227451897, 124.4984337392455 45.34583211213972, 124.49843365884487 45.34583193422323, 124.49843363226313 45.34583174843483, 124.49843366064577 45.34583156277894, 124.49845959907309 45.34574631579689, 124.49845993814483 45.345744213250065, 124.4984599400233 45.34574412529335, 124.49845969089522 45.3457420165226, 124.49845966840374 45.3457419299981, 124.49845884065327 45.34573989601901, 124.49845879465654 45.34573981425174, 124.49845742009352 45.345737933229316, 124.49845735235903 45.345737859360945, 124.49845548380748 45.345736203582284, 124.49845539693789 45.34573614045147, 124.49845310620525 45.3457347735471, 124.49845300353915 45.34573472358003, 124.49845037865678 45.34573369807919, 124.49845026413969 45.34573366319615, 124.49844740598063 45.345733018508305, 124.49844728401285 45.345733000049734, 124.49844430241424 45.34573276094977, 124.4984441776836 45.34573275962513, 124.49844118722636 45.34573293530155, 124.498441064526 45.34573295116169, 124.49843818013193 45.345733534863335, 124.49843806417685 45.34573356729881, 124.49843539669136 45.345734536594435, 124.49843529193824 45.34573458435861, 124.49843294387152 45.34573590199862, 124.49843285434493 45.34573596325644, 124.49843091593216 45.34573757860446, 124.49843084507322 45.34573765100148, 124.49842939080555 45.345739501981356, 124.4984293418171 45.345739581952444, 124.49842839512014 45.345741682665626, 124.4984004008693 45.345833686823205, 124.49840006015478 45.34583591456141, 124.498400059698 45.345836007678436, 124.4984003785462 45.34583823700129, 124.49840040536155 45.345838328178765, 124.49840137003056 45.34584046305446, 124.49840142296253 45.34584054836338, 124.49840299188699 45.34584249680457, 124.49840306791057 45.345842571834794, 124.49840526617463 45.345844316704586, 124.49847325758294 45.34588830740891, 124.49847514476177 45.345889348996096, 124.49847522704434 45.34588938748902, 124.49847741070744 45.34589024050884, 124.4985391604515 45.34591016024772, 124.49860197923141 45.345932092505606, 124.49860467258745 45.34593281929297, 124.4986047881074 45.34593284193822, 124.49860762691894 45.34593319961962, 124.49860774525509 45.34593320651781, 124.49861074891867 45.345933177562664, 124.49891408286004 45.34591037795537, 124.49891427534045 45.34591037379442, 124.49891446651625 45.3459103901103, 124.49895988009015 45.34591674801046, 124.4989601606733 45.345916811778515, 124.49896041300954 45.345916919257505, 124.49896146617893 45.34591749464788, 124.49896157180382 45.34591754144803, 124.49896364224985 45.34591826993727, 124.49896386881565 45.34591837197652, 124.49896406002894 45.34591850522923, 124.49896420739891 45.34591866377845, 124.49896430438187 45.345918840583984, 124.49896434667141 45.345919027794956, 124.49896433238969 45.34591921709846, 124.49896409203193 45.345920276069734, 124.4989640844854 45.34592036387451, 124.49896419741702 45.34592247845186, 124.4989642143075 45.34592256560729, 124.49896491008671 45.34592462401717, 124.49896495076513 45.345924707174746, 124.4989662026533 45.34592663031395, 124.4989662655564 45.34592670627752, 124.49896802544437 45.345928420240824, 124.49896810815518 45.3459284860913, 124.49897030841136 45.34592992501211, 124.49897040775022 45.34592997821832, 124.49897296382075 45.345931086800014, 124.49897307597091 45.34593112531774, 124.4989758896264 45.34593186095755, 124.49897601027875 45.345931883306754, 124.498978973392 45.34593221773467, 124.49897909790869 45.34593222305618, 124.49898209660938 45.345932143420356, 124.49898222020583 45.345932131509755, 124.49898513925521 45.34593164087056, 124.49898525603936 45.345931612463374, 124.49898809439058 45.3459306891207, 124.49910710925825 45.34588167306962, 124.49911055488622 45.34587975043554, 124.49929053450677 45.34574775879784, 124.49929243278234 45.345746052386176, 124.4992925005178 45.34574597696659, 124.49929392853336 45.34574395463672, 124.49935320964136 45.34563399769906, 124.49935331361696 45.34563384820259, 124.49935345488188 45.34563371477911, 124.49935362859664 45.345633601999346, 124.4993538288104 45.345633513726774, 124.49935404866442 45.345633452985346, 124.49935428062709 45.345633421855894, 124.49935451675209 45.34563342140482, 124.49942962784826 45.34563819945365, 124.49943259230498 45.34563818495235, 124.49943271488141 45.345638175937445, 124.49943561973471 45.34563775878226, 124.49943573754823 45.34563773327565, 124.49943847390428 45.34563692911146, 124.49943858253653 45.34563688806985, 124.49944104777043 45.345635727056155, 124.49944114314727 45.34563567201872, 124.49944324480138 45.34563419769887, 124.49944332334644 45.345634130729245, 124.49944498259975 45.34563239839682, 124.49944504136633 45.345632322007255, 124.49944619599077 45.34563039663124, 124.49944623277479 45.34563031368698, 124.49944683946632 45.34562826747769, 124.49944685288868 45.3456281810893, 124.4994468888939 45.34562609078859, 124.49944687845105 45.34562600419483, 124.49944634241973 45.34562394819849, 124.49944630850325 45.345623864648225, 124.49944522053904 45.34562192006424, 124.49944516442085 45.34562184269048, 124.49944356532664 45.345620082448754, 124.49944348911252 45.345620014154456, 124.49944143886098 45.3456185042717, 124.49944134540847 45.34561844761709, 124.49943892089374 45.34561724472104, 124.49943881370713 45.34561720183081, 124.49943610585859 45.34561635103495, 124.49943598895862 45.34561632351802, 124.49943539252497 45.34561622717076, 124.49943516075732 45.34561617281651, 124.49943494792676 45.345616088311836, 124.49943476183455 45.34561597675421, 124.49943460930173 45.34561584223271, 124.49943449591949 45.34561568967822, 124.49943442584365 45.345615524682486, 124.4994344016428 45.34561535329341, 124.49943442420408 45.34561518179312, 124.4994344927005 45.345615016467924, 124.49943460462148 45.345614863377726, 124.49943475586433 45.34561472813398, 124.49943494088552 45.34561461569399, 124.4994351529031 45.34561453017916, 124.49943538414574 45.34561447472403, 124.49943562613724 45.34561445136128, 124.4994787020749 45.345613229920325, 124.49948175825229 45.34561292394187, 124.49948188281166 45.34561290225794, 124.49948478971199 45.34561217016107, 124.49948490556976 45.345612131296434, 124.49948754508749 45.345611002840364, 124.49948764753312 45.3456109483751, 124.49948991234024 45.34560946944494, 124.49948999720723 45.34560940159421, 124.49949179521178 45.34560763232658, 124.49949185904967 45.34560755384915, 124.4994931171411 45.345605566186045, 124.49949315735445 45.34560548027241, 124.4994938243759 45.345603355037085, 124.49949383932919 45.34560326518078, 124.49949388815867 45.345601088789316, 124.4994938772438 45.345600998644215, 124.49949330589585 45.34559885959317, 124.49949326955667 45.3455987728252, 124.49949210126329 45.34559675809222, 124.499492040978 45.34559667823009, 124.49949032324417 45.34559486973846, 124.49949024146369 45.345594800028636, 124.49948804413657 45.34559327131599, 124.49948794418624 45.34559321459307, 124.49948535661372 45.34559202782009, 124.49948524255758 45.34559198639041, 124.49948236995581 45.3455911898136, 124.49948224762836 45.34559116559882, 124.49947907901466 45.345590780365974, 124.49940054619796 45.345586804020755, 124.49936727644767 45.345584006643534, 124.49936702739868 45.34558396757771, 124.4993667943538 45.34558389434697, 124.49936658663354 45.34558378988021, 124.4993664125457 45.345583658355565, 124.49936627905302 45.34558350503338, 124.49936619149456 45.345583336045806, 124.49936615337211 45.34558315815152, 124.49936616621058 45.34558297846539, 124.49936676798946 45.34558018019001, 124.49936682502627 45.345580018216175, 124.49936692350961 45.34557986645884, 124.49936706004995 45.34557973014079, 124.49936722994833 45.34557961395347, 124.49936742735764 45.34557952189547, 124.49936764548384 45.345579457135045, 124.49936787682016 45.3455794219009, 124.49936961876105 45.34557927399944, 124.49936981015694 45.345579267966436, 124.49942948800862 45.34558055136899, 124.49942959484825 45.34558055683942, 124.49947416985928 45.34558417101604, 124.49949527919449 45.3455856792998, 124.49949537759832 45.34558568907411, 124.49950619561729 45.34558706852363, 124.49950805516232 45.34558722558246, 124.49953108031438 45.345588222461814, 124.4995340419552 45.34558814857056, 124.49953416407202 45.34558813710997, 124.499537049868 45.34558766223341, 124.49953716656503 45.34558763439564, 124.49953986853508 45.345586776325824, 124.49953997543943 45.345586733154065, 124.49954239232684 45.34558552404732, 124.49954248543169 45.34558546715964, 124.4995445266628 45.345583952327445, 124.4995446024789 45.34558388385609, 124.49954619155781 45.3455821200675, 124.49954624724516 45.34558204257727, 124.49954732462 45.34558009593138, 124.49954735809105 45.34558001232635, 124.49954788338776 45.34557795577392, 124.49954789338783 45.34557786918861, 124.4995478469208 45.34557577979888, 124.49954783307537 45.345575693476945, 124.4995472165858 45.34557364955105, 124.49954717941372 45.345573566727836, 124.49954601600466 45.345571644861856, 124.4995459568996 45.345571568642, 124.49954429017026 45.34556984085887, 124.49954421134596 45.34556977409705, 124.49954210375842 45.34556830514669, 124.49954200816875 45.34556825034522, 124.49953953870502 45.345567095276266, 124.49953942993297 45.345567054489415, 124.49953669113668 45.34556625658822, 124.49953657440024 45.34556623158891, 124.4995335467016 45.34556580761941, 124.4994998445417 45.345563400325545, 124.49949974597186 45.345563390532284, 124.4994647945785 45.34555893116943, 124.49946243961298 45.34555875890906, 124.49943190694887 45.34555810230092, 124.49943180010926 45.345558096830494, 124.49941100038936 45.34555641036649, 124.49941074828196 45.34555637139414, 124.49941051245699 45.345556297438065, 124.49941030256657 45.34555619152514, 124.49941012720082 45.345556057990166, 124.4994099935372 45.345555902298464, 124.49940990704636 45.34555573082213, 124.49940987126801 45.34555555057935, 124.49940988766657 45.34555536894708, 124.49940995557088 45.34555519335917, 124.49941007220184 45.34555503100203, 124.49941023278586 45.3455548885206, 124.4994104307506 45.345554771746386, 124.49941065799382 45.345554685458666, 124.49941090521494 45.34555463318904, 124.49941116229564 45.345554617076786, 124.49948086060738 45.34555524037551, 124.49948394226728 45.345555047661996, 124.49948406854793 45.345555030566075, 124.4994870322643 45.34555440485873, 124.49948715109149 45.34555437020682, 124.49948987586838 45.34555333705953, 124.4994899823877 45.345553286267325, 124.49949235692907 45.34555188787979, 124.49949244679075 45.34555182302142, 124.49949437410582 45.34555011651246, 124.49949444363868 45.345550040237605, 124.49949584500533 45.345548095310484, 124.4994958913693 45.345548010734625, 124.49949670954703 45.345545906831994, 124.49949673084842 45.34554581740993, 124.49949693241827 45.345543640467184, 124.4994969277871 45.34554354985113, 124.49949650451552 45.34554138878775, 124.49949647414118 45.34554130067912, 124.49949544331724 45.34553924376603, 124.49949538843993 45.34553916176314, 124.49949379216913 45.34553729301684, 124.49949371503037 45.345537220469296, 124.49949161851357 45.34553561622024, 124.49949152226397 45.34553555609146, 124.49948901113518 45.34553428186625, 124.49948889970695 45.345534236612714, 124.49948607653529 45.34553334445821, 124.49948595566235 45.34553331620457, 124.49948280855607 45.345532827146265, 124.49937569202456 45.34552390086357, 124.49937543564907 45.345523860285574, 124.49937519649977 45.3455237835312, 124.49937498472129 45.34552367385628, 124.49937480929702 45.34552353591314, 124.49937467766836 45.34552337555323, 124.4993745954189 45.345523199578885, 124.49937338717537 45.345519302028805, 124.49937335810034 45.34551913117948, 124.49937337568696 45.3455189595518, 124.49937343929174 45.34551879342493, 124.49937354658765 45.345518638876726, 124.49937369364929 45.345518501561486, 124.4993738750961 45.34551838650301, 124.49937408428983 45.34551829791079, 124.49937431357682 45.34551823902606, 124.49937455456855 45.34551821200316, 124.49937479844814 45.34551821783073, 124.49938496299092 45.34551915241535, 124.49951466567353 45.34552720161721, 124.49951766627518 45.34552717948974, 124.49951779028429 45.345527169952625, 124.49952072714657 45.34552673544661, 124.4995208461343 45.34552670903259, 124.49952360635602 45.345525878846225, 124.49952371575009 45.3455258365703, 124.49952619325768 45.34552464260709, 124.49952628885342 45.345524586094186, 124.49952838843787 45.34552307423751, 124.4995284665623 45.345523005659004, 124.4995301075373 45.345521234008714, 124.49953016518747 45.34552115600068, 124.4995312844917 45.34551919264007, 124.49953131945286 45.34551910819933, 124.49953187407165 45.345517028580055, 124.49953188499993 45.34551694095245, 124.49953185362003 45.3455148249919, 124.49953184009553 45.34551473754491, 124.49953122392263 45.34551266655914, 124.49953118646485 45.345512582652574, 124.49953000917871 45.34551063622863, 124.49952994922735 45.345510559087394, 124.49952825607016 45.34550881202465, 124.49952817592856 45.345508744612914, 124.49952603196768 45.345507264050376, 124.4995259347166 45.3455072089594, 124.49952342234263 45.34550605179376, 124.49952331171895 45.34550601114036, 124.49952052748105 45.34550522184096, 124.499520408896 45.34550519742626, 124.4995173358075 45.3455047941212, 124.49938875779941 45.34549682029106, 124.4993666516997 45.345494786803286, 124.49936639847864 45.34549474463252, 124.49936616265688 45.34549466711107, 124.4993659540431 45.34549455746339, 124.49936578131455 45.34549442025018, 124.49936565165578 45.34549426117878, 124.49936557045996 45.34549408686564, 124.49936439711962 45.345490301901975, 124.4993643681305 45.34549013347312, 124.49936438450182 45.34548996420148, 124.49936444565138 45.34548980010773, 124.49936454940415 45.34548964702836, 124.4993646920698 45.345489510408115, 124.49936486857409 45.34548939510631, 124.49936507263902 45.34548930522402, 124.4993652970064 45.34548924395819, 124.49936553369594 45.34548921348791, 124.49936577428896 45.34548921489696, 124.49953042666965 45.34550118618539, 124.49953342745998 45.34550119590927, 124.49953355165832 45.34550118768947, 124.49953649746128 45.34550078440476, 124.49953661699887 45.345500759256765, 124.49953939462745 45.34549995846155, 124.49953950491089 45.34549991735173, 124.49954200762228 45.34549874982012, 124.49954210441332 45.34549869432834, 124.49954423602985 45.34549720492777, 124.49954431560843 45.34549713718689, 124.49954599421295 45.345495383154386, 124.49954605352188 45.34549530576679, 124.49954721460622 45.34549335450973, 124.49954725136597 45.345493270449296, 124.49954785031106 45.345491196952224, 124.49954786310853 45.34549110945025, 124.49954787689727 45.34548899339688, 124.49954786524083 45.34548890581619, 124.4995472933431 45.34548682852477, 124.49954725768062 45.34548674423015, 124.49954612207476 45.34548478553098, 124.49954606377679 45.34548470776204, 124.49954440810262 45.34548294292539, 124.49954432941026 45.34548287467172, 124.49954221729503 45.34548137152018, 124.49954212123099 45.345481315403255, 124.49953963384223 45.345480131702054, 124.49953952409913 45.3454800898792, 124.49953675702551 45.34547927111705, 124.49953663897499 45.34547924544643, 124.49953357484462 45.34547880956901, 124.4993687457587 45.34546682199875, 124.4993577202726 45.34546591940962, 124.49935746336756 45.345465879104424, 124.49935722365773 45.34546580248288, 124.49935701134488 45.34546569280592, 124.499356835465 45.34546555474126, 124.49935670350332 45.34546539416484, 124.49935662107596 45.345465217910586, 124.49935537879911 45.34546121056706, 124.49935534988532 45.34546104407488, 124.49935536530394 45.34546087669163, 124.49935542451878 45.345460714236246, 124.49935552547142 45.3454605623563, 124.49935566465234 45.34546042633175, 124.49935583722299 45.34546031089134, 124.49935603718424 45.345460220048224, 124.49935625758464 45.345460156960506, 124.49935649076204 45.34546012382135, 124.49935672861042 45.34546012178278, 124.49946276806001 45.34546620746506, 124.49946576422097 45.3454661720268, 124.49946588796891 45.34546616196414, 124.49946881689655 45.34546571560177, 124.499468935493 45.34546568873168, 124.49947168498586 45.34546484854954, 124.49947179388678 45.345464805901635, 124.49947425858282 45.345463604096, 124.49947435361493 45.34546354730448, 124.49947643906532 45.34546202992951, 124.49947651658752 45.34546196117031, 124.4994781428773 45.34546018637217, 124.49947819991765 45.34546010828109, 124.49947930472689 45.34545814407079, 124.4994793391004 45.34545805963932, 124.49947988009167 45.34545598128719, 124.4994798904809 45.34545589375127, 124.4994798469239 45.34545378089968, 124.4994798329307 45.3454536936142, 124.49947920649404 45.34545162722874, 124.49947916865509 45.3454515435386, 124.49947798334419 45.345449602804486, 124.4994779231088 45.34544952591564, 124.49947622434608 45.34544778520337, 124.4994761440227 45.34544771806259, 124.49947399690528 45.345446244076626, 124.49947389957156 45.34544618925673, 124.4994713863785 45.34544503848107, 124.49947127576438 45.34544499808297, 124.49946849280153 45.3454442146154, 124.49946837430609 45.34544419042418, 124.49946530437562 45.34544379228014, 124.49943253904948 45.345441806502734, 124.49941531077978 45.34544051457846, 124.49941507096781 45.34544047993818, 124.49941484495272 45.34544041363682, 124.49941464105603 45.34544031811544, 124.49941446678466 45.345440196890934, 124.49941432855493 45.34544005442652, 124.49941423145609 45.34543989596743, 124.4994141790633 45.34543972734778, 124.49941417330537 45.345439554775744, 124.49941421439433 45.34543938460509, 124.49941430081738 45.345439223101096, 124.49941442939266 45.34543907620999, 124.49941459538616 45.34543894934, 124.49941479268666 45.34543884716216, 124.49941501402968 45.34543877343845, 124.49941525126603 45.34543873088324, 124.4994154956611 45.34543872106328, 124.49950643603951 45.34544123416915, 124.49950938433467 45.34544111475026, 124.4995095056529 45.34544110147167, 124.49951236652515 45.34544058506544, 124.49951248197023 45.345440555606686, 124.49951514898757 45.345439661430646, 124.49951525426184 45.34543961688847, 124.49951762816399 45.345438378221715, 124.49951771935108 45.34543832025314, 124.49951971178709 45.34543678319605, 124.49951978549208 45.345436713959245, 124.4995213223089 45.34543493571681, 124.49952137578926 45.34543485778798, 124.49952239979022 45.34543290454229, 124.49952243105511 45.34543282082247, 124.49952290412944 45.34543076526862, 124.49952291201565 45.3454306788724, 124.49952281655695 45.345428597512615, 124.49952280077072 45.34542851165719, 124.49952214033173 45.34542648195452, 124.49952210146047 45.34542639983356, 124.49952090062106 45.34542449732836, 124.49952084011237 45.34542442200005, 124.49951914356431 45.34542271749847, 124.49951906366935 45.34542265176499, 124.49951693455488 45.34542120870521, 124.49951683824708 45.34542115501298, 124.49951435580599 45.34542002710163, 124.49951424667 45.345419987449276, 124.49951150329284 45.345419216664475, 124.49951138653174 45.34541919276132, 124.49950836232536 45.34541879571141, 124.49950804801966 45.34541877586064, 124.49950778540503 45.345418739395726, 124.49950753935936 45.3454186650947, 124.49950732071301 45.34541855622805, 124.49950713909018 45.345418417587794, 124.49950700248536 45.345418255276535, 124.49950691691167 45.34541807643878, 124.49950688613563 45.34541788894646, 124.4995068567358 45.34541584499338, 124.49950684364718 45.345415758885956, 124.49950624688124 45.34541371876262, 124.49950621058231 45.345413636031545, 124.49950506923479 45.34541171472432, 124.4995050110774 45.34541163845055, 124.49950336765215 45.3454099075093, 124.49950328980195 45.3454098405328, 124.49950120549975 45.34540836441753, 124.49950111085639 45.34540830923292, 124.49949866329622 45.345407142913864, 124.49949855538331 45.345407101575745, 124.49949583571275 45.34540628848666, 124.49949571968419 45.345406262786, 124.4994927075456 45.345405819254076, 124.49940356755359 45.34539880914233, 124.49920353213366 45.34538480881166, 124.49920133495105 45.34538476442596, 124.49909231719913 45.34538776908107, 124.49908940057087 45.345388049073456, 124.49908928146527 45.34538806888069, 124.49908649478799 45.34538873734407, 124.49908638434029 45.345388772516856, 124.49908372718649 45.34538985116348, 124.49905972176416 45.34540186110846, 124.49905711077669 45.345403514271695, 124.49905701514776 45.34540359049648, 124.49905492965152 45.34540570721039, 124.4990421919694 45.34542236417396, 124.49904207249284 45.34542249274406, 124.49904157268008 45.34542294163776, 124.49904150501027 45.345423016878485, 124.49904007743002 45.345425034342476, 124.49902857952571 45.345446294638165, 124.49902846689692 45.34544645362935, 124.49902831214212 45.345446593904484, 124.49902812130121 45.34544670998893, 124.49902790182216 45.34544679735216, 124.4990276622707 45.345446852584644, 124.49902741199611 45.34544687353071, 124.49902716076593 45.34544685937295, 124.4990269183852 45.34544681066386, 124.4990266943134 45.34544672930446, 124.49902649729556 45.34544661847004, 124.49902633502089 45.345446482486196, 124.49902621382252 45.34544632666007, 124.49902613843061 45.3454461570732, 124.49902611178737 45.34544598034416, 124.4990261349329 45.3454458033703, 124.49903866275508 45.34540009096754, 124.49903894095138 45.34539799133875, 124.49903894037078 45.34539790367739, 124.49903863438537 45.34539580601382, 124.49903860964723 45.34539572010471, 124.49903773116273 45.345393704418214, 124.49903768321106 45.34539362354002, 124.49903626575285 45.34539176675485, 124.4990361964182 45.34539169399471, 124.49903429408144 45.345390066972044, 124.499034206009 45.345390005105756, 124.4990318913927 45.34538866993801, 124.499031787944 45.3453886213269, 124.4990291493813 45.34538762896815, 124.49902903450366 45.34538759546718, 124.49902617269014 45.34538698378884, 124.49902605076846 45.34538696667677, 124.49902307491966 45.345386759022276, 124.49902295060649 45.3453867589521, 124.49901997428998 45.34538696324625, 124.49901985232952 45.34538698022061, 124.49901698913047 45.345387588666924, 124.49901687417744 45.34538762203801, 124.49901423336486 45.345388611416226, 124.49901412980545 45.34538865991074, 124.49901181216087 45.345389992463, 124.49901172394769 45.34539005423003, 124.49900981791917 45.3453916791025, 124.49900974841937 45.34539175178428, 124.4990083267467 45.345393606966915, 124.49900827907798 45.34539368700753, 124.49900736482348 45.34539578687493, 124.49898989289342 45.345455967911626, 124.49898979548567 45.34545617337291, 124.49898963124924 45.345456356456175, 124.49898072961675 45.345464044229004, 124.49898055925378 45.34546416570954, 124.49898035939427 45.34546426228728, 124.49898013724666 45.34546433047893, 124.49897990082306 45.345464367825045, 124.49897965865051 45.34546437297867, 124.4989794194636 45.34546434575388, 124.49897919188892 45.34546428713264, 124.49897898413448 45.345464199229234, 124.49897880369329 45.345464085214054, 124.49895167704801 45.3454433475682, 124.49894945813631 45.34544195124987, 124.49894935833449 45.34544189979655, 124.49894679851347 45.34544083240816, 124.49894668648716 45.345440795533825, 124.4989438822984 45.345440097315965, 124.49894376227553 45.34544007641213, 124.49894081955642 45.34543977371735, 124.49894069606658 45.34543976957293, 124.49893772588219 45.345439873825676, 124.49893760358657 45.34543988659708, 124.49893471803867 45.345440393862624, 124.49893460155323 45.34544042306776, 124.498931909549 45.34544131420082, 124.49893180326984 45.34544135873737, 124.49892940641303 45.34544260010418, 124.49892931435076 45.345442658291546, 124.49892730310368 45.345444203040195, 124.49892722873373 45.34544427268185, 124.49892567900612 45.345446062509765, 124.49892562513541 45.34544614097704, 124.49892459541765 45.345448108331716, 124.4989245640786 45.345448192664556, 124.49892409323505 45.34545026329253, 124.49892408561124 45.34545035030652, 124.49892419141214 45.34545244605863, 124.4989242077912 45.34545253247007, 124.49892488624381 45.34545457424665, 124.49892492562262 45.34545465599525, 124.49892620747255 45.345456644671174, 124.49896971868769 45.3455099810403, 124.49896982435617 45.34551014772587, 124.49896988012249 45.34551032602342, 124.49896988368955 45.345510508588795, 124.49896983491037 45.34551068790207, 124.49896730404444 45.34551664287612, 124.49896721125113 45.345516803176345, 124.49896707662928 45.34551694797261, 124.4989669051653 45.34551707190162, 124.49896670321036 45.345517170372915, 124.49896647824504 45.3455172397391, 124.49896623860221 45.34551727743079, 124.49896599315824 45.34551728205187, 124.49896575100466 45.34551725343117, 124.49896552111085 45.34551719262883, 124.49896531199234 45.34551710189698, 124.49896513139497 45.34551698459641, 124.49896485978418 45.3455167706092, 124.49896477102833 45.34551671280806, 124.49896245878719 45.345515471732256, 124.49896235614085 45.34551542679994, 124.49895975297511 45.34551451620973, 124.49895964013736 45.345514485765484, 124.49895683985221 45.34551393847417, 124.4989567208897 45.345513923615066, 124.49895382439476 45.345513759344634, 124.49895370359377 45.34551376060592, 124.49895081526536 45.34551398527597, 124.49895069697872 45.34551400261224, 124.49894792089896 45.34551460812669, 124.49894780938943 45.3455146409132, 124.49894524559488 45.34551560545214, 124.49894514488076 45.34551565250743, 124.49894288575858 45.3455169413136, 124.49894280030465 45.345517000364566, 124.4989408534467 45.345518634794345, 124.49892794941448 45.345531782307255), (124.49913438865481 45.34550413909547, 124.49913413945116 45.34550409996747, 124.49913390628608 45.34550402663196, 124.49913369849753 45.34550392202592, 124.49913352440716 45.34550379033866, 124.4991333909871 45.3455036368441, 124.49913330358049 45.345503467689475, 124.49913326568797 45.34550328964915, 124.49913327882696 45.345503109853425, 124.49913334247137 45.345502935502864, 124.49913345407238 45.34550277357993, 124.49913360916032 45.34550263056941, 124.49913460470927 45.3455018816377, 124.49913468068969 45.345501811871614, 124.49913596864842 45.345500352661894, 124.49913610752974 45.34550022306715, 124.49913627719488 45.34550011319603, 124.4991364721123 45.34550002663063, 124.49913668592725 45.34549996619318, 124.49913691166886 45.345499933854114, 124.49913714197733 45.34549993066773, 124.49922236533867 45.34550419181527, 124.49922244019645 45.345504197126424, 124.49933850433271 45.34551487789908, 124.49933875755382 45.34551492006989, 124.49933899337567 45.3455149975914, 124.49933920198946 45.345515107239144, 124.499339374718 45.34551524445238, 124.49933950437676 45.34551540352382, 124.49933958557254 45.34551557783697, 124.49934090512106 45.34551983444326, 124.49934093414515 45.3455200038281, 124.49934091729696 45.345520174030796, 124.49934085518261 45.345520338929454, 124.49934075003611 45.345520492592954, 124.49934060563952 45.34552062949427, 124.49934042718641 45.34552074470925, 124.49934022109561 45.34552083409384, 124.4993399947798 45.345520894433015, 124.49933975637919 45.34552092355646, 124.49933951446859 45.34552092041666, 124.49921385100151 45.34551083064256, 124.49913438865481 45.34550413909547), (124.49921586854803 45.34548131988262, 124.49921563169586 45.34548129206583, 124.49921540643028 45.3454812334456, 124.4992152007313 45.345481146098535, 124.49921502188555 45.34548103311885, 124.49921487622858 45.345480898508754, 124.49921476892027 45.34548074703674, 124.49921470376181 45.345480584068575, 124.49921468306144 45.34548041537734, 124.49921470755247 45.34548024693875, 124.49921477636735 45.345480084719675, 124.4992152723303 45.345479221427595, 124.49921530761115 45.34547913705311, 124.49921567715502 45.3454777714946, 124.49921574356691 45.34547760995785, 124.49921585145715 45.34547745996112, 124.49921599705465 45.34547732674705, 124.49921617527073 45.34547721497174, 124.49921637987616 45.34547712854186, 124.49921660371987 45.34547707047833, 124.49921683897803 45.34547704281054, 124.49921707742801 45.345477046505565, 124.49932961535778 45.34548626014336, 124.49932987226292 45.345486300448606, 124.49933011197278 45.34548637707021, 124.49933032428567 45.345486486747234, 124.49933050016556 45.345486624811926, 124.49933063212721 45.34548678538838, 124.49933071455453 45.345486961642656, 124.49933176887262 45.34549036267128, 124.49933179794787 45.34549053353044, 124.49933178035609 45.345490705167656, 124.49933171674121 45.34549087130273, 124.49933160943068 45.34549102585678, 124.4993314623512 45.34549116317466, 124.49933128088432 45.34549127823193, 124.49933107166981 45.345491366818635, 124.49933084236295 45.345491425693375, 124.49933060135402 45.345491452701964, 124.49933035746164 45.34549144685612, 124.49922608224922 45.34548185094965, 124.4992251091071 45.34548178190526, 124.49921586854803 45.34548131988262), (124.49908933545763 45.34545521016266, 124.49908909078701 45.34545519918822, 124.49908885361106 45.34545515541348, 124.49908863268888 45.34545508045502, 124.49908843617908 45.345454977081076, 124.49908827133902 45.34545484910929, 124.49908814425612 45.34545470126568, 124.49908805962359 45.345454539010134, 124.49908802056692 45.34545436833482, 124.49908802852863 45.34545419554281, 124.49908808321443 45.34545402701533, 124.499088182605 45.34545386897618, 124.49908832302978 45.34545372726176, 124.49908849930273 45.34545360710562, 124.49908870491414 45.34545351294517, 124.49908893227071 45.345453448257764, 124.49911585264306 45.34544783984785, 124.49911605661485 45.3454478098644, 124.49911626478745 45.345447803693496, 124.49916706195533 45.34544922867688, 124.49932083072551 45.3454580600877, 124.49932109643099 45.345458095628594, 124.49932134554228 45.34545816986661, 124.49932156686461 45.34545827946562, 124.49932175045231 45.34545841950044, 124.49932188805505 45.3454585836781, 124.49932197348926 45.345458764620744, 124.49932293671984 45.345461871821755, 124.49932296575085 45.34546204140283, 124.49932294880422 45.345462211796594, 124.49932288649097 45.34546237686018, 124.49932278105757 45.34546253064293, 124.49932263630484 45.34546266760084, 124.49932245745137 45.34546278279649, 124.49932225094486 45.34546287207697, 124.49932202423011 45.34546293222363, 124.49932178548032 45.34546296106817, 124.49932154330268 45.345462957570696, 124.49919779277299 45.34545282840932, 124.49919543201415 45.34545276176976, 124.49908933545763 45.34545521016266), (124.49924736119394 45.34556623487589, 124.49924760882071 45.34556627424404, 124.49924784049246 45.34556634740502, 124.49924804703724 45.34556645146231, 124.4992482202778 45.345566582296264, 124.49924835335561 45.345566734727136, 124.49924844100197 45.34556690272007, 124.49924847974681 45.34556707962421, 124.49924846805644 45.34556725843579, 124.49924840639349 45.345567432075626, 124.4992482971994 45.34556759366923, 124.49924814479701 45.34556773681906, 124.4992479552201 45.34556785585772, 124.49924773597412 45.34556794607244, 124.49924749573908 45.345568003891586, 124.4992267683356 45.34557141473351, 124.49922653945252 45.345571437241276, 124.49922630856653 45.345571430262794, 124.49919910759445 45.345568853600575, 124.49910744183322 45.34556180073748, 124.4990333685007 45.34555702182909, 124.49903311800973 45.34555698760086, 124.49903288218769 45.345556918906766, 124.49903267046729 45.34555681849451, 124.49903249131731 45.34555669038057, 124.49903235190355 45.34555653968944, 124.49903225780272 45.3455563724487, 124.49903221277869 45.345556195347946, 124.49903221863244 45.34555601547109, 124.49903227512968 45.34555584001317, 124.49903238001075 45.345555675992436, 124.4990325290804 45.345555529969644, 124.49903271637575 45.34555540778566, 124.49903293440526 45.345555314327775, 124.49903317444777 45.34555525333429, 124.49903342690156 45.34555522724493, 124.49909446215331 45.34555327410023, 124.49909464855527 45.34555327775533, 124.49913498836226 45.34555615916989, 124.49915407387134 45.345558162993285, 124.49924736119394 45.34556623487589), (124.49901958508757 45.345533156403135, 124.49901933566157 45.345533147125096, 124.49901909357959 45.34553310375432, 124.49901886812096 45.34553302795326, 124.4990186679277 45.34553292262749, 124.4990185006736 45.34553279181428, 124.49901837276971 45.34553264052786, 124.49901828911875 45.34553247456723, 124.49901825292719 45.34553230029391, 124.49901826558217 45.345532124388015, 124.49901832659882 45.34553195359224, 124.49901843363807 45.34553179445342, 124.4990185825971 45.34553165307155, 124.4990187677661 45.345531534865984, 124.49901898204733 45.34553144436769, 124.49902382139027 45.34552983125229, 124.49902412957735 45.3455297606244, 124.49906413349316 45.345524426768954, 124.49906434344416 45.34552441130885, 124.4990645541362 45.345524420473595, 124.49912732638269 45.34553085865529, 124.49912754307405 45.34553089472433, 124.49912774757286 45.34553095680985, 124.49912885025527 45.34553137548337, 124.49912905774866 45.34553147389288, 124.4991292340342 45.34553159895333, 124.49912937233918 45.34553174586006, 124.4991294673501 45.34553190896904, 124.49912951541684 45.34553208201384, 124.49912951469257 45.34553225834625, 124.49912946520527 45.34553243119181, 124.499129368856 45.345532593909965, 124.49912922934651 45.34553274024926, 124.4991290520366 45.345532864587526, 124.49912884373829 45.34553296214781, 124.49912861245429 45.34553302918195, 124.49912836706996 45.345533063114594, 124.49912811701303 45.34553306264208, 124.49909656139508 45.345530811082256, 124.49909423133721 45.345530767706855, 124.49901958508757 45.345533156403135))</textarea>
            <div class="coord-settings" style="margin-bottom:8px;font-size:12px;color:#333;">
                <label>WKT坐标系：
                    <select id="coordSysSelect" style="margin-left:6px;">
                        <option value="wgs84" selected>WGS84</option>
                        <option value="gcj02">GCJ-02（国测局）</option>
                        <option value="bd09">BD-09（百度）</option>
                        <option value="cgcs2000">CGCS2000</option>
                    </select>
                </label>
                <!-- 已移除“不进行绘制坐标转换”选项，统一使用WGS84绘制 -->
            </div>

            <div class="button-group">
                <button id="drawButton" disabled>绘制轮廓</button>
                <button id="clearButton" disabled>清空轮廓</button>
            </div>
            <!-- 显示开关：仅保留显示亩数 -->
            <div class="display-toggles" style="margin-top:8px;font-size:12px;color:#333;">
                <label><input type="checkbox" id="toggleLabelsCheckbox"> 显示亩数</label>
            </div>
        </div>

        <div class="tab-pane" id="tabSplit">
            <!-- MultiPolygon → 多个 Polygon 分割器 -->
            <div class="split-section">
                <div class="title">MultiPolygon → 多个 Polygon 分割器</div>
                <div class="desc">输入一个 MULTIPOLYGON WKT，分割为多行 POLYGON WKT。</div>
                <textarea id="multiInput"></textarea>
                <div class="split-actions">
                    <button id="splitMultiBtn">分割为多个 POLYGON</button>
                    <button id="copyPolysBtn">复制结果</button>
                </div>
                <textarea id="polyOutput" readonly></textarea>
            </div>
        </div>

        <div class="tab-pane" id="tabBatch">
            <!-- 批量POLYGON → MULTIPOLYGON 生成器 -->
            <div class="batch-section">
                <div class="title">批量POLYGON → MULTIPOLYGON 合并器</div>
                <div class="desc">每行一个 POLYGON WKT（或用分号分隔）。生成后可一键填充到上方并绘制。</div>
                <textarea id="batchInput"></textarea>
                <div class="batch-actions">
                    <button id="generateMultiBtn">生成 MULTIPOLYGON</button>
                    <button id="copyMultiBtn">复制结果</button>
                </div>
                <textarea id="multiOutput" readonly></textarea>
            </div>
        </div>
        <div class="tab-pane" id="tabTrack">
            <div class="tip">请粘贴轨迹文本（支持两种格式：1）每行一条：定位时间yyyyMMddHHmmss, 经度, 纬度；2）单行#分隔：经度,纬度,定位时间yyyyMMddHHmmss#经度,纬度,定位时间yyyyMMddHHmmss#…）。</div>
            <div class="coord-settings" style="margin-bottom:8px;font-size:12px;color:#333;">
                <label>轨迹坐标系：
                    <select id="trackCoordSysSelect" style="margin-left:6px;">
                        <option value="wgs84" selected>WGS84</option>
                        <option value="gcj02">GCJ-02（国测局）</option>
                        <option value="bd09">BD-09（百度）</option>
                        <option value="cgcs2000">CGCS2000</option>
                    </select>
                </label>
            </div>
            <textarea id="trackTextarea" style="width:100%;height:120px;margin-bottom:10px;padding:8px;border:1px solid #ddd;border-radius:4px;font-family:monospace;resize:vertical;box-sizing:border-box;">20250930125620,124.504461,45.342159,5.3
20250930125630,124.504449,45.342141,1.0
20250930125640,124.504459,45.342098,2.2
20250930125650,124.504503,45.342061,0.8
20250930130711,124.504509,45.342037,0.0
20250930130721,124.504532,45.342030,0.0
20250930130731,124.504532,45.342030,0.0
20250930130741,124.504344,45.342010,12.5
20250930130751,124.504155,45.341996,0.0
20250930130801,124.504155,45.341996,0.0
20250930130811,124.504155,45.341996,0.0
20250930130821,124.504155,45.341996,0.0
20250930130831,124.504155,45.341996,0.0
20250930130841,124.504155,45.341996,0.0
20250930130851,124.504155,45.341996,0.0
20250930130901,124.504155,45.341996,0.0
20250930130911,124.504155,45.341996,0.0
20250930130921,124.504155,45.341996,0.0
20250930130931,124.504155,45.341996,0.0
20250930130941,124.504155,45.341996,0.0
20250930130951,124.504075,45.341975,11.1
20250930131001,124.503665,45.341870,12.1
20250930131011,124.503287,45.341748,9.5
20250930131021,124.502906,45.341643,10.5
20250930131031,124.502588,45.341997,16.7
20250930131041,124.502381,45.342301,7.5
20250930131051,124.502120,45.342415,6.7
20250930131101,124.501898,45.342589,16.3
20250930131111,124.501417,45.342698,19.8
20250930131121,124.501102,45.342806,16.5
20250930131131,124.500656,45.343304,22.0
20250930131141,124.500362,45.343601,17.8
20250930131151,124.499969,45.344033,14.8
20250930131201,124.499654,45.344349,22.7
20250930131211,124.499237,45.344797,23.1
20250930131221,124.498825,45.345273,15.0
20250930131231,124.498543,45.345623,17.4
20250930131241,124.498450,45.345856,4.7
20250930131251,124.498572,45.345871,0.0
20250930131301,124.498878,45.345793,6.4
20250930131311,124.498881,45.345772,0.0
20250930131321,124.498881,45.345772,0.0
20250930131331,124.498881,45.345772,0.0
20250930131341,124.498881,45.345772,0.0
20250930131351,124.498881,45.345772,0.0
20250930131401,124.498881,45.345772,0.0
20250930131411,124.498881,45.345772,0.0
20250930131421,124.498881,45.345772,0.0
20250930131431,124.498877,45.345744,7.0
20250930131441,124.498870,45.345607,0.0
20250930131555,124.498870,45.345607,0.0
20250930131605,124.498870,45.345607,0.0
20250930131615,124.498870,45.345607,0.0
20250930131625,124.498906,45.345591,2.4
20250930131635,124.499011,45.345594,2.7
20250930131645,124.499119,45.345601,2.8
20250930131655,124.499223,45.345611,1.5
20250930131705,124.499280,45.345615,1.9
20250930131715,124.499409,45.345625,3.2
20250930131725,124.499431,45.345627,4.0
20250930131735,124.499164,45.345610,7.9
20250930131745,124.498920,45.345585,4.1
20250930131755,124.498959,45.345592,11.2
20250930131805,124.498902,45.345575,0.0
20250930131815,124.498902,45.345575,0.0
20250930131825,124.498894,45.345580,1.2
20250930131835,124.498915,45.345540,1.8
20250930131845,124.498901,45.345579,3.6
20250930131855,124.498954,45.345525,2.8
20250930131905,124.498929,45.345579,0.1
20250930131915,124.498929,45.345579,0.0
20250930131925,124.498982,45.345565,2.9
20250930131935,124.499106,45.345573,3.5
20250930131945,124.499197,45.345580,1.4
20250930131955,124.499292,45.345589,2.8
20250930132005,124.499399,45.345598,2.8
20250930132015,124.499478,45.345602,0.9
20250930132025,124.499301,45.345607,8.3
20250930132035,124.499060,45.345574,6.6
20250930132045,124.498921,45.345579,3.5
20250930132055,124.498957,45.345552,0.0
20250930132105,124.498957,45.345552,0.0
20250930132115,124.498957,45.345552,0.0
20250930132125,124.498970,45.345546,2.4
20250930132135,124.499095,45.345542,3.8
20250930132146,124.499137,45.345545,0.0
20250930132156,124.499137,45.345545,0.0
20250930132206,124.499137,45.345545,0.0
20250930132216,124.499156,45.345547,0.1
20250930132226,124.499168,45.345548,1.4
20250930132236,124.499260,45.345556,2.9
20250930132246,124.499365,45.345564,3.0
20250930132256,124.499476,45.345573,3.1
20250930132306,124.499532,45.345577,0.0
20250930132316,124.499509,45.345576,0.0
20250930132326,124.499509,45.345576,0.0
20250930132336,124.499462,45.345570,2.5
20250930132346,124.499369,45.345568,2.9
20250930132356,124.499263,45.345577,2.8
20250930132406,124.499184,45.345590,1.7
20250930132416,124.499031,45.345603,6.3
20250930132426,124.498921,45.345586,6.7
20250930132436,124.498935,45.345563,0.0
20250930132446,124.498935,45.345563,0.0
20250930143758,124.498991,45.345520,0.0
20250930143808,124.499032,45.345512,2.5
20250930143818,124.499066,45.345512,2.1
20250930143828,124.499064,45.345513,4.0
20250930143838,124.499086,45.345513,0.0
20250930143848,124.499117,45.345514,0.7
20250930143858,124.499212,45.345522,3.9
20250930143908,124.499349,45.345533,3.7
20250930143918,124.499481,45.345544,3.6
20250930143928,124.499370,45.345543,7.5
20250930143938,124.499149,45.345523,5.7
20250930143948,124.499135,45.345521,0.0
20250930143958,124.499142,45.345521,3.0
20250930144008,124.499064,45.345513,0.0
20250930144018,124.499019,45.345519,2.2
20250930144028,124.498977,45.345533,4.5
20250930144038,124.498994,45.345493,0.7
20250930144048,124.498997,45.345486,0.0
20250930144058,124.498997,45.345486,0.0
20250930144108,124.499005,45.345460,3.6
20250930144118,124.499023,45.345398,3.4
20250930144128,124.499006,45.345460,2.8
20250930144138,124.498984,45.345479,2.4
20250930144148,124.498991,45.345490,4.0
20250930144158,124.498940,45.345451,1.5
20250930144208,124.499002,45.345527,3.4
20250930144218,124.499055,45.345429,4.4
20250930144228,124.499039,45.345476,3.4
20250930144238,124.499084,45.345486,3.2
20250930144248,124.499224,45.345493,5.3
20250930144258,124.499387,45.345508,4.2
20250930144308,124.499516,45.345516,8.0
20250930144318,124.499122,45.345495,8.1
20250930144328,124.499079,45.345493,4.9
20250930144338,124.499035,45.345489,2.9
20250930144349,124.499066,45.345467,1.7
20250930144359,124.499196,45.345464,4.5
20250930144409,124.499367,45.345478,5.1
20250930144419,124.499532,45.345490,1.4
20250930144429,124.499200,45.345476,7.4
20250930144439,124.499040,45.345488,2.5
20250930144449,124.499078,45.345444,0.0
20250930144459,124.499126,45.345434,3.4
20250930144509,124.499271,45.345441,4.6
20250930144519,124.499431,45.345453,4.7
20250930144529,124.499464,45.345455,11.7
20250930144539,124.499168,45.345438,6.0
20250930144549,124.499061,45.345435,3.7
20250930144559,124.499111,45.345410,3.2
20250930144609,124.499235,45.345411,4.8
20250930144619,124.499412,45.345424,5.6
20250930144629,124.499507,45.345430,7.8
20250930144639,124.499218,45.345422,5.3
20250930144649,124.499056,45.345428,2.9
20250930144659,124.499069,45.345411,1.8
20250930144709,124.499093,45.345399,5.5
20250930144719,124.499202,45.345396,3.7
20250930144729,124.499402,45.345410,6.4
20250930144739,124.499491,45.345417,7.8
20250930144749,124.499330,45.345432,5.9
20250930144759,124.499361,45.345532,1.6
20250930144809,124.499341,45.345625,5.3
20250930144819,124.499279,45.345740,5.5
20250930144829,124.499099,45.345872,6.5
20250930144839,124.498980,45.345921,0.0
20250930145119,124.498970,45.345908,0.0
20250930145129,124.498967,45.345906,0.0
20250930145139,124.498965,45.345906,0.0
20250930145149,124.498915,45.345899,4.7
20250930145159,124.498609,45.345922,8.6
20250930145209,124.498546,45.345900,0.0
20250930145219,124.498484,45.345880,6.1
20250930145229,124.498416,45.345836,0.0
20250930145239,124.498444,45.345744,11.2
20250930145249,124.498735,45.345392,20.8
20250930145259,124.499128,45.344941,28.8
20250930145309,124.499532,45.344476,4.4
20250930145319,124.499820,45.344178,23.7
20250930145329,124.500166,45.343821,10.3
20250930145339,124.500391,45.343557,18.7
20250930145349,124.500837,45.343101,22.0
20250930145359,124.501129,45.342775,9.5
20250930145409,124.501415,45.342702,12.8
20250930145419,124.501836,45.342651,16.1
20250930145429,124.502118,45.342423,5.5
20250930145439,124.502344,45.342354,5.8
20250930145449,124.502545,45.342073,20.7
20250930145459,124.502815,45.341705,10.2
20250930145509,124.503013,45.341655,9.5
20250930145519,124.503502,45.341822,21.1
20250930145529,124.504184,45.341975,19.3
20250930145539,124.504547,45.341988,4.5
20250930145549,124.504500,45.342051,3.8
20250930145559,124.504448,45.342116,1.7
20250930145609,124.504460,45.342167,3.0
20250930145619,124.504525,45.342199,0.0</textarea>
            <div class="button-group">
                <button id="drawTrackButton" disabled style="flex: 1;">绘制轨迹</button>
                <button id="showTrackPointsButton" disabled style="flex: 1;" class="btn-warning">打点</button>
                <button id="clearTrackButton" disabled style="flex: 1;">清空轨迹</button>
            </div>
            <!-- 回放控制 -->
            <div class="split-section" style="margin-top:8px;">
                <div class="title">轨迹回放</div>
                <div class="playback-actions" style="display:flex;gap:8px;margin-bottom:8px;">
                    <button id="playbackStartBtn" disabled>开始</button>
                    <button id="playbackPauseBtn" disabled>继续</button>
                    <button id="playbackStopBtn" disabled>结束</button>
                </div>
                <div class="playback-speed" style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                    <label>速度：
                        <select id="playbackSpeedSelect" disabled>
                            <option value="1" selected>1×</option>
                            <option value="2">2×</option>
                            <option value="4">4×</option>
                            <option value="8">8×</option>
                            <option value="16">16×</option>
                            <option value="32">32×</option>
                            <option value="64">64×</option>
                            <option value="128">128×</option>
                            <option value="256">256×</option>
                            <option value="512">512×</option>
                            <option value="1024">1024×</option>
                        </select>
                    </label>
                    <span id="playbackTimeLabel" style="font-size:12px;color:#666;">时间：—</span>
                </div>
                <div class="playback-time" style="display:flex;flex-direction:column;gap:4px;margin-bottom:8px;">
                    <label class="playback-time-label" style="display:flex;align-items:center;gap:8px;flex:1 1 auto;min-width:0;">
                        <span class="playback-time-text" style="white-space:nowrap;">起始时间：</span>
                        <input type="range" id="playbackTimeSlider" disabled min="0" max="0" step="1000" value="0" style="flex:1 1 auto;min-width:0;max-width:100%;vertical-align:middle;">
                    </label>
                    <span id="playbackTimeCursor" style="font-size:12px;color:#666;align-self:flex-end;">—</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let map;
    let currentPolygons = []; // 存储多边形和其标签
    let currentTracks = []; // 存储轨迹折线及相关覆盖物
    let mapLoaded = false;
    let mapLabelHandlers = []; // 存储地图事件处理器
    let labelsEnabled = false; // 标签显示开关（默认关闭）
    let isDrawing = false; // 绘制进行中防止重复点击

    window.onload = function () {
        if (typeof T === 'undefined') {
            alert("天地图API加载失败，请检查网络或密钥！");
            return;
        }
        initMap();
        bindDrawEvent();
        bindMinimizeEvent();
        bindTabs();
        bindBatchGenerator();
        bindMultiSplitter();
        bindLabelsToggle(); // 绑定标签显示开关
        bindTrackEvents();  // 绑定轨迹绘制与清空
        bindPlaybackControls(); // 绑定轨迹回放
    };

    function initMap() {
        showLoading();
        disableButtons(true);

        try {
            map = new T.Map("mapContainer", {
                zoom: 12,
                center: new T.LngLat(116.40769, 39.90403)
            });

            // 已移除测试标签
            map.enableScrollWheelZoom();

            // 添加地图类型控件
            const mapTypeCtrl = new T.Control.MapType({
                mapTypes: [TMAP_NORMAL_MAP, TMAP_SATELLITE_MAP, TMAP_TERRAIN_MAP],
                position: T_ANCHOR_TOP_LEFT
            });
            map.addControl(mapTypeCtrl);

            // 加载影像底图（卫星）
            const tk = "648f621977051d0199ff0f965d3fd322";

            // 方案1：使用默认地图类型（作为备选）
            map.setMapType(TMAP_SATELLITE_MAP);

            // 方案2：手动添加影像图层（底图 + 标注）
            const vecLayer = new T.TileLayer(`https://t0.tianditu.gov.cn/img_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=img&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`);
            const cvaLayer = new T.TileLayer(`https://t0.tianditu.gov.cn/cia_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cia&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`);

            // 添加图层并监听加载状态
            vecLayer.addEventListener("load", function () {
                console.log("影像底图加载完成");
            });

            vecLayer.addEventListener("error", function (e) {
                console.error("影像底图加载错误:", e);
                alert("影像底图加载错误，将使用默认地图类型");
            });

            map.addLayer(vecLayer);
            map.addLayer(cvaLayer);

            // 监听地图加载事件
            map.addEventListener("loaded", function () {
                console.log("地图加载完成");
                markMapLoaded();
            });
            map.addEventListener("load", function () {
                console.log("地图load事件触发");
                markMapLoaded();
            });
            map.addEventListener("tilesloaded", function () {
                console.log("地图瓦片加载完成");
                markMapLoaded();
            });
            // 监听地图加载失败事件
            map.addEventListener("error", function (e) {
                console.error("地图加载错误:", e);
                alert("地图加载错误: " + e.message);
                hideLoading();
            });

            // 监听地图移动事件，用于更新标签位置
            const moveHandler = function () {
                updateAllLabelsPosition();
            };
            map.addEventListener("move", moveHandler);
            map.addEventListener("zoom", moveHandler);

            // 存储事件处理器，用于清理
            mapLabelHandlers.push({ event: "move", handler: moveHandler });
            mapLabelHandlers.push({ event: "zoom", handler: moveHandler });

            // 超时容错
            setTimeout(() => {
                if (!mapLoaded) markMapLoaded();
            }, 8000);

        } catch (error) {
            alert("地图初始化失败：" + error.message);
            console.error(error);
            hideLoading();
        }
    }

    function markMapLoaded() {
        if (!mapLoaded) {
            mapLoaded = true;
            hideLoading();
            disableButtons(false);
            disableTrackButtons(false);
            // 仅开启速度选择，回放按钮按状态控制
            const speedSel = document.getElementById('playbackSpeedSelect');
            if (speedSel) speedSel.disabled = false;
            updatePlaybackButtonsState('idle');
        }
    }

    function showLoading() {
        const loading = document.getElementById("mapLoading");
        loading.style.display = "flex";
        loading.style.opacity = "1";
    }

    function hideLoading() {
        const loading = document.getElementById("mapLoading");
        loading.style.opacity = "0";
        setTimeout(() => loading.style.display = "none", 300);
    }

    function disableButtons(disabled) {
        document.getElementById("drawButton").disabled = disabled;
        document.getElementById("clearButton").disabled = disabled;
    }

    function disableTrackButtons(disabled) {
        const drawTrackBtn = document.getElementById("drawTrackButton");
        const showTrackPointsBtn = document.getElementById("showTrackPointsButton");
        const clearTrackBtn = document.getElementById("clearTrackButton");
        if (drawTrackBtn) drawTrackBtn.disabled = disabled;
        if (showTrackPointsBtn) showTrackPointsBtn.disabled = disabled;
        if (clearTrackBtn) clearTrackBtn.disabled = disabled;
    }
    // 回放控件的禁用/启用
    function disablePlaybackButtons(disabled) {
        ["playbackStartBtn","playbackPauseBtn","playbackStopBtn","playbackSpeedSelect","playbackTimeSlider"].forEach(id=>{
            const el = document.getElementById(id);
            if (el) el.disabled = disabled;
        });
    }

    // 回放按钮状态管理：空闲/播放/暂停
    function updatePlaybackButtonsState(state){
        try {
            const startBtn = document.getElementById('playbackStartBtn');
            const pauseBtn = document.getElementById('playbackPauseBtn');
            const stopBtn = document.getElementById('playbackStopBtn');
            if (!startBtn || !pauseBtn || !stopBtn) return;
            if (state === 'idle') {
                startBtn.disabled = false;
                pauseBtn.disabled = true;
                stopBtn.disabled = true;
                pauseBtn.textContent = '继续';
            } else if (state === 'playing') {
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
                pauseBtn.textContent = '暂停';
            } else if (state === 'paused') {
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
                pauseBtn.textContent = '继续';
            }
        } catch(e) { console.warn('更新按钮状态失败:', e); }
    }

    function bindDrawEvent() {
        document.getElementById("drawButton").addEventListener("click", function () {
            if (isDrawing) { console.log('绘制进行中，忽略重复点击'); return; }
            isDrawing = true;
            disableButtons(true);
            showLoading();
            try {
                const wktStr = document.getElementById("wktTextarea").value.trim();
                if (!wktStr) { alert("请输入WKT字符串！"); return; }
                clearOverlays();
                const geojson = parseWkt(wktStr);
    
                const polygonData = [];
                if (geojson.type === "Polygon") {
                    polygonData.push({ index: 1, coordinates: geojson.coordinates });
                } else if (geojson.type === "MultiPolygon") {
                    geojson.coordinates.forEach((polygon, index) => {
                        polygonData.push({ index: index + 1, coordinates: polygon });
                    });
                }
    
                // 重置并绘制
                polygonInfoList = [];
                polygonData.forEach(pd => processPolygon(pd.index, pd.coordinates));
    
                // 视图居中到所有已绘制轮廓
                try { fitViewportToPolygons(); } catch (e) { console.warn('视图居中失败', e); }
    
                // 在视图稳定后再创建/更新标签
                setTimeout(() => {
                    if (labelsEnabled) {
                        try {
                            createAllLabels();
                            updateAllLabelsPosition();
                        } catch (e) {
                            console.warn('创建或更新标签失败:', e);
                        }
                    }
                }, 150);
            } catch (e) {
                alert('绘制失败：' + (e && e.message ? e.message : e));
                console.error('绘制异常:', e);
            } finally {
                hideLoading();
                isDrawing = false;
                disableButtons(false);
            }
        });

        document.getElementById("clearButton").addEventListener("click", function () {
            if (isDrawing) { console.log('绘制进行中，暂不清空'); return; }
            clearOverlays();
            console.log("已清空所有轮廓");
        });
    }

    // 存储多边形数据，用于后续标签创建
    let polygonInfoList = [];

    // 处理单个多边形的绘制和面积计算
    function processPolygon(actualPolygonIndex, polygonCoords) {
        console.log('开始处理多边形', actualPolygonIndex);

        // 坐标系选择（绘制始终使用WGS84坐标）
        const coordSys = (document.getElementById('coordSysSelect') && document.getElementById('coordSysSelect').value) || 'wgs84';

        // 统一转换为WGS84用于绘制与面积计算
        function toWgs(point){
            const lng = point[0], lat = point[1];
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                return [lng, lat];
            } else if (coordSys === 'gcj02') {
                const w = gcj02ToWgs84(lng, lat);
                return [w.lng, w.lat];
            } else if (coordSys === 'bd09') {
                const gcj = bd09ToGcj02(lng, lat);
                const w = gcj02ToWgs84(gcj.lng, gcj.lat);
                return [w.lng, w.lat];
            }
            return [lng, lat];
        }
        const coordsWGS84 = polygonCoords.map(ring => ring.map(toWgs));
        let outerRingWGS = coordsWGS84[0] || [];

        // 生成用于绘制的坐标（直接使用WGS84坐标）
        const rings = coordsWGS84.map(ring => ring.map(([lng, lat]) => new T.LngLat(lng, lat)));


         // 创建半透明填充的多边形（无边框）
          const polygon = new T.Polygon(rings, {
              color: "#FFD700",
              weight: 1,
              opacity: 1,
              fillColor: "#FFFF00",
              fillOpacity: 0.35
          });
 
          // 使用WGS84坐标计算面积（更准确的面积计算）
         let areaSqm;
         let areaMu;



         try {
             // 检查Turf.js是否可用
             if (typeof turf !== 'undefined' && turf.area) {
                 // 使用Turf.js计算多边形面积
                // 构造GeoJSON格式的多边形
                const geoJsonPolygon = {
                    type: "Polygon",
                    coordinates: coordsWGS84
                };


                 // 使用Turf.js计算面积（平方米）
                 areaSqm = turf.area(geoJsonPolygon);
                 areaMu = (areaSqm / 666.6667).toFixed(4); // 转换为亩
                 console.log(`多边形${actualPolygonIndex}面积计算结果(Turf.js): ${areaSqm}平方米 = ${areaMu}亩`);
             } else {
                 // 如果Turf.js不可用，回退到之前的计算方法
                 console.warn('Turf.js不可用，使用备用计算方法');
                 // 计算带孔洞的多边形面积
                 areaSqm = 0;
                 // 计算外环面积
                 outerRingWGS = coordsWGS84[0] || [];
                 areaSqm += calculatePolygonArea(outerRingWGS);

                 // 减去内环（孔洞）面积
                 for (let i = 1; i < coordsWGS84.length; i++) {
                     const innerRingArea = calculatePolygonArea(coordsWGS84[i]);
                     areaSqm -= innerRingArea;
                 }

                  areaMu = (areaSqm / 666.6667).toFixed(4); // 使用更精确的转换系数
                  console.log(`多边形${actualPolygonIndex}面积计算结果(备用): ${areaSqm}平方米 = ${areaMu}亩`);
              }
          } catch (error) {
              console.error(`面积计算失败:`, error);
              areaSqm = 0;
              areaMu = '0.0000';
          }

          // 计算多边形的中心点和底部中心点（WGS84）
          const centerPoint = calculatePolygonCenter(outerRingWGS);
          const bottomCenterPoint = calculatePolygonBottomCenter(outerRingWGS);

          // 添加多边形到地图
          if (map) {
              map.addOverLay(polygon);
              console.log(`多边形${actualPolygonIndex}已添加到地图`);
          } else {
              console.error('地图对象不存在');
          }

          // 存储多边形信息，用于后续标签创建
          polygonInfoList.push({
              index: actualPolygonIndex,
              polygon: polygon,
              area: areaMu,
              bottomCenter: { lng: bottomCenterPoint.lng, lat: bottomCenterPoint.lat },
              ringPoints: rings
          });
      }

    // 视图居中：根据已绘制的GCJ-02点
    function fitViewportToPolygons() {
        const points = [];
        try {
            if (!map || !map.setViewport) return;
            polygonInfoList.forEach(info => {
                if (!info || !info.ringPoints) return;
                info.ringPoints.forEach(ring => {
                    ring.forEach(ll => points.push(ll));
                });
            });
            if (!points.length) return;
            map.setViewport(points);
        } catch (e) {
            try {
                const lngs = points.map(p => p.lng);
                const lats = points.map(p => p.lat);
                const center = new T.LngLat(
                    (Math.min(...lngs) + Math.max(...lngs)) / 2,
                    (Math.min(...lats) + Math.max(...lats)) / 2
                );
                if (map && map.panTo) map.panTo(center);
            } catch (e2) {
                console.warn('视图居中失败:', e2);
            }
        }
    }

    // 统一创建所有多边形的标签
    function createAllLabels() {
        const mapContainer = document.getElementById('mapContainer');
        if (!mapContainer || !map) return;

        polygonInfoList.forEach(info => {
            if (!info) return;
            // 防止重复创建
            if (info.labelRef) return;
            // 创建标签元素
            const labelDiv = document.createElement('div');
            labelDiv.className = 'area-label';
            labelDiv.innerHTML = `多边形${info.index}：${info.area}亩`;

            // 添加到地图容器并根据屏幕边界定位到轮廓下方
            mapContainer.appendChild(labelDiv);
            positionLabelForPolygon(labelDiv, info);

            // 记录引用，避免重复创建
            info.labelRef = labelDiv;

            // 存储到 currentPolygons 以复用现有定位/清理逻辑
            const labelObj = {
                domElement: labelDiv,
                isDomLabel: true,
                polygonInfo: info
            };
            currentPolygons.push({ polygon: info.polygon, label: labelObj });
        });

        // 不清空 polygonInfoList，便于开关随时创建/隐藏标签
    }

    // 根据多边形屏幕边界定位标签，保证始终在轮廓下方
    function positionLabelForPolygon(labelDiv, info) {
        if (!map || !info || !info.ringPoints) return;
        const points = [];
        info.ringPoints.forEach(ring => {
            ring.forEach(ll => {
                const p = map.lngLatToContainerPoint(ll);
                points.push(p);
            });
        });
        if (!points.length) return;
        const minX = Math.min(...points.map(p => p.x));
        const maxX = Math.max(...points.map(p => p.x));
        const maxY = Math.max(...points.map(p => p.y));
        const container = document.getElementById('mapContainer');
        const labelWidth = labelDiv.offsetWidth;
        const labelHeight = labelDiv.offsetHeight;
        const targetLeft = Math.round((minX + maxX) / 2 - labelWidth / 2);
        const targetTop = Math.round(maxY + 6);
        const clampedLeft = Math.max(0, Math.min(targetLeft, container.clientWidth - labelWidth));
        const clampedTop = Math.max(0, Math.min(targetTop, container.clientHeight - labelHeight));
        labelDiv.style.left = clampedLeft + 'px';
        labelDiv.style.top = clampedTop + 'px';
    }

    // 更新所有标签位置（地图move/zoom时调用）
    function updateAllLabelsPosition() {
        try {
            if (!map) return;
            const container = document.getElementById('mapContainer');
            if (!container) return;
            currentPolygons.forEach(item => {
                if (!item || !item.label) return;
                const labelObj = item.label;
                if (labelObj.isDomLabel && labelObj.domElement && labelObj.polygonInfo) {
                    // 确保标签在容器中
                    if (!labelObj.domElement.parentNode) {
                        container.appendChild(labelObj.domElement);
                    }
                    positionLabelForPolygon(labelObj.domElement, labelObj.polygonInfo);
                }
            });
        } catch (e) {
            console.warn('更新标签位置时出错:', e);
        }
    }
    // 确保在全局可用（处理第三方库事件回调作用域差异）
    window.updateAllLabelsPosition = updateAllLabelsPosition;

    // 绑定“显示亩数标签”开关（默认隐藏）
    function bindLabelsToggle() {
        const cb = document.getElementById('toggleLabelsCheckbox');
        const container = document.getElementById('mapContainer');
        if (!cb || !container) return;
        // 默认隐藏标签
        container.classList.add('labels-hidden');
        cb.addEventListener('change', () => {
            labelsEnabled = cb.checked;
            if (labelsEnabled) {
                container.classList.remove('labels-hidden');
                const hasAnyLabel = currentPolygons.some(item => item && item.label && item.label.domElement);
                if (!hasAnyLabel) {
                    try { createAllLabels(); } catch (e) { console.warn('创建标签失败:', e); }
                }
                updateAllLabelsPosition();
            } else {
                container.classList.add('labels-hidden');
            }
        });
    }

    /**
     * 计算多边形中心点（比底部中心更适合显示标签）
     */
    function calculatePolygonCenter(outerRing) {
        let sumLng = 0, sumLat = 0;
        const len = outerRing.length;

        for (let i = 0; i < len; i++) {
            sumLng += outerRing[i][0];
            sumLat += outerRing[i][1];
        }

        return {
            lng: sumLng / len,
            lat: sumLat / len
        };
    }

    /**
     * 计算多边形面积（球面多边形面积计算）
     * 使用更准确的球面坐标面积计算方法，确保面积与视觉大小一致
     */
    function calculatePolygonArea(coordinates) {
        // 地球半径（米）- 使用更精确的值
        const R = 6371000.8;
        const n = coordinates.length;

        // 将所有坐标转换为弧度
        const coordsRad = coordinates.map(point => [
            point[0] * Math.PI / 180,
            point[1] * Math.PI / 180
        ]);

        let areaRad = 0;

        // 使用更准确的球面多边形面积公式（Girard定理）
        for (let i = 0; i < n; i++) {
            const j = (i + 1) % n;
            const lon1 = coordsRad[i][0];
            const lat1 = coordsRad[i][1];
            const lon2 = coordsRad[j][0];
            const lat2 = coordsRad[j][1];

            // 计算球面多边形面积增量
            const dlon = lon2 - lon1;
            const sinLat1 = Math.sin(lat1);
            const sinLat2 = Math.sin(lat2);
            const cosLat1 = Math.cos(lat1);
            const cosLat2 = Math.cos(lat2);

            // 使用更精确的公式
            areaRad += dlon * (sinLat1 * cosLat2 * Math.cos(dlon / 2) + sinLat2 * cosLat1);
        }

        // 计算总面积（平方米）
        const areaSqm = Math.abs(areaRad) * R * R * 0.5;

        return areaSqm;
    }

    /**
     * 清空所有多边形和标签（同时处理 polygonInfoList 与 currentPolygons）
     */
    function clearOverlays() {
        try {
            // 先移除 polygonInfoList 中记录的多边形与其DOM标签
            polygonInfoList.forEach(info => {
                if (info && info.polygon && map && map.removeOverLay) {
                    try { map.removeOverLay(info.polygon); } catch (e) { console.warn('移除多边形失败:', e); }
                }
                if (info && info.labelRef && info.labelRef.parentNode) {
                    try { info.labelRef.parentNode.removeChild(info.labelRef); } catch (e) { console.warn('移除DOM标签失败:', e); }
                    info.labelRef = null;
                }
            });

            // 再处理 currentPolygons（兼容旧路径与标签对象）
            currentPolygons.forEach(item => {
                if (item.polygon && map && map.removeOverLay) {
                    try { map.removeOverLay(item.polygon); } catch (e) { console.warn('移除多边形失败:', e); }
                }
                if (item.label) {
                    if (item.label.domElement && item.label.domElement.parentNode) {
                        try { item.label.domElement.parentNode.removeChild(item.label.domElement); } catch (e) { console.warn('移除DOM标签失败:', e); }
                    } else if (map && map.removeOverLay && !item.label.isDomLabel) {
                        try { map.removeOverLay(item.label); } catch (e) { console.warn('移除地图覆盖物标签失败:', e); }
                    }
                }
            });

            // 清空记录数组
            currentPolygons = [];
            polygonInfoList = [];

            console.log('已清空所有多边形和标签（保留事件监听器）');
        } catch (error) {
            console.error('清空覆盖物时出错:', error);
        }
    }

    // 其他辅助函数（保持不变）
    function bindMinimizeEvent() {
        const container = document.querySelector(".wkt-input-container");
        const btn = document.getElementById("minimizeBtn");
        const minIcon = btn?.querySelector(".min-icon");
        const restoreIcon = btn?.querySelector(".restore-icon");

        btn?.addEventListener("click", () => {
            const minimized = container.classList.toggle("minimized");
            if (minIcon && restoreIcon) {
                if (minimized) {
                    minIcon.style.display = "none";
                    restoreIcon.style.display = "";
                } else {
                    minIcon.style.display = "";
                    restoreIcon.style.display = "none";
                }
            }
        });
    }

    // 在脚本内部补充：页签切换（3个页签）
     function bindTabs() {
         const tabs = [
             { btn: document.getElementById('tabDrawBtn'), pane: document.getElementById('tabDraw'), key: 'draw' },
             { btn: document.getElementById('tabTrackBtn'), pane: document.getElementById('tabTrack'), key: 'track' },
             { btn: document.getElementById('tabSplitBtn'), pane: document.getElementById('tabSplit'), key: 'split' },
             { btn: document.getElementById('tabBatchBtn'), pane: document.getElementById('tabBatch'), key: 'batch' },
         ];
         if (tabs.some(t => !t.btn || !t.pane)) return;
         function activate(key) {
             tabs.forEach(t => {
                 const active = t.key === key;
                 t.btn.classList.toggle('active', active);
                 t.pane.classList.toggle('active', active);
             });
         }
         tabs.forEach(t => t.btn.addEventListener('click', () => activate(t.key)));
         activate('draw');
     }
    function updateParserStatus() {
        const el = document.getElementById('parserStatus');
        if (!el) return;
        const ok = (typeof Terraformer !== 'undefined' && Terraformer.WKT && typeof Terraformer.WKT.parse === 'function');
        if (ok) {
            el.textContent = 'Terraformer WKT Parser';
            el.style.color = '#2f8f2f';
        } else {
            el.textContent = '本地回退解析（仅支持POLYGON/MULTIPOLYGON）';
            el.style.color = '#c77d1e';
        }
    }
     function parseWkt(wkt) {
         wkt = wkt.trim();
         // 优先使用成熟库（Terraformer WKT Parser）
         if (typeof Terraformer !== 'undefined' && Terraformer.WKT && Terraformer.WKT.parse) {
             try {
                 return Terraformer.WKT.parse(wkt);
             } catch (e) {
                 console.warn('Terraformer解析失败，尝试本地回退解析:', e);
             }
         } else {
             // 不再提示“未加载”，由状态栏展示回退信息
         }
         // 回退解析：仅支持 POLYGON / MULTIPOLYGON
         const typeMatch = wkt.match(/^\s*(POLYGON|MULTIPOLYGON)\s*\(/i);
         if (!typeMatch) throw new Error('仅支持POLYGON/MULTIPOLYGON');
         const type = typeMatch[1].toUpperCase();
         const inner = wkt.substring(wkt.indexOf('('));
         if (type === 'POLYGON') {
             const coords = parsePolygonCoords(inner.replace(/^\(/, '').replace(/\)$/, ''));
             return { type: 'Polygon', coordinates: coords };
         } else {
             const trimmed = inner.replace(/^\(\(/, '').replace(/\)\)$/, '');
             const coords = parseMultiPolygonCoords(trimmed);
             return { type: 'MultiPolygon', coordinates: coords };
         }
     }

     function bindMultiSplitter() {
         const input = document.getElementById('multiInput');
         const output = document.getElementById('polyOutput');
         const splitBtn = document.getElementById('splitMultiBtn');
         const copyBtn = document.getElementById('copyPolysBtn');
         if (!input || !output || !splitBtn || !copyBtn) return;

         // 本地WKT序列化辅助
         function ringToText(ring) {
             if (!ring || !ring.length) return '()';
             const first = ring[0];
             const last = ring[ring.length - 1];
             const closed = (first[0] === last[0] && first[1] === last[1]) ? ring : ring.concat([[first[0], first[1]]]);
             return '(' + closed.map(pt => pt[0] + ' ' + pt[1]).join(', ') + ')';
         }
         function toWktPolygonCoords(coords) {
             return 'POLYGON(' + coords.map(ringToText).join(', ') + ')';
         }
         function toWktMulti(coords) {
             return 'MULTIPOLYGON(' + coords.map(poly => '(' + poly.map(ringToText).join(', ') + ')').join(', ') + ')';
         }

         function polygonsFromMulti(text) {
             const geo = parseWkt(text.trim());
             if (geo.type !== 'MultiPolygon') throw new Error('请输入有效的 MULTIPOLYGON WKT');
             const polys = geo.coordinates.map(rings => toWktPolygonCoords(rings));
             return polys;
         }
         splitBtn.addEventListener('click', () => {
             try {
                 const list = polygonsFromMulti(input.value.trim());
                 output.value = list.join('\n');
             } catch (e) {
                 alert('分割失败：' + e.message);
             }
         });
         copyBtn.addEventListener('click', async () => {
             const val = output.value.trim();
             if (!val) { alert('没有可复制的结果'); return; }
             try { await navigator.clipboard.writeText(val); alert('已复制到剪贴板'); } catch (e) { console.warn('复制失败', e); }
         });
     }

     function bindBatchGenerator() {
         const batchInput = document.getElementById('batchInput');
         const output = document.getElementById('multiOutput');
         const genBtn = document.getElementById('generateMultiBtn');
         const copyBtn = document.getElementById('copyMultiBtn');

         // 本地WKT序列化辅助（与分割器保持一致）
         function ringToText(ring) {
             if (!ring || !ring.length) return '()';
             const first = ring[0];
             const last = ring[ring.length - 1];
             const closed = (first[0] === last[0] && first[1] === last[1]) ? ring : ring.concat([[first[0], first[1]]]);
             return '(' + closed.map(pt => pt[0] + ' ' + pt[1]).join(', ') + ')';
         }
         function toWktMulti(coords) {
             return 'MULTIPOLYGON(' + coords.map(poly => '(' + poly.map(ringToText).join(', ') + ')').join(', ') + ')';
         }

         genBtn.addEventListener('click', () => {
             try {
                 const lines = batchInput.value.trim().split(/\n|;/).map(s => s.trim()).filter(Boolean);
                 if (lines.length === 0) throw new Error('请按每行或分号输入至少一个POLYGON');
                 const polygons = lines.map((line, idx) => {
                     const g = parseWkt(line);
                     if (g.type !== 'Polygon') throw new Error(`第${idx + 1}行不是有效的POLYGON WKT`);
                     return g;
                 });
                 const multiGeo = { type: 'MultiPolygon', coordinates: polygons.map(p => p.coordinates) };
                 output.value = toWktMulti(multiGeo.coordinates);
             } catch (e) {
                 alert('生成失败：' + e.message);
             }
         });

         copyBtn.addEventListener('click', async () => {
             const val = output.value.trim();
             if (!val) { alert('没有可复制的结果'); return; }
             try { await navigator.clipboard.writeText(val); alert('已复制到剪贴板'); } catch (e) { console.warn('复制失败', e); }
         });

     }

     function setExampleWkt() {
         const exampleWkt = "MULTIPOLYGON(" +
             "(" +
             "(116.35 39.93, 116.39 39.93, 116.39 39.90, 116.35 39.90, 116.35 39.93)," + // 外环
             "(116.36 39.92, 116.38 39.92, 116.38 39.91, 116.36 39.91, 116.36 39.92)" +  // 内环
             ")," +
             "(" +
             "(116.40 39.95, 116.43 39.97, 116.46 39.96, 116.49 39.98, 116.52 39.95, 116.55 39.93, 116.58 39.94, 116.61 39.92, 116.64 39.95, 116.40 39.95)" +
             ")" +
             ")";
         document.getElementById("wktTextarea").value = exampleWkt;
     }

     function parsePolygonCoords(coordStr) {
         const ringStrs = coordStr.split(/\)\s*,\s*\(/).map(s => s.replace(/[()]/g, '').trim());
         const rings = [];
         ringStrs.forEach(ringStr => {
             const pts = ringStr.split(/,\s*/).map(pointStr => {
                 const [lng, lat] = pointStr.split(/\s+/).map(Number);
                 if (isNaN(lng) || isNaN(lat)) throw new Error("坐标格式错误：" + pointStr);
                 return [lng, lat];
             });
             // 自动拆分：如果一个ring中包含多次回到起点（闭合），则拆分为多个环
             // 兼容用户将外环与内环错误地写在同一对括号中的情况
             let start = 0;
             while (start < pts.length) {
                 const startPt = pts[start];
                 let closeIdx = -1;
                 for (let i = start + 1; i < pts.length; i++) {
                     if (pts[i][0] === startPt[0] && pts[i][1] === startPt[1]) {
                         closeIdx = i;
                         break;
                     }
                 }
                 if (closeIdx === -1) {
                     // 未找到闭合：将剩余点视为一个环，并强制闭合
                     const ring = pts.slice(start);
                     if (ring.length && (ring[0][0] !== ring[ring.length - 1][0] || ring[0][1] !== ring[ring.length - 1][1])) {
                         ring.push([ring[0][0], ring[0][1]]);
                     }
                     rings.push(ring);
                     break;
                 } else {
                     const ring = pts.slice(start, closeIdx + 1);
                     rings.push(ring);
                     start = closeIdx + 1;
                 }
             }
         });
         return rings;
     }

     function parseMultiPolygonCoords(coordStr) {
         const polygonStrs = coordStr.split(/\)\s*\)\s*,\s*\(\s*\(/).map(s => s.replace(/[()]/g, '').trim());
         return polygonStrs.map(polygonStr => parsePolygonCoords(polygonStr));
     }

     function wgs84ToGcj02(lng, lat) {
         const x_PI = 3.14159265358979324 * 3000.0 / 180.0;
         const PI = 3.1415926535897932384626;
         const a = 6378245.0;
         const ee = 0.00669342162296594323;

         if (outOfChina(lng, lat)) return { lng, lat };

         let dlat = transformLat(lng - 105.0, lat - 35.0);
         let dlng = transformLng(lng - 105.0, lat - 35.0);
         const radlat = lat / 180.0 * PI;
         let magic = Math.sin(radlat);
         magic = 1 - ee * magic * magic;
         const sqrtmagic = Math.sqrt(magic);
         dlat = (dlat * 180.0) / ((a * (1 - ee)) / (magic * sqrtmagic) * PI);
         dlng = (dlng * 180.0) / (a / sqrtmagic * Math.cos(radlat) * PI);

         return { lng: lng + dlng, lat: lat + dlat };

         function outOfChina(lng, lat) {
             return (lng < 72.004 || lng > 137.8347) || (lat < 0.8293 || lat > 55.8271);
         }

         function transformLat(x, y) {
             let ret = -100.0 + 2.0 * x + 3.0 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * Math.sqrt(Math.abs(x));
             ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
             ret += (20.0 * Math.sin(y * PI) + 40.0 * Math.sin(y / 3.0 * PI)) * 2.0 / 3.0;
             ret += (160.0 * Math.sin(y / 12.0 * PI) + 320 * Math.sin(y * PI / 30.0)) * 2.0 / 3.0;
             return ret;
         }

         function transformLng(x, y) {
             let ret = 300.0 + x + 2.0 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * Math.sqrt(Math.abs(x));
             ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
             ret += (20.0 * Math.sin(x * PI) + 40.0 * Math.sin(x / 3.0 * PI)) * 2.0 / 3.0;
             ret += (150.0 * Math.sin(x / 12.0 * PI) + 300.0 * Math.sin(x / 30.0 * PI)) * 2.0 / 3.0;
             return ret;
         }
     }

     function gcj02ToWgs84(lng, lat) {
         const g = wgs84ToGcj02(lng, lat);
         return { lng: lng * 2 - g.lng, lat: lat * 2 - g.lat };
     }

     function bd09ToGcj02(bdLng, bdLat) {
         const x_PI = 3.14159265358979324 * 3000.0 / 180.0;
         const x = bdLng - 0.0065;
         const y = bdLat - 0.006;
         const z = Math.sqrt(x * x + y * y) - 0.00002 * Math.sin(y * x_PI);
         const theta = Math.atan2(y, x) - 0.000003 * Math.cos(x * x_PI);
         const ggLng = z * Math.cos(theta);
         const ggLat = z * Math.sin(theta);
         return { lng: ggLng, lat: ggLat };
     }

     function calculatePolygonBottomCenter(outerRing) {
         let minLat = Infinity;
         let bottomPoints = [];
         outerRing.forEach(point => {
             const lat = point[1];
             if (lat < minLat) {
                 minLat = lat;
                 bottomPoints = [point];
             } else if (lat === minLat) {
                 bottomPoints.push(point);
             }
         });

         const sumLng = bottomPoints.reduce((sum, point) => sum + point[0], 0);
         const centerLng = sumLng / bottomPoints.length;

         return { lng: centerLng, lat: minLat };
     }

     function fitBounds(geojson) {
         try {
             const allPoints = [];
             function collectPoints(coords) {
                 if (typeof coords[0] === 'number') {
                     allPoints.push(coords);
                 } else {
                     coords.forEach(coord => collectPoints(coord));
                 }
             }
             collectPoints(geojson.coordinates);

             if (allPoints.length === 0) return;

             const lats = allPoints.map(p => p[1]);
             const lngs = allPoints.map(p => p[0]);
             const minLng = Math.min(...lngs);
             const maxLng = Math.max(...lngs);
             const minLat = Math.min(...lats);
             const maxLat = Math.max(...lats);

             const sw = wgs84ToGcj02(minLng, minLat);
             const ne = wgs84ToGcj02(maxLng, maxLat);

             // 修复setViewport方法的使用，确保参数格式正确
             if (map && map.setViewport) {
                 map.setViewport([
                     new T.LngLat(sw.lng, sw.lat),
                     new T.LngLat(ne.lng, ne.lat)
                 ], { padding: [50, 50] });
             } else {
                 console.warn('地图对象或setViewport方法不可用');
             }
         } catch (error) {
             console.error('调整视图范围时出错:', error);
         }
     }
// 轨迹绘制与解析
    function bindTrackEvents() {
        const drawBtn = document.getElementById('drawTrackButton');
        const showPointsBtn = document.getElementById('showTrackPointsButton');
        const clearBtn = document.getElementById('clearTrackButton');
        const ta = document.getElementById('trackTextarea');
        if (!drawBtn || !showPointsBtn || !clearBtn || !ta) return;

        drawBtn.addEventListener('click', function(){
            try {
                const text = ta.value.trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const points = parseTrackText(text);
                if (points.length < 2) { alert('有效轨迹点不足，至少需要两点'); return; }
                drawTrackFromPoints(points);
                fitViewportToTrack(points);
            } catch (e) {
                alert('绘制轨迹失败：' + (e && e.message ? e.message : e));
                console.error('绘制轨迹异常:', e);
            }
        });

        showPointsBtn.addEventListener('click', function(){
            try {
                const text = ta.value.trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const points = parseTrackText(text);
                if (points.length === 0) { alert('未找到有效轨迹点'); return; }
                showTrackPoints(points);
                fitViewportToTrack(points);
            } catch (e) {
                alert('显示轨迹点失败：' + (e && e.message ? e.message : e));
                console.error('显示轨迹点异常:', e);
            }
        });

        clearBtn.addEventListener('click', function(){
            clearTrackOverlays();
            console.log('已清空轨迹');
        });
    }

    function showTrackPoints(points) {
        // 先移除旧轨迹（不影响轮廓）
        clearTrackOverlays(false);
        
        if (!map || !points || points.length === 0) {
            console.log('无轨迹点可显示');
            return;
        }
        
        console.log(`准备显示${points.length}个轨迹点`);
        
        // 使用批量处理和更小的图标来提高性能
        // 创建一个更小的红点SVG图标
        const smallRedDotIcon = new T.Icon({
            iconUrl: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1" height="1"><circle cx="0.5" cy="0.5" r="0.3" fill="%23FF0000"/></svg>',
            iconSize: new T.Point(1, 1),
            iconAnchor: new T.Point(0.5, 0.5)
        });
        
        // 优化批量添加点的速度
        const batchSize = 2000; // 增加每批处理的点数
        const concurrentBatches = 4; // 并发批次数量
        
        // 预创建点击事件处理函数，避免重复创建
        function createClickHandler(point, index) {
            return function() {
                const infoWindow = new T.InfoWindow({
                    content: `点${index + 1}<br/>经度: ${point.lng.toFixed(6)}<br/>纬度: ${point.lat.toFixed(6)}`,
                    offset: new T.Point(0, -20)
                });
                infoWindow.open(map, point);
            };
        }
        
        // 使用setTimeout实现更高效的批量添加，避免阻塞UI
        let currentIndex = 0;
        
        function addBatch() {
            if (currentIndex >= points.length) {
                console.log(`已显示${points.length}个轨迹点`);
                return;
            }
            
            // 添加当前批次的点
            const endIndex = Math.min(currentIndex + batchSize, points.length);
            const markersToAdd = [];
            
            // 先创建所有标记
            for (let i = currentIndex; i < endIndex; i++) {
                const point = points[i];
                const index = i;
                
                const marker = new T.Marker(point, {
                    icon: smallRedDotIcon
                });
                
                // 添加点击事件
                marker.addEventListener('click', createClickHandler(point, index));
                
                markersToAdd.push(marker);
            }
            
            // 批量添加到地图和数组
            markersToAdd.forEach(marker => {
                map.addOverLay(marker);
                currentTracks.push(marker);
            });
            
            currentIndex = endIndex;
            
            // 使用setTimeout而不是requestAnimationFrame，减少对渲染周期的依赖
            // 设置为0，将任务放入微任务队列，但允许UI有短暂的呼吸空间
            setTimeout(addBatch, 0);
        }
        
        // 启动批量添加
        addBatch();
    }
    
    // 恢复原始的clearTrackOverlays函数
    function clearTrackOverlays(resetArray = true){        
        try {
            currentTracks.forEach(pl => {
                if (pl && map && map.removeOverLay) {
                    try { map.removeOverLay(pl); } catch (e) { console.warn('移除轨迹失败:', e); }
                }
            });
            if (resetArray) currentTracks = [];
        } catch (e) {
            console.warn('清空轨迹时出错:', e);
        }
    }

    function parseTrackText(text){
        // 选择输入坐标系（优先使用轨迹页签专属选择器，若未设置则回退到绘制页签选择器）
        const coordSysEl = document.getElementById('trackCoordSysSelect') || document.getElementById('coordSysSelect');
        const coordSys = (coordSysEl && coordSysEl.value) || 'wgs84';
        const isHash = text.indexOf('#') !== -1;
        const items = isHash ? text.split('#') : text.split(/\r?\n/);
        const pts = [];
        for (let i=0;i<items.length;i++){
            const raw = items[i];
            if (!raw) continue;
            const line = raw.trim();
            if (!line) continue;
            const parts = line.split(',');
            if (parts.length < 3) continue;
            let lng = parseFloat((parts[isHash ? 0 : 1] || '').trim());
            let lat = parseFloat((parts[isHash ? 1 : 2] || '').trim());
            // 初步过滤：数值合法性与正常范围
            if (!isFinite(lng) || !isFinite(lat)) continue;
            if (lng === 0 || lat === 0) continue; // 丢弃0.0异常点
            if (lng < -180 || lng > 180 || lat < -90 || lat > 90) continue; // 超出经纬度范围丢弃

            // 将输入坐标转换为WGS84
            let w;
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                w = { lng, lat };
            } else if (coordSys === 'gcj02') {
                w = gcj02ToWgs84(lng, lat);
            } else if (coordSys === 'bd09') {
                const g = bd09ToGcj02(lng, lat);
                w = gcj02ToWgs84(g.lng, g.lat);
            } else {
                w = { lng, lat };
            }
            // 转换结果兜底检查
            if (!isFinite(w.lng) || !isFinite(w.lat)) continue;
            if (w.lng < -180 || w.lng > 180 || w.lat < -90 || w.lat > 90) continue;

            // 使用WGS84坐标绘制到地图
            pts.push(new T.LngLat(w.lng, w.lat));
        }
        return pts;
    }

    function drawTrackFromPoints(points){
        // 先移除旧轨迹（不影响轮廓）
        clearTrackOverlays(false);
        const polyline = new T.Polyline(points, {
            color: '#FF3B30',
            weight: 1,
            opacity: 0.9
        });
        if (map) {
            map.addOverLay(polyline);
        }
        currentTracks.push(polyline);
    }

    function clearTrackOverlays(resetArray = true){
        try {
            currentTracks.forEach(pl => {
                if (pl && map && map.removeOverLay) {
                    try { map.removeOverLay(pl); } catch (e) { console.warn('移除轨迹失败:', e); }
                }
            });
            if (resetArray) currentTracks = [];
        } catch (e) {
            console.warn('清空轨迹时出错:', e);
        }
    }


    function fitViewportToTrack(points){
        try {
            if (!map || !map.setViewport || !points || !points.length) return;
            map.setViewport(points);
        } catch (e) {
            console.warn('轨迹视图居中失败:', e);
        }
    }

    // ========= 轨迹回放功能 =========
    let playbackState = { points: [], idx: 0, speed: 1, timer: null, running: false, marker: null, line: null, path: [] };

    function bindPlaybackControls(){
        const startBtn = document.getElementById('playbackStartBtn');
        const pauseBtn = document.getElementById('playbackPauseBtn');
        const stopBtn = document.getElementById('playbackStopBtn');
        const speedSel = document.getElementById('playbackSpeedSelect');
        const timeSlider = document.getElementById('playbackTimeSlider');
        const timeCursor = document.getElementById('playbackTimeCursor');
        const ta = document.getElementById('trackTextarea');
        if (!startBtn || !pauseBtn || !stopBtn || !speedSel) return;

        // 初始按钮状态
        updatePlaybackButtonsState('idle');

        startBtn.addEventListener('click', function(){
            try {
                const text = (ta && ta.value || '').trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const pts = parseTrackTextWithTime(text);
                if (pts.length < 2) { alert('有效轨迹点不足，至少需要两点'); return; }
                startPlayback(pts);
                // 状态在startPlayback中已设置为playing
            } catch (e) {
                alert('开始回放失败：' + (e && e.message ? e.message : e));
                console.error('开始回放异常:', e);
            }
        });

        pauseBtn.addEventListener('click', function(){
            if (!playbackState.running) {
                // 继续
                playbackState.running = true;
                scheduleNext();
                updatePlaybackButtonsState('playing');
            } else {
                // 暂停
                if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
                playbackState.running = false;
                updatePlaybackButtonsState('paused');
            }
        });

        stopBtn.addEventListener('click', function(){ 
            stopPlayback(); 
            updatePlaybackButtonsState('idle');
        });

        speedSel.addEventListener('change', function(){
            const v = parseFloat(speedSel.value);
            playbackState.speed = (isFinite(v) && v > 0) ? v : 1;
        });

        if (timeSlider) {
            timeSlider.addEventListener('input', function(){
                const ms = parseInt(timeSlider.value, 10);
                const txt = formatTimeForLabel(ms);
                if (timeCursor) timeCursor.textContent = txt;
            });
            timeSlider.addEventListener('change', function(){
                jumpToSliderTime();
            });
        }
    }

    function parseTrackTextWithTime(text){
        const coordSysEl = document.getElementById('trackCoordSysSelect') || document.getElementById('coordSysSelect');
        const coordSys = (coordSysEl && coordSysEl.value) || 'wgs84';
        const isHash = text.indexOf('#') !== -1;
        const items = isHash ? text.split('#') : text.split(/\r?\n/);
        const out = [];
        for (let i=0;i<items.length;i++){
            const raw = items[i];
            if (!raw) continue;
            const line = raw.trim();
            if (!line) continue;
            const parts = line.split(',');
            if (parts.length < 3) continue;
            const tsRaw = (parts[isHash ? 2 : 0] || '').trim();
            const ts = (tsRaw || '').replace(/\D/g,'');
            let lng = parseFloat((parts[isHash ? 0 : 1] || '').trim());
            let lat = parseFloat((parts[isHash ? 1 : 2] || '').trim());
            if (!isFinite(lng) || !isFinite(lat)) continue;
            if (lng === 0 || lat === 0) continue;
            if (lng < -180 || lng > 180 || lat < -90 || lat > 90) continue;
            const t = parseTimestamp(ts);
            if (!t) continue;
            let w;
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                w = { lng, lat };
            } else if (coordSys === 'gcj02') {
                w = gcj02ToWgs84(lng, lat);
            } else if (coordSys === 'bd09') {
                const g = bd09ToGcj02(lng, lat);
                w = gcj02ToWgs84(g.lng, g.lat);
            } else { w = { lng, lat }; }
            if (!isFinite(w.lng) || !isFinite(w.lat)) continue;
            if (w.lng < -180 || w.lng > 180 || w.lat < -90 || w.lat > 90) continue;
            out.push({ ll: new T.LngLat(w.lng, w.lat), time: t, ts });
        }
        out.sort((a,b)=>a.time - b.time);
        return out;
    }

    function parseTimestamp(ts){
        const tstr = (ts || '').replace(/\D/g,'');
        const m = tstr && tstr.match(/^\d{14}$/);
        if (!m) return null;
        const y = parseInt(tstr.slice(0,4),10);
        const M = parseInt(tstr.slice(4,6),10) - 1;
        const d = parseInt(tstr.slice(6,8),10);
        const h = parseInt(tstr.slice(8,10),10);
        const m2 = parseInt(tstr.slice(10,12),10);
        const s = parseInt(tstr.slice(12,14),10);
        const dt = new Date(y,M,d,h,m2,s);
        return isNaN(dt.getTime()) ? null : dt;
    }

    function startPlayback(points){
        console.log('[Playback] startPlayback: 点数=', points && points.length);
        stopPlayback();
        playbackState.points = points;
        playbackState.idx = 0;
        playbackState.speed = playbackState.speed || 1;
        playbackState.running = true;
        // 配置时间滑动条，并尊重现有滑块位置作为起始
        configureTimeSlider(points);
        // 启用滑块
        const slider = document.getElementById('playbackTimeSlider');
        if (slider) slider.disabled = false;
        let initIdx = 0;
        if (slider && slider.min && slider.max) {
            const ms = parseInt(slider.value, 10);
            if (isFinite(ms)) initIdx = findIndexByTime(points, ms);
        }
        playbackState.idx = initIdx;
        const first = points[initIdx];
        console.log('[Playback] 首点:', first && first.ts, first && first.ll, 'initIdx=', initIdx);
        playbackState.path = points.slice(0, initIdx+1).map(p=>p.ll);
        playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 1, opacity: 0.9 });
        if (map) {
            map.addOverLay(playbackState.line);
        }
        currentTracks.push(playbackState.line);
        // 创建并定位DOM标记以保证可见移动
        ensurePlaybackDom(first.ll);
        updatePlaybackDom(first.ll);
        updatePlaybackTimeLabel(first.ts);
        try { fitViewportToTrack(points.map(p=>p.ll)); } catch(e){}
        // 更新按钮状态
        updatePlaybackButtonsState('playing');
        scheduleNext();
    }

    function scheduleNext(){
        if (!playbackState.running) return;
        if (!playbackState.points || playbackState.idx >= playbackState.points.length - 1) {
            playbackState.running = false;
            console.log('[Playback] 回放结束：idx=', playbackState.idx, '点数=', playbackState.points ? playbackState.points.length : 0);
            updatePlaybackButtonsState('idle'); // 播放结束后按钮回到初始状态：开始可点，继续/结束灰化
            return;
        }
        const next = playbackState.points[playbackState.idx+1];
        const speed = playbackState.speed || 1;
        const delay = Math.max(4, Math.round(1000 / speed)); // 1x=1000ms/点，2x=500ms/点...
        console.log('[Playback] scheduleNext: idx=', playbackState.idx, '->', playbackState.idx+1, 'delay=', delay, 'speed=', speed);
        playbackState.timer = setTimeout(()=>{
            playbackState.idx++;
            const nextLL = next.ll;
            console.log('[Playback] 下一点:', next && next.ts, nextLL);
            try {
                // 维护路径数组
                playbackState.path = playbackState.path || [];
                playbackState.path.push(nextLL);
                console.log('[Playback] 路径长度=', playbackState.path.length);
                // 使用DOM标记进行移动（容器/图层坐标）
                if (!playbackDom.el) console.log('[Playback] DOM标记不存在，将尝试创建');
                updatePlaybackDom(nextLL);
                // 折线更新：优先setLngLats，兜底重建
                if (playbackState.line && typeof playbackState.line.setLngLats === 'function') {
                    try { playbackState.line.setLngLats(playbackState.path); }
                    catch(e){
                        console.warn('[Playback] setLngLats失败，重建折线', e);
                        if (map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                        playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 1, opacity: 0.9 });
                        if (map) map.addOverLay(playbackState.line);
                    }
                } else {
                    console.log('[Playback] 折线不支持setLngLats，重建');
                    if (playbackState.line && map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                    playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 1, opacity: 0.9 });
                    if (map) map.addOverLay(playbackState.line);
                }
            } catch(e) { console.warn('更新回放覆盖物失败:', e); }
            updatePlaybackTimeLabel(next.ts);
            scheduleNext();
        }, delay);
    }

    function stopPlayback(){
        if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
        playbackState.running = false;
        playbackState.idx = 0;
        try {
            // 移除DOM标记
            removePlaybackDom();
            if (playbackState.marker && map) map.removeOverLay(playbackState.marker);
            if (playbackState.line && map) map.removeOverLay(playbackState.line);
        } catch(e){}
        playbackState.marker = null;
        playbackState.line = null;
        updatePlaybackTimeLabel('—');
        // 按钮回到初始状态
        updatePlaybackButtonsState('idle');
    }

    function updatePlaybackTimeLabel(text){
        const el = document.getElementById('playbackTimeLabel');
        if (el) el.textContent = '时间：' + (text || '—');
    }

    // 时间滑动条：配置与跳转
    function configureTimeSlider(points){
        try {
            const slider = document.getElementById('playbackTimeSlider');
            const cursor = document.getElementById('playbackTimeCursor');
            if (!slider || !points || !points.length) return;
            const minMs = points[0].time.getTime();
            const maxMs = points[points.length - 1].time.getTime();
            const prev = parseInt(slider.value, 10);
            slider.min = String(minMs);
            slider.max = String(maxMs);
            slider.step = '1000'; // 以秒为步进
            let val = (isFinite(prev) && prev >= minMs && prev <= maxMs) ? prev : minMs;
            slider.value = String(val);
            if (cursor) cursor.textContent = formatTimeForLabel(val);
        } catch(e) { console.warn('配置时间滑动条失败:', e); }
    }
    function formatTimeForLabel(ms){
        if (!isFinite(ms)) return '—';
        const d = new Date(ms);
        const pad = n => String(n).padStart(2,'0');
        const y = d.getFullYear();
        const M = pad(d.getMonth()+1);
        const da = pad(d.getDate());
        const h = pad(d.getHours());
        const m = pad(d.getMinutes());
        const s = pad(d.getSeconds());
        return `${y}-${M}-${da} ${h}:${m}:${s}`;
    }
    function findIndexByTime(points, ms){
        try {
            if (!points || !points.length) return 0;
            const n = points.length;
            const minMs = points[0].time.getTime();
            const maxMs = points[n-1].time.getTime();
            if (!isFinite(ms)) return 0;
            if (ms <= minMs) return 0;
            if (ms >= maxMs) return n-1;
            let lo = 0, hi = n - 1, ans = 0;
            while (lo <= hi) {
                const mid = (lo + hi) >> 1;
                const t = points[mid].time.getTime();
                if (t < ms) { lo = mid + 1; ans = lo; }
                else { hi = mid - 1; ans = mid; }
            }
            return Math.max(0, Math.min(n-1, ans));
        } catch(e){ console.warn('findIndexByTime失败:', e); return 0; }
    }
    function jumpToSliderTime(){
        try {
            const slider = document.getElementById('playbackTimeSlider');
            if (!slider || !playbackState.points || !playbackState.points.length) return;
            const ms = parseInt(slider.value, 10);
            if (!isFinite(ms)) return;
            const idx = findIndexByTime(playbackState.points, ms);
            playbackState.idx = idx;
            const pts = playbackState.points;
            const ll = pts[idx].ll;
            playbackState.path = pts.slice(0, idx+1).map(p=>p.ll);
            // 更新折线
            try {
                if (playbackState.line && typeof playbackState.line.setLngLats === 'function') {
                    playbackState.line.setLngLats(playbackState.path);
                } else {
                    if (playbackState.line && map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                    playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 1, opacity: 0.9 });
                    if (map) map.addOverLay(playbackState.line);
                }
            } catch(e){ console.warn('滑块更新折线失败:', e); }
            // 更新标记与时间
            ensurePlaybackDom(ll);
            updatePlaybackDom(ll);
            updatePlaybackTimeLabel(pts[idx].ts);
            // 若正在播放，立即按新位置继续
            if (playbackState.running) {
                if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
                scheduleNext();
            }
        } catch(e) { console.warn('滑块跳转失败:', e); }
    }

    // DOM标记：使用容器坐标实现可见移动
    let playbackDom = { el: null, lastLL: null, bound: false };

    function ensurePlaybackDom(ll){
        try {
            playbackDom.lastLL = ll;
            const pane = (map && map.getPanes && map.getPanes().overlayPane) || document.getElementById('mapContainer');
            if (!pane) { console.warn('未找到overlayPane或mapContainer'); return; }
            if (!playbackDom.el) {
                const el = document.createElement('div');
                el.id = 'playbackDomMarker';
                el.style.position = 'absolute';
                el.style.width = '16px';
                el.style.height = '16px';
                el.style.borderRadius = '50%';
                el.style.background = '#2C64A7';
                el.style.border = '2px solid #fff';
                el.style.boxShadow = '0 0 0 1px rgba(0,0,0,.25)';
                el.style.zIndex = '9999';
                pane.appendChild(el);
                playbackDom.el = el;
                console.log('[Playback] 创建DOM标记，父节点=', pane === document.getElementById('mapContainer') ? '#mapContainer' : 'overlayPane');
                bindPlaybackDomEvents();
            }
            updatePlaybackDom(ll);
        } catch(e) { console.warn('创建DOM标记失败:', e); }
    }

    function updatePlaybackDom(ll){
        try {
            playbackDom.lastLL = ll;
            if (!map || !playbackDom.el || !ll) { console.log('[Playback] update取消：map/el/ll缺失'); return; }
            let p;
            if (typeof map.lngLatToLayerPoint === 'function') {
                p = map.lngLatToLayerPoint(ll);
                console.log('[Playback] 使用layerPoint定位:', ll && ll.lng, ll && ll.lat, '=>', p && p.x, p && p.y);
            } else if (typeof map.lngLatToContainerPoint === 'function') {
                p = map.lngLatToContainerPoint(ll);
                console.log('[Playback] 使用containerPoint定位:', ll && ll.lng, ll && ll.lat, '=>', p && p.x, p && p.y);
            } else {
                console.warn('地图对象不支持lngLat到像素坐标转换');
                return;
            }
            playbackDom.el.style.left = p.x + 'px';
            playbackDom.el.style.top = p.y + 'px';
        } catch(e) { console.warn('更新DOM标记位置失败:', e); }
    }

    function bindPlaybackDomEvents(){
        if (playbackDom.bound) return;
        const updater = function(){
            try {
                if (!map || !playbackDom.el || !playbackDom.lastLL) return;
                let p;
                if (typeof map.lngLatToLayerPoint === 'function') {
                    p = map.lngLatToLayerPoint(playbackDom.lastLL);
                } else if (typeof map.lngLatToContainerPoint === 'function') {
                    p = map.lngLatToContainerPoint(playbackDom.lastLL);
                }
                if (!p) return;
                playbackDom.el.style.left = p.x + 'px';
                playbackDom.el.style.top = p.y + 'px';
            } catch(e){}
        };
        try {
            map.addEventListener('move', updater);
            map.addEventListener('zoom', updater);
            playbackDom.bound = true;
        } catch(e){}
    }

    function removePlaybackDom(){
        try {
            const el = playbackDom.el;
            playbackDom.lastLL = null;
            if (el && el.parentNode) el.parentNode.removeChild(el);
        } catch(e){}
        playbackDom.el = null;
        playbackDom.bound = false;
    }

</script>
</body>

</html>
