<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>展示轮廓</title>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #mapContainer {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        #mapLoading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
            transition: opacity 0.3s;
        }

        .loading-text {
            font-size: 16px;
            color: #333;
            padding: 10px 20px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .wkt-input-container {
            position: absolute;
            top: 20px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            width: min(320px, 90vw);
            box-sizing: border-box;
            transition: all 0.3s;
        }

        .minimize-btn {
            position: absolute;
            top: -5px;
            right: -4px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #f0f0f0;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #666;
            z-index: 1001;
            transition: background 0.2s;
        }

        .minimize-btn:hover {
            background: #e0e0e0;
        }

        .content-wrapper {
            transition: all 0.3s;
        }

        .wkt-input-container.minimized {
            width: 40px;
            height: 40px;
            padding: 0;
        }

        .wkt-input-container.minimized .content-wrapper {
            display: none;
        }

        .wkt-input-container.minimized .min-icon {
            display: none;
        }

        .wkt-input-container.minimized .restore-icon {
            display: inline;
        }

        #wktTextarea {
            width: 100%;
            height: 120px;
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
            box-sizing: border-box;
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        /* 页签样式 */
        .tabs-header {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .tab-btn {
            flex: 1;
            padding: 6px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            background: #f5f5f5;
            color: #333;
            transition: background 0.2s;
        }
        .tab-btn.active { background: #337AFF; color: #fff; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        /* Multi → Polygons 分割器样式 */
        .split-section {
            margin-top: 10px;
            padding: 10px;
            background: #fafafa;
            border: 1px solid #eee;
            border-radius: 6px;
        }
        .split-section .title {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
        }
        .split-section .desc {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        #multiInput, #polyOutput {
            width: 100%;
            height: 90px;
            margin-bottom: 8px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
            box-sizing: border-box;
        }
        .split-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .split-actions button {
            flex: 1;
            padding: 6px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }
        #splitMultiBtn { background: #337AFF; color: #fff; }
        #splitMultiBtn:hover { background: #2860E0; }
        #copyPolysBtn { background: #f5f5f5; color: #333; }
        #copyPolysBtn:hover { background: #e0e0e0; }
        #drawButton,
        #clearButton,
        #drawTrackButton,
        #clearTrackButton {
            width: 50%;
            padding: 8px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        #drawButton,
        #drawTrackButton {
            background: #337AFF;
            color: white;
        }

        #drawButton:hover,
        #drawTrackButton:hover {
            background: #2860E0;
        }

        #clearButton,
        #clearTrackButton {
            background: #f5f5f5;
            color: #333;
        }

        #clearButton:hover,
        #clearTrackButton:hover {
            background: #e0e0e0;
        }

        #drawButton:disabled,
        #clearButton:disabled,
        #drawTrackButton:disabled,
        #clearTrackButton:disabled {
            background: #e0e0e0;
            color: #999;
            cursor: not-allowed;
        }

        .tip {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .area-label {
             position: absolute;
             background: rgba(255, 0, 0, 0.85);
             border: 1px solid #000;
             border-radius: 3px;
             padding: 4px 6px;
             font-size: 12px;
             color: #fff;
             font-weight: 600;
             box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
             white-space: nowrap;
             z-index: 9999;
             pointer-events: none;
         }
         /* 默认隐藏标签容器下的标签 */
          .labels-hidden .area-label { display: none; }

          /* Batch → Generator 样式 */
          .batch-section { margin-top: 10px; padding: 10px; background: #fafafa; border: 1px solid #eee; border-radius: 6px; }
          .batch-section .title { font-size: 13px; font-weight: 600; color: #333; margin-bottom: 6px; }
          .batch-section .desc { font-size: 12px; color: #666; margin-bottom: 8px; }
          #batchInput, #multiOutput { width: 100%; height: 90px; margin-bottom: 8px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; resize: vertical; box-sizing: border-box; }
          .batch-actions { display: flex; gap: 8px; margin-bottom: 8px; }
          .batch-actions button { flex: 1; padding: 6px 0; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; transition: background 0.2s; }
          #generateMultiBtn { background: #337AFF; color: #fff; }
          #generateMultiBtn:hover { background: #2860E0; }
          #copyMultiBtn { background: #f5f5f5; color: #333; }
          #copyMultiBtn:hover { background: #e0e0e0; }
      </style>
    <script src="https://api.tianditu.gov.cn/api?v=4.0&tk=648f621977051d0199ff0f965d3fd322"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
    <script src="https://lib.baomitu.com/terraformer/1.0.12/terraformer.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://unpkg.com/terraformer-wkt-parser@1.2.1/terraformer-wkt-parser.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- 已移除动态备用加载器 ensureTerraformer：改为仅使用静态脚本标签加载 Terraformer 核心库与 WKT 解析器 -->
    <script>
        // 检查Turf.js是否加载成功
        window.addEventListener('load', function () {
            if (typeof turf === 'undefined') {
                console.warn('Turf.js加载失败，已启用备用面积算法');
            } else {
                console.log('Turf.js加载成功');
            }
        });
    </script>
</head>

<body>
<div id="mapContainer">
    <div id="mapLoading">
        <div class="loading-text">地图正在加载中...</div>
    </div>
</div>

<div class="wkt-input-container">
    <div class="minimize-btn" id="minimizeBtn">
        <span class="min-icon">−</span>
        <span class="restore-icon" style="display:none;">+</span>
    </div>

    <div class="content-wrapper">
        <div class="tabs-header">
            <button class="tab-btn active" id="tabDrawBtn">轮廓</button>
            <button class="tab-btn" id="tabTrackBtn">轨迹</button>
            <button class="tab-btn" id="tabSplitBtn">分割器</button>
            <button class="tab-btn" id="tabBatchBtn">合并器</button>
        </div>
        <div class="tab-pane active" id="tabDraw">
            <div class="tip">请输入WKT字符串（支持POLYGON/MULTIPOLYGON）：</div>
            <textarea id="wktTextarea">POLYGON ((124.50443268266127 45.34213117007532, 124.50443271407596 45.342131225542964, 124.50443272742149 45.34213128452504, 124.5044327220443 45.34213134413275, 124.5044292947688 45.34214506104092, 124.504429060961 45.342147282833686, 124.50442906196962 45.34214730981555, 124.50442946145185 45.34214951982133, 124.50442947004824 45.34214954604025, 124.50443050090597 45.34215168058661, 124.504452501995 45.342185679383256, 124.50445398622868 45.342187496480975, 124.50445400708267 45.342187517206874, 124.5044559490446 45.34218910525381, 124.50445597497131 45.342189122794075, 124.50445833483187 45.34219044010277, 124.50451733644334 45.34221743929345, 124.50452007945074 45.34221844008148, 124.50452011421255 45.34221844985205, 124.50452308136828 45.342219054026664, 124.50452311816494 45.34221905882692, 124.50452619544721 45.34221924317165, 124.50452623286479 45.3422192428172, 124.50452930201502 45.34221900024774, 124.50452933861575 45.34221899475216, 124.5045322816886 45.342218334590335, 124.50453231606556 45.3422183241649, 124.5045350199599 45.342217271780385, 124.50453505079251 45.342217256825485, 124.50453741159909 45.3422158526611, 124.50453743770244 45.34221583375141, 124.50453936469737 45.34221413176802, 124.50453938506726 45.34221410963117, 124.50454080419706 45.34221217523497, 124.50454081805192 45.34221215072038, 124.50454167478007 45.3422100582495, 124.50454168158684 45.342210032300216, 124.50454194298975 45.34220786216705, 124.50454194248717 45.34220783577979, 124.50454159851954 45.342205671381834, 124.50454159072648 45.34220564556962, 124.5045406546069 45.34220357008314, 124.50454063982356 45.34220354584016, 124.50454034292653 45.34220316647338, 124.50454031296373 45.3422031171472, 124.50454029743132 45.342203064615546, 124.50454029694352 45.34220301095519, 124.5045403115196 45.34220295828743, 124.50454063899886 45.34220219090649, 124.50454066145643 45.34220205858138, 124.504540672544 45.34220201883361, 124.50454070794586 45.342201928399675, 124.50454071432053 45.34220190239536, 124.50454080881723 45.342200992217556, 124.50454094601744 45.34219998703856, 124.50454094601206 45.34218101342987, 124.50454062973259 45.342178778182706, 124.50454062217622 45.342178751908186, 124.50453969169243 45.34217663174029, 124.50453967683711 45.34217660697527, 124.50453816734458 45.34217465953861, 124.5045381458054 45.34217463735003, 124.50453611754179 45.34217294035878, 124.50453609017909 45.34217292163247, 124.50453362408335 45.34217154280622, 124.50453359198896 45.34217152828926, 124.50453078647378 45.34217052265185, 124.50453075092746 45.34217051292307, 124.50452771794964 45.342169920605414, 124.50452768037027 45.3421699160533, 124.50452454096315 45.34216976069218, 124.5045245028507 45.342169761498475, 124.50452170785425 45.34217001926878, 124.50452163597343 45.3421700210908, 124.50452156487876 45.34217001339566, 124.50452149708143 45.342169996455176, 124.50452143497635 45.34216997086776, 124.50452138075718 45.342169937537214, 124.50451947665354 45.34216852395685, 124.50451944924477 45.34216850714719, 124.50451701062089 45.342167278046084, 124.50451697919308 45.34216726520135, 124.50451425460847 45.34216638406396, 124.50451422029984 45.342166375649406, 124.50451130838236 45.342165874372185, 124.50451127243494 45.34216587069239, 124.50450827859453 45.34216576742133, 124.5045082423094 45.3421657686095, 124.50450527492124 45.3421660670829, 124.5045052396118 45.34216607309607, 124.50450240609315 45.34216676250942, 124.504502373038 45.34216677312977, 124.5044997759605 45.342167828526875, 124.50449974635607 45.342167843369985, 124.50449747973276 45.34216922654581, 124.5044974546502 45.34216924507473, 124.50449560053126 45.34217090595919, 124.50449558087895 45.34217092750294, 124.50449420638256 45.34217280597304, 124.50449419287192 45.34217282975173, 124.50449334775352 45.34217485780839, 124.5044933408942 45.34217488288643, 124.50449305399086 45.3421770127877, 124.50449305399025 45.34217902062828, 124.50449304672759 45.34217907295744, 124.50449302521523 45.34217912330048, 124.50449299026967 45.34217916974666, 124.50449294321723 45.342179210533104, 124.50449288584382 45.342179244111826, 124.50449282032703 45.34217926920835, 124.50449274915334 45.342179284870134, 124.50449267502435 45.34217929050278, 124.50449260075341 45.34217928589247, 124.50449252915953 45.342179271214206, 124.50449246296002 45.34217924702506, 124.50447967161983 45.34217339335729, 124.5044796150067 45.34217336171863, 124.5044795678323 45.34217332314155, 124.50447953177711 45.34217327900041, 124.50447789960377 45.3421707565529, 124.50447787459883 45.34217070436833, 124.5044778651388 45.34217064969043, 124.50447787161761 45.342170594796855, 124.50447789376555 45.34217054197426, 124.50447793065992 45.342170493423005, 124.50447901387336 45.34216936276627, 124.50447903168272 45.34216933955642, 124.50448022816104 45.34216733169379, 124.50448023920721 45.34216730647987, 124.50448085723865 45.342165172586725, 124.50448086109749 45.342165146337486, 124.50448087693154 45.34216296841751, 124.50448087346494 45.34216294221974, 124.50448027757623 45.342160778242686, 124.50446615216057 45.34212732333909, 124.5044661368775 45.34212726181496, 124.50446614205883 45.3421271994609, 124.50446859527821 45.342117386568745, 124.5044686014575 45.342117366396366, 124.50447644870894 45.34209578326456, 124.5044768707673 45.34209409102467, 124.50447719535562 45.34209176480546, 124.50447720987769 45.34209171316488, 124.50449326785248 45.34205423897745, 124.5044939022156 45.34205183266211, 124.50449579150704 45.342034199232856, 124.5044958066147 45.3420341418854, 124.50449663950296 45.34203218758196, 124.50449664665688 45.34203216199025, 124.50449694596647 45.34202998695692, 124.50449694421552 45.34202298714047, 124.5044966558147 45.34202087103764, 124.50449664885703 45.3420208457476, 124.50449579422431 45.342018807141955, 124.50449578056387 45.34201878324999, 124.50449439098593 45.342016896756256, 124.50449437112292 45.34201687513672, 124.50449249747501 45.34201520982319, 124.50449247213642 45.34201519126728, 124.5044901830173 45.34201380810524, 124.50449015313086 45.34201379329242, 124.50448753235003 45.34201274292215, 124.50448749900964 45.34201273239465, 124.50448464251932 45.342012053272335, 124.50448460694626 45.342012047415835, 124.50448161932842 45.34201176440558, 124.50448158282477 45.34201176343441, 124.50447857346256 45.34201188689782, 124.50447853736505 45.34201189084754, 124.50447561643749 45.34201241626438, 124.50447558206724 45.342012424990436, 124.50447285651616 45.342013333123994, 124.50447282513181 45.342013346306864, 124.50447039474453 45.342014603908744, 124.50447036749588 45.34201462106533, 124.50446832125468 45.3420161820918, 124.50446829913763 45.34201620259522, 124.50446786343804 45.342016698720656, 124.50446781704007 45.34201674138243, 124.50446775957126 45.34201677671175, 124.50446769331255 45.342016803306564, 124.50446762089322 45.34201682011148, 124.50446754518742 45.34201682645956, 124.50446746919954 45.34201682209889, 124.5044236178616 45.34201116385865, 124.50442353851226 45.34201114719987, 124.50437115873096 45.34199562867362, 124.50436820792773 45.34199498591419, 124.50436817126331 45.34199498063499, 124.5043650993522 45.34199475619899, 124.50436506193162 45.34199475606554, 124.50436198695864 45.341994958576606, 124.50436195022019 45.34199496359404, 124.50435899035456 45.3419955852698, 124.50435895570998 45.341995595245336, 124.50435622469737 45.34199661219522, 124.50435619347833 45.34199662674536, 124.50435379627011 45.34199799988867, 124.50435376967637 45.3419980184542, 124.50435179839634 45.34199969502146, 124.50435177744886 45.34199971688973, 124.50435030785191 45.34200163245156, 124.50435029335699 45.34200165678082, 124.50434938191886 45.34200373772361, 124.50434937443272 45.34200376358018, 124.50434905617968 45.34200592993363, 124.50434905599046 45.34200595632383, 124.50434934315265 45.34200812483692, 124.50434935026723 45.34200815074496, 124.50435023180965 45.34201023808354, 124.50435024595497 45.34201026251522, 124.50435168799967 45.34201218846254, 124.50435170863238 45.34201221047909, 124.50435365576345 45.34201390102323, 124.50435368208935 45.342013919777344, 124.50435605947955 45.342015309951364, 124.5043560903953 45.3420153246792, 124.50435884053498 45.34201637251527, 124.50441284309677 45.34203237155778, 124.50441615032089 45.342033064292266, 124.50446159490203 45.34203892811261, 124.50446166743943 45.34203894280733, 124.50446173447722 45.34203896725505, 124.50446179340823 45.34203900050499, 124.50446184194074 45.3420390412641, 124.50446187818712 45.34203908794723, 124.50446190073794 45.3420391387389, 124.50446190871621 45.342039191663844, 124.50446190181151 45.342039244663795, 124.50446188029255 45.34203929567758, 124.504461844996 45.34203934272133, 124.50446179729472 45.342039383965506, 124.50446173904363 45.34203941780611, 124.50446167250828 45.34203944292712, 124.50445949924257 45.342040077916614, 124.50445946624183 45.342040090358715, 124.50445689852052 45.34204130052276, 124.50445686959561 45.34204131726618, 124.50445468599253 45.34204285744493, 124.50445466225538 45.34204287784609, 124.50445294668474 45.342044688851495, 124.5044529290476 45.342044712126246, 124.50445174743794 45.342046724362206, 124.50445173661065 45.342046749541375, 124.50445112884206 45.342048911874556, 124.50444577015864 45.34208731569815, 124.50444575563206 45.34208736734929, 124.50443593481043 45.34211028256927, 124.50443590777161 45.34211032932964, 124.50443586885389 45.34211037171929, 124.50443581941971 45.34211040825413, 124.50443446195231 45.34211123967275, 124.50443443696453 45.342111258191395, 124.50443259007656 45.342112917411875, 124.50443257050239 45.342112938927166, 124.50443120158583 45.34211481440959, 124.50443118813116 45.34211483814526, 124.50443034653134 45.34211686228438, 124.50443033970103 45.34211688731059, 124.50443005401077 45.34211901273125, 124.50443005584388 45.34212501316383, 124.50443035855959 45.34212718065419, 124.50443036585996 45.342127206536674, 124.504431262363 45.342129290704186, 124.50443127668316 45.34212931508472, 124.50443268266127 45.34213117007532))</textarea>
            <div class="coord-settings" style="margin-bottom:8px;font-size:12px;color:#333;">
                <label>WKT坐标系：
                    <select id="coordSysSelect" style="margin-left:6px;">
                        <option value="wgs84" selected>WGS84</option>
                        <option value="gcj02">GCJ-02（国测局）</option>
                        <option value="bd09">BD-09（百度）</option>
                        <option value="cgcs2000">CGCS2000</option>
                    </select>
                </label>
                <!-- 已移除“不进行绘制坐标转换”选项，统一使用WGS84绘制 -->
            </div>

            <div class="button-group">
                <button id="drawButton" disabled>绘制轮廓</button>
                <button id="clearButton" disabled>清空轮廓</button>
            </div>
            <!-- 显示开关：仅保留显示亩数 -->
            <div class="display-toggles" style="margin-top:8px;font-size:12px;color:#333;">
                <label><input type="checkbox" id="toggleLabelsCheckbox"> 显示亩数</label>
            </div>
        </div>

        <div class="tab-pane" id="tabSplit">
            <!-- MultiPolygon → 多个 Polygon 分割器 -->
            <div class="split-section">
                <div class="title">MultiPolygon → 多个 Polygon 分割器</div>
                <div class="desc">输入一个 MULTIPOLYGON WKT，分割为多行 POLYGON WKT。</div>
                <textarea id="multiInput"></textarea>
                <div class="split-actions">
                    <button id="splitMultiBtn">分割为多个 POLYGON</button>
                    <button id="copyPolysBtn">复制结果</button>
                </div>
                <textarea id="polyOutput" readonly></textarea>
            </div>
        </div>

        <div class="tab-pane" id="tabBatch">
            <!-- 批量POLYGON → MULTIPOLYGON 生成器 -->
            <div class="batch-section">
                <div class="title">批量POLYGON → MULTIPOLYGON 合并器</div>
                <div class="desc">每行一个 POLYGON WKT（或用分号分隔）。生成后可一键填充到上方并绘制。</div>
                <textarea id="batchInput"></textarea>
                <div class="batch-actions">
                    <button id="generateMultiBtn">生成 MULTIPOLYGON</button>
                    <button id="copyMultiBtn">复制结果</button>
                </div>
                <textarea id="multiOutput" readonly></textarea>
            </div>
        </div>
        <div class="tab-pane" id="tabTrack">
            <div class="tip">请粘贴轨迹文本（支持两种格式：1）每行一条：定位时间yyyyMMddHHmmss, 经度, 纬度；2）单行#分隔：经度,纬度,定位时间yyyyMMddHHmmss#经度,纬度,定位时间yyyyMMddHHmmss#…）。</div>
            <div class="coord-settings" style="margin-bottom:8px;font-size:12px;color:#333;">
                <label>轨迹坐标系：
                    <select id="trackCoordSysSelect" style="margin-left:6px;">
                        <option value="wgs84" selected>WGS84</option>
                        <option value="gcj02">GCJ-02（国测局）</option>
                        <option value="bd09">BD-09（百度）</option>
                        <option value="cgcs2000">CGCS2000</option>
                    </select>
                </label>
            </div>
            <textarea id="trackTextarea" style="width:100%;height:120px;margin-bottom:10px;padding:8px;border:1px solid #ddd;border-radius:4px;font-family:monospace;resize:vertical;box-sizing:border-box;">20250908090743,124.504525,45.342199
20250908090753,124.504525,45.342196
20250908090803,124.504524,45.342193
20250908090813,124.504524,45.342193
20250908090823,124.504525,45.342193
20250908090833,124.504525,45.342193
20250908090843,124.504525,45.342181
20250908090853,124.504524,45.342186
20250908090903,124.504522,45.342187
20250908090913,124.504520,45.342188
20250908090923,124.504521,45.342188
20250908090933,124.504521,45.342187
20250908090943,124.504512,45.342193
20250908090953,124.504513,45.342196
20250908091003,124.504513,45.342199
20250908091013,124.504513,45.342200
20250908091023,124.504511,45.342201
20250908091033,124.504511,45.342201
20250908091043,124.504525,45.342199
20250908091053,124.504516,45.342190
20250908091103,124.504519,45.342190
20250908091113,124.504520,45.342191
20250908091123,124.504522,45.342194
20250908091133,124.504522,45.342196
20250908091143,124.504522,45.342200
20250908091153,124.504518,45.342198
20250908091203,124.504515,45.342199
20250908091213,124.504511,45.342198
20250908091223,124.504509,45.342196
20250908091233,124.504509,45.342195
20250908091243,124.504509,45.342177
20250908091253,124.504512,45.342181
20250908091303,124.504514,45.342184
20250908091313,124.504515,45.342185
20250908091323,124.504515,45.342186
20250908091333,124.504516,45.342187
20250908091343,124.504524,45.342199
20250908091353,124.504525,45.342199
20250908091403,124.504525,45.342199
20250908091413,124.504525,45.342199
20250908091423,124.504525,45.342199
20250908091433,124.504525,45.342199
20250908091443,124.504524,45.342199
20250908091453,124.504525,45.342199
20250908091503,124.504525,45.342199
20250908091513,124.504525,45.342199
20250908091523,124.504524,45.342199
20250908091533,124.504524,45.342199
20250908091543,124.504524,45.342199
20250908091553,124.504525,45.342199
20250908091603,124.504525,45.342199
20250908091613,124.504525,45.342199
20250908091623,124.504525,45.342199
20250908091633,124.504524,45.342199
20250908091643,124.504524,45.342199
20250908091653,124.504524,45.342199
20250908091703,124.504524,45.342199
20250908091713,124.504524,45.342199
20250908091723,124.504525,45.342199
20250908091733,124.504524,45.342199
20250908091743,124.504524,45.342199
20250908091753,124.504524,45.342199
20250908091803,124.504524,45.342199
20250908091813,124.504524,45.342199
20250908091823,124.504524,45.342199
20250908091833,124.504524,45.342199
20250908091843,124.504525,45.342199
20250908091853,124.504524,45.342199
20250908091903,124.504524,45.342199
20250908091913,124.504524,45.342199
20250908091923,124.504524,45.342199
20250908091933,124.504524,45.342199
20250908091943,124.504524,45.342199
20250908091953,124.504524,45.342199
20250908092003,124.504524,45.342199
20250908092013,124.504524,45.342199
20250908092023,124.504524,45.342199
20250908092033,124.504524,45.342199
20250908092043,124.504524,45.342199
20250908092053,124.504524,45.342199
20250908092103,124.504524,45.342199
20250908092113,124.504524,45.342199
20250908092123,124.504525,45.342199
20250908092133,124.504524,45.342199
20250908092143,124.504524,45.342199
20250908092153,124.504524,45.342199
20250908092203,124.504524,45.342199
20250908092213,124.504524,45.342199
20250908092223,124.504524,45.342199
20250908092233,124.504524,45.342199
20250908092243,124.504525,45.342199
20250908092253,124.504525,45.342199
20250908092303,124.504525,45.342199
20250908092313,124.504525,45.342199
20250908092323,124.504525,45.342199
20250908092333,124.504525,45.342199
20250908092343,124.504525,45.342199
20250908092353,124.504525,45.342199
20250908092403,124.504525,45.342199
20250908092413,124.504525,45.342199
20250908092423,124.504524,45.342199
20250908092433,124.504525,45.342199
20250908092443,124.504525,45.342199
20250908092453,124.504525,45.342199
20250908092503,124.504525,45.342199
20250908092513,124.504525,45.342199
20250908092523,124.504525,45.342199
20250908092533,124.504525,45.342199
20250908092543,124.504525,45.342199
20250908092553,124.504525,45.342199
20250908092603,124.504525,45.342199
20250908092613,124.504525,45.342199
20250908092623,124.504525,45.342199
20250908092633,124.504525,45.342199
20250908092643,124.504525,45.342199
20250908092653,124.504525,45.342199
20250908092703,124.504525,45.342199
20250908092713,124.504525,45.342199
20250908092723,124.504525,45.342199
20250908092733,124.504524,45.342199
20250908092743,124.504525,45.342199
20250908092753,124.504524,45.342199
20250908092803,124.504525,45.342199
20250908092813,124.504525,45.342199
20250908092823,124.504525,45.342199
20250908092833,124.504524,45.342199
20250908092843,124.504525,45.342199
20250908092853,124.504524,45.342199
20250908092903,124.504525,45.342199
20250908092913,124.504525,45.342199
20250908092923,124.504524,45.342199
20250908092933,124.504525,45.342199
20250908092943,124.504525,45.342199
20250908092953,124.504525,45.342199
20250908093003,124.504525,45.342199
20250908093013,124.504525,45.342199
20250908093023,124.504525,45.342199
20250908093033,124.504525,45.342199
20250908093043,124.504525,45.342199
20250908093053,124.504525,45.342199
20250908093103,124.504525,45.342199
20250908093113,124.504525,45.342199
20250908093123,124.504525,45.342199
20250908093133,124.504525,45.342199
20250908093143,124.504525,45.342199
20250908093153,124.504525,45.342199
20250908093203,124.504525,45.342199
20250908093213,124.504525,45.342199
20250908093223,124.504525,45.342199
20250908093233,124.504525,45.342199
20250908093243,124.504525,45.342199
20250908093253,124.504525,45.342199
20250908093303,124.504525,45.342199
20250908093313,124.504525,45.342199
20250908093323,124.504525,45.342199
20250908093333,124.504525,45.342199
20250908093343,124.504525,45.342199
20250908093353,124.504525,45.342199
20250908093403,124.504525,45.342199
20250908093413,124.504524,45.342199
20250908093423,124.504524,45.342199
20250908093433,124.504525,45.342199
20250908093443,124.504525,45.342199
20250908093453,124.504525,45.342199
20250908093503,124.504525,45.342199
20250908093513,124.504525,45.342199
20250908093523,124.504525,45.342199
20250908093533,124.504525,45.342200
20250908093543,124.504525,45.342199
20250908093553,124.504525,45.342199
20250908093603,124.504525,45.342199
20250908093613,124.504525,45.342200
20250908093623,124.504525,45.342200
20250908093633,124.504525,45.342199
20250908093643,124.504524,45.342199
20250908093653,124.504525,45.342199
20250908093703,124.504525,45.342199
20250908093713,124.504525,45.342200
20250908093723,124.504525,45.342199
20250908093733,124.504524,45.342199
20250908093743,124.504525,45.342199
20250908093753,124.504525,45.342199
20250908093803,124.504525,45.342199
20250908093813,124.504525,45.342200
20250908093823,124.504524,45.342199
20250908093833,124.504525,45.342200
20250908093843,124.504525,45.342199
20250908093853,124.504525,45.342199
20250908093903,124.504525,45.342199
20250908093913,124.504525,45.342199
20250908093923,124.504525,45.342200
20250908093933,124.504525,45.342199
20250908093943,124.504525,45.342200
20250908093953,124.504525,45.342200
20250908094003,124.504525,45.342200
20250908094013,124.504525,45.342200
20250908094023,124.504525,45.342200
20250908094033,124.504525,45.342200
20250908094043,124.504525,45.342200
20250908094053,124.504524,45.342199
20250908094103,124.504525,45.342200
20250908094113,124.504524,45.342199
20250908094123,124.504524,45.342199
20250908094133,124.504524,45.342199
20250908094143,124.504525,45.342200
20250908094153,124.504524,45.342199
20250908094203,124.504525,45.342200
20250908094213,124.504525,45.342200
20250908094223,124.504525,45.342200
20250908094233,124.504524,45.342199
20250908094243,124.504525,45.342200
20250908094253,124.504525,45.342200
20250908094303,124.504525,45.342200
20250908094313,124.504525,45.342200
20250908094323,124.504525,45.342200
20250908094333,124.504525,45.342200
20250908094343,124.504525,45.342199
20250908094353,124.504525,45.342200
20250908094403,124.504525,45.342199
20250908094413,124.504524,45.342199
20250908094423,124.504524,45.342199
20250908094433,124.504525,45.342199
20250908094443,124.504525,45.342199
20250908094453,124.504525,45.342200
20250908094503,124.504525,45.342200
20250908094513,124.504525,45.342199
20250908094523,124.504525,45.342200
20250908094533,124.504525,45.342200
20250908094543,124.504525,45.342199
20250908094553,124.504525,45.342200
20250908094603,124.504525,45.342200
20250908094613,124.504525,45.342200
20250908094623,124.504525,45.342200
20250908094633,124.504525,45.342200
20250908094643,124.504525,45.342200
20250908094653,124.504525,45.342200
20250908094703,124.504525,45.342200
20250908094713,124.504525,45.342200
20250908094723,124.504525,45.342200
20250908094733,124.504525,45.342200
20250908094743,124.504525,45.342200
20250908094753,124.504525,45.342200
20250908094803,124.504525,45.342200
20250908094813,124.504525,45.342200
20250908094823,124.504525,45.342200
20250908094833,124.504525,45.342200
20250908094843,124.504525,45.342200
20250908094853,124.504525,45.342200
20250908094903,124.504525,45.342200
20250908094913,124.504525,45.342200
20250908094923,124.504525,45.342200
20250908094933,124.504525,45.342200
20250908094943,124.504525,45.342200
20250908094953,124.504525,45.342200
20250908095003,124.504525,45.342200
20250908095013,124.504525,45.342200
20250908095023,124.504525,45.342200
20250908095033,124.504525,45.342200
20250908095043,124.504525,45.342200
20250908095053,124.504525,45.342200
20250908095103,124.504525,45.342200
20250908095113,124.504525,45.342200
20250908095123,124.504525,45.342200
20250908095133,124.504525,45.342200
20250908095143,124.504525,45.342200
20250908095153,124.504525,45.342200
20250908095203,124.504525,45.342200
20250908095213,124.504525,45.342200
20250908095223,124.504525,45.342200
20250908095233,124.504525,45.342200
20250908095243,124.504525,45.342200
20250908095253,124.504525,45.342200
20250908095303,124.504525,45.342200
20250908095313,124.504525,45.342200
20250908095323,124.504525,45.342200
20250908095333,124.504525,45.342200
20250908095343,124.504525,45.342200
20250908095353,124.504525,45.342200
20250908095403,124.504525,45.342200
20250908095413,124.504525,45.342200
20250908095423,124.504525,45.342200
20250908095433,124.504525,45.342200
20250908095443,124.504525,45.342200
20250908095453,124.504525,45.342200
20250908095503,124.504525,45.342200
20250908095513,124.504525,45.342200
20250908095523,124.504525,45.342200
20250908095533,124.504525,45.342200
20250908095543,124.504525,45.342200
20250908095553,124.504525,45.342200
20250908095603,124.504525,45.342200
20250908095613,124.504525,45.342200
20250908095623,124.504524,45.342200
20250908095633,124.504524,45.342200
20250908095643,124.504524,45.342200
20250908095653,124.504524,45.342200
20250908095703,124.504525,45.342200
20250908095713,124.504525,45.342200
20250908095723,124.504525,45.342200
20250908095732,124.504525,45.342200
20250908095742,124.504525,45.342200
20250908095752,124.504525,45.342200
20250908095802,124.504525,45.342200
20250908095812,124.504525,45.342200
20250908095822,124.504525,45.342200
20250908095832,124.504525,45.342200
20250908095842,124.504525,45.342200
20250908095852,124.504525,45.342200
20250908095902,124.504525,45.342200
20250908095912,124.504524,45.342200
20250908095922,124.504525,45.342200
20250908095932,124.504525,45.342200
20250908095942,124.504525,45.342200
20250908095952,124.504525,45.342200
20250908100002,124.504525,45.342200
20250908100012,124.504525,45.342200
20250908100022,124.504525,45.342200
20250908100032,124.504525,45.342200
20250908100042,124.504525,45.342200
20250908100052,124.504524,45.342200
20250908100102,124.504525,45.342200
20250908100112,124.504525,45.342200
20250908100122,124.504525,45.342200
20250908100132,124.504525,45.342200
20250908100142,124.504525,45.342200
20250908100152,124.504525,45.342200
20250908100202,124.504525,45.342200
20250908100212,124.504525,45.342200
20250908100222,124.504525,45.342200
20250908100232,124.504525,45.342200
20250908100242,124.504525,45.342200
20250908100252,124.504525,45.342200
20250908100302,124.504525,45.342200
20250908100312,124.504525,45.342200
20250908100322,124.504525,45.342200
20250908100332,124.504525,45.342200
20250908100342,124.504525,45.342200
20250908100352,124.504525,45.342200
20250908100402,124.504525,45.342200
20250908100412,124.504525,45.342200
20250908100422,124.504525,45.342200
20250908100432,124.504525,45.342200
20250908100442,124.504525,45.342200
20250908100452,124.504525,45.342200
20250908100502,124.504525,45.342200
20250908100512,124.504525,45.342200
20250908100522,124.504525,45.342200
20250908100532,124.504525,45.342200
20250908100542,124.504525,45.342200
20250908100552,124.504525,45.342200
20250908100602,124.504525,45.342200
20250908100612,124.504525,45.342200
20250908100622,124.504525,45.342200
20250908100632,124.504525,45.342200
20250908100642,124.504525,45.342200
20250908100652,124.504525,45.342200
20250908100702,124.504525,45.342200
20250908100712,124.504525,45.342200
20250908100722,124.504525,45.342200
20250908100732,124.504525,45.342200
20250908100742,124.504525,45.342200
20250908100752,124.504525,45.342200
20250908100802,124.504525,45.342200
20250908100812,124.504525,45.342200
20250908100822,124.504525,45.342200
20250908100832,124.504525,45.342200
20250908100842,124.504525,45.342200
20250908100852,124.504525,45.342200
20250908100902,124.504525,45.342200
20250908100912,124.504525,45.342199
20250908100922,124.504525,45.342199
20250908100932,124.504525,45.342200
20250908100942,124.504525,45.342199
20250908100952,124.504525,45.342199
20250908101002,124.504525,45.342200
20250908101012,124.504525,45.342199
20250908101022,124.504525,45.342199
20250908101032,124.504525,45.342199
20250908101042,124.504525,45.342200
20250908101052,124.504525,45.342200
20250908101102,124.504525,45.342199
20250908101112,124.504525,45.342199
20250908101122,124.504525,45.342199
20250908101132,124.504525,45.342199
20250908101142,124.504525,45.342199
20250908101152,124.504525,45.342199
20250908101202,124.504525,45.342199
20250908101212,124.504525,45.342199
20250908101222,124.504525,45.342199
20250908101232,124.504525,45.342199
20250908101242,124.504525,45.342199
20250908101252,124.504524,45.342199
20250908101302,124.504525,45.342199
20250908101312,124.504525,45.342199
20250908101322,124.504525,45.342199
20250908101332,124.504525,45.342199
20250908101342,124.504525,45.342200
20250908101352,124.504525,45.342200
20250908101402,124.504525,45.342199
20250908101412,124.504525,45.342200
20250908101422,124.504525,45.342199
20250908101432,124.504525,45.342199
20250908101442,124.504525,45.342199
20250908101452,124.504525,45.342199
20250908101502,124.504525,45.342199
20250908101512,124.504525,45.342199
20250908101522,124.504525,45.342199
20250908101532,124.504525,45.342199
20250908101542,124.504525,45.342199
20250908101552,124.504525,45.342199
20250908101602,124.504525,45.342199
20250908101612,124.504524,45.342199
20250908101622,124.504525,45.342199
20250908101632,124.504525,45.342200
20250908101642,124.504525,45.342199
20250908101652,124.504525,45.342199
20250908101702,124.504525,45.342200
20250908101712,124.504525,45.342199
20250908101722,124.504525,45.342199
20250908101732,124.504525,45.342199
20250908101742,124.504525,45.342199
20250908101752,124.504525,45.342199
20250908101802,124.504525,45.342199
20250908101812,124.504525,45.342199
20250908101822,124.504524,45.342199
20250908101832,124.504525,45.342199
20250908101842,124.504525,45.342199
20250908101852,124.504525,45.342199
20250908101902,124.504525,45.342199
20250908101912,124.504525,45.342199
20250908101922,124.504525,45.342199
20250908101932,124.504524,45.342199
20250908101942,124.504525,45.342200
20250908101952,124.504525,45.342199
20250908102002,124.504524,45.342199
20250908102012,124.504525,45.342200
20250908102022,124.504525,45.342199
20250908102032,124.504525,45.342199
20250908102042,124.504524,45.342199
20250908102052,124.504525,45.342199
20250908102102,124.504525,45.342199
20250908102112,124.504525,45.342200
20250908102122,124.504525,45.342199
20250908102132,124.504525,45.342200
20250908102142,124.504525,45.342199
20250908102152,124.504525,45.342200
20250908102202,124.504525,45.342199
20250908102212,124.504525,45.342200
20250908102222,124.504525,45.342200
20250908102232,124.504525,45.342199
20250908102242,124.504525,45.342199
20250908102252,124.504525,45.342199
20250908102302,124.504525,45.342199
20250908102312,124.504525,45.342199
20250908102322,124.504525,45.342200
20250908102332,124.504525,45.342199
20250908102342,124.504525,45.342199
20250908102352,124.504525,45.342199
20250908102402,124.504525,45.342200
20250908102412,124.504525,45.342199
20250908102422,124.504525,45.342200
20250908102432,124.504525,45.342200
20250908102442,124.504525,45.342199
20250908102452,124.504525,45.342199
20250908102502,124.504525,45.342200
20250908102512,124.504525,45.342200
20250908102522,124.504525,45.342200
20250908102532,124.504525,45.342200
20250908102542,124.504525,45.342199
20250908102552,124.504525,45.342200
20250908102602,124.504525,45.342199
20250908102612,124.504525,45.342199
20250908102622,124.504525,45.342199
20250908102632,124.504525,45.342199
20250908102642,124.504525,45.342199
20250908102652,124.504525,45.342199
20250908102702,124.504525,45.342199
20250908102712,124.504525,45.342199
20250908102722,124.504525,45.342199
20250908102732,124.504525,45.342199
20250908102742,124.504525,45.342199
20250908102752,124.504525,45.342199
20250908102802,124.504525,45.342199
20250908102812,124.504525,45.342199
20250908102822,124.504525,45.342199
20250908102832,124.504525,45.342199
20250908102842,124.504525,45.342199
20250908102852,124.504525,45.342199
20250908102902,124.504525,45.342199
20250908102912,124.504525,45.342199
20250908102922,124.504525,45.342199
20250908102932,124.504525,45.342199
20250908102942,124.504525,45.342199
20250908102952,124.504525,45.342199
20250908103002,124.504525,45.342199
20250908103012,124.504525,45.342199
20250908103022,124.504524,45.342199
20250908103032,124.504525,45.342199
20250908103042,124.504525,45.342199
20250908103052,124.504525,45.342199
20250908103102,124.504525,45.342199
20250908103112,124.504525,45.342199
20250908103122,124.504525,45.342199
20250908103132,124.504525,45.342199
20250908103142,124.504524,45.342199
20250908103152,124.504525,45.342199
20250908103202,124.504525,45.342199
20250908103212,124.504525,45.342199
20250908103222,124.504525,45.342199
20250908103232,124.504524,45.342199
20250908103242,124.504525,45.342199
20250908103252,124.504525,45.342199
20250908103302,124.504525,45.342199
20250908103312,124.504525,45.342199
20250908103322,124.504525,45.342199
20250908103332,124.504525,45.342199
20250908103342,124.504525,45.342199
20250908103352,124.504525,45.342199
20250908103402,124.504524,45.342199
20250908103412,124.504525,45.342199
20250908103422,124.504524,45.342199
20250908103432,124.504524,45.342199
20250908103442,124.504525,45.342199
20250908103452,124.504525,45.342199
20250908103502,124.504525,45.342199
20250908103512,124.504525,45.342199
20250908103522,124.504525,45.342199
20250908103532,124.504525,45.342199
20250908103542,124.504525,45.342199
20250908103552,124.504525,45.342199
20250908103602,124.504525,45.342199
20250908103612,124.504525,45.342199
20250908103622,124.504525,45.342200
20250908103632,124.504525,45.342199
20250908103642,124.504525,45.342199
20250908103652,124.504525,45.342200
20250908103702,124.504525,45.342199
20250908103712,124.504525,45.342199
20250908103722,124.504525,45.342199
20250908103732,124.504525,45.342199
20250908103742,124.504525,45.342200
20250908103752,124.504525,45.342199
20250908103802,124.504525,45.342200
20250908103812,124.504525,45.342199
20250908103822,124.504525,45.342199
20250908103832,124.504525,45.342200
20250908103842,124.504525,45.342199
20250908103852,124.504525,45.342199
20250908103902,124.504525,45.342199
20250908103912,124.504525,45.342199
20250908103922,124.504525,45.342199
20250908103932,124.504525,45.342199
20250908103942,124.504525,45.342199
20250908103952,124.504525,45.342199
20250908104002,124.504525,45.342199
20250908104012,124.504525,45.342199
20250908104022,124.504525,45.342199
20250908104032,124.504525,45.342199
20250908104042,124.504525,45.342199
20250908104052,124.504525,45.342200
20250908104102,124.504525,45.342200
20250908104112,124.504525,45.342200
20250908104122,124.504525,45.342199
20250908104132,124.504525,45.342200
20250908104142,124.504525,45.342200
20250908104152,124.504525,45.342199
20250908104202,124.504524,45.342200
20250908104212,124.504525,45.342200
20250908104221,124.504525,45.342200
20250908104231,124.504525,45.342199
20250908104241,124.504525,45.342200
20250908104251,124.504525,45.342200
20250908104301,124.504525,45.342200
20250908104311,124.504525,45.342200
20250908104321,124.504525,45.342200
20250908104331,124.504525,45.342200
20250908104341,124.504525,45.342200
20250908104351,124.504525,45.342200
20250908104401,124.504525,45.342200
20250908104411,124.504525,45.342200
20250908104421,124.504525,45.342200
20250908104431,124.504525,45.342200
20250908104441,124.504525,45.342200
20250908104451,124.504525,45.342200
20250908104501,124.504525,45.342200
20250908104511,124.504525,45.342200
20250908104521,124.504525,45.342200
20250908104531,124.504525,45.342200
20250908104541,124.504525,45.342199
20250908104551,124.504525,45.342200
20250908104601,124.504525,45.342200
20250908104611,124.504525,45.342200
20250908104621,124.504525,45.342200
20250908104631,124.504525,45.342200
20250908104641,124.504525,45.342199
20250908104651,124.504525,45.342199
20250908104701,124.504525,45.342200
20250908104711,124.504525,45.342199
20250908104721,124.504525,45.342200
20250908104731,124.504525,45.342200
20250908104741,124.504525,45.342200
20250908104751,124.504525,45.342200
20250908104801,124.504525,45.342200
20250908104811,124.504525,45.342200
20250908104821,124.504525,45.342200
20250908104831,124.504525,45.342200
20250908104841,124.504524,45.342200
20250908104851,124.504525,45.342200
20250908104901,124.504525,45.342200
20250908104911,124.504525,45.342200
20250908104921,124.504525,45.342200
20250908104931,124.504525,45.342200
20250908104941,124.504525,45.342200
20250908104951,124.504525,45.342200
20250908110934,124.504525,45.342199
20250908112847,124.504465,45.342164
20250908112857,124.504446,45.342119
20250908112907,124.504446,45.342125
20250908112917,124.504446,45.342125
20250908112927,124.504446,45.342125
20250908112937,124.504446,45.342125
20250908112947,124.504451,45.342114
20250908112957,124.504464,45.342086
20250908113007,124.504478,45.342051
20250908113017,124.504481,45.342023
20250908113027,124.504481,45.342030
20250908113037,124.504419,45.342022
20250908113047,124.504365,45.342006
20250908113532,124.504467,45.342050
20250908113542,124.504461,45.342093
20250908113552,124.504453,45.342115
20250908113602,124.504445,45.342147
20250908113612,124.504467,45.342181
20250908113622,124.504513,45.342203
20250908113632,124.504526,45.342208</textarea>
            <div class="button-group">
                <button id="drawTrackButton" disabled style="flex: 1;">绘制轨迹</button>
                <button id="showTrackPointsButton" disabled style="flex: 1;" class="btn-warning">打点</button>
                <button id="clearTrackButton" disabled style="flex: 1;">清空轨迹</button>
            </div>
            <!-- 回放控制 -->
            <div class="split-section" style="margin-top:8px;">
                <div class="title">轨迹回放</div>
                <div class="playback-actions" style="display:flex;gap:8px;margin-bottom:8px;">
                    <button id="playbackStartBtn" disabled>开始</button>
                    <button id="playbackPauseBtn" disabled>继续</button>
                    <button id="playbackStopBtn" disabled>结束</button>
                </div>
                <div class="playback-speed" style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                    <label>速度：
                        <select id="playbackSpeedSelect" disabled>
                            <option value="1" selected>1×</option>
                            <option value="2">2×</option>
                            <option value="4">4×</option>
                            <option value="8">8×</option>
                            <option value="16">16×</option>
                            <option value="32">32×</option>
                            <option value="64">64×</option>
                            <option value="128">128×</option>
                            <option value="256">256×</option>
                            <option value="512">512×</option>
                            <option value="1024">1024×</option>
                        </select>
                    </label>
                    <span id="playbackTimeLabel" style="font-size:12px;color:#666;">时间：—</span>
                </div>
                <div class="playback-time" style="display:flex;flex-direction:column;gap:4px;margin-bottom:8px;">
                    <label class="playback-time-label" style="display:flex;align-items:center;gap:8px;flex:1 1 auto;min-width:0;">
                        <span class="playback-time-text" style="white-space:nowrap;">起始时间：</span>
                        <input type="range" id="playbackTimeSlider" disabled min="0" max="0" step="1000" value="0" style="flex:1 1 auto;min-width:0;max-width:100%;vertical-align:middle;">
                    </label>
                    <span id="playbackTimeCursor" style="font-size:12px;color:#666;align-self:flex-end;">—</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let map;
    let currentPolygons = []; // 存储多边形和其标签
    let currentTracks = []; // 存储轨迹折线及相关覆盖物
    let mapLoaded = false;
    let mapLabelHandlers = []; // 存储地图事件处理器
    let labelsEnabled = false; // 标签显示开关（默认关闭）
    let isDrawing = false; // 绘制进行中防止重复点击

    window.onload = function () {
        if (typeof T === 'undefined') {
            alert("天地图API加载失败，请检查网络或密钥！");
            return;
        }
        initMap();
        bindDrawEvent();
        bindMinimizeEvent();
        bindTabs();
        bindBatchGenerator();
        bindMultiSplitter();
        bindLabelsToggle(); // 绑定标签显示开关
        bindTrackEvents();  // 绑定轨迹绘制与清空
        bindPlaybackControls(); // 绑定轨迹回放
    };

    function initMap() {
        showLoading();
        disableButtons(true);

        try {
            map = new T.Map("mapContainer", {
                zoom: 12,
                center: new T.LngLat(116.40769, 39.90403)
            });

            // 已移除测试标签
            map.enableScrollWheelZoom();

            // 添加地图类型控件
            const mapTypeCtrl = new T.Control.MapType({
                mapTypes: [TMAP_NORMAL_MAP, TMAP_SATELLITE_MAP, TMAP_TERRAIN_MAP],
                position: T_ANCHOR_TOP_LEFT
            });
            map.addControl(mapTypeCtrl);

            // 加载影像底图（卫星）
            const tk = "648f621977051d0199ff0f965d3fd322";

            // 方案1：使用默认地图类型（作为备选）
            map.setMapType(TMAP_SATELLITE_MAP);

            // 方案2：手动添加影像图层（底图 + 标注）
            const vecLayer = new T.TileLayer(`https://t0.tianditu.gov.cn/img_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=img&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`);
            const cvaLayer = new T.TileLayer(`https://t0.tianditu.gov.cn/cia_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cia&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`);

            // 添加图层并监听加载状态
            vecLayer.addEventListener("load", function () {
                console.log("影像底图加载完成");
            });

            vecLayer.addEventListener("error", function (e) {
                console.error("影像底图加载错误:", e);
                alert("影像底图加载错误，将使用默认地图类型");
            });

            map.addLayer(vecLayer);
            map.addLayer(cvaLayer);

            // 监听地图加载事件
            map.addEventListener("loaded", function () {
                console.log("地图加载完成");
                markMapLoaded();
            });
            map.addEventListener("load", function () {
                console.log("地图load事件触发");
                markMapLoaded();
            });
            map.addEventListener("tilesloaded", function () {
                console.log("地图瓦片加载完成");
                markMapLoaded();
            });
            // 监听地图加载失败事件
            map.addEventListener("error", function (e) {
                console.error("地图加载错误:", e);
                alert("地图加载错误: " + e.message);
                hideLoading();
            });

            // 监听地图移动事件，用于更新标签位置
            const moveHandler = function () {
                updateAllLabelsPosition();
            };
            map.addEventListener("move", moveHandler);
            map.addEventListener("zoom", moveHandler);

            // 存储事件处理器，用于清理
            mapLabelHandlers.push({ event: "move", handler: moveHandler });
            mapLabelHandlers.push({ event: "zoom", handler: moveHandler });

            // 超时容错
            setTimeout(() => {
                if (!mapLoaded) markMapLoaded();
            }, 8000);

        } catch (error) {
            alert("地图初始化失败：" + error.message);
            console.error(error);
            hideLoading();
        }
    }

    function markMapLoaded() {
        if (!mapLoaded) {
            mapLoaded = true;
            hideLoading();
            disableButtons(false);
            disableTrackButtons(false);
            // 仅开启速度选择，回放按钮按状态控制
            const speedSel = document.getElementById('playbackSpeedSelect');
            if (speedSel) speedSel.disabled = false;
            updatePlaybackButtonsState('idle');
        }
    }

    function showLoading() {
        const loading = document.getElementById("mapLoading");
        loading.style.display = "flex";
        loading.style.opacity = "1";
    }

    function hideLoading() {
        const loading = document.getElementById("mapLoading");
        loading.style.opacity = "0";
        setTimeout(() => loading.style.display = "none", 300);
    }

    function disableButtons(disabled) {
        document.getElementById("drawButton").disabled = disabled;
        document.getElementById("clearButton").disabled = disabled;
    }

    function disableTrackButtons(disabled) {
        const drawTrackBtn = document.getElementById("drawTrackButton");
        const showTrackPointsBtn = document.getElementById("showTrackPointsButton");
        const clearTrackBtn = document.getElementById("clearTrackButton");
        if (drawTrackBtn) drawTrackBtn.disabled = disabled;
        if (showTrackPointsBtn) showTrackPointsBtn.disabled = disabled;
        if (clearTrackBtn) clearTrackBtn.disabled = disabled;
    }
    // 回放控件的禁用/启用
    function disablePlaybackButtons(disabled) {
        ["playbackStartBtn","playbackPauseBtn","playbackStopBtn","playbackSpeedSelect","playbackTimeSlider"].forEach(id=>{
            const el = document.getElementById(id);
            if (el) el.disabled = disabled;
        });
    }

    // 回放按钮状态管理：空闲/播放/暂停
    function updatePlaybackButtonsState(state){
        try {
            const startBtn = document.getElementById('playbackStartBtn');
            const pauseBtn = document.getElementById('playbackPauseBtn');
            const stopBtn = document.getElementById('playbackStopBtn');
            if (!startBtn || !pauseBtn || !stopBtn) return;
            if (state === 'idle') {
                startBtn.disabled = false;
                pauseBtn.disabled = true;
                stopBtn.disabled = true;
                pauseBtn.textContent = '继续';
            } else if (state === 'playing') {
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
                pauseBtn.textContent = '暂停';
            } else if (state === 'paused') {
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
                pauseBtn.textContent = '继续';
            }
        } catch(e) { console.warn('更新按钮状态失败:', e); }
    }

    function bindDrawEvent() {
        document.getElementById("drawButton").addEventListener("click", function () {
            if (isDrawing) { console.log('绘制进行中，忽略重复点击'); return; }
            isDrawing = true;
            disableButtons(true);
            showLoading();
            try {
                const wktStr = document.getElementById("wktTextarea").value.trim();
                if (!wktStr) { alert("请输入WKT字符串！"); return; }
                clearOverlays();
                const geojson = parseWkt(wktStr);
    
                const polygonData = [];
                if (geojson.type === "Polygon") {
                    polygonData.push({ index: 1, coordinates: geojson.coordinates });
                } else if (geojson.type === "MultiPolygon") {
                    geojson.coordinates.forEach((polygon, index) => {
                        polygonData.push({ index: index + 1, coordinates: polygon });
                    });
                }
    
                // 重置并绘制
                polygonInfoList = [];
                polygonData.forEach(pd => processPolygon(pd.index, pd.coordinates));
    
                // 视图居中到所有已绘制轮廓
                try { fitViewportToPolygons(); } catch (e) { console.warn('视图居中失败', e); }
    
                // 在视图稳定后再创建/更新标签
                setTimeout(() => {
                    if (labelsEnabled) {
                        try {
                            createAllLabels();
                            updateAllLabelsPosition();
                        } catch (e) {
                            console.warn('创建或更新标签失败:', e);
                        }
                    }
                }, 150);
            } catch (e) {
                alert('绘制失败：' + (e && e.message ? e.message : e));
                console.error('绘制异常:', e);
            } finally {
                hideLoading();
                isDrawing = false;
                disableButtons(false);
            }
        });

        document.getElementById("clearButton").addEventListener("click", function () {
            if (isDrawing) { console.log('绘制进行中，暂不清空'); return; }
            clearOverlays();
            console.log("已清空所有轮廓");
        });
    }

    // 存储多边形数据，用于后续标签创建
    let polygonInfoList = [];

    // 处理单个多边形的绘制和面积计算
    function processPolygon(actualPolygonIndex, polygonCoords) {
        console.log('开始处理多边形', actualPolygonIndex);

        // 坐标系选择（绘制始终使用WGS84坐标）
        const coordSys = (document.getElementById('coordSysSelect') && document.getElementById('coordSysSelect').value) || 'wgs84';

        // 统一转换为WGS84用于绘制与面积计算
        function toWgs(point){
            const lng = point[0], lat = point[1];
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                return [lng, lat];
            } else if (coordSys === 'gcj02') {
                const w = gcj02ToWgs84(lng, lat);
                return [w.lng, w.lat];
            } else if (coordSys === 'bd09') {
                const gcj = bd09ToGcj02(lng, lat);
                const w = gcj02ToWgs84(gcj.lng, gcj.lat);
                return [w.lng, w.lat];
            }
            return [lng, lat];
        }
        const coordsWGS84 = polygonCoords.map(ring => ring.map(toWgs));
        let outerRingWGS = coordsWGS84[0] || [];

        // 生成用于绘制的坐标（直接使用WGS84坐标）
        const rings = coordsWGS84.map(ring => ring.map(([lng, lat]) => new T.LngLat(lng, lat)));


         // 创建半透明填充的多边形（无边框）
          const polygon = new T.Polygon(rings, {
              color: "#FFD700",
              weight: 1,
              opacity: 1,
              fillColor: "#FFFF00",
              fillOpacity: 0.35
          });
 
          // 使用WGS84坐标计算面积（更准确的面积计算）
         let areaSqm;
         let areaMu;



         try {
             // 检查Turf.js是否可用
             if (typeof turf !== 'undefined' && turf.area) {
                 // 使用Turf.js计算多边形面积
                // 构造GeoJSON格式的多边形
                const geoJsonPolygon = {
                    type: "Polygon",
                    coordinates: coordsWGS84
                };


                 // 使用Turf.js计算面积（平方米）
                 areaSqm = turf.area(geoJsonPolygon);
                 areaMu = (areaSqm / 666.6667).toFixed(4); // 转换为亩
                 console.log(`多边形${actualPolygonIndex}面积计算结果(Turf.js): ${areaSqm}平方米 = ${areaMu}亩`);
             } else {
                 // 如果Turf.js不可用，回退到之前的计算方法
                 console.warn('Turf.js不可用，使用备用计算方法');
                 // 计算带孔洞的多边形面积
                 areaSqm = 0;
                 // 计算外环面积
                 outerRingWGS = coordsWGS84[0] || [];
                 areaSqm += calculatePolygonArea(outerRingWGS);

                 // 减去内环（孔洞）面积
                 for (let i = 1; i < coordsWGS84.length; i++) {
                     const innerRingArea = calculatePolygonArea(coordsWGS84[i]);
                     areaSqm -= innerRingArea;
                 }

                  areaMu = (areaSqm / 666.6667).toFixed(4); // 使用更精确的转换系数
                  console.log(`多边形${actualPolygonIndex}面积计算结果(备用): ${areaSqm}平方米 = ${areaMu}亩`);
              }
          } catch (error) {
              console.error(`面积计算失败:`, error);
              areaSqm = 0;
              areaMu = '0.0000';
          }

          // 计算多边形的中心点和底部中心点（WGS84）
          const centerPoint = calculatePolygonCenter(outerRingWGS);
          const bottomCenterPoint = calculatePolygonBottomCenter(outerRingWGS);

          // 添加多边形到地图
          if (map) {
              map.addOverLay(polygon);
              console.log(`多边形${actualPolygonIndex}已添加到地图`);
          } else {
              console.error('地图对象不存在');
          }

          // 存储多边形信息，用于后续标签创建
          polygonInfoList.push({
              index: actualPolygonIndex,
              polygon: polygon,
              area: areaMu,
              bottomCenter: { lng: bottomCenterPoint.lng, lat: bottomCenterPoint.lat },
              ringPoints: rings
          });
      }

    // 视图居中：根据已绘制的GCJ-02点
    function fitViewportToPolygons() {
        const points = [];
        try {
            if (!map || !map.setViewport) return;
            polygonInfoList.forEach(info => {
                if (!info || !info.ringPoints) return;
                info.ringPoints.forEach(ring => {
                    ring.forEach(ll => points.push(ll));
                });
            });
            if (!points.length) return;
            map.setViewport(points);
        } catch (e) {
            try {
                const lngs = points.map(p => p.lng);
                const lats = points.map(p => p.lat);
                const center = new T.LngLat(
                    (Math.min(...lngs) + Math.max(...lngs)) / 2,
                    (Math.min(...lats) + Math.max(...lats)) / 2
                );
                if (map && map.panTo) map.panTo(center);
            } catch (e2) {
                console.warn('视图居中失败:', e2);
            }
        }
    }

    // 统一创建所有多边形的标签
    function createAllLabels() {
        const mapContainer = document.getElementById('mapContainer');
        if (!mapContainer || !map) return;

        polygonInfoList.forEach(info => {
            if (!info) return;
            // 防止重复创建
            if (info.labelRef) return;
            // 创建标签元素
            const labelDiv = document.createElement('div');
            labelDiv.className = 'area-label';
            labelDiv.innerHTML = `多边形${info.index}：${info.area}亩`;

            // 添加到地图容器并根据屏幕边界定位到轮廓下方
            mapContainer.appendChild(labelDiv);
            positionLabelForPolygon(labelDiv, info);

            // 记录引用，避免重复创建
            info.labelRef = labelDiv;

            // 存储到 currentPolygons 以复用现有定位/清理逻辑
            const labelObj = {
                domElement: labelDiv,
                isDomLabel: true,
                polygonInfo: info
            };
            currentPolygons.push({ polygon: info.polygon, label: labelObj });
        });

        // 不清空 polygonInfoList，便于开关随时创建/隐藏标签
    }

    // 根据多边形屏幕边界定位标签，保证始终在轮廓下方
    function positionLabelForPolygon(labelDiv, info) {
        if (!map || !info || !info.ringPoints) return;
        const points = [];
        info.ringPoints.forEach(ring => {
            ring.forEach(ll => {
                const p = map.lngLatToContainerPoint(ll);
                points.push(p);
            });
        });
        if (!points.length) return;
        const minX = Math.min(...points.map(p => p.x));
        const maxX = Math.max(...points.map(p => p.x));
        const maxY = Math.max(...points.map(p => p.y));
        const container = document.getElementById('mapContainer');
        const labelWidth = labelDiv.offsetWidth;
        const labelHeight = labelDiv.offsetHeight;
        const targetLeft = Math.round((minX + maxX) / 2 - labelWidth / 2);
        const targetTop = Math.round(maxY + 6);
        const clampedLeft = Math.max(0, Math.min(targetLeft, container.clientWidth - labelWidth));
        const clampedTop = Math.max(0, Math.min(targetTop, container.clientHeight - labelHeight));
        labelDiv.style.left = clampedLeft + 'px';
        labelDiv.style.top = clampedTop + 'px';
    }

    // 更新所有标签位置（地图move/zoom时调用）
    function updateAllLabelsPosition() {
        try {
            if (!map) return;
            const container = document.getElementById('mapContainer');
            if (!container) return;
            currentPolygons.forEach(item => {
                if (!item || !item.label) return;
                const labelObj = item.label;
                if (labelObj.isDomLabel && labelObj.domElement && labelObj.polygonInfo) {
                    // 确保标签在容器中
                    if (!labelObj.domElement.parentNode) {
                        container.appendChild(labelObj.domElement);
                    }
                    positionLabelForPolygon(labelObj.domElement, labelObj.polygonInfo);
                }
            });
        } catch (e) {
            console.warn('更新标签位置时出错:', e);
        }
    }
    // 确保在全局可用（处理第三方库事件回调作用域差异）
    window.updateAllLabelsPosition = updateAllLabelsPosition;

    // 绑定“显示亩数标签”开关（默认隐藏）
    function bindLabelsToggle() {
        const cb = document.getElementById('toggleLabelsCheckbox');
        const container = document.getElementById('mapContainer');
        if (!cb || !container) return;
        // 默认隐藏标签
        container.classList.add('labels-hidden');
        cb.addEventListener('change', () => {
            labelsEnabled = cb.checked;
            if (labelsEnabled) {
                container.classList.remove('labels-hidden');
                const hasAnyLabel = currentPolygons.some(item => item && item.label && item.label.domElement);
                if (!hasAnyLabel) {
                    try { createAllLabels(); } catch (e) { console.warn('创建标签失败:', e); }
                }
                updateAllLabelsPosition();
            } else {
                container.classList.add('labels-hidden');
            }
        });
    }

    /**
     * 计算多边形中心点（比底部中心更适合显示标签）
     */
    function calculatePolygonCenter(outerRing) {
        let sumLng = 0, sumLat = 0;
        const len = outerRing.length;

        for (let i = 0; i < len; i++) {
            sumLng += outerRing[i][0];
            sumLat += outerRing[i][1];
        }

        return {
            lng: sumLng / len,
            lat: sumLat / len
        };
    }

    /**
     * 计算多边形面积（球面多边形面积计算）
     * 使用更准确的球面坐标面积计算方法，确保面积与视觉大小一致
     */
    function calculatePolygonArea(coordinates) {
        // 地球半径（米）- 使用更精确的值
        const R = 6371000.8;
        const n = coordinates.length;

        // 将所有坐标转换为弧度
        const coordsRad = coordinates.map(point => [
            point[0] * Math.PI / 180,
            point[1] * Math.PI / 180
        ]);

        let areaRad = 0;

        // 使用更准确的球面多边形面积公式（Girard定理）
        for (let i = 0; i < n; i++) {
            const j = (i + 1) % n;
            const lon1 = coordsRad[i][0];
            const lat1 = coordsRad[i][1];
            const lon2 = coordsRad[j][0];
            const lat2 = coordsRad[j][1];

            // 计算球面多边形面积增量
            const dlon = lon2 - lon1;
            const sinLat1 = Math.sin(lat1);
            const sinLat2 = Math.sin(lat2);
            const cosLat1 = Math.cos(lat1);
            const cosLat2 = Math.cos(lat2);

            // 使用更精确的公式
            areaRad += dlon * (sinLat1 * cosLat2 * Math.cos(dlon / 2) + sinLat2 * cosLat1);
        }

        // 计算总面积（平方米）
        const areaSqm = Math.abs(areaRad) * R * R * 0.5;

        return areaSqm;
    }

    /**
     * 清空所有多边形和标签（同时处理 polygonInfoList 与 currentPolygons）
     */
    function clearOverlays() {
        try {
            // 先移除 polygonInfoList 中记录的多边形与其DOM标签
            polygonInfoList.forEach(info => {
                if (info && info.polygon && map && map.removeOverLay) {
                    try { map.removeOverLay(info.polygon); } catch (e) { console.warn('移除多边形失败:', e); }
                }
                if (info && info.labelRef && info.labelRef.parentNode) {
                    try { info.labelRef.parentNode.removeChild(info.labelRef); } catch (e) { console.warn('移除DOM标签失败:', e); }
                    info.labelRef = null;
                }
            });

            // 再处理 currentPolygons（兼容旧路径与标签对象）
            currentPolygons.forEach(item => {
                if (item.polygon && map && map.removeOverLay) {
                    try { map.removeOverLay(item.polygon); } catch (e) { console.warn('移除多边形失败:', e); }
                }
                if (item.label) {
                    if (item.label.domElement && item.label.domElement.parentNode) {
                        try { item.label.domElement.parentNode.removeChild(item.label.domElement); } catch (e) { console.warn('移除DOM标签失败:', e); }
                    } else if (map && map.removeOverLay && !item.label.isDomLabel) {
                        try { map.removeOverLay(item.label); } catch (e) { console.warn('移除地图覆盖物标签失败:', e); }
                    }
                }
            });

            // 清空记录数组
            currentPolygons = [];
            polygonInfoList = [];

            console.log('已清空所有多边形和标签（保留事件监听器）');
        } catch (error) {
            console.error('清空覆盖物时出错:', error);
        }
    }

    // 其他辅助函数（保持不变）
    function bindMinimizeEvent() {
        const container = document.querySelector(".wkt-input-container");
        const btn = document.getElementById("minimizeBtn");
        const minIcon = btn?.querySelector(".min-icon");
        const restoreIcon = btn?.querySelector(".restore-icon");

        btn?.addEventListener("click", () => {
            const minimized = container.classList.toggle("minimized");
            if (minIcon && restoreIcon) {
                if (minimized) {
                    minIcon.style.display = "none";
                    restoreIcon.style.display = "";
                } else {
                    minIcon.style.display = "";
                    restoreIcon.style.display = "none";
                }
            }
        });
    }

    // 在脚本内部补充：页签切换（3个页签）
     function bindTabs() {
         const tabs = [
             { btn: document.getElementById('tabDrawBtn'), pane: document.getElementById('tabDraw'), key: 'draw' },
             { btn: document.getElementById('tabTrackBtn'), pane: document.getElementById('tabTrack'), key: 'track' },
             { btn: document.getElementById('tabSplitBtn'), pane: document.getElementById('tabSplit'), key: 'split' },
             { btn: document.getElementById('tabBatchBtn'), pane: document.getElementById('tabBatch'), key: 'batch' },
         ];
         if (tabs.some(t => !t.btn || !t.pane)) return;
         function activate(key) {
             tabs.forEach(t => {
                 const active = t.key === key;
                 t.btn.classList.toggle('active', active);
                 t.pane.classList.toggle('active', active);
             });
         }
         tabs.forEach(t => t.btn.addEventListener('click', () => activate(t.key)));
         activate('draw');
     }
    function updateParserStatus() {
        const el = document.getElementById('parserStatus');
        if (!el) return;
        const ok = (typeof Terraformer !== 'undefined' && Terraformer.WKT && typeof Terraformer.WKT.parse === 'function');
        if (ok) {
            el.textContent = 'Terraformer WKT Parser';
            el.style.color = '#2f8f2f';
        } else {
            el.textContent = '本地回退解析（仅支持POLYGON/MULTIPOLYGON）';
            el.style.color = '#c77d1e';
        }
    }
     function parseWkt(wkt) {
         wkt = wkt.trim();
         // 优先使用成熟库（Terraformer WKT Parser）
         if (typeof Terraformer !== 'undefined' && Terraformer.WKT && Terraformer.WKT.parse) {
             try {
                 return Terraformer.WKT.parse(wkt);
             } catch (e) {
                 console.warn('Terraformer解析失败，尝试本地回退解析:', e);
             }
         } else {
             // 不再提示“未加载”，由状态栏展示回退信息
         }
         // 回退解析：仅支持 POLYGON / MULTIPOLYGON
         const typeMatch = wkt.match(/^\s*(POLYGON|MULTIPOLYGON)\s*\(/i);
         if (!typeMatch) throw new Error('仅支持POLYGON/MULTIPOLYGON');
         const type = typeMatch[1].toUpperCase();
         const inner = wkt.substring(wkt.indexOf('('));
         if (type === 'POLYGON') {
             const coords = parsePolygonCoords(inner.replace(/^\(/, '').replace(/\)$/, ''));
             return { type: 'Polygon', coordinates: coords };
         } else {
             const trimmed = inner.replace(/^\(\(/, '').replace(/\)\)$/, '');
             const coords = parseMultiPolygonCoords(trimmed);
             return { type: 'MultiPolygon', coordinates: coords };
         }
     }

     function bindMultiSplitter() {
         const input = document.getElementById('multiInput');
         const output = document.getElementById('polyOutput');
         const splitBtn = document.getElementById('splitMultiBtn');
         const copyBtn = document.getElementById('copyPolysBtn');
         if (!input || !output || !splitBtn || !copyBtn) return;

         // 本地WKT序列化辅助
         function ringToText(ring) {
             if (!ring || !ring.length) return '()';
             const first = ring[0];
             const last = ring[ring.length - 1];
             const closed = (first[0] === last[0] && first[1] === last[1]) ? ring : ring.concat([[first[0], first[1]]]);
             return '(' + closed.map(pt => pt[0] + ' ' + pt[1]).join(', ') + ')';
         }
         function toWktPolygonCoords(coords) {
             return 'POLYGON(' + coords.map(ringToText).join(', ') + ')';
         }
         function toWktMulti(coords) {
             return 'MULTIPOLYGON(' + coords.map(poly => '(' + poly.map(ringToText).join(', ') + ')').join(', ') + ')';
         }

         function polygonsFromMulti(text) {
             const geo = parseWkt(text.trim());
             if (geo.type !== 'MultiPolygon') throw new Error('请输入有效的 MULTIPOLYGON WKT');
             const polys = geo.coordinates.map(rings => toWktPolygonCoords(rings));
             return polys;
         }
         splitBtn.addEventListener('click', () => {
             try {
                 const list = polygonsFromMulti(input.value.trim());
                 output.value = list.join('\n');
             } catch (e) {
                 alert('分割失败：' + e.message);
             }
         });
         copyBtn.addEventListener('click', async () => {
             const val = output.value.trim();
             if (!val) { alert('没有可复制的结果'); return; }
             try { await navigator.clipboard.writeText(val); alert('已复制到剪贴板'); } catch (e) { console.warn('复制失败', e); }
         });
     }

     function bindBatchGenerator() {
         const batchInput = document.getElementById('batchInput');
         const output = document.getElementById('multiOutput');
         const genBtn = document.getElementById('generateMultiBtn');
         const copyBtn = document.getElementById('copyMultiBtn');

         // 本地WKT序列化辅助（与分割器保持一致）
         function ringToText(ring) {
             if (!ring || !ring.length) return '()';
             const first = ring[0];
             const last = ring[ring.length - 1];
             const closed = (first[0] === last[0] && first[1] === last[1]) ? ring : ring.concat([[first[0], first[1]]]);
             return '(' + closed.map(pt => pt[0] + ' ' + pt[1]).join(', ') + ')';
         }
         function toWktMulti(coords) {
             return 'MULTIPOLYGON(' + coords.map(poly => '(' + poly.map(ringToText).join(', ') + ')').join(', ') + ')';
         }

         genBtn.addEventListener('click', () => {
             try {
                 const lines = batchInput.value.trim().split(/\n|;/).map(s => s.trim()).filter(Boolean);
                 if (lines.length === 0) throw new Error('请按每行或分号输入至少一个POLYGON');
                 const polygons = lines.map((line, idx) => {
                     const g = parseWkt(line);
                     if (g.type !== 'Polygon') throw new Error(`第${idx + 1}行不是有效的POLYGON WKT`);
                     return g;
                 });
                 const multiGeo = { type: 'MultiPolygon', coordinates: polygons.map(p => p.coordinates) };
                 output.value = toWktMulti(multiGeo.coordinates);
             } catch (e) {
                 alert('生成失败：' + e.message);
             }
         });

         copyBtn.addEventListener('click', async () => {
             const val = output.value.trim();
             if (!val) { alert('没有可复制的结果'); return; }
             try { await navigator.clipboard.writeText(val); alert('已复制到剪贴板'); } catch (e) { console.warn('复制失败', e); }
         });

     }

     function setExampleWkt() {
         const exampleWkt = "MULTIPOLYGON(" +
             "(" +
             "(116.35 39.93, 116.39 39.93, 116.39 39.90, 116.35 39.90, 116.35 39.93)," + // 外环
             "(116.36 39.92, 116.38 39.92, 116.38 39.91, 116.36 39.91, 116.36 39.92)" +  // 内环
             ")," +
             "(" +
             "(116.40 39.95, 116.43 39.97, 116.46 39.96, 116.49 39.98, 116.52 39.95, 116.55 39.93, 116.58 39.94, 116.61 39.92, 116.64 39.95, 116.40 39.95)" +
             ")" +
             ")";
         document.getElementById("wktTextarea").value = exampleWkt;
     }

     function parsePolygonCoords(coordStr) {
         const ringStrs = coordStr.split(/\)\s*,\s*\(/).map(s => s.replace(/[()]/g, '').trim());
         const rings = [];
         ringStrs.forEach(ringStr => {
             const pts = ringStr.split(/,\s*/).map(pointStr => {
                 const [lng, lat] = pointStr.split(/\s+/).map(Number);
                 if (isNaN(lng) || isNaN(lat)) throw new Error("坐标格式错误：" + pointStr);
                 return [lng, lat];
             });
             // 自动拆分：如果一个ring中包含多次回到起点（闭合），则拆分为多个环
             // 兼容用户将外环与内环错误地写在同一对括号中的情况
             let start = 0;
             while (start < pts.length) {
                 const startPt = pts[start];
                 let closeIdx = -1;
                 for (let i = start + 1; i < pts.length; i++) {
                     if (pts[i][0] === startPt[0] && pts[i][1] === startPt[1]) {
                         closeIdx = i;
                         break;
                     }
                 }
                 if (closeIdx === -1) {
                     // 未找到闭合：将剩余点视为一个环，并强制闭合
                     const ring = pts.slice(start);
                     if (ring.length && (ring[0][0] !== ring[ring.length - 1][0] || ring[0][1] !== ring[ring.length - 1][1])) {
                         ring.push([ring[0][0], ring[0][1]]);
                     }
                     rings.push(ring);
                     break;
                 } else {
                     const ring = pts.slice(start, closeIdx + 1);
                     rings.push(ring);
                     start = closeIdx + 1;
                 }
             }
         });
         return rings;
     }

     function parseMultiPolygonCoords(coordStr) {
         const polygonStrs = coordStr.split(/\)\s*\)\s*,\s*\(\s*\(/).map(s => s.replace(/[()]/g, '').trim());
         return polygonStrs.map(polygonStr => parsePolygonCoords(polygonStr));
     }

     function wgs84ToGcj02(lng, lat) {
         const x_PI = 3.14159265358979324 * 3000.0 / 180.0;
         const PI = 3.1415926535897932384626;
         const a = 6378245.0;
         const ee = 0.00669342162296594323;

         if (outOfChina(lng, lat)) return { lng, lat };

         let dlat = transformLat(lng - 105.0, lat - 35.0);
         let dlng = transformLng(lng - 105.0, lat - 35.0);
         const radlat = lat / 180.0 * PI;
         let magic = Math.sin(radlat);
         magic = 1 - ee * magic * magic;
         const sqrtmagic = Math.sqrt(magic);
         dlat = (dlat * 180.0) / ((a * (1 - ee)) / (magic * sqrtmagic) * PI);
         dlng = (dlng * 180.0) / (a / sqrtmagic * Math.cos(radlat) * PI);

         return { lng: lng + dlng, lat: lat + dlat };

         function outOfChina(lng, lat) {
             return (lng < 72.004 || lng > 137.8347) || (lat < 0.8293 || lat > 55.8271);
         }

         function transformLat(x, y) {
             let ret = -100.0 + 2.0 * x + 3.0 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * Math.sqrt(Math.abs(x));
             ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
             ret += (20.0 * Math.sin(y * PI) + 40.0 * Math.sin(y / 3.0 * PI)) * 2.0 / 3.0;
             ret += (160.0 * Math.sin(y / 12.0 * PI) + 320 * Math.sin(y * PI / 30.0)) * 2.0 / 3.0;
             return ret;
         }

         function transformLng(x, y) {
             let ret = 300.0 + x + 2.0 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * Math.sqrt(Math.abs(x));
             ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
             ret += (20.0 * Math.sin(x * PI) + 40.0 * Math.sin(x / 3.0 * PI)) * 2.0 / 3.0;
             ret += (150.0 * Math.sin(x / 12.0 * PI) + 300.0 * Math.sin(x / 30.0 * PI)) * 2.0 / 3.0;
             return ret;
         }
     }

     function gcj02ToWgs84(lng, lat) {
         const g = wgs84ToGcj02(lng, lat);
         return { lng: lng * 2 - g.lng, lat: lat * 2 - g.lat };
     }

     function bd09ToGcj02(bdLng, bdLat) {
         const x_PI = 3.14159265358979324 * 3000.0 / 180.0;
         const x = bdLng - 0.0065;
         const y = bdLat - 0.006;
         const z = Math.sqrt(x * x + y * y) - 0.00002 * Math.sin(y * x_PI);
         const theta = Math.atan2(y, x) - 0.000003 * Math.cos(x * x_PI);
         const ggLng = z * Math.cos(theta);
         const ggLat = z * Math.sin(theta);
         return { lng: ggLng, lat: ggLat };
     }

     function calculatePolygonBottomCenter(outerRing) {
         let minLat = Infinity;
         let bottomPoints = [];
         outerRing.forEach(point => {
             const lat = point[1];
             if (lat < minLat) {
                 minLat = lat;
                 bottomPoints = [point];
             } else if (lat === minLat) {
                 bottomPoints.push(point);
             }
         });

         const sumLng = bottomPoints.reduce((sum, point) => sum + point[0], 0);
         const centerLng = sumLng / bottomPoints.length;

         return { lng: centerLng, lat: minLat };
     }

     function fitBounds(geojson) {
         try {
             const allPoints = [];
             function collectPoints(coords) {
                 if (typeof coords[0] === 'number') {
                     allPoints.push(coords);
                 } else {
                     coords.forEach(coord => collectPoints(coord));
                 }
             }
             collectPoints(geojson.coordinates);

             if (allPoints.length === 0) return;

             const lats = allPoints.map(p => p[1]);
             const lngs = allPoints.map(p => p[0]);
             const minLng = Math.min(...lngs);
             const maxLng = Math.max(...lngs);
             const minLat = Math.min(...lats);
             const maxLat = Math.max(...lats);

             const sw = wgs84ToGcj02(minLng, minLat);
             const ne = wgs84ToGcj02(maxLng, maxLat);

             // 修复setViewport方法的使用，确保参数格式正确
             if (map && map.setViewport) {
                 map.setViewport([
                     new T.LngLat(sw.lng, sw.lat),
                     new T.LngLat(ne.lng, ne.lat)
                 ], { padding: [50, 50] });
             } else {
                 console.warn('地图对象或setViewport方法不可用');
             }
         } catch (error) {
             console.error('调整视图范围时出错:', error);
         }
     }
// 轨迹绘制与解析
    function bindTrackEvents() {
        const drawBtn = document.getElementById('drawTrackButton');
        const showPointsBtn = document.getElementById('showTrackPointsButton');
        const clearBtn = document.getElementById('clearTrackButton');
        const ta = document.getElementById('trackTextarea');
        if (!drawBtn || !showPointsBtn || !clearBtn || !ta) return;

        drawBtn.addEventListener('click', function(){
            try {
                const text = ta.value.trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const points = parseTrackText(text);
                if (points.length < 2) { alert('有效轨迹点不足，至少需要两点'); return; }
                drawTrackFromPoints(points);
                fitViewportToTrack(points);
            } catch (e) {
                alert('绘制轨迹失败：' + (e && e.message ? e.message : e));
                console.error('绘制轨迹异常:', e);
            }
        });

        showPointsBtn.addEventListener('click', function(){
            try {
                const text = ta.value.trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const points = parseTrackText(text);
                if (points.length === 0) { alert('未找到有效轨迹点'); return; }
                showTrackPoints(points);
                fitViewportToTrack(points);
            } catch (e) {
                alert('显示轨迹点失败：' + (e && e.message ? e.message : e));
                console.error('显示轨迹点异常:', e);
            }
        });

        clearBtn.addEventListener('click', function(){
            clearTrackOverlays();
            console.log('已清空轨迹');
        });
    }

    function showTrackPoints(points) {
        // 先移除旧轨迹（不影响轮廓）
        clearTrackOverlays(false);
        
        if (!map || !points || points.length === 0) {
            console.log('无轨迹点可显示');
            return;
        }
        
        console.log(`准备显示${points.length}个轨迹点`);
        
        // 使用批量处理和更小的图标来提高性能
        // 创建一个更小的红点SVG图标
        const smallRedDotIcon = new T.Icon({
            iconUrl: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1" height="1"><circle cx="0.5" cy="0.5" r="0.3" fill="%23FF0000"/></svg>',
            iconSize: new T.Point(1, 1),
            iconAnchor: new T.Point(0.5, 0.5)
        });
        
        // 优化批量添加点的速度
        const batchSize = 2000; // 增加每批处理的点数
        const concurrentBatches = 4; // 并发批次数量
        
        // 预创建点击事件处理函数，避免重复创建
        function createClickHandler(point, index) {
            return function() {
                const infoWindow = new T.InfoWindow({
                    content: `点${index + 1}<br/>经度: ${point.lng.toFixed(6)}<br/>纬度: ${point.lat.toFixed(6)}`,
                    offset: new T.Point(0, -20)
                });
                infoWindow.open(map, point);
            };
        }
        
        // 使用setTimeout实现更高效的批量添加，避免阻塞UI
        let currentIndex = 0;
        
        function addBatch() {
            if (currentIndex >= points.length) {
                console.log(`已显示${points.length}个轨迹点`);
                return;
            }
            
            // 添加当前批次的点
            const endIndex = Math.min(currentIndex + batchSize, points.length);
            const markersToAdd = [];
            
            // 先创建所有标记
            for (let i = currentIndex; i < endIndex; i++) {
                const point = points[i];
                const index = i;
                
                const marker = new T.Marker(point, {
                    icon: smallRedDotIcon
                });
                
                // 添加点击事件
                marker.addEventListener('click', createClickHandler(point, index));
                
                markersToAdd.push(marker);
            }
            
            // 批量添加到地图和数组
            markersToAdd.forEach(marker => {
                map.addOverLay(marker);
                currentTracks.push(marker);
            });
            
            currentIndex = endIndex;
            
            // 使用setTimeout而不是requestAnimationFrame，减少对渲染周期的依赖
            // 设置为0，将任务放入微任务队列，但允许UI有短暂的呼吸空间
            setTimeout(addBatch, 0);
        }
        
        // 启动批量添加
        addBatch();
    }
    
    // 恢复原始的clearTrackOverlays函数
    function clearTrackOverlays(resetArray = true){        
        try {
            currentTracks.forEach(pl => {
                if (pl && map && map.removeOverLay) {
                    try { map.removeOverLay(pl); } catch (e) { console.warn('移除轨迹失败:', e); }
                }
            });
            if (resetArray) currentTracks = [];
        } catch (e) {
            console.warn('清空轨迹时出错:', e);
        }
    }

    function parseTrackText(text){
        // 选择输入坐标系（优先使用轨迹页签专属选择器，若未设置则回退到绘制页签选择器）
        const coordSysEl = document.getElementById('trackCoordSysSelect') || document.getElementById('coordSysSelect');
        const coordSys = (coordSysEl && coordSysEl.value) || 'wgs84';
        const isHash = text.indexOf('#') !== -1;
        const items = isHash ? text.split('#') : text.split(/\r?\n/);
        const pts = [];
        for (let i=0;i<items.length;i++){
            const raw = items[i];
            if (!raw) continue;
            const line = raw.trim();
            if (!line) continue;
            const parts = line.split(',');
            if (parts.length < 3) continue;
            let lng = parseFloat((parts[isHash ? 0 : 1] || '').trim());
            let lat = parseFloat((parts[isHash ? 1 : 2] || '').trim());
            // 初步过滤：数值合法性与正常范围
            if (!isFinite(lng) || !isFinite(lat)) continue;
            if (lng === 0 || lat === 0) continue; // 丢弃0.0异常点
            if (lng < -180 || lng > 180 || lat < -90 || lat > 90) continue; // 超出经纬度范围丢弃

            // 将输入坐标转换为WGS84
            let w;
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                w = { lng, lat };
            } else if (coordSys === 'gcj02') {
                w = gcj02ToWgs84(lng, lat);
            } else if (coordSys === 'bd09') {
                const g = bd09ToGcj02(lng, lat);
                w = gcj02ToWgs84(g.lng, g.lat);
            } else {
                w = { lng, lat };
            }
            // 转换结果兜底检查
            if (!isFinite(w.lng) || !isFinite(w.lat)) continue;
            if (w.lng < -180 || w.lng > 180 || w.lat < -90 || w.lat > 90) continue;

            // 使用WGS84坐标绘制到地图
            pts.push(new T.LngLat(w.lng, w.lat));
        }
        return pts;
    }

    function drawTrackFromPoints(points){
        // 先移除旧轨迹（不影响轮廓）
        clearTrackOverlays(false);
        const polyline = new T.Polyline(points, {
            color: '#FF3B30',
            weight: 1,
            opacity: 0.9
        });
        if (map) {
            map.addOverLay(polyline);
        }
        currentTracks.push(polyline);
    }

    function clearTrackOverlays(resetArray = true){
        try {
            currentTracks.forEach(pl => {
                if (pl && map && map.removeOverLay) {
                    try { map.removeOverLay(pl); } catch (e) { console.warn('移除轨迹失败:', e); }
                }
            });
            if (resetArray) currentTracks = [];
        } catch (e) {
            console.warn('清空轨迹时出错:', e);
        }
    }


    function fitViewportToTrack(points){
        try {
            if (!map || !map.setViewport || !points || !points.length) return;
            map.setViewport(points);
        } catch (e) {
            console.warn('轨迹视图居中失败:', e);
        }
    }

    // ========= 轨迹回放功能 =========
    let playbackState = { points: [], idx: 0, speed: 1, timer: null, running: false, marker: null, line: null, path: [] };

    function bindPlaybackControls(){
        const startBtn = document.getElementById('playbackStartBtn');
        const pauseBtn = document.getElementById('playbackPauseBtn');
        const stopBtn = document.getElementById('playbackStopBtn');
        const speedSel = document.getElementById('playbackSpeedSelect');
        const timeSlider = document.getElementById('playbackTimeSlider');
        const timeCursor = document.getElementById('playbackTimeCursor');
        const ta = document.getElementById('trackTextarea');
        if (!startBtn || !pauseBtn || !stopBtn || !speedSel) return;

        // 初始按钮状态
        updatePlaybackButtonsState('idle');

        startBtn.addEventListener('click', function(){
            try {
                const text = (ta && ta.value || '').trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const pts = parseTrackTextWithTime(text);
                if (pts.length < 2) { alert('有效轨迹点不足，至少需要两点'); return; }
                startPlayback(pts);
                // 状态在startPlayback中已设置为playing
            } catch (e) {
                alert('开始回放失败：' + (e && e.message ? e.message : e));
                console.error('开始回放异常:', e);
            }
        });

        pauseBtn.addEventListener('click', function(){
            if (!playbackState.running) {
                // 继续
                playbackState.running = true;
                scheduleNext();
                updatePlaybackButtonsState('playing');
            } else {
                // 暂停
                if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
                playbackState.running = false;
                updatePlaybackButtonsState('paused');
            }
        });

        stopBtn.addEventListener('click', function(){ 
            stopPlayback(); 
            updatePlaybackButtonsState('idle');
        });

        speedSel.addEventListener('change', function(){
            const v = parseFloat(speedSel.value);
            playbackState.speed = (isFinite(v) && v > 0) ? v : 1;
        });

        if (timeSlider) {
            timeSlider.addEventListener('input', function(){
                const ms = parseInt(timeSlider.value, 10);
                const txt = formatTimeForLabel(ms);
                if (timeCursor) timeCursor.textContent = txt;
            });
            timeSlider.addEventListener('change', function(){
                jumpToSliderTime();
            });
        }
    }

    function parseTrackTextWithTime(text){
        const coordSysEl = document.getElementById('trackCoordSysSelect') || document.getElementById('coordSysSelect');
        const coordSys = (coordSysEl && coordSysEl.value) || 'wgs84';
        const isHash = text.indexOf('#') !== -1;
        const items = isHash ? text.split('#') : text.split(/\r?\n/);
        const out = [];
        for (let i=0;i<items.length;i++){
            const raw = items[i];
            if (!raw) continue;
            const line = raw.trim();
            if (!line) continue;
            const parts = line.split(',');
            if (parts.length < 3) continue;
            const tsRaw = (parts[isHash ? 2 : 0] || '').trim();
            const ts = (tsRaw || '').replace(/\D/g,'');
            let lng = parseFloat((parts[isHash ? 0 : 1] || '').trim());
            let lat = parseFloat((parts[isHash ? 1 : 2] || '').trim());
            if (!isFinite(lng) || !isFinite(lat)) continue;
            if (lng === 0 || lat === 0) continue;
            if (lng < -180 || lng > 180 || lat < -90 || lat > 90) continue;
            const t = parseTimestamp(ts);
            if (!t) continue;
            let w;
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                w = { lng, lat };
            } else if (coordSys === 'gcj02') {
                w = gcj02ToWgs84(lng, lat);
            } else if (coordSys === 'bd09') {
                const g = bd09ToGcj02(lng, lat);
                w = gcj02ToWgs84(g.lng, g.lat);
            } else { w = { lng, lat }; }
            if (!isFinite(w.lng) || !isFinite(w.lat)) continue;
            if (w.lng < -180 || w.lng > 180 || w.lat < -90 || w.lat > 90) continue;
            out.push({ ll: new T.LngLat(w.lng, w.lat), time: t, ts });
        }
        out.sort((a,b)=>a.time - b.time);
        return out;
    }

    function parseTimestamp(ts){
        const tstr = (ts || '').replace(/\D/g,'');
        const m = tstr && tstr.match(/^\d{14}$/);
        if (!m) return null;
        const y = parseInt(tstr.slice(0,4),10);
        const M = parseInt(tstr.slice(4,6),10) - 1;
        const d = parseInt(tstr.slice(6,8),10);
        const h = parseInt(tstr.slice(8,10),10);
        const m2 = parseInt(tstr.slice(10,12),10);
        const s = parseInt(tstr.slice(12,14),10);
        const dt = new Date(y,M,d,h,m2,s);
        return isNaN(dt.getTime()) ? null : dt;
    }

    function startPlayback(points){
        console.log('[Playback] startPlayback: 点数=', points && points.length);
        stopPlayback();
        playbackState.points = points;
        playbackState.idx = 0;
        playbackState.speed = playbackState.speed || 1;
        playbackState.running = true;
        // 配置时间滑动条，并尊重现有滑块位置作为起始
        configureTimeSlider(points);
        // 启用滑块
        const slider = document.getElementById('playbackTimeSlider');
        if (slider) slider.disabled = false;
        let initIdx = 0;
        if (slider && slider.min && slider.max) {
            const ms = parseInt(slider.value, 10);
            if (isFinite(ms)) initIdx = findIndexByTime(points, ms);
        }
        playbackState.idx = initIdx;
        const first = points[initIdx];
        console.log('[Playback] 首点:', first && first.ts, first && first.ll, 'initIdx=', initIdx);
        playbackState.path = points.slice(0, initIdx+1).map(p=>p.ll);
        playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 1, opacity: 0.9 });
        if (map) {
            map.addOverLay(playbackState.line);
        }
        currentTracks.push(playbackState.line);
        // 创建并定位DOM标记以保证可见移动
        ensurePlaybackDom(first.ll);
        updatePlaybackDom(first.ll);
        updatePlaybackTimeLabel(first.ts);
        try { fitViewportToTrack(points.map(p=>p.ll)); } catch(e){}
        // 更新按钮状态
        updatePlaybackButtonsState('playing');
        scheduleNext();
    }

    function scheduleNext(){
        if (!playbackState.running) return;
        if (!playbackState.points || playbackState.idx >= playbackState.points.length - 1) {
            playbackState.running = false;
            console.log('[Playback] 回放结束：idx=', playbackState.idx, '点数=', playbackState.points ? playbackState.points.length : 0);
            updatePlaybackButtonsState('idle'); // 播放结束后按钮回到初始状态：开始可点，继续/结束灰化
            return;
        }
        const next = playbackState.points[playbackState.idx+1];
        const speed = playbackState.speed || 1;
        const delay = Math.max(4, Math.round(1000 / speed)); // 1x=1000ms/点，2x=500ms/点...
        console.log('[Playback] scheduleNext: idx=', playbackState.idx, '->', playbackState.idx+1, 'delay=', delay, 'speed=', speed);
        playbackState.timer = setTimeout(()=>{
            playbackState.idx++;
            const nextLL = next.ll;
            console.log('[Playback] 下一点:', next && next.ts, nextLL);
            try {
                // 维护路径数组
                playbackState.path = playbackState.path || [];
                playbackState.path.push(nextLL);
                console.log('[Playback] 路径长度=', playbackState.path.length);
                // 使用DOM标记进行移动（容器/图层坐标）
                if (!playbackDom.el) console.log('[Playback] DOM标记不存在，将尝试创建');
                updatePlaybackDom(nextLL);
                // 折线更新：优先setLngLats，兜底重建
                if (playbackState.line && typeof playbackState.line.setLngLats === 'function') {
                    try { playbackState.line.setLngLats(playbackState.path); }
                    catch(e){
                        console.warn('[Playback] setLngLats失败，重建折线', e);
                        if (map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                        playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 1, opacity: 0.9 });
                        if (map) map.addOverLay(playbackState.line);
                    }
                } else {
                    console.log('[Playback] 折线不支持setLngLats，重建');
                    if (playbackState.line && map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                    playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 1, opacity: 0.9 });
                    if (map) map.addOverLay(playbackState.line);
                }
            } catch(e) { console.warn('更新回放覆盖物失败:', e); }
            updatePlaybackTimeLabel(next.ts);
            scheduleNext();
        }, delay);
    }

    function stopPlayback(){
        if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
        playbackState.running = false;
        playbackState.idx = 0;
        try {
            // 移除DOM标记
            removePlaybackDom();
            if (playbackState.marker && map) map.removeOverLay(playbackState.marker);
            if (playbackState.line && map) map.removeOverLay(playbackState.line);
        } catch(e){}
        playbackState.marker = null;
        playbackState.line = null;
        updatePlaybackTimeLabel('—');
        // 按钮回到初始状态
        updatePlaybackButtonsState('idle');
    }

    function updatePlaybackTimeLabel(text){
        const el = document.getElementById('playbackTimeLabel');
        if (el) el.textContent = '时间：' + (text || '—');
    }

    // 时间滑动条：配置与跳转
    function configureTimeSlider(points){
        try {
            const slider = document.getElementById('playbackTimeSlider');
            const cursor = document.getElementById('playbackTimeCursor');
            if (!slider || !points || !points.length) return;
            const minMs = points[0].time.getTime();
            const maxMs = points[points.length - 1].time.getTime();
            const prev = parseInt(slider.value, 10);
            slider.min = String(minMs);
            slider.max = String(maxMs);
            slider.step = '1000'; // 以秒为步进
            let val = (isFinite(prev) && prev >= minMs && prev <= maxMs) ? prev : minMs;
            slider.value = String(val);
            if (cursor) cursor.textContent = formatTimeForLabel(val);
        } catch(e) { console.warn('配置时间滑动条失败:', e); }
    }
    function formatTimeForLabel(ms){
        if (!isFinite(ms)) return '—';
        const d = new Date(ms);
        const pad = n => String(n).padStart(2,'0');
        const y = d.getFullYear();
        const M = pad(d.getMonth()+1);
        const da = pad(d.getDate());
        const h = pad(d.getHours());
        const m = pad(d.getMinutes());
        const s = pad(d.getSeconds());
        return `${y}-${M}-${da} ${h}:${m}:${s}`;
    }
    function findIndexByTime(points, ms){
        try {
            if (!points || !points.length) return 0;
            const n = points.length;
            const minMs = points[0].time.getTime();
            const maxMs = points[n-1].time.getTime();
            if (!isFinite(ms)) return 0;
            if (ms <= minMs) return 0;
            if (ms >= maxMs) return n-1;
            let lo = 0, hi = n - 1, ans = 0;
            while (lo <= hi) {
                const mid = (lo + hi) >> 1;
                const t = points[mid].time.getTime();
                if (t < ms) { lo = mid + 1; ans = lo; }
                else { hi = mid - 1; ans = mid; }
            }
            return Math.max(0, Math.min(n-1, ans));
        } catch(e){ console.warn('findIndexByTime失败:', e); return 0; }
    }
    function jumpToSliderTime(){
        try {
            const slider = document.getElementById('playbackTimeSlider');
            if (!slider || !playbackState.points || !playbackState.points.length) return;
            const ms = parseInt(slider.value, 10);
            if (!isFinite(ms)) return;
            const idx = findIndexByTime(playbackState.points, ms);
            playbackState.idx = idx;
            const pts = playbackState.points;
            const ll = pts[idx].ll;
            playbackState.path = pts.slice(0, idx+1).map(p=>p.ll);
            // 更新折线
            try {
                if (playbackState.line && typeof playbackState.line.setLngLats === 'function') {
                    playbackState.line.setLngLats(playbackState.path);
                } else {
                    if (playbackState.line && map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                    playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 1, opacity: 0.9 });
                    if (map) map.addOverLay(playbackState.line);
                }
            } catch(e){ console.warn('滑块更新折线失败:', e); }
            // 更新标记与时间
            ensurePlaybackDom(ll);
            updatePlaybackDom(ll);
            updatePlaybackTimeLabel(pts[idx].ts);
            // 若正在播放，立即按新位置继续
            if (playbackState.running) {
                if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
                scheduleNext();
            }
        } catch(e) { console.warn('滑块跳转失败:', e); }
    }

    // DOM标记：使用容器坐标实现可见移动
    let playbackDom = { el: null, lastLL: null, bound: false };

    function ensurePlaybackDom(ll){
        try {
            playbackDom.lastLL = ll;
            const pane = (map && map.getPanes && map.getPanes().overlayPane) || document.getElementById('mapContainer');
            if (!pane) { console.warn('未找到overlayPane或mapContainer'); return; }
            if (!playbackDom.el) {
                const el = document.createElement('div');
                el.id = 'playbackDomMarker';
                el.style.position = 'absolute';
                el.style.width = '0';
                el.style.height = '0';
                el.style.borderLeft = '3px solid transparent';
                el.style.borderRight = '3px solid transparent';
                el.style.borderBottom = '4px solid #2C64A7';
                el.style.borderTop = '0';
                el.style.transform = 'translate(-50%, -50%)';
                el.style.zIndex = '9999';
                // 添加伪元素来增强箭头效果
                el.style.clipPath = 'polygon(50% 0, 100% 100%, 0 100%)';
                pane.appendChild(el);
                playbackDom.el = el;
                console.log('[Playback] 创建DOM标记，父节点=', pane === document.getElementById('mapContainer') ? '#mapContainer' : 'overlayPane');
                bindPlaybackDomEvents();
            }
            updatePlaybackDom(ll);
        } catch(e) { console.warn('创建DOM标记失败:', e); }
    }

    function updatePlaybackDom(ll){
        try {
            playbackDom.lastLL = ll;
            if (!map || !playbackDom.el || !ll) { console.log('[Playback] update取消：map/el/ll缺失'); return; }
            let p;
            if (typeof map.lngLatToLayerPoint === 'function') {
                p = map.lngLatToLayerPoint(ll);
                console.log('[Playback] 使用layerPoint定位:', ll && ll.lng, ll && ll.lat, '=>', p && p.x, p && p.y);
            } else if (typeof map.lngLatToContainerPoint === 'function') {
                p = map.lngLatToContainerPoint(ll);
                console.log('[Playback] 使用containerPoint定位:', ll && ll.lng, ll && ll.lat, '=>', p && p.x, p && p.y);
            } else {
                console.warn('地图对象不支持lngLat到像素坐标转换');
                return;
            }
            playbackDom.el.style.left = p.x + 'px';
            playbackDom.el.style.top = p.y + 'px';
        } catch(e) { console.warn('更新DOM标记位置失败:', e); }
    }

    function bindPlaybackDomEvents(){
        if (playbackDom.bound) return;
        const updater = function(){
            try {
                if (!map || !playbackDom.el || !playbackDom.lastLL) return;
                let p;
                if (typeof map.lngLatToLayerPoint === 'function') {
                    p = map.lngLatToLayerPoint(playbackDom.lastLL);
                } else if (typeof map.lngLatToContainerPoint === 'function') {
                    p = map.lngLatToContainerPoint(playbackDom.lastLL);
                }
                if (!p) return;
                playbackDom.el.style.left = p.x + 'px';
                playbackDom.el.style.top = p.y + 'px';
            } catch(e){}
        };
        try {
            map.addEventListener('move', updater);
            map.addEventListener('zoom', updater);
            playbackDom.bound = true;
        } catch(e){}
    }

    function removePlaybackDom(){
        try {
            const el = playbackDom.el;
            playbackDom.lastLL = null;
            if (el && el.parentNode) el.parentNode.removeChild(el);
        } catch(e){}
        playbackDom.el = null;
        playbackDom.bound = false;
    }

</script>
</body>

</html>
