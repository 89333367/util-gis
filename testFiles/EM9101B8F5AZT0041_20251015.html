<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>展示轮廓</title>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #mapContainer {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        #mapLoading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
            transition: opacity 0.3s;
        }

        .loading-text {
            font-size: 16px;
            color: #333;
            padding: 10px 20px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .wkt-input-container {
            position: absolute;
            top: 20px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            width: min(320px, 90vw);
            box-sizing: border-box;
            transition: all 0.3s;
        }

        .minimize-btn {
            position: absolute;
            top: -5px;
            right: -4px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #f0f0f0;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #666;
            z-index: 1001;
            transition: background 0.2s;
        }

        .minimize-btn:hover {
            background: #e0e0e0;
        }

        .content-wrapper {
            transition: all 0.3s;
        }

        .wkt-input-container.minimized {
            width: 40px;
            height: 40px;
            padding: 0;
        }

        .wkt-input-container.minimized .content-wrapper {
            display: none;
        }

        .wkt-input-container.minimized .min-icon {
            display: none;
        }

        .wkt-input-container.minimized .restore-icon {
            display: inline;
        }

        #wktTextarea {
            width: 100%;
            height: 120px;
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
            box-sizing: border-box;
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        /* 页签样式 */
        .tabs-header {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .tab-btn {
            flex: 1;
            padding: 6px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            background: #f5f5f5;
            color: #333;
            transition: background 0.2s;
        }
        .tab-btn.active { background: #337AFF; color: #fff; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        /* Multi → Polygons 分割器样式 */
        .split-section {
            margin-top: 10px;
            padding: 10px;
            background: #fafafa;
            border: 1px solid #eee;
            border-radius: 6px;
        }
        .split-section .title {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
        }
        .split-section .desc {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        #multiInput, #polyOutput {
            width: 100%;
            height: 90px;
            margin-bottom: 8px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
            box-sizing: border-box;
        }
        .split-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .split-actions button {
            flex: 1;
            padding: 6px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }
        #splitMultiBtn { background: #337AFF; color: #fff; }
        #splitMultiBtn:hover { background: #2860E0; }
        #copyPolysBtn { background: #f5f5f5; color: #333; }
        #copyPolysBtn:hover { background: #e0e0e0; }
        #drawButton,
        #clearButton,
        #drawTrackButton,
        #clearTrackButton {
            width: 50%;
            padding: 8px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        #drawButton,
        #drawTrackButton {
            background: #337AFF;
            color: white;
        }

        #drawButton:hover,
        #drawTrackButton:hover {
            background: #2860E0;
        }

        #clearButton,
        #clearTrackButton {
            background: #f5f5f5;
            color: #333;
        }

        #clearButton:hover,
        #clearTrackButton:hover {
            background: #e0e0e0;
        }

        #drawButton:disabled,
        #clearButton:disabled,
        #drawTrackButton:disabled,
        #clearTrackButton:disabled {
            background: #e0e0e0;
            color: #999;
            cursor: not-allowed;
        }

        .tip {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .area-label {
             position: absolute;
             background: rgba(255, 0, 0, 0.85);
             border: 1px solid #000;
             border-radius: 3px;
             padding: 4px 6px;
             font-size: 12px;
             color: #fff;
             font-weight: 600;
             box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
             white-space: nowrap;
             z-index: 9999;
             pointer-events: none;
         }
         /* 默认隐藏标签容器下的标签 */
          .labels-hidden .area-label { display: none; }

          /* Batch → Generator 样式 */
          .batch-section { margin-top: 10px; padding: 10px; background: #fafafa; border: 1px solid #eee; border-radius: 6px; }
          .batch-section .title { font-size: 13px; font-weight: 600; color: #333; margin-bottom: 6px; }
          .batch-section .desc { font-size: 12px; color: #666; margin-bottom: 8px; }
          #batchInput, #multiOutput { width: 100%; height: 90px; margin-bottom: 8px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; resize: vertical; box-sizing: border-box; }
          .batch-actions { display: flex; gap: 8px; margin-bottom: 8px; }
          .batch-actions button { flex: 1; padding: 6px 0; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; transition: background 0.2s; }
          #generateMultiBtn { background: #337AFF; color: #fff; }
          #generateMultiBtn:hover { background: #2860E0; }
          #copyMultiBtn { background: #f5f5f5; color: #333; }
          #copyMultiBtn:hover { background: #e0e0e0; }
      </style>
    <script src="https://api.tianditu.gov.cn/api?v=4.0&tk=648f621977051d0199ff0f965d3fd322"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
    <script src="https://lib.baomitu.com/terraformer/1.0.12/terraformer.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://unpkg.com/terraformer-wkt-parser@1.2.1/terraformer-wkt-parser.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- 已移除动态备用加载器 ensureTerraformer：改为仅使用静态脚本标签加载 Terraformer 核心库与 WKT 解析器 -->
    <script>
        // 检查Turf.js是否加载成功
        window.addEventListener('load', function () {
            if (typeof turf === 'undefined') {
                console.warn('Turf.js加载失败，已启用备用面积算法');
            } else {
                console.log('Turf.js加载成功');
            }
        });
    </script>
</head>

<body>
<div id="mapContainer">
    <div id="mapLoading">
        <div class="loading-text">地图正在加载中...</div>
    </div>
</div>

<div class="wkt-input-container">
    <div class="minimize-btn" id="minimizeBtn">
        <span class="min-icon">−</span>
        <span class="restore-icon" style="display:none;">+</span>
    </div>

    <div class="content-wrapper">
        <div class="tabs-header">
            <button class="tab-btn active" id="tabDrawBtn">轮廓</button>
            <button class="tab-btn" id="tabTrackBtn">轨迹</button>
            <button class="tab-btn" id="tabSplitBtn">分割器</button>
            <button class="tab-btn" id="tabBatchBtn">合并器</button>
        </div>
        <div class="tab-pane active" id="tabDraw">
            <div class="tip">请输入WKT字符串（支持POLYGON/MULTIPOLYGON）：</div>
            <textarea id="wktTextarea">POLYGON ((124.48584607029872 45.33104874978053, 124.48587638439803 45.331083850303, 124.48587810051967 45.33108548404455, 124.48590476937927 45.33110658021621, 124.4858918387866 45.33109646821241, 124.48588952887143 45.33109498422974, 124.48588685298645 45.33109384651065, 124.48588391390282 45.33109309875084, 124.48588082450014 45.33109276966911, 124.48587770343146 45.3310928719043, 124.48587467056585 45.33109340152992, 124.48587184238464 45.33109433820495, 124.4858693275083 45.33109564595505, 124.48586722252429 45.33109727455424, 124.48586560827749 45.331099161453814, 124.48586454676537 45.33110123418472, 124.48586407875705 45.33110341314073, 124.48586414266605 45.3311043938028, 124.48586348582482 45.33110420893139, 124.4858605332019 45.33110380674197, 124.48585752603108 45.33110380278415, 124.48585548659707 45.33110407501971, 124.48585433152466 45.33110283277089, 124.48585244335993 45.33110117004543, 124.48585014451159 45.33109978832445, 124.48584751748152 45.3310987371957, 124.48584465654962 45.33109805438248, 124.48584166439007 45.33109776438985, 124.48583864838665 45.33109787762517, 124.48583571677896 45.33109839002461, 124.48583297477744 45.33109928319899, 124.48583052078827 45.33110052509372, 124.48582844288107 45.331102071139206, 124.4858268156286 45.3311038658504, 124.48582569743047 45.331105844817976, 124.485825128417 45.33110793701999, 124.48582283781555 45.33112495289061, 124.4858219752799 45.33112623867566, 124.48582121134736 45.33112843913421, 124.48582108820321 45.331130702941095, 124.48582161084524 45.33113293821886, 124.48582173262734 45.331133162844644, 124.48581812840254 45.33115993701923, 124.48581813583984 45.33116211685179, 124.48581873937543 45.33116425471851, 124.48581991633132 45.33116627028869, 124.48582162248329 45.33116808782697, 124.4858237937225 45.33116963903907, 124.48582634846426 45.33117086563794, 124.48582919071367 45.331171721533934, 124.48583221367299 45.33117217456663, 124.48583530375384 45.33117220771322, 124.48583834484589 45.33117181972824, 124.48584122267975 45.331171025190265, 124.48584161022049 45.33117085104407, 124.48584305981763 45.33122521147867, 124.4858434437107 45.33122746177565, 124.48584445955109 45.33122961206729, 124.48584606607213 45.331231575001695, 124.48584819801178 45.33123327083803, 124.4858507687636 45.331234630685884, 124.48585367389529 45.33123559930379, 124.48586496747757 45.33123842269968, 124.48586636602606 45.331239795350854, 124.48586582242172 45.33123978533831, 124.4858626860481 45.33124017412072, 124.48585972178232 45.33124099480837, 124.4858570478856 45.33124221465941, 124.48585477103454 45.33124378500717, 124.48585298206581 45.331245643201584, 124.48585175235127 45.33124771510889, 124.48585113095137 45.331249918069005, 124.48585114265738 45.33125216419346, 124.48585178700212 45.33125436387167, 124.48585423526846 45.33125987247445, 124.48584489338467 45.33127940549203, 124.48584418485596 45.33128157858029, 124.4858440981441 45.33128380755566, 124.48584463665844 45.331286004779706, 124.48584577922584 45.331288083862404, 124.48584748092316 45.33128996305873, 124.4858496748433 45.33129156848279, 124.48585227472623 45.331292837012796, 124.48585508786614 45.3312936912951, 124.48585094976426 45.331315623205874, 124.48584738615658 45.33131829591062, 124.48584542447583 45.33132010347353, 124.4858440190713 45.33132215265498, 124.48584322753162 45.33132435948685, 124.4858430822912 45.331326633541096, 124.48584606350013 45.331363898812114, 124.48584478004898 45.33136477739069, 124.48584294535543 45.331366691234706, 124.48584170387144 45.331368829147785, 124.48583170386549 45.33139282914653, 124.48583111438559 45.33139504632229, 124.48583116415001 45.331397301874475, 124.48583185115628 45.33139950503863, 124.48583314775897 45.331401567158466, 124.48583500178229 45.33140340525328, 124.48583733861959 45.33140494535731, 124.48583794415707 45.331405207543284, 124.48584319142493 45.33141162087203, 124.48584492146027 45.33141334000428, 124.48584707600573 45.33141480116619, 124.48584957933792 45.33141595300404, 124.48585180681096 45.33141659931906, 124.48585261916494 45.3314474690914, 124.4858521748155 45.33144763462313, 124.48584969703992 45.33144906918621, 124.4858476762134 45.33145082437141, 124.4858461940328 45.331452829221156, 124.4858453104188 45.33145500268461, 124.48584506109373 45.33145725689435, 124.48584545613718 45.331459500718516, 124.48584647957868 45.331461643445145, 124.48584809004316 45.33146359844934, 124.48585022242376 45.33146528669539, 124.48585296750406 45.331467062924496, 124.48585254889687 45.3314819233387, 124.485843274141 45.331497690411304, 124.48584236357858 45.33149980501467, 124.48584205692161 45.33150200439216, 124.48584236601415 45.331504203600026, 124.48584327891825 45.331506317701034, 124.48584476037631 45.33150826504495, 124.48584675317171 45.33150997042193, 124.48584918033924 45.33151136796736, 124.48585169297618 45.3315123082216, 124.48585106005733 45.33153477660895, 124.48585306032176 45.33160323323816, 124.48585314197408 45.331604160221524, 124.48586314195535 45.331672160223135, 124.48586375296257 45.33167428656229, 124.48586493149699 45.33167629056863, 124.485866633691 45.33167809764878, 124.48586879618546 45.33167964053937, 124.4858713384877 45.33168086181071, 124.48587416596783 45.33168171600449, 124.48587717338098 45.33168217132578, 124.48588024878485 45.331682210826564, 124.48588327770632 45.33168183303651, 124.4858861474024 45.331681052017814, 124.48588875105693 45.33167989684163, 124.48589099175635 45.331678410506086, 124.48589278609707 45.331676648335765, 124.48589406728995 45.331674675922415, 124.48589478764629 45.331672566683444, 124.48589492035305 45.331670399129194, 124.48588395616183 45.33152587168856, 124.48588453696415 45.33151251315701, 124.48592648966606 45.33154997092262, 124.48592702291057 45.33155042227439, 124.48599822918118 45.331607584678444, 124.4862131602706 45.331773531498804, 124.48665109232411 45.33212047772412, 124.48691517002965 45.332322539695596, 124.48719006487731 45.33254145599091, 124.48726629147356 45.33259963264611, 124.48726751839561 45.332600473594546, 124.48728051839606 45.33260847359572, 124.48728308405623 45.332609761372616, 124.48728595851927 45.332610668356125, 124.48728902965166 45.33261115916462, 124.48729217764793 45.332611214651536, 124.48729527970387 45.33261083265231, 124.4872982148076 45.33261002806883, 124.48730086845998 45.332608832288095, 124.48730313714134 45.33260729195782, 124.48730493235014 45.332605467166594, 124.4873061840547 45.332603429100004, 124.48730684342584 45.33260125726345, 124.48730688474163 45.33259903638078, 124.48730630639005 45.33259685308912, 124.4873051309331 45.332594792559114, 124.48728801525374 45.33257168641425, 124.48730893850579 45.33258069135143, 124.4873562220982 45.33261128661857, 124.48735868159049 45.332612593429644, 124.48736022420117 45.33261325887019, 124.48732540495018 45.332639281645264, 124.48732351302964 45.33264100288213, 124.4873221269953 45.33264294906642, 124.48732129883628 45.33264504719824, 124.48731829883305 45.332657047197884, 124.48731806072911 45.332659255886, 124.48731844105914 45.332661454645915, 124.48731942506679 45.33266355816705, 124.48732097457298 45.332665484834074, 124.4873230294581 45.332667159893454, 124.48732550999368 45.33266851835389, 124.48732831993662 45.33266950750791, 124.48733135026262 45.33267008897693, 124.48733448339698 45.332670240200315, 124.48733759777572 45.33266995531065, 124.48734057256301 45.3326692453615, 124.48738644438069 45.33265460541937, 124.48742625090672 45.332646838291915, 124.48742891679433 45.33264613199528, 124.48753491680844 45.33261013198873, 124.48753761649823 45.332608969488284, 124.48753993769073 45.332607453956314, 124.48766293768566 45.332509453943636, 124.48766473816836 45.332507706369185, 124.4876660316637 45.33250574820944, 124.48766677043731 45.33250365172747, 124.48766815494389 45.33249707532215, 124.48772573904486 45.33244868019, 124.48780406995945 45.332401327517104, 124.48800025755854 45.33232684890993, 124.48801786754956 45.33232533947548, 124.48819379681426 45.33239165834659, 124.4883945269086 45.33248617689898, 124.48843482398335 45.33257444672674, 124.48843606892908 45.33257646877093, 124.48843784923825 45.33257828065331, 124.4884400964946 45.3325798127442, 124.4884427243373 45.3325810061662, 124.48844563177975 45.33258181505676, 124.48844870709067 45.33258220833062, 124.48845183208735 45.33258217087452, 124.488454886678 45.33258170412785, 124.4884577534762 45.332580826027446, 124.48846032231265 45.332579570318224, 124.48846249446827 45.332577985256414, 124.48846418646819 45.332576131755076, 124.48846533329012 45.33257408104324, 124.4884658908622 45.33257191192865, 124.48846583775733 45.33256970776916, 124.48846517601653 45.33256755326937, 124.48842317599475 45.33247555327518, 124.48842171505277 45.332473266044765, 124.48841957157568 45.33247126416704, 124.48841685223442 45.33246964726622, 124.48821085225404 45.3323726472818, 124.48820951489918 45.33237208219347, 124.48806563276443 45.33231784395112, 124.48806722810822 45.33231607399119, 124.48806835814634 45.33231401865042, 124.48806889797952 45.332311847304595, 124.48806882686227 45.33230964339733, 124.48806814752758 45.33230749162357, 124.48806688608211 45.33230547467472, 124.48806509100245 45.332303670060995, 124.48806283127259 45.33230214713268, 124.4880601937326 45.332300964415, 124.48805727974174 45.332300167359136, 124.48805420128285 45.33229978659546, 124.48805107665943 45.33229983675652, 124.48802401674091 45.33230215619605, 124.48801851492368 45.33230008220563, 124.48801561868376 45.33229923683909, 124.48801254392644 45.33229880748092, 124.48800940949481 45.33229881072624, 124.48800633653799 45.332299246449644, 124.48800344382919 45.332300097809934, 124.48799044085447 45.33230503414228, 124.48787607669321 45.332314836753184, 124.48787300147372 45.33231532159817, 124.4878000014858 45.33233232159483, 124.48779818778154 45.332332832829366, 124.48773818778966 45.332352832825734, 124.48773635144985 45.33235355294272, 124.48766254923375 45.332387165846704, 124.48766206198296 45.33238687349617, 124.48751883783748 45.3322774661783, 124.4874684566147 45.332237179535035, 124.48740978191547 45.33219441662494, 124.48735975606355 45.33215340385911, 124.48714685852269 45.331989482773324, 124.48704171168552 45.33190536986862, 124.48682200214837 45.33173759170293, 124.48677482518963 45.331697457499374, 124.48662475245023 45.33158040116577, 124.48629086294748 45.331323486228975, 124.486184674505 45.33123834167378, 124.48600677004025 45.33110341415075, 124.48588086374872 45.33100448779428, 124.48587856691474 45.33100300430453, 124.485875905028 45.33100186407111, 124.48587297966039 45.33100111060294, 124.48586990243751 45.33100077265071, 124.48586679077968 45.33100086310992, 124.48586376342091 45.331001378528896, 124.48586093587869 45.33100229924034, 124.48586079455481 45.3310023716384, 124.48584650616017 45.33099354172052, 124.48584391320156 45.33099223760218, 124.48584100450135 45.330991323009535, 124.48583789611868 45.330990834435404, 124.48583471207972 45.330990791374155, 124.48583157942956 45.33099119554398, 124.48582862316286 45.33099203081827, 124.48582596123646 45.33099326386905, 124.48582369986299 45.33099484549688, 124.48582192927236 45.330996712593816, 124.48582072011261 45.33099879066156, 124.48582052946364 45.330999492258, 124.4858191089134 45.33099985935227, 124.48581649753277 45.33100097038419, 124.48581423384894 45.331002411811326, 124.48581240069066 45.3310041308916, 124.48581106513338 45.33100606472362, 124.48581027604557 45.331008142548086, 124.48581006230002 45.331010288337076, 124.4858120622846 45.33106528833755, 124.48581246754546 45.33106753541348, 124.48581350303658 45.33106967961485, 124.48581512674282 45.33107163394062, 124.48581727278241 45.33107331909388, 124.48581985407954 45.33107466669944, 124.48582276589799 45.331075622078075, 124.48582589009052 45.33107614646528, 124.48582909989287 45.33107621858398, 124.48583226506693 45.33107583550795, 124.48583525718564 45.33107501278056, 124.4858379548436 45.331073783784, 124.4858402485832 45.3310721983849, 124.48584204533577 45.33107032091093, 124.48584327219797 45.331068227540726, 124.48584387938993 45.3310660032129, 124.48584607029872 45.33104874978053), (124.48587877118268 45.331043382503154, 124.48591449384195 45.33106545828473, 124.48591709546764 45.33106676589209, 124.4859174006124 45.33106686159739, 124.4859833254963 45.331118658305115, 124.48616117499843 45.33125354418403, 124.48626724755502 45.331338598797025, 124.48660121104518 45.331595570743666, 124.48675094413757 45.3317123625744, 124.48679772467943 45.33175217580841, 124.48679828831692 45.33175263010593, 124.48701816315128 45.331920534550704, 124.48712324393927 45.33200459611603, 124.48733607557972 45.332168466512705, 124.48738591304728 45.33220933324282, 124.48738654338413 45.332209820456086, 124.48744528591138 45.332252632812704, 124.48745960292685 45.33226408515067, 124.48745909659036 45.332266205124114, 124.48745917436385 45.3322683636331, 124.48745983558483 45.33227047186872, 124.48746105587591 45.33227245210615, 124.48746279024834 45.33227423133952, 124.48751170729608 45.33231532166769, 124.48752447533072 45.332332287445, 124.48734279303491 45.33219143241756, 124.48726870154856 45.332136360811624, 124.48705393532227 45.33196854350741, 124.48698470180611 45.33191236232995, 124.48684182225149 45.331803454154674, 124.48670378112617 45.33169342327201, 124.48643878112034 45.33148842329917, 124.48636771486436 45.3314353712585, 124.48596886902645 45.33112349185472, 124.48590286267059 45.331071277880966, 124.48587877118268 45.331043382503154), (124.48759710756744 45.33237040885778, 124.48763529958734 45.33239958326621, 124.48763244133178 45.33240125458183, 124.48762897747558 45.332403826995105, 124.48762683242582 45.332403978804635, 124.48762379113147 45.33240464239948, 124.4876209973865 45.3324057189549, 124.4876185625783 45.332407165548354, 124.48761658378352 45.3324089245037, 124.48761513989717 45.33241092569093, 124.48761428848763 45.33241308932208, 124.4876137967815 45.33241510084794, 124.48760827244668 45.33241920346096, 124.487607324107 45.33241505887327, 124.4876083860645 45.33241453189929, 124.48761051096633 45.3324129705214, 124.48761217244387 45.33241115094543, 124.48761330895397 45.332409140571066, 124.48761387839839 45.33240701386548, 124.4876138596844 45.33240484960486, 124.48761325350512 45.33240272795654, 124.48761208231439 45.33240072750936, 124.48760053363486 45.33238538203444, 124.48759710756744 45.33237040885778), (124.4875502694058 45.332385706031225, 124.48754637493128 45.332383109712076, 124.48741980343688 45.332285440384176, 124.48731383575453 45.332202578711, 124.48731931986823 45.33220665511263, 124.4875502694058 45.332385706031225), (124.4870280890854 45.33198185016965, 124.48688888687651 45.33187350547474, 124.48686073686056 45.33185098607422, 124.4869611293493 45.331927508968775, 124.4870280890854 45.33198185016965), (124.48665986711893 45.33169283298868, 124.48639411367178 45.331487823404395, 124.48641531441142 45.33150365060122, 124.48665986711893 45.33169283298868), (124.48587332636627 45.33116427101717, 124.4858806684668 45.33117216723195, 124.48588184660038 45.33117327822463, 124.48590825983653 45.33119521723337, 124.48592329196026 45.33120888279859, 124.4859208492804 45.33120784526226, 124.48591791545759 45.331207099027516, 124.48591483180309 45.33120676993728, 124.4859117163183 45.33120687058476, 124.48590868822254 45.33120739711848, 124.48590586339104 45.33120832938976, 124.48590334992083 45.33120963172362, 124.48590124399425 45.33121125428404, 124.48589962619833 45.33121313498092, 124.48589855844062 45.3312152018462, 124.48589808158091 45.33121737578767, 124.48589821386722 45.33121957361571, 124.48589895023729 45.33122171122663, 124.48590026251286 45.331223706821014, 124.48590210047725 45.331225484033965, 124.48596924618133 45.33127859773153, 124.48614719655723 45.331415559558785, 124.48636026099939 45.331582609167135, 124.48663114525785 45.33179052036447, 124.48677727478524 45.33190761978403, 124.48698612484019 45.33206750501832, 124.4870492703737 45.332118616437405, 124.48725021690662 45.332272575496184, 124.48740135516539 45.33239069826167, 124.48740009451859 45.33239152049279, 124.48739827606526 45.33239327664712, 124.48739697084811 45.33239524683858, 124.48739622767845 45.33239735738765, 124.48739607434898 45.332399529365766, 124.48739651659378 45.3324016815471, 124.48739753787413 45.332403733446164, 124.48740248063224 45.3324112464517, 124.48727587870012 45.33231149935004, 124.4871767550138 45.33223640251251, 124.48699783979033 45.33209646883987, 124.48686979022034 45.331999429248214, 124.48653790718605 45.33173652194622, 124.48646876916119 45.33168441285911, 124.48634489482455 45.33158651218916, 124.48629067743953 45.33154634267165, 124.48594141625941 45.331274916885, 124.485887946538 45.33122243735447, 124.48588581256769 45.33122073604011, 124.48588323739612 45.33121937193251, 124.48588032610179 45.331218400693395, 124.48587473254898 45.33121700230552, 124.48587332636627 45.33116427101717), (124.48745401052066 45.332431851119296, 124.48745616402128 45.3324335341885, 124.48745682348968 45.332434019600626, 124.48752662790599 45.33248241734027, 124.48749946879637 45.33250436786684, 124.48745401052066 45.332431851119296), (124.48726373284636 45.332335649174325, 124.48725053385868 45.33232530115503, 124.48725222514909 45.332326582468944, 124.48726373284636 45.332335649174325), (124.48705136273927 45.3321719131554, 124.48702174302062 45.33214939361405, 124.48692222538291 45.3320721747603, 124.486974244189 45.332111596840576, 124.48705136273927 45.3321719131554), (124.485885059729 45.331305326490835, 124.48588629322059 45.331298788973356, 124.48595321740734 45.33135057553712, 124.48595546325453 45.33135201164567, 124.485955504422 45.33135202928962, 124.48629120700886 45.33161056761545, 124.48649612885008 45.331770506638435, 124.48675708659914 45.33197747316211, 124.48699820253549 45.33216456413937, 124.48714422903817 45.332275585158015, 124.48734764966744 45.33243506710233, 124.48734692002441 45.332435305728254, 124.487344414895 45.332436590672415, 124.48734230930278 45.33243819302852, 124.48734068272363 45.332440052315285, 124.4873395965532 45.332442098353525, 124.48733909178941 45.332444253915085, 124.48733918748472 45.332446437637785, 124.48733988002712 45.33244856709653, 124.4873406774461 45.332449826314004, 124.4868418152919 45.33206144972809, 124.48675974285811 45.332000391649075, 124.48637891038396 45.33169852448589, 124.48630571622446 45.331644371210174, 124.48602588786584 45.33142350671859, 124.4859542214495 45.331369751607085, 124.485887753622 45.331307252020146, 124.48588567359808 45.3313056466325, 124.485885059729 45.331305326490835), (124.48739512576499 45.33252571267319, 124.48738036688363 45.332516097030584, 124.48712900658712 45.33231853379727, 124.48739512576499 45.33252571267319), (124.4870421611598 45.33225092250032, 124.48680368358279 45.33206576561217, 124.48681830612118 45.332076644793965, 124.4870421611598 45.33225092250032), (124.48612254505731 45.33153354958009, 124.4860938653127 45.33151148799217, 124.48605136490067 45.33147736796788, 124.48612254505731 45.33153354958009), (124.48600926629918 45.33144413999097, 124.48598481922771 45.33142552891932, 124.48600224723079 45.331438599909845, 124.48600926629918 45.33144413999097), (124.48591977979059 45.331374846582015, 124.48591721851363 45.331374155423376, 124.48591415598464 45.33137378422079, 124.48591104954112 45.33137383909318, 124.48590801719342 45.33137431795602, 124.48590517413692 45.33137520261785, 124.4859026283762 45.331376459471365, 124.48590047662199 45.33137804077006, 124.48590037017175 45.331378157996525, 124.48588112797773 45.33136950981396, 124.48587899275208 45.331337481506026, 124.4858791509042 45.33133664329907, 124.48591977979059 45.331374846582015), (124.48593402556737 45.33141995246492, 124.48599916225217 45.331469534126526, 124.48607024911607 45.33152660002846, 124.48629118221567 45.33169654859278, 124.48667919922129 45.33200256154223, 124.48708616653025 45.33231853620969, 124.48728376081021 45.33247384118824, 124.48728229627537 45.332475252581965, 124.48728100012491 45.33247718897314, 124.48728024787262 45.33247926355284, 124.48728006679552 45.33248140109647, 124.48728046345937 45.332483524096254, 124.4872814234813 45.33248555557184, 124.48728933543991 45.33249815013959, 124.48708078368503 45.332333425151575, 124.48658983064755 45.3319534615563, 124.48644402555223 45.33183861509556, 124.48637172341003 45.33177837884894, 124.48607785651137 45.331553480746855, 124.4859357238959 45.33143917831401, 124.48590630076801 45.331407491892314, 124.48593402556737 45.33141995246492), (124.4858848571698 45.331425447458415, 124.48590966297759 45.33145216139477, 124.48591101398371 45.33145341508532, 124.4859367812077 45.33147413609962, 124.48593663284245 45.331474039334424, 124.48593398831363 45.33147289249043, 124.48593107882589 45.33147212886836, 124.48592801469135 45.33147177742059, 124.48592491208534 45.33147185147211, 124.48592188864163 45.33147234821529, 124.48591995163761 45.33147296471154, 124.4858869115603 45.33145626312791, 124.4858848571698 45.331425447458415), (124.4859013207733 45.331491216981696, 124.48593898842758 45.33151025775991, 124.48594386607739 45.33151429443431, 124.4859460453884 45.33151578395649, 124.48594834483931 45.331516844327815, 124.48611323791467 45.33164759142199, 124.4863531229438 45.331832502827424, 124.48648119956371 45.331935561798154, 124.48703111364591 45.33236249516159, 124.48714202926367 45.332451427518116, 124.48719610704666 45.33249249265604, 124.48724078057823 45.33252918878551, 124.4872383799681 45.33252976985714, 124.48723569230248 45.332530869890334, 124.4872333582059 45.33253231674663, 124.48723146634306 45.33253405546468, 124.48723008857978 45.332536019996276, 124.48722927725272 45.33253813571526, 124.48722926695382 45.33253824090946, 124.48721382315063 45.33252645483707, 124.48693893511282 45.332307544034585, 124.48667481596077 45.33210544961448, 124.4862369076617 45.33175852231821, 124.48602187506894 45.33159249581074, 124.48595125207113 45.33153579848392, 124.4859013207733 45.331491216981696), (124.48731911688579 45.3325559230137, 124.48727586116243 45.33252348122084, 124.48722009599007 45.33247767412247, 124.48716582795527 45.332436457998035, 124.4870548004474 45.33234743814229, 124.48675336315524 45.33211341436775, 124.48705716187678 45.332348532715564, 124.48732125116146 45.332557125058464, 124.48732083405963 45.33255699624748, 124.48731911688579 45.3325559230137), (124.4865259244266 45.33193683826557, 124.4865048958171 45.331920512250974, 124.48649091499246 45.331909262508276, 124.4865259244266 45.33193683826557), (124.48637804376727 45.331818439864556, 124.48637676208877 45.33181740855038, 124.48613683769933 45.33163246686219, 124.48611290560542 45.33161349047224, 124.4863480483333 45.33179344646393, 124.48637804376727 45.331818439864556), (124.48746827838025 45.33252957654603, 124.48744890874495 45.332539261362435, 124.48744779681951 45.33253862128283, 124.4874449786318 45.33253757522343, 124.48744368579014 45.33253730870866, 124.48744489918082 45.33252583660429, 124.48744485848637 45.33252384118724, 124.4874443183658 45.3325218822643, 124.4874432958289 45.332520021527245, 124.4874253832163 45.33249443212311, 124.48745450910792 45.33251579544226, 124.48745599353046 45.33251675468677, 124.48747251730798 45.332526150566935, 124.48746827838025 45.33252957654603), (124.48753892210895 45.332506686216945, 124.48754865663952 45.3324988185731, 124.48754893889584 45.332499300604546, 124.48755069509951 45.33250115069426, 124.48755293366153 45.33250272047324, 124.48755362220855 45.33250304156521, 124.48753892210895 45.332506686216945), (124.48758516425518 45.33249522121742, 124.48758553236155 45.33249495139064, 124.48758723711107 45.3324930614769, 124.48758837696455 45.33249097073533, 124.48758890669535 45.33248876212179, 124.48758880528489 45.332486523269026, 124.48758807675712 45.33248434300955, 124.48758675001834 45.332482307851066, 124.48758487771053 45.332480498543966, 124.4875825341226 45.33247898687737, 124.48757981224281 45.33247783283074, 124.48757613754762 45.33247660793301, 124.48758953579934 45.332465779179365, 124.48759150426449 45.332467033256115, 124.4875941398354 45.332468151123194, 124.48759703066379 45.33246889128073, 124.48760006918597 45.3324692261885, 124.4876005694296 45.33246921270988, 124.48759479549585 45.33249283330264, 124.48758516425518 45.33249522121742), (124.48763121898187 45.33247619840795, 124.487634863626 45.33246128848642, 124.48763645894783 45.33246048749482, 124.48763858034411 45.332458908130235, 124.48764023086342 45.33245707019738, 124.48764134872785 45.33245504248924, 124.48764189209608 45.33245290090209, 124.48764184063019 45.332450725594576, 124.48764119625666 45.332448597987494, 124.48763998309413 45.33244659771623, 124.48763876340635 45.33244533481695, 124.48764342970472 45.33242624537595, 124.48765083019974 45.33242624537854, 124.48764164001595 45.33246989870082, 124.48763121898187 45.33247619840795), (124.48767857722258 45.33244756946013, 124.48768306649289 45.33242624538426, 124.48771080528437 45.3324262453819, 124.48770299887123 45.33243280609506, 124.48767857722258 45.33244756946013), (124.48775003213358 45.33240437353054, 124.48774799670285 45.33240395505738, 124.48774499998947 45.33240375462838, 124.48768621523226 45.332403754642705, 124.48768596010459 45.332403275477986, 124.48775276409415 45.33237284987906, 124.4878109276108 45.33235346203925, 124.48788149505181 45.332337028525316, 124.48791335698097 45.3323342975228, 124.48778744385518 45.33238209779544, 124.48778462472457 45.33238346157482, 124.48775003213358 45.33240437353054), (124.48757991128684 45.33243641444538, 124.48758066451047 45.33243970631108, 124.48756598772133 45.332450605922205, 124.48756237090977 45.332453529106246, 124.48754517645675 45.33241325789264, 124.48757991128684 45.33243641444538), (124.48743331800709 45.33232920430587, 124.48743200308547 45.332329716211106, 124.48742967336406 45.33233108589067, 124.48742775352765 45.33233274196371, 124.48742631305062 45.33233462450074, 124.4874254040606 45.33233666537706, 124.48742505945191 45.33233879073807, 124.48742529169525 45.33234092367178, 124.48742609238633 45.3323429869922, 124.48742649024848 45.33234355670877, 124.48719784738313 45.332164474772405, 124.4870677565816 45.33206540401848, 124.48678785411694 45.33184747999049, 124.48656872178016 45.33167437761875, 124.48625384168248 45.33143346939071, 124.48617878417075 45.331373425676986, 124.48597097246417 45.33121257144876, 124.48593307655065 45.331181088712334, 124.48590232797244 45.331153135446606, 124.48596671531551 45.331188603020586, 124.48623523382761 45.331398588230336, 124.48672513653725 45.331776513236555, 124.48686518616228 45.33188855137151, 124.48706818615752 45.332046551392395, 124.48713030119276 45.33209264139765, 124.48739616133965 45.3323005320708, 124.48743331800709 45.33232920430587), (124.48598225766747 45.331254698122876, 124.48612538063605 45.331365480811066, 124.48599282721997 45.33126345876098, 124.48598188072796 45.33125479960662, 124.48598225766747 45.331254698122876), (124.48631212142978 45.33151123918811, 124.48654519216123 45.331689556538066, 124.48662340806382 45.33175134355441, 124.48638379611504 45.33156743466814, 124.48631212142978 45.33151123918811), (124.48671642025823 45.33182481872163, 124.48676418447644 45.331862550055384, 124.48690673838001 45.33197353876879, 124.48680084801315 45.33189247422269, 124.48671642025823 45.33182481872163), (124.48704998953039 45.33208497091728, 124.4871742272688 45.332179583696316, 124.48726589898803 45.33225138474888, 124.4870728772977 45.332103496702246, 124.48704998953039 45.33208497091728), (124.48739951391968 45.332559188961184, 124.48738276121878 45.33256794605511, 124.48734902354182 45.33252513606671, 124.48735713406165 45.332531510723676, 124.48735818199205 45.3325322605687, 124.48739951391968 45.332559188961184), (124.4875272817671 45.332551736552254, 124.4874916052031 45.33257259825974, 124.48746700747496 45.332564808981694, 124.48748981094992 45.33254637880033, 124.48749072399792 45.332545922276125, 124.48749209429687 45.3325476028191, 124.48749434395194 45.33254936464416, 124.48749706733103 45.33255075461166, 124.4875001433639 45.332551710929344, 124.487503435303 45.33255219108329, 124.48750679680217 45.332552173727784, 124.48752897926484 45.33255039913101, 124.4875272817671 45.332551736552254), (124.48754572353447 45.33253720668303, 124.48754497086244 45.332535132604235, 124.48754357482754 45.332533102351064, 124.48754163223946 45.332531309550575, 124.48753994592552 45.33253027215643, 124.48756121953734 45.332524997709875, 124.48754572353447 45.33253720668303), (124.48743836489126 45.332587615546544, 124.48744401229021 45.33258339408974, 124.48744509104294 45.3325825222234, 124.48746157506358 45.33258774216446, 124.4874554029558 45.33259052956656, 124.48745337512986 45.33259161564015, 124.48743683918015 45.332602040482264, 124.48743836489126 45.332587615546544), (124.48738801942814 45.332625248973066, 124.48739319981851 45.332627483650874, 124.48739488568984 45.33262962286053, 124.48737767576378 45.3326329808929, 124.48738801942814 45.332625248973066))</textarea>
            <div class="coord-settings" style="margin-bottom:8px;font-size:12px;color:#333;">
                <label>WKT坐标系：
                    <select id="coordSysSelect" style="margin-left:6px;">
                        <option value="wgs84" selected>WGS84</option>
                        <option value="gcj02">GCJ-02（国测局）</option>
                        <option value="bd09">BD-09（百度）</option>
                        <option value="cgcs2000">CGCS2000</option>
                    </select>
                </label>
                <!-- 已移除“不进行绘制坐标转换”选项，统一使用WGS84绘制 -->
            </div>

            <div class="button-group">
                <button id="drawButton" disabled>绘制轮廓</button>
                <button id="clearButton" disabled>清空轮廓</button>
            </div>
            <!-- 显示开关：仅保留显示亩数 -->
            <div class="display-toggles" style="margin-top:8px;font-size:12px;color:#333;">
                <label><input type="checkbox" id="toggleLabelsCheckbox"> 显示亩数</label>
            </div>
        </div>

        <div class="tab-pane" id="tabSplit">
            <!-- MultiPolygon → 多个 Polygon 分割器 -->
            <div class="split-section">
                <div class="title">MultiPolygon → 多个 Polygon 分割器</div>
                <div class="desc">输入一个 MULTIPOLYGON WKT，分割为多行 POLYGON WKT。</div>
                <textarea id="multiInput"></textarea>
                <div class="split-actions">
                    <button id="splitMultiBtn">分割为多个 POLYGON</button>
                    <button id="copyPolysBtn">复制结果</button>
                </div>
                <textarea id="polyOutput" readonly></textarea>
            </div>
        </div>

        <div class="tab-pane" id="tabBatch">
            <!-- 批量POLYGON → MULTIPOLYGON 生成器 -->
            <div class="batch-section">
                <div class="title">批量POLYGON → MULTIPOLYGON 合并器</div>
                <div class="desc">每行一个 POLYGON WKT（或用分号分隔）。生成后可一键填充到上方并绘制。</div>
                <textarea id="batchInput"></textarea>
                <div class="batch-actions">
                    <button id="generateMultiBtn">生成 MULTIPOLYGON</button>
                    <button id="copyMultiBtn">复制结果</button>
                </div>
                <textarea id="multiOutput" readonly></textarea>
            </div>
        </div>
        <div class="tab-pane" id="tabTrack">
            <div class="tip">请粘贴轨迹文本（支持两种格式：1）每行一条：定位时间yyyyMMddHHmmss, 经度, 纬度；2）单行#分隔：经度,纬度,定位时间yyyyMMddHHmmss#经度,纬度,定位时间yyyyMMddHHmmss#…）。</div>
            <div class="coord-settings" style="margin-bottom:8px;font-size:12px;color:#333;">
                <label>轨迹坐标系：
                    <select id="trackCoordSysSelect" style="margin-left:6px;">
                        <option value="wgs84" selected>WGS84</option>
                        <option value="gcj02">GCJ-02（国测局）</option>
                        <option value="bd09">BD-09（百度）</option>
                        <option value="cgcs2000">CGCS2000</option>
                    </select>
                </label>
            </div>
            <textarea id="trackTextarea" style="width:100%;height:120px;margin-bottom:10px;padding:8px;border:1px solid #ddd;border-radius:4px;font-family:monospace;resize:vertical;box-sizing:border-box;">20251015095653,124.504354,45.342155
20251015095703,124.504421,45.342118
20251015095713,124.504494,45.342044
20251015095723,124.504459,45.342031
20251015095733,124.504307,45.341991
20251015095743,124.503701,45.341875
20251015095753,124.503401,45.341786
20251015095803,124.503350,45.341770
20251015095813,124.503113,45.341685
20251015095823,124.502814,45.341598
20251015095833,124.502274,45.341354
20251015095843,124.501753,45.341134
20251015095853,124.501187,45.340860
20251015095903,124.500561,45.340542
20251015095913,124.500107,45.340319
20251015095923,124.499830,45.340192
20251015095933,124.499298,45.339941
20251015095943,124.498862,45.339724
20251015095953,124.498567,45.339575
20251015100003,124.497980,45.339306
20251015100013,124.497170,45.338902
20251015100023,124.496631,45.338580
20251015100033,124.496358,45.338409
20251015100043,124.495598,45.338059
20251015100053,124.494821,45.337716
20251015100103,124.493822,45.337369
20251015100113,124.492812,45.337082
20251015100123,124.492024,45.336793
20251015100133,124.491306,45.336556
20251015100143,124.491041,45.336470
20251015100153,124.490423,45.336204
20251015100203,124.489772,45.335783
20251015100213,124.489356,45.335433
20251015100223,124.488979,45.334728
20251015100233,124.488583,45.334327
20251015100243,124.487900,45.333999
20251015100253,124.487686,45.333899
20251015100303,124.487430,45.333771
20251015100313,124.487395,45.333694
20251015100323,124.487441,45.333670
20251015100333,124.487557,45.333569
20251015100343,124.487718,45.333423
20251015100353,124.487885,45.333267
20251015100403,124.488049,45.333099
20251015100413,124.488177,45.332936
20251015100423,124.488346,45.332720
20251015100433,124.488459,45.332518
20251015100443,124.488351,45.332432
20251015100453,124.488053,45.332311
20251015100503,124.487878,45.332326
20251015100513,124.487805,45.332343
20251015100523,124.487745,45.332363
20251015100533,124.487720,45.332374
20251015100543,124.487644,45.332409
20251015100553,124.487578,45.332458
20251015100603,124.487505,45.332517
20251015100613,124.487432,45.332576
20251015100623,124.487337,45.332647
20251015100633,124.487334,45.332659
20251015100643,124.487381,45.332644
20251015100653,124.487422,45.332636
20251015100703,124.487528,45.332600
20251015100713,124.487651,45.332502
20251015100723,124.487671,45.332407
20251015100733,124.487651,45.332395
20251015100743,124.487572,45.332334
20251015100753,124.487578,45.332339
20251015100803,124.487507,45.332285
20251015100813,124.487457,45.332245
20251015100823,124.487398,45.332202
20251015100833,124.487348,45.332161
20251015100843,124.487297,45.332121
20251015100853,124.487241,45.332079
20251015100903,124.487188,45.332037
20251015100913,124.487135,45.331997
20251015100923,124.487083,45.331955
20251015100933,124.487030,45.331913
20251015100943,124.486976,45.331873
20251015100953,124.486922,45.331831
20251015101003,124.486866,45.331787
20251015101013,124.486810,45.331745
20251015101023,124.486762,45.331705
20251015101033,124.486763,45.331705
20251015101043,124.486727,45.331678
20251015101053,124.486669,45.331632
20251015101103,124.486613,45.331588
20251015101113,124.486556,45.331544
20251015101123,124.486496,45.331498
20251015101133,124.486441,45.331455
20251015101143,124.486386,45.331413
20251015101153,124.486331,45.331370
20251015101203,124.486279,45.331331
20251015101213,124.486226,45.331288
20251015101223,124.486173,45.331246
20251015101233,124.486118,45.331204
20251015101243,124.486055,45.331156
20251015101253,124.485995,45.331111
20251015101303,124.485931,45.331061
20251015101313,124.485869,45.331012
20251015101323,124.485925,45.331057
20251015101333,124.485924,45.331056
20251015101343,124.485924,45.331056
20251015101353,124.485924,45.331056
20251015101403,124.485924,45.331056
20251015101413,124.485924,45.331056
20251015101423,124.485836,45.331002
20251015101433,124.485833,45.331028
20251015101443,124.485828,45.331065
20251015101453,124.485826,45.331010
20251015101503,124.485832,45.331024
20251015101513,124.485833,45.331012
20251015101523,124.485890,45.331078
20251015101533,124.485957,45.331131
20251015101543,124.486024,45.331183
20251015101553,124.486090,45.331234
20251015101603,124.486153,45.331283
20251015101613,124.486223,45.331338
20251015101623,124.486291,45.331391
20251015101633,124.486356,45.331443
20251015101643,124.486427,45.331496
20251015101653,124.486495,45.331549
20251015101703,124.486559,45.331598
20251015101713,124.486626,45.331650
20251015101723,124.486692,45.331701
20251015101733,124.486761,45.331755
20251015101743,124.486830,45.331811
20251015101753,124.486901,45.331865
20251015101803,124.486973,45.331920
20251015101813,124.487042,45.331976
20251015101823,124.487110,45.332029
20251015101833,124.487184,45.332087
20251015101843,124.487257,45.332144
20251015101853,124.487331,45.332199
20251015101903,124.487401,45.332254
20251015101913,124.487469,45.332306
20251015101923,124.487539,45.332361
20251015101933,124.487598,45.332406
20251015101943,124.487525,45.332309
20251015101953,124.487475,45.332267
20251015102003,124.487477,45.332268
20251015102013,124.487477,45.332268
20251015102023,124.487477,45.332268
20251015102033,124.487574,45.332340
20251015102043,124.487601,45.332458
20251015102053,124.487626,45.332452
20251015102103,124.487613,45.332441
20251015102113,124.487613,45.332441
20251015102123,124.487613,45.332441
20251015102133,124.487604,45.332437
20251015102143,124.487535,45.332391
20251015102153,124.487472,45.332342
20251015102203,124.487408,45.332293
20251015102213,124.487344,45.332243
20251015102223,124.487275,45.332189
20251015102233,124.487210,45.332139
20251015102243,124.487142,45.332085
20251015102253,124.487080,45.332039
20251015102303,124.487012,45.331985
20251015102313,124.486945,45.331934
20251015102323,124.486877,45.331881
20251015102333,124.486806,45.331825
20251015102343,124.486737,45.331769
20251015102353,124.486667,45.331715
20251015102403,124.486598,45.331661
20251015102413,124.486529,45.331608
20251015102423,124.486461,45.331556
20251015102433,124.486393,45.331503
20251015102443,124.486321,45.331448
20251015102453,124.486247,45.331391
20251015102503,124.486180,45.331338
20251015102513,124.486101,45.331276
20251015102523,124.486035,45.331224
20251015102533,124.485963,45.331168
20251015102543,124.485880,45.331104
20251015102553,124.485977,45.331180
20251015102603,124.485977,45.331180
20251015102613,124.485977,45.331179
20251015102623,124.485977,45.331179
20251015102633,124.485977,45.331179
20251015102643,124.485859,45.331115
20251015102653,124.485854,45.331119
20251015102703,124.485834,45.331161
20251015102713,124.485841,45.331109
20251015102723,124.485894,45.331166
20251015102733,124.485959,45.331220
20251015102743,124.486026,45.331271
20251015102753,124.486095,45.331325
20251015102803,124.486167,45.331381
20251015102813,124.486242,45.331441
20251015102823,124.486316,45.331498
20251015102833,124.486356,45.331528
20251015102843,124.486421,45.331579
20251015102853,124.486485,45.331628
20251015102903,124.486557,45.331682
20251015102913,124.486629,45.331738
20251015102923,124.486705,45.331798
20251015102933,124.486776,45.331855
20251015102943,124.486844,45.331907
20251015102953,124.486913,45.331961
20251015103003,124.486985,45.332018
20251015103013,124.487056,45.332073
20251015103023,124.487127,45.332127
20251015103033,124.487186,45.332172
20251015103043,124.487252,45.332224
20251015103053,124.487321,45.332277
20251015103103,124.487399,45.332338
20251015103113,124.487474,45.332397
20251015103123,124.487532,45.332443
20251015103133,124.487441,45.332339
20251015103143,124.487452,45.332346
20251015103153,124.487452,45.332346
20251015103203,124.487452,45.332346
20251015103213,124.487452,45.332346
20251015103223,124.487454,45.332348
20251015103233,124.487525,45.332405
20251015103243,124.487563,45.332494
20251015103253,124.487563,45.332493
20251015103303,124.487573,45.332488
20251015103313,124.487573,45.332488
20251015103323,124.487573,45.332488
20251015103333,124.487543,45.332478
20251015103343,124.487468,45.332426
20251015103353,124.487400,45.332373
20251015103403,124.487331,45.332319
20251015103413,124.487262,45.332265
20251015103423,124.487194,45.332213
20251015103433,124.487127,45.332162
20251015103443,124.487061,45.332111
20251015103453,124.486998,45.332060
20251015103503,124.486930,45.332009
20251015103513,124.486860,45.331954
20251015103523,124.486789,45.331900
20251015103533,124.486713,45.331840
20251015103543,124.486643,45.331783
20251015103553,124.486576,45.331731
20251015103603,124.486508,45.331680
20251015103613,124.486440,45.331626
20251015103623,124.486372,45.331575
20251015103633,124.486302,45.331520
20251015103643,124.486232,45.331465
20251015103653,124.486159,45.331408
20251015103703,124.486120,45.331378
20251015103713,124.486049,45.331323
20251015103723,124.485981,45.331271
20251015103733,124.485914,45.331218
20251015103743,124.485933,45.331233
20251015103753,124.485945,45.331242
20251015103803,124.485944,45.331242
20251015103813,124.485944,45.331241
20251015103823,124.485955,45.331250
20251015103833,124.485981,45.331243
20251015103843,124.485860,45.331133
20251015103853,124.485837,45.331130
20251015103903,124.485874,45.331138
20251015103913,124.485857,45.331150
20251015103923,124.485858,45.331204
20251015103933,124.485859,45.331225
20251015103943,124.485875,45.331229
20251015103953,124.485929,45.331282
20251015104003,124.486002,45.331338
20251015104013,124.486071,45.331392
20251015104023,124.486139,45.331444
20251015104033,124.486208,45.331498
20251015104043,124.486279,45.331554
20251015104053,124.486294,45.331565
20251015104103,124.486333,45.331594
20251015104113,124.486395,45.331643
20251015104123,124.486457,45.331692
20251015104133,124.486526,45.331744
20251015104143,124.486592,45.331796
20251015104153,124.486656,45.331846
20251015104203,124.486720,45.331897
20251015104213,124.486791,45.331953
20251015104223,124.486858,45.332007
20251015104233,124.486921,45.332055
20251015104243,124.486986,45.332104
20251015104253,124.487051,45.332155
20251015104303,124.487117,45.332206
20251015104313,124.487165,45.332244
20251015104323,124.487217,45.332283
20251015104333,124.487264,45.332319
20251015104343,124.487314,45.332359
20251015104353,124.487374,45.332406
20251015104403,124.487443,45.332459
20251015104413,124.487462,45.332475
20251015104423,124.487412,45.332399
20251015104433,124.487412,45.332399
20251015104443,124.487412,45.332399
20251015104453,124.487412,45.332399
20251015104503,124.487421,45.332407
20251015104513,124.487505,45.332539
20251015104523,124.487505,45.332541
20251015104533,124.487530,45.332539
20251015104543,124.487529,45.332539
20251015104553,124.487529,45.332539
20251015104603,124.487529,45.332539
20251015104613,124.487529,45.332539
20251015104623,124.487529,45.332539
20251015104633,124.487529,45.332539
20251015104643,124.487529,45.332539
20251015104653,124.487529,45.332539
20251015104703,124.487529,45.332539
20251015104713,124.487529,45.332539
20251015104723,124.487529,45.332539
20251015104733,124.487529,45.332539
20251015104743,124.487529,45.332539
20251015104753,124.487529,45.332539
20251015104803,124.487517,45.332537
20251015104813,124.487466,45.332508
20251015104823,124.487406,45.332464
20251015104833,124.487348,45.332419
20251015104843,124.487286,45.332371
20251015104853,124.487229,45.332325
20251015104902,124.487156,45.332268
20251015104912,124.487082,45.332211
20251015104922,124.487010,45.332157
20251015104932,124.486943,45.332104
20251015104942,124.486905,45.332075
20251015104952,124.486840,45.332025
20251015105002,124.486769,45.331970
20251015105012,124.486704,45.331918
20251015105022,124.486638,45.331866
20251015105032,124.486574,45.331815
20251015105042,124.486508,45.331763
20251015105052,124.486440,45.331711
20251015105102,124.486371,45.331656
20251015105112,124.486303,45.331603
20251015105122,124.486234,45.331551
20251015105132,124.486168,45.331499
20251015105142,124.486099,45.331447
20251015105152,124.486027,45.331390
20251015105202,124.485953,45.331333
20251015105212,124.485881,45.331278
20251015105222,124.485951,45.331332
20251015105232,124.485965,45.331343
20251015105242,124.485965,45.331343
20251015105252,124.485964,45.331342
20251015105302,124.485964,45.331342
20251015105312,124.485964,45.331342
20251015105322,124.485963,45.331341
20251015105332,124.485963,45.331341
20251015105342,124.485963,45.331341
20251015105352,124.485956,45.331335
20251015105402,124.485867,45.331251
20251015105412,124.485871,45.331260
20251015105422,124.485860,45.331283
20251015105432,124.485873,45.331284
20251015105442,124.485863,45.331337
20251015105452,124.485866,45.331398
20251015105502,124.485871,45.331457
20251015105512,124.485868,45.331526
20251015105522,124.485874,45.331592
20251015105532,124.485879,45.331659
20251015105542,124.485879,45.331671
20251015105552,124.485869,45.331603
20251015105602,124.485867,45.331535
20251015105612,124.485869,45.331464
20251015105622,124.485867,45.331388
20251015105632,124.485865,45.331401
20251015105642,124.485859,45.331326
20251015105652,124.485875,45.331314
20251015105702,124.485942,45.331377
20251015105712,124.486014,45.331431
20251015105722,124.486088,45.331490
20251015105732,124.486148,45.331536
20251015105742,124.486220,45.331593
20251015105752,124.486294,45.331652
20251015105802,124.486367,45.331706
20251015105812,124.486443,45.331766
20251015105822,124.486521,45.331827
20251015105832,124.486600,45.331890
20251015105842,124.486675,45.331949
20251015105852,124.486748,45.332008
20251015105902,124.486830,45.332069
20251015105912,124.486902,45.332125
20251015105922,124.486978,45.332185
20251015105932,124.487047,45.332239
20251015105942,124.487124,45.332298
20251015105952,124.487202,45.332358
20251015110002,124.487282,45.332422
20251015110012,124.487367,45.332488
20251015110022,124.487426,45.332533
20251015110032,124.487355,45.332445
20251015110042,124.487357,45.332446
20251015110052,124.487357,45.332446
20251015110102,124.487357,45.332446
20251015110112,124.487357,45.332446
20251015110122,124.487357,45.332446
20251015110132,124.487358,45.332446
20251015110142,124.487366,45.332435
20251015110152,124.487429,45.332525
20251015110202,124.487418,45.332629
20251015110212,124.487464,45.332600
20251015110222,124.487495,45.332587
20251015110232,124.487495,45.332586
20251015110242,124.487495,45.332586
20251015110252,124.487495,45.332586
20251015110302,124.487435,45.332567
20251015110312,124.487369,45.332524
20251015110322,124.487298,45.332469
20251015110332,124.487240,45.332422
20251015110342,124.487165,45.332364
20251015110352,124.487098,45.332311
20251015110402,124.487030,45.332258
20251015110412,124.486964,45.332207
20251015110422,124.486898,45.332156
20251015110432,124.486828,45.332101
20251015110442,124.486759,45.332048
20251015110452,124.486691,45.331995
20251015110502,124.486620,45.331939
20251015110512,124.486551,45.331885
20251015110522,124.486481,45.331829
20251015110532,124.486409,45.331773
20251015110542,124.486333,45.331713
20251015110552,124.486303,45.331689
20251015110602,124.486303,45.331689
20251015110612,124.486299,45.331687
20251015110622,124.486228,45.331632
20251015110632,124.486153,45.331574
20251015110642,124.486082,45.331519
20251015110652,124.486011,45.331462
20251015110702,124.485944,45.331411
20251015110712,124.485913,45.331385
20251015110722,124.485960,45.331423
20251015110732,124.485958,45.331421
20251015110742,124.485957,45.331420
20251015110752,124.485957,45.331420
20251015110802,124.485946,45.331412
20251015110812,124.485857,45.331372
20251015110822,124.485847,45.331396
20251015110832,124.485848,45.331395
20251015110842,124.485857,45.331406
20251015110852,124.485871,45.331390
20251015110902,124.485923,45.331446
20251015110912,124.485992,45.331502
20251015110922,124.486066,45.331561
20251015110932,124.486141,45.331618
20251015110942,124.486219,45.331679
20251015110952,124.486290,45.331733
20251015111002,124.486360,45.331786
20251015111012,124.486432,45.331846
20251015111022,124.486508,45.331906
20251015111032,124.486578,45.331961
20251015111042,124.486649,45.332016
20251015111052,124.486721,45.332072
20251015111102,124.486793,45.332127
20251015111112,124.486858,45.332179
20251015111122,124.486935,45.332237
20251015111132,124.487000,45.332288
20251015111142,124.487069,45.332341
20251015111152,124.487137,45.332396
20251015111202,124.487208,45.332452
20251015111212,124.487274,45.332504
20251015111222,124.487345,45.332559
20251015111232,124.487337,45.332546
20251015111242,124.487295,45.332481
20251015111252,124.487296,45.332481
20251015111302,124.487296,45.332481
20251015111312,124.487296,45.332481
20251015111322,124.487296,45.332481
20251015111332,124.487296,45.332481
20251015111342,124.487296,45.332481
20251015111352,124.487296,45.332481
20251015111402,124.487296,45.332481
20251015111412,124.487296,45.332481
20251015111422,124.487296,45.332481
20251015111432,124.487296,45.332482
20251015111442,124.487296,45.332482
20251015111452,124.487296,45.332482
20251015111502,124.487296,45.332482
20251015111512,124.487296,45.332482
20251015111522,124.487296,45.332482
20251015111532,124.487296,45.332482
20251015111542,124.487296,45.332482
20251015111552,124.487296,45.332482
20251015111602,124.487296,45.332482
20251015111701,124.487415,45.332632
20251015111935,124.487647,45.332496
20251015111945,124.487647,45.332496
20251015111955,124.487647,45.332496
20251015112005,124.487647,45.332496
20251015112015,124.487647,45.332496
20251015112025,124.487647,45.332496
20251015112035,124.487647,45.332496
20251015112045,124.487647,45.332496
20251015112055,124.487647,45.332496
20251015112105,124.487647,45.332496
20251015112115,124.487647,45.332496
20251015112125,124.487647,45.332496
20251015112135,124.487647,45.332496
20251015112145,124.487647,45.332496
20251015112155,124.487647,45.332496
20251015112205,124.487647,45.332496
20251015112215,124.487647,45.332496
20251015112225,124.487647,45.332496
20251015112235,124.487647,45.332496
20251015112245,124.487647,45.332496
20251015112255,124.487647,45.332496
20251015112305,124.487647,45.332496
20251015112315,124.487647,45.332496
20251015112325,124.487647,45.332496
20251015112335,124.487647,45.332496
20251015112345,124.487647,45.332496
20251015112355,124.487647,45.332496
20251015112405,124.487647,45.332496
20251015112415,124.487647,45.332496
20251015112425,124.487647,45.332496
20251015112435,124.487651,45.332494
20251015112445,124.487745,45.332415
20251015112455,124.487630,45.332415
20251015112505,124.487608,45.332505
20251015112515,124.487569,45.332536
20251015112526,124.487509,45.332583
20251015112536,124.487455,45.332619
20251015112546,124.487418,45.332625
20251015112556,124.487367,45.332603
20251015112606,124.487316,45.332570
20251015112616,124.487264,45.332531
20251015112626,124.487208,45.332485
20251015112636,124.487154,45.332444
20251015112646,124.487097,45.332399
20251015112656,124.487043,45.332355
20251015112706,124.486983,45.332308
20251015112716,124.486922,45.332261
20251015112726,124.486862,45.332215
20251015112736,124.486801,45.332167
20251015112746,124.486740,45.332119
20251015112756,124.486681,45.332074
20251015112806,124.486617,45.332024
20251015112816,124.486556,45.331976
20251015112826,124.486493,45.331928
20251015112836,124.486430,45.331877
20251015112846,124.486365,45.331825
20251015112856,124.486303,45.331777
20251015112906,124.486242,45.331729
20251015112916,124.486179,45.331681
20251015112926,124.486125,45.331640
20251015112936,124.486062,45.331589
20251015112946,124.485995,45.331538
20251015112956,124.485927,45.331483
20251015113006,124.485956,45.331507
20251015113016,124.485956,45.331507
20251015113026,124.485955,45.331506
20251015113036,124.485954,45.331505
20251015113046,124.485952,45.331503
20251015113056,124.485861,45.331457
20251015113106,124.485878,45.331468
20251015113116,124.485858,45.331502
20251015113126,124.485879,45.331487
20251015113136,124.485879,45.331487
20251015113146,124.485879,45.331487
20251015113156,124.485879,45.331487
20251015113206,124.485879,45.331487
20251015113216,124.485883,45.331493
20251015113226,124.485939,45.331543
20251015113236,124.486010,45.331600
20251015113246,124.486084,45.331658
20251015113256,124.486159,45.331716
20251015113306,124.486225,45.331766
20251015113316,124.486296,45.331822
20251015113326,124.486362,45.331874
20251015113336,124.486425,45.331924
20251015113346,124.486476,45.331965
20251015113356,124.486544,45.332019
20251015113406,124.486566,45.332036
20251015113416,124.486622,45.332080
20251015113426,124.486663,45.332113
20251015113436,124.486725,45.332160
20251015113446,124.486787,45.332207
20251015113456,124.486862,45.332266
20251015113506,124.486927,45.332315
20251015113516,124.486993,45.332368
20251015113526,124.487067,45.332426
20251015113536,124.487133,45.332478
20251015113546,124.487202,45.332534
20251015113556,124.487278,45.332592
20251015113606,124.487291,45.332600
20251015113616,124.487251,45.332546
20251015113626,124.487251,45.332547
20251015113636,124.487252,45.332546
20251015113646,124.487252,45.332547
20251015113656,124.487252,45.332547
20251015113706,124.487245,45.332540
20251015113716,124.487255,45.332545
20251015113726,124.487324,45.332574
20251015113736,124.487308,45.332564
20251015113746,124.487308,45.332564
20251015113756,124.487308,45.332564
20251015113806,124.487308,45.332564
20251015113816,124.487307,45.332565
20251015113826,124.487375,45.332586
20251015113836,124.487419,45.332563
20251015113846,124.487439,45.332548
20251015113856,124.487401,45.332586
20251015113906,124.487389,45.332610
20251015113916,124.487389,45.332610
20251015113926,124.487389,45.332610
20251015113936,124.487389,45.332610
20251015113946,124.487389,45.332610
20251015113956,124.487389,45.332610
20251015114006,124.487389,45.332610
20251015114016,124.487389,45.332610
20251015114026,124.487433,45.332563
20251015114036,124.487441,45.332557
20251015114046,124.487497,45.332529
20251015114056,124.487618,45.332499
20251015114106,124.487795,45.332392
20251015114116,124.488011,45.332310
20251015114126,124.488202,45.332382
20251015114136,124.488408,45.332479
20251015114146,124.488450,45.332571
20251015114156,124.488282,45.332796
20251015114206,124.488090,45.333043
20251015114216,124.487862,45.333280
20251015114226,124.487602,45.333521
20251015114236,124.487403,45.333686
20251015114246,124.487296,45.333723
20251015114256,124.487454,45.333778
20251015114306,124.487639,45.333874
20251015114316,124.487786,45.333954
20251015114326,124.487818,45.333986
20251015114336,124.487820,45.334037
20251015114346,124.488008,45.334038
20251015114356,124.488132,45.334112
20251015114406,124.488263,45.334180
20251015114416,124.488463,45.334279
20251015114426,124.488833,45.334470
20251015114436,124.489072,45.334939
20251015114446,124.489233,45.335271
20251015114456,124.489280,45.335358
20251015114506,124.489395,45.335484
20251015114516,124.489535,45.335615
20251015114526,124.489733,45.335762
20251015114536,124.490040,45.335970
20251015114546,124.490458,45.336218
20251015114556,124.490795,45.336356
20251015114606,124.490829,45.336367
20251015114616,124.491052,45.336453
20251015114625,124.491621,45.336664
20251015114635,124.492398,45.336938
20251015114645,124.493200,45.337203
20251015114655,124.494118,45.337451
20251015114705,124.494960,45.337783
20251015114715,124.495843,45.338167
20251015114725,124.496604,45.338558
20251015114735,124.497348,45.339002
20251015114745,124.498070,45.339360
20251015114755,124.498622,45.339608
20251015114805,124.499329,45.339964
20251015114815,124.499880,45.340215
20251015114825,124.500341,45.340446
20251015114835,124.500945,45.340746
20251015114845,124.501234,45.340889
20251015114855,124.501260,45.340902
20251015114905,124.501261,45.340902
20251015114915,124.501261,45.340902
20251015114925,124.501261,45.340902
20251015114935,124.501373,45.340948
20251015114945,124.501752,45.341137
20251015114955,124.502158,45.341308
20251015115005,124.502614,45.341520
20251015115015,124.503050,45.341675
20251015115025,124.503673,45.341871
20251015115035,124.504172,45.341973
20251015115045,124.504521,45.342063
20251015115055,124.504513,45.342027
20251015115105,124.504434,45.342114
20251015115115,124.504324,45.342182</textarea>
            <div class="button-group">
                <button id="drawTrackButton" disabled style="flex: 1;">绘制轨迹</button>
                <button id="showTrackPointsButton" disabled style="flex: 1;" class="btn-warning">打点</button>
                <button id="clearTrackButton" disabled style="flex: 1;">清空轨迹</button>
            </div>
            <!-- 回放控制 -->
            <div class="split-section" style="margin-top:8px;">
                <div class="title">轨迹回放</div>
                <div class="playback-actions" style="display:flex;gap:8px;margin-bottom:8px;">
                    <button id="playbackStartBtn" disabled>开始</button>
                    <button id="playbackPauseBtn" disabled>继续</button>
                    <button id="playbackStopBtn" disabled>结束</button>
                </div>
                <div class="playback-speed" style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                    <label>速度：
                        <select id="playbackSpeedSelect" disabled>
                            <option value="1" selected>1×</option>
                            <option value="2">2×</option>
                            <option value="4">4×</option>
                            <option value="8">8×</option>
                            <option value="16">16×</option>
                            <option value="32">32×</option>
                            <option value="64">64×</option>
                            <option value="128">128×</option>
                            <option value="256">256×</option>
                            <option value="512">512×</option>
                            <option value="1024">1024×</option>
                        </select>
                    </label>
                    <span id="playbackTimeLabel" style="font-size:12px;color:#666;">时间：—</span>
                </div>
                <div class="playback-time" style="display:flex;flex-direction:column;gap:4px;margin-bottom:8px;">
                    <label class="playback-time-label" style="display:flex;align-items:center;gap:8px;flex:1 1 auto;min-width:0;">
                        <span class="playback-time-text" style="white-space:nowrap;">起始时间：</span>
                        <input type="range" id="playbackTimeSlider" disabled min="0" max="0" step="1000" value="0" style="flex:1 1 auto;min-width:0;max-width:100%;vertical-align:middle;">
                    </label>
                    <span id="playbackTimeCursor" style="font-size:12px;color:#666;align-self:flex-end;">—</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let map;
    let currentPolygons = []; // 存储多边形和其标签
    let currentTracks = []; // 存储轨迹折线及相关覆盖物
    let mapLoaded = false;
    let mapLabelHandlers = []; // 存储地图事件处理器
    let labelsEnabled = false; // 标签显示开关（默认关闭）
    let isDrawing = false; // 绘制进行中防止重复点击

    window.onload = function () {
        if (typeof T === 'undefined') {
            alert("天地图API加载失败，请检查网络或密钥！");
            return;
        }
        initMap();
        bindDrawEvent();
        bindMinimizeEvent();
        bindTabs();
        bindBatchGenerator();
        bindMultiSplitter();
        bindLabelsToggle(); // 绑定标签显示开关
        bindTrackEvents();  // 绑定轨迹绘制与清空
        bindPlaybackControls(); // 绑定轨迹回放
    };

    function initMap() {
        showLoading();
        disableButtons(true);

        try {
            map = new T.Map("mapContainer", {
                zoom: 12,
                center: new T.LngLat(116.40769, 39.90403)
            });

            // 已移除测试标签
            map.enableScrollWheelZoom();

            // 添加地图类型控件
            const mapTypeCtrl = new T.Control.MapType({
                mapTypes: [TMAP_NORMAL_MAP, TMAP_SATELLITE_MAP, TMAP_TERRAIN_MAP],
                position: T_ANCHOR_TOP_LEFT
            });
            map.addControl(mapTypeCtrl);

            // 加载影像底图（卫星）
            const tk = "648f621977051d0199ff0f965d3fd322";

            // 方案1：使用默认地图类型（作为备选）
            map.setMapType(TMAP_SATELLITE_MAP);

            // 方案2：手动添加影像图层（底图 + 标注）
            const vecLayer = new T.TileLayer(`https://t0.tianditu.gov.cn/img_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=img&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`);
            const cvaLayer = new T.TileLayer(`https://t0.tianditu.gov.cn/cia_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cia&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`);

            // 添加图层并监听加载状态
            vecLayer.addEventListener("load", function () {
                console.log("影像底图加载完成");
            });

            vecLayer.addEventListener("error", function (e) {
                console.error("影像底图加载错误:", e);
                alert("影像底图加载错误，将使用默认地图类型");
            });

            map.addLayer(vecLayer);
            map.addLayer(cvaLayer);

            // 监听地图加载事件
            map.addEventListener("loaded", function () {
                console.log("地图加载完成");
                markMapLoaded();
            });
            map.addEventListener("load", function () {
                console.log("地图load事件触发");
                markMapLoaded();
            });
            map.addEventListener("tilesloaded", function () {
                console.log("地图瓦片加载完成");
                markMapLoaded();
            });
            // 监听地图加载失败事件
            map.addEventListener("error", function (e) {
                console.error("地图加载错误:", e);
                alert("地图加载错误: " + e.message);
                hideLoading();
            });

            // 监听地图移动事件，用于更新标签位置
            const moveHandler = function () {
                updateAllLabelsPosition();
            };
            map.addEventListener("move", moveHandler);
            map.addEventListener("zoom", moveHandler);

            // 存储事件处理器，用于清理
            mapLabelHandlers.push({ event: "move", handler: moveHandler });
            mapLabelHandlers.push({ event: "zoom", handler: moveHandler });

            // 超时容错
            setTimeout(() => {
                if (!mapLoaded) markMapLoaded();
            }, 8000);

        } catch (error) {
            alert("地图初始化失败：" + error.message);
            console.error(error);
            hideLoading();
        }
    }

    function markMapLoaded() {
        if (!mapLoaded) {
            mapLoaded = true;
            hideLoading();
            disableButtons(false);
            disableTrackButtons(false);
            // 仅开启速度选择，回放按钮按状态控制
            const speedSel = document.getElementById('playbackSpeedSelect');
            if (speedSel) speedSel.disabled = false;
            updatePlaybackButtonsState('idle');
        }
    }

    function showLoading() {
        const loading = document.getElementById("mapLoading");
        loading.style.display = "flex";
        loading.style.opacity = "1";
    }

    function hideLoading() {
        const loading = document.getElementById("mapLoading");
        loading.style.opacity = "0";
        setTimeout(() => loading.style.display = "none", 300);
    }

    function disableButtons(disabled) {
        document.getElementById("drawButton").disabled = disabled;
        document.getElementById("clearButton").disabled = disabled;
    }

    function disableTrackButtons(disabled) {
        const drawTrackBtn = document.getElementById("drawTrackButton");
        const showTrackPointsBtn = document.getElementById("showTrackPointsButton");
        const clearTrackBtn = document.getElementById("clearTrackButton");
        if (drawTrackBtn) drawTrackBtn.disabled = disabled;
        if (showTrackPointsBtn) showTrackPointsBtn.disabled = disabled;
        if (clearTrackBtn) clearTrackBtn.disabled = disabled;
    }
    // 回放控件的禁用/启用
    function disablePlaybackButtons(disabled) {
        ["playbackStartBtn","playbackPauseBtn","playbackStopBtn","playbackSpeedSelect","playbackTimeSlider"].forEach(id=>{
            const el = document.getElementById(id);
            if (el) el.disabled = disabled;
        });
    }

    // 回放按钮状态管理：空闲/播放/暂停
    function updatePlaybackButtonsState(state){
        try {
            const startBtn = document.getElementById('playbackStartBtn');
            const pauseBtn = document.getElementById('playbackPauseBtn');
            const stopBtn = document.getElementById('playbackStopBtn');
            if (!startBtn || !pauseBtn || !stopBtn) return;
            if (state === 'idle') {
                startBtn.disabled = false;
                pauseBtn.disabled = true;
                stopBtn.disabled = true;
                pauseBtn.textContent = '继续';
            } else if (state === 'playing') {
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
                pauseBtn.textContent = '暂停';
            } else if (state === 'paused') {
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
                pauseBtn.textContent = '继续';
            }
        } catch(e) { console.warn('更新按钮状态失败:', e); }
    }

    function bindDrawEvent() {
        document.getElementById("drawButton").addEventListener("click", function () {
            if (isDrawing) { console.log('绘制进行中，忽略重复点击'); return; }
            isDrawing = true;
            disableButtons(true);
            showLoading();
            try {
                const wktStr = document.getElementById("wktTextarea").value.trim();
                if (!wktStr) { alert("请输入WKT字符串！"); return; }
                clearOverlays();
                const geojson = parseWkt(wktStr);
    
                const polygonData = [];
                if (geojson.type === "Polygon") {
                    polygonData.push({ index: 1, coordinates: geojson.coordinates });
                } else if (geojson.type === "MultiPolygon") {
                    geojson.coordinates.forEach((polygon, index) => {
                        polygonData.push({ index: index + 1, coordinates: polygon });
                    });
                }
    
                // 重置并绘制
                polygonInfoList = [];
                polygonData.forEach(pd => processPolygon(pd.index, pd.coordinates));
    
                // 视图居中到所有已绘制轮廓
                try { fitViewportToPolygons(); } catch (e) { console.warn('视图居中失败', e); }
    
                // 在视图稳定后再创建/更新标签
                setTimeout(() => {
                    if (labelsEnabled) {
                        try {
                            createAllLabels();
                            updateAllLabelsPosition();
                        } catch (e) {
                            console.warn('创建或更新标签失败:', e);
                        }
                    }
                }, 150);
            } catch (e) {
                alert('绘制失败：' + (e && e.message ? e.message : e));
                console.error('绘制异常:', e);
            } finally {
                hideLoading();
                isDrawing = false;
                disableButtons(false);
            }
        });

        document.getElementById("clearButton").addEventListener("click", function () {
            if (isDrawing) { console.log('绘制进行中，暂不清空'); return; }
            clearOverlays();
            console.log("已清空所有轮廓");
        });
    }

    // 存储多边形数据，用于后续标签创建
    let polygonInfoList = [];

    // 处理单个多边形的绘制和面积计算
    function processPolygon(actualPolygonIndex, polygonCoords) {
        console.log('开始处理多边形', actualPolygonIndex);

        // 坐标系选择（绘制始终使用WGS84坐标）
        const coordSys = (document.getElementById('coordSysSelect') && document.getElementById('coordSysSelect').value) || 'wgs84';

        // 统一转换为WGS84用于绘制与面积计算
        function toWgs(point){
            const lng = point[0], lat = point[1];
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                return [lng, lat];
            } else if (coordSys === 'gcj02') {
                const w = gcj02ToWgs84(lng, lat);
                return [w.lng, w.lat];
            } else if (coordSys === 'bd09') {
                const gcj = bd09ToGcj02(lng, lat);
                const w = gcj02ToWgs84(gcj.lng, gcj.lat);
                return [w.lng, w.lat];
            }
            return [lng, lat];
        }
        const coordsWGS84 = polygonCoords.map(ring => ring.map(toWgs));
        let outerRingWGS = coordsWGS84[0] || [];

        // 生成用于绘制的坐标（直接使用WGS84坐标）
        const rings = coordsWGS84.map(ring => ring.map(([lng, lat]) => new T.LngLat(lng, lat)));


         // 创建半透明填充的多边形（无边框）
          const polygon = new T.Polygon(rings, {
              color: "#FFD700",
              weight: 1,
              opacity: 1,
              fillColor: "#FFFF00",
              fillOpacity: 0.35
          });
 
          // 使用WGS84坐标计算面积（更准确的面积计算）
         let areaSqm;
         let areaMu;



         try {
             // 检查Turf.js是否可用
             if (typeof turf !== 'undefined' && turf.area) {
                 // 使用Turf.js计算多边形面积
                // 构造GeoJSON格式的多边形
                const geoJsonPolygon = {
                    type: "Polygon",
                    coordinates: coordsWGS84
                };


                 // 使用Turf.js计算面积（平方米）
                 areaSqm = turf.area(geoJsonPolygon);
                 areaMu = (areaSqm / 666.6667).toFixed(4); // 转换为亩
                 console.log(`多边形${actualPolygonIndex}面积计算结果(Turf.js): ${areaSqm}平方米 = ${areaMu}亩`);
             } else {
                 // 如果Turf.js不可用，回退到之前的计算方法
                 console.warn('Turf.js不可用，使用备用计算方法');
                 // 计算带孔洞的多边形面积
                 areaSqm = 0;
                 // 计算外环面积
                 outerRingWGS = coordsWGS84[0] || [];
                 areaSqm += calculatePolygonArea(outerRingWGS);

                 // 减去内环（孔洞）面积
                 for (let i = 1; i < coordsWGS84.length; i++) {
                     const innerRingArea = calculatePolygonArea(coordsWGS84[i]);
                     areaSqm -= innerRingArea;
                 }

                  areaMu = (areaSqm / 666.6667).toFixed(4); // 使用更精确的转换系数
                  console.log(`多边形${actualPolygonIndex}面积计算结果(备用): ${areaSqm}平方米 = ${areaMu}亩`);
              }
          } catch (error) {
              console.error(`面积计算失败:`, error);
              areaSqm = 0;
              areaMu = '0.0000';
          }

          // 计算多边形的中心点和底部中心点（WGS84）
          const centerPoint = calculatePolygonCenter(outerRingWGS);
          const bottomCenterPoint = calculatePolygonBottomCenter(outerRingWGS);

          // 添加多边形到地图
          if (map) {
              map.addOverLay(polygon);
              console.log(`多边形${actualPolygonIndex}已添加到地图`);
          } else {
              console.error('地图对象不存在');
          }

          // 存储多边形信息，用于后续标签创建
          polygonInfoList.push({
              index: actualPolygonIndex,
              polygon: polygon,
              area: areaMu,
              bottomCenter: { lng: bottomCenterPoint.lng, lat: bottomCenterPoint.lat },
              ringPoints: rings
          });
      }

    // 视图居中：根据已绘制的GCJ-02点
    function fitViewportToPolygons() {
        const points = [];
        try {
            if (!map || !map.setViewport) return;
            polygonInfoList.forEach(info => {
                if (!info || !info.ringPoints) return;
                info.ringPoints.forEach(ring => {
                    ring.forEach(ll => points.push(ll));
                });
            });
            if (!points.length) return;
            map.setViewport(points);
        } catch (e) {
            try {
                const lngs = points.map(p => p.lng);
                const lats = points.map(p => p.lat);
                const center = new T.LngLat(
                    (Math.min(...lngs) + Math.max(...lngs)) / 2,
                    (Math.min(...lats) + Math.max(...lats)) / 2
                );
                if (map && map.panTo) map.panTo(center);
            } catch (e2) {
                console.warn('视图居中失败:', e2);
            }
        }
    }

    // 统一创建所有多边形的标签
    function createAllLabels() {
        const mapContainer = document.getElementById('mapContainer');
        if (!mapContainer || !map) return;

        polygonInfoList.forEach(info => {
            if (!info) return;
            // 防止重复创建
            if (info.labelRef) return;
            // 创建标签元素
            const labelDiv = document.createElement('div');
            labelDiv.className = 'area-label';
            labelDiv.innerHTML = `多边形${info.index}：${info.area}亩`;

            // 添加到地图容器并根据屏幕边界定位到轮廓下方
            mapContainer.appendChild(labelDiv);
            positionLabelForPolygon(labelDiv, info);

            // 记录引用，避免重复创建
            info.labelRef = labelDiv;

            // 存储到 currentPolygons 以复用现有定位/清理逻辑
            const labelObj = {
                domElement: labelDiv,
                isDomLabel: true,
                polygonInfo: info
            };
            currentPolygons.push({ polygon: info.polygon, label: labelObj });
        });

        // 不清空 polygonInfoList，便于开关随时创建/隐藏标签
    }

    // 根据多边形屏幕边界定位标签，保证始终在轮廓下方
    function positionLabelForPolygon(labelDiv, info) {
        if (!map || !info || !info.ringPoints) return;
        const points = [];
        info.ringPoints.forEach(ring => {
            ring.forEach(ll => {
                const p = map.lngLatToContainerPoint(ll);
                points.push(p);
            });
        });
        if (!points.length) return;
        const minX = Math.min(...points.map(p => p.x));
        const maxX = Math.max(...points.map(p => p.x));
        const maxY = Math.max(...points.map(p => p.y));
        const container = document.getElementById('mapContainer');
        const labelWidth = labelDiv.offsetWidth;
        const labelHeight = labelDiv.offsetHeight;
        const targetLeft = Math.round((minX + maxX) / 2 - labelWidth / 2);
        const targetTop = Math.round(maxY + 6);
        const clampedLeft = Math.max(0, Math.min(targetLeft, container.clientWidth - labelWidth));
        const clampedTop = Math.max(0, Math.min(targetTop, container.clientHeight - labelHeight));
        labelDiv.style.left = clampedLeft + 'px';
        labelDiv.style.top = clampedTop + 'px';
    }

    // 更新所有标签位置（地图move/zoom时调用）
    function updateAllLabelsPosition() {
        try {
            if (!map) return;
            const container = document.getElementById('mapContainer');
            if (!container) return;
            currentPolygons.forEach(item => {
                if (!item || !item.label) return;
                const labelObj = item.label;
                if (labelObj.isDomLabel && labelObj.domElement && labelObj.polygonInfo) {
                    // 确保标签在容器中
                    if (!labelObj.domElement.parentNode) {
                        container.appendChild(labelObj.domElement);
                    }
                    positionLabelForPolygon(labelObj.domElement, labelObj.polygonInfo);
                }
            });
        } catch (e) {
            console.warn('更新标签位置时出错:', e);
        }
    }
    // 确保在全局可用（处理第三方库事件回调作用域差异）
    window.updateAllLabelsPosition = updateAllLabelsPosition;

    // 绑定“显示亩数标签”开关（默认隐藏）
    function bindLabelsToggle() {
        const cb = document.getElementById('toggleLabelsCheckbox');
        const container = document.getElementById('mapContainer');
        if (!cb || !container) return;
        // 默认隐藏标签
        container.classList.add('labels-hidden');
        cb.addEventListener('change', () => {
            labelsEnabled = cb.checked;
            if (labelsEnabled) {
                container.classList.remove('labels-hidden');
                const hasAnyLabel = currentPolygons.some(item => item && item.label && item.label.domElement);
                if (!hasAnyLabel) {
                    try { createAllLabels(); } catch (e) { console.warn('创建标签失败:', e); }
                }
                updateAllLabelsPosition();
            } else {
                container.classList.add('labels-hidden');
            }
        });
    }

    /**
     * 计算多边形中心点（比底部中心更适合显示标签）
     */
    function calculatePolygonCenter(outerRing) {
        let sumLng = 0, sumLat = 0;
        const len = outerRing.length;

        for (let i = 0; i < len; i++) {
            sumLng += outerRing[i][0];
            sumLat += outerRing[i][1];
        }

        return {
            lng: sumLng / len,
            lat: sumLat / len
        };
    }

    /**
     * 计算多边形面积（球面多边形面积计算）
     * 使用更准确的球面坐标面积计算方法，确保面积与视觉大小一致
     */
    function calculatePolygonArea(coordinates) {
        // 地球半径（米）- 使用更精确的值
        const R = 6371000.8;
        const n = coordinates.length;

        // 将所有坐标转换为弧度
        const coordsRad = coordinates.map(point => [
            point[0] * Math.PI / 180,
            point[1] * Math.PI / 180
        ]);

        let areaRad = 0;

        // 使用更准确的球面多边形面积公式（Girard定理）
        for (let i = 0; i < n; i++) {
            const j = (i + 1) % n;
            const lon1 = coordsRad[i][0];
            const lat1 = coordsRad[i][1];
            const lon2 = coordsRad[j][0];
            const lat2 = coordsRad[j][1];

            // 计算球面多边形面积增量
            const dlon = lon2 - lon1;
            const sinLat1 = Math.sin(lat1);
            const sinLat2 = Math.sin(lat2);
            const cosLat1 = Math.cos(lat1);
            const cosLat2 = Math.cos(lat2);

            // 使用更精确的公式
            areaRad += dlon * (sinLat1 * cosLat2 * Math.cos(dlon / 2) + sinLat2 * cosLat1);
        }

        // 计算总面积（平方米）
        const areaSqm = Math.abs(areaRad) * R * R * 0.5;

        return areaSqm;
    }

    /**
     * 清空所有多边形和标签（同时处理 polygonInfoList 与 currentPolygons）
     */
    function clearOverlays() {
        try {
            // 先移除 polygonInfoList 中记录的多边形与其DOM标签
            polygonInfoList.forEach(info => {
                if (info && info.polygon && map && map.removeOverLay) {
                    try { map.removeOverLay(info.polygon); } catch (e) { console.warn('移除多边形失败:', e); }
                }
                if (info && info.labelRef && info.labelRef.parentNode) {
                    try { info.labelRef.parentNode.removeChild(info.labelRef); } catch (e) { console.warn('移除DOM标签失败:', e); }
                    info.labelRef = null;
                }
            });

            // 再处理 currentPolygons（兼容旧路径与标签对象）
            currentPolygons.forEach(item => {
                if (item.polygon && map && map.removeOverLay) {
                    try { map.removeOverLay(item.polygon); } catch (e) { console.warn('移除多边形失败:', e); }
                }
                if (item.label) {
                    if (item.label.domElement && item.label.domElement.parentNode) {
                        try { item.label.domElement.parentNode.removeChild(item.label.domElement); } catch (e) { console.warn('移除DOM标签失败:', e); }
                    } else if (map && map.removeOverLay && !item.label.isDomLabel) {
                        try { map.removeOverLay(item.label); } catch (e) { console.warn('移除地图覆盖物标签失败:', e); }
                    }
                }
            });

            // 清空记录数组
            currentPolygons = [];
            polygonInfoList = [];

            console.log('已清空所有多边形和标签（保留事件监听器）');
        } catch (error) {
            console.error('清空覆盖物时出错:', error);
        }
    }

    // 其他辅助函数（保持不变）
    function bindMinimizeEvent() {
        const container = document.querySelector(".wkt-input-container");
        const btn = document.getElementById("minimizeBtn");
        const minIcon = btn?.querySelector(".min-icon");
        const restoreIcon = btn?.querySelector(".restore-icon");

        btn?.addEventListener("click", () => {
            const minimized = container.classList.toggle("minimized");
            if (minIcon && restoreIcon) {
                if (minimized) {
                    minIcon.style.display = "none";
                    restoreIcon.style.display = "";
                } else {
                    minIcon.style.display = "";
                    restoreIcon.style.display = "none";
                }
            }
        });
    }

    // 在脚本内部补充：页签切换（3个页签）
     function bindTabs() {
         const tabs = [
             { btn: document.getElementById('tabDrawBtn'), pane: document.getElementById('tabDraw'), key: 'draw' },
             { btn: document.getElementById('tabTrackBtn'), pane: document.getElementById('tabTrack'), key: 'track' },
             { btn: document.getElementById('tabSplitBtn'), pane: document.getElementById('tabSplit'), key: 'split' },
             { btn: document.getElementById('tabBatchBtn'), pane: document.getElementById('tabBatch'), key: 'batch' },
         ];
         if (tabs.some(t => !t.btn || !t.pane)) return;
         function activate(key) {
             tabs.forEach(t => {
                 const active = t.key === key;
                 t.btn.classList.toggle('active', active);
                 t.pane.classList.toggle('active', active);
             });
         }
         tabs.forEach(t => t.btn.addEventListener('click', () => activate(t.key)));
         activate('draw');
     }
    function updateParserStatus() {
        const el = document.getElementById('parserStatus');
        if (!el) return;
        const ok = (typeof Terraformer !== 'undefined' && Terraformer.WKT && typeof Terraformer.WKT.parse === 'function');
        if (ok) {
            el.textContent = 'Terraformer WKT Parser';
            el.style.color = '#2f8f2f';
        } else {
            el.textContent = '本地回退解析（仅支持POLYGON/MULTIPOLYGON）';
            el.style.color = '#c77d1e';
        }
    }
     function parseWkt(wkt) {
         wkt = wkt.trim();
         // 优先使用成熟库（Terraformer WKT Parser）
         if (typeof Terraformer !== 'undefined' && Terraformer.WKT && Terraformer.WKT.parse) {
             try {
                 return Terraformer.WKT.parse(wkt);
             } catch (e) {
                 console.warn('Terraformer解析失败，尝试本地回退解析:', e);
             }
         } else {
             // 不再提示“未加载”，由状态栏展示回退信息
         }
         // 回退解析：仅支持 POLYGON / MULTIPOLYGON
         const typeMatch = wkt.match(/^\s*(POLYGON|MULTIPOLYGON)\s*\(/i);
         if (!typeMatch) throw new Error('仅支持POLYGON/MULTIPOLYGON');
         const type = typeMatch[1].toUpperCase();
         const inner = wkt.substring(wkt.indexOf('('));
         if (type === 'POLYGON') {
             const coords = parsePolygonCoords(inner.replace(/^\(/, '').replace(/\)$/, ''));
             return { type: 'Polygon', coordinates: coords };
         } else {
             const trimmed = inner.replace(/^\(\(/, '').replace(/\)\)$/, '');
             const coords = parseMultiPolygonCoords(trimmed);
             return { type: 'MultiPolygon', coordinates: coords };
         }
     }

     function bindMultiSplitter() {
         const input = document.getElementById('multiInput');
         const output = document.getElementById('polyOutput');
         const splitBtn = document.getElementById('splitMultiBtn');
         const copyBtn = document.getElementById('copyPolysBtn');
         if (!input || !output || !splitBtn || !copyBtn) return;

         // 本地WKT序列化辅助
         function ringToText(ring) {
             if (!ring || !ring.length) return '()';
             const first = ring[0];
             const last = ring[ring.length - 1];
             const closed = (first[0] === last[0] && first[1] === last[1]) ? ring : ring.concat([[first[0], first[1]]]);
             return '(' + closed.map(pt => pt[0] + ' ' + pt[1]).join(', ') + ')';
         }
         function toWktPolygonCoords(coords) {
             return 'POLYGON(' + coords.map(ringToText).join(', ') + ')';
         }
         function toWktMulti(coords) {
             return 'MULTIPOLYGON(' + coords.map(poly => '(' + poly.map(ringToText).join(', ') + ')').join(', ') + ')';
         }

         function polygonsFromMulti(text) {
             const geo = parseWkt(text.trim());
             if (geo.type !== 'MultiPolygon') throw new Error('请输入有效的 MULTIPOLYGON WKT');
             const polys = geo.coordinates.map(rings => toWktPolygonCoords(rings));
             return polys;
         }
         splitBtn.addEventListener('click', () => {
             try {
                 const list = polygonsFromMulti(input.value.trim());
                 output.value = list.join('\n');
             } catch (e) {
                 alert('分割失败：' + e.message);
             }
         });
         copyBtn.addEventListener('click', async () => {
             const val = output.value.trim();
             if (!val) { alert('没有可复制的结果'); return; }
             try { await navigator.clipboard.writeText(val); alert('已复制到剪贴板'); } catch (e) { console.warn('复制失败', e); }
         });
     }

     function bindBatchGenerator() {
         const batchInput = document.getElementById('batchInput');
         const output = document.getElementById('multiOutput');
         const genBtn = document.getElementById('generateMultiBtn');
         const copyBtn = document.getElementById('copyMultiBtn');

         // 本地WKT序列化辅助（与分割器保持一致）
         function ringToText(ring) {
             if (!ring || !ring.length) return '()';
             const first = ring[0];
             const last = ring[ring.length - 1];
             const closed = (first[0] === last[0] && first[1] === last[1]) ? ring : ring.concat([[first[0], first[1]]]);
             return '(' + closed.map(pt => pt[0] + ' ' + pt[1]).join(', ') + ')';
         }
         function toWktMulti(coords) {
             return 'MULTIPOLYGON(' + coords.map(poly => '(' + poly.map(ringToText).join(', ') + ')').join(', ') + ')';
         }

         genBtn.addEventListener('click', () => {
             try {
                 const lines = batchInput.value.trim().split(/\n|;/).map(s => s.trim()).filter(Boolean);
                 if (lines.length === 0) throw new Error('请按每行或分号输入至少一个POLYGON');
                 const polygons = lines.map((line, idx) => {
                     const g = parseWkt(line);
                     if (g.type !== 'Polygon') throw new Error(`第${idx + 1}行不是有效的POLYGON WKT`);
                     return g;
                 });
                 const multiGeo = { type: 'MultiPolygon', coordinates: polygons.map(p => p.coordinates) };
                 output.value = toWktMulti(multiGeo.coordinates);
             } catch (e) {
                 alert('生成失败：' + e.message);
             }
         });

         copyBtn.addEventListener('click', async () => {
             const val = output.value.trim();
             if (!val) { alert('没有可复制的结果'); return; }
             try { await navigator.clipboard.writeText(val); alert('已复制到剪贴板'); } catch (e) { console.warn('复制失败', e); }
         });

     }

     function setExampleWkt() {
         const exampleWkt = "MULTIPOLYGON(" +
             "(" +
             "(116.35 39.93, 116.39 39.93, 116.39 39.90, 116.35 39.90, 116.35 39.93)," + // 外环
             "(116.36 39.92, 116.38 39.92, 116.38 39.91, 116.36 39.91, 116.36 39.92)" +  // 内环
             ")," +
             "(" +
             "(116.40 39.95, 116.43 39.97, 116.46 39.96, 116.49 39.98, 116.52 39.95, 116.55 39.93, 116.58 39.94, 116.61 39.92, 116.64 39.95, 116.40 39.95)" +
             ")" +
             ")";
         document.getElementById("wktTextarea").value = exampleWkt;
     }

     function parsePolygonCoords(coordStr) {
         const ringStrs = coordStr.split(/\)\s*,\s*\(/).map(s => s.replace(/[()]/g, '').trim());
         const rings = [];
         ringStrs.forEach(ringStr => {
             const pts = ringStr.split(/,\s*/).map(pointStr => {
                 const [lng, lat] = pointStr.split(/\s+/).map(Number);
                 if (isNaN(lng) || isNaN(lat)) throw new Error("坐标格式错误：" + pointStr);
                 return [lng, lat];
             });
             // 自动拆分：如果一个ring中包含多次回到起点（闭合），则拆分为多个环
             // 兼容用户将外环与内环错误地写在同一对括号中的情况
             let start = 0;
             while (start < pts.length) {
                 const startPt = pts[start];
                 let closeIdx = -1;
                 for (let i = start + 1; i < pts.length; i++) {
                     if (pts[i][0] === startPt[0] && pts[i][1] === startPt[1]) {
                         closeIdx = i;
                         break;
                     }
                 }
                 if (closeIdx === -1) {
                     // 未找到闭合：将剩余点视为一个环，并强制闭合
                     const ring = pts.slice(start);
                     if (ring.length && (ring[0][0] !== ring[ring.length - 1][0] || ring[0][1] !== ring[ring.length - 1][1])) {
                         ring.push([ring[0][0], ring[0][1]]);
                     }
                     rings.push(ring);
                     break;
                 } else {
                     const ring = pts.slice(start, closeIdx + 1);
                     rings.push(ring);
                     start = closeIdx + 1;
                 }
             }
         });
         return rings;
     }

     function parseMultiPolygonCoords(coordStr) {
         const polygonStrs = coordStr.split(/\)\s*\)\s*,\s*\(\s*\(/).map(s => s.replace(/[()]/g, '').trim());
         return polygonStrs.map(polygonStr => parsePolygonCoords(polygonStr));
     }

     function wgs84ToGcj02(lng, lat) {
         const x_PI = 3.14159265358979324 * 3000.0 / 180.0;
         const PI = 3.1415926535897932384626;
         const a = 6378245.0;
         const ee = 0.00669342162296594323;

         if (outOfChina(lng, lat)) return { lng, lat };

         let dlat = transformLat(lng - 105.0, lat - 35.0);
         let dlng = transformLng(lng - 105.0, lat - 35.0);
         const radlat = lat / 180.0 * PI;
         let magic = Math.sin(radlat);
         magic = 1 - ee * magic * magic;
         const sqrtmagic = Math.sqrt(magic);
         dlat = (dlat * 180.0) / ((a * (1 - ee)) / (magic * sqrtmagic) * PI);
         dlng = (dlng * 180.0) / (a / sqrtmagic * Math.cos(radlat) * PI);

         return { lng: lng + dlng, lat: lat + dlat };

         function outOfChina(lng, lat) {
             return (lng < 72.004 || lng > 137.8347) || (lat < 0.8293 || lat > 55.8271);
         }

         function transformLat(x, y) {
             let ret = -100.0 + 2.0 * x + 3.0 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * Math.sqrt(Math.abs(x));
             ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
             ret += (20.0 * Math.sin(y * PI) + 40.0 * Math.sin(y / 3.0 * PI)) * 2.0 / 3.0;
             ret += (160.0 * Math.sin(y / 12.0 * PI) + 320 * Math.sin(y * PI / 30.0)) * 2.0 / 3.0;
             return ret;
         }

         function transformLng(x, y) {
             let ret = 300.0 + x + 2.0 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * Math.sqrt(Math.abs(x));
             ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
             ret += (20.0 * Math.sin(x * PI) + 40.0 * Math.sin(x / 3.0 * PI)) * 2.0 / 3.0;
             ret += (150.0 * Math.sin(x / 12.0 * PI) + 300.0 * Math.sin(x / 30.0 * PI)) * 2.0 / 3.0;
             return ret;
         }
     }

     function gcj02ToWgs84(lng, lat) {
         const g = wgs84ToGcj02(lng, lat);
         return { lng: lng * 2 - g.lng, lat: lat * 2 - g.lat };
     }

     function bd09ToGcj02(bdLng, bdLat) {
         const x_PI = 3.14159265358979324 * 3000.0 / 180.0;
         const x = bdLng - 0.0065;
         const y = bdLat - 0.006;
         const z = Math.sqrt(x * x + y * y) - 0.00002 * Math.sin(y * x_PI);
         const theta = Math.atan2(y, x) - 0.000003 * Math.cos(x * x_PI);
         const ggLng = z * Math.cos(theta);
         const ggLat = z * Math.sin(theta);
         return { lng: ggLng, lat: ggLat };
     }

     function calculatePolygonBottomCenter(outerRing) {
         let minLat = Infinity;
         let bottomPoints = [];
         outerRing.forEach(point => {
             const lat = point[1];
             if (lat < minLat) {
                 minLat = lat;
                 bottomPoints = [point];
             } else if (lat === minLat) {
                 bottomPoints.push(point);
             }
         });

         const sumLng = bottomPoints.reduce((sum, point) => sum + point[0], 0);
         const centerLng = sumLng / bottomPoints.length;

         return { lng: centerLng, lat: minLat };
     }

     function fitBounds(geojson) {
         try {
             const allPoints = [];
             function collectPoints(coords) {
                 if (typeof coords[0] === 'number') {
                     allPoints.push(coords);
                 } else {
                     coords.forEach(coord => collectPoints(coord));
                 }
             }
             collectPoints(geojson.coordinates);

             if (allPoints.length === 0) return;

             const lats = allPoints.map(p => p[1]);
             const lngs = allPoints.map(p => p[0]);
             const minLng = Math.min(...lngs);
             const maxLng = Math.max(...lngs);
             const minLat = Math.min(...lats);
             const maxLat = Math.max(...lats);

             const sw = wgs84ToGcj02(minLng, minLat);
             const ne = wgs84ToGcj02(maxLng, maxLat);

             // 修复setViewport方法的使用，确保参数格式正确
             if (map && map.setViewport) {
                 map.setViewport([
                     new T.LngLat(sw.lng, sw.lat),
                     new T.LngLat(ne.lng, ne.lat)
                 ], { padding: [50, 50] });
             } else {
                 console.warn('地图对象或setViewport方法不可用');
             }
         } catch (error) {
             console.error('调整视图范围时出错:', error);
         }
     }
// 轨迹绘制与解析
    function bindTrackEvents() {
        const drawBtn = document.getElementById('drawTrackButton');
        const showPointsBtn = document.getElementById('showTrackPointsButton');
        const clearBtn = document.getElementById('clearTrackButton');
        const ta = document.getElementById('trackTextarea');
        if (!drawBtn || !showPointsBtn || !clearBtn || !ta) return;

        drawBtn.addEventListener('click', function(){
            try {
                const text = ta.value.trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const points = parseTrackText(text);
                if (points.length < 2) { alert('有效轨迹点不足，至少需要两点'); return; }
                drawTrackFromPoints(points);
                fitViewportToTrack(points);
            } catch (e) {
                alert('绘制轨迹失败：' + (e && e.message ? e.message : e));
                console.error('绘制轨迹异常:', e);
            }
        });

        showPointsBtn.addEventListener('click', function(){
            try {
                const text = ta.value.trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const points = parseTrackText(text);
                if (points.length === 0) { alert('未找到有效轨迹点'); return; }
                showTrackPoints(points);
                fitViewportToTrack(points);
            } catch (e) {
                alert('显示轨迹点失败：' + (e && e.message ? e.message : e));
                console.error('显示轨迹点异常:', e);
            }
        });

        clearBtn.addEventListener('click', function(){
            clearTrackOverlays();
            console.log('已清空轨迹');
        });
    }

    function showTrackPoints(points) {
        // 先移除旧轨迹（不影响轮廓）
        clearTrackOverlays(false);
        
        if (!map || !points || points.length === 0) {
            console.log('无轨迹点可显示');
            return;
        }
        
        console.log(`准备显示${points.length}个轨迹点`);
        
        // 使用批量处理和更小的图标来提高性能
        // 创建一个更小的红点SVG图标
        const smallRedDotIcon = new T.Icon({
            iconUrl: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1" height="1"><circle cx="0.5" cy="0.5" r="0.3" fill="%23FF0000"/></svg>',
            iconSize: new T.Point(1, 1),
            iconAnchor: new T.Point(0.5, 0.5)
        });
        
        // 优化批量添加点的速度
        const batchSize = 2000; // 增加每批处理的点数
        const concurrentBatches = 4; // 并发批次数量
        
        // 预创建点击事件处理函数，避免重复创建
        function createClickHandler(point, index) {
            return function() {
                const infoWindow = new T.InfoWindow({
                    content: `点${index + 1}<br/>经度: ${point.lng.toFixed(6)}<br/>纬度: ${point.lat.toFixed(6)}`,
                    offset: new T.Point(0, -20)
                });
                infoWindow.open(map, point);
            };
        }
        
        // 使用setTimeout实现更高效的批量添加，避免阻塞UI
        let currentIndex = 0;
        
        function addBatch() {
            if (currentIndex >= points.length) {
                console.log(`已显示${points.length}个轨迹点`);
                return;
            }
            
            // 添加当前批次的点
            const endIndex = Math.min(currentIndex + batchSize, points.length);
            const markersToAdd = [];
            
            // 先创建所有标记
            for (let i = currentIndex; i < endIndex; i++) {
                const point = points[i];
                const index = i;
                
                const marker = new T.Marker(point, {
                    icon: smallRedDotIcon
                });
                
                // 添加点击事件
                marker.addEventListener('click', createClickHandler(point, index));
                
                markersToAdd.push(marker);
            }
            
            // 批量添加到地图和数组
            markersToAdd.forEach(marker => {
                map.addOverLay(marker);
                currentTracks.push(marker);
            });
            
            currentIndex = endIndex;
            
            // 使用setTimeout而不是requestAnimationFrame，减少对渲染周期的依赖
            // 设置为0，将任务放入微任务队列，但允许UI有短暂的呼吸空间
            setTimeout(addBatch, 0);
        }
        
        // 启动批量添加
        addBatch();
    }
    
    // 恢复原始的clearTrackOverlays函数
    function clearTrackOverlays(resetArray = true){        
        try {
            currentTracks.forEach(pl => {
                if (pl && map && map.removeOverLay) {
                    try { map.removeOverLay(pl); } catch (e) { console.warn('移除轨迹失败:', e); }
                }
            });
            if (resetArray) currentTracks = [];
        } catch (e) {
            console.warn('清空轨迹时出错:', e);
        }
    }

    function parseTrackText(text){
        // 选择输入坐标系（优先使用轨迹页签专属选择器，若未设置则回退到绘制页签选择器）
        const coordSysEl = document.getElementById('trackCoordSysSelect') || document.getElementById('coordSysSelect');
        const coordSys = (coordSysEl && coordSysEl.value) || 'wgs84';
        const isHash = text.indexOf('#') !== -1;
        const items = isHash ? text.split('#') : text.split(/\r?\n/);
        const pts = [];
        for (let i=0;i<items.length;i++){
            const raw = items[i];
            if (!raw) continue;
            const line = raw.trim();
            if (!line) continue;
            const parts = line.split(',');
            if (parts.length < 3) continue;
            let lng = parseFloat((parts[isHash ? 0 : 1] || '').trim());
            let lat = parseFloat((parts[isHash ? 1 : 2] || '').trim());
            // 初步过滤：数值合法性与正常范围
            if (!isFinite(lng) || !isFinite(lat)) continue;
            if (lng === 0 || lat === 0) continue; // 丢弃0.0异常点
            if (lng < -180 || lng > 180 || lat < -90 || lat > 90) continue; // 超出经纬度范围丢弃

            // 将输入坐标转换为WGS84
            let w;
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                w = { lng, lat };
            } else if (coordSys === 'gcj02') {
                w = gcj02ToWgs84(lng, lat);
            } else if (coordSys === 'bd09') {
                const g = bd09ToGcj02(lng, lat);
                w = gcj02ToWgs84(g.lng, g.lat);
            } else {
                w = { lng, lat };
            }
            // 转换结果兜底检查
            if (!isFinite(w.lng) || !isFinite(w.lat)) continue;
            if (w.lng < -180 || w.lng > 180 || w.lat < -90 || w.lat > 90) continue;

            // 使用WGS84坐标绘制到地图
            pts.push(new T.LngLat(w.lng, w.lat));
        }
        return pts;
    }

    function drawTrackFromPoints(points){
        // 先移除旧轨迹（不影响轮廓）
        clearTrackOverlays(false);
        const polyline = new T.Polyline(points, {
            color: '#FF3B30',
            weight: 1,
            opacity: 0.9
        });
        if (map) {
            map.addOverLay(polyline);
        }
        currentTracks.push(polyline);
    }

    function clearTrackOverlays(resetArray = true){
        try {
            currentTracks.forEach(pl => {
                if (pl && map && map.removeOverLay) {
                    try { map.removeOverLay(pl); } catch (e) { console.warn('移除轨迹失败:', e); }
                }
            });
            if (resetArray) currentTracks = [];
        } catch (e) {
            console.warn('清空轨迹时出错:', e);
        }
    }


    function fitViewportToTrack(points){
        try {
            if (!map || !map.setViewport || !points || !points.length) return;
            map.setViewport(points);
        } catch (e) {
            console.warn('轨迹视图居中失败:', e);
        }
    }

    // ========= 轨迹回放功能 =========
    let playbackState = { points: [], idx: 0, speed: 1, timer: null, running: false, marker: null, line: null, path: [] };

    function bindPlaybackControls(){
        const startBtn = document.getElementById('playbackStartBtn');
        const pauseBtn = document.getElementById('playbackPauseBtn');
        const stopBtn = document.getElementById('playbackStopBtn');
        const speedSel = document.getElementById('playbackSpeedSelect');
        const timeSlider = document.getElementById('playbackTimeSlider');
        const timeCursor = document.getElementById('playbackTimeCursor');
        const ta = document.getElementById('trackTextarea');
        if (!startBtn || !pauseBtn || !stopBtn || !speedSel) return;

        // 初始按钮状态
        updatePlaybackButtonsState('idle');

        startBtn.addEventListener('click', function(){
            try {
                const text = (ta && ta.value || '').trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const pts = parseTrackTextWithTime(text);
                if (pts.length < 2) { alert('有效轨迹点不足，至少需要两点'); return; }
                startPlayback(pts);
                // 状态在startPlayback中已设置为playing
            } catch (e) {
                alert('开始回放失败：' + (e && e.message ? e.message : e));
                console.error('开始回放异常:', e);
            }
        });

        pauseBtn.addEventListener('click', function(){
            if (!playbackState.running) {
                // 继续
                playbackState.running = true;
                scheduleNext();
                updatePlaybackButtonsState('playing');
            } else {
                // 暂停
                if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
                playbackState.running = false;
                updatePlaybackButtonsState('paused');
            }
        });

        stopBtn.addEventListener('click', function(){ 
            stopPlayback(); 
            updatePlaybackButtonsState('idle');
        });

        speedSel.addEventListener('change', function(){
            const v = parseFloat(speedSel.value);
            playbackState.speed = (isFinite(v) && v > 0) ? v : 1;
        });

        if (timeSlider) {
            timeSlider.addEventListener('input', function(){
                const ms = parseInt(timeSlider.value, 10);
                const txt = formatTimeForLabel(ms);
                if (timeCursor) timeCursor.textContent = txt;
            });
            timeSlider.addEventListener('change', function(){
                jumpToSliderTime();
            });
        }
    }

    function parseTrackTextWithTime(text){
        const coordSysEl = document.getElementById('trackCoordSysSelect') || document.getElementById('coordSysSelect');
        const coordSys = (coordSysEl && coordSysEl.value) || 'wgs84';
        const isHash = text.indexOf('#') !== -1;
        const items = isHash ? text.split('#') : text.split(/\r?\n/);
        const out = [];
        for (let i=0;i<items.length;i++){
            const raw = items[i];
            if (!raw) continue;
            const line = raw.trim();
            if (!line) continue;
            const parts = line.split(',');
            if (parts.length < 3) continue;
            const tsRaw = (parts[isHash ? 2 : 0] || '').trim();
            const ts = (tsRaw || '').replace(/\D/g,'');
            let lng = parseFloat((parts[isHash ? 0 : 1] || '').trim());
            let lat = parseFloat((parts[isHash ? 1 : 2] || '').trim());
            if (!isFinite(lng) || !isFinite(lat)) continue;
            if (lng === 0 || lat === 0) continue;
            if (lng < -180 || lng > 180 || lat < -90 || lat > 90) continue;
            const t = parseTimestamp(ts);
            if (!t) continue;
            let w;
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                w = { lng, lat };
            } else if (coordSys === 'gcj02') {
                w = gcj02ToWgs84(lng, lat);
            } else if (coordSys === 'bd09') {
                const g = bd09ToGcj02(lng, lat);
                w = gcj02ToWgs84(g.lng, g.lat);
            } else { w = { lng, lat }; }
            if (!isFinite(w.lng) || !isFinite(w.lat)) continue;
            if (w.lng < -180 || w.lng > 180 || w.lat < -90 || w.lat > 90) continue;
            out.push({ ll: new T.LngLat(w.lng, w.lat), time: t, ts });
        }
        out.sort((a,b)=>a.time - b.time);
        return out;
    }

    function parseTimestamp(ts){
        const tstr = (ts || '').replace(/\D/g,'');
        const m = tstr && tstr.match(/^\d{14}$/);
        if (!m) return null;
        const y = parseInt(tstr.slice(0,4),10);
        const M = parseInt(tstr.slice(4,6),10) - 1;
        const d = parseInt(tstr.slice(6,8),10);
        const h = parseInt(tstr.slice(8,10),10);
        const m2 = parseInt(tstr.slice(10,12),10);
        const s = parseInt(tstr.slice(12,14),10);
        const dt = new Date(y,M,d,h,m2,s);
        return isNaN(dt.getTime()) ? null : dt;
    }

    function startPlayback(points){
        console.log('[Playback] startPlayback: 点数=', points && points.length);
        stopPlayback();
        playbackState.points = points;
        playbackState.idx = 0;
        playbackState.speed = playbackState.speed || 1;
        playbackState.running = true;
        // 配置时间滑动条，并尊重现有滑块位置作为起始
        configureTimeSlider(points);
        // 启用滑块
        const slider = document.getElementById('playbackTimeSlider');
        if (slider) slider.disabled = false;
        let initIdx = 0;
        if (slider && slider.min && slider.max) {
            const ms = parseInt(slider.value, 10);
            if (isFinite(ms)) initIdx = findIndexByTime(points, ms);
        }
        playbackState.idx = initIdx;
        const first = points[initIdx];
        console.log('[Playback] 首点:', first && first.ts, first && first.ll, 'initIdx=', initIdx);
        playbackState.path = points.slice(0, initIdx+1).map(p=>p.ll);
        playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 1, opacity: 0.9 });
        if (map) {
            map.addOverLay(playbackState.line);
        }
        currentTracks.push(playbackState.line);
        // 创建并定位DOM标记以保证可见移动
        ensurePlaybackDom(first.ll);
        updatePlaybackDom(first.ll);
        updatePlaybackTimeLabel(first.ts);
        try { fitViewportToTrack(points.map(p=>p.ll)); } catch(e){}
        // 更新按钮状态
        updatePlaybackButtonsState('playing');
        scheduleNext();
    }

    function scheduleNext(){
        if (!playbackState.running) return;
        if (!playbackState.points || playbackState.idx >= playbackState.points.length - 1) {
            playbackState.running = false;
            console.log('[Playback] 回放结束：idx=', playbackState.idx, '点数=', playbackState.points ? playbackState.points.length : 0);
            updatePlaybackButtonsState('idle'); // 播放结束后按钮回到初始状态：开始可点，继续/结束灰化
            return;
        }
        const next = playbackState.points[playbackState.idx+1];
        const speed = playbackState.speed || 1;
        const delay = Math.max(4, Math.round(1000 / speed)); // 1x=1000ms/点，2x=500ms/点...
        console.log('[Playback] scheduleNext: idx=', playbackState.idx, '->', playbackState.idx+1, 'delay=', delay, 'speed=', speed);
        playbackState.timer = setTimeout(()=>{
            playbackState.idx++;
            const nextLL = next.ll;
            console.log('[Playback] 下一点:', next && next.ts, nextLL);
            try {
                // 维护路径数组
                playbackState.path = playbackState.path || [];
                playbackState.path.push(nextLL);
                console.log('[Playback] 路径长度=', playbackState.path.length);
                // 使用DOM标记进行移动（容器/图层坐标）
                if (!playbackDom.el) console.log('[Playback] DOM标记不存在，将尝试创建');
                updatePlaybackDom(nextLL);
                // 折线更新：优先setLngLats，兜底重建
                if (playbackState.line && typeof playbackState.line.setLngLats === 'function') {
                    try { playbackState.line.setLngLats(playbackState.path); }
                    catch(e){
                        console.warn('[Playback] setLngLats失败，重建折线', e);
                        if (map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                        playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 1, opacity: 0.9 });
                        if (map) map.addOverLay(playbackState.line);
                    }
                } else {
                    console.log('[Playback] 折线不支持setLngLats，重建');
                    if (playbackState.line && map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                    playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 1, opacity: 0.9 });
                    if (map) map.addOverLay(playbackState.line);
                }
            } catch(e) { console.warn('更新回放覆盖物失败:', e); }
            updatePlaybackTimeLabel(next.ts);
            scheduleNext();
        }, delay);
    }

    function stopPlayback(){
        if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
        playbackState.running = false;
        playbackState.idx = 0;
        try {
            // 移除DOM标记
            removePlaybackDom();
            if (playbackState.marker && map) map.removeOverLay(playbackState.marker);
            if (playbackState.line && map) map.removeOverLay(playbackState.line);
        } catch(e){}
        playbackState.marker = null;
        playbackState.line = null;
        updatePlaybackTimeLabel('—');
        // 按钮回到初始状态
        updatePlaybackButtonsState('idle');
    }

    function updatePlaybackTimeLabel(text){
        const el = document.getElementById('playbackTimeLabel');
        if (el) el.textContent = '时间：' + (text || '—');
    }

    // 时间滑动条：配置与跳转
    function configureTimeSlider(points){
        try {
            const slider = document.getElementById('playbackTimeSlider');
            const cursor = document.getElementById('playbackTimeCursor');
            if (!slider || !points || !points.length) return;
            const minMs = points[0].time.getTime();
            const maxMs = points[points.length - 1].time.getTime();
            const prev = parseInt(slider.value, 10);
            slider.min = String(minMs);
            slider.max = String(maxMs);
            slider.step = '1000'; // 以秒为步进
            let val = (isFinite(prev) && prev >= minMs && prev <= maxMs) ? prev : minMs;
            slider.value = String(val);
            if (cursor) cursor.textContent = formatTimeForLabel(val);
        } catch(e) { console.warn('配置时间滑动条失败:', e); }
    }
    function formatTimeForLabel(ms){
        if (!isFinite(ms)) return '—';
        const d = new Date(ms);
        const pad = n => String(n).padStart(2,'0');
        const y = d.getFullYear();
        const M = pad(d.getMonth()+1);
        const da = pad(d.getDate());
        const h = pad(d.getHours());
        const m = pad(d.getMinutes());
        const s = pad(d.getSeconds());
        return `${y}-${M}-${da} ${h}:${m}:${s}`;
    }
    function findIndexByTime(points, ms){
        try {
            if (!points || !points.length) return 0;
            const n = points.length;
            const minMs = points[0].time.getTime();
            const maxMs = points[n-1].time.getTime();
            if (!isFinite(ms)) return 0;
            if (ms <= minMs) return 0;
            if (ms >= maxMs) return n-1;
            let lo = 0, hi = n - 1, ans = 0;
            while (lo <= hi) {
                const mid = (lo + hi) >> 1;
                const t = points[mid].time.getTime();
                if (t < ms) { lo = mid + 1; ans = lo; }
                else { hi = mid - 1; ans = mid; }
            }
            return Math.max(0, Math.min(n-1, ans));
        } catch(e){ console.warn('findIndexByTime失败:', e); return 0; }
    }
    function jumpToSliderTime(){
        try {
            const slider = document.getElementById('playbackTimeSlider');
            if (!slider || !playbackState.points || !playbackState.points.length) return;
            const ms = parseInt(slider.value, 10);
            if (!isFinite(ms)) return;
            const idx = findIndexByTime(playbackState.points, ms);
            playbackState.idx = idx;
            const pts = playbackState.points;
            const ll = pts[idx].ll;
            playbackState.path = pts.slice(0, idx+1).map(p=>p.ll);
            // 更新折线
            try {
                if (playbackState.line && typeof playbackState.line.setLngLats === 'function') {
                    playbackState.line.setLngLats(playbackState.path);
                } else {
                    if (playbackState.line && map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                    playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 1, opacity: 0.9 });
                    if (map) map.addOverLay(playbackState.line);
                }
            } catch(e){ console.warn('滑块更新折线失败:', e); }
            // 更新标记与时间
            ensurePlaybackDom(ll);
            updatePlaybackDom(ll);
            updatePlaybackTimeLabel(pts[idx].ts);
            // 若正在播放，立即按新位置继续
            if (playbackState.running) {
                if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
                scheduleNext();
            }
        } catch(e) { console.warn('滑块跳转失败:', e); }
    }

    // DOM标记：使用容器坐标实现可见移动
    let playbackDom = { el: null, lastLL: null, bound: false };

    function ensurePlaybackDom(ll){
        try {
            playbackDom.lastLL = ll;
            const pane = (map && map.getPanes && map.getPanes().overlayPane) || document.getElementById('mapContainer');
            if (!pane) { console.warn('未找到overlayPane或mapContainer'); return; }
            if (!playbackDom.el) {
                const el = document.createElement('div');
                el.id = 'playbackDomMarker';
                el.style.position = 'absolute';
                el.style.width = '0';
                el.style.height = '0';
                el.style.borderLeft = '3px solid transparent';
                el.style.borderRight = '3px solid transparent';
                el.style.borderBottom = '4px solid #2C64A7';
                el.style.borderTop = '0';
                el.style.transform = 'translate(-50%, -50%)';
                el.style.zIndex = '9999';
                // 添加伪元素来增强箭头效果
                el.style.clipPath = 'polygon(50% 0, 100% 100%, 0 100%)';
                pane.appendChild(el);
                playbackDom.el = el;
                console.log('[Playback] 创建DOM标记，父节点=', pane === document.getElementById('mapContainer') ? '#mapContainer' : 'overlayPane');
                bindPlaybackDomEvents();
            }
            updatePlaybackDom(ll);
        } catch(e) { console.warn('创建DOM标记失败:', e); }
    }

    function updatePlaybackDom(ll){
        try {
            playbackDom.lastLL = ll;
            if (!map || !playbackDom.el || !ll) { console.log('[Playback] update取消：map/el/ll缺失'); return; }
            let p;
            if (typeof map.lngLatToLayerPoint === 'function') {
                p = map.lngLatToLayerPoint(ll);
                console.log('[Playback] 使用layerPoint定位:', ll && ll.lng, ll && ll.lat, '=>', p && p.x, p && p.y);
            } else if (typeof map.lngLatToContainerPoint === 'function') {
                p = map.lngLatToContainerPoint(ll);
                console.log('[Playback] 使用containerPoint定位:', ll && ll.lng, ll && ll.lat, '=>', p && p.x, p && p.y);
            } else {
                console.warn('地图对象不支持lngLat到像素坐标转换');
                return;
            }
            playbackDom.el.style.left = p.x + 'px';
            playbackDom.el.style.top = p.y + 'px';
        } catch(e) { console.warn('更新DOM标记位置失败:', e); }
    }

    function bindPlaybackDomEvents(){
        if (playbackDom.bound) return;
        const updater = function(){
            try {
                if (!map || !playbackDom.el || !playbackDom.lastLL) return;
                let p;
                if (typeof map.lngLatToLayerPoint === 'function') {
                    p = map.lngLatToLayerPoint(playbackDom.lastLL);
                } else if (typeof map.lngLatToContainerPoint === 'function') {
                    p = map.lngLatToContainerPoint(playbackDom.lastLL);
                }
                if (!p) return;
                playbackDom.el.style.left = p.x + 'px';
                playbackDom.el.style.top = p.y + 'px';
            } catch(e){}
        };
        try {
            map.addEventListener('move', updater);
            map.addEventListener('zoom', updater);
            playbackDom.bound = true;
        } catch(e){}
    }

    function removePlaybackDom(){
        try {
            const el = playbackDom.el;
            playbackDom.lastLL = null;
            if (el && el.parentNode) el.parentNode.removeChild(el);
        } catch(e){}
        playbackDom.el = null;
        playbackDom.bound = false;
    }

</script>
</body>

</html>
