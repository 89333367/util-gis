<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>展示轮廓</title>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #mapContainer {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        #mapLoading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
            transition: opacity 0.3s;
        }

        .loading-text {
            font-size: 16px;
            color: #333;
            padding: 10px 20px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .wkt-input-container {
            position: absolute;
            top: 20px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            width: min(320px, 90vw);
            box-sizing: border-box;
            transition: all 0.3s;
        }

        .minimize-btn {
            position: absolute;
            top: -5px;
            right: -4px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #f0f0f0;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #666;
            z-index: 1001;
            transition: background 0.2s;
        }

        .minimize-btn:hover {
            background: #e0e0e0;
        }

        .content-wrapper {
            transition: all 0.3s;
        }

        .wkt-input-container.minimized {
            width: 40px;
            height: 40px;
            padding: 0;
        }

        .wkt-input-container.minimized .content-wrapper {
            display: none;
        }

        .wkt-input-container.minimized .min-icon {
            display: none;
        }

        .wkt-input-container.minimized .restore-icon {
            display: inline;
        }

        #wktTextarea {
            width: 100%;
            height: 120px;
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
            box-sizing: border-box;
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        /* 页签样式 */
        .tabs-header {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .tab-btn {
            flex: 1;
            padding: 6px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            background: #f5f5f5;
            color: #333;
            transition: background 0.2s;
        }
        .tab-btn.active { background: #337AFF; color: #fff; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        /* Multi → Polygons 分割器样式 */
        .split-section {
            margin-top: 10px;
            padding: 10px;
            background: #fafafa;
            border: 1px solid #eee;
            border-radius: 6px;
        }
        .split-section .title {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
        }
        .split-section .desc {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        #multiInput, #polyOutput {
            width: 100%;
            height: 90px;
            margin-bottom: 8px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
            box-sizing: border-box;
        }
        .split-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .split-actions button {
            flex: 1;
            padding: 6px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }
        #splitMultiBtn { background: #337AFF; color: #fff; }
        #splitMultiBtn:hover { background: #2860E0; }
        #copyPolysBtn { background: #f5f5f5; color: #333; }
        #copyPolysBtn:hover { background: #e0e0e0; }
        #drawButton,
        #clearButton,
        #drawTrackButton,
        #clearTrackButton {
            width: 50%;
            padding: 8px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        #drawButton,
        #drawTrackButton {
            background: #337AFF;
            color: white;
        }

        #drawButton:hover,
        #drawTrackButton:hover {
            background: #2860E0;
        }

        #clearButton,
        #clearTrackButton {
            background: #f5f5f5;
            color: #333;
        }

        #clearButton:hover,
        #clearTrackButton:hover {
            background: #e0e0e0;
        }

        #drawButton:disabled,
        #clearButton:disabled,
        #drawTrackButton:disabled,
        #clearTrackButton:disabled {
            background: #e0e0e0;
            color: #999;
            cursor: not-allowed;
        }

        .tip {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .area-label {
             position: absolute;
             background: rgba(255, 0, 0, 0.85);
             border: 1px solid #000;
             border-radius: 3px;
             padding: 4px 6px;
             font-size: 12px;
             color: #fff;
             font-weight: 600;
             box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
             white-space: nowrap;
             z-index: 9999;
             pointer-events: none;
         }
         /* 默认隐藏标签容器下的标签 */
          .labels-hidden .area-label { display: none; }

          /* Batch → Generator 样式 */
          .batch-section { margin-top: 10px; padding: 10px; background: #fafafa; border: 1px solid #eee; border-radius: 6px; }
          .batch-section .title { font-size: 13px; font-weight: 600; color: #333; margin-bottom: 6px; }
          .batch-section .desc { font-size: 12px; color: #666; margin-bottom: 8px; }
          #batchInput, #multiOutput { width: 100%; height: 90px; margin-bottom: 8px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; resize: vertical; box-sizing: border-box; }
          .batch-actions { display: flex; gap: 8px; margin-bottom: 8px; }
          .batch-actions button { flex: 1; padding: 6px 0; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; transition: background 0.2s; }
          #generateMultiBtn { background: #337AFF; color: #fff; }
          #generateMultiBtn:hover { background: #2860E0; }
          #copyMultiBtn { background: #f5f5f5; color: #333; }
          #copyMultiBtn:hover { background: #e0e0e0; }
      </style>
    <script src="https://api.tianditu.gov.cn/api?v=4.0&tk=648f621977051d0199ff0f965d3fd322"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
    <script src="https://lib.baomitu.com/terraformer/1.0.12/terraformer.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://unpkg.com/terraformer-wkt-parser@1.2.1/terraformer-wkt-parser.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- 已移除动态备用加载器 ensureTerraformer：改为仅使用静态脚本标签加载 Terraformer 核心库与 WKT 解析器 -->
    <script>
        // 检查Turf.js是否加载成功
        window.addEventListener('load', function () {
            if (typeof turf === 'undefined') {
                console.warn('Turf.js加载失败，已启用备用面积算法');
            } else {
                console.log('Turf.js加载成功');
            }
        });
    </script>
</head>

<body>
<div id="mapContainer">
    <div id="mapLoading">
        <div class="loading-text">地图正在加载中...</div>
    </div>
</div>

<div class="wkt-input-container">
    <div class="minimize-btn" id="minimizeBtn">
        <span class="min-icon">−</span>
        <span class="restore-icon" style="display:none;">+</span>
    </div>

    <div class="content-wrapper">
        <div class="tabs-header">
            <button class="tab-btn active" id="tabDrawBtn">轮廓</button>
            <button class="tab-btn" id="tabTrackBtn">轨迹</button>
            <button class="tab-btn" id="tabSplitBtn">分割器</button>
            <button class="tab-btn" id="tabBatchBtn">合并器</button>
        </div>
        <div class="tab-pane active" id="tabDraw">
            <div class="tip">请输入WKT字符串（支持POLYGON/MULTIPOLYGON）：</div>
            <textarea id="wktTextarea">POLYGON ((107.79294051360304 22.54080379013598, 107.79294051358522 22.540803791551753, 107.79294051236413 22.540804089347144, 107.79294054130582 22.540804320912024, 107.79294054731376 22.540804396835195, 107.79294055929378 22.540804753766146, 107.79294057155289 22.540804971264528, 107.79294066523703 22.54080541328511, 107.79294067973716 22.540805507912367, 107.79294072383226 22.540805970106625, 107.79294075156953 22.540806105173452, 107.79294076009535 22.540806153898124, 107.79294080775846 22.54080648290128, 107.79294091757053 22.5408068313353, 107.79294093061793 22.540806877168475, 107.79294097233011 22.54080704099942, 107.79294102708302 22.540807180379527, 107.792941067674 22.54080731554815, 107.79294109690592 22.540807453625032, 107.7929411267053 22.540807543469736, 107.79294124328236 22.540807797077584, 107.79294128383421 22.54080790319165, 107.79294137429375 22.540808196891803, 107.79294145163863 22.540808366760967, 107.79294147996909 22.540808436983532, 107.7929416467982 22.540808909388193, 107.79294167557255 22.54080897036467, 107.7929420915978 22.540809655026933, 107.79294213183718 22.540809728994397, 107.79294223292116 22.54080993815541, 107.79294235895289 22.540810120221145, 107.79294239680836 22.540810179813686, 107.79294252553663 22.540810401464814, 107.79294258580963 22.540810478872828, 107.79294264308031 22.540810561569053, 107.79294297307916 22.54081110053135, 107.79294302762918 22.540811172001433, 107.79294355317982 22.540811734320265, 107.7929435931794 22.54081178005378, 107.7929437940233 22.540812025663236, 107.7929438265877 22.540812055215685, 107.79294390580469 22.540812136409727, 107.79294403307588 22.54081228395662, 107.7929442818772 22.54081251814889, 107.79294432231848 22.540812558621617, 107.79294474653246 22.540813010126687, 107.79294481642445 22.540813071107298, 107.79294539123828 22.5408134812054, 107.79294576485961 22.540813773919414, 107.79294591021053 22.540813883427504, 107.7929461001433 22.540813993974066, 107.79294617605932 22.5408140429831, 107.79294689764257 22.54081455780478, 107.7929469746934 22.540814601886098, 107.7929475551237 22.540814865888166, 107.79294760915609 22.540814892454396, 107.79294791809154 22.540815056114397, 107.7929481701996 22.540815168347716, 107.79294832920488 22.54081525741812, 107.79294846705469 22.54081537297133, 107.7929485787099 22.54081551078315, 107.79294866008881 22.540815665815767, 107.79294870821661 22.54081583240183, 107.79294872133389 22.54081600445162, 107.79294869896111 22.54081617567572, 107.79294864191618 22.54081633981488, 107.79294855228441 22.540816490868846, 107.79294843334233 22.54081662331571, 107.79294828943809 22.540816732313743, 107.79294812583207 22.540816813878447, 107.79294794850514 22.540816865028148, 107.79294776393964 22.54081688389302, 107.79294671972038 22.540816897327144, 107.79294662283507 22.540816894078034, 107.79294639594367 22.540816875903047, 107.79294629865433 22.540816877222, 107.79294550052988 22.540816963016233, 107.79294543168756 22.540816968120176, 107.79294463603615 22.540817000720633, 107.79294453923762 22.54081701387349, 107.79294418630975 22.540817096333342, 107.7929440598331 22.54081711773359, 107.79294369551785 22.54081715646028, 107.79294360050635 22.54081717568653, 107.79294282850357 22.540817409395945, 107.79294276369095 22.540817426728633, 107.79294198547785 22.540817607914605, 107.79294189370758 22.54081763869209, 107.79294157067409 22.540817782670988, 107.7929414509583 22.540817827207523, 107.79294110884064 22.540817930579873, 107.79294102011653 22.540817966864772, 107.79294030308675 22.540818343785375, 107.79294024462675 22.540818372126438, 107.79293951913284 22.540818695220082, 107.79293943659705 22.54081874190727, 107.79293924695325 22.54081887496562, 107.79293913139057 22.54081894466822, 107.79293879472712 22.540819117506803, 107.79293871734919 22.54081916688601, 107.79293770494537 22.540819957381675, 107.79293766676022 22.540819985705205, 107.79293734900236 22.540820209474532, 107.7929371895472 22.54082035654468, 107.79293713038597 22.54082040678072, 107.79293676523305 22.540820692065168, 107.79293669937663 22.540820754634776, 107.79293510227565 22.54082260150469, 107.79293505068657 22.540822674756914, 107.79293386887414 22.54082477365789, 107.792933833538 22.540824854771746, 107.79293311129773 22.54082712667231, 107.79293309353082 22.540827212592763, 107.79293285819526 22.540829571630127, 107.7929328586898 22.54082965936306, 107.79293312060065 22.540832015906666, 107.79293313929797 22.540832101536605, 107.79293388638375 22.540834366210586, 107.79293392262798 22.540834447017094, 107.79293512782986 22.540836534855732, 107.7929351802927 22.54083660768437, 107.79293679804755 22.54083843871544, 107.79293686453627 22.540838500584456, 107.79293883262918 22.540840006298872, 107.79293891059181 22.540840054961745, 107.79294114292392 22.540841171402825, 107.79294141565248 22.54084126653938, 107.79294278532112 22.54084165425938, 107.79294328099819 22.540841813924313, 107.79294346238204 22.54084185098499, 107.79294352210744 22.540841865047184, 107.79294376041148 22.54084192869305, 107.79294393740147 22.540841957827695, 107.79294502714903 22.540842056111714, 107.79294587910813 22.54084216769189, 107.79294617246522 22.540842166899957, 107.79294625546129 22.540842169975562, 107.79294648336739 22.54084218751293, 107.79294812828542 22.54084218955774, 107.79295836003065 22.540842109268993, 107.7929988005796 22.540842079709147, 107.79301989946559 22.54084192969491, 107.79304082892601 22.540842059777493, 107.79306182131401 22.540842009919963, 107.79309335574966 22.540841879767214, 107.79310400906542 22.540841909522424, 107.79312490704079 22.540841829765462, 107.79314581181906 22.540841839165918, 107.79315645534304 22.540841860009415, 107.79317747268311 22.54084183949207, 107.79319844999901 22.540841779135008, 107.7932195010552 22.54084167954246, 107.79324041232881 22.540841629386033, 107.7932614849099 22.540841679204394, 107.79330349934591 22.540841579899013, 107.79332445216491 22.540841509096083, 107.79334545534535 22.54084145993372, 107.79336638809568 22.5408414896413, 107.79337691615424 22.540841489911113, 107.79342086420259 22.540841375148418, 107.7934209553274 22.54084137888954, 107.79342150827473 22.540841425836533, 107.79342185844101 22.540841401726592, 107.79342196529792 22.540841399847068, 107.79342232934704 22.540841412067326, 107.7934224258499 22.540841406334145, 107.79342308307653 22.540841305392373, 107.79342315034937 22.540841297290783, 107.79342361239787 22.540841256829527, 107.79342368389631 22.54084124177611, 107.79342380286829 22.540841223851235, 107.79342415498971 22.54084119146202, 107.79342424786509 22.540841174278306, 107.79342455085268 22.540841088906234, 107.79342466583226 22.54084106349004, 107.79342504342875 22.540841002293668, 107.79342539257163 22.54084088688101, 107.79342547414052 22.54084086361365, 107.79342552344146 22.540840851725036, 107.79342593833107 22.54084070736911, 107.79342598751391 22.54084069163835, 107.79342670993348 22.54084048050389, 107.79342679300927 22.540840448062927, 107.7934271369307 22.540840277214237, 107.79342724962008 22.540840229549183, 107.79342759462972 22.54084010763667, 107.79342768123628 22.540840067414486, 107.79342781562572 22.54083998849616, 107.79342788995069 22.54083994899847, 107.79342803730974 22.54083987850919, 107.7934284052884 22.540839651963175, 107.79342848432401 22.54083960816454, 107.79342906342569 22.540839320894563, 107.79342913905708 22.540839274359307, 107.7934294439102 22.54083904580826, 107.79342951979937 22.540838994339744, 107.79342990347739 22.54083875968692, 107.7934300406582 22.540838653197085, 107.79343019480805 22.540838540283556, 107.79343062976923 22.540838143609093, 107.7934306967873 22.54083808791009, 107.79343111079055 22.540837774645357, 107.79343119321408 22.540837697467627, 107.79343140452676 22.54083745814003, 107.79343147913329 22.54083738280098, 107.79343152794134 22.540837338807997, 107.7934315860657 22.54083728162797, 107.79343196046737 22.540836930025666, 107.79343217273131 22.540836663769827, 107.79343228674408 22.54083652976625, 107.7934324071733 22.54083635465938, 107.79343247766111 22.54083626488031, 107.79343280669488 22.540835895876214, 107.79343301879896 22.54083554897667, 107.79343304447026 22.540835509387907, 107.79343325277027 22.54083520713532, 107.79343345351262 22.540834937000373, 107.7934334987632 22.54083486150447, 107.79343361239351 22.540834619886645, 107.79343365213113 22.540834545034294, 107.79343377118751 22.540834344704507, 107.79343384123234 22.540834173902468, 107.79343389296973 22.54083406860246, 107.79343410152417 22.540833707458184, 107.79343420910969 22.540833414584988, 107.79343423424909 22.540833353491223, 107.79343433043019 22.54083314297138, 107.79343434905164 22.54083307981912, 107.79343439620168 22.540832956069746, 107.79343450189329 22.540832732016554, 107.79343453076196 22.540832650377748, 107.79343460857736 22.5408323297763, 107.79343464807951 22.540832207869684, 107.79343471370203 22.54083204738168, 107.793434738946 22.540831960055833, 107.79343477216733 22.540831770858777, 107.79343480119178 22.54083165460076, 107.79343490575928 22.540831333872923, 107.793434945865 22.540831087944934, 107.79343495658307 22.54083103354126, 107.7934350094155 22.5408308051495, 107.79343502089942 22.540830666106192, 107.79343503386121 22.540830573012247, 107.79343509114156 22.54083028172152, 107.79343510474251 22.540829906820758, 107.79343511646037 22.540829794262844, 107.79343516467937 22.54082951515271, 107.79343517033726 22.540829424248383, 107.79343516212296 22.540829249429017, 107.79343516556843 22.540829124615488, 107.7934351945811 22.54082884146155, 107.79343519113361 22.54082861688154, 107.79343519577841 22.540828389947993, 107.79343516904252 22.540828177793514, 107.79343516280991 22.540828097259112, 107.79343515625365 22.540827871742895, 107.79343512826713 22.540827712127676, 107.79343511855608 22.54082763700381, 107.79343510501315 22.540827475123876, 107.79343508597633 22.5408273849368, 107.79343506871324 22.540827249833665, 107.79343505496139 22.540826950592983, 107.79343504052957 22.540826859149867, 107.79343499977429 22.54082670993285, 107.79343497750362 22.540826600378956, 107.79343492757924 22.540826230722644, 107.7934348821235 22.540825985836833, 107.79343479033814 22.540825718265125, 107.79343477214084 22.540825658082813, 107.7934347318798 22.54082550470363, 107.79343467381189 22.540825357715086, 107.79343464446971 22.540825269814857, 107.79343457826678 22.540825028623388, 107.79343451730577 22.540824891162853, 107.79343447329039 22.54082476707474, 107.79343439574963 22.54082447998179, 107.7934342859192 22.540824234942118, 107.79343425685332 22.5408241612019, 107.7934341254636 22.540823776812434, 107.79343409229209 22.540823703783204, 107.79343371586286 22.540823061195834, 107.79343368763722 22.5408230090644, 107.79343355022216 22.54082273339847, 107.79343342595067 22.54082255661268, 107.79343337097733 22.540822467762514, 107.79343319892762 22.540822149048033, 107.7934331004081 22.540822009439015, 107.79343306043964 22.540821947532827, 107.79343288504892 22.540821649449136, 107.79343283318245 22.540821578378523, 107.79343231133237 22.5408209925751, 107.79343225166397 22.5408209181017, 107.79343213501883 22.540820755688138, 107.79343207484217 22.540820687473072, 107.79343189452382 22.54082051972083, 107.79343183412776 22.540820458084625, 107.79343122226012 22.540819772540285, 107.79343116817869 22.540819722954488, 107.79343049941596 22.540819212840027, 107.79343042828276 22.540819152871116, 107.79343025339335 22.540818990069408, 107.79343018037959 22.540818934241337, 107.79342995843001 22.540818795921655, 107.79342988385618 22.540818744477882, 107.79342921611632 22.540818236071157, 107.79342915110409 22.54081819490257, 107.79342836838987 22.540817801301305, 107.79342829018559 22.54081775743615, 107.79342803757078 22.540817600224074, 107.79342795352346 22.540817558409667, 107.79342768703432 22.540817455747312, 107.79342759801573 22.54081741642299, 107.79342692871845 22.54081708106094, 107.79342684359152 22.54081704770489, 107.79342656668439 22.54081696709846, 107.7934263930065 22.540816898706915, 107.79342623683873 22.54081680041602, 107.79342610407323 22.540816675934337, 107.7934259997194 22.54081652995862, 107.79342592771454 22.540816367996616, 107.79342589077541 22.540816196159206, 107.79342589029581 22.540816020929924, 107.79342592629376 22.540815848920268, 107.79342599741108 22.540815686620213, 107.79342610096447 22.540815540153453, 107.79342623304673 22.540815415046247, 107.79342638867446 22.540815316018936, 107.79342656197569 22.54081524680788, 107.79342816471427 22.54081477193016, 107.79342825180566 22.54081473707523, 107.79343050062076 22.540813582696735, 107.79343057889123 22.540813532623837, 107.79343254172919 22.540811992640627, 107.7934326079323 22.54081192937772, 107.79343421026086 22.540810062379585, 107.79343426185066 22.540809988425515, 107.79343544134683 22.540807867808788, 107.79343547646654 22.540807785816362, 107.79343618791421 22.540805491578855, 107.7934362051389 22.54080540471907, 107.79343642041123 22.54080302593102, 107.79343641907336 22.540802937900704, 107.79343613154185 22.540800565259037, 107.79343611165979 22.54080047881428, 107.79343533069134 22.54079820522769, 107.79343529322415 22.540798124438314, 107.7934340504981 22.540796034617273, 107.79343399646575 22.540795961746998, 107.79343233767871 22.54079413842415, 107.79343226975028 22.54079407708861, 107.79343027277649 22.5407925975008, 107.793430087289 22.540792493370326, 107.7934299334921 22.540792386402785, 107.79342980537487 22.54079225340325, 107.79342970795173 22.540792099577263, 107.79342964503583 22.54079193094554, 107.79342961908965 22.54079175410828, 107.7934296311287 22.540791575986823, 107.79342968068183 22.540791403552802, 107.79342976580946 22.54079124355523, 107.79342988317983 22.540791102256367, 107.79343002819901 22.54079098518659, 107.79343019519104 22.540790896928005, 107.79343037761986 22.540790840934996, 107.7934305683453 22.54079081939913, 107.79343856832402 22.540790656761875, 107.79344934949796 22.540790248218066, 107.7934601397842 22.540789573813754, 107.79346267460559 22.540789180871744, 107.79346276628671 22.540789157893954, 107.79346516987636 22.540788313135227, 107.79346525496995 22.540788273984333, 107.7934674349601 22.54078700987218, 107.79346751019558 22.540786956053054, 107.79346938281016 22.54078532116672, 107.7934694452973 22.540785254747007, 107.79347093857236 22.540783311914605, 107.7934709859095 22.540783235446888, 107.79347204245968 22.54078105933025, 107.79347207282764 22.540780975753247, 107.7934726520502 22.540778649979345, 107.79347266428192 22.54077856250436, 107.79347274391786 22.540776176451452, 107.79347273754315 22.54077608844151, 107.79347231453207 22.540773733803373, 107.79347228979596 22.540773648639362, 107.79347138039417 22.540771415904924, 107.79347133824713 22.540771336859606, 107.79346997740227 22.54076931183071, 107.79346991946416 22.54076924194238, 107.79346815947265 22.54076750243969, 107.7934680879702 22.540767444394238, 107.79346599646753 22.540766057265813, 107.79346591414853 22.540766013293627, 107.79346357150978 22.540765031846178, 107.79346348153729 22.540765003636917, 107.79346097778921 22.54076446558705, 107.79346088443874 22.540764454323543, 107.79345822051543 22.540764381799796, 107.79344810855645 22.540765013133832, 107.79342045951685 22.540765754937127, 107.79340483228071 22.540765750373662, 107.79338380281588 22.5407656506042, 107.7933627522444 22.540765820290776, 107.79334171685157 22.540765800394244, 107.79333114971438 22.540765850349207, 107.7932892094116 22.540765830384245, 107.79326825879126 22.540765750501905, 107.7932576053148 22.54076577040468, 107.79323657826473 22.54076593031173, 107.79319475231087 22.540765880399682, 107.79317365248518 22.540766050289413, 107.79315259878328 22.54076603039433, 107.79314190117582 22.540766120776418, 107.79312098790666 22.540766250336006, 107.79308959595757 22.540766220391085, 107.79306852820875 22.540766280271196, 107.79304770457625 22.5407661805714, 107.79303699691599 22.540766220819282, 107.79301589148382 22.540766385498113, 107.79301333602196 22.540766638916807, 107.79301324304203 22.540766656832538, 107.793010790008 22.540767368459793, 107.79301070257742 22.540767402881272, 107.7930084461328 22.540768545380356, 107.79300836761148 22.540768594984755, 107.79300639447055 22.540770124449917, 107.79300632787563 22.54077018733134, 107.79300471386506 22.540772044985985, 107.79300466175609 22.54077211872763, 107.79300346890128 22.54077423318322, 107.79300343328056 22.54077431495158, 107.79300270742227 22.54077660495067, 107.7930026896589 22.540776691602947, 107.7930024586915 22.54077906914264, 107.7930024594681 22.54077915734911, 107.79300273226747 22.540781531061562, 107.79300275155421 22.5407816174322, 107.79300351763688 22.540783896097057, 107.79300355469238 22.540783977312874, 107.79300478461823 22.540786073362035, 107.79300483801907 22.540786146302594, 107.79300648452255 22.540787979186195, 107.79300655221583 22.54078804104745, 107.79300855202317 22.54078954032904, 107.79300863140783 22.540789588734036, 107.79300894169766 22.54078973978037, 107.79300909586959 22.540789833115024, 107.79300922831987 22.540789951789428, 107.79300933429258 22.540790091542387, 107.79300940998264 22.540790247355826, 107.79300945267222 22.540790413635005, 107.79300946082857 22.54079058440938, 107.79300943415873 22.540790753547004, 107.7930093736204 22.540790914974718, 107.79300928138717 22.54079106289617, 107.79300916077106 22.540791191999983, 107.79300901610279 22.54079129765048, 107.793008852577 22.54079137605409, 107.79300867606544 22.540791424395596, 107.7930084929059 22.540791440939227, 107.79300359262714 22.540791450220144, 107.79297210301733 22.540791320692403, 107.79295475485384 22.54079115402872, 107.79295466578526 22.54079114936658, 107.79295419396435 22.540791104401823, 107.79295411133755 22.54079110359138, 107.79295325352939 22.540791178414977, 107.79295142080579 22.54079136174345, 107.79295104082834 22.54079145838402, 107.79295065560352 22.54079157762797, 107.79295001969606 22.540791766659463, 107.79294909762241 22.54079201581285, 107.79294887938036 22.540792102954086, 107.79294866174772 22.540792181593535, 107.79294808088181 22.540792485011426, 107.79294789049352 22.540792574574816, 107.7929478092024 22.540792623532496, 107.79294773077365 22.54079266606539, 107.79294671802863 22.540793157816058, 107.7929464774879 22.540793319812074, 107.79294623690382 22.540793467035275, 107.79294575939522 22.540793852215348, 107.79294567699634 22.540793911777314, 107.79294561192047 22.54079395380265, 107.7929454474653 22.540794092293964, 107.79294540553933 22.540794125634427, 107.79294461553866 22.540794718570616, 107.79294444621833 22.54079488614578, 107.79294440430546 22.540794925165926, 107.79294431245746 22.54079500560288, 107.79294411599764 22.540795212956983, 107.79294388392674 22.540795500675607, 107.79294382729579 22.540795564555975, 107.79294367965589 22.54079571633612, 107.7929435742076 22.540795857857272, 107.7929435227037 22.540795920882626, 107.79294288422912 22.540796634858633, 107.79294277467072 22.540796794612458, 107.79294268883794 22.54079691655163, 107.79294261121144 22.540797055017084, 107.7929425596049 22.5407971363703, 107.79294240120598 22.540797358596496, 107.79294231756363 22.54079752635144, 107.79294228350645 22.540797588279627, 107.79294222218769 22.540797689908516, 107.79294208542768 22.540797978759148, 107.79294205409005 22.54079803881526, 107.79294155807219 22.540798906107124, 107.79294140435852 22.54079933919859, 107.79294136340795 22.54079943557479, 107.79294125642855 22.5407996503336, 107.79294122381924 22.540799739063257, 107.79294105807078 22.540800413080724, 107.7929410399295 22.540800476222767, 107.79294079313067 22.54080122519753, 107.79294076384113 22.54080135712382, 107.7929407105038 22.540801799707346, 107.79294069231523 22.540801899549074, 107.79294061314013 22.54080222268655, 107.79294060116314 22.54080231337699, 107.7929405854905 22.54080302891901, 107.79294057857449 22.540803119582357, 107.79294053835689 22.5408034264686, 107.79294051360304 22.54080379013598))</textarea>
            <div class="coord-settings" style="margin-bottom:8px;font-size:12px;color:#333;">
                <label>WKT坐标系：
                    <select id="coordSysSelect" style="margin-left:6px;">
                        <option value="wgs84" selected>WGS84</option>
                        <option value="gcj02">GCJ-02（国测局）</option>
                        <option value="bd09">BD-09（百度）</option>
                        <option value="cgcs2000">CGCS2000</option>
                    </select>
                </label>
                <!-- 已移除“不进行绘制坐标转换”选项，统一使用WGS84绘制 -->
            </div>

            <div class="button-group">
                <button id="drawButton" disabled>绘制轮廓</button>
                <button id="clearButton" disabled>清空轮廓</button>
            </div>
            <!-- 显示开关：仅保留显示亩数 -->
            <div class="display-toggles" style="margin-top:8px;font-size:12px;color:#333;">
                <label><input type="checkbox" id="toggleLabelsCheckbox"> 显示亩数</label>
            </div>
        </div>

        <div class="tab-pane" id="tabSplit">
            <!-- MultiPolygon → 多个 Polygon 分割器 -->
            <div class="split-section">
                <div class="title">MultiPolygon → 多个 Polygon 分割器</div>
                <div class="desc">输入一个 MULTIPOLYGON WKT，分割为多行 POLYGON WKT。</div>
                <textarea id="multiInput"></textarea>
                <div class="split-actions">
                    <button id="splitMultiBtn">分割为多个 POLYGON</button>
                    <button id="copyPolysBtn">复制结果</button>
                </div>
                <textarea id="polyOutput" readonly></textarea>
            </div>
        </div>

        <div class="tab-pane" id="tabBatch">
            <!-- 批量POLYGON → MULTIPOLYGON 生成器 -->
            <div class="batch-section">
                <div class="title">批量POLYGON → MULTIPOLYGON 合并器</div>
                <div class="desc">每行一个 POLYGON WKT（或用分号分隔）。生成后可一键填充到上方并绘制。</div>
                <textarea id="batchInput"></textarea>
                <div class="batch-actions">
                    <button id="generateMultiBtn">生成 MULTIPOLYGON</button>
                    <button id="copyMultiBtn">复制结果</button>
                </div>
                <textarea id="multiOutput" readonly></textarea>
            </div>
        </div>
        <div class="tab-pane" id="tabTrack">
            <div class="tip">请粘贴轨迹文本（支持两种格式：1）每行一条：定位时间yyyyMMddHHmmss, 经度, 纬度；2）单行#分隔：经度,纬度,定位时间yyyyMMddHHmmss#经度,纬度,定位时间yyyyMMddHHmmss#…）。</div>
            <div class="coord-settings" style="margin-bottom:8px;font-size:12px;color:#333;">
                <label>轨迹坐标系：
                    <select id="trackCoordSysSelect" style="margin-left:6px;">
                        <option value="wgs84" selected>WGS84</option>
                        <option value="gcj02">GCJ-02（国测局）</option>
                        <option value="bd09">BD-09（百度）</option>
                        <option value="cgcs2000">CGCS2000</option>
                    </select>
                </label>
            </div>
            <textarea id="trackTextarea" style="width:100%;height:120px;margin-bottom:10px;padding:8px;border:1px solid #ddd;border-radius:4px;font-family:monospace;resize:vertical;box-sizing:border-box;">20251104100606,107.79342153,22.54082875,0,304
20251104100607,107.79342156,22.54082875,0,68
20251104100608,107.79342160,22.54082873,0,50
20251104100609,107.79342155,22.54082875,0,304
20251104100610,107.79342155,22.54082876,0,63
20251104100611,107.79342151,22.54082873,0,358
20251104100612,107.79342156,22.54082871,0,71
20251104100613,107.79342156,22.54082873,0,303
20251104100615,107.79342155,22.54082875,0,311
20251104100616,107.79342160,22.54082876,0,134
20251104100617,107.79342153,22.54082878,0,112
20251104100618,107.79342150,22.54082878,0,90
20251104100620,107.79342148,22.54082878,0,2
20251104100621,107.79342155,22.54082878,0,113
20251104100623,107.79342160,22.54082873,0,105
20251104100624,107.79342160,22.54082875,0,53
20251104100626,107.79342155,22.54082878,0,333
20251104100627,107.79342155,22.54082875,0,199
20251104100628,107.79342155,22.54082876,0,300
20251104100629,107.79342151,22.54082881,0,286
20251104100630,107.79342155,22.54082880,0,244
20251104100631,107.79342153,22.54082880,0,19
20251104100632,107.79342151,22.54082876,0,354
20251104100633,107.79342155,22.54082871,0,130
20251104100634,107.79342155,22.54082875,0,358
20251104100635,107.79342155,22.54082875,0,316
20251104100636,107.79342158,22.54082871,0,95
20251104100637,107.79342150,22.54082875,0,293
20251104100638,107.79342156,22.54082873,0,120
20251104100639,107.79342161,22.54082870,0,124
20251104100640,107.79342153,22.54082876,0,93
20251104100641,107.79342155,22.54082876,0,275
20251104100642,107.79342155,22.54082873,0,102
20251104100643,107.79342156,22.54082873,0,348
20251104100644,107.79342151,22.54082876,0,46
20251104100645,107.79342156,22.54082875,0,90
20251104100646,107.79342155,22.54082876,0,69
20251104100647,107.79342158,22.54082873,0,100
20251104100648,107.79342055,22.54082875,0.1,251
20251104100649,107.79341663,22.54082876,1.1,262
20251104100650,107.79340868,22.54082878,3.3,263
20251104100651,107.79339803,22.54082881,3.7,267
20251104100652,107.79338744,22.54082881,3.8,270
20251104100653,107.79337688,22.54082886,3.9,270
20251104100654,107.79336641,22.54082886,4,271
20251104100655,107.79335594,22.54082880,3.7,268
20251104100656,107.79334545,22.54082883,4,269
20251104100657,107.79333493,22.54082880,3.9,270
20251104100658,107.79332441,22.54082888,3.8,270
20251104100659,107.79331388,22.54082888,3.8,270
20251104100700,107.79330345,22.54082895,3.8,268
20251104100701,107.79329298,22.54082898,3.8,269
20251104100702,107.79328243,22.54082895,3.8,268
20251104100703,107.79327198,22.54082900,3.8,271
20251104100704,107.79326145,22.54082905,3.9,270
20251104100705,107.79325104,22.54082896,3.7,269
20251104100706,107.79324041,22.54082900,3.8,269
20251104100707,107.79322995,22.54082900,3.7,269
20251104100708,107.79321945,22.54082905,3.6,268
20251104100709,107.79320893,22.54082906,3.9,268
20251104100710,107.79319838,22.54082915,3.9,269
20251104100711,107.79318785,22.54082915,3.6,268
20251104100712,107.79317746,22.54082921,3.8,271
20251104100713,107.79316701,22.54082921,3.9,271
20251104100714,107.79315644,22.54082923,3.8,270
20251104100715,107.79314583,22.54082921,3.9,269
20251104100716,107.79313524,22.54082916,3.8,268
20251104100717,107.79312488,22.54082920,3.8,270
20251104100718,107.79311441,22.54082921,3.7,269
20251104100719,107.79310395,22.54082928,3.9,272
20251104100720,107.79309335,22.54082925,3.8,271
20251104100721,107.79308276,22.54082921,3.9,270
20251104100722,107.79307231,22.54082931,3.7,266
20251104100723,107.79306176,22.54082938,4,271
20251104100724,107.79305135,22.54082940,3.7,271
20251104100725,107.79304079,22.54082943,3.8,270
20251104100726,107.79303040,22.54082933,3.8,269
20251104100727,107.79301990,22.54082930,3.9,269
20251104100728,107.79300931,22.54082935,3.9,270
20251104100729,107.79299879,22.54082945,3.9,270
20251104100730,107.79298826,22.54082943,3.9,270
20251104100731,107.79297783,22.54082945,3.7,271
20251104100732,107.79296733,22.54082948,3.8,270
20251104100733,107.79295830,22.54082948,3.3,272
20251104100734,107.79295190,22.54082946,2.2,273
20251104100735,107.79294801,22.54082956,1.4,281
20251104100736,107.79294645,22.54082955,0.1,277
20251104100737,107.79294645,22.54082955,0,32
20251104100738,107.79294656,22.54082953,0,28
20251104100739,107.79294655,22.54082953,0,321
20251104100740,107.79294653,22.54082953,0,70
20251104100741,107.79294655,22.54082956,0,118
20251104100742,107.79294658,22.54082955,0,127
20251104100743,107.79294651,22.54082956,0,337
20251104100744,107.79294655,22.54082955,0,85
20251104100745,107.79294656,22.54082955,0,224
20251104100746,107.79294655,22.54082950,0,298
20251104100747,107.79294656,22.54082955,0,6
20251104101009,107.79295420,22.54080383,0,127
20251104101010,107.79295415,22.54080383,0,64
20251104101011,107.79295415,22.54080381,0,347
20251104101012,107.79295413,22.54080378,0,24
20251104101013,107.79295415,22.54080378,0,171
20251104101014,107.79295411,22.54080381,0,16
20251104101015,107.79295416,22.54080380,0,80
20251104101016,107.79295415,22.54080378,0,344
20251104101017,107.79295416,22.54080380,0,305
20251104101018,107.79295410,22.54080385,0,248
20251104101019,107.79295420,22.54080378,0,59
20251104101020,107.79295415,22.54080373,0,135
20251104101021,107.79295413,22.54080378,0,321
20251104101022,107.79295410,22.54080378,0,188
20251104101023,107.79295413,22.54080383,0,292
20251104101024,107.79295411,22.54080378,0,97
20251104101025,107.79295411,22.54080376,0,37
20251104101026,107.79295411,22.54080375,0,296
20251104101027,107.79295411,22.54080380,0,285
20251104101028,107.79295415,22.54080378,0,290
20251104101029,107.79295426,22.54080378,0,76
20251104101030,107.79296123,22.54080391,3,82
20251104101031,107.79297200,22.54080395,3.7,88
20251104101032,107.79298251,22.54080405,4,92
20251104101033,107.79299306,22.54080406,3.9,89
20251104101034,107.79300358,22.54080408,3.9,90
20251104101035,107.79301414,22.54080415,3.9,90
20251104101036,107.79302463,22.54080408,3.9,89
20251104101037,107.79303498,22.54080403,3.8,93
20251104101038,107.79304546,22.54080400,3.9,91
20251104101039,107.79305603,22.54080398,3.9,88
20251104101040,107.79306659,22.54080395,3.9,93
20251104101041,107.79307708,22.54080381,3.9,91
20251104101042,107.79308750,22.54080381,3.9,89
20251104101043,107.79309813,22.54080381,3.9,90
20251104101044,107.79310858,22.54080378,3.8,89
20251104101045,107.79311906,22.54080378,3.8,90
20251104101046,107.79312953,22.54080395,3.8,88
20251104101047,107.79314004,22.54080396,4,88
20251104101048,107.79315060,22.54080390,4.1,91
20251104101049,107.79316116,22.54080381,3.9,90
20251104101050,107.79317164,22.54080368,3.8,90
20251104101051,107.79318210,22.54080375,3.8,89
20251104101052,107.79319265,22.54080366,3.9,90
20251104101053,107.79320323,22.54080370,3.9,89
20251104101054,107.79321371,22.54080365,3.9,91
20251104101055,107.79322415,22.54080355,3.8,90
20251104101056,107.79323456,22.54080368,3.8,88
20251104101057,107.79324508,22.54080371,3.9,90
20251104101058,107.79325563,22.54080375,3.8,90
20251104101059,107.79326615,22.54080365,3.8,91
20251104101100,107.79327668,22.54080363,3.9,90
20251104101101,107.79328713,22.54080363,3.8,89
20251104101102,107.79329766,22.54080361,3.9,90
20251104101103,107.79330816,22.54080361,3.9,90
20251104101104,107.79331863,22.54080348,3.7,88
20251104101105,107.79332910,22.54080345,3.7,89
20251104101106,107.79333960,22.54080350,3.7,89
20251104101107,107.79335014,22.54080350,4,91
20251104101108,107.79336073,22.54080348,3.9,90
20251104101109,107.79337123,22.54080330,3.9,91
20251104101110,107.79338163,22.54080345,3.9,89
20251104101111,107.79339130,22.54080346,3.3,89
20251104101112,107.79339833,22.54080336,2.4,90
20251104101113,107.79340435,22.54080330,2.6,86
20251104101114,107.79341106,22.54080328,2.2,92
20251104101115,107.79341520,22.54080326,1.5,96
20251104101116,107.79341728,22.54080321,0.4,93
20251104101117,107.79342100,22.54080316,1.2,79
20251104101118,107.79342283,22.54080316,0.5,103
20251104101240,107.79345918,22.54077698,3.8,271
20251104101241,107.79344878,22.54077763,3.7,272
20251104101242,107.79343828,22.54077803,3.9,272
20251104101243,107.79342791,22.54077821,3.8,271
20251104101244,107.79342008,22.54077840,2.1,276
20251104101245,107.79342031,22.54077838,0,293
20251104101246,107.79342029,22.54077838,0,244
20251104101247,107.79342029,22.54077838,0,93
20251104101248,107.79342031,22.54077838,0,141
20251104101249,107.79342031,22.54077841,0,85
20251104101250,107.79342025,22.54077840,0,332
20251104101251,107.79342031,22.54077843,0,102
20251104101252,107.79342033,22.54077838,0,103
20251104101253,107.79342031,22.54077840,0,311
20251104101254,107.79342031,22.54077846,0,51
20251104101255,107.79342031,22.54077843,0,16
20251104101256,107.79342033,22.54077838,0,199
20251104101257,107.79342028,22.54077841,0,208
20251104101258,107.79342033,22.54077843,0,142
20251104101259,107.79342031,22.54077843,0,80
20251104101300,107.79342016,22.54077846,0,271
20251104101301,107.79341496,22.54077841,1.8,260
20251104101302,107.79340480,22.54077838,3.7,268
20251104101303,107.79339430,22.54077835,3.8,272
20251104101304,107.79338374,22.54077828,3.8,269
20251104101305,107.79337325,22.54077841,3.8,270
20251104101306,107.79336280,22.54077845,3.8,269
20251104101307,107.79335221,22.54077845,3.9,269
20251104101308,107.79334170,22.54077843,3.8,271
20251104101309,107.79333118,22.54077848,3.8,271
20251104101310,107.79332070,22.54077858,3.8,270
20251104101311,107.79331015,22.54077846,3.7,267
20251104101312,107.79329973,22.54077846,3.9,270
20251104101313,107.79328918,22.54077846,3.9,271
20251104101314,107.79327871,22.54077848,3.9,272
20251104101315,107.79326820,22.54077838,3.8,268
20251104101316,107.79325763,22.54077840,3.9,270
20251104101317,107.79324711,22.54077848,3.7,269
20251104101318,107.79323663,22.54077856,3.7,270
20251104101319,107.79322625,22.54077868,3.9,271
20251104101320,107.79321573,22.54077868,3.9,269
20251104101321,107.79320518,22.54077858,4,269
20251104101322,107.79319473,22.54077851,4,270
20251104101323,107.79318416,22.54077865,3.8,271
20251104101324,107.79317370,22.54077868,3.8,270
20251104101325,107.79316315,22.54077873,3.8,269
20251104101326,107.79315258,22.54077866,3.9,271
20251104101327,107.79314201,22.54077875,3.8,271
20251104101328,107.79313150,22.54077885,3.8,270
20251104101329,107.79312103,22.54077888,3.8,269
20251104101330,107.79311053,22.54077893,3.9,270
20251104101331,107.79310003,22.54077890,4,270
20251104101332,107.79308958,22.54077885,3.7,268
20251104101333,107.79307908,22.54077888,3.9,270
20251104101334,107.79306851,22.54077891,3.8,270
20251104101335,107.79305808,22.54077890,3.8,267
20251104101336,107.79304763,22.54077881,3.9,269
20251104101337,107.79303711,22.54077885,3.9,269
20251104101338,107.79302655,22.54077901,3.8,270
20251104101339,107.79301605,22.54077901,3.8,270</textarea>
            <div class="button-group">
                <button id="drawTrackButton" disabled style="flex: 1;">绘制轨迹</button>
                <button id="showTrackPointsButton" disabled style="flex: 1;" class="btn-warning">打点</button>
                <button id="clearTrackButton" disabled style="flex: 1;">清空轨迹</button>
            </div>
            <!-- 回放控制 -->
            <div class="split-section" style="margin-top:8px;">
                <div class="title">轨迹回放</div>
                <div class="playback-actions" style="display:flex;gap:8px;margin-bottom:8px;">
                    <button id="playbackStartBtn" disabled>开始</button>
                    <button id="playbackPauseBtn" disabled>继续</button>
                    <button id="playbackStopBtn" disabled>结束</button>
                </div>
                <div class="playback-speed" style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                    <label>速度：
                        <select id="playbackSpeedSelect" disabled>
                            <option value="1" selected>1×</option>
                            <option value="2">2×</option>
                            <option value="4">4×</option>
                            <option value="8">8×</option>
                            <option value="16">16×</option>
                            <option value="32">32×</option>
                            <option value="64">64×</option>
                            <option value="128">128×</option>
                            <option value="256">256×</option>
                            <option value="512">512×</option>
                            <option value="1024">1024×</option>
                        </select>
                    </label>
                    <span id="playbackTimeLabel" style="font-size:12px;color:#666;">时间：—</span>
                </div>
                <div class="playback-time" style="display:flex;flex-direction:column;gap:4px;margin-bottom:8px;">
                    <label class="playback-time-label" style="display:flex;align-items:center;gap:8px;flex:1 1 auto;min-width:0;">
                        <span class="playback-time-text" style="white-space:nowrap;">起始时间：</span>
                        <input type="range" id="playbackTimeSlider" disabled min="0" max="0" step="1000" value="0" style="flex:1 1 auto;min-width:0;max-width:100%;vertical-align:middle;">
                    </label>
                    <span id="playbackTimeCursor" style="font-size:12px;color:#666;align-self:flex-end;">—</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let map;
    let currentPolygons = []; // 存储多边形和其标签
    let currentTracks = []; // 存储轨迹折线及相关覆盖物
    let mapLoaded = false;
    let mapLabelHandlers = []; // 存储地图事件处理器
    let labelsEnabled = false; // 标签显示开关（默认关闭）
    let isDrawing = false; // 绘制进行中防止重复点击

    window.onload = function () {
        if (typeof T === 'undefined') {
            alert("天地图API加载失败，请检查网络或密钥！");
            return;
        }
        initMap();
        bindDrawEvent();
        bindMinimizeEvent();
        bindTabs();
        bindBatchGenerator();
        bindMultiSplitter();
        bindLabelsToggle(); // 绑定标签显示开关
        bindTrackEvents();  // 绑定轨迹绘制与清空
        bindPlaybackControls(); // 绑定轨迹回放
    };

    function initMap() {
        showLoading();
        disableButtons(true);

        try {
            map = new T.Map("mapContainer", {
                zoom: 12,
                center: new T.LngLat(116.40769, 39.90403)
            });

            // 已移除测试标签
            map.enableScrollWheelZoom();

            // 添加地图类型控件
            const mapTypeCtrl = new T.Control.MapType({
                mapTypes: [TMAP_NORMAL_MAP, TMAP_SATELLITE_MAP, TMAP_TERRAIN_MAP],
                position: T_ANCHOR_TOP_LEFT
            });
            map.addControl(mapTypeCtrl);

            // 加载影像底图（卫星）
            const tk = "648f621977051d0199ff0f965d3fd322";

            // 方案1：使用默认地图类型（作为备选）
            map.setMapType(TMAP_SATELLITE_MAP);

            // 方案2：手动添加影像图层（底图 + 标注）
            const vecLayer = new T.TileLayer(`https://t0.tianditu.gov.cn/img_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=img&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`);
            const cvaLayer = new T.TileLayer(`https://t0.tianditu.gov.cn/cia_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cia&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${tk}`);

            // 添加图层并监听加载状态
            vecLayer.addEventListener("load", function () {
                console.log("影像底图加载完成");
            });

            vecLayer.addEventListener("error", function (e) {
                console.error("影像底图加载错误:", e);
                alert("影像底图加载错误，将使用默认地图类型");
            });

            map.addLayer(vecLayer);
            map.addLayer(cvaLayer);

            // 监听地图加载事件
            map.addEventListener("loaded", function () {
                console.log("地图加载完成");
                markMapLoaded();
            });
            map.addEventListener("load", function () {
                console.log("地图load事件触发");
                markMapLoaded();
            });
            map.addEventListener("tilesloaded", function () {
                console.log("地图瓦片加载完成");
                markMapLoaded();
            });
            // 监听地图加载失败事件
            map.addEventListener("error", function (e) {
                console.error("地图加载错误:", e);
                alert("地图加载错误: " + e.message);
                hideLoading();
            });

            // 监听地图移动事件，用于更新标签位置
            const moveHandler = function () {
                updateAllLabelsPosition();
            };
            map.addEventListener("move", moveHandler);
            map.addEventListener("zoom", moveHandler);

            // 存储事件处理器，用于清理
            mapLabelHandlers.push({ event: "move", handler: moveHandler });
            mapLabelHandlers.push({ event: "zoom", handler: moveHandler });

            // 超时容错
            setTimeout(() => {
                if (!mapLoaded) markMapLoaded();
            }, 8000);

        } catch (error) {
            alert("地图初始化失败：" + error.message);
            console.error(error);
            hideLoading();
        }
    }

    function markMapLoaded() {
        if (!mapLoaded) {
            mapLoaded = true;
            hideLoading();
            disableButtons(false);
            disableTrackButtons(false);
            // 仅开启速度选择，回放按钮按状态控制
            const speedSel = document.getElementById('playbackSpeedSelect');
            if (speedSel) speedSel.disabled = false;
            updatePlaybackButtonsState('idle');
        }
    }

    function showLoading() {
        const loading = document.getElementById("mapLoading");
        loading.style.display = "flex";
        loading.style.opacity = "1";
    }

    function hideLoading() {
        const loading = document.getElementById("mapLoading");
        loading.style.opacity = "0";
        setTimeout(() => loading.style.display = "none", 300);
    }

    function disableButtons(disabled) {
        document.getElementById("drawButton").disabled = disabled;
        document.getElementById("clearButton").disabled = disabled;
    }

    function disableTrackButtons(disabled) {
        const drawTrackBtn = document.getElementById("drawTrackButton");
        const showTrackPointsBtn = document.getElementById("showTrackPointsButton");
        const clearTrackBtn = document.getElementById("clearTrackButton");
        if (drawTrackBtn) drawTrackBtn.disabled = disabled;
        if (showTrackPointsBtn) showTrackPointsBtn.disabled = disabled;
        if (clearTrackBtn) clearTrackBtn.disabled = disabled;
    }
    // 回放控件的禁用/启用
    function disablePlaybackButtons(disabled) {
        ["playbackStartBtn","playbackPauseBtn","playbackStopBtn","playbackSpeedSelect","playbackTimeSlider"].forEach(id=>{
            const el = document.getElementById(id);
            if (el) el.disabled = disabled;
        });
    }

    // 回放按钮状态管理：空闲/播放/暂停
    function updatePlaybackButtonsState(state){
        try {
            const startBtn = document.getElementById('playbackStartBtn');
            const pauseBtn = document.getElementById('playbackPauseBtn');
            const stopBtn = document.getElementById('playbackStopBtn');
            if (!startBtn || !pauseBtn || !stopBtn) return;
            if (state === 'idle') {
                startBtn.disabled = false;
                pauseBtn.disabled = true;
                stopBtn.disabled = true;
                pauseBtn.textContent = '继续';
            } else if (state === 'playing') {
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
                pauseBtn.textContent = '暂停';
            } else if (state === 'paused') {
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
                pauseBtn.textContent = '继续';
            }
        } catch(e) { console.warn('更新按钮状态失败:', e); }
    }

    function bindDrawEvent() {
        document.getElementById("drawButton").addEventListener("click", function () {
            if (isDrawing) { console.log('绘制进行中，忽略重复点击'); return; }
            isDrawing = true;
            disableButtons(true);
            showLoading();
            try {
                const wktStr = document.getElementById("wktTextarea").value.trim();
                if (!wktStr) { alert("请输入WKT字符串！"); return; }
                clearOverlays();
                const geojson = parseWkt(wktStr);
    
                const polygonData = [];
                if (geojson.type === "Polygon") {
                    polygonData.push({ index: 1, coordinates: geojson.coordinates });
                } else if (geojson.type === "MultiPolygon") {
                    geojson.coordinates.forEach((polygon, index) => {
                        polygonData.push({ index: index + 1, coordinates: polygon });
                    });
                }
    
                // 重置并绘制
                polygonInfoList = [];
                polygonData.forEach(pd => processPolygon(pd.index, pd.coordinates));
    
                // 视图居中到所有已绘制轮廓
                try { fitViewportToPolygons(); } catch (e) { console.warn('视图居中失败', e); }
    
                // 在视图稳定后再创建/更新标签
                setTimeout(() => {
                    if (labelsEnabled) {
                        try {
                            createAllLabels();
                            updateAllLabelsPosition();
                        } catch (e) {
                            console.warn('创建或更新标签失败:', e);
                        }
                    }
                }, 150);
            } catch (e) {
                alert('绘制失败：' + (e && e.message ? e.message : e));
                console.error('绘制异常:', e);
            } finally {
                hideLoading();
                isDrawing = false;
                disableButtons(false);
            }
        });

        document.getElementById("clearButton").addEventListener("click", function () {
            if (isDrawing) { console.log('绘制进行中，暂不清空'); return; }
            clearOverlays();
            console.log("已清空所有轮廓");
        });
    }

    // 存储多边形数据，用于后续标签创建
    let polygonInfoList = [];

    // 处理单个多边形的绘制和面积计算
    function processPolygon(actualPolygonIndex, polygonCoords) {
        console.log('开始处理多边形', actualPolygonIndex);

        // 坐标系选择（绘制始终使用WGS84坐标）
        const coordSys = (document.getElementById('coordSysSelect') && document.getElementById('coordSysSelect').value) || 'wgs84';

        // 统一转换为WGS84用于绘制与面积计算
        function toWgs(point){
            const lng = point[0], lat = point[1];
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                return [lng, lat];
            } else if (coordSys === 'gcj02') {
                const w = gcj02ToWgs84(lng, lat);
                return [w.lng, w.lat];
            } else if (coordSys === 'bd09') {
                const gcj = bd09ToGcj02(lng, lat);
                const w = gcj02ToWgs84(gcj.lng, gcj.lat);
                return [w.lng, w.lat];
            }
            return [lng, lat];
        }
        const coordsWGS84 = polygonCoords.map(ring => ring.map(toWgs));
        let outerRingWGS = coordsWGS84[0] || [];

        // 生成用于绘制的坐标（直接使用WGS84坐标）
        const rings = coordsWGS84.map(ring => ring.map(([lng, lat]) => new T.LngLat(lng, lat)));


         // 创建半透明填充的多边形（无边框）
          const polygon = new T.Polygon(rings, {
              color: "#FFD700",
              weight: 1,
              opacity: 1,
              fillColor: "#FFFF00",
              fillOpacity: 0.35
          });
 
          // 使用WGS84坐标计算面积（更准确的面积计算）
         let areaSqm;
         let areaMu;



         try {
             // 检查Turf.js是否可用
             if (typeof turf !== 'undefined' && turf.area) {
                 // 使用Turf.js计算多边形面积
                // 构造GeoJSON格式的多边形
                const geoJsonPolygon = {
                    type: "Polygon",
                    coordinates: coordsWGS84
                };


                 // 使用Turf.js计算面积（平方米）
                 areaSqm = turf.area(geoJsonPolygon);
                 areaMu = (areaSqm / 666.6667).toFixed(4); // 转换为亩
                 console.log(`多边形${actualPolygonIndex}面积计算结果(Turf.js): ${areaSqm}平方米 = ${areaMu}亩`);
             } else {
                 // 如果Turf.js不可用，回退到之前的计算方法
                 console.warn('Turf.js不可用，使用备用计算方法');
                 // 计算带孔洞的多边形面积
                 areaSqm = 0;
                 // 计算外环面积
                 outerRingWGS = coordsWGS84[0] || [];
                 areaSqm += calculatePolygonArea(outerRingWGS);

                 // 减去内环（孔洞）面积
                 for (let i = 1; i < coordsWGS84.length; i++) {
                     const innerRingArea = calculatePolygonArea(coordsWGS84[i]);
                     areaSqm -= innerRingArea;
                 }

                  areaMu = (areaSqm / 666.6667).toFixed(4); // 使用更精确的转换系数
                  console.log(`多边形${actualPolygonIndex}面积计算结果(备用): ${areaSqm}平方米 = ${areaMu}亩`);
              }
          } catch (error) {
              console.error(`面积计算失败:`, error);
              areaSqm = 0;
              areaMu = '0.0000';
          }

          // 计算多边形的中心点和底部中心点（WGS84）
          const centerPoint = calculatePolygonCenter(outerRingWGS);
          const bottomCenterPoint = calculatePolygonBottomCenter(outerRingWGS);

          // 添加多边形到地图
          if (map) {
              map.addOverLay(polygon);
              console.log(`多边形${actualPolygonIndex}已添加到地图`);
          } else {
              console.error('地图对象不存在');
          }

          // 存储多边形信息，用于后续标签创建
          polygonInfoList.push({
              index: actualPolygonIndex,
              polygon: polygon,
              area: areaMu,
              bottomCenter: { lng: bottomCenterPoint.lng, lat: bottomCenterPoint.lat },
              ringPoints: rings
          });
      }

    // 视图居中：根据已绘制的GCJ-02点
    function fitViewportToPolygons() {
        const points = [];
        try {
            if (!map || !map.setViewport) return;
            polygonInfoList.forEach(info => {
                if (!info || !info.ringPoints) return;
                info.ringPoints.forEach(ring => {
                    ring.forEach(ll => points.push(ll));
                });
            });
            if (!points.length) return;
            map.setViewport(points);
        } catch (e) {
            try {
                const lngs = points.map(p => p.lng);
                const lats = points.map(p => p.lat);
                const center = new T.LngLat(
                    (Math.min(...lngs) + Math.max(...lngs)) / 2,
                    (Math.min(...lats) + Math.max(...lats)) / 2
                );
                if (map && map.panTo) map.panTo(center);
            } catch (e2) {
                console.warn('视图居中失败:', e2);
            }
        }
    }

    // 统一创建所有多边形的标签
    function createAllLabels() {
        const mapContainer = document.getElementById('mapContainer');
        if (!mapContainer || !map) return;

        polygonInfoList.forEach(info => {
            if (!info) return;
            // 防止重复创建
            if (info.labelRef) return;
            // 创建标签元素
            const labelDiv = document.createElement('div');
            labelDiv.className = 'area-label';
            labelDiv.innerHTML = `多边形${info.index}：${info.area}亩`;

            // 添加到地图容器并根据屏幕边界定位到轮廓下方
            mapContainer.appendChild(labelDiv);
            positionLabelForPolygon(labelDiv, info);

            // 记录引用，避免重复创建
            info.labelRef = labelDiv;

            // 存储到 currentPolygons 以复用现有定位/清理逻辑
            const labelObj = {
                domElement: labelDiv,
                isDomLabel: true,
                polygonInfo: info
            };
            currentPolygons.push({ polygon: info.polygon, label: labelObj });
        });

        // 不清空 polygonInfoList，便于开关随时创建/隐藏标签
    }

    // 根据多边形屏幕边界定位标签，保证始终在轮廓下方
    function positionLabelForPolygon(labelDiv, info) {
        if (!map || !info || !info.ringPoints) return;
        const points = [];
        info.ringPoints.forEach(ring => {
            ring.forEach(ll => {
                const p = map.lngLatToContainerPoint(ll);
                points.push(p);
            });
        });
        if (!points.length) return;
        const minX = Math.min(...points.map(p => p.x));
        const maxX = Math.max(...points.map(p => p.x));
        const maxY = Math.max(...points.map(p => p.y));
        const container = document.getElementById('mapContainer');
        const labelWidth = labelDiv.offsetWidth;
        const labelHeight = labelDiv.offsetHeight;
        const targetLeft = Math.round((minX + maxX) / 2 - labelWidth / 2);
        const targetTop = Math.round(maxY + 6);
        const clampedLeft = Math.max(0, Math.min(targetLeft, container.clientWidth - labelWidth));
        const clampedTop = Math.max(0, Math.min(targetTop, container.clientHeight - labelHeight));
        labelDiv.style.left = clampedLeft + 'px';
        labelDiv.style.top = clampedTop + 'px';
    }

    // 更新所有标签位置（地图move/zoom时调用）
    function updateAllLabelsPosition() {
        try {
            if (!map) return;
            const container = document.getElementById('mapContainer');
            if (!container) return;
            currentPolygons.forEach(item => {
                if (!item || !item.label) return;
                const labelObj = item.label;
                if (labelObj.isDomLabel && labelObj.domElement && labelObj.polygonInfo) {
                    // 确保标签在容器中
                    if (!labelObj.domElement.parentNode) {
                        container.appendChild(labelObj.domElement);
                    }
                    positionLabelForPolygon(labelObj.domElement, labelObj.polygonInfo);
                }
            });
        } catch (e) {
            console.warn('更新标签位置时出错:', e);
        }
    }
    // 确保在全局可用（处理第三方库事件回调作用域差异）
    window.updateAllLabelsPosition = updateAllLabelsPosition;

    // 绑定“显示亩数标签”开关（默认隐藏）
    function bindLabelsToggle() {
        const cb = document.getElementById('toggleLabelsCheckbox');
        const container = document.getElementById('mapContainer');
        if (!cb || !container) return;
        // 默认隐藏标签
        container.classList.add('labels-hidden');
        cb.addEventListener('change', () => {
            labelsEnabled = cb.checked;
            if (labelsEnabled) {
                container.classList.remove('labels-hidden');
                const hasAnyLabel = currentPolygons.some(item => item && item.label && item.label.domElement);
                if (!hasAnyLabel) {
                    try { createAllLabels(); } catch (e) { console.warn('创建标签失败:', e); }
                }
                updateAllLabelsPosition();
            } else {
                container.classList.add('labels-hidden');
            }
        });
    }

    /**
     * 计算多边形中心点（比底部中心更适合显示标签）
     */
    function calculatePolygonCenter(outerRing) {
        let sumLng = 0, sumLat = 0;
        const len = outerRing.length;

        for (let i = 0; i < len; i++) {
            sumLng += outerRing[i][0];
            sumLat += outerRing[i][1];
        }

        return {
            lng: sumLng / len,
            lat: sumLat / len
        };
    }

    /**
     * 计算多边形面积（球面多边形面积计算）
     * 使用更准确的球面坐标面积计算方法，确保面积与视觉大小一致
     */
    function calculatePolygonArea(coordinates) {
        // 地球半径（米）- 使用更精确的值
        const R = 6371000.8;
        const n = coordinates.length;

        // 将所有坐标转换为弧度
        const coordsRad = coordinates.map(point => [
            point[0] * Math.PI / 180,
            point[1] * Math.PI / 180
        ]);

        let areaRad = 0;

        // 使用更准确的球面多边形面积公式（Girard定理）
        for (let i = 0; i < n; i++) {
            const j = (i + 1) % n;
            const lon1 = coordsRad[i][0];
            const lat1 = coordsRad[i][1];
            const lon2 = coordsRad[j][0];
            const lat2 = coordsRad[j][1];

            // 计算球面多边形面积增量
            const dlon = lon2 - lon1;
            const sinLat1 = Math.sin(lat1);
            const sinLat2 = Math.sin(lat2);
            const cosLat1 = Math.cos(lat1);
            const cosLat2 = Math.cos(lat2);

            // 使用更精确的公式
            areaRad += dlon * (sinLat1 * cosLat2 * Math.cos(dlon / 2) + sinLat2 * cosLat1);
        }

        // 计算总面积（平方米）
        const areaSqm = Math.abs(areaRad) * R * R * 0.5;

        return areaSqm;
    }

    /**
     * 清空所有多边形和标签（同时处理 polygonInfoList 与 currentPolygons）
     */
    function clearOverlays() {
        try {
            // 先移除 polygonInfoList 中记录的多边形与其DOM标签
            polygonInfoList.forEach(info => {
                if (info && info.polygon && map && map.removeOverLay) {
                    try { map.removeOverLay(info.polygon); } catch (e) { console.warn('移除多边形失败:', e); }
                }
                if (info && info.labelRef && info.labelRef.parentNode) {
                    try { info.labelRef.parentNode.removeChild(info.labelRef); } catch (e) { console.warn('移除DOM标签失败:', e); }
                    info.labelRef = null;
                }
            });

            // 再处理 currentPolygons（兼容旧路径与标签对象）
            currentPolygons.forEach(item => {
                if (item.polygon && map && map.removeOverLay) {
                    try { map.removeOverLay(item.polygon); } catch (e) { console.warn('移除多边形失败:', e); }
                }
                if (item.label) {
                    if (item.label.domElement && item.label.domElement.parentNode) {
                        try { item.label.domElement.parentNode.removeChild(item.label.domElement); } catch (e) { console.warn('移除DOM标签失败:', e); }
                    } else if (map && map.removeOverLay && !item.label.isDomLabel) {
                        try { map.removeOverLay(item.label); } catch (e) { console.warn('移除地图覆盖物标签失败:', e); }
                    }
                }
            });

            // 清空记录数组
            currentPolygons = [];
            polygonInfoList = [];

            console.log('已清空所有多边形和标签（保留事件监听器）');
        } catch (error) {
            console.error('清空覆盖物时出错:', error);
        }
    }

    // 其他辅助函数（保持不变）
    function bindMinimizeEvent() {
        const container = document.querySelector(".wkt-input-container");
        const btn = document.getElementById("minimizeBtn");
        const minIcon = btn?.querySelector(".min-icon");
        const restoreIcon = btn?.querySelector(".restore-icon");

        btn?.addEventListener("click", () => {
            const minimized = container.classList.toggle("minimized");
            if (minIcon && restoreIcon) {
                if (minimized) {
                    minIcon.style.display = "none";
                    restoreIcon.style.display = "";
                } else {
                    minIcon.style.display = "";
                    restoreIcon.style.display = "none";
                }
            }
        });
    }

    // 在脚本内部补充：页签切换（3个页签）
     function bindTabs() {
         const tabs = [
             { btn: document.getElementById('tabDrawBtn'), pane: document.getElementById('tabDraw'), key: 'draw' },
             { btn: document.getElementById('tabTrackBtn'), pane: document.getElementById('tabTrack'), key: 'track' },
             { btn: document.getElementById('tabSplitBtn'), pane: document.getElementById('tabSplit'), key: 'split' },
             { btn: document.getElementById('tabBatchBtn'), pane: document.getElementById('tabBatch'), key: 'batch' },
         ];
         if (tabs.some(t => !t.btn || !t.pane)) return;
         function activate(key) {
             tabs.forEach(t => {
                 const active = t.key === key;
                 t.btn.classList.toggle('active', active);
                 t.pane.classList.toggle('active', active);
             });
         }
         tabs.forEach(t => t.btn.addEventListener('click', () => activate(t.key)));
         activate('draw');
     }
    function updateParserStatus() {
        const el = document.getElementById('parserStatus');
        if (!el) return;
        const ok = (typeof Terraformer !== 'undefined' && Terraformer.WKT && typeof Terraformer.WKT.parse === 'function');
        if (ok) {
            el.textContent = 'Terraformer WKT Parser';
            el.style.color = '#2f8f2f';
        } else {
            el.textContent = '本地回退解析（仅支持POLYGON/MULTIPOLYGON）';
            el.style.color = '#c77d1e';
        }
    }
     function parseWkt(wkt) {
         wkt = wkt.trim();
         // 优先使用成熟库（Terraformer WKT Parser）
         if (typeof Terraformer !== 'undefined' && Terraformer.WKT && Terraformer.WKT.parse) {
             try {
                 return Terraformer.WKT.parse(wkt);
             } catch (e) {
                 console.warn('Terraformer解析失败，尝试本地回退解析:', e);
             }
         } else {
             // 不再提示“未加载”，由状态栏展示回退信息
         }
         // 回退解析：仅支持 POLYGON / MULTIPOLYGON
         const typeMatch = wkt.match(/^\s*(POLYGON|MULTIPOLYGON)\s*\(/i);
         if (!typeMatch) throw new Error('仅支持POLYGON/MULTIPOLYGON');
         const type = typeMatch[1].toUpperCase();
         const inner = wkt.substring(wkt.indexOf('('));
         if (type === 'POLYGON') {
             const coords = parsePolygonCoords(inner.replace(/^\(/, '').replace(/\)$/, ''));
             return { type: 'Polygon', coordinates: coords };
         } else {
             const trimmed = inner.replace(/^\(\(/, '').replace(/\)\)$/, '');
             const coords = parseMultiPolygonCoords(trimmed);
             return { type: 'MultiPolygon', coordinates: coords };
         }
     }

     function bindMultiSplitter() {
         const input = document.getElementById('multiInput');
         const output = document.getElementById('polyOutput');
         const splitBtn = document.getElementById('splitMultiBtn');
         const copyBtn = document.getElementById('copyPolysBtn');
         if (!input || !output || !splitBtn || !copyBtn) return;

         // 本地WKT序列化辅助
         function ringToText(ring) {
             if (!ring || !ring.length) return '()';
             const first = ring[0];
             const last = ring[ring.length - 1];
             const closed = (first[0] === last[0] && first[1] === last[1]) ? ring : ring.concat([[first[0], first[1]]]);
             return '(' + closed.map(pt => pt[0] + ' ' + pt[1]).join(', ') + ')';
         }
         function toWktPolygonCoords(coords) {
             return 'POLYGON(' + coords.map(ringToText).join(', ') + ')';
         }
         function toWktMulti(coords) {
             return 'MULTIPOLYGON(' + coords.map(poly => '(' + poly.map(ringToText).join(', ') + ')').join(', ') + ')';
         }

         function polygonsFromMulti(text) {
             const geo = parseWkt(text.trim());
             if (geo.type !== 'MultiPolygon') throw new Error('请输入有效的 MULTIPOLYGON WKT');
             const polys = geo.coordinates.map(rings => toWktPolygonCoords(rings));
             return polys;
         }
         splitBtn.addEventListener('click', () => {
             try {
                 const list = polygonsFromMulti(input.value.trim());
                 output.value = list.join('\n');
             } catch (e) {
                 alert('分割失败：' + e.message);
             }
         });
         copyBtn.addEventListener('click', async () => {
             const val = output.value.trim();
             if (!val) { alert('没有可复制的结果'); return; }
             try { await navigator.clipboard.writeText(val); alert('已复制到剪贴板'); } catch (e) { console.warn('复制失败', e); }
         });
     }

     function bindBatchGenerator() {
         const batchInput = document.getElementById('batchInput');
         const output = document.getElementById('multiOutput');
         const genBtn = document.getElementById('generateMultiBtn');
         const copyBtn = document.getElementById('copyMultiBtn');

         // 本地WKT序列化辅助（与分割器保持一致）
         function ringToText(ring) {
             if (!ring || !ring.length) return '()';
             const first = ring[0];
             const last = ring[ring.length - 1];
             const closed = (first[0] === last[0] && first[1] === last[1]) ? ring : ring.concat([[first[0], first[1]]]);
             return '(' + closed.map(pt => pt[0] + ' ' + pt[1]).join(', ') + ')';
         }
         function toWktMulti(coords) {
             return 'MULTIPOLYGON(' + coords.map(poly => '(' + poly.map(ringToText).join(', ') + ')').join(', ') + ')';
         }

         genBtn.addEventListener('click', () => {
             try {
                 const lines = batchInput.value.trim().split(/\n|;/).map(s => s.trim()).filter(Boolean);
                 if (lines.length === 0) throw new Error('请按每行或分号输入至少一个POLYGON');
                 const polygons = lines.map((line, idx) => {
                     const g = parseWkt(line);
                     if (g.type !== 'Polygon') throw new Error(`第${idx + 1}行不是有效的POLYGON WKT`);
                     return g;
                 });
                 const multiGeo = { type: 'MultiPolygon', coordinates: polygons.map(p => p.coordinates) };
                 output.value = toWktMulti(multiGeo.coordinates);
             } catch (e) {
                 alert('生成失败：' + e.message);
             }
         });

         copyBtn.addEventListener('click', async () => {
             const val = output.value.trim();
             if (!val) { alert('没有可复制的结果'); return; }
             try { await navigator.clipboard.writeText(val); alert('已复制到剪贴板'); } catch (e) { console.warn('复制失败', e); }
         });

     }

     function setExampleWkt() {
         const exampleWkt = "MULTIPOLYGON(" +
             "(" +
             "(116.35 39.93, 116.39 39.93, 116.39 39.90, 116.35 39.90, 116.35 39.93)," + // 外环
             "(116.36 39.92, 116.38 39.92, 116.38 39.91, 116.36 39.91, 116.36 39.92)" +  // 内环
             ")," +
             "(" +
             "(116.40 39.95, 116.43 39.97, 116.46 39.96, 116.49 39.98, 116.52 39.95, 116.55 39.93, 116.58 39.94, 116.61 39.92, 116.64 39.95, 116.40 39.95)" +
             ")" +
             ")";
         document.getElementById("wktTextarea").value = exampleWkt;
     }

     function parsePolygonCoords(coordStr) {
         const ringStrs = coordStr.split(/\)\s*,\s*\(/).map(s => s.replace(/[()]/g, '').trim());
         const rings = [];
         ringStrs.forEach(ringStr => {
             const pts = ringStr.split(/,\s*/).map(pointStr => {
                 const [lng, lat] = pointStr.split(/\s+/).map(Number);
                 if (isNaN(lng) || isNaN(lat)) throw new Error("坐标格式错误：" + pointStr);
                 return [lng, lat];
             });
             // 自动拆分：如果一个ring中包含多次回到起点（闭合），则拆分为多个环
             // 兼容用户将外环与内环错误地写在同一对括号中的情况
             let start = 0;
             while (start < pts.length) {
                 const startPt = pts[start];
                 let closeIdx = -1;
                 for (let i = start + 1; i < pts.length; i++) {
                     if (pts[i][0] === startPt[0] && pts[i][1] === startPt[1]) {
                         closeIdx = i;
                         break;
                     }
                 }
                 if (closeIdx === -1) {
                     // 未找到闭合：将剩余点视为一个环，并强制闭合
                     const ring = pts.slice(start);
                     if (ring.length && (ring[0][0] !== ring[ring.length - 1][0] || ring[0][1] !== ring[ring.length - 1][1])) {
                         ring.push([ring[0][0], ring[0][1]]);
                     }
                     rings.push(ring);
                     break;
                 } else {
                     const ring = pts.slice(start, closeIdx + 1);
                     rings.push(ring);
                     start = closeIdx + 1;
                 }
             }
         });
         return rings;
     }

     function parseMultiPolygonCoords(coordStr) {
         const polygonStrs = coordStr.split(/\)\s*\)\s*,\s*\(\s*\(/).map(s => s.replace(/[()]/g, '').trim());
         return polygonStrs.map(polygonStr => parsePolygonCoords(polygonStr));
     }

     function wgs84ToGcj02(lng, lat) {
         const x_PI = 3.14159265358979324 * 3000.0 / 180.0;
         const PI = 3.1415926535897932384626;
         const a = 6378245.0;
         const ee = 0.00669342162296594323;

         if (outOfChina(lng, lat)) return { lng, lat };

         let dlat = transformLat(lng - 105.0, lat - 35.0);
         let dlng = transformLng(lng - 105.0, lat - 35.0);
         const radlat = lat / 180.0 * PI;
         let magic = Math.sin(radlat);
         magic = 1 - ee * magic * magic;
         const sqrtmagic = Math.sqrt(magic);
         dlat = (dlat * 180.0) / ((a * (1 - ee)) / (magic * sqrtmagic) * PI);
         dlng = (dlng * 180.0) / (a / sqrtmagic * Math.cos(radlat) * PI);

         return { lng: lng + dlng, lat: lat + dlat };

         function outOfChina(lng, lat) {
             return (lng < 72.004 || lng > 137.8347) || (lat < 0.8293 || lat > 55.8271);
         }

         function transformLat(x, y) {
             let ret = -100.0 + 2.0 * x + 3.0 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * Math.sqrt(Math.abs(x));
             ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
             ret += (20.0 * Math.sin(y * PI) + 40.0 * Math.sin(y / 3.0 * PI)) * 2.0 / 3.0;
             ret += (160.0 * Math.sin(y / 12.0 * PI) + 320 * Math.sin(y * PI / 30.0)) * 2.0 / 3.0;
             return ret;
         }

         function transformLng(x, y) {
             let ret = 300.0 + x + 2.0 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * Math.sqrt(Math.abs(x));
             ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
             ret += (20.0 * Math.sin(x * PI) + 40.0 * Math.sin(x / 3.0 * PI)) * 2.0 / 3.0;
             ret += (150.0 * Math.sin(x / 12.0 * PI) + 300.0 * Math.sin(x / 30.0 * PI)) * 2.0 / 3.0;
             return ret;
         }
     }

     function gcj02ToWgs84(lng, lat) {
         const g = wgs84ToGcj02(lng, lat);
         return { lng: lng * 2 - g.lng, lat: lat * 2 - g.lat };
     }

     function bd09ToGcj02(bdLng, bdLat) {
         const x_PI = 3.14159265358979324 * 3000.0 / 180.0;
         const x = bdLng - 0.0065;
         const y = bdLat - 0.006;
         const z = Math.sqrt(x * x + y * y) - 0.00002 * Math.sin(y * x_PI);
         const theta = Math.atan2(y, x) - 0.000003 * Math.cos(x * x_PI);
         const ggLng = z * Math.cos(theta);
         const ggLat = z * Math.sin(theta);
         return { lng: ggLng, lat: ggLat };
     }

     function calculatePolygonBottomCenter(outerRing) {
         let minLat = Infinity;
         let bottomPoints = [];
         outerRing.forEach(point => {
             const lat = point[1];
             if (lat < minLat) {
                 minLat = lat;
                 bottomPoints = [point];
             } else if (lat === minLat) {
                 bottomPoints.push(point);
             }
         });

         const sumLng = bottomPoints.reduce((sum, point) => sum + point[0], 0);
         const centerLng = sumLng / bottomPoints.length;

         return { lng: centerLng, lat: minLat };
     }

     function fitBounds(geojson) {
         try {
             const allPoints = [];
             function collectPoints(coords) {
                 if (typeof coords[0] === 'number') {
                     allPoints.push(coords);
                 } else {
                     coords.forEach(coord => collectPoints(coord));
                 }
             }
             collectPoints(geojson.coordinates);

             if (allPoints.length === 0) return;

             const lats = allPoints.map(p => p[1]);
             const lngs = allPoints.map(p => p[0]);
             const minLng = Math.min(...lngs);
             const maxLng = Math.max(...lngs);
             const minLat = Math.min(...lats);
             const maxLat = Math.max(...lats);

             const sw = wgs84ToGcj02(minLng, minLat);
             const ne = wgs84ToGcj02(maxLng, maxLat);

             // 修复setViewport方法的使用，确保参数格式正确
             if (map && map.setViewport) {
                 map.setViewport([
                     new T.LngLat(sw.lng, sw.lat),
                     new T.LngLat(ne.lng, ne.lat)
                 ], { padding: [50, 50] });
             } else {
                 console.warn('地图对象或setViewport方法不可用');
             }
         } catch (error) {
             console.error('调整视图范围时出错:', error);
         }
     }
// 轨迹绘制与解析
    function bindTrackEvents() {
        const drawBtn = document.getElementById('drawTrackButton');
        const showPointsBtn = document.getElementById('showTrackPointsButton');
        const clearBtn = document.getElementById('clearTrackButton');
        const ta = document.getElementById('trackTextarea');
        if (!drawBtn || !showPointsBtn || !clearBtn || !ta) return;

        drawBtn.addEventListener('click', function(){
            try {
                const text = ta.value.trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const points = parseTrackText(text);
                if (points.length < 2) { alert('有效轨迹点不足，至少需要两点'); return; }
                drawTrackFromPoints(points);
                fitViewportToTrack(points);
            } catch (e) {
                alert('绘制轨迹失败：' + (e && e.message ? e.message : e));
                console.error('绘制轨迹异常:', e);
            }
        });

        showPointsBtn.addEventListener('click', function(){
            try {
                const text = ta.value.trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const points = parseTrackText(text);
                if (points.length === 0) { alert('未找到有效轨迹点'); return; }
                showTrackPoints(points);
                fitViewportToTrack(points);
            } catch (e) {
                alert('显示轨迹点失败：' + (e && e.message ? e.message : e));
                console.error('显示轨迹点异常:', e);
            }
        });

        clearBtn.addEventListener('click', function(){
            clearTrackOverlays();
            console.log('已清空轨迹');
        });
    }

    function showTrackPoints(points) {
        // 先移除旧轨迹（不影响轮廓）
        clearTrackOverlays(false);
        
        if (!map || !points || points.length === 0) {
            console.log('无轨迹点可显示');
            return;
        }
        
        console.log(`准备显示${points.length}个轨迹点`);
        
        // 使用批量处理和更小的图标来提高性能
        // 创建一个更小的红点SVG图标
        const smallRedDotIcon = new T.Icon({
            iconUrl: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1" height="1"><circle cx="0.5" cy="0.5" r="0.3" fill="%23FF0000"/></svg>',
            iconSize: new T.Point(1, 1),
            iconAnchor: new T.Point(0.5, 0.5)
        });
        
        // 优化批量添加点的速度
        const batchSize = 2000; // 增加每批处理的点数
        const concurrentBatches = 4; // 并发批次数量
        
        // 预创建点击事件处理函数，避免重复创建
        function createClickHandler(point, index) {
            return function() {
                const infoWindow = new T.InfoWindow({
                    content: `点${index + 1}<br/>经度: ${point.lng.toFixed(6)}<br/>纬度: ${point.lat.toFixed(6)}`,
                    offset: new T.Point(0, -20)
                });
                infoWindow.open(map, point);
            };
        }
        
        // 使用setTimeout实现更高效的批量添加，避免阻塞UI
        let currentIndex = 0;
        
        function addBatch() {
            if (currentIndex >= points.length) {
                console.log(`已显示${points.length}个轨迹点`);
                return;
            }
            
            // 添加当前批次的点
            const endIndex = Math.min(currentIndex + batchSize, points.length);
            const markersToAdd = [];
            
            // 先创建所有标记
            for (let i = currentIndex; i < endIndex; i++) {
                const point = points[i];
                const index = i;
                
                const marker = new T.Marker(point, {
                    icon: smallRedDotIcon
                });
                
                // 添加点击事件
                marker.addEventListener('click', createClickHandler(point, index));
                
                markersToAdd.push(marker);
            }
            
            // 批量添加到地图和数组
            markersToAdd.forEach(marker => {
                map.addOverLay(marker);
                currentTracks.push(marker);
            });
            
            currentIndex = endIndex;
            
            // 使用setTimeout而不是requestAnimationFrame，减少对渲染周期的依赖
            // 设置为0，将任务放入微任务队列，但允许UI有短暂的呼吸空间
            setTimeout(addBatch, 0);
        }
        
        // 启动批量添加
        addBatch();
    }
    
    // 恢复原始的clearTrackOverlays函数
    function clearTrackOverlays(resetArray = true){        
        try {
            currentTracks.forEach(pl => {
                if (pl && map && map.removeOverLay) {
                    try { map.removeOverLay(pl); } catch (e) { console.warn('移除轨迹失败:', e); }
                }
            });
            if (resetArray) currentTracks = [];
        } catch (e) {
            console.warn('清空轨迹时出错:', e);
        }
    }

    function parseTrackText(text){
        // 选择输入坐标系（优先使用轨迹页签专属选择器，若未设置则回退到绘制页签选择器）
        const coordSysEl = document.getElementById('trackCoordSysSelect') || document.getElementById('coordSysSelect');
        const coordSys = (coordSysEl && coordSysEl.value) || 'wgs84';
        const isHash = text.indexOf('#') !== -1;
        const items = isHash ? text.split('#') : text.split(/\r?\n/);
        const pts = [];
        for (let i=0;i<items.length;i++){
            const raw = items[i];
            if (!raw) continue;
            const line = raw.trim();
            if (!line) continue;
            const parts = line.split(',');
            if (parts.length < 3) continue;
            let lng = parseFloat((parts[isHash ? 0 : 1] || '').trim());
            let lat = parseFloat((parts[isHash ? 1 : 2] || '').trim());
            // 初步过滤：数值合法性与正常范围
            if (!isFinite(lng) || !isFinite(lat)) continue;
            if (lng === 0 || lat === 0) continue; // 丢弃0.0异常点
            if (lng < -180 || lng > 180 || lat < -90 || lat > 90) continue; // 超出经纬度范围丢弃

            // 将输入坐标转换为WGS84
            let w;
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                w = { lng, lat };
            } else if (coordSys === 'gcj02') {
                w = gcj02ToWgs84(lng, lat);
            } else if (coordSys === 'bd09') {
                const g = bd09ToGcj02(lng, lat);
                w = gcj02ToWgs84(g.lng, g.lat);
            } else {
                w = { lng, lat };
            }
            // 转换结果兜底检查
            if (!isFinite(w.lng) || !isFinite(w.lat)) continue;
            if (w.lng < -180 || w.lng > 180 || w.lat < -90 || w.lat > 90) continue;

            // 使用WGS84坐标绘制到地图
            pts.push(new T.LngLat(w.lng, w.lat));
        }
        return pts;
    }

    function drawTrackFromPoints(points){
        // 先移除旧轨迹（不影响轮廓）
        clearTrackOverlays(false);
        const polyline = new T.Polyline(points, {
            color: '#FF3B30',
            weight: 1,
            opacity: 0.9
        });
        if (map) {
            map.addOverLay(polyline);
        }
        currentTracks.push(polyline);
    }

    function clearTrackOverlays(resetArray = true){
        try {
            currentTracks.forEach(pl => {
                if (pl && map && map.removeOverLay) {
                    try { map.removeOverLay(pl); } catch (e) { console.warn('移除轨迹失败:', e); }
                }
            });
            if (resetArray) currentTracks = [];
        } catch (e) {
            console.warn('清空轨迹时出错:', e);
        }
    }


    function fitViewportToTrack(points){
        try {
            if (!map || !map.setViewport || !points || !points.length) return;
            map.setViewport(points);
        } catch (e) {
            console.warn('轨迹视图居中失败:', e);
        }
    }

    // ========= 轨迹回放功能 =========
    let playbackState = { points: [], idx: 0, speed: 1, timer: null, running: false, marker: null, line: null, path: [] };

    function bindPlaybackControls(){
        const startBtn = document.getElementById('playbackStartBtn');
        const pauseBtn = document.getElementById('playbackPauseBtn');
        const stopBtn = document.getElementById('playbackStopBtn');
        const speedSel = document.getElementById('playbackSpeedSelect');
        const timeSlider = document.getElementById('playbackTimeSlider');
        const timeCursor = document.getElementById('playbackTimeCursor');
        const ta = document.getElementById('trackTextarea');
        if (!startBtn || !pauseBtn || !stopBtn || !speedSel) return;

        // 初始按钮状态
        updatePlaybackButtonsState('idle');

        startBtn.addEventListener('click', function(){
            try {
                const text = (ta && ta.value || '').trim();
                if (!text) { alert('请粘贴轨迹文本（时间戳,经度,纬度）'); return; }
                const pts = parseTrackTextWithTime(text);
                if (pts.length < 2) { alert('有效轨迹点不足，至少需要两点'); return; }
                startPlayback(pts);
                // 状态在startPlayback中已设置为playing
            } catch (e) {
                alert('开始回放失败：' + (e && e.message ? e.message : e));
                console.error('开始回放异常:', e);
            }
        });

        pauseBtn.addEventListener('click', function(){
            if (!playbackState.running) {
                // 继续
                playbackState.running = true;
                scheduleNext();
                updatePlaybackButtonsState('playing');
            } else {
                // 暂停
                if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
                playbackState.running = false;
                updatePlaybackButtonsState('paused');
            }
        });

        stopBtn.addEventListener('click', function(){ 
            stopPlayback(); 
            updatePlaybackButtonsState('idle');
        });

        speedSel.addEventListener('change', function(){
            const v = parseFloat(speedSel.value);
            playbackState.speed = (isFinite(v) && v > 0) ? v : 1;
        });

        if (timeSlider) {
            timeSlider.addEventListener('input', function(){
                const ms = parseInt(timeSlider.value, 10);
                const txt = formatTimeForLabel(ms);
                if (timeCursor) timeCursor.textContent = txt;
            });
            timeSlider.addEventListener('change', function(){
                jumpToSliderTime();
            });
        }
    }

    function parseTrackTextWithTime(text){
        const coordSysEl = document.getElementById('trackCoordSysSelect') || document.getElementById('coordSysSelect');
        const coordSys = (coordSysEl && coordSysEl.value) || 'wgs84';
        const isHash = text.indexOf('#') !== -1;
        const items = isHash ? text.split('#') : text.split(/\r?\n/);
        const out = [];
        for (let i=0;i<items.length;i++){
            const raw = items[i];
            if (!raw) continue;
            const line = raw.trim();
            if (!line) continue;
            const parts = line.split(',');
            if (parts.length < 3) continue;
            const tsRaw = (parts[isHash ? 2 : 0] || '').trim();
            const ts = (tsRaw || '').replace(/\D/g,'');
            let lng = parseFloat((parts[isHash ? 0 : 1] || '').trim());
            let lat = parseFloat((parts[isHash ? 1 : 2] || '').trim());
            if (!isFinite(lng) || !isFinite(lat)) continue;
            if (lng === 0 || lat === 0) continue;
            if (lng < -180 || lng > 180 || lat < -90 || lat > 90) continue;
            const t = parseTimestamp(ts);
            if (!t) continue;
            let w;
            if (coordSys === 'wgs84' || coordSys === 'cgcs2000') {
                w = { lng, lat };
            } else if (coordSys === 'gcj02') {
                w = gcj02ToWgs84(lng, lat);
            } else if (coordSys === 'bd09') {
                const g = bd09ToGcj02(lng, lat);
                w = gcj02ToWgs84(g.lng, g.lat);
            } else { w = { lng, lat }; }
            if (!isFinite(w.lng) || !isFinite(w.lat)) continue;
            if (w.lng < -180 || w.lng > 180 || w.lat < -90 || w.lat > 90) continue;
            out.push({ ll: new T.LngLat(w.lng, w.lat), time: t, ts });
        }
        out.sort((a,b)=>a.time - b.time);
        return out;
    }

    function parseTimestamp(ts){
        const tstr = (ts || '').replace(/\D/g,'');
        const m = tstr && tstr.match(/^\d{14}$/);
        if (!m) return null;
        const y = parseInt(tstr.slice(0,4),10);
        const M = parseInt(tstr.slice(4,6),10) - 1;
        const d = parseInt(tstr.slice(6,8),10);
        const h = parseInt(tstr.slice(8,10),10);
        const m2 = parseInt(tstr.slice(10,12),10);
        const s = parseInt(tstr.slice(12,14),10);
        const dt = new Date(y,M,d,h,m2,s);
        return isNaN(dt.getTime()) ? null : dt;
    }

    function startPlayback(points){
        console.log('[Playback] startPlayback: 点数=', points && points.length);
        stopPlayback();
        playbackState.points = points;
        playbackState.idx = 0;
        playbackState.speed = playbackState.speed || 1;
        playbackState.running = true;
        // 配置时间滑动条，并尊重现有滑块位置作为起始
        configureTimeSlider(points);
        // 启用滑块
        const slider = document.getElementById('playbackTimeSlider');
        if (slider) slider.disabled = false;
        let initIdx = 0;
        if (slider && slider.min && slider.max) {
            const ms = parseInt(slider.value, 10);
            if (isFinite(ms)) initIdx = findIndexByTime(points, ms);
        }
        playbackState.idx = initIdx;
        const first = points[initIdx];
        console.log('[Playback] 首点:', first && first.ts, first && first.ll, 'initIdx=', initIdx);
        playbackState.path = points.slice(0, initIdx+1).map(p=>p.ll);
        playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 1, opacity: 0.9 });
        if (map) {
            map.addOverLay(playbackState.line);
        }
        currentTracks.push(playbackState.line);
        // 创建并定位DOM标记以保证可见移动
        ensurePlaybackDom(first.ll);
        updatePlaybackDom(first.ll);
        updatePlaybackTimeLabel(first.ts);
        try { fitViewportToTrack(points.map(p=>p.ll)); } catch(e){}
        // 更新按钮状态
        updatePlaybackButtonsState('playing');
        scheduleNext();
    }

    function scheduleNext(){
        if (!playbackState.running) return;
        if (!playbackState.points || playbackState.idx >= playbackState.points.length - 1) {
            playbackState.running = false;
            console.log('[Playback] 回放结束：idx=', playbackState.idx, '点数=', playbackState.points ? playbackState.points.length : 0);
            updatePlaybackButtonsState('idle'); // 播放结束后按钮回到初始状态：开始可点，继续/结束灰化
            return;
        }
        const next = playbackState.points[playbackState.idx+1];
        const speed = playbackState.speed || 1;
        const delay = Math.max(4, Math.round(1000 / speed)); // 1x=1000ms/点，2x=500ms/点...
        console.log('[Playback] scheduleNext: idx=', playbackState.idx, '->', playbackState.idx+1, 'delay=', delay, 'speed=', speed);
        playbackState.timer = setTimeout(()=>{
            playbackState.idx++;
            const nextLL = next.ll;
            console.log('[Playback] 下一点:', next && next.ts, nextLL);
            try {
                // 维护路径数组
                playbackState.path = playbackState.path || [];
                playbackState.path.push(nextLL);
                console.log('[Playback] 路径长度=', playbackState.path.length);
                // 使用DOM标记进行移动（容器/图层坐标）
                if (!playbackDom.el) console.log('[Playback] DOM标记不存在，将尝试创建');
                updatePlaybackDom(nextLL);
                // 折线更新：优先setLngLats，兜底重建
                if (playbackState.line && typeof playbackState.line.setLngLats === 'function') {
                    try { playbackState.line.setLngLats(playbackState.path); }
                    catch(e){
                        console.warn('[Playback] setLngLats失败，重建折线', e);
                        if (map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                        playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 1, opacity: 0.9 });
                        if (map) map.addOverLay(playbackState.line);
                    }
                } else {
                    console.log('[Playback] 折线不支持setLngLats，重建');
                    if (playbackState.line && map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                    playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 1, opacity: 0.9 });
                    if (map) map.addOverLay(playbackState.line);
                }
            } catch(e) { console.warn('更新回放覆盖物失败:', e); }
            updatePlaybackTimeLabel(next.ts);
            scheduleNext();
        }, delay);
    }

    function stopPlayback(){
        if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
        playbackState.running = false;
        playbackState.idx = 0;
        try {
            // 移除DOM标记
            removePlaybackDom();
            if (playbackState.marker && map) map.removeOverLay(playbackState.marker);
            if (playbackState.line && map) map.removeOverLay(playbackState.line);
        } catch(e){}
        playbackState.marker = null;
        playbackState.line = null;
        updatePlaybackTimeLabel('—');
        // 按钮回到初始状态
        updatePlaybackButtonsState('idle');
    }

    function updatePlaybackTimeLabel(text){
        const el = document.getElementById('playbackTimeLabel');
        if (el) el.textContent = '时间：' + (text || '—');
    }

    // 时间滑动条：配置与跳转
    function configureTimeSlider(points){
        try {
            const slider = document.getElementById('playbackTimeSlider');
            const cursor = document.getElementById('playbackTimeCursor');
            if (!slider || !points || !points.length) return;
            const minMs = points[0].time.getTime();
            const maxMs = points[points.length - 1].time.getTime();
            const prev = parseInt(slider.value, 10);
            slider.min = String(minMs);
            slider.max = String(maxMs);
            slider.step = '1000'; // 以秒为步进
            let val = (isFinite(prev) && prev >= minMs && prev <= maxMs) ? prev : minMs;
            slider.value = String(val);
            if (cursor) cursor.textContent = formatTimeForLabel(val);
        } catch(e) { console.warn('配置时间滑动条失败:', e); }
    }
    function formatTimeForLabel(ms){
        if (!isFinite(ms)) return '—';
        const d = new Date(ms);
        const pad = n => String(n).padStart(2,'0');
        const y = d.getFullYear();
        const M = pad(d.getMonth()+1);
        const da = pad(d.getDate());
        const h = pad(d.getHours());
        const m = pad(d.getMinutes());
        const s = pad(d.getSeconds());
        return `${y}-${M}-${da} ${h}:${m}:${s}`;
    }
    function findIndexByTime(points, ms){
        try {
            if (!points || !points.length) return 0;
            const n = points.length;
            const minMs = points[0].time.getTime();
            const maxMs = points[n-1].time.getTime();
            if (!isFinite(ms)) return 0;
            if (ms <= minMs) return 0;
            if (ms >= maxMs) return n-1;
            let lo = 0, hi = n - 1, ans = 0;
            while (lo <= hi) {
                const mid = (lo + hi) >> 1;
                const t = points[mid].time.getTime();
                if (t < ms) { lo = mid + 1; ans = lo; }
                else { hi = mid - 1; ans = mid; }
            }
            return Math.max(0, Math.min(n-1, ans));
        } catch(e){ console.warn('findIndexByTime失败:', e); return 0; }
    }
    function jumpToSliderTime(){
        try {
            const slider = document.getElementById('playbackTimeSlider');
            if (!slider || !playbackState.points || !playbackState.points.length) return;
            const ms = parseInt(slider.value, 10);
            if (!isFinite(ms)) return;
            const idx = findIndexByTime(playbackState.points, ms);
            playbackState.idx = idx;
            const pts = playbackState.points;
            const ll = pts[idx].ll;
            playbackState.path = pts.slice(0, idx+1).map(p=>p.ll);
            // 更新折线
            try {
                if (playbackState.line && typeof playbackState.line.setLngLats === 'function') {
                    playbackState.line.setLngLats(playbackState.path);
                } else {
                    if (playbackState.line && map) { try { map.removeOverLay(playbackState.line); } catch(e){} }
                    playbackState.line = new T.Polyline(playbackState.path, { color: '#00FFFF', weight: 1, opacity: 0.9 });
                    if (map) map.addOverLay(playbackState.line);
                }
            } catch(e){ console.warn('滑块更新折线失败:', e); }
            // 更新标记与时间
            ensurePlaybackDom(ll);
            updatePlaybackDom(ll);
            updatePlaybackTimeLabel(pts[idx].ts);
            // 若正在播放，立即按新位置继续
            if (playbackState.running) {
                if (playbackState.timer) { clearTimeout(playbackState.timer); playbackState.timer = null; }
                scheduleNext();
            }
        } catch(e) { console.warn('滑块跳转失败:', e); }
    }

    // DOM标记：使用容器坐标实现可见移动
    let playbackDom = { el: null, lastLL: null, bound: false };

    function ensurePlaybackDom(ll){
        try {
            playbackDom.lastLL = ll;
            const pane = (map && map.getPanes && map.getPanes().overlayPane) || document.getElementById('mapContainer');
            if (!pane) { console.warn('未找到overlayPane或mapContainer'); return; }
            if (!playbackDom.el) {
                const el = document.createElement('div');
                el.id = 'playbackDomMarker';
                el.style.position = 'absolute';
                el.style.width = '16px';
                el.style.height = '16px';
                el.style.borderRadius = '50%';
                el.style.background = '#2C64A7';
                el.style.border = '2px solid #fff';
                el.style.boxShadow = '0 0 0 1px rgba(0,0,0,.25)';
                el.style.zIndex = '9999';
                pane.appendChild(el);
                playbackDom.el = el;
                console.log('[Playback] 创建DOM标记，父节点=', pane === document.getElementById('mapContainer') ? '#mapContainer' : 'overlayPane');
                bindPlaybackDomEvents();
            }
            updatePlaybackDom(ll);
        } catch(e) { console.warn('创建DOM标记失败:', e); }
    }

    function updatePlaybackDom(ll){
        try {
            playbackDom.lastLL = ll;
            if (!map || !playbackDom.el || !ll) { console.log('[Playback] update取消：map/el/ll缺失'); return; }
            let p;
            if (typeof map.lngLatToLayerPoint === 'function') {
                p = map.lngLatToLayerPoint(ll);
                console.log('[Playback] 使用layerPoint定位:', ll && ll.lng, ll && ll.lat, '=>', p && p.x, p && p.y);
            } else if (typeof map.lngLatToContainerPoint === 'function') {
                p = map.lngLatToContainerPoint(ll);
                console.log('[Playback] 使用containerPoint定位:', ll && ll.lng, ll && ll.lat, '=>', p && p.x, p && p.y);
            } else {
                console.warn('地图对象不支持lngLat到像素坐标转换');
                return;
            }
            playbackDom.el.style.left = p.x + 'px';
            playbackDom.el.style.top = p.y + 'px';
        } catch(e) { console.warn('更新DOM标记位置失败:', e); }
    }

    function bindPlaybackDomEvents(){
        if (playbackDom.bound) return;
        const updater = function(){
            try {
                if (!map || !playbackDom.el || !playbackDom.lastLL) return;
                let p;
                if (typeof map.lngLatToLayerPoint === 'function') {
                    p = map.lngLatToLayerPoint(playbackDom.lastLL);
                } else if (typeof map.lngLatToContainerPoint === 'function') {
                    p = map.lngLatToContainerPoint(playbackDom.lastLL);
                }
                if (!p) return;
                playbackDom.el.style.left = p.x + 'px';
                playbackDom.el.style.top = p.y + 'px';
            } catch(e){}
        };
        try {
            map.addEventListener('move', updater);
            map.addEventListener('zoom', updater);
            playbackDom.bound = true;
        } catch(e){}
    }

    function removePlaybackDom(){
        try {
            const el = playbackDom.el;
            playbackDom.lastLL = null;
            if (el && el.parentNode) el.parentNode.removeChild(el);
        } catch(e){}
        playbackDom.el = null;
        playbackDom.bound = false;
    }

</script>
</body>

</html>
